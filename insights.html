<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>User Activity Insights</title>
  <link href="data:image/svg+xml,&lt;svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32' width='32' height='32'&gt;&lt;rect width='32' height='32' rx='4' fill='%236366f1'/&gt;&lt;text x='50%' y='55%' dominant-baseline='middle' text-anchor='middle' font-family='Arial, sans-serif' font-size='18' font-weight='bold' fill='white'&gt;IB&lt;/text&gt;&lt;/svg&gt;" rel="icon" type="image/svg+xml"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  <style>
    :root {
      --primary-color: #6366f1;
      --primary-color-hover: #4f46e5;
      --text-color: #d1d5db;
      --text-color-muted: #9ca3af;
      --bg-color: #111827;
      --bg-color-alt: #1f2937;
      --border-color: #374151;
      --border-radius: 0.5rem;
      --border-radius-lg: 0.75rem;
    }
    html, body {
      height: 100%;
      margin: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      font-size: 16px;
    }
    .page-wrapper {
      padding: 1.5rem 2rem;
    }
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border-color);
    }
    .page-header h1 {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--text-color);
      margin: 0;
    }
     .button, button {
        background-color: var(--primary-color);
        color: white;
        border: 1px solid transparent;
        padding: 0.625rem 1rem;
        border-radius: var(--border-radius);
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 500;
        transition: background-color 0.2s;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }
    .button:hover, button:hover { background-color: var(--primary-color-hover); }
    .button-secondary {
        background-color: var(--bg-color-alt);
        color: var(--text-color-muted);
        border-color: var(--border-color);
    }
    .button-secondary:hover { background-color: #374151; color: var(--text-color); }
    
    .card {
      background-color: var(--bg-color-alt);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius-lg);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    
    .filters {
        display: flex;
        flex-wrap: wrap;
        gap: 1.25rem;
        align-items: flex-end;
    }
    .filters .form-group {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
    }
    .filters .form-group label {
        font-size: 0.8rem;
        font-weight: 500;
        color: var(--text-color-muted);
        margin-bottom: 0.5rem;
    }
    .filters input, .filters select {
        width: 100%;
        padding: 0.625rem;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        background-color: var(--bg-color);
        color: var(--text-color);
        font-size: 0.9rem;
    }
    .filters .search-group { flex-basis: 300px; }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
    }
    .stat-card {
        text-align: center;
    }
    .stat-card h2 {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-color-muted);
        margin-bottom: 0.75rem;
    }
    .stat-card .stat-value {
        font-size: 2.5rem;
        font-weight: 700;
    }
    .stat-card .stat-value.helpful { color: #22c55e; }
    .stat-card .stat-value.not-helpful { color: #ef4444; }
    
    .table-wrap { overflow-x: auto; }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px;
    }
    th, td {
      padding: 0.8rem 1rem;
      border-bottom: 1px solid var(--border-color);
      font-size: 0.9rem;
      text-align: left;
    }
    thead th {
      background-color: #111827;
      color: var(--text-color-muted);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .highlight { background-color: rgba(59,130,246,0.3) !important; transition: background-color 1s ease; }

    .spinner-overlay{ position:fixed; inset:0; background:rgba(17,24,39,0.7); display:flex; align-items:center; justify-content:center; z-index:1000; }
    .spinner { width:60px; height:60px; border-radius:50%; border:5px solid var(--border-color); border-top-color:var(--primary-color); animation:spin 1s linear infinite; }
    @keyframes spin{ to{transform:rotate(360deg);} }
    
    .toast{ position:fixed; top:20px; right:20px; padding:12px 16px; border-radius: var(--border-radius); color:white; z-index:1100; display:flex; align-items:center; gap:10px; cursor:pointer; opacity:0; transform:translateY(-10px); transition: all .2s; }
    .toast.show { opacity:1; transform:translateY(0); }

    .hidden { display: none !important; }
    .access-restricted-card { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; height: 100vh; width: 100%; }
    .access-restricted-card .card { max-width: 450px; padding: 3rem; }
    .access-restricted-card .icon { font-size: 4rem; color: var(--primary-color); margin-bottom: 1.5rem; }
    .access-restricted-card h2 { font-size: 1.75rem; margin-bottom: 0.5rem; color: white; }
    .access-restricted-card p { color: var(--text-color-muted); margin-bottom: 2rem; }
  </style>
</head>
<body>

<!-- Main dashboard content, hidden by default -->
<div id="dashboard" class="hidden">
  <div class="page-wrapper">
    <div class="page-header">
      <h1><i class="fas fa-chart-pie" style="color: var(--primary-color); margin-right: 1rem;"></i>User Activity Insights</h1>
      <a href="app.html" class="button button-secondary"><i class="fas fa-arrow-left"></i> Back to Dashboard</a>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Spinner Overlay -->
    <div id="spinner" class="spinner-overlay hidden"><div class="spinner"></div></div>

    <!-- FILTERS -->
    <div class="card filters">
      <div class="form-group">
        <label for="timeFilter">Time Range</label>
        <select id="timeFilter">
          <option value="all">All Time</option>
          <option value="today">Today</option>
          <option value="7d">Last 7 days</option>
          <option value="30d">Last 30 days</option>
        </select>
      </div>
      <div class="form-group">
        <label for="actionFilter">Action</label>
        <select id="actionFilter">
          <option value="all">All</option>
          <option value="viewed">Viewed</option>
          <option value="updated">Updated</option>
          <option value="deleted">Deleted</option>
        </select>
      </div>
      <div class="form-group search-group">
        <label for="searchInput">Search by User, Email, or Case</label>
        <input id="searchInput" type="text" placeholder="..." />
      </div>
      <button id="exportBtn" class="button-secondary"><i class="fas fa-file-csv"></i> Export CSV</button>
    </div>

    <!-- STATS CARDS -->
    <div class="card stats-grid">
      <div class="stat-card">
        <h2>Total Activities</h2>
        <p id="totalActivities" class="stat-value">0</p>
      </div>
      <div class="stat-card">
        <h2>Helpful Feedback</h2>
        <p id="helpfulCount" class="stat-value helpful">0</p>
      </div>
      <div class="stat-card">
        <h2>Not Helpful Feedback</h2>
        <p id="notHelpfulCount" class="stat-value not-helpful">0</p>
      </div>
    </div>

    <!-- CHARTS -->
    <div class="stats-grid">
      <div class="card">
        <h2 style="font-size:1.25rem; font-weight:600; margin-bottom:1.5rem;">Feedback Distribution</h2>
        <canvas id="feedbackChart" height="250"></canvas>
      </div>
      <div class="card">
        <h2 style="font-size:1.25rem; font-weight:600; margin-bottom:0.5rem;">Top Active Users</h2>
        <p style="font-size:0.9rem; color:var(--text-color-muted); margin-top:0; margin-bottom:1.5rem;">Based on total number of activities logged.</p>
        <canvas id="activeUsersChart" height="250"></canvas>
      </div>
    </div>

    <!-- ACTIVITY FEED TABLE -->
    <div class="card">
      <h2 style="font-size:1.25rem; font-weight:600; margin-bottom:1rem;">Recent Activities</h2>
      <div class="table-wrap">
        <table aria-label="Recent Activities">
          <thead>
            <tr>
              <th>User</th>
              <th>Email</th>
              <th>Case</th>
              <th>Action</th>
              <th>Details</th>
              <th>Activity Time</th>
            </tr>
          </thead>
          <tbody id="activityTable"></tbody>
        </table>
      </div>
      <div style="display: flex; justify-content: center; margin-top: 1.5rem;">
        <button id="loadMoreBtn" class="button-secondary">Load More</button>
      </div>
    </div>
  </div>
</div>

<!-- Admin access restricted card, visible by default -->
<div id="restricted-card" class="access-restricted-card">
    <div class="card">
        <div class="icon">🔒</div>
        <h2>Access Restricted</h2>
        <p>This page is available to administrators only.</p>
        <a href="app.html" class="button">Go Back to Dashboard</a>
    </div>
</div>


  <script type="module">
    import { supabase } from './supabase.js';

    let activities = [];
    let feedbackStats = { helpful: 0, notHelpful: 0 };
    let topUsers = [];
    let currentPage = 1;
    const pageSize = 25;

    const table = document.getElementById('activityTable');
    const totalActivitiesEl = document.getElementById('totalActivities');
    const helpfulCountEl = document.getElementById('helpfulCount');
    const notHelpfulCountEl = document.getElementById('notHelpfulCount');
    const toast = document.getElementById('toast');
    const spinner = document.getElementById('spinner');

    let feedbackChart, activeUsersChart;

    function showSpinner(show) { spinner.classList.toggle('hidden', !show); }

    function showToast(message, type, rowId) {
      const colors = { insert: '#16a34a', update: '#2563eb', delete: '#ef4444' };
      const icons = { insert: '✅', update: '✏️', delete: '🗑️' };
      toast.style.backgroundColor = colors[type] || '#6366f1';
      toast.innerHTML = `<span style="font-size: 1.1rem;">${icons[type] || 'ℹ️'}</span><span>${message}</span>`;
      toast.classList.add('show');
      toast.onclick = () => {
        if (rowId) {
          const row = document.getElementById(rowId);
          if (row) {
            row.scrollIntoView({ behavior: 'smooth', block: 'center' });
            row.classList.add('highlight');
            setTimeout(() => row.classList.remove('highlight'), 3000);
          }
        }
        toast.classList.remove('show');
      };
      setTimeout(() => toast.classList.remove('show'), 4000);
    }
    
    function createChart(ctx, type, labels, data, dataLabels, backgroundColors) {
        const legendColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim();
        const ticksColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color-muted').trim();
        const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim();

        const chartOptions = {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { labels: { color: legendColor, font: { family: 'Inter', size: 14 }}}},
            scales: { y: { beginAtZero: true, ticks: { color: ticksColor }, grid: { color: gridColor } }, x: { ticks: { color: ticksColor }, grid: { color: gridColor } } }
        };

        if(type === 'doughnut') {
            delete chartOptions.scales;
        }

        return new Chart(ctx, {
            type,
            data: { labels, datasets: [{ label: dataLabels, data, backgroundColor: backgroundColors }] },
            options: chartOptions
        });
    }

    function renderActivities(filtered) {
      const start = 0;
      const end = currentPage * pageSize;
      const paginated = filtered.slice(start, end);
      
      table.innerHTML = paginated.map((act, idx) => {
          const rowId = `row-${idx}`;
          return `<tr id="${rowId}">
            <td class='px-4 py-2'>${act.user_name}</td>
            <td class='px-4 py-2'>${act.user_email}</td>
            <td class='px-4 py-2'>${act.item_title || '-'}</td>
            <td class='px-4 py-2'>${act.action}</td>
            <td class='px-4 py-2'>${JSON.stringify(act.details)}</td>
            <td class='px-4 py-2'>${new Date(act.activity_time).toLocaleString()}</td>
          </tr>`;
      }).join('');
      
      totalActivitiesEl.textContent = filtered.length;
      document.getElementById('loadMoreBtn').style.display = end < filtered.length ? 'inline-flex' : 'none';
    }

    function renderFeedback() {
      helpfulCountEl.textContent = feedbackStats.helpful;
      notHelpfulCountEl.textContent = feedbackStats.notHelpful;
      if (feedbackChart) feedbackChart.destroy();
      feedbackChart = createChart(document.getElementById('feedbackChart').getContext('2d'), 'doughnut', ['Helpful', 'Not Helpful'], [feedbackStats.helpful, feedbackStats.notHelpful], 'Feedback', ['#10B981', '#EF4444']);
    }

    function renderTopUsers() {
      if (activeUsersChart) activeUsersChart.destroy();
      activeUsersChart = createChart(document.getElementById('activeUsersChart').getContext('2d'), 'bar', topUsers.map(u => u.user_name), topUsers.map(u => u.activity_count), 'Activities', '#6366F1');
    }

    function filterAndRender() {
        const timeFilter = document.getElementById('timeFilter').value;
        const actionFilter = document.getElementById('actionFilter').value;
        const search = document.getElementById('searchInput').value.toLowerCase();
        let filtered = [...activities];
        const now = new Date();

        if (timeFilter !== 'all') {
            filtered = filtered.filter(a => {
                const ts = new Date(a.activity_time);
                if (timeFilter === 'today') return ts.toDateString() === now.toDateString();
                if (timeFilter === '7d') return (now - ts) / (1000*60*60*24) <= 7;
                if (timeFilter === '30d') return (now - ts) / (1000*60*60*24) <= 30;
                return true;
            });
        }
        if (actionFilter !== 'all') filtered = filtered.filter(a => a.action === actionFilter);
        if (search) {
            filtered = filtered.filter(a =>
                (a.user_name || '').toLowerCase().includes(search) ||
                (a.user_email || '').toLowerCase().includes(search) ||
                (a.item_title || '').toLowerCase().includes(search)
            );
        }
        
        currentPage = 1;
        renderActivities(filtered);
        return filtered;
    }

    function exportCSV(data) {
        const headers = ['User','Email','Case','Action','Details','Activity Time'];
        let csv = headers.join(',') + '\n';
        data.forEach(a => {
            const row = [a.user_name, a.user_email, a.item_title || '-', a.action, JSON.stringify(a.details), a.activity_time];
            csv += row.map(val => `"${String(val || '').replace(/"/g, '""')}"`).join(',') + '\n';
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'activities_insights.csv'; a.click();
        URL.revokeObjectURL(url);
    }

    async function initData() {
      showSpinner(true);
      const [actsRes, fbRes, tuRes] = await Promise.all([
          supabase.rpc('get_user_activity_feed'),
          supabase.rpc('get_feedback_stats'),
          supabase.rpc('get_top_active_users', { limit_count: 5 })
      ]);
      
      activities = actsRes.data || [];
      feedbackStats = { 
        helpful: fbRes.data?.find(f => f.rating_type === 'Helpful')?.count || 0, 
        notHelpful: fbRes.data?.find(f => f.rating_type === 'Not Helpful')?.count || 0 
      };
      topUsers = tuRes.data || [];

      filterAndRender();
      renderFeedback();
      renderTopUsers();
      showSpinner(false);
    }

    // Event Listeners
    ['timeFilter', 'actionFilter', 'searchInput'].forEach(id => {
        document.getElementById(id).addEventListener('input', filterAndRender);
    });
    document.getElementById('loadMoreBtn').onclick = () => { currentPage++; filterAndRender(); };
    document.getElementById('exportBtn').onclick = () => exportCSV(filterAndRender());

    // Realtime Subscriptions
    supabase.channel('activity_log_changes').on('postgres_changes', { event: '*', schema: 'public', table: 'activity_log' }, payload => {
        if (payload.eventType === 'INSERT') { 
            activities.unshift(payload.new); 
            showToast(`${payload.new.user_name} ${payload.new.action} ${payload.new.item_title || ''}`, 'insert', 'row-0'); 
        }
        filterAndRender();
      }).subscribe();

    supabase.channel('feedback_changes').on('postgres_changes', { event: '*', schema: 'public', table: 'kb_feedback' }, async () => {
        const {data:fb} = await supabase.rpc('get_feedback_stats');
        feedbackStats = { 
            helpful: fb?.find(f => f.rating_type === 'Helpful')?.count || 0, 
            notHelpful: fb?.find(f => f.rating_type === 'Not Helpful')?.count || 0 
        };
        renderFeedback();
    }).subscribe();

    // Admin Access Check & App Boot
    async function checkAdminAccess() {
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
          document.getElementById('dashboard').classList.add('hidden');
          document.getElementById('restricted-card').classList.remove('hidden');
          return;
        }
        const { data, error } = await supabase.from('users').select('role').eq('id', user.id).single();
        if (error || !data || data.role !== 'admin') {
          document.getElementById('dashboard').classList.add('hidden');
          document.getElementById('restricted-card').classList.remove('hidden');
        } else {
          document.getElementById('restricted-card').classList.add('hidden');
          document.getElementById('dashboard').classList.remove('hidden');
          initData(); // Boot app only for admins
        }
      } catch (e) {
        console.error('Admin check failed', e);
        document.getElementById('dashboard').classList.add('hidden');
        document.getElementById('restricted-card').classList.remove('hidden');
      }
    }
    
    document.addEventListener('DOMContentLoaded', checkAdminAccess);
  </script>
</body>
</html>
