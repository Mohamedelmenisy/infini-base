<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>InfiniBase - Knowledge Base Insights</title>
<link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
<link rel="icon" href="favicon.svg" type="image/svg+xml">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --brand-500: #0b5fff;
  --brand-600: #084fd6;
  --muted-600: #6b7280;
  --bg: #071428;
  --card-bg: #0b1220;
  --glass: rgba(255,255,255,0.04);
  --success: #16a34a;
  --danger: #ef4444;
  --radius: 10px;
  --gap: 12px;
  --max-width: 1200px;
  --mono: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue';
  --primary-color: #8b5cf6;
  --primary-color-hover: #7c3aed;
  --text-color: #e5e7eb;
  --text-color-muted: #9ca3af;
  --bg-color: #111827;
  --bg-color-alt: #1f2937;
  --border-color: #374151;
  --border-radius: 0.5rem;
  --border-radius-lg: 0.75rem;
  --header-height: 72px;
  --accent-color: #38bdf8;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:var(--mono);background-image:linear-gradient(120deg,#071428 0%,#071827 100%);color:var(--text-color)}
.app-header{
  position:fixed;top:0;left:0;right:0;height:var(--header-height);display:flex;align-items:center;justify-content:space-between;padding:12px 20px;z-index:1200;
  background:rgba(6,11,22,0.75);backdrop-filter: blur(6px);border-bottom:1px solid rgba(255,255,255,0.04)
}
.brand{display:flex;align-items:center;gap:10px;font-weight:700;font-size:18px;color:var(--brand-500)}
.app-header nav{display:flex;gap:10px;align-items:center}
.app-header a{color:#dbeafe;text-decoration:none;padding:8px 12px;border-radius:8px;display:inline-block;font-size:14px}
.app-header a:hover{background:rgba(255,255,255,0.03);transform:translateY(-1px);transition:all 120ms ease}
.protected-link{opacity:0.6;cursor:pointer;position:relative;outline:none}
.protected-link::after{content:'ðŸ”’';margin-left:6px;font-size:12px;opacity:0.7}

.page-wrapper{padding:1.6rem;padding-top:calc(var(--header-height) + 1.4rem);min-height:100vh;max-width:1200px;margin:0 auto}
.card{background:var(--card-bg);border-radius:12px;padding:1.2rem;margin-bottom:1.2rem;border:1px solid rgba(255,255,255,0.03);box-shadow:0 8px 30px rgba(2,6,23,0.6)}
.card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid rgba(255,255,255,0.02)}
.card-header h2{margin:0;font-size:1.15rem;color:#fff}
.insights-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(360px,1fr));gap:1rem;margin-bottom:1.2rem}
.chart-wrapper{height:360px;padding:12px}
.table-container{max-height:420px;overflow:auto;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent)}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.03);font-size:0.95rem;text-align:left}
thead th{position:sticky;top:0;background:rgba(10,14,20,0.6);backdrop-filter:blur(4px);z-index:2}
.metric-card{background:linear-gradient(180deg,var(--bg-color-alt),#111827);padding:14px;border-radius:12px;display:flex;align-items:center;gap:12px;border:1px solid rgba(255,255,255,0.02)}
.metric-card .value{font-size:1.6rem;font-weight:800}
.toast{position:fixed;top:20px;right:20px;padding:12px 16px;border-radius:8px;background:#ef4444;color:#fff;display:flex;align-items:center;gap:10px;z-index:2000;opacity:0;transform:translateY(-10px);transition:all .25s}
.toast.show{opacity:1;transform:translateY(0)}
.spinner-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(2,6,23,0.6);z-index:1500;display:none}
.spinner{width:48px;height:48px;border-radius:50%;border:5px solid rgba(255,255,255,0.08);border-top-color:var(--primary-color);animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
@media(max-width:800px){.insights-grid{grid-template-columns:1fr}.app-header nav{display:flex;flex-wrap:wrap}}
.protected-modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:3000;visibility:hidden;opacity:0;transition:all .15s}
.protected-modal.open{visibility:visible;opacity:1}
.protected-card{background:#0b1220;padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);width:380px;color:#dbeafe}
.protected-card h3{margin:0 0 8px}
.protected-card p{color:var(--text-color-muted);margin:0 0 12px}
.protected-actions{display:flex;justify-content:flex-end;gap:8px}
.protected-actions button{padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--brand-500);cursor:pointer}
.footer{padding:24px;text-align:center;color:var(--text-color-muted)}

/* small polish for table headers and values */
thead th { font-weight:700; color: #cfe5ff; font-size:0.95rem; }
tbody td { color: #e6eefc; }
.card small { color: var(--text-color-muted); }
</style>
</head>
<body>
<header class="app-header">
  <div class="brand">Knowledge Base</div>
  <nav>
    <a href="app.html" id="link-dashboard" data-role-required="admin,manager">Dashboard</a>
    <a href="insights.html" id="link-insights" data-role-required="admin,manager">Insights</a>
    <a href="employees.html" id="link-employees" data-role-required="admin,manager">Employees</a>
    <a href="audit.html" id="link-audit" data-role-required="admin,manager">Audit Log</a>
    <span id="role-badge" style="margin-left:12px;padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.02);font-size:13px">guest</span>
  </nav>
</header>

<div id="dashboard" style="visibility:hidden">
  <div class="page-wrapper">
    <div id="toast" class="toast"><i class="fas fa-exclamation-circle"></i><span id="toastMsg"></span></div>
    <div id="spinner" class="spinner-overlay"><div class="spinner"></div></div>

    <div class="insights-grid">
      <div class="card">
        <div class="card-header"><h2><i class="fas fa-chart-bar"></i> Activity by Section</h2></div>
        <div class="chart-wrapper"><canvas id="activityBySectionChart"></canvas></div>
      </div>
      <div class="card">
        <div class="card-header"><h2><i class="fas fa-comments"></i> Feedback Analysis</h2></div>
        <div class="chart-wrapper"><canvas id="feedbackAnalysisChart"></canvas></div>
      </div>
    </div>

    <div class="card">
      <div class="card-header"><h2><i class="fas fa-book-open"></i> Articles Performance Insights</h2></div>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Article Title</th><th>Description</th><th>Category</th><th>Sub-Category</th><th>Created By</th><th>Created At</th><th>Total Views</th><th>Unique Viewers</th><th>Last Viewed</th><th>Avg Rating</th><th>Total Feedbacks</th>
            </tr>
          </thead>
          <tbody id="articlesInsightsTable"></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <div class="card-header"><h2><i class="fas fa-crown"></i> Top Content Creators</h2></div>
      <div class="table-container">
        <table>
          <thead><tr><th>Creator Name</th><th>Total Articles Created</th><th>Total Views on Articles</th></tr></thead>
          <tbody id="topPerformersTable"></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <div class="card-header"><h2><i class="fas fa-folder-tree"></i> Sections Performance Summary</h2></div>
      <div class="table-container">
        <table>
          <thead><tr><th>Section Title</th><th>Total Articles</th><th>Total Views</th><th>Average Rating</th><th>Last Activity</th></tr></thead>
          <tbody id="sectionsSummaryTable"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div class="protected-modal" id="protectedModal">
  <div class="protected-card">
    <h3>Restricted</h3>
    <p>This section is for Admins and Managers only. If you believe you should have access, contact your administrator.</p>
    <div class="protected-actions">
      <button id="protectedClose">Close</button>
    </div>
  </div>
</div>

<footer class="footer">&copy; <script>document.write((new Date()).getFullYear())</script> InfiniBase.Elmenisy.</footer>

<script>
/* -------------------------
   Configuration
   ------------------------- */
const SUPABASE_URL = 'https://aefiigottnlcmjzilqnh.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFlZmlpZ290dG5sY21qemlscW5oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcxNzY2MDQsImV4cCI6MjA2Mjc1MjYwNH0.FypB02v3tGMnxXV9ZmZMdMC0oQpREKOJWgHMPxUzwX4';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* -------------------------
   UI helpers
   ------------------------- */
const toast = document.getElementById('toast');
const toastMsg = document.getElementById('toastMsg');
const spinner = document.getElementById('spinner');
let activityBySectionChart = null, feedbackAnalysisChart = null;

function showSpinner(show){ spinner.style.display = show ? 'flex' : 'none'; }
function showToast(message, isError=true){
  toastMsg.textContent = message;
  toast.style.backgroundColor = isError ? '#ef4444' : '#16a34a';
  toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),3000);
}

function escapeHtml(str){
  if (str === null || str === undefined) return 'Not Available';
  return String(str).replace(/[&<>"']/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[s]);
}
function formatToEgyptTime(dateString){
  if(!dateString) return 'Not Available';
  try{
    const d = new Date(dateString);
    if(isNaN(d.getTime())) return dateString;
    return d.toLocaleString('en-EG',{year:'numeric',month:'short',day:'numeric',hour:'numeric',minute:'2-digit',hour12:true,timeZone:'Africa/Cairo'});
  }catch(e){ return dateString; }
}

function createChart(ctx,type,labels,data,label,backgroundColors){
  const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim() || '#fff';
  const borderColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim() || '#374151';
  return new Chart(ctx,{type,data:{labels,datasets:[{label,data,backgroundColor:backgroundColors,borderColor:borderColor,borderWidth:2}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{color:textColor}},tooltip:{backgroundColor:'#0b1220',titleColor:'#fff',bodyColor:'#fff'}}}});
}

/* -------------------------
   Renderers
   ------------------------- */
function renderArticlesTable(data){
  const tbody = document.getElementById('articlesInsightsTable');
  if(!data || data.length===0){ tbody.innerHTML = '<tr><td colspan="11" style="text-align:center">No article data available.</td></tr>'; return;}
  const html = data.map(r=>{
    const title = r.article_title || r.case_name || r.title_en || 'Untitled';
    const desc = r.article_description || r.description_en || r.description || '';
    const section = r.section_title || r.section || r.section_name || '';
    const subcat = r.sub_category_name || r.sub_category || '';
    const createdBy = r.created_by || r.author_name || r.created_by_name || 'Unknown';
    const createdAt = r.created_at_egypt || r.created_at || r.last_article_created_egypt || null;
    const totalViews = r.total_views || r.total_views_all || r.views || 0;
    const uniqueViewers = r.unique_viewers || r.unique_authors || r.unique_feedback_users || 0;
    const lastViewed = r.last_viewed_egypt || r.last_activity_egypt || r.last_activity || null;
    const avgRating = r.avg_rating || r.avg_feedback_rating || null;
    const totalFeedbacks = r.total_feedbacks || r.total_feedbacks_count || r.total_feedback || 0;
    return `<tr>
      <td>${escapeHtml(title)}</td>
      <td title="${escapeHtml(desc)}">${escapeHtml(desc)}</td>
      <td>${escapeHtml(section)}</td>
      <td>${escapeHtml(subcat)}</td>
      <td>${escapeHtml(createdBy)}</td>
      <td>${formatToEgyptTime(createdAt)}</td>
      <td style="text-align:center">${escapeHtml(totalViews)}</td>
      <td style="text-align:center">${escapeHtml(uniqueViewers)}</td>
      <td>${formatToEgyptTime(lastViewed)}</td>
      <td style="text-align:center">${avgRating ? Number(avgRating).toFixed(2) : 'Not Available'}</td>
      <td style="text-align:center">${escapeHtml(totalFeedbacks)}</td>
    </tr>`;
  }).join('');
  tbody.innerHTML = html;
}

function renderTopPerformers(data){
  const tbody = document.getElementById('topPerformersTable');
  if(!data || data.length===0){ tbody.innerHTML = '<tr><td colspan="3" style="text-align:center">No performer data available.</td></tr>'; return;}
  tbody.innerHTML = data.map(r=>`<tr><td>${escapeHtml(r.contributor_name || r.creator_name || r.created_by || 'Unknown')}</td><td style="text-align:center">${escapeHtml(r.total_articles || r.total_articles_created || 0)}</td><td style="text-align:center">${escapeHtml(r.total_views || 0)}</td></tr>`).join('');
}

function renderSectionsTable(data){
  const tbody = document.getElementById('sectionsSummaryTable');
  if(!data || data.length===0){ tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">No section data available.</td></tr>'; return;}
  tbody.innerHTML = data.map(r=>`<tr><td>${escapeHtml(r.section_title || r.section || r.section_name || 'Uncategorized')}</td><td style="text-align:center">${escapeHtml(r.total_articles || 0)}</td><td style="text-align:center">${escapeHtml(r.total_views || 0)}</td><td style="text-align:center">${r.avg_rating ? Number(r.avg_rating).toFixed(2) : 'Not Available'}</td><td>${formatToEgyptTime(r.last_activity_egypt || r.last_activity || null)}</td></tr>`).join('');
}

function renderFeedbackCharts(data){
  if(feedbackAnalysisChart) feedbackAnalysisChart.destroy();
  const ctx = document.getElementById('feedbackAnalysisChart').getContext('2d');
  if(!data || data.length===0){ ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height); ctx.font='16px Segoe UI'; ctx.fillStyle='grey'; ctx.textAlign='center'; ctx.fillText('No feedback data to display.',ctx.canvas.width/2,ctx.canvas.height/2); return;}
  const labels = data.map(d=>d.feedback_type || d.label || (d.rating ? String(d.rating) : 'N/A'));
  const counts = data.map(d=>d.total_feedbacks || d.count || 0);
  const colors = ['#10b981','#f59e0b','#ef4444','#3b82f6','#8b5cf6'];
  feedbackAnalysisChart = createChart(ctx,'pie',labels,counts,'Feedback Distribution',colors);
}

/* -------------------------
   Data loaders (use the views we created)
   ------------------------- */
async function loadArticlesInsights(){
  const { data, error } = await supabase.from('v_kb_articles').select('*');
  if(error){ console.error('Error loading Article Insights:', error); showToast('Error loading articles: ' + (error.message || error), true); return;}
  renderArticlesTable(data);
}

async function loadTopPerformers(){
  const { data, error } = await supabase.from('v_kb_top_creators').select('*');
  if(error){ console.error('Error loading Top Performers:', error); showToast('Error loading performers: ' + (error.message || error), true); return;}
  renderTopPerformers(data);
}

async function loadFeedbackAnalysis(){
  const { data, error } = await supabase.from('v_kb_feedback_analysis').select('*');
  if(error){ console.error('Error loading Feedback Analysis:', error); showToast('Error loading feedback: ' + (error.message || error), true); return;}
  // aggregate by rating or reason for chart
  const grouped = (data || []).reduce((acc,row)=>{
    const key = row.rating ? String(row.rating) : (row.reason ? (row.reason.length>20 ? row.reason.slice(0,20)+'...' : row.reason) : 'No Rating');
    if(!acc[key]) acc[key] = 0;
    acc[key]++;
    return acc;
  },{});
  const chartData = Object.keys(grouped).map(k=>({ label:k, total_feedbacks: grouped[k]}));
  renderFeedbackCharts(chartData);
}

async function loadSectionsSummary(){
  const { data, error } = await supabase.from('v_kb_sections_summary').select('*');
  if(error){ console.error('Error loading Sections Summary:', error); showToast('Error loading sections: ' + (error.message || error), true); return;}
  renderSectionsTable(data);
  if(activityBySectionChart) activityBySectionChart.destroy();
  const ctx = document.getElementById('activityBySectionChart').getContext('2d');
  const labels = data.map(s=>s.section_title || s.section || s.section_name || 'Uncategorized');
  const values = data.map(s=>s.total_views || 0);
  const colors = ['#8b5cf6','#38bdf8','#10b981','#f59e0b','#ef4444','#3b82f6'];
  activityBySectionChart = createChart(ctx,'doughnut',labels,values,'Total Views by Section',colors);
}

/* -------------------------
   current user & nav access
   ------------------------- */
async function fetchCurrentProfile(){
  try{
    const userResp = await supabase.auth.getUser();
    const user = userResp?.data?.user ?? null;
    if(!user) return null;
    const { data: profile, error } = await supabase.from('users').select('*').eq('id', user.id).single();
    if(error) {
      const roleFromToken = (user?.user_metadata && user.user_metadata.role) || user?.role || 'agent';
      return { id: user.id, email: user.email, name: user.user_metadata?.name || user.email, role: roleFromToken };
    }
    return profile;
  }catch(e){ console.warn('Profile fetch failed', e); return null; }
}

function applyNavVisibility(role){
  const links = document.querySelectorAll('.app-header nav a[data-role-required]');
  links.forEach(a=>{
    const allowed = a.dataset.roleRequired.split(',').map(x=>x.trim());
    if(!allowed.includes(role)){
      a.classList.add('protected-link');
      // ensure only one listener
      a.onclick = (ev)=>{
        ev.preventDefault();
        document.getElementById('protectedModal').classList.add('open');
      };
    } else {
      a.classList.remove('protected-link');
      a.onclick = null;
    }
  });
}

document.getElementById('protectedClose').addEventListener('click', ()=>{ document.getElementById('protectedModal').classList.remove('open'); });

/* -------------------------
   initialize dashboard
   ------------------------- */
async function initializeInsightsDashboard(){
  showSpinner(true);
  document.getElementById('dashboard').style.visibility = 'visible';
  const profile = await fetchCurrentProfile();
  if(profile){
    document.getElementById('role-badge').textContent = (profile.role || 'user') + (profile.name ? ` â€¢ ${profile.name}` : '');
    applyNavVisibility(profile.role || 'agent');
  } else {
    applyNavVisibility('agent');
  }
  await Promise.all([ loadArticlesInsights(), loadTopPerformers(), loadFeedbackAnalysis(), loadSectionsSummary() ]);
  const now = new Date();
  const timeString = now.toLocaleTimeString('en-GB',{timeZone:'Africa/Cairo',hour:'2-digit',minute:'2-digit'});
  document.getElementById('lastUpdateTime')?.remove?.();
  const el = document.createElement('div'); el.style.display='none'; el.id='lastUpdateTime'; el.textContent = timeString + ' (Cairo)'; document.querySelector('.page-wrapper').appendChild(el);
  setInterval(()=>{ const now2=new Date(); const ts = now2.toLocaleTimeString('en-GB',{timeZone:'Africa/Cairo',hour:'2-digit',minute:'2-digit'}); document.getElementById('lastUpdateTime').textContent = ts + ' (Cairo)'; },60000);
  showSpinner(false);
}

document.addEventListener('DOMContentLoaded', initializeInsightsDashboard);
</script>

</body>
</html>
