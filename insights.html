<!DOCTYPE html>
<html class="dark" dir="ltr" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>InfiniBase - User Insights (Realtime)</title>

    <!-- Icons & Charts -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary: #6366f1;
            --bg: #0f1724;
            --card: #111827;
            --muted: #9ca3af;
            --border: #24303a;
            --glass: rgba(255,255,255,0.03);
            --success: #22c55e;
            --danger: #ef4444;
        }
        html,body { height:100%; margin:0; font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; background:var(--bg); color:#d1d5db; }
        a { color: inherit; text-decoration: none; }
        .header { display:flex; align-items:center; justify-content:space-between; padding:18px 28px; background:var(--card); border-bottom:1px solid var(--border); position:sticky; top:0; z-index:40; }
        .brand { display:flex; gap:12px; align-items:center; font-weight:700; color:var(--primary); }
        .brand svg { width:36px; height:36px; }
        .main { max-width:1400px; margin:22px auto; padding:0 18px 80px; }
        .page-title { font-size:22px; font-weight:800; color:var(--primary); margin:12px 0 20px; display:flex; align-items:center; gap:12px; }

        /* Layout */
        .grid-3 { display:grid; grid-template-columns: repeat(3,1fr); gap:16px; margin-bottom:18px; }
        .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-bottom:18px; }
        .card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px; box-shadow: 0 6px 20px rgba(0,0,0,0.4); }
        .card h3 { margin:0 0 10px; font-size:15px; color:#f8fafc; }
        .big-number { font-size:28px; font-weight:700; color:#fff; }

        /* Filters */
        .filters { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
        .input, select, button { background:var(--glass); border:1px solid var(--border); color:var(--muted); padding:8px 12px; border-radius:8px; font-size:13px; }
        .input::placeholder { color:#7b8791; }
        .btn-primary { background:var(--primary); color:white; border:1px solid rgba(0,0,0,0.08); cursor:pointer; }
        .btn-ghost { background:transparent; color:var(--muted); border:1px solid var(--border); cursor:pointer; }

        /* Table */
        .table-wrapper { overflow:auto; max-height:520px; border-radius:8px; }
        table { width:100%; border-collapse:collapse; min-width:940px; }
        th, td { padding:12px 14px; border-bottom:1px solid var(--border); text-align:left; color:#cbd5e1; font-size:13px; }
        th { background:#0b1220; color:var(--muted); font-size:12px; text-transform:uppercase; letter-spacing:0.03em; }
        tr:hover td { background: rgba(255,255,255,0.01); }

        /* small */
        .muted { color:var(--muted); font-size:13px; }
        .badge { padding:6px 10px; border-radius:999px; font-size:12px; font-weight:600; }
        .badge.success { background: rgba(34,197,94,0.12); color:var(--success); border:1px solid rgba(34,197,94,0.18); }
        .badge.error { background: rgba(239,68,68,0.08); color:var(--danger); border:1px solid rgba(239,68,68,0.12); }

        /* Spinner overlay */
        .overlay { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(2,6,23,0.5); z-index:1000; visibility:hidden; opacity:0; transition:all .18s; }
        .overlay.show { visibility:visible; opacity:1; }
        .spinner { width:72px; height:72px; border-radius:50%; border:6px solid rgba(255,255,255,0.06); border-top-color:var(--primary); animation:spin 1s linear infinite; }
        @keyframes spin { to { transform:rotate(360deg); } }

        /* footer actions */
        .actions { display:flex; gap:8px; align-items:center; }
        .export-btn { display:inline-flex; gap:8px; align-items:center; padding:8px 12px; border-radius:8px; font-weight:600; background:transparent; color:var(--muted); border:1px solid var(--border); cursor:pointer; }
        .small { font-size:12px; padding:6px 8px; border-radius:6px; }

        /* responsive */
        @media (max-width:980px) {
            .grid-3 { grid-template-columns: repeat(2,1fr); }
            .grid-2 { grid-template-columns: 1fr; }
            .card { padding:12px; }
        }
        @media (max-width:640px) {
            .grid-3 { grid-template-columns: 1fr; }
            .filters { flex-direction:column; align-items:stretch; }
            .table-wrapper { max-height: 400px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="brand">
            <svg viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="32" height="32" rx="6" fill="#6366f1"/><text x="50%" y="54%" text-anchor="middle" font-size="14" fill="#fff" font-weight="700">IB</text></svg>
            <div>
                <div style="font-weight:800;">InfiniBase</div>
                <div class="muted" style="font-size:12px;">User Activity Insights (Realtime)</div>
            </div>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
            <a href="app.html" class="btn-ghost small"><i class="fas fa-arrow-left"></i>&nbsp; Back</a>
            <button id="exportCsvBtn" class="export-btn"><i class="fas fa-file-export"></i> Export CSV</button>
        </div>
    </div>

    <main class="main">
        <div class="page-title"><i class="fas fa-chart-pie"></i> User Activity Insights</div>

        <!-- Stats -->
        <section class="grid-3">
            <div class="card">
                <h3>Total Activities</h3>
                <div class="big-number" id="totalActivities">0</div>
                <div class="muted" style="margin-top:8px;">Number of actions recorded in the selected range</div>
            </div>
            <div class="card">
                <h3>Feedback (Helpful)</h3>
                <div class="big-number" id="helpfulCount">0</div>
                <div class="muted" style="margin-top:8px;">Helpful votes on articles</div>
            </div>
            <div class="card">
                <h3>Feedback (Not Helpful)</h3>
                <div class="big-number" id="notHelpfulCount">0</div>
                <div class="muted" style="margin-top:8px;">Not helpful votes</div>
            </div>
        </section>

        <!-- Charts -->
        <section class="grid-2">
            <div class="card">
                <h3>Feedback Distribution</h3>
                <canvas id="feedbackChart" height="160"></canvas>
            </div>
            <div class="card">
                <h3>Top Active Users</h3>
                <canvas id="topUsersChart" height="160"></canvas>
            </div>
        </section>

        <!-- Filters + Table -->
        <section class="card" style="margin-top:12px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <div>
                    <div class="filters">
                        <input id="searchInput" class="input" placeholder="Search by user name or case title" style="min-width:320px;" />
                        <select id="actionFilter" class="input">
                            <option value="">All actions</option>
                            <option value="viewed">Viewed</option>
                            <option value="commented">Commented</option>
                            <option value="positive_feedback">Positive Feedback</option>
                            <option value="negative_feedback">Negative Feedback</option>
                            <option value="updated">Updated</option>
                        </select>

                        <select id="timeRange" class="input">
                            <option value="all">All time</option>
                            <option value="today">Today</option>
                            <option value="7d">Last 7 days</option>
                            <option value="30d">Last 30 days</option>
                            <option value="custom">Custom range</option>
                        </select>

                        <input type="date" id="startDate" class="input" style="display:none;" />
                        <input type="date" id="endDate" class="input" style="display:none;" />

                        <button id="applyFiltersBtn" class="btn-primary">Apply</button>
                        <button id="clearFiltersBtn" class="btn-ghost">Clear</button>
                    </div>
                </div>

                <div class="actions">
                    <button id="refreshBtn" class="small btn-ghost"><i class="fas fa-sync-alt"></i>&nbsp; Refresh</button>
                    <div class="muted" id="lastUpdated" style="font-size:13px;">Last updated: â€”</div>
                </div>
            </div>

            <div class="table-wrapper">
                <table id="activityTable">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Email</th>
                            <th>Action</th>
                            <th>Case Title</th>
                            <th>Details</th>
                            <th>Activity Time</th>
                        </tr>
                    </thead>
                    <tbody id="activityTableBody">
                        <tr><td colspan="6" style="text-align:center; padding:40px 0;" class="muted">Loading activity...</td></tr>
                    </tbody>
                </table>
            </div>

            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:12px;">
                <div class="muted" id="rowsInfo">Showing 0 rows</div>
                <div style="display:flex; gap:8px; align-items:center;">
                    <button id="prevPage" class="small btn-ghost">Prev</button>
                    <button id="nextPage" class="small btn-ghost">Next</button>
                </div>
            </div>
        </section>
    </main>

    <div id="overlay" class="overlay"><div class="spinner"></div></div>

    <script type="module">
        import { supabase } from './supabase.js';

        // State
        let originalData = []; // full data from RPC
        let filteredData = [];
        let currentPage = 1;
        const pageSize = 25;

        let feedbackChart, topUsersChart;
        let realtimeChannel;

        // Utilities
        function showOverlay(show=true) {
            document.getElementById('overlay').classList.toggle('show', !!show);
        }

        function formatReadable(iso) {
            if (!iso) return 'N/A';
            try {
                const d = new Date(iso);
                return d.toLocaleString('en-GB', { day:'2-digit', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit' });
            } catch (e) {
                return iso;
            }
        }

        function csvEscape(v) {
            if (v === null || v === undefined) return '';
            const s = typeof v === 'object' ? JSON.stringify(v) : String(v);
            if (s.includes('"') || s.includes(',') || s.includes('\n')) {
                return '"' + s.replace(/"/g, '""') + '"';
            }
            return s;
        }

        // Fetchers (use existing RPC functions)
        async function fetchAllData() {
            showOverlay(true);
            try {
                const [activityRes, feedbackRes, topUsersRes] = await Promise.all([
                    supabase.rpc('get_user_activity_feed'),
                    supabase.rpc('get_feedback_stats'),
                    supabase.rpc('get_top_active_users', { limit_count: 10 })
                ]);

                if (activityRes.error) {
                    console.error('Activity fetch error', activityRes.error);
                    alert('Failed to load activity feed. See console for details.');
                    originalData = [];
                } else {
                    originalData = activityRes.data || [];
                }

                const feedback = (feedbackRes.error ? [] : (feedbackRes.data || []));
                renderFeedbackStats(feedback);

                const topUsers = (topUsersRes.error ? [] : (topUsersRes.data || []));
                renderTopUsersChart(topUsers);

                document.getElementById('lastUpdated').textContent = 'Last updated: ' + new Date().toLocaleString('en-GB');
            } finally {
                showOverlay(false);
            }
        }

        // Rendering
        function renderFeedbackStats(data) {
            const helpful = data.find(d => d.rating_type === 'Helpful')?.count || 0;
            const notHelpful = data.find(d => d.rating_type === 'Not Helpful')?.count || 0;
            document.getElementById('helpfulCount').textContent = helpful;
            document.getElementById('notHelpfulCount').textContent = notHelpful;

            // Chart
            const ctx = document.getElementById('feedbackChart').getContext('2d');
            if (feedbackChart) feedbackChart.destroy();
            feedbackChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Helpful','Not Helpful'],
                    datasets: [{ data: [helpful, notHelpful], backgroundColor: ['#16a34a','#ef4444'] }]
                },
                options: { plugins: { legend: { position: 'bottom', labels:{color:'#d1d5db'} } } }
            });
        }

        function renderTopUsersChart(data) {
            const ctx = document.getElementById('topUsersChart').getContext('2d');
            if (topUsersChart) topUsersChart.destroy();
            const labels = (data||[]).map(d=>d.user_name);
            const values = (data||[]).map(d=>d.activity_count);
            topUsersChart = new Chart(ctx, {
                type:'bar',
                data: { labels, datasets: [{ label:'Activities', data: values }] },
                options: { scales: { y: { beginAtZero:true, ticks:{ color:'#d1d5db' } }, x: { ticks:{ color:'#d1d5db' } } }, plugins:{ legend:{ display:false } } }
            });
        }

        function applyFiltersAndRender() {
            const search = (document.getElementById('searchInput').value||'').trim().toLowerCase();
            const action = document.getElementById('actionFilter').value;
            const range = document.getElementById('timeRange').value;
            let start = null, end = null;
            if (range === 'today') {
                const now = new Date();
                start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                end = new Date(start); end.setDate(end.getDate()+1);
            } else if (range === '7d') {
                end = new Date(); start = new Date(); start.setDate(start.getDate()-6);
            } else if (range === '30d') {
                end = new Date(); start = new Date(); start.setDate(start.getDate()-29);
            } else if (range === 'custom') {
                const s = document.getElementById('startDate').value;
                const e = document.getElementById('endDate').value;
                start = s ? new Date(s + 'T00:00:00') : null;
                end = e ? new Date(e + 'T23:59:59') : null;
            } else {
                // all
                start = null; end = null;
            }

            filteredData = originalData.filter(row => {
                // activity_time field (RPC returns as activity_time)
                const at = row.activity_time || row.timestamp || row.activity_time;
                if (!at) return false;
                const dt = new Date(at);

                if (start && dt < start) return false;
                if (end && dt > end) return false;

                if (action && String(row.action).toLowerCase() !== action.toLowerCase()) return false;

                if (search) {
                    const uname = (row.user_name||'').toString().toLowerCase();
                    const email = (row.user_email||'').toString().toLowerCase();
                    const title = (row.item_title||'').toString().toLowerCase();
                    const details = JSON.stringify(row.details||'').toLowerCase();
                    return uname.includes(search) || email.includes(search) || title.includes(search) || details.includes(search);
                }
                return true;
            });

            currentPage = 1;
            renderTablePage();
            document.getElementById('totalActivities').textContent = filteredData.length;
            document.getElementById('rowsInfo').textContent = `Showing ${Math.min(filteredData.length, (currentPage-1)*pageSize+1)} - ${Math.min(filteredData.length, currentPage*pageSize)} of ${filteredData.length} rows`;
        }

        function renderTablePage() {
            const tbody = document.getElementById('activityTableBody');
            tbody.innerHTML = '';
            if (!filteredData.length) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:40px 0;" class="muted">No activity found for selected filters.</td></tr>`;
                document.getElementById('rowsInfo').textContent = 'Showing 0 rows';
                document.getElementById('totalActivities').textContent = 0;
                return;
            }

            const startIdx = (currentPage-1)*pageSize;
            const page = filteredData.slice(startIdx, startIdx+pageSize);
            for (const r of page) {
                const details = (r.details && typeof r.details === 'object') ? JSON.stringify(r.details) : (r.details || '');
                const html = `<tr>
                    <td>${r.user_name || '-'}</td>
                    <td>${r.user_email || '-'}</td>
                    <td><span class="badge ${r.action==='positive_feedback' || r.action==='helpful' ? 'success':''} ${r.action==='negative_feedback' ? 'error':''}">${r.action || '-'}</span></td>
                    <td>${r.item_title || '-'}</td>
                    <td style="max-width:360px; white-space:pre-wrap;">${details}</td>
                    <td>${formatReadable(r.activity_time || r.timestamp || r.activity_time)}</td>
                </tr>`;
                tbody.insertAdjacentHTML('beforeend', html);
            }

            const from = startIdx+1;
            const to = Math.min(filteredData.length, startIdx+page.length);
            document.getElementById('rowsInfo').textContent = `Showing ${from} - ${to} of ${filteredData.length} rows`;
        }

        // Export CSV
        function exportCsv() {
            if (!filteredData.length) {
                alert('No data to export for the selected filters.');
                return;
            }
            const headers = ['user_name','user_email','action','item_title','details','activity_time'];
            const rows = [headers.join(',')];
            for (const r of filteredData) {
                const row = [
                    csvEscape(r.user_name),
                    csvEscape(r.user_email),
                    csvEscape(r.action),
                    csvEscape(r.item_title),
                    csvEscape(r.details),
                    csvEscape(r.activity_time || r.timestamp)
                ];
                rows.push(row.join(','));
            }
            const csv = rows.join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `infini_activity_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }

        // Realtime subscription: on any change in activity_log or kb_feedback, refresh data
        function setupRealtime() {
            try {
                // Supabase JS v2: channel API
                realtimeChannel = supabase.channel('public:activity_log_kb_feedback')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'activity_log' }, payload => {
                        console.log('Realtime event activity_log', payload);
                        // simple strategy: refresh all data (keeps charts consistent)
                        fetchAllData().then(() => applyFiltersAndRender());
                    })
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'kb_feedback' }, payload => {
                        console.log('Realtime event kb_feedback', payload);
                        fetchAllData().then(() => applyFiltersAndRender());
                    })
                    .subscribe(status => {
                        console.log('Realtime channel status', status);
                    });
            } catch (e) {
                console.warn('Realtime setup failed - check supabase client version', e);
            }

            // cleanup on page unload
            window.addEventListener('beforeunload', () => {
                if (realtimeChannel && realtimeChannel.unsubscribe) {
                    try { realtimeChannel.unsubscribe(); } catch(e){/*ignore*/ }
                }
            });
        }

        // Events
        document.getElementById('timeRange').addEventListener('change', (e) => {
            const v = e.target.value;
            document.getElementById('startDate').style.display = (v==='custom') ? 'inline-block' : 'none';
            document.getElementById('endDate').style.display = (v==='custom') ? 'inline-block' : 'none';
        });

        document.getElementById('applyFiltersBtn').addEventListener('click', () => { applyFiltersAndRender(); });
        document.getElementById('clearFiltersBtn').addEventListener('click', () => {
            document.getElementById('searchInput').value = '';
            document.getElementById('actionFilter').value = '';
            document.getElementById('timeRange').value = 'all';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('startDate').style.display = 'none';
            document.getElementById('endDate').style.display = 'none';
            filteredData = originalData.slice();
            currentPage = 1;
            renderTablePage();
            document.getElementById('totalActivities').textContent = filteredData.length;
        });

        document.getElementById('exportCsvBtn').addEventListener('click', exportCsv);
        document.getElementById('refreshBtn').addEventListener('click', () => fetchAllData().then(()=>applyFiltersAndRender()));

        document.getElementById('prevPage').addEventListener('click', () => {
            if (currentPage > 1) { currentPage--; renderTablePage(); }
        });
        document.getElementById('nextPage').addEventListener('click', () => {
            if (currentPage * pageSize < filteredData.length) { currentPage++; renderTablePage(); }
        });

        // Init
        (async function init() {
            showOverlay(true);
            await fetchAllData();
            // initial filter: show last 7 days by default
            document.getElementById('timeRange').value = '7d';
            applyFiltersAndRender();
            setupRealtime();
            showOverlay(false);
        })();
    </script>
</body>
</html>
