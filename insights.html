<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>InfiniBase - Knowledge Base Insights</title>
  
  <!-- Favicon -->
  <link href="data:image/svg+xml,&lt;svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32' width='32' height='32'&gt;&lt;rect width='32' height='32' rx='4' fill='%236366f1'/&gt;&lt;text x='50%' y='55%' dominant-baseline='middle' text-anchor='middle' font-family='Arial, sans-serif' font-size='18' font-weight='bold' fill='white'&gt;IB&lt;/text&gt;&lt;/svg&gt;" rel="icon" type="image/svg+xml"/>
  
  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  
  <!-- Main Styles -->
  <style>
    :root {
      --primary-color: #6366f1;
      --primary-color-hover: #4f46e5;
      --text-color: #d1d5db;
      --text-color-muted: #9ca3af;
      --bg-color: #111827;
      --bg-color-alt: #1f2937;
      --border-color: #374151;
      --border-radius: 0.5rem;
      --border-radius-lg: 0.75rem;
      --header-height: 65px;
      --yes-color: #22c55e;
      --no-color: #ef4444;
      --rating-color: #fbbf24;
    }
    html, body {
      height: 100%; margin: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: var(--bg-color); color: var(--text-color);
      font-size: 15px; /* Base font size */
    }
    .page-wrapper {
      padding: 1.25rem 1.5rem;
      padding-top: calc(var(--header-height) + 1.25rem);
      padding-bottom: 2rem; /* Added padding to avoid footer overlap */
    }
    .page-header {
        position: fixed; top: 0; left: 0; right: 0;
        height: var(--header-height);
        display: flex; justify-content: space-between; align-items: center;
        padding: 0 1.5rem;
        background-color: rgba(31, 41, 55, 0.8);
        border-bottom: 1px solid var(--border-color);
        backdrop-filter: blur(8px); z-index: 100;
    }
    .page-header .header-title { display: flex; align-items: center; gap: 0.8rem; }
    .page-header .logo-icon { font-size: 1.6rem; color: var(--primary-color); }
    .page-header h1 { font-size: 1.5rem; font-weight: 600; color: white; margin: 0; }
    
    .button, button {
        background-color: var(--primary-color); color: white; border: 1px solid transparent;
        padding: 0.65rem 1.1rem; border-radius: var(--border-radius);
        cursor: pointer; font-size: 0.9rem; font-weight: 500;
        transition: all 0.2s; text-decoration: none;
        display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
    }
    .button:hover, button:hover { background-color: var(--primary-color-hover); transform: translateY(-2px); }
    .button-secondary { background-color: var(--bg-color-alt); color: var(--text-color); border-color: var(--border-color); }
    .button-secondary:hover { background-color: var(--border-color); color: white; }
    
    .card {
      background-color: var(--bg-color-alt); border: 1px solid var(--border-color);
      border-radius: var(--border-radius-lg); padding: 1.25rem; margin-bottom: 1.25rem;
    }
    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border-color);
    }
    .card-header h2 {
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    .card-header h2 i { color: var(--primary-color); }

    .filters { display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-end; }
    .filters .form-group { display: flex; flex-direction: column; flex-grow: 1; }
    .filters .form-group label {
        font-size: 0.85rem; font-weight: 500;
        color: var(--text-color-muted); margin-bottom: 0.4rem;
    }
    .filters input, .filters select {
        width: 100%; padding: 0.7rem; border: 1px solid var(--border-color);
        border-radius: var(--border-radius); background-color: var(--bg-color);
        color: var(--text-color); font-size: 0.9rem;
    }
    .filters .search-group { flex-basis: 350px; }

    .insights-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 1.25rem;
    }

    .chart-wrapper { position: relative; height: 320px; }

    .table-wrap { overflow-x: auto; max-height: 500px; }
    table { width: 100%; border-collapse: collapse; min-width: 900px; }
    th, td {
      padding: 0.8rem 1rem; border-bottom: 1px solid var(--border-color);
      font-size: 0.9rem; text-align: left; /* LTR support */
      white-space: nowrap;
    }
    thead th {
      background-color: #111827; color: var(--text-color-muted); font-size: 0.75rem;
      text-transform: uppercase; letter-spacing: 0.05em;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tbody tr:hover { background-color: #2a3546; }

    .spinner-overlay{ position:fixed; inset:0; background:rgba(17,24,39,0.8); display:flex; align-items:center; justify-content:center; z-index:1000; }
    .spinner { width:50px; height:50px; border-radius:50%; border:4px solid var(--border-color); border-top-color:var(--primary-color); animation:spin 1s linear infinite; }
    @keyframes spin{ to{transform:rotate(360deg);} }
    
    .toast{ position:fixed; top:20px; right:20px; padding:12px 16px; border-radius: var(--border-radius); color:white; background-color: #ef4444; z-index:1100; display:flex; align-items:center; gap:10px; cursor:pointer; opacity:0; transform:translateY(-10px); transition: all .3s; }
    .toast.show { opacity:1; transform:translateY(0); }
    
    .access-restricted-container { display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; height: 100vh; width: 100%; }
    .access-restricted-container .card { max-width: 450px; padding: 3rem; }
    .access-restricted-container .icon { font-size: 4rem; color: var(--primary-color); margin-bottom: 1.5rem; }
    .access-restricted-container h2 { font-size: 1.75rem; margin-bottom: 0.5rem; color: white; }
    .access-restricted-container p { color: var(--text-color-muted); margin-bottom: 2rem; }
  </style>
</head>
<body>

<!-- Main dashboard view, hidden by default -->
<div id="dashboard" style="visibility: hidden;">
  <header class="page-header">
    <div class="header-title">
        <i class="fas fa-chart-pie logo-icon"></i>
        <h1>Knowledge Base Insights</h1>
    </div>
    <a href="app.html" class="button button-secondary"><i class="fas fa-arrow-left"></i> Back to Dashboard</a>
  </header>
  
  <div class="page-wrapper">
    <div id="toast" class="toast"></div>
    <div id="spinner" class="spinner-overlay" style="display: none;"><div class="spinner"></div></div>

    <div class="card filters">
      <div class="form-group search-group">
        <label for="searchInput">Search Tables</label>
        <input id="searchInput" type="text" placeholder="Search by title, name, email, or section..." autocomplete="off" />
      </div>
      <button id="exportBtn" class="button-secondary" style="margin-left: 0.5rem;"><i class="fas fa-file-csv"></i> Export All Data</button>
    </div>
    
    <div class="insights-grid">
        <div class="card">
            <div class="card-header" style="border: none; padding-bottom: 0;">
                <h2><i class="fas fa-chart-bar"></i>Activity by Section</h2>
            </div>
            <div class="chart-wrapper">
                <canvas id="activityBySectionChart"></canvas>
            </div>
        </div>
        <div class="card">
            <div class="card-header" style="border: none; padding-bottom: 0;">
                <h2><i class="fas fa-fire"></i>Top Viewed Articles</h2>
            </div>
            <div class="chart-wrapper">
                <canvas id="topArticlesChart"></canvas>
            </div>
        </div>
    </div>


    <!-- Article Insights Table -->
    <div class="card">
      <div class="card-header">
        <h2><i class="fas fa-newspaper"></i>Article Performance</h2>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Article Title</th>
              <th>Total Views</th>
              <th>Avg Rating (1=Helpful)</th>
              <th>Total Feedbacks</th>
              <th>Last Viewed (Egypt Time)</th>
              <th>Last Viewed By</th>
            </tr>
          </thead>
          <tbody id="articleInsightsTable"></tbody>
        </table>
      </div>
    </div>
    
    <!-- User Insights Table -->
    <div class="card">
        <div class="card-header">
            <h2><i class="fas fa-users"></i>User Engagement</h2>
        </div>
        <div class="table-wrap">
            <table>
            <thead>
                <tr>
                <th>User Name</th>
                <th>Email</th>
                <th>Total Articles Viewed</th>
                <th>Unique Articles Viewed</th>
                <th>Average Feedback Rating</th>
                <th>Last Activity (Egypt Time)</th>
                </tr>
            </thead>
            <tbody id="userInsightsTable"></tbody>
            </table>
        </div>
    </div>

    <!-- Section Insights Table -->
    <div class="card">
        <div class="card-header">
            <h2><i class="fas fa-folder-tree"></i>Section Performance</h2>
        </div>
        <div class="table-wrap">
            <table>
            <thead>
                <tr>
                <th>Section Name</th>
                <th>Total Articles</th>
                <th>Total Views</th>
                <th>Average Rating</th>
                <th>Total Feedbacks</th>
                <th>Last Activity (Egypt Time)</th>
                </tr>
            </thead>
            <tbody id="sectionInsightsTable"></tbody>
            </table>
        </div>
    </div>

  </div>
</div>

<!-- Access restricted view -->
<div id="restricted-card" class="access-restricted-container">
    <div class="card">
        <div class="icon">🔒</div>
        <h2>Access Restricted</h2>
        <p>This page is available for administrators only.</p>
        <a href="app.html" class="button">Back to Dashboard</a>
    </div>
</div>

<!-- Footer -->
<footer style="padding: 1.5rem; text-align: center; color: var(--text-color-muted); font-size: 0.85rem;">
  <span>© <script>document.write(new Date().getFullYear())</script> InfiniBase.Elmenisy.</span>
</footer>


  <script type="module">
    import { supabase } from './supabase.js';

    let allInsights = { articles: [], users: [], sections: [] };
    let filteredInsights = { articles: [], users: [], sections: [] };

    const toast = document.getElementById('toast');
    const spinner = document.getElementById('spinner');

    let activityBySectionChart = null, topArticlesChart = null;

    function showSpinner(show) { spinner.style.display = show ? 'flex' : 'none'; }

    function showToast(message, isError = true) {
      toast.textContent = message;
      toast.style.backgroundColor = isError ? '#ef4444' : '#22c55e';
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }
    
    function escapeHtml(unsafe) {
      if (unsafe === null || unsafe === undefined) return '';
      return String(unsafe).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
    }

    function createChart(ctx, type, labels, data, dataLabel, backgroundColors) {
        const legendColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim();
        const ticksColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color-muted').trim();
        const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim();
        const defaultOptions = { responsive: true, maintainAspectRatio: false };
        if (type === 'bar') {
            return new Chart(ctx, { type, data: { labels, datasets: [{ label: dataLabel, data, backgroundColor: backgroundColors }] }, options: { ...defaultOptions, scales: { y: { beginAtZero: true, ticks: { color: ticksColor }, grid: { color: gridColor } }, x: { ticks: { color: ticksColor }, grid: { display: false } } } } });
        }
        return new Chart(ctx, { type, data: { labels, datasets: [{ label: dataLabel, data, backgroundColor: backgroundColors }] }, options: { ...defaultOptions, plugins: { legend: { position: 'right', labels: { color: legendColor } } } } });
    }
    
    function renderTables() {
        const { articles, users, sections } = filteredInsights;
        
        document.getElementById('articleInsightsTable').innerHTML = articles.map(item => `
            <tr>
                <td>${escapeHtml(item.article_title)}</td>
                <td>${item.total_views}</td>
                <td>${item.avg_rating}</td>
                <td>${item.total_feedbacks}</td>
                <td>${escapeHtml(item.last_view_egypt)}</td>
                <td>${escapeHtml(item.last_viewed_by)}</td>
            </tr>
        `).join('') || '<tr><td colspan="6" style="text-align:center;">No matching articles found.</td></tr>';

        document.getElementById('userInsightsTable').innerHTML = users.map(item => `
            <tr>
                <td>${escapeHtml(item.user_name)}</td>
                <td>${escapeHtml(item.user_email)}</td>
                <td>${item.total_articles_viewed}</td>
                <td>${item.unique_articles_viewed}</td>
                <td>${item.avg_feedback_rating}</td>
                <td>${escapeHtml(item.last_activity_egypt)}</td>
            </tr>
        `).join('') || '<tr><td colspan="6" style="text-align:center;">No matching users found.</td></tr>';

        document.getElementById('sectionInsightsTable').innerHTML = sections.map(item => `
            <tr>
                <td>${escapeHtml(item.section_name)}</td>
                <td>${item.total_articles}</td>
                <td>${item.total_views}</td>
                <td>${item.avg_rating}</td>
                <td>${item.total_feedbacks}</td>
                <td>${escapeHtml(item.last_activity_egypt)}</td>
            </tr>
        `).join('') || '<tr><td colspan="6" style="text-align:center;">No matching sections found.</td></tr>';
    }

    function renderCharts() {
        // Activity by Section Chart
        if (activityBySectionChart) activityBySectionChart.destroy();
        const sectionLabels = allInsights.sections.map(s => s.section_name);
        const sectionViews = allInsights.sections.map(s => s.total_views);
        activityBySectionChart = createChart(document.getElementById('activityBySectionChart').getContext('2d'), 'doughnut', sectionLabels, sectionViews, 'Total Views', ['#6366F1', '#22C55E', '#FBBF24', '#EC4899', '#38BDF8']);

        // Top 5 Viewed Articles Chart
        if (topArticlesChart) topArticlesChart.destroy();
        const topArticles = [...allInsights.articles].sort((a,b) => b.total_views - a.total_views).slice(0, 5);
        const articleLabels = topArticles.map(a => a.article_title);
        const articleViews = topArticles.map(a => a.total_views);
        topArticlesChart = createChart(document.getElementById('topArticlesChart').getContext('2d'), 'bar', articleLabels, articleViews, 'Total Views', '#6366F1');
    }

    function applyFilters() {
        const search = document.getElementById('searchInput').value.trim().toLowerCase();
        
        if (!search) {
            filteredInsights = { ...allInsights };
        } else {
            filteredInsights.articles = allInsights.articles.filter(a => a.article_title.toLowerCase().includes(search));
            filteredInsights.users = allInsights.users.filter(u => u.user_name?.toLowerCase().includes(search) || u.user_email?.toLowerCase().includes(search));
            filteredInsights.sections = allInsights.sections.filter(s => s.section_name.toLowerCase().includes(search));
        }
        renderTables();
    }
    
    function exportCSV() {
        let csvContent = "data:text/csv;charset=utf-8,";
        
        const generateCsvSection = (title, headers, data) => {
            let sectionCsv = `${title}\n`;
            sectionCsv += headers.join(',') + '\n';
            data.forEach(item => {
                const row = headers.map(header => `"${String(item[header.toLowerCase().replace(/ /g, '_')] || '').replace(/"/g, '""')}"`);
                sectionCsv += row.join(',') + '\n';
            });
            return sectionCsv + '\n';
        };

        csvContent += generateCsvSection("Article Performance", ["article_title", "total_views", "avg_rating", "total_feedbacks", "last_view_egypt", "last_viewed_by"], allInsights.articles);
        csvContent += generateCsvSection("User Engagement", ["user_name", "user_email", "total_articles_viewed", "unique_articles_viewed", "avg_feedback_rating", "last_activity_egypt"], allInsights.users);
        csvContent += generateCsvSection("Section Performance", ["section_name", "total_articles", "total_views", "avg_rating", "total_feedbacks", "last_activity_egypt"], allInsights.sections);
        
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "infinibase_insights.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    async function fetchData() {
      showSpinner(true);
      try {
        const [articles, users, sections] = await Promise.all([
            supabase.from('v_article_insights').select('*'),
            supabase.from('v_user_insights').select('*'),
            supabase.from('v_section_insights').select('*')
        ]);

        if (articles.error) throw new Error(`Article Insights: ${articles.error.message}`);
        if (users.error) throw new Error(`User Insights: ${users.error.message}`);
        if (sections.error) throw new Error(`Section Insights: ${sections.error.message}`);
        
        allInsights = {
            articles: articles.data || [],
            users: users.data || [],
            sections: sections.data || []
        };
        
        applyFilters();
        renderCharts();

      } catch (e) {
        console.error('Error loading initial data:', e);
        showToast(`Failed to load data: ${e.message}`);
      } finally {
        showSpinner(false);
      }
    }

    async function checkAdminAccess() {
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
          document.getElementById('restricted-card').style.display = 'flex';
          return;
        }
        const { data, error } = await supabase.from('users').select('role').eq('id', user.id).single();
        if (error || !data || data.role !== 'admin') {
          document.getElementById('restricted-card').style.display = 'flex';
        } else {
          document.getElementById('dashboard').style.visibility = 'visible';
          await fetchData();

          // Set up real-time subscriptions
          supabase.channel('public:activity_log_and_feedback')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'activity_log' }, (payload) => {
              console.log('Real-time activity change received!', payload);
              fetchData();
            })
            .on('postgres_changes', { event: '*', schema: 'public', table: 'kb_feedback' }, (payload) => {
              console.log('Real-time feedback change received!', payload);
              fetchData();
            })
            .subscribe();
        }
      } catch (e) {
        console.error('Admin check failed:', e);
        document.getElementById('restricted-card').style.display = 'flex';
      }
    }

    // Event Listeners
    document.getElementById('searchInput').addEventListener('input', applyFilters);
    document.getElementById('exportBtn').onclick = exportCSV;

    // Start the application
    document.addEventListener('DOMContentLoaded', checkAdminAccess);
  </script>

</body>
</html>
