<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>User Activity Insights (Final Expanded)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    /* Highlight animation for realtime rows */
    .highlight { 
      background-color: rgba(59,130,246,0.3) !important; 
      transition: background-color 1s ease; 
    }
  </style>
</head>
<body class="bg-gray-900 text-gray-100">
  <div class="container mx-auto p-6">
    <!-- Page Title -->
    <h1 class="text-2xl font-bold mb-6">User Activity Insights</h1>

    <!-- Toast Notification -->
    <div id="toast" 
         class="hidden fixed top-4 right-4 text-white px-4 py-2 rounded-lg shadow-lg z-50 flex items-center space-x-2 cursor-pointer"></div>

    <!-- Spinner Overlay -->
    <div id="spinner" 
         class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-white"></div>
    </div>

    <!-- ================= FILTERS ================= -->
    <div class="bg-gray-800 p-4 rounded-2xl shadow mb-6 flex flex-wrap gap-4 items-end">
      <!-- Time Filter -->
      <div>
        <label class="block text-sm">Time Range</label>
        <select id="timeFilter" class="bg-gray-700 rounded px-2 py-1">
          <option value="all">All</option>
          <option value="today">Today</option>
          <option value="7d">Last 7 days</option>
          <option value="30d">Last 30 days</option>
        </select>
      </div>

      <!-- Action Filter -->
      <div>
        <label class="block text-sm">Action</label>
        <select id="actionFilter" class="bg-gray-700 rounded px-2 py-1">
          <option value="all">All</option>
          <option value="viewed">Viewed</option>
          <option value="updated">Updated</option>
          <option value="deleted">Deleted</option>
        </select>
      </div>

      <!-- Search -->
      <div class="flex-1">
        <label class="block text-sm">Search</label>
        <input id="searchInput" 
               type="text" 
               placeholder="User, Email, Case..." 
               class="w-full bg-gray-700 rounded px-2 py-1" />
      </div>

      <!-- Export Button -->
      <button id="exportBtn" 
              class="bg-green-600 hover:bg-green-700 px-3 py-1 rounded">
        Export CSV
      </button>
    </div>

    <!-- ================= STATS CARDS ================= -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
      <!-- Total Activities -->
      <div class="bg-gray-800 p-4 rounded-2xl shadow">
        <h2 class="text-lg font-semibold mb-2">Total Activities</h2>
        <p id="totalActivities" class="text-3xl font-bold">0</p>
      </div>

      <!-- Helpful Feedback -->
      <div class="bg-gray-800 p-4 rounded-2xl shadow">
        <h2 class="text-lg font-semibold mb-2">Helpful Feedback</h2>
        <p id="helpfulCount" class="text-3xl font-bold">0</p>
      </div>

      <!-- Not Helpful Feedback -->
      <div class="bg-gray-800 p-4 rounded-2xl shadow">
        <h2 class="text-lg font-semibold mb-2">Not Helpful Feedback</h2>
        <p id="notHelpfulCount" class="text-3xl font-bold">0</p>
      </div>
    </div>

    <!-- ================= CHARTS ================= -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
      <!-- Feedback Chart -->
      <div class="bg-gray-800 p-6 rounded-2xl shadow">
        <h2 class="text-lg font-semibold mb-4">Feedback Distribution</h2>
        <canvas id="feedbackChart"></canvas>
      </div>

      <!-- Active Users Chart -->
      <div class="bg-gray-800 p-6 rounded-2xl shadow">
        <h2 class="text-lg font-semibold mb-4">Top Active Users</h2>
        <canvas id="activeUsersChart"></canvas>
      </div>
    </div>

    <!-- ================= ACTIVITY FEED ================= -->
    <div class="bg-gray-800 p-6 rounded-2xl shadow">
      <h2 class="text-lg font-semibold mb-4">Recent Activities</h2>

      <!-- Activity Table -->
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-700">
            <tr>
              <th class="px-4 py-2 text-left">User</th>
              <th class="px-4 py-2 text-left">Email</th>
              <th class="px-4 py-2 text-left">Case</th>
              <th class="px-4 py-2 text-left">Action</th>
              <th class="px-4 py-2 text-left">Details</th>
              <th class="px-4 py-2 text-left">Activity Time</th>
            </tr>
          </thead>
          <tbody id="activityTable" class="divide-y divide-gray-700"></tbody>
        </table>
      </div>

      <!-- Load More Button -->
      <div class="flex justify-center mt-4">
        <button id="loadMoreBtn" class="bg-gray-700 px-3 py-1 rounded">Load More</button>
      </div>
    </div>
  </div>

  <!-- ================= JAVASCRIPT ================= -->
  <script type="module">
    import { supabase } from './supabase.js';

    // ---------------- Variables ----------------
    let activities = [];
    let feedbackStats = { helpful: 0, notHelpful: 0 };
    let topUsers = [];
    let currentPage = 1;
    const pageSize = 25;

    const table = document.getElementById('activityTable');
    const totalActivitiesEl = document.getElementById('totalActivities');
    const helpfulCountEl = document.getElementById('helpfulCount');
    const notHelpfulCountEl = document.getElementById('notHelpfulCount');
    const toast = document.getElementById('toast');
    const spinner = document.getElementById('spinner');

    let feedbackChart, activeUsersChart;

    // ---------------- Helpers ----------------
    function showSpinner(show) { spinner.classList.toggle('hidden', !show); }

    function showToast(message, type, rowId) {
      const colors = { insert: 'bg-green-600', update: 'bg-blue-600', delete: 'bg-red-600' };
      const icons = { insert: '‚úÖ', update: '‚úèÔ∏è', delete: 'üóëÔ∏è' };
      toast.className = `fixed top-4 right-4 text-white px-4 py-2 rounded-lg shadow-lg z-50 flex items-center space-x-2 cursor-pointer ${colors[type] || 'bg-indigo-600'}`;
      toast.innerHTML = `<span>${icons[type] || '‚ÑπÔ∏è'}</span><span>${message}</span>`;
      toast.classList.remove('hidden');
      toast.onclick = () => {
        if (rowId) {
          const row = document.getElementById(rowId);
          if (row) {
            row.scrollIntoView({ behavior: 'smooth', block: 'center' });
            row.classList.add('highlight');
            setTimeout(() => row.classList.remove('highlight'), 3000);
          }
        }
        toast.classList.add('hidden');
      };
      setTimeout(() => toast.classList.add('hidden'), 4000);
    }

    function renderActivities(filtered) {
      table.innerHTML = '';
      const start = 0;
      const end = currentPage * pageSize;
      filtered.slice(start, end).forEach((act, idx) => {
        const rowId = `row-${idx}`;
        const row = `<tr id="${rowId}">
          <td class='px-4 py-2'>${act.user_name}</td>
          <td class='px-4 py-2'>${act.user_email}</td>
          <td class='px-4 py-2'>${act.item_title || '-'}</td>
          <td class='px-4 py-2'>${act.action}</td>
          <td class='px-4 py-2'>${JSON.stringify(act.details)}</td>
          <td class='px-4 py-2'>${act.activity_time}</td>
        </tr>`;
        table.insertAdjacentHTML('beforeend', row);
      });
      totalActivitiesEl.textContent = filtered.length;
    }

    function renderFeedback() {
      helpfulCountEl.textContent = feedbackStats.helpful;
      notHelpfulCountEl.textContent = feedbackStats.notHelpful;
      if (feedbackChart) feedbackChart.destroy();
      feedbackChart = new Chart(document.getElementById('feedbackChart'), {
        type: 'doughnut',
        data: {
          labels: ['Helpful', 'Not Helpful'],
          datasets: [{ 
            data: [feedbackStats.helpful, feedbackStats.notHelpful], 
            backgroundColor: ['#10B981', '#EF4444'] 
          }]
        }
      });
    }

    function renderTopUsers() {
      if (activeUsersChart) activeUsersChart.destroy();
      activeUsersChart = new Chart(document.getElementById('activeUsersChart'), {
        type: 'bar',
        data: {
          labels: topUsers.map(u => u.user_name),
          datasets: [{ 
            label: 'Activities', 
            data: topUsers.map(u => u.activity_count), 
            backgroundColor: '#6366F1' 
          }]
        },
        options: { scales: { y: { beginAtZero: true } } }
      });
    }

    function filterActivities() {
      const timeFilter = document.getElementById('timeFilter').value;
      const actionFilter = document.getElementById('actionFilter').value;
      const search = document.getElementById('searchInput').value.toLowerCase();
      let filtered = [...activities];
      const now = new Date();

      // Filter by time
      if (timeFilter !== 'all') {
        filtered = filtered.filter(a => {
          const ts = new Date(a.activity_time);
          if (timeFilter === 'today') return ts.toDateString() === now.toDateString();
          if (timeFilter === '7d') return (now - ts) / (1000*60*60*24) <= 7;
          if (timeFilter === '30d') return (now - ts) / (1000*60*60*24) <= 30;
          return true;
        });
      }

      // Filter by action
      if (actionFilter !== 'all') filtered = filtered.filter(a => a.action === actionFilter);

      // Search filter
      if (search) {
        filtered = filtered.filter(a =>
          a.user_name.toLowerCase().includes(search) ||
          a.user_email.toLowerCase().includes(search) ||
          (a.item_title || '').toLowerCase().includes(search) ||
          JSON.stringify(a.details).toLowerCase().includes(search)
        );
      }

      return filtered;
    }

    function exportCSV(data) {
      const headers = ['User','Email','Case','Action','Details','Activity Time'];
      const rows = data.map(a => [a.user_name,a.user_email,a.item_title||'-',a.action,JSON.stringify(a.details),a.activity_time]);
      let csv = headers.join(',') + '\n';
      rows.forEach(r => { csv += r.join(',') + '\n'; });
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'activities.csv'; a.click();
      URL.revokeObjectURL(url);
    }

    async function initData() {
      showSpinner(true);
      const { data: acts } = await supabase.rpc('get_user_activity_feed');
      const { data: fb } = await supabase.rpc('get_feedback_stats');
      const { data: tu } = await supabase.rpc('get_top_active_users', { limit_count: 5 });

      activities = acts || [];
      feedbackStats = { 
        helpful: fb?.find(f => f.rating_type === 'Helpful')?.count || 0, 
        notHelpful: fb?.find(f => f.rating_type === 'Not Helpful')?.count || 0 
      };
      topUsers = tu || [];

      renderActivities(filterActivities());
      renderFeedback();
      renderTopUsers();
      showSpinner(false);
    }

    // ---------------- Event Listeners ----------------
    document.getElementById('timeFilter').onchange = () => renderActivities(filterActivities());
    document.getElementById('actionFilter').onchange = () => renderActivities(filterActivities());
    document.getElementById('searchInput').oninput = () => renderActivities(filterActivities());
    document.getElementById('loadMoreBtn').onclick = () => { currentPage++; renderActivities(filterActivities()); };
    document.getElementById('exportBtn').onclick = () => exportCSV(filterActivities());

    // ---------------- Realtime Subscriptions ----------------
    supabase.channel('activity_log_changes').on(
      'postgres_changes',
      {event:'*',schema:'public',table:'activity_log'},
      payload => {
        if(payload.eventType==='INSERT'){ 
          activities.unshift(payload.new); 
          showToast(`${payload.new.user_name} ${payload.new.action} ${payload.new.item_title}`,'insert','row-0'); 
        }
        else if(payload.eventType==='UPDATE'){ 
          const idx=activities.findIndex(a=>a.id===payload.new.id); 
          if(idx>-1) activities[idx]=payload.new; 
          showToast(`${payload.new.user_name} updated ${payload.new.item_title}`,'update',`row-${idx}`); 
        }
        else if(payload.eventType==='DELETE'){ 
          activities=activities.filter(a=>a.id!==payload.old.id); 
          showToast(`${payload.old.user_name} deleted ${payload.old.item_title}`,'delete'); 
        }
        renderActivities(filterActivities());
      }
    ).subscribe();

    supabase.channel('feedback_changes').on(
      'postgres_changes',
      {event:'*',schema:'public',table:'kb_feedback'},
      ()=>{
        supabase.rpc('get_feedback_stats').then(({data:fb})=>{
          feedbackStats={ 
            helpful: fb?.find(f => f.rating_type==='Helpful')?.count||0, 
            notHelpful: fb?.find(f => f.rating_type==='Not Helpful')?.count||0 
          };
          renderFeedback();
        });
      }
    ).subscribe();

    // ---------------- Init ----------------
    initData();
  </script>
</div>

<div id="restricted-card" class="hidden flex items-center justify-center h-screen bg-gray-900">
  <div class="bg-gray-800 text-center p-10 rounded-2xl shadow-2xl max-w-md">
    <div class="text-indigo-400 text-6xl mb-4">üîí</div>
    <h2 class="text-2xl font-bold text-white mb-2">Access Restricted</h2>
    <p class="text-gray-400 mb-6">This page is available to administrators only.</p>
    <a href="/" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-6 rounded-lg">Go Back Home</a>
  </div>
</div>


<script type="module">
import { supabase } from './supabase.js';

async function checkAdminAccess() {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return;
  const { data, error } = await supabase
    .from('users')
    .select('role')
    .eq('id', user.id)
    .single();

  if (!error && data && data.role !== 'admin') {
    document.getElementById('dashboard').classList.add('hidden');
    document.getElementById('restricted-card').classList.remove('hidden');
  }
}
checkAdminAccess();
</script>

</body>
</html>
