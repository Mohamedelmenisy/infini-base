<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>InfiniBase - User Activity Insights</title>
  <link href="data:image/svg+xml,&lt;svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32' width='32' height='32'&gt;&lt;rect width='32' height='32' rx='4' fill='%236366f1'/&gt;&lt;text x='50%' y='55%' dominant-baseline='middle' text-anchor='middle' font-family='Arial, sans-serif' font-size='18' font-weight='bold' fill='white'&gt;IB&lt;/text&gt;&lt;/svg&gt;" rel="icon" type="image/svg+xml"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  <style>
    :root {
      --primary-color: #6366f1;
      --primary-color-hover: #4f46e5;
      --text-color: #d1d5db;
      --text-color-muted: #9ca3af;
      --bg-color: #0b1220;
      --bg-color-alt: #0f1724;
      --border-color: #1f2937;
      --border-radius: 0.5rem;
      --border-radius-lg: 0.75rem;
      --header-height: 72px;
    }
    html, body {
      height: 100%; margin: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: var(--bg-color); color: var(--text-color);
      font-size: 16px;
    }
    .page-wrapper {
      padding: 1.25rem 2rem;
      padding-top: calc(var(--header-height) + 1.25rem);
      max-width: 1200px; margin: 0 auto;
    }
    .page-header {
        position: fixed; top: 0; left: 0; right: 0;
        height: var(--header-height);
        display: flex; justify-content: space-between; align-items: center;
        padding: 0 2rem;
        background-color: rgba(10, 15, 25, 0.7);
        border-bottom: 1px solid rgba(255,255,255,0.03);
        backdrop-filter: blur(6px); z-index: 100;
    }
    .page-header .header-title { display: flex; align-items: center; gap: 0.75rem; }
    .page-header .logo-icon { font-size: 1.4rem; color: var(--primary-color); }
    .page-header h1 {
      font-size: 1.25rem; font-weight: 700; color: white; margin: 0;
    }
    .button, button {
        background-color: var(--primary-color); color: white; border: 1px solid transparent;
        padding: 0.5rem 0.9rem; border-radius: var(--border-radius);
        cursor: pointer; font-size: 0.95rem; font-weight: 600;
        transition: all 0.15s; text-decoration: none;
        display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
    }
    .button:hover, button:hover { background-color: var(--primary-color-hover); transform: translateY(-1px); }
    .button-secondary {
        background-color: transparent; color: var(--text-color); border: 1px solid rgba(255,255,255,0.04);
    }
    .button-secondary:hover { background-color: rgba(255,255,255,0.02); color: white; border-color: rgba(255,255,255,0.06); }
    #exportBtn:hover { background-color: rgba(99,102,241,0.12); border-color: rgba(99,102,241,0.25); color: var(--primary-color); }
    .card {
      background-color: var(--bg-color-alt); border: 1px solid rgba(255,255,255,0.03);
      border-radius: var(--border-radius-lg); padding: 1.1rem; margin-bottom: 1rem;
    }
    .filters { display: flex; flex-wrap: wrap; gap: 0.9rem; align-items: flex-end; justify-content: space-between; }
    .filters .form-group { display: flex; flex-direction: column; width: 100%; max-width: 320px; }
    .filters .form-group label {
        font-size: 0.82rem; font-weight: 600;
        color: var(--text-color-muted); margin-bottom: 0.45rem;
    }
    .filters input, .filters select {
        width: 100%; padding: 0.6rem; border: 1px solid rgba(255,255,255,0.03);
        border-radius: var(--border-radius); background-color: transparent;
        color: var(--text-color); font-size: 0.95rem;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.9rem; margin-bottom: 0.9rem;
    }
    .stat-card { text-align: left; padding: 0.9rem; min-height: 64px; display:flex; flex-direction:column; justify-content:center; }
    .stat-card h2 {
        font-size: 0.92rem; font-weight:700;
        color: var(--text-color-muted); margin: 0 0 0.45rem 0;
    }
    .stat-card .stat-value { font-size: 1.6rem; font-weight:800; }
    .stat-card .stat-value.helpful { color: #22c55e; }
    .stat-card .stat-value.not-helpful { color: #ef4444; }
    .chart-wrapper {
        position: relative;
        height: 260px;
    }
    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; min-width: 840px; }
    th, td {
      padding: 0.86rem 1rem; border-bottom: 1px solid rgba(255,255,255,0.025);
      font-size: 0.95rem; text-align: left;
    }
    thead th {
      background-color: transparent; color: var(--text-color-muted); font-size: 0.78rem;
      text-transform: uppercase; letter-spacing: 0.03em;
    }
    tbody tr:hover { background-color: rgba(255,255,255,0.02); }
    .pagination { display:flex; gap:0.75rem; align-items:center; justify-content:flex-end; margin-top:12px; }
    .spinner-overlay{ position:fixed; inset:0; background:rgba(11,17,28,0.7); display:flex; align-items:center; justify-content:center; z-index:1000; }
    .spinner { width:48px; height:48px; border-radius:50%; border:4px solid rgba(255,255,255,0.06); border-top-color:var(--primary-color); animation:spin 1s linear infinite; }
    @keyframes spin{ to{transform:rotate(360deg);} }
    .toast{ position:fixed; top:20px; right:20px; padding:10px 14px; border-radius: var(--border-radius); color:white; z-index:1100; display:flex; align-items:center; gap:10px; cursor:pointer; opacity:0; transform:translateY(-10px); transition: all .2s; }
    .toast.show { opacity:1; transform:translateY(0); }
    .access-restricted-container { display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; height: 100vh; width: 100%; }
    .access-restricted-container .card { max-width: 450px; padding: 2.5rem; }
    .access-restricted-container .icon { font-size: 3rem; color: var(--primary-color); margin-bottom: 1.25rem; }
    .access-restricted-container h2 { font-size: 1.5rem; margin-bottom: 0.5rem; color: white; }
    .access-restricted-container p { color: var(--text-color-muted); margin-bottom: 1.25rem; }
    @media (max-width:900px){ .stats-grid { grid-template-columns: 1fr; } .filters { gap:0.6rem; } }
  </style>
</head>
<body>

<div id="dashboard" style="visibility: hidden;">
  <header class="page-header">
    <div class="header-title">
        <i class="fas fa-chart-pie logo-icon"></i>
        <h1>Insights â€” Knowledge Base</h1>
    </div>
    <div style="display:flex; gap:0.6rem;">
      <a href="app.html" class="button button-secondary"><i class="fas fa-arrow-left"></i> Back</a>
      <button id="debugBtn" class="button button-secondary">Debug</button>
    </div>
  </header>
  
  <div class="page-wrapper">
    <div id="toast" class="toast"></div>
    <div id="spinner" class="spinner-overlay" style="display: none;"><div class="spinner"></div></div>

    <div class="card filters">
      <div style="display:flex; gap:0.9rem; width:100%; align-items:flex-end; justify-content:space-between;">
        <div class="form-group">
          <label for="timeFilter">Time Range</label>
          <select id="timeFilter">
            <option value="all">All time</option>
            <option value="today">Today</option>
            <option value="7d">Last 7 days</option>
            <option value="30d">Last 30 days</option>
          </select>
        </div>
        <div class="form-group">
          <label for="actionFilter">Action</label>
          <select id="actionFilter">
            <option value="all">All</option>
            <option value="viewed">Viewed</option>
            <option value="updated">Updated</option>
            <option value="deleted">Deleted</option>
            <option value="insert">Insert</option>
          </select>
        </div>
        <div class="form-group search-group">
          <label for="searchInput">Search</label>
          <input id="searchInput" type="text" placeholder="Search by user, email or case..." />
        </div>
        <div style="display:flex; gap:0.5rem; align-items:center;">
          <button id="refreshBtn" class="button-secondary">Refresh</button>
          <button id="exportBtn" class="button"><i class="fas fa-file-csv"></i> Export</button>
        </div>
      </div>
    </div>

    <div class="card stats-grid" aria-hidden="false">
      <div class="stat-card">
        <h2>Total Activities</h2>
        <p id="totalActivities" class="stat-value">0</p>
        <div style="font-size:0.85rem; color:var(--text-color-muted); margin-top:6px;">Number of events recorded in activity log</div>
      </div>
      <div class="stat-card">
        <h2>Helpful Feedback</h2>
        <p id="helpfulCount" class="stat-value helpful">0</p>
        <div style="font-size:0.85rem; color:var(--text-color-muted); margin-top:6px;">Positive feedback counts</div>
      </div>
      <div class="stat-card">
        <h2>Not Helpful</h2>
        <p id="notHelpfulCount" class="stat-value not-helpful">0</p>
        <div style="font-size:0.85rem; color:var(--text-color-muted); margin-top:6px;">Negative feedback counts</div>
      </div>
    </div>

    <div class="card" style="display:grid; grid-template-columns: 1fr 360px; gap:0.9rem; margin-bottom:1rem;">
      <div>
        <h2 style="font-size:1rem; font-weight:600; margin-bottom:0.55rem;">Top Active Users</h2>
        <p style="font-size:0.85rem; color:var(--text-color-muted); margin-top:0; margin-bottom:0.8rem;">Who interacts most with KB</p>
        <div class="chart-wrapper">
            <canvas id="activeUsersChart"></canvas>
        </div>
      </div>
      <div>
        <h2 style="font-size:1rem; font-weight:600; margin-bottom:0.55rem;">Feedback Distribution</h2>
        <div class="chart-wrapper">
            <canvas id="feedbackChart"></canvas>
        </div>
      </div>
    </div>

    <div class="card">
      <h2 style="font-size:1rem; font-weight:600; margin-bottom:0.8rem;">Recent Activities</h2>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>User</th>
              <th>Email</th>
              <th>Case</th>
              <th>Action</th>
              <th>Details</th>
              <th>Activity Time</th>
            </tr>
          </thead>
          <tbody id="activityTable"></tbody>
        </table>
      </div>
      <div class="pagination">
        <div id="pageInfo" style="color:var(--text-color-muted); font-size:0.9rem;"></div>
        <div style="flex:1"></div>
        <button id="prevBtn" class="button-secondary">Previous</button>
        <button id="nextBtn" class="button-secondary">Next</button>
      </div>
    </div>

    <div style="text-align:center; color:var(--text-color-muted); font-size:0.85rem; margin-top:1.25rem;">
      Built for Knowledge Base tracking â€” live connected views. If charts are empty please run the SQL views/triggers then refresh.
    </div>
  </div>
</div>

<div id="restricted-card" class="access-restricted-container">
    <div class="card">
        <div class="icon">ðŸ”’</div>
        <h2>Access Restricted</h2>
        <p>This page is available to administrators only.</p>
        <a href="app.html" class="button">Go Back to Dashboard</a>
    </div>
</div>


  <script type="module">
    import { supabase } from './supabase.js';

    let activities = [];
    let feedbackStats = { helpful: 0, notHelpful: 0 };
    let topUsers = [];
    let currentPage = 1;
    const pageSize = 10;

    const table = document.getElementById('activityTable');
    const totalActivitiesEl = document.getElementById('totalActivities');
    const helpfulCountEl = document.getElementById('helpfulCount');
    const notHelpfulCountEl = document.getElementById('notHelpfulCount');
    const toast = document.getElementById('toast');
    const spinner = document.getElementById('spinner');
    const pageInfo = document.getElementById('pageInfo');

    let feedbackChart = null, activeUsersChart = null;

    function showSpinner(show) { spinner.style.display = show ? 'flex' : 'none'; }

    function showToast(message, timeout = 3000) {
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), timeout);
    }

    function createChart(ctx, type, labels, data, dataLabel, backgroundColors) {
        const legendColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim();
        const ticksColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color-muted').trim();
        const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim();

        const chartOptions = {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { color: legendColor, font: { family: 'Inter', size: 12 } }
                },
                tooltip: { mode: 'index', intersect: false }
            },
            scales: {
                y: { beginAtZero: true, ticks: { color: ticksColor }, grid: { color: gridColor, drawBorder: false } },
                x: { ticks: { color: ticksColor }, grid: { display: false } }
            }
        };

        if(type === 'doughnut') {
            delete chartOptions.scales;
        }

        return new Chart(ctx, {
            type,
            data: {
              labels,
              datasets: [{
                label: dataLabel || '',
                data,
                backgroundColor: Array.isArray(backgroundColors) ? backgroundColors : [backgroundColors],
                borderColor: getComputedStyle(document.documentElement).getPropertyValue('--bg-color-alt').trim(),
                borderWidth: 2
              }]
            },
            options: chartOptions
        });
    }

    function renderActivities(filtered) {
      const start = (currentPage - 1) * pageSize;
      const paginated = filtered.slice(start, start + pageSize);

      table.innerHTML = paginated.map((act) => {
          return `<tr>
            <td>${escapeHtml(act.user_name) || 'N/A'}</td>
            <td>${escapeHtml(act.user_email) || 'N/A'}</td>
            <td>${escapeHtml(act.item_title) || '-'}</td>
            <td>${escapeHtml(act.action) || '-'}</td>
            <td>${act.details ? escapeHtml(formatDetails(act.details)) : '-'}</td>
            <td>${act.activity_time ? new Date(act.activity_time).toLocaleString('en-GB', { timeZone: 'Africa/Cairo' }) : '-'}</td>
          </tr>`;
      }).join('');

      totalActivitiesEl.textContent = filtered.length;
      const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
      pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
      document.getElementById('prevBtn').disabled = currentPage <= 1;
      document.getElementById('nextBtn').disabled = currentPage >= totalPages;
    }

    function formatDetails(details) {
      if (!details) return '';
      if (typeof details === 'string') return details;
      try { return JSON.stringify(details); } catch (e) { return String(details); }
    }

    function renderFeedback() {
      helpfulCountEl.textContent = feedbackStats.helpful;
      notHelpfulCountEl.textContent = feedbackStats.notHelpful;
      if (feedbackChart) feedbackChart.destroy();
      feedbackChart = createChart(document.getElementById('feedbackChart').getContext('2d'), 'doughnut',
        ['Helpful', 'Not Helpful'],
        [feedbackStats.helpful, feedbackStats.notHelpful],
        'Feedback',
        ['#10B981', '#EF4444']
      );
    }

    function renderTopUsers() {
      if (activeUsersChart) activeUsersChart.destroy();
      const labels = topUsers.map(u => u.user_name || 'Unknown');
      const data = topUsers.map(u => u.activity_count || 0);
      const colors = data.map(_ => '#6366F1');
      activeUsersChart = createChart(document.getElementById('activeUsersChart').getContext('2d'), 'bar', labels, data, 'Activities', colors);
    }

    function filterAndRender() {
        const timeFilter = document.getElementById('timeFilter').value;
        const actionFilter = document.getElementById('actionFilter').value;
        const search = document.getElementById('searchInput').value.trim().toLowerCase();
        let filtered = [...activities];
        const now = new Date();

        if (timeFilter !== 'all') {
            filtered = filtered.filter(a => {
                const ts = new Date(a.activity_time);
                if (isNaN(ts)) return false;
                if (timeFilter === 'today') return ts.toDateString() === now.toDateString();
                if (timeFilter === '7d') return (now - ts) / (1000*60*60*24) <= 7;
                if (timeFilter === '30d') return (now - ts) / (1000*60*60*24) <= 30;
                return true;
            });
        }
        if (actionFilter !== 'all') {
            const wanted = actionFilter.toLowerCase();
            filtered = filtered.filter(a => (a.action || '').toLowerCase() === wanted);
        }
        if (search) {
            filtered = filtered.filter(a =>
                ((a.user_name || '').toLowerCase().includes(search)) ||
                ((a.user_email || '').toLowerCase().includes(search)) ||
                ((a.item_title || '').toLowerCase().includes(search))
            );
        }

        // reset to first page when filters change
        currentPage = 1;
        renderActivities(filtered);
        return filtered;
    }

    function exportCSV(data) {
        const headers = ['User','Email','Case','Action','Details','Activity Time'];
        let csv = headers.join(',') + '\n';
        data.forEach(a => {
            const row = [a.user_name, a.user_email, a.item_title || '-', a.action, JSON.stringify(a.details || ''), a.activity_time];
            csv += row.map(val => `"${String(val || '').replace(/"/g, '""')}"`).join(',') + '\n';
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url; link.download = 'activities_insights.csv'; document.body.appendChild(link);
        link.click(); document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }

    async function initData() {
      showSpinner(true);
      try {
        const [actsRes, fbRes, tuRes] = await Promise.all([
            supabase.rpc('get_user_activity_feed'),
            supabase.rpc('get_feedback_stats'),
            supabase.rpc('get_top_active_users', { limit_count: 5 })
        ]);

        if (actsRes.error) {
          console.error('activity feed RPC error', actsRes.error);
          activities = [];
          showToast('Failed to load activities.');
        } else {
          activities = Array.isArray(actsRes.data) ? actsRes.data : (actsRes.data || []);
        }

        if (fbRes.error) {
          console.error('feedback stats RPC error', fbRes.error);
          feedbackStats = { helpful: 0, notHelpful: 0 };
        } else {
          const fbData = fbRes.data || [];
          feedbackStats = {
            helpful: (fbData.find(f => String(f.rating_type).toLowerCase() === 'helpful')?.count) || 0,
            notHelpful: (fbData.find(f => String(f.rating_type).toLowerCase() === 'not helpful')?.count) || 0
          };
        }

        if (tuRes.error) {
          console.error('top users RPC error', tuRes.error);
          topUsers = [];
        } else {
          topUsers = Array.isArray(tuRes.data) ? tuRes.data : (tuRes.data || []);
        }

        activities.sort((a,b) => new Date(b.activity_time) - new Date(a.activity_time));

        filterAndRender();
        renderFeedback();
        renderTopUsers();
      } catch (e) {
        console.error('initData error', e);
        showToast('Error loading insights.');
      } finally {
        showSpinner(false);
      }
    }

    document.getElementById('prevBtn').addEventListener('click', () => {
      if (currentPage > 1) { currentPage--; filterAndRender(); }
    });
    document.getElementById('nextBtn').addEventListener('click', () => {
      currentPage++; filterAndRender();
    });
    document.getElementById('refreshBtn').addEventListener('click', () => initData());
    document.getElementById('exportBtn').addEventListener('click', () => exportCSV(activities));

    ['timeFilter', 'actionFilter', 'searchInput'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', filterAndRender);
    });

    async function checkAdminAccess() {
      try {
        const { data: userData, error: userErr } = await supabase.auth.getUser();
        const user = userData?.user;
        if (!user) {
          document.getElementById('restricted-card').style.display = 'flex';
          return;
        }
        const { data, error } = await supabase.from('users').select('role').eq('id', user.id).single();
        if (error || !data || data.role !== 'admin') {
          document.getElementById('restricted-card').style.display = 'flex';
        } else {
          document.getElementById('dashboard').style.visibility = 'visible';
          initData();
        }
      } catch (e) {
        console.error('Admin check failed', e);
        document.getElementById('restricted-card').style.display = 'flex';
      }
    }

    function escapeHtml(unsafe) {
      if (unsafe === null || unsafe === undefined) return '';
      return String(unsafe)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;");
    }

    document.addEventListener('DOMContentLoaded', checkAdminAccess);
  </script>
</body>
</html>
