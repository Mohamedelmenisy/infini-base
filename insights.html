<!doctype html>
<html lang=en dir=ltr>
<head>
<meta charset=UTF-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<title>InfiniBase - Knowledge Base Insights</title>
<link rel="shortcut icon" href=favicon.ico type=image/x-icon>
<link rel=icon href=favicon.svg type=image/svg+xml>
<script src=https://cdn.jsdelivr.net/npm/chart.js></script>
<script src=https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js></script>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css>
<script src=https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2></script>
<style>:root{--primary-color:#6366f1;--primary-color-hover:#4f46e5;--text-color:#d1d5db;--text-color-muted:#9ca3af;--bg-color:#111827;--bg-color-alt:#1f2937;--border-color:#374151;--border-radius:0.5rem;--border-radius-lg:0.75rem;--header-height:65px;--bg-color-lighter:#18202f;--bg-color-darker:#0c1220;--accent-color:#38bdf8;--accent-color-secondary:#58a6ff;--success-color:#22c55e;--warning-color:#fbbf24}body,html{height:100%;margin:0;font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background-color:var(--bg-color);color:var(--text-color);font-size:15px}.page-wrapper{padding:1.25rem 1.5rem;padding-top:calc(var(--header-height) + 1.25rem);background:linear-gradient(135deg,var(--bg-color-darker) 0,var(--bg-color) 100%);min-height:100vh}.page-header{position:fixed;top:0;left:0;right:0;height:var(--header-height);display:flex;justify-content:space-between;align-items:center;padding:0 1.5rem;background:linear-gradient(90deg,rgba(31,41,55,.95),rgba(17,24,39,.95));border-bottom:1px solid var(--border-color);backdrop-filter:blur(8px);z-index:100}.page-header .header-title{display:flex;align-items:center;gap:.8rem}.page-header .logo-icon{font-size:1.6rem;color:var(--primary-color)}.page-header h1{font-size:1.5rem;font-weight:600;color:#fff;margin:0}.button,button{background-color:var(--primary-color);color:#fff;border:1px solid transparent;padding:.65rem 1.1rem;border-radius:var(--border-radius);cursor:pointer;font-size:.9rem;font-weight:500;transition:all .2s;text-decoration:none;display:inline-flex;align-items:center;justify-content:center;gap:.5rem}.button:hover,button:hover{background-color:var(--primary-color-hover);transform:translateY(-2px);box-shadow:0 4px 12px rgba(99,102,241,.3)}.button-secondary{background-color:var(--bg-color-alt);color:var(--text-color);border-color:var(--border-color)}.button-secondary:hover{background-color:var(--border-color);color:#fff}.card{background-color:var(--bg-color-alt);border:1px solid var(--border-color);border-radius:var(--border-radius-lg);padding:1.25rem;margin-bottom:2.5rem;box-shadow:0 4px 25px rgba(0,0,0,.25);transition:all .3s ease;position:relative}.card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--primary-color),var(--accent-color));border-radius:var(--border-radius-lg) var(--border-radius-lg) 0 0}.card:hover{box-shadow:0 8px 30px rgba(0,0,0,.3);border-color:rgba(99,102,241,.5);transform:translateY(-2px)}.card-header{display:flex;justify-content:space-between;align-items:center;margin:-1.25rem -1.25rem 1rem -1.25rem;padding:1rem 1.25rem;border-bottom:1px solid var(--border-color);background:linear-gradient(90deg,var(--bg-color-lighter),var(--bg-color-alt));border-radius:var(--border-radius-lg) var(--border-radius-lg) 0 0}.card-header h2{font-size:1.25rem;font-weight:700;margin:0;display:flex;align-items:center;gap:.75rem;color:var(--accent-color-secondary)}.card-header h2 i{color:var(--primary-color)}.summary-metrics{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1.5rem;margin-bottom:2rem}.metric-card{background:linear-gradient(145deg,var(--bg-color-alt),var(--bg-color-lighter));border:1px solid var(--border-color);border-radius:16px;padding:1.25rem;display:flex;align-items:center;gap:1rem;transition:transform .2s,box-shadow .2s;position:relative;overflow:hidden}.metric-card::before{content:'';position:absolute;top:0;left:0;width:4px;height:100%;background:linear-gradient(to bottom,var(--primary-color),var(--accent-color))}.metric-card:hover{transform:translateY(-4px);box-shadow:0 8px 25px rgba(99,102,241,.15)}.metric-card .icon{font-size:1.75rem;color:var(--primary-color);background:rgba(99,102,241,.1);padding:.5rem;border-radius:10px}.metric-card .value{font-size:1.75rem;font-weight:800;color:#fff}.metric-card .label{color:var(--text-color-muted);font-size:.9rem;font-weight:500}.filters-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;align-items:flex-end}.filters-container .form-group{margin-bottom:0}.filters-container .form-group label{font-size:.85rem;font-weight:500;color:var(--text-color-muted);margin-bottom:.4rem;display:block}.filters-container input,.filters-container select{width:100%;padding:.7rem;border:1px solid var(--border-color);border-radius:var(--border-radius);background-color:var(--bg-color);color:var(--text-color);font-size:.9rem;transition:border-color .2s,box-shadow .2s}.filters-container input:focus,.filters-container select:focus{border-color:var(--primary-color);box-shadow:0 0 0 3px rgba(99,102,241,.2);outline:0}.filter-actions{grid-column:1/-1;display:flex;gap:.75rem;padding-top:1rem;justify-content:flex-start}.insights-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:1.5rem}.chart-wrapper{position:relative;height:320px}.table-wrap{overflow-x:auto;max-height:500px;border-radius:var(--border-radius);margin-top:1rem}table{width:100%;border-collapse:collapse;background-color:var(--bg-color-lighter);border-radius:var(--border-radius);overflow:hidden}td,th{padding:.8rem 1rem;border-bottom:1px solid var(--border-color);font-size:.9rem;text-align:left;white-space:nowrap}td:nth-child(2){white-space:normal;max-width:300px;overflow:hidden;text-overflow:ellipsis}thead th{background:linear-gradient(to bottom,var(--bg-color-darker),var(--bg-color));color:var(--text-color-muted);font-size:.75rem;text-transform:uppercase;letter-spacing:.05em;position:sticky;top:0;z-index:1;font-weight:600;padding:1rem}tbody tr{transition:background-color .2s}tbody tr:hover{background-color:rgba(56,189,248,.05)}.pagination-controls{display:flex;justify-content:flex-end;align-items:center;gap:1rem;margin-top:1.5rem;font-size:.9rem;color:var(--text-color-muted)}.pagination-controls button{padding:.4rem .8rem}.pagination-controls button:disabled{background-color:var(--border-color);cursor:not-allowed;opacity:.5}.spinner-overlay{position:fixed;inset:0;background:rgba(17,24,39,.8);display:flex;align-items:center;justify-content:center;z-index:1000}.spinner{width:50px;height:50px;border-radius:50%;border:4px solid var(--border-color);border-top-color:var(--primary-color);animation:spin 1s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}.toast{position:fixed;top:20px;right:20px;padding:12px 16px;border-radius:var(--border-radius);color:#fff;background-color:#ef4444;z-index:1100;display:flex;align-items:center;gap:10px;cursor:pointer;opacity:0;transform:translateY(-10px);transition:all .3s}.toast.show{opacity:1;transform:translateY(0)}.access-restricted-container{display:none;flex-direction:column;align-items:center;justify-content:center;text-align:center;height:100vh;width:100%}.access-restricted-container .card{max-width:450px;padding:3rem}.access-restricted-container .icon{font-size:4rem;color:var(--primary-color);margin-bottom:1.5rem}.access-restricted-container h2{font-size:1.75rem;margin-bottom:.5rem;color:#fff}.access-restricted-container p{color:var(--text-color-muted);margin-bottom:2rem}.refresh-indicator{display:flex;align-items:center;gap:.5rem;color:var(--text-color-muted);font-size:.9rem;background:rgba(31,41,55,.7);padding:.5rem 1rem;border-radius:20px;border:1px solid var(--border-color)}.refresh-indicator.active{color:var(--success-color);border-color:rgba(34,197,94,.3)}.refresh-indicator.active i{animation:spin 1s linear infinite}.quick-stats{display:flex;gap:1rem;margin-bottom:1rem;flex-wrap:wrap}.stat-badge{background:linear-gradient(145deg,var(--bg-color-lighter),var(--bg-color-alt));padding:.6rem 1.2rem;border-radius:12px;display:flex;align-items:center;gap:.5rem;font-size:.9rem;border:1px solid var(--border-color);transition:all .2s}.stat-badge:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.15)}.stat-badge i{color:var(--accent-color);font-size:1rem}.table-summary{background:var(--bg-color);padding:.75rem 1rem;border-radius:var(--border-radius);margin-bottom:1rem;font-size:.9rem;color:var(--text-color-muted)}.table-summary strong{color:var(--text-color)}.chart-toolbar{display:flex;justify-content:flex-end;gap:.5rem}.chart-toolbar button{padding:.4rem .8rem;font-size:.8rem}.export-options{display:flex;gap:.5rem;margin-left:auto}.export-options .button{padding:.6rem 1rem;font-size:.85rem}.export-options .button i{font-size:.8rem}td:nth-child(3),td:nth-child(4),td:nth-child(5){text-align:center}</style>
</head>
<body>
<div id=dashboard>
<header class=page-header>
<div class=header-title>
<i class="fas fa-chart-pie logo-icon"></i>
<h1>Knowledge Base Insights</h1>
</div>
<div style=display:flex;align-items:center;gap:1rem>
<div class=refresh-indicator id=refreshIndicator>
<i class="fas fa-sync-alt"></i>
<span>Last updated: <span id=lastUpdateTime>Just now</span></span>
</div>
<a href=app.html class="button button-secondary"><i class="fas fa-arrow-left"></i> Back to Dashboard</a>
</div>
</header>
<div class=page-wrapper>
<div id=toast class=toast></div>
<div id=spinner class=spinner-overlay style=display:none><div class=spinner></div></div>
<div class=summary-metrics>
<div class=metric-card><i class="fas fa-file-alt icon"></i><div><div id=metric-total-articles class=value>-</div><div class=label>Total Articles</div></div></div>
<div class=metric-card><i class="fas fa-eye icon"></i><div><div id=metric-total-views class=value>-</div><div class=label>Total Views</div></div></div>
<div class=metric-card><i class="fas fa-star-half-alt icon"></i><div><div id=metric-avg-rating class=value>-</div><div class=label>Average Rating</div></div></div>
<div class=metric-card><i class="fas fa-users icon"></i><div><div id=metric-active-users class=value>-</div><div class=label>Active Users (Week)</div></div></div>
</div>
<div class=card>
<div class=card-header>
<h2><i class="fas fa-filter"></i> Filters</h2>
</div>
<div class=filters-container>
<div class=form-group><label for=filterDateFrom>From Date</label><input id=filterDateFrom type=date></div>
<div class=form-group><label for=filterDateTo>To Date</label><input id=filterDateTo type=date></div>
<div class=form-group><label for=filterEmployee>Employee</label><select id=filterEmployee><option value="">All Employees</option></select></div>
<div class=form-group><label for=filterCase>Case / Article Title</label><input id=filterCase placeholder="Enter title to search..."></div>
<div class=filter-actions>
<button id=applyFiltersBtn class=button><i class="fas fa-check"></i> Apply Filters</button>
<button id=clearFiltersBtn class=button-secondary><i class="fas fa-times"></i> Clear</button>
<div class=export-options>
<button id=exportBtn class=button-secondary><i class="fas fa-file-csv"></i> Export All Data</button>
<button id=exportPdfBtn class=button-secondary><i class="fas fa-file-pdf"></i> PDF Report</button>
</div>
</div>
</div>
<div id=filterSummary class=table-summary style=display:none;margin-top:1rem></div>
</div>
<div class=insights-grid>
<div class=card>
<div class=card-header>
<h2><i class="fas fa-chart-bar"></i>Activity by Category</h2>
<div class=chart-toolbar>
<button class="button-secondary chart-export" data-chart=activityBySectionChart><i class="fas fa-download"></i></button>
</div>
</div>
<div class=chart-wrapper><canvas id=activityBySectionChart></canvas></div>
</div>
<div class=card>
<div class=card-header>
<h2><i class="fas fa-fire"></i>Top Viewed Articles</h2>
<div class=chart-toolbar>
<button class="button-secondary chart-export" data-chart=topArticlesChart><i class="fas fa-download"></i></button>
</div>
</div>
<div class=chart-wrapper><canvas id=topArticlesChart></canvas></div>
</div>
</div>
<div class=card>
<div class=card-header>
<h2><i class="fas fa-book-open"></i> Knowledge Base Articles</h2>
</div>
<div class=table-wrap>
<table>
<thead>
<tr>
<th>Article Title</th>
<th>Description</th>
<th>Sub-Category</th>
<th>Category</th>
<th>Created At (Egypt Time)</th>
</tr>
</thead>
<tbody id=kbInsightsTable></tbody>
</table>
</div>
</div>
<div class=card>
<div class=card-header>
<h2><i class="fas fa-newspaper"></i> Article Performance</h2>
<div class=quick-stats id=articleStats></div>
</div>
<div class=table-wrap>
<table>
<thead><tr><th>Article Title</th><th>Total Views</th><th>Avg Rating (1=Helpful)</th><th>Total Feedbacks</th><th>Last Viewed (Egypt Time)</th><th>Last Viewed By</th></tr></thead>
<tbody id=articleInsightsTable></tbody>
</table>
</div>
<div class=pagination-controls id=paginationArticles></div>
</div>
<div class=card>
<div class=card-header>
<h2><i class="fas fa-users"></i> User Engagement</h2>
<div class=quick-stats id=userStats></div>
</div>
<div class=table-wrap>
<table>
<thead><tr><th>User Name</th><th>Email</th><th>Total Articles Viewed</th><th>Unique Articles Viewed</th><th>Average Feedback Rating</th><th>Last Activity (Egypt Time)</th></tr></thead>
<tbody id=userInsightsTable></tbody>
</table>
</div>
<div class=pagination-controls id=paginationUsers></div>
</div>
<div class=card>
<div class=card-header>
<h2><i class="fas fa-folder-tree"></i> Section Performance</h2>
<div class=quick-stats id=sectionStats></div>
</div>
<div class=table-wrap>
<table>
<thead><tr><th>Category Name</th><th>Total Articles</th><th>Total Views</th><th>Average Rating</th><th>Total Feedbacks</th><th>Last Activity (Egypt Time)</th></tr></thead>
<tbody id=sectionInsightsTable></tbody>
</table>
</div>
<div class=pagination-controls id=paginationSections></div>
</div>
</div>
</div>
<footer style=padding:1.5rem;text-align:center;color:var(--text-color-muted);font-size:.85rem>
<span>© <script>document.write((new Date).getFullYear())</script> InfiniBase.Elmenisy.</span>
</footer>
<script>
// تهيئة Supabase
const SUPABASE_URL = 'https://aefiigottnlcmjzilqnh.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFlZmlpZ290dG5sY21qemlscW5oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcxNzY2MDQsImV4cCI6MjA2Mjc1MjYwNH0.FypB02v3tGMnxXV9ZmZMdMC0oQpREKOJWgHMPxUzwX4';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// تهيئة نظام التحقق من الصلاحيات عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', async function() {
    initializeInsightsDashboard();
});

// باقي كود الـ Insights Dashboard
let allInsights = { articles: [], users: [], sections: [], overall: {} };
let filteredInsights = { articles: [], users: [], sections: [] };
let paginationState = { articles: 1, users: 1, sections: 1 };
const ROWS_PER_PAGE = 5;
const toast = document.getElementById("toast");
const spinner = document.getElementById("spinner");
let activityBySectionChart, topArticlesChart = null;

function showSpinner(t) {
    spinner.style.display = t ? "flex" : "none";
}

function showToast(t, e = !0) {
    toast.textContent = t;
    toast.style.backgroundColor = e ? "#ef4444" : "#22c55e";
    toast.classList.add("show");
    setTimeout((() => toast.classList.remove("show")), 3e3);
}

function escapeHtml(t) {
    if (null == t) return "";
    return String(t).replace(/[&<>"']/g, (t => ({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[t])));
}

function formatToEgyptTime(t) {
    if (!t) return "N/A";
    const e = new Date(t);
    return isNaN(e.getTime()) ? t : e.toLocaleString("en-EG", { year: "numeric", month: "short", day: "numeric", hour: "numeric", minute: "2-digit", hour12: !0, timeZone: "Africa/Cairo" }) + " (Cairo)";
}

function updateLastUpdateTime() {
    const t = new Date();
    document.getElementById("lastUpdateTime").textContent = t.toLocaleTimeString("en-GB", { timeZone: "Africa/Cairo", hour: "2-digit", minute: "2-digit" });
    const e = document.getElementById("refreshIndicator");
    e.classList.add("active");
    setTimeout((() => e.classList.remove("active")), 2e3);
}

function updateQuickStats() {
    const t = document.getElementById("articleStats");
    const e = filteredInsights.articles.length;
    const a = filteredInsights.articles.reduce(((t, e) => t + (e.total_views || 0)), 0);
    const n = filteredInsights.articles.filter((t => null != t.avg_rating));
    const s = n.reduce(((t, e) => t + (e.avg_rating || 0)), 0) / (n.length || 1);
    t.innerHTML = `
        <div class="stat-badge"><i class="fas fa-file-alt"></i> ${e} Articles</div>
        <div class="stat-badge"><i class="fas fa-eye"></i> ${a} Total Views</div>
        <div class="stat-badge"><i class="fas fa-star"></i> ${s.toFixed(2)} Avg Rating</div>
    `;
    
    const i = document.getElementById("userStats");
    const r = filteredInsights.users.length;
    const l = filteredInsights.users.reduce(((t, e) => t + (e.total_activities || 0)), 0);
    i.innerHTML = `
        <div class="stat-badge"><i class="fas fa-users"></i> ${r} Users</div>
        <div class="stat-badge"><i class="fas fa-eye"></i> ${l} Total Views</div>
    `;
    
    const o = document.getElementById("sectionStats");
    const c = filteredInsights.sections.length;
    const d = filteredInsights.sections.reduce(((t, e) => t + (e.total_views || 0)), 0);
    o.innerHTML = `
        <div class="stat-badge"><i class="fas fa-folder"></i> ${c} Categories</div>
        <div class="stat-badge"><i class="fas fa-eye"></i> ${d} Total Views</div>
    `;
}

function updateFilterSummary() {
    const t = document.getElementById("filterSummary");
    const e = document.getElementById("filterDateFrom").value;
    const a = document.getElementById("filterDateTo").value;
    const n = document.getElementById("filterEmployee").value;
    const s = document.getElementById("filterCase").value.trim().toLowerCase();
    const i = [];
    
    e && i.push(`From: ${e}`);
    a && i.push(`To: ${a}`);
    n && i.push(`Employee: ${document.getElementById("filterEmployee").options[document.getElementById("filterEmployee").selectedIndex].text}`);
    s && i.push(`Case: "${s}"`);
    
    i.length > 0 ? (t.innerHTML = `<strong>Active Filters:</strong> ${i.join(" • ")}`, t.style.display = "block") : t.style.display = "none";
}

function createChart(t, e, a, n, s, i) {
    if (!t) return null;
    const r = getComputedStyle(document.documentElement).getPropertyValue("--text-color").trim();
    const l = getComputedStyle(document.documentElement).getPropertyValue("--text-color-muted").trim();
    const o = getComputedStyle(document.documentElement).getPropertyValue("--border-color").trim();
    const c = {
        responsive: !0,
        maintainAspectRatio: !1,
        plugins: {
            legend: {
                position: "doughnut" === e ? "right" : "top",
                labels: { color: r, font: { size: 14 } }
            },
            tooltip: {
                bodyFont: { size: 14 },
                titleFont: { size: 16 },
                backgroundColor: "#111827",
                titleColor: "#fff",
                bodyColor: "#fff",
                borderColor: o,
                borderWidth: 1
            }
        }
    };
    
    return "bar" === e ? new Chart(t, {
        type: e,
        data: {
            labels: a,
            datasets: [{
                label: s,
                data: n,
                backgroundColor: i,
                borderRadius: 4
            }]
        },
        options: {
            ...c,
            scales: {
                y: {
                    beginAtZero: !0,
                    ticks: { color: l },
                    grid: { color: o }
                },
                x: {
                    ticks: { color: l },
                    grid: { display: !1 }
                }
            }
        }
    }) : new Chart(t, {
        type: e,
        data: {
            labels: a,
            datasets: [{
                label: s,
                data: n,
                backgroundColor: i,
                borderColor: o,
                borderWidth: 2
            }]
        },
        options: c
    });
}

function renderPaginatedTable(t, e, a, n) {
    const s = paginationState[t];
    const i = Math.ceil(e.length / 5);
    const r = 5 * (s - 1);
    const l = r + 5;
    const o = e.slice(r, l);
    const c = document.getElementById(a);
    let d;
    
    d = "articles" === t ? o.map((t => `
        <tr>
            <td>${escapeHtml(t.article_title)}</td>
            <td style="text-align: center;">${t.total_views || 0}</td>
            <td style="text-align: center;">${t.avg_rating ? t.avg_rating.toFixed(2) : "N/A"}</td>
            <td style="text-align: center;">${t.total_feedbacks || 0}</td>
            <td>${escapeHtml(formatToEgyptTime(t.last_view_egypt))}</td>
            <td>${escapeHtml(t.last_viewed_by) || "N/A"}</td>
        </tr>
    `)).join("") : "users" === t ? o.map((t => `
        <tr>
            <td>${escapeHtml(t.user_name)}</td>
            <td>${escapeHtml(t.user_email)}</td>
            <td style="text-align: center;">${t.total_activities || 0}</td>
            <td style="text-align: center;">${t.unique_articles_viewed || 0}</td>
            <td style="text-align: center;">${t.avg_feedback_rating ? t.avg_feedback_rating.toFixed(2) : "N/A"}</td>
            <td>${escapeHtml(formatToEgyptTime(t.last_activity_egypt))}</td>
        </tr>
    `)).join("") : o.map((t => `
        <tr>
            <td>${escapeHtml(t.section_name)}</td>
            <td style="text-align: center;">${t.total_articles}</td>
            <td style="text-align: center;">${t.total_views}</td>
            <td style="text-align: center;">${t.average_rating ? t.average_rating.toFixed(2) : "N/A"}</td>
            <td style="text-align: center;">${t.total_feedbacks}</td>
            <td>${escapeHtml(formatToEgyptTime(t.last_activity_egypt))}</td>
        </tr>
    `)).join("");
    
    c.innerHTML = d || '<tr><td colspan="6" style="text-align:center;">No data to display.</td></tr>';
    
    document.getElementById(n).innerHTML = `
        <span>Page ${s} of ${i || 1}</span>
        <button class="button-secondary" onclick="window.changePage('${t}', -1)" ${1 === s ? "disabled" : ""}>Previous</button>
        <button class="button-secondary" onclick="window.changePage('${t}', 1)" ${s === i || 0 === i ? "disabled" : ""}>Next</button>
    `;
}

function renderAllTables() {
    renderPaginatedTable("articles", filteredInsights.articles, "articleInsightsTable", "paginationArticles");
    renderPaginatedTable("users", filteredInsights.users, "userInsightsTable", "paginationUsers");
    renderPaginatedTable("sections", filteredInsights.sections, "sectionInsightsTable", "paginationSections");
    updateQuickStats();
}

function renderSummaryMetrics(t) {
    document.getElementById("metric-total-articles").textContent = t.total_articles || 0;
    document.getElementById("metric-total-views").textContent = t.total_views_all || 0;
    document.getElementById("metric-avg-rating").textContent = t.avg_feedback_rating ? t.avg_feedback_rating.toFixed(2) : "N/A";
    document.getElementById("metric-active-users").textContent = t.active_users_this_week || 0;
}

function renderCharts() {
    activityBySectionChart && activityBySectionChart.destroy();
    const t = allInsights.sections.map((t => t.section_name || "Uncategorized"));
    const e = allInsights.sections.map((t => t.total_views));
    const a = document.getElementById("activityBySectionChart").getContext("2d");
    activityBySectionChart = createChart(a, "doughnut", t, e, "Total Views", ["#6366F1", "#22C55E", "#FBBF24", "#EC4899", "#38BDF8", "#8B5CF6"]);
    
    topArticlesChart && topArticlesChart.destroy();
    const n = [...allInsights.articles].sort(((t, e) => (e.total_views || 0) - (t.total_views || 0))).slice(0, 5);
    const s = n.map((t => t.article_title.length > 20 ? t.article_title.substring(0, 20) + "..." : t.article_title));
    const i = n.map((t => t.total_views));
    const r = document.getElementById("topArticlesChart").getContext("2d");
    topArticlesChart = createChart(r, "bar", s, i, "Total Views", ["#6366F1", "#5A5FE6", "#5158DC", "#4851D1", "#3F4AC7"]);
}

function applyFilters() {
    const t = document.getElementById("filterDateFrom").value;
    const e = document.getElementById("filterDateTo").value;
    const a = document.getElementById("filterEmployee").value;
    const n = document.getElementById("filterCase").value.trim().toLowerCase();
    const s = t ? new Date(t) : null;
    s && s.setHours(0, 0, 0, 0);
    const i = e ? new Date(e) : null;
    i && i.setHours(23, 59, 59, 999);
    
    const r = t => {
        if (!t) return !0;
        const e = new Date(t);
        return !s && !i || (!s || e >= s) && (!i || e <= i);
    };
    
    filteredInsights.articles = allInsights.articles.filter((t => (!n || t.article_title.toLowerCase().includes(n)) && r(t.last_view_egypt)));
    filteredInsights.users = allInsights.users.filter((t => (!a || t.user_name === a) && r(t.last_activity_egypt)));
    filteredInsights.sections = calculateCategoryPerformance(filteredInsights.articles);
    paginationState = { articles: 1, users: 1, sections: 1 };
    renderAllTables();
    updateFilterSummary();
}

function clearFilters() {
    document.getElementById("filterDateFrom").value = "";
    document.getElementById("filterDateTo").value = "";
    document.getElementById("filterEmployee").value = "";
    document.getElementById("filterCase").value = "";
    filteredInsights = JSON.parse(JSON.stringify(allInsights));
    paginationState = { articles: 1, users: 1, sections: 1 };
    renderAllTables();
    updateFilterSummary();
}

function exportCSV() {
    let t = "data:text/csv;charset=utf-8,";
    const e = (t, e, a) => {
        let n = `${t}\n`;
        n += e.map((t => t.label || t.key)).join(",") + "\n";
        a.forEach((t => {
            const a = e.map((e => {
                let a = t[e.key] || "";
                e.formatter && (a = e.formatter(a));
                return `"${String(a).replace(/"/g, '""')}"`;
            }));
            n += a.join(",") + "\n";
        }));
        return n + "\n";
    };
    
    t += e("Article Performance", [
        { key: "article_title" },
        { key: "total_views" },
        { key: "avg_rating" },
        { key: "total_feedbacks" },
        { key: "last_view_egypt", formatter: formatToEgyptTime },
        { key: "last_viewed_by" }
    ], filteredInsights.articles);
    
    t += e("User Engagement", [
        { key: "user_name" },
        { key: "user_email" },
        { key: "total_activities" },
        { key: "unique_articles_viewed" },
        { key: "avg_feedback_rating" },
        { key: "last_activity_egypt", formatter: formatToEgyptTime }
    ], filteredInsights.users);
    
    t += e("Section Performance", [
        { key: "section_name", label: "Category Name" },
        { key: "total_articles" },
        { key: "total_views" },
        { key: "average_rating" },
        { key: "total_feedbacks" },
        { key: "last_activity_egypt", formatter: formatToEgyptTime }
    ], filteredInsights.sections);
    
    const a = document.createElement("a");
    a.href = encodeURI(t);
    a.download = "infinibase_insights_report.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    showToast("CSV exported successfully", !1);
}

function populateUserFilter(t) {
    const e = document.getElementById("filterEmployee");
    e.innerHTML = '<option value="">All Employees</option>';
    [...new Map(t.map((t => [t.user_name, t]))).values()].forEach((t => {
        if (t.user_name) {
            const a = document.createElement("option");
            a.value = t.user_name;
            a.textContent = t.user_name;
            e.appendChild(a);
        }
    }));
}

function calculateCategoryPerformance(t) {
    const e = {};
    t.forEach((t => {
        const a = t.category_title || "Uncategorized";
        e[a] || (e[a] = {
            section_name: a,
            total_articles: 0,
            total_views: 0,
            total_feedbacks: 0,
            last_activity_egypt: null,
            rating_sum: 0,
            rating_count: 0
        });
        const n = e[a];
        n.total_articles += 1;
        n.total_views += t.total_views || 0;
        n.total_feedbacks += t.total_feedbacks || 0;
        null != t.avg_rating && (n.rating_sum += t.avg_rating * (t.total_feedbacks || 1), n.rating_count += t.total_feedbacks || 1);
        const s = t.last_view_egypt ? new Date(t.last_view_egypt) : null;
        const i = n.last_activity_egypt ? new Date(n.last_activity_egypt) : null;
        s && (!i || s > i) && (n.last_activity_egypt = t.last_view_egypt);
    }));
    return Object.values(e).map((t => (t.average_rating = t.rating_count > 0 ? t.rating_sum / t.rating_count : null, t)));
}

async function fetchData() {
    showSpinner(!0);
    try {
        const [t, e, a] = await Promise.all([
            supabase.from("v_article_insights").select("*"),
            supabase.from("v_user_insights").select("*"),
            supabase.from("v_overall_insights").select("*").single()
        ]);
        
        if (t.error) throw new Error(`Article Insights: ${t.error.message}`);
        if (e.error) throw new Error(`User Insights: ${e.error.message}`);
        if (a.error) throw new Error(`Overall Insights: ${a.error.message}`);
        
        const n = calculateCategoryPerformance(t.data || []);
        allInsights = {
            articles: t.data || [],
            users: e.data || [],
            sections: n,
            overall: a.data || {}
        };
        filteredInsights = JSON.parse(JSON.stringify(allInsights));
        populateUserFilter(allInsights.users);
        renderSummaryMetrics(allInsights.overall);
        renderAllTables();
        renderCharts();
        updateLastUpdateTime();
    } catch (t) {
        showToast(`Failed to load data: ${t.message}`);
    } finally {
        showSpinner(!1);
    }
}

async function loadKnowledgeBaseInsights() {
    try {
        const { data: t, error: e } = await supabase.from("v_articles_detailed").select("article_id, article_title, article_description, created_at_egypt, sub_category_title, category_title").order("created_at_egypt", { ascending: !1 }).limit(50);
        
        if (e) return console.error("Error loading KB Insights:", e), void (document.getElementById("kbInsightsTable").innerHTML = `
            <tr><td colspan="5" style="text-align:center; color: #ef4444;">⚠️ Error loading insights: ${e.message}</td></tr>
        `);
        
        if (!t || 0 === t.length) return void (document.getElementById("kbInsightsTable").innerHTML = `
            <tr><td colspan="5" style="text-align:center;">No articles found</td></tr>
        `);
        
        const a = t.map((t => {
            const e = t.article_description || "";
            return `
                <tr>
                    <td>${escapeHtml(t.article_title)}</td>
                    <td title="${escapeHtml(e)}">${escapeHtml(e)}</td>
                    <td>${escapeHtml(t.sub_category_title)}</td>
                    <td>${escapeHtml(t.category_title)}</td>
                    <td>${escapeHtml(t.created_at_egypt)}</td>
                </tr>
            `;
        })).join("");
        
        document.getElementById("kbInsightsTable").innerHTML = a;
    } catch (t) {
        console.error("Unexpected error loading KB Insights:", t);
        document.getElementById("kbInsightsTable").innerHTML = `
            <tr><td colspan="5" style="text-align:center; color: #ef4444;">⚠️ An unexpected error occurred.</td></tr>
        `;
    }
}

// تهيئة الـ Insights Dashboard
async function initializeInsightsDashboard() {
    document.getElementById("dashboard").style.visibility = "visible";
    await fetchData();
    await loadKnowledgeBaseInsights();
    
    // الاشتراك في التحديثات الحية
    supabase.channel("public-insights-realtime")
        .on("postgres_changes", { event: "*", schema: "public", table: "activity_log" }, (t => fetchData()))
        .on("postgres_changes", { event: "*", schema: "public", table: "kb_feedback" }, (t => fetchData()))
        .subscribe();
}

// تعريف الدوال في النطاق العام
window.changePage = (t, e) => {
    const a = Math.ceil(filteredInsights[t].length / 5);
    let n = paginationState[t] + e;
    n >= 1 && n <= a && (paginationState[t] = n, renderAllTables());
};

// إضافة مستمعي الأحداث
document.getElementById("applyFiltersBtn").addEventListener("click", applyFilters);
document.getElementById("clearFiltersBtn").addEventListener("click", clearFilters);
document.getElementById("exportBtn").addEventListener("click", exportCSV);
document.getElementById("exportPdfBtn").addEventListener("click", (() => {
    showToast("PDF export feature coming soon", !0);
}));
document.querySelectorAll(".chart-export").forEach((t => {
    t.addEventListener("click", (() => {
        showToast("Chart export feature coming soon", !0);
    }));
}));
</script>
</body>
</html>
