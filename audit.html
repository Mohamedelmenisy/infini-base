<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>InfiniBase — Audit Log</title>
  <link href="data:image/svg+xml,&lt;svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32' width='32' height='32'&gt;&lt;rect width='32' height='32' rx='4' fill='%236366f1'/&gt;&lt;text x='50%' y='55%' dominant-baseline='middle' text-anchor='middle' font-family='Arial, sans-serif' font-size='18' font-weight='bold' fill='white'&gt;IB&lt;/text&gt;&lt;/svg&gt;" rel="icon" type="image/svg+xml"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  <style>
    :root {
      --primary-color: #6366f1;
      --primary-color-hover: #4f46e5;
      --text-color: #d1d5db;
      --text-color-muted: #9ca3af;
      --bg-color: #111827;
      --bg-color-alt: #1f2937;
      --border-color: #374151;
      --border-radius: 0.5rem;
      --border-radius-lg: 0.75rem;
    }
    html, body {
      height: 100%;
      margin: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      font-size: 16px;
    }
    .page-wrapper {
      padding: 1.5rem 2rem;
    }
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border-color);
    }
    .page-header h1 {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--text-color);
      margin: 0;
    }
    .button, button {
        background-color: var(--primary-color);
        color: white;
        border: 1px solid transparent;
        padding: 0.625rem 1rem;
        border-radius: var(--border-radius);
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 500;
        transition: background-color 0.2s;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }
    .button:hover, button:hover { background-color: var(--primary-color-hover); }
    .button-secondary {
        background-color: transparent;
        color: var(--text-color-muted);
        border-color: var(--border-color);
    }
    .button-secondary:hover { background-color: var(--bg-color-alt); color: var(--text-color); }

    .card {
      background-color: var(--bg-color-alt);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius-lg);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    .filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.25rem;
      align-items: end;
    }
    .filters .form-group {
      display: flex;
      flex-direction: column;
    }
    .filters .form-group label {
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--text-color-muted);
      margin-bottom: 0.5rem;
    }
    .filters input, .filters select {
      width: 100%;
      padding: 0.625rem;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      background-color: var(--bg-color);
      color: var(--text-color);
      font-size: 0.9rem;
    }
    .filters .filter-buttons {
      display: flex;
      gap: 0.75rem;
      align-items: center;
      grid-column: 1 / -1; /* Span full width on smaller screens */
    }
     @media (min-width: 1024px) {
        .filters .search-group { grid-column: span 2; }
        .filters .filter-buttons { grid-column: auto; }
     }
    #customDates { display: none; gap: 1rem; }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
    }
    .chart-container { min-height: 280px; }
    .chart-container h3 {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--text-color-muted);
    }
    .stat-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    .stat-card .stat-value { font-size: 2.5rem; font-weight: 700; color: var(--primary-color); }
    .stat-card .stat-label { font-size: 1rem; color: var(--text-color-muted); margin-top: 0.5rem;}
    
    .table-wrap { overflow-x: auto; }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px;
    }
    th, td {
      padding: 0.8rem 1rem;
      border-bottom: 1px solid var(--border-color);
      font-size: 0.9rem;
      text-align: left;
    }
    thead th {
      background-color: #111827;
      color: var(--text-color-muted);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .highlight { background: rgba(99,102,241,0.18) !important; transition: background 1s ease; }
    
    .overlay { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(17,24,39,0.7); z-index:1000; opacity:0; visibility: hidden; transition: opacity .2s; }
    .overlay.show { opacity: 1; visibility: visible; }
    .spinner{ width:60px; height:60px; border-radius:50%; border:5px solid var(--border-color); border-top-color:var(--primary-color); animation:spin 1s linear infinite; }
    @keyframes spin{ to{transform:rotate(360deg);} }

    .toast { position:fixed; top:20px; right:20px; z-index:1100; display:flex; align-items:center; gap:10px; padding:12px 16px; border-radius:var(--border-radius); color:white; box-shadow:0 8px 30px rgba(0,0,0,0.5); cursor:pointer; opacity: 0; transform: translateY(-10px); transition: all .2s; }
    .toast.show { opacity: 1; transform: translateY(0); }
    
    .hidden { display: none !important; }
    .access-restricted-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        height: 100vh;
        width: 100%;
    }
    .access-restricted-card .card {
        max-width: 450px;
        padding: 3rem;
    }
    .access-restricted-card .icon {
        font-size: 4rem;
        color: var(--primary-color);
        margin-bottom: 1.5rem;
    }
    .access-restricted-card h2 {
        font-size: 1.75rem;
        margin-bottom: 0.5rem;
        color: white;
    }
    .access-restricted-card p {
        color: var(--text-color-muted);
        margin-bottom: 2rem;
    }
  </style>
</head>
<body>

<!-- Main dashboard content, hidden by default -->
<div id="dashboard" class="hidden">
  <div class="page-wrapper">
    <div class="page-header">
      <h1><i class="fas fa-history" style="color: var(--primary-color); margin-right: 1rem;"></i>Audit Log</h1>
      <a href="app.html" class="button button-secondary"><i class="fas fa-arrow-left"></i> Back to Dashboard</a>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast" role="status" aria-live="polite"></div>

    <!-- Overlay Spinner -->
    <div id="overlay" class="overlay"><div class="spinner"></div></div>

    <!-- Filters Card -->
    <div class="card">
      <div class="filters" role="region" aria-label="filters">
        <div class="form-group search-group">
          <label for="searchInput">Search (case title / slug / user / field)</label>
          <input id="searchInput" placeholder="Search..." />
        </div>
        <div class="form-group">
          <label for="fieldFilter">Field</label>
          <select id="fieldFilter">
            <option value="">All fields</option>
            <option value="status">status</option>
            <option value="assigned_to">assigned_to</option>
            <option value="priority">priority</option>
            <option value="title">title</option>
          </select>
        </div>
        <div class="form-group">
          <label for="userFilter">User</label>
          <input id="userFilter" placeholder="User name or email" />
        </div>
        <div class="form-group">
          <label for="timeRange">Time Range</label>
          <select id="timeRange">
            <option value="all">All time</option>
            <option value="today">Today</option>
            <option value="7d">Last 7 days</option>
            <option value="30d">Last 30 days</option>
            <option value="custom">Custom</option>
          </select>
        </div>
        <div id="customDates" class="form-group">
          <label>Custom Dates</label>
          <div style="display: flex; gap: 0.5rem;">
            <input id="startDate" type="date" />
            <input id="endDate" type="date" />
          </div>
        </div>
        <div class="filter-buttons">
          <button id="applyBtn" class="button">Apply</button>
          <button id="clearBtn" class="button-secondary">Clear</button>
          <button id="exportBtn" class="button-secondary">Export CSV</button>
        </div>
      </div>
    </div>

    <!-- Charts + Stats -->
    <div class="card">
        <div class="stats-grid">
            <div class="chart-container">
                <h3>Top Changed Fields</h3>
                <canvas id="fieldsChart"></canvas>
            </div>
            <div class="chart-container">
                <h3>Top Editors</h3>
                <canvas id="editorsChart"></canvas>
            </div>
            <div class="stat-card">
                <div id="totalChanges" class="stat-value">0</div>
                <div class="stat-label">Total Changes</div>
            </div>
        </div>
    </div>

    <!-- Audit Table Card -->
    <div class="card">
      <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem;">Audit Trail</h3>
      <div class="table-wrap">
        <table aria-label="Audit trail">
          <thead>
            <tr>
              <th>Case</th>
              <th>Field</th>
              <th>Old Value</th>
              <th>New Value</th>
              <th>Modified At</th>
              <th>Modified By</th>
            </tr>
          </thead>
          <tbody id="auditBody">
            <tr><td colspan="6" style="text-align:center; padding: 2rem;">Loading...</td></tr>
          </tbody>
        </table>
      </div>
      <div style="display:flex; justify-content:center; margin-top: 1.5rem;">
        <button id="loadMore" class="button-secondary">Load more</button>
      </div>
    </div>
  </div>
</div>

<!-- Admin access restricted card, visible by default -->
<div id="restricted-card" class="access-restricted-card">
    <div class="card">
        <div class="icon">🔒</div>
        <h2>Access Restricted</h2>
        <p>This page is available to administrators only.</p>
        <a href="app.html" class="button">Go Back to Dashboard</a>
    </div>
</div>

<script type="module">
    import { supabase } from './supabase.js';

    // State
    let auditStore = [];
    let filtered = [];
    let pageSize = 25;
    let currentPage = 1;
    let fieldsChart = null, editorsChart = null;

    // DOM Refs
    const overlay = document.getElementById('overlay');
    const toast = document.getElementById('toast');
    const auditBody = document.getElementById('auditBody');
    const totalChangesEl = document.getElementById('totalChanges');
    
    // Helpers
    function showOverlay(show = true) { overlay.classList.toggle('show', show); }
    function escapeHtml(s) { return s === null || s === undefined ? '' : String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }
    function formatTime(ts) { return !ts ? '-' : new Date(ts).toLocaleString(); }
    
    // Fetch initial data
    async function fetchInitial() {
      showOverlay(true);
      try {
        const { data, error } = await supabase.rpc('get_full_case_history');
        if (error) { console.error('get_full_case_history error', error); auditStore = []; }
        else { auditStore = data || []; }
        
        buildChartsFromStore();
        applyFiltersAndRender();
      } finally {
        showOverlay(false);
      }
    }

    // Rendering
    function renderTable(list) {
      auditBody.innerHTML = '';
      if (!list || !list.length) {
        auditBody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 2rem;">No records found for the current filters.</td></tr>';
        totalChangesEl.textContent = 0;
        document.getElementById('loadMore').style.display = 'none';
        return;
      }
      const end = Math.min(list.length, currentPage * pageSize);
      list.slice(0, end).forEach((r, i) => {
        const rowId = `row-${i}`;
        const oldVal = typeof r.old_value === 'object' ? JSON.stringify(r.old_value) : (r.old_value || '');
        const newVal = typeof r.new_value === 'object' ? JSON.stringify(r.new_value) : (r.new_value || '');
        const tr = document.createElement('tr');
        tr.id = rowId;
        tr.innerHTML = `
          <td>${escapeHtml(r.case_title || r.slug || '-')}</td>
          <td>${escapeHtml(r.field_changed || '-')}</td>
          <td style="white-space:pre-wrap; max-width:300px; word-break:break-word;">${escapeHtml(oldVal)}</td>
          <td style="white-space:pre-wrap; max-width:300px; word-break:break-word;">${escapeHtml(newVal)}</td>
          <td>${formatTime(r.modified_at)}</td>
          <td>${escapeHtml(r.modified_by_name)}</td>
        `;
        auditBody.appendChild(tr);
      });
      totalChangesEl.textContent = list.length;
      document.getElementById('loadMore').style.display = end < list.length ? 'inline-flex' : 'none';
    }

    // Filters
    function applyFiltersAndRender() {
        const search = document.getElementById('searchInput').value.toLowerCase().trim();
        const field = document.getElementById('fieldFilter').value.toLowerCase();
        const user = document.getElementById('userFilter').value.toLowerCase();
        const range = document.getElementById('timeRange').value;
        let start = null, end = new Date();

        if (range === 'today') { start = new Date(); start.setHours(0,0,0,0); }
        else if (range === '7d') { start = new Date(); start.setDate(start.getDate() - 7); }
        else if (range === '30d') { start = new Date(); start.setDate(start.getDate() - 30); }
        else if (range === 'custom') {
            const s = document.getElementById('startDate').value;
            const e = document.getElementById('endDate').value;
            start = s ? new Date(s + 'T00:00:00') : null;
            end = e ? new Date(e + 'T23:59:59') : new Date();
        }

        filtered = auditStore.filter(r => {
            if (range !== 'all' && start) {
                const d = new Date(r.modified_at);
                if (d < start || d > end) return false;
            }
            if (field && String(r.field_changed || '').toLowerCase() !== field) return false;
            if (user && !(r.modified_by_name || '').toLowerCase().includes(user)) return false;
            if (search) {
                const hay = [r.case_title, r.slug, JSON.stringify(r.old_value), JSON.stringify(r.new_value)].join('|').toLowerCase();
                if (!hay.includes(search)) return false;
            }
            return true;
        });
        currentPage = 1;
        renderTable(filtered);
    }
    
    // Charts
    function createChart(ctx, type, labels, data, label, backgroundColor) {
        const legendColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim();
        const ticksColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color-muted').trim();
        const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim();
        return new Chart(ctx, {
            type,
            data: { labels, datasets: [{ label, data, backgroundColor }] },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { ticks: { color: ticksColor, font: { family: 'Inter' } }, grid: { color: gridColor } },
                    x: { ticks: { color: ticksColor, font: { family: 'Inter' } }, grid: { color: gridColor } }
                }
            }
        });
    }

    function buildChartsFromStore() {
        const fieldCounts = auditStore.reduce((acc, r) => { acc[r.field_changed || 'unknown'] = (acc[r.field_changed || 'unknown'] || 0) + 1; return acc; }, {});
        const editorCounts = auditStore.reduce((acc, r) => { acc[r.modified_by_name || 'unknown'] = (acc[r.modified_by_name || 'unknown'] || 0) + 1; return acc; }, {});

        const topFields = Object.entries(fieldCounts).sort((a, b) => b[1] - a[1]).slice(0, 8);
        const topEditors = Object.entries(editorCounts).sort((a, b) => b[1] - a[1]).slice(0, 8);

        if (fieldsChart) fieldsChart.destroy();
        fieldsChart = createChart(document.getElementById('fieldsChart').getContext('2d'), 'bar', topFields.map(e => e[0]), topFields.map(e => e[1]), 'Changes', '#22c55e');

        if (editorsChart) editorsChart.destroy();
        editorsChart = createChart(document.getElementById('editorsChart').getContext('2d'), 'bar', topEditors.map(e => e[0]), topEditors.map(e => e[1]), 'Edits', '#6366f1');
    }

    // CSV Export
    function exportCSV(list) {
      if (!list || !list.length) { alert('No data to export.'); return; }
      const headers = ['case_title', 'slug', 'field_changed', 'old_value', 'new_value', 'modified_at', 'modified_by_name'];
      let csvContent = headers.join(',') + '\r\n';
      list.forEach(r => {
        const oldVal = JSON.stringify(r.old_value || '').replace(/"/g, '""');
        const newVal = JSON.stringify(r.new_value || '').replace(/"/g, '""');
        const row = [r.case_title, r.slug, r.field_changed, oldVal, newVal, r.modified_at, r.modified_by_name].map(val => `"${String(val || '').replace(/"/g, '""')}"`);
        csvContent += row.join(',') + '\r\n';
      });
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `audit_export_${new Date().toISOString().slice(0, 10)}.csv`;
      link.click();
      URL.revokeObjectURL(link.href);
    }
    
    // Realtime
    let toastTimer = null;
    function showToastNotification(row, type) {
      clearTimeout(toastTimer);
      const colors = { insert: '#16a34a', update: '#2563eb', delete: '#ef4444' };
      const icons = { insert: '✅', update: '✏️', delete: '🗑️' };
      const msg = `${row.modified_by_name || 'System'} ${type}d an item.`;
      toast.style.background = colors[type] || '#6366f1';
      toast.innerHTML = `<span style="font-size:18px;">${icons[type] || 'ℹ️'}</span><span>${escapeHtml(msg)}</span>`;
      toast.classList.add('show');
      toastTimer = setTimeout(() => toast.classList.remove('show'), 4500);
    }

    function setupRealtime() {
      supabase.channel('public:case_history_changes')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'case_history' }, payload => {
          if (payload.eventType === 'INSERT') {
            auditStore.unshift(payload.new);
            showToastNotification(payload.new, 'insert');
          } else if (payload.eventType === 'UPDATE') {
            const idx = auditStore.findIndex(x => x.id === payload.new.id);
            if (idx > -1) auditStore[idx] = payload.new;
            showToastNotification(payload.new, 'update');
          } else if (payload.eventType === 'DELETE') {
            auditStore = auditStore.filter(x => x.id !== payload.old.id);
            showToastNotification(payload.old, 'delete');
          }
          buildChartsFromStore();
          applyFiltersAndRender();
        })
        .subscribe();
    }

    // UI Events
    document.getElementById('timeRange').addEventListener('change', (e) => {
      document.getElementById('customDates').style.display = e.target.value === 'custom' ? 'block' : 'none';
    });
    document.getElementById('applyBtn').addEventListener('click', applyFiltersAndRender);
    document.getElementById('clearBtn').addEventListener('click', () => {
      ['searchInput', 'fieldFilter', 'userFilter', 'timeRange', 'startDate', 'endDate'].forEach(id => document.getElementById(id).value = id === 'timeRange' ? 'all' : '');
      applyFiltersAndRender();
    });
    document.getElementById('exportBtn').addEventListener('click', () => exportCSV(filtered));
    document.getElementById('loadMore').addEventListener('click', () => { currentPage++; renderTable(filtered); });
    document.getElementById('searchInput').addEventListener('keydown', e => { if (e.key === 'Enter') applyFiltersAndRender(); });

    // Admin Access Check
    async function checkAdminAccess() {
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
          document.getElementById('dashboard').classList.add('hidden');
          document.getElementById('restricted-card').classList.remove('hidden');
          return;
        }
        const { data, error } = await supabase.from('users').select('role').eq('id', user.id).single();
        if (error || !data || data.role !== 'admin') {
          document.getElementById('dashboard').classList.add('hidden');
          document.getElementById('restricted-card').classList.remove('hidden');
        } else {
          document.getElementById('restricted-card').classList.add('hidden');
          document.getElementById('dashboard').classList.remove('hidden');
          // Boot app only for admins
          await fetchInitial();
          setupRealtime();
        }
      } catch (e) {
        console.error('Admin check failed', e);
        document.getElementById('dashboard').classList.add('hidden');
        document.getElementById('restricted-card').classList.remove('hidden');
      }
    }
    
    // Boot the application
    document.addEventListener('DOMContentLoaded', checkAdminAccess);
</script>

</body>
</html>
