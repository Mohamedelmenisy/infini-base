<!doctype html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>InfiniBase — Audit Trail Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/5.1.0/diff.min.js"></script>
    <style>
        :root {
            --bg-dark: #0F1015;
            --bg-card: #1A1C23;
            --bg-header: #21242D;
            --primary-accent: #6C5DD3;
            --text-light: #F5F5F5;
            --text-muted: #9CA3B3;
            --border-color: #2A2D38;
            --success: #00B69B;
            --warning: #FFC454;
            --danger: #FF6A55;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-dark); color: var(--text-light); }
        .insights-dashboard { padding: 24px; display: grid; gap: 24px; visibility: hidden; }
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; background: var(--bg-header); padding: 24px; border-radius: 16px; border: 1px solid var(--border-color); }
        .header-title h1 { font-size: 2rem; font-weight: 800; background: linear-gradient(135deg, var(--primary-accent), #8374FF); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .action-btn { background-color: var(--bg-card); color: var(--text-light); border: 1px solid var(--border-color); padding: 8px 12px; border-radius: 10px; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; font-size: 12px; font-weight: 600; }
        .filters-container { background-color: var(--bg-card); padding: 24px; border-radius: 16px; display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); align-items: end; gap: 20px; }
        .filter-group { display: flex; flex-direction: column; gap: 8px; }
        .filter-group label { font-size: 14px; color: var(--text-muted); }
        .filter-group input, .filter-group select { background-color: var(--bg-dark); border: 1px solid var(--border-color); color: var(--text-light); padding: 12px 16px; border-radius: 12px; }
        .filter-actions { grid-column: 1 / -1; display: flex; justify-content: flex-end; }
        .activity-log-card { background-color: var(--bg-card); padding: 24px; border-radius: 16px; }
        .activity-table { width: 100%; border-collapse: collapse; }
        .activity-table th { background-color: var(--bg-header); color: var(--text-muted); text-align: left; padding: 16px 20px; border-bottom: 1px solid var(--border-color); }
        .activity-table td { padding: 16px 20px; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .user-avatar { width: 36px; height: 36px; border-radius: 50%; background: var(--primary-accent); display: flex; align-items: center; justify-content: center; font-weight: 600; }
        .badge { padding: 6px 12px; border-radius: 8px; text-transform: uppercase; font-size: 12px; }
        .badge.CASE_CREATED { background: rgba(0, 182, 155, .2); color: var(--success); }
        .badge.CASE_UPDATED { background: rgba(255, 196, 84, .2); color: var(--warning); }
        .badge.CASE_DELETED { background: rgba(255, 106, 85, .2); color: var(--danger); }
        .pagination { display: flex; justify-content: center; align-items: center; gap: 12px; margin-top: 24px; }
        .pagination-btn { background: var(--bg-header); border: 1px solid var(--border-color); color: var(--text-light); padding: 10px 16px; border-radius: 10px; cursor: pointer; }
        .pagination-btn:disabled { opacity: .5; }
        .modal { position: fixed; inset: 0; z-index: 2000; display: none; align-items: center; justify-content: center; background: rgba(15, 16, 21, .8); backdrop-filter: blur(10px); }
        .modal.show { display: flex; }
        .modal-content { background: var(--bg-card); padding: 24px; width: 90%; max-width: 800px; max-height: 85vh; border: 1px solid var(--border-color); display: flex; flex-direction: column; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 16px; margin-bottom: 20px; }
        .modal .close-btn { background: 0 0; border: none; font-size: 24px; color: var(--text-muted); cursor: pointer; }
        .diff-content-area { background-color: var(--bg-dark); border: 1px solid var(--border-color); padding: 20px; font-family: 'Courier New', monospace; white-space: pre-wrap; flex-grow: 1; overflow-y: auto; }
        .diff-added { background-color: rgba(0, 182, 155, 0.15); }
        .diff-removed { background-color: rgba(255, 106, 85, 0.15); text-decoration: line-through; }
        .diff-notice { padding: 16px; background-color: rgba(63, 140, 255, 0.1); border: 1px solid #3F8CFF; text-align: center; }
        .access-restricted-container { display: none; }
    </style>
</head>
<body>
    <div id="dashboard-container" class="insights-dashboard">
        <header class="dashboard-header"><div class="header-title"><h1><i class="fas fa-shield-alt"></i> Audit Trail</h1></div></header>
        <div class="filters-container">
            <div class="filter-group"><label>Case Title</label><input id="searchInput"></div>
            <div class="filter-group"><label>User</label><input id="userSearchInput"></div>
            <div class="filter-group"><label>Section</label><select id="sectionFilter"><option value="">All</option></select></div>
            <div class="filter-group"><label>Action</label><select id="actionFilter"><option value="">All</option><option value="CASE_CREATED">Created</option><option value="CASE_UPDATED">Updated</option><option value="CASE_DELETED">Deleted</option></select></div>
            <div class="filter-actions"><button id="clearBtn" class="action-btn">Clear</button></div>
        </div>
        <div class="activity-log-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;"><h3><i class="fas fa-history"></i> Activity Log</h3><div id="totalRecords">0 records</div></div>
            <div class="table-container">
                <table class="activity-table">
                    <thead><tr><th>Date & Time</th><th>User</th><th>Case</th><th>Section</th><th>Action</th><th>Details</th><th>Changes</th><th>History</th></tr></thead>
                    <tbody id="auditBody"></tbody>
                </table>
            </div>
            <div class="pagination"><button id="prevBtn" class="pagination-btn">Previous</button><span id="pageInfo">Page 1 of 1</span><button id="nextBtn" class="pagination-btn">Next</button></div>
        </div>
    </div>
    <div id="restricted-container" class="access-restricted-container"></div>
    <div id="diffModal" class="modal"><div class="modal-content"><div class="modal-header"><h2 id="diffCaseTitle"></h2><button class="close-btn">&times;</button></div><div id="diffBody" class="diff-content-area"></div></div></div>
    <div id="timelineModal" class="modal"><div class="modal-content"><div class="modal-header"><h2 id="timelineCaseTitle"></h2><button class="close-btn">&times;</button></div><div id="timelineBody"></div></div></div>
    <script type="module">
        import { supabase } from "./supabase.js";
        let currentTableData = [], pageSize = 10, currentPage = 1, totalRecordsCount = 0;
        const escapeHtml = u => String(u||"").replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]);
        const formatTime = t => t ? new Date(t).toLocaleString("en-US",{timeZone:"Africa/Cairo",year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}) : "-";
        const stripHtml = h => {if(!h)return"";const d=document.createElement("div");d.innerHTML=h;return d.textContent||d.innerText||""};
        const createFriendlyDiff=(oldH,newH)=>{const oldT=stripHtml(oldH),newT=stripHtml(newH);if(!oldT&&!newT){const n=document.createElement('div');n.className='diff-notice';n.textContent='No content recorded.';return n}const diff=Diff.diffWords(oldT||"",newT||""),frag=document.createDocumentFragment();if(diff.length===1&&!diff[0].added&&!diff[0].removed){const n=document.createElement('div');n.className='diff-notice';n.innerHTML='<i class="fas fa-info-circle"></i> Technical modification, no visible text change.';frag.appendChild(n);return frag}diff.forEach(p=>{const s=document.createElement('span');if(p.added)s.className='diff-added';else if(p.removed)s.className='diff-removed';s.appendChild(document.createTextNode(p.value));frag.appendChild(s)});return frag};
        const populateFilters=async()=>{const{data,error}=await supabase.from('distinct_sections').select('section');if(error)return;const sel=document.getElementById("sectionFilter");sel.innerHTML='<option value="">All</option>';data.forEach(({section:s})=>s&&sel.add(new Option(s,s)))};
        const renderPage=()=>{const tbody=document.getElementById("auditBody"),totalP=Math.max(1,Math.ceil(totalRecordsCount/pageSize));tbody.innerHTML="";if(currentTableData.length){currentTableData.forEach(i=>{const r=document.createElement("tr"),a=(i.action||'').toUpperCase();const cBtn=a.includes('UPDATED')?`<button class="action-btn view-diff-btn" data-history-id="${i.id}"><i class="fas fa-exchange-alt"></i></button>`:`<span>—</span>`;r.innerHTML=`<td>${formatTime(i.modified_at_egypt)}</td><td><div class="user-info"><div class="user-avatar">${(i.user_name||'?').charAt(0)}</div><div>${escapeHtml(i.user_name)}<br><small>${escapeHtml(i.user_email)}</small></div></div></td><td>${escapeHtml(i.case_title)}</td><td>${escapeHtml(i.section)}</td><td><span class="badge ${a}">${a}</span></td><td>${escapeHtml(i.details)}</td><td>${cBtn}</td><td><button class="action-btn view-timeline-btn" data-case-id="${i.case_id}"><i class="fas fa-stream"></i></button></td>`;tbody.appendChild(r)})}else{tbody.innerHTML='<tr><td colspan="8" style="text-align:center;">No records.</td></tr>'}document.getElementById("pageInfo").textContent=`Page ${currentPage} of ${totalP}`;document.getElementById("prevBtn").disabled=currentPage===1;document.getElementById("nextBtn").disabled=currentPage>=totalP;document.getElementById("totalRecords").textContent=`${totalRecordsCount} records`};
        const applyFiltersAndRender=async(reset=true)=>{if(reset)currentPage=1;let q=supabase.from("v_case_history_audit");const sT=document.getElementById("searchInput").value.trim(),uT=document.getElementById("userSearchInput").value.trim();const aF=document.getElementById("actionFilter").value,sF=document.getElementById("sectionFilter").value;if(sT)q=q.ilike('case_title',`%${sT}%`);if(uT)q=q.or(`user_name.ilike.%${uT}%,user_email.ilike.%${uT}%`);if(aF)q=q.eq('action',aF);if(sF)q=q.eq('section',sF);try{const start=(currentPage-1)*pageSize;const{data,count,error}=await q.select('*',{count:'exact'}).order("modified_at_egypt",{ascending:false}).range(start,start+pageSize-1);if(error)throw error;currentTableData=data||[];totalRecordsCount=count||0;renderPage()}catch(e){console.error("Error fetching data:",e);document.getElementById("auditBody").innerHTML = '<tr><td colspan="8" style="text-align:center; color: var(--danger);">Failed to load data. Check console.</td></tr>';}};
        const showDiff=id=>{const rec=currentTableData.find(i=>i.id==id);if(!rec)return;const m=document.getElementById("diffModal");document.getElementById("diffCaseTitle").textContent=`Changes for: ${rec.case_title}`;const b=document.getElementById("diffBody");b.innerHTML='';b.appendChild(createFriendlyDiff(rec.old_value,rec.new_value));m.classList.add("show")};
        const showTimeline=async id=>{/* Placeholder */};
        async function checkAccess(){try{const{data:{user}}=await supabase.auth.getUser();if(!user)throw new Error("Access denied.");document.getElementById("dashboard-container").style.visibility="visible";await populateFilters();await applyFiltersAndRender()}catch(e){document.getElementById("restricted-container").style.display="flex"}}
        document.addEventListener("DOMContentLoaded",()=>{checkAccess();["searchInput","userSearchInput","sectionFilter","actionFilter"].forEach(id=>document.getElementById(id).addEventListener("input",()=>applyFiltersAndRender(true)));document.getElementById("clearBtn").addEventListener("click",()=>{["searchInput","userSearchInput","sectionFilter","actionFilter"].forEach(id=>document.getElementById(id).value="");applyFiltersAndRender(true)});document.getElementById("prevBtn").addEventListener("click",()=>{currentPage--;applyFiltersAndRender(false)});document.getElementById("nextBtn").addEventListener("click",()=>{currentPage++;applyFiltersAndRender(false)});document.addEventListener("click",e=>{const dBtn=e.target.closest(".view-diff-btn");if(dBtn)showDiff(dBtn.dataset.historyId);const tBtn=e.target.closest(".view-timeline-btn");if(tBtn)showTimeline(tBtn.dataset.caseId);if(e.target.closest(".close-btn")||e.target.matches(".modal")){document.querySelectorAll(".modal.show").forEach(m=>m.classList.remove("show"))}})});
    </script>
</body>
</html>
