<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>InfiniBase — Audit Log (Realtime, Full)</title>

  <!-- External libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --muted:#9ca3af; --primary:#6366f1;
      --border:rgba(255,255,255,0.04);
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial;background:var(--bg);color:#d1d5db;}
    .container{max-width:1200px;margin:24px auto;padding:0 16px;}
    h1{font-weight:800;color:var(--primary);margin-bottom:14px;font-size:22px;}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;box-shadow:0 6px 20px rgba(0,0,0,0.45);}
    .filters{display:flex;gap:12px;flex-wrap:wrap;align-items:end;}
    .input,select,button{background:rgba(255,255,255,0.03);border:1px solid var(--border);color:var(--muted);padding:8px 10px;border-radius:8px;font-size:13px;}
    .btn-primary{background:var(--primary);color:white;border:1px solid rgba(0,0,0,0.08);}
    .table-wrap{overflow:auto;border-radius:8px;}
    table{width:100%;border-collapse:collapse;min-width:1000px;}
    th,td{padding:12px 14px;border-bottom:1px solid var(--border);font-size:13px;color:#cbd5e1;text-align:left;}
    thead th{background:#071021;color:var(--muted);font-size:12px;text-transform:uppercase;letter-spacing:0.03em;}
    .muted{color:var(--muted);font-size:13px;}
    .overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(2,6,23,0.5);z-index:1000;visibility:hidden;opacity:0;transition:opacity .18s;}
    .overlay.show{visibility:visible;opacity:1;}
    .spinner{width:72px;height:72px;border-radius:50%;border:6px solid rgba(255,255,255,0.06);border-top-color:var(--primary);animation:spin 1s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg);}}
    .toast{position:fixed;top:20px;right:20px;z-index:1100;display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:10px;color:white;box-shadow:0 8px 30px rgba(0,0,0,0.5);cursor:pointer;transform-origin:right top;transition:transform .18s ease,opacity .18s;}
    .toast.hide{opacity:0;transform:translateY(-8px) scale(.98);pointer-events:none;}
    .toast.show{opacity:1;transform:translateY(0) scale(1);pointer-events:auto;}
    .highlight{background:rgba(99,102,241,0.18) !important;transition:background 1s;}
    @media (max-width:980px){ .filters{flex-direction:column;align-items:stretch;} table{min-width:900px;} }
  </style>
</head>
<body>
<div id="dashboard">
  <div class="container">
    <h1>InfiniBase — Audit Log (Realtime)</h1>

    <!-- Toast -->
    <div id="toast" class="toast hide" role="status" aria-live="polite"></div>

    <!-- Overlay spinner -->
    <div id="overlay" class="overlay"><div class="spinner" aria-hidden="true"></div></div>

    <!-- Filters -->
    <div class="card" style="margin-bottom:16px;">
      <div class="filters" role="region" aria-label="filters">
        <div style="flex:1;min-width:220px;">
          <label class="muted" for="searchInput">Search (case title / slug / user / field)</label>
          <input id="searchInput" class="input" placeholder="Search..." />
        </div>
        <div>
          <label class="muted" for="fieldFilter">Field</label>
          <select id="fieldFilter" class="input">
            <option value="">All fields</option>
            <option value="status">status</option>
            <option value="assigned_to">assigned_to</option>
            <option value="priority">priority</option>
            <option value="title">title</option>
          </select>
        </div>
        <div>
          <label class="muted" for="userFilter">User</label>
          <input id="userFilter" class="input" placeholder="User name or email" />
        </div>
        <div>
          <label class="muted" for="timeRange">Time Range</label>
          <select id="timeRange" class="input">
            <option value="all">All time</option>
            <option value="today">Today</option>
            <option value="7d">Last 7 days</option>
            <option value="30d">Last 30 days</option>
            <option value="custom">Custom</option>
          </select>
        </div>
        <div id="customDates" style="display:none;">
          <label class="muted">Start</label>
          <input id="startDate" type="date" class="input" />
          <label class="muted">End</label>
          <input id="endDate" type="date" class="input" />
        </div>

        <div style="display:flex;gap:8px;align-items:center;">
          <button id="applyBtn" class="btn-primary input">Apply</button>
          <button id="clearBtn" class="input">Clear</button>
          <button id="exportBtn" class="input">Export CSV</button>
        </div>
      </div>
    </div>

    <!-- Charts + Stats -->
    <div class="card" style="margin-bottom:16px;">
      <div style="display:flex;gap:16px;align-items:center;flex-wrap:wrap;">
        <div style="flex:1;min-width:220px;">
          <h3 class="muted">Top Changed Fields</h3>
          <canvas id="fieldsChart" height="120"></canvas>
        </div>
        <div style="flex:1;min-width:220px;">
          <h3 class="muted">Top Editors</h3>
          <canvas id="editorsChart" height="120"></canvas>
        </div>
        <div style="width:220px;">
          <h3 class="muted">Total Changes</h3>
          <div id="totalChanges" style="font-size:24px;font-weight:700;">0</div>
        </div>
      </div>
    </div>

    <!-- Audit table -->
    <div class="card">
      <h3 class="muted">Audit Trail</h3>
      <div class="table-wrap" style="margin-top:12px;">
        <table role="table" aria-label="Audit trail">
          <thead>
            <tr>
              <th>Case</th>
              <th>Field</th>
              <th>Old Value</th>
              <th>New Value</th>
              <th>Modified At</th>
              <th>Modified By</th>
            </tr>
          </thead>
          <tbody id="auditBody">
            <tr><td colspan="6" class="muted" style="text-align:center;padding:20px 0;">Loading...</td></tr>
          </tbody>
        </table>
      </div>
      <div style="display:flex;justify-content:center;margin-top:12px;">
        <button id="loadMore" class="input">Load more</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { supabase } from './supabase.js';

    // ---------------- state ----------------
    let auditStore = []; // master list of audit rows (most recent first)
    let filtered = [];
    let pageSize = 25;
    let currentPage = 1;

    // charts state
    let fieldsChart = null;
    let editorsChart = null;

    // dom refs
    const overlay = document.getElementById('overlay');
    const toast = document.getElementById('toast');
    const auditBody = document.getElementById('auditBody');
    const totalChangesEl = document.getElementById('totalChanges');
    const fieldsChartCtx = document.getElementById('fieldsChart').getContext('2d');
    const editorsChartCtx = document.getElementById('editorsChart').getContext('2d');

    // helpers
    function showOverlay(show=true){ overlay.classList.toggle('show', !!show); }
    function escapeHtml(s){ if(s===null||s===undefined) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
    function formatTime(ts){ if(!ts) return '-'; try{ return new Date(ts).toLocaleString(); }catch(e){return ts;} }

    // ---------------- fetch initial data ----------------
    async function fetchInitial(){
      showOverlay(true);
      try{
        // RPC: get_full_case_history() should return the audit rows (id, case_id, case_title, slug, field_changed, old_value, new_value, modified_at, modified_by_name)
        const { data, error } = await supabase.rpc('get_full_case_history');
        if(error){ console.error('get_full_case_history error', error); auditStore = []; }
        else auditStore = data || [];

        // Build charts from initial snapshot (counts)
        buildChartsFromStore();
        applyFiltersAndRender();
      } finally {
        showOverlay(false);
      }
    }

    // ---------------- rendering ----------------
    function renderTable(list){
      auditBody.innerHTML = '';
      if(!list || !list.length){
        auditBody.innerHTML = '<tr><td colspan="6" class="muted" style="text-align:center;padding:20px 0;">No records</td></tr>';
        totalChangesEl.textContent = 0;
        return;
      }
      const end = Math.min(list.length, currentPage * pageSize);
      for(let i=0;i<end;i++){
        const r = list[i];
        const rowId = `row-${i}`;
        const oldVal = typeof r.old_value === 'object' ? JSON.stringify(r.old_value) : (r.old_value || '');
        const newVal = typeof r.new_value === 'object' ? JSON.stringify(r.new_value) : (r.new_value || '');
        const tr = document.createElement('tr');
        tr.id = rowId;
        tr.innerHTML = `
          <td>${escapeHtml(r.case_title || r.slug || '-')}</td>
          <td>${escapeHtml(r.field_changed || '-')}</td>
          <td style="white-space:pre-wrap;max-width:300px">${escapeHtml(oldVal)}</td>
          <td style="white-space:pre-wrap;max-width:300px">${escapeHtml(newVal)}</td>
          <td>${escapeHtml(formatTime(r.modified_at))}</td>
          <td>${escapeHtml(r.modified_by_name)}</td>
        `;
        auditBody.appendChild(tr);
      }
      totalChangesEl.textContent = list.length;
    }

    // ---------------- filters ----------------
    function applyFiltersAndRender(){
      const search = (document.getElementById('searchInput').value || '').toLowerCase().trim();
      const field = (document.getElementById('fieldFilter').value || '').toLowerCase();
      const user = (document.getElementById('userFilter').value || '').toLowerCase();
      const range = (document.getElementById('timeRange').value || 'all');
      let start=null,end=null;
      if(range==='today'){ const now = new Date(); start=new Date(now.getFullYear(),now.getMonth(),now.getDate()); end=new Date(start); end.setDate(end.getDate()+1); }
      else if(range==='7d'){ end=new Date(); start=new Date(); start.setDate(start.getDate()-6); }
      else if(range==='30d'){ end=new Date(); start=new Date(); start.setDate(start.getDate()-29); }
      else if(range==='custom'){ const s=document.getElementById('startDate').value; const e=document.getElementById('endDate').value; start = s ? new Date(s+'T00:00:00') : null; end = e ? new Date(e+'T23:59:59') : null; }

      filtered = auditStore.filter(r => {
        // time filter
        if(start && end){
          const d = new Date(r.modified_at);
          if(d < start || d > end) return false;
        }
        // field filter
        if(field && field.length && String(r.field_changed||'').toLowerCase() !== field) return false;
        // user filter
        if(user && user.length){
          const uname = (r.modified_by_name||'').toLowerCase();
          if(!uname.includes(user)) return false;
        }
        // search filter across case title, slug, old/new values
        if(search && search.length){
          const hay = (r.case_title||'') + '|' + (r.slug||'') + '|' + JSON.stringify(r.old_value||'') + '|' + JSON.stringify(r.new_value||'');
          if(!hay.toLowerCase().includes(search)) return false;
        }
        return true;
      });

      currentPage = 1;
      renderTable(filtered);
    }

    // ---------------- charts ----------------
    function buildChartsFromStore(){
      // Top changed fields
      const fieldCounts = {};
      const editorCounts = {};
      for(const r of auditStore){
        const f = r.field_changed || 'unknown';
        fieldCounts[f] = (fieldCounts[f] || 0) + 1;
        const u = r.modified_by_name || 'unknown';
        editorCounts[u] = (editorCounts[u] || 0) + 1;
      }
      const fieldLabels = Object.keys(fieldCounts).sort((a,b)=>fieldCounts[b]-fieldCounts[a]).slice(0,8);
      const fieldValues = fieldLabels.map(l=>fieldCounts[l]);
      const editorLabels = Object.keys(editorCounts).sort((a,b)=>editorCounts[b]-editorCounts[a]).slice(0,8);
      const editorValues = editorLabels.map(l=>editorCounts[l]);

      // render fields chart
      if(fieldsChart) fieldsChart.destroy();
      fieldsChart = new Chart(fieldsChartCtx, {
        type: 'bar',
        data: { labels: fieldLabels, datasets: [{ label:'Changes', data: fieldValues, backgroundColor:'#10b981' }] },
        options: { plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true } } }
      });

      // render editors chart
      if(editorsChart) editorsChart.destroy();
      editorsChart = new Chart(editorsChartCtx, {
        type: 'bar',
        data: { labels: editorLabels, datasets: [{ label:'Edits', data: editorValues, backgroundColor:'#6366f1' }] },
        options: { plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true } } }
      });
    }

    // ---------------- CSV export ----------------
    function exportCSV(list){
      if(!list || !list.length){ alert('No data to export'); return; }
      const headers = ['case_title','slug','field_changed','old_value','new_value','modified_at','modified_by_name'];
      const rows = [headers.join(',')];
      for(const r of list){
        const oldVal = typeof r.old_value === 'object' ? JSON.stringify(r.old_value).replaceAll('"','""') : String(r.old_value||'').replaceAll('"','""');
        const newVal = typeof r.new_value === 'object' ? JSON.stringify(r.new_value).replaceAll('"','""') : String(r.new_value||'').replaceAll('"','""');
        const row = [`"${(r.case_title||'').replaceAll('"','""')}"`,`"${(r.slug||'').replaceAll('"','""')}"`,`"${(r.field_changed||'').replaceAll('"','""')}"`,`"${oldVal}"`,`"${newVal}"`,`"${r.modified_at}"`,`"${(r.modified_by_name||'').replaceAll('"','""')}"`];
        rows.push(row.join(','));
      }
      const csv = rows.join('\\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'audit_export_' + new Date().toISOString().slice(0,10) + '.csv'; a.click(); URL.revokeObjectURL(url);
    }

    // ---------------- realtime patching ----------------
    function setupRealtime(){
      // channel for case_history (table name in your DB might be 'case_history' or similar)
      supabase.channel('public:case_history_changes')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'case_history' }, payload => {
          try{
            const t = payload.eventType;
            if(t === 'INSERT'){
              auditStore.unshift(payload.new);
              showTypedToast(payload.new, 'insert');
            } else if(t === 'UPDATE'){
              const idx = auditStore.findIndex(x => String(x.id) === String(payload.new.id));
              if(idx > -1) auditStore[idx] = payload.new;
              showTypedToast(payload.new, 'update');
            } else if(t === 'DELETE'){
              auditStore = auditStore.filter(x => String(x.id) !== String(payload.old.id));
              showTypedToast(payload.old, 'delete');
            }
            // update charts and UI
            buildChartsFromStore();
            applyFiltersAndRender();
          } catch(e){ console.error('realtime patch error', e); }
        })
        .subscribe();
    }

    // ---------------- toast ----------------
    let toastTimer = null;
    function showTypedToast(row, type){
      clearTimeout(toastTimer);
      const colors = { insert:'#16a34a', update:'#2563eb', delete:'#ef4444' };
      const icons = { insert:'✅', update:'✏️', delete:'🗑️' };
      const actor = row.modified_by_name || 'Unknown';
      const title = row.case_title || row.slug || '-';
      const f = row.field_changed || '-';
      const time = formatTime(row.modified_at || row.activity_time);
      const msg = `${icons[type] || 'ℹ️'} ${actor} ${type === 'insert' ? 'created' : (type==='delete'?'deleted':'updated')} "${title}" (${f}) — ${time}`;
      toast.style.background = colors[type] || '#6366f1';
      toast.innerHTML = `<span style="font-size:18px;margin-right:6px;">${icons[type] || 'ℹ️'}</span><div style="line-height:1.05;">${escapeHtml(msg)}</div>`;
      toast.classList.remove('hide'); toast.classList.add('show');
      // click behavior: try to find the row in filtered list and highlight it
      toast.onclick = () => {
        const idx = filtered.findIndex(x => String(x.id) === String(row.id));
        if(idx > -1){
          const el = document.getElementById('row-' + idx);
          if(el){ el.scrollIntoView({ behavior:'smooth', block:'center' }); el.classList.add('highlight'); setTimeout(()=>el.classList.remove('highlight'),3500); }
        } else {
          window.scrollTo({ top:0, behavior:'smooth' });
        }
        toast.classList.remove('show'); toast.classList.add('hide');
      };
      toastTimer = setTimeout(()=>{ toast.classList.remove('show'); toast.classList.add('hide'); }, 4500);
    }

    // ---------------- UI events ----------------
    document.getElementById('timeRange').addEventListener('change', (e)=>{
      document.getElementById('customDates').style.display = (e.target.value === 'custom') ? 'inline-flex' : 'none';
    });
    document.getElementById('applyBtn').addEventListener('click', ()=> applyFiltersAndRender());
    document.getElementById('clearBtn').addEventListener('click', ()=>{
      document.getElementById('searchInput').value = '';
      document.getElementById('fieldFilter').value = '';
      document.getElementById('userFilter').value = '';
      document.getElementById('timeRange').value = 'all';
      document.getElementById('startDate').value = '';
      document.getElementById('endDate').value = '';
      applyFiltersAndRender();
    });
    document.getElementById('exportBtn').addEventListener('click', ()=> exportCSV(filtered));
    document.getElementById('loadMore').addEventListener('click', ()=>{ currentPage++; renderTable(filtered); });

    // quick search enter key trigger
    document.getElementById('searchInput').addEventListener('keydown', (e)=>{ if(e.key === 'Enter') applyFiltersAndRender(); });

    // ---------------- boot ----------------
    (async function boot(){
      showOverlay(true);
      await fetchInitial();
      setupRealtime();
      showOverlay(false);
    })();

  </script>
</div>

<!-- Admin access restricted card -->
<div id="restricted-card" class="hidden flex items-center justify-center h-screen bg-gray-900">
  <div class="bg-gray-800 text-center p-10 rounded-2xl shadow-2xl max-w-md">
    <div class="text-indigo-400 text-6xl mb-4">🔒</div>
    <h2 class="text-2xl font-bold text-white mb-2">Access Restricted</h2>
    <p class="text-gray-400 mb-6">This page is available to administrators only.</p>
    <a href="/" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-6 rounded-lg">Go Back Home</a>
  </div>
</div>


<!-- Admin check script -->
<script type="module">
import { supabase } from './supabase.js';

async function checkAdminAccess() {
  try {
    const { data: { user }, error: userErr } = await supabase.auth.getUser();
    if (userErr || !user) {
      // show restricted if not logged in
      document.getElementById('dashboard').classList.add('hidden');
      document.getElementById('restricted-card').classList.remove('hidden');
      return;
    }
    const { data, error } = await supabase
      .from('users')
      .select('role')
      .eq('id', user.id)
      .single();
    if (error || !data || data.role !== 'admin') {
      document.getElementById('dashboard').classList.add('hidden');
      document.getElementById('restricted-card').classList.remove('hidden');
    } else {
      // admin: ensure dashboard visible (in case hidden)
      document.getElementById('restricted-card').classList.add('hidden');
      document.getElementById('dashboard').classList.remove('hidden');
    }
  } catch (e) {
    console.error('admin check failed', e);
  }
}

document.addEventListener('DOMContentLoaded', checkAdminAccess);
</script>

</body>
</html>
