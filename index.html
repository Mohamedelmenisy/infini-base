<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InfiniBase - Knowledge Base</title>
    <link rel="icon" type="image/x-icon" href="https://cdn-icons-png.flaticon.com/512/919/919820.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', '"Segoe UI"', 'Roboto', '"Helvetica Neue"', 'Arial', '"Noto Sans"', 'sans-serif']
                    }
                }
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .dark body { background-color: #111827; color: #d1d5db; }
        body:not(.dark) { background-color: #f3f4f6; color: #1f2937; }

        .sidebar {
            width: 260px;
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            padding: 1.5rem;
            overflow-y: auto;
            transition: transform 0.3s ease-in-out;
            z-index: 40;
        }
        .dark .sidebar { background-color: #1f2937; color: #9ca3af; border-right: 1px solid #374151; }
        body:not(.dark) .sidebar { background-color: #ffffff; color: #4b5563; border-right: 1px solid #e5e7eb; }

        .sidebar-header {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
        }
        .sidebar-header img { width: 2rem; height: 2rem; margin-right: 0.5rem; }
        .sidebar-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease;
        }
        .dark .sidebar-link { color: #9ca3af; }
        body:not(.dark) .sidebar-link { color: #4b5563; }
        .sidebar-link:hover { background-color: #e5e7eb; }
        .dark .sidebar-link:hover { background-color: #374151; }
        .sidebar-link.active { background-color: #e5e7eb; font-weight: 600; }
        .dark .sidebar-link.active { background-color: #374151; color: #ffffff; }
        .sidebar-link i { margin-right: 0.75rem; }

        .content-wrapper { margin-left: 260px; padding: 1.5rem; transition: margin-left 0.3s ease-in-out; }
        @media (max-width: 767px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .content-wrapper { margin-left: 0; }
        }

        .card {
            background-color: #ffffff;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .dark .card { background-color: #1f2937; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3); }
        .card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15); }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal-content {
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        .dark .modal-content { background-color: #1f2937; }
        .close-modal-btn { position: absolute; top: 1rem; right: 1rem; }

        .chart-container { position: relative; height: 300px; width: 100%; margin-bottom: 1.5rem; }
        .prose { max-width: none; }
        .dark .prose { color: #d1d5db; }
        .prose h1, .prose h2, .prose h3, .prose h4, .prose h5, .prose h6 { color: #1f2937; }
        .dark .prose h1, .dark .prose h2, .dark .prose h3, .dark .prose h4, .dark .prose h5, .dark .prose h6 { color: #ffffff; }

        .ql-editor { min-height: 150px; }
        mark { background-color: #fef08a; padding: 0 2px; border-radius: 2px; }
    </style>
</head>
<body>
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="https://cdn-icons-png.flaticon.com/512/919/919820.png" alt="Logo">
            <span>InfiniBase</span>
        </div>
        <a href="#home" class="sidebar-link active" data-section="home"><i class="fas fa-home"></i> Home</a>
        <a href="#support" class="sidebar-link" data-section="support"><i class="fas fa-headset"></i> Support</a>
        <a href="#partner_care" class="sidebar-link" data-section="partner_care"><i class="fas fa-handshake"></i> Partner Care</a>
        <a href="#logistics" class="sidebar-link" data-section="logistics"><i class="fas fa-truck"></i> Logistics</a>
        <a href="#customer_care" class="sidebar-link" data-section="customer_care"><i class="fas fa-users"></i> Customer Care</a>
        <a href="#dist_follow_up" class="sidebar-link" data-section="dist_follow_up"><i class="fas fa-people-carry"></i> Distribution & Follow-up</a>
        <a href="#logistics_driver" class="sidebar-link" data-section="logistics_driver"><i class="fas fa-shipping-fast"></i> Logistics (Driver Complaints)</a>
        <a href="#logistics_3pl" class="sidebar-link" data-section="logistics_3pl"><i class="fas fa-boxes"></i> Logistics-3PL</a>
        <a href="#order_at_store" class="sidebar-link" data-section="order_at_store"><i class="fas fa-store"></i> Order at Store (Mac)</a>
        <a href="#logistics_admin" class="sidebar-link" data-section="logistics_admin"><i class="fas fa-user-shield"></i> Logistics-Admin</a>
        <a href="#os" class="sidebar-link" data-section="os"><i class="fab fa-windows"></i> Operating Systems</a>
        <a href="#compensation" class="sidebar-link" data-section="compensation"><i class="fas fa-hand-holding-usd"></i> Compensation Policies</a>
        <a href="#op_instructions" class="sidebar-link" data-section="op_instructions"><i class="fas fa-clipboard-list"></i> Operational Instructions</a>
        <a href="#forms_templates" class="sidebar-link" data-section="forms_templates"><i class="fas fa-file-alt"></i> Forms/Templates</a>
    </nav>

    <div class="content-wrapper" id="contentWrapper">
        <header class="flex items-center justify-between mb-6">
            <div class="flex items-center">
                <button id="mobileSidebarToggle" class="md:hidden mr-4 text-2xl"><i class="fas fa-bars"></i></button>
                <h1 class="text-2xl font-bold" id="currentSectionTitle">Dashboard Overview</h1>
            </div>
            <div class="flex items-center space-x-4">
                <div class="relative">
                    <input type="text" id="globalSearchInput" placeholder="Search..." class="border rounded-md px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white w-64">
                    <div id="searchResults" class="absolute mt-1 w-full bg-white dark:bg-gray-700 border dark:border-gray-600 rounded-md shadow-lg max-h-80 overflow-y-auto hidden z-50"></div>
                </div>
                <button id="themeSwitcher" class="flex items-center text-sm"><i id="themeIcon" class="fas fa-moon mr-2"></i><span id="themeText">Dark Mode</span></button>
                <button id="reportErrorBtn" class="text-sm text-red-600 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300"><i class="fas fa-bug mr-1"></i> Report Error</button>
                <div class="flex items-center">
                    <img id="userAvatar" src="https://ui-avatars.com/api/?name=User&size=36&background=4f46e5&color=fff&rounded=true" alt="User Avatar" class="w-9 h-9 rounded-full mr-2">
                    <span id="userNameDisplayHeader" class="text-sm font-medium"></span>
                </div>
                <button id="logoutButton" class="text-sm text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200"><i class="fas fa-sign-out-alt mr-1"></i> Logout</button>
            </div>
        </header>

        <nav class="mb-6" aria-label="Breadcrumb">
            <div class="text-sm text-gray-600 dark:text-gray-400" id="breadcrumbs">
                <span class="font-medium">Home</span>
            </div>
        </nav>

        <div id="pageContentArea">
            <div id="dashboardOverviewContainer">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="card">
                        <h2 id="welcomeUserNameDashboard" class="text-xl font-semibold mb-4"></h2>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">KB Version: <span id="kbVersionDashboard"></span></p>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Last Update: <span id="lastKbUpdateDashboard"></span></p>
                    </div>
                    <div class="card">
                        <h2 class="text-xl font-semibold mb-4">Filters</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <div>
                                <label for="filterDate" class="block text-sm font-medium mb-1">Date</label>
                                <input type="date" id="filterDate" class="border rounded-md px-3 py-2 text-sm w-full dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            </div>
                            <div>
                                <label for="filterUser" class="block text-sm font-medium mb-1">User</label>
                                <select id="filterUser" class="border rounded-md px-3 py-2 text-sm w-full dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    <option value="">All Users</option>
                                </select>
                            </div>
                            <div>
                                <label for="filterInteraction" class="block text-sm font-medium mb-1">Interaction</label>
                                <select id="filterInteraction" class="border rounded-md px-3 py-2 text-sm w-full dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    <option value="">All Interactions</option>
                                    <option value="navigation">Navigation</option>
                                    <option value="case_created">Case Created</option>
                                    <option value="article_view">Article View</option>
                                    <option value="item_added">Item Added</option>
                                </select>
                            </div>
                        </div>
                        <button id="applyFilterBtn" class="mt-4 px-4 py-2 bg-indigo-500 text-white rounded-md hover:bg-indigo-600">Apply Filters</button>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="card">
                        <h2 class="text-xl font-semibold mb-4">User Activity</h2>
                        <div class="chart-container"><canvas id="usersChart"></canvas></div>
                    </div>
                    <div class="card">
                        <h2 class="text-xl font-semibold mb-4">Case Views</h2>
                        <div class="chart-container"><canvas id="casesChart"></canvas></div>
                    </div>
                </div>
                <div class="card">
                    <h2 class="text-xl font-semibold mb-4">Recent Updates</h2>
                    <ul id="recentUpdatesList"></ul>
                </div>
            </div>
            <div id="standardSectionContentPlaceholder" class="hidden"></div>
        </div>

        <footer class="mt-8 py-4 border-t border-gray-200 dark:border-gray-700 text-center">
            <p class="text-sm text-gray-600 dark:text-gray-400">InfiniBase &copy; 2025 | KB Version: <span id="footerKbVersion"></span></p>
        </footer>

        <div id="addContentModalOverlay" class="modal-overlay hidden" aria-hidden="true">
            <div class="modal-content">
                <button id="closeAddContentModalBtn" class="close-modal-btn text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200"><i class="fas fa-times"></i></button>
                <h2 class="text-xl font-semibold mb-4">Add New Content</h2>
                <form id="addContentForm">
                    <div class="mb-4">
                        <label for="contentType" class="block text-sm font-medium mb-1">Content Type</label>
                        <select id="contentType" name="type" class="border rounded-md px-3 py-2 text-sm w-full dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            <option value="case">Case</option>
                            <option value="sheet">Sheet</option>
                            <option value="form">Form</option>
                            <option value="video">Video</option>
                            <option value="design">Design</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="contentTitle" class="block text-sm font-medium mb-1">Title</label>
                        <input type="text" id="contentTitle" name="title" required class="border rounded-md px-3 py-2 text-sm w-full dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    </div>
                    <div class="mb-4">
                        <label for="contentSummary" class="block text-sm font-medium mb-1">Summary</label>
                        <textarea id="contentSummary" name="summary" rows="3" class="border rounded-md px-3 py-2 text-sm w-full dark:bg-gray-700 dark:border-gray-600 dark:text-white"></textarea>
                    </div>
                    <div id="contentUrlContainer" class="mb-4 hidden">
                        <label for="contentUrl" class="block text-sm font-medium mb-1">URL</label>
                        <div class="flex items-center space-x-2">
                            <input type="url" id="contentUrl" name="url" class="border rounded-md px-3 py-2 text-sm w-full dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            <button type="button" id="loadContentBtn" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600">Load Content</button>
                        </div>
                        <div id="contentDisplay" class="mt-2"></div>
                    </div>
                    <div id="resolutionStepsContainer" class="mb-4">
                        <label class="block text-sm font-medium mb-1">Resolution Steps</label>
                        <div id="quillEditor"></div>
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button type="button" id="cancelAddContentBtn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-indigo-500 text-white rounded-md hover:bg-indigo-600">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Simulated Supabase
        const supabase = {
            from: (table) => ({
                select: async (columns = '*') => {
                    console.log(`Simulated Supabase: SELECT ${columns} FROM ${table}`);
                    if (table === 'views_log') {
                        return { 
                            data: [
                                { id: 1, item_id: 'case001', item_type: 'case_created', user_identifier: 'user1@sim.com', viewed_at: '2025-05-25T10:00:00Z' },
                                { id: 2, item_id: 'sup001', item_type: 'article_view', user_identifier: 'user2@sim.com', viewed_at: '2025-05-25T11:00:00Z' },
                                { id: 3, item_id: 'logistics', item_type: 'navigation', user_identifier: 'rahma@example.com', viewed_at: '2025-05-26T09:15:00Z' },
                                { id: 4, item_id: 'item_1678886400000', item_type: 'item_added', user_identifier: 'admin@example.com', viewed_at: '2025-05-26T14:30:00Z' },
                                { id: 5, item_id: 'case002', item_type: 'case_created', user_identifier: 'rahma@example.com', viewed_at: '2025-05-27T08:00:00Z' }
                            ], 
                            error: null 
                        };
                    }
                    if (table === 'cases') return { data: [], error: null };
                    return { data: [], error: null };
                },
                insert: async (records) => {
                    console.log(`Simulated Supabase: INSERT INTO ${table}`, records);
                    const newId = Math.floor(Math.random() * 10000);
                    return { data: [{ id: newId, ...records[0] }], error: null };
                },
                rpc: async (fnName, params) => {
                    if (fnName === 'get_distinct_viewers') {
                        return { 
                            data: [
                                { user_identifier: 'user1@sim.com' },
                                { user_identifier: 'user2@sim.com' },
                                { user_identifier: 'test@sim.com' },
                                { user_identifier: 'rahma@example.com' },
                                { user_identifier: 'admin@example.com' }
                            ], 
                            error: null 
                        };
                    }
                    return { data: null, error: { message: 'RPC not found' } };
                }
            })
        };

        // Simulated Auth
        const Auth = {
            isAuthenticated: () => true,
            getCurrentUser: () => ({ id: 'rahma@example.com', fullName: 'رحمة عبدالله', role: 'admin' }),
            logout: () => {
                Swal.fire({
                    icon: 'success',
                    title: 'Logged out!',
                    text: 'You have been logged out successfully.',
                    showConfirmButton: false,
                    timer: 2000
                }).then(() => {
                    console.log('User logged out, redirecting to login page');
                    window.location.href = '/login.html';
                });
            },
            protectPage: () => { 
                if (!Auth.isAuthenticated()) { 
                    alert('Not Authorized'); 
                    window.location.href = '/login.html'; 
                    throw 'Stop Execution'; 
                } 
            }
        };

        // Simulated KB Data
        const kbSystemData = {
            meta: { version: '0.1.2', lastGlobalUpdate: '2023-11-28T12:00:00Z' },
            sections: [
                { id: 'support', name: 'Support', icon: 'fas fa-headset', themeColor: 'blue', description: 'Support resources.', articles: [] },
                { id: 'partner_care', name: 'Partner Care', icon: 'fas fa-handshake', themeColor: 'teal', description: 'Partner support.', articles: [] },
                { id: 'logistics', name: 'Logistics', icon: 'fas fa-truck', themeColor: 'green', description: 'Logistics resources.', articles: [], cases: [] },
                { id: 'customer_care', name: 'Customer Care', icon: 'fas fa-users', themeColor: 'indigo', description: 'Customer support.', articles: [] },
                { id: 'dist_follow_up', name: 'Distribution & Follow-up', icon: 'fas fa-people-carry', themeColor: 'cyan', description: 'Follow-up resources.', articles: [], cases: [] },
                { id: 'logistics_driver', name: 'Logistics (Driver Complaints)', icon: 'fas fa-shipping-fast', themeColor: 'lime', description: 'Driver issues.', articles: [], cases: [] },
                { id: 'logistics_3pl', name: 'Logistics-3PL', icon: 'fas fa-boxes', themeColor: 'yellow', description: 'Third-party logistics.', articles: [] },
                { id: 'order_at_store', name: 'Order at Store (Mac)', icon: 'fas fa-store', themeColor: 'pink', description: 'Store orders.', articles: [], cases: [] },
                { id: 'logistics_admin', name: 'Logistics-Admin', icon: 'fas fa-user-shield', themeColor: 'red', description: 'Admin logistics.', articles: [], cases: [] },
                { id: 'os', name: 'Operating Systems', icon: 'fab fa-windows', themeColor: 'sky', description: 'OS support.', articles: [] },
                { id: 'compensation', name: 'Compensation Policies', icon: 'fas fa-hand-holding-usd', themeColor: 'amber', description: 'Compensation info.', articles: [], cases: [], items: [] },
                { id: 'op_instructions', name: 'Operational Instructions', icon: 'fas fa-clipboard-list', themeColor: 'slate', description: 'Instructions.', articles: [] },
                { id: 'forms_templates', name: 'Forms/Templates', icon: 'fas fa-file-alt', themeColor: 'purple', description: 'Forms and templates.', articles: [], cases: [], items: [] }
            ]
        };

        let contentEditorQuill;
        let usersChartInstance, casesChartInstance;
        const TABLES = { CASES: 'cases', VIEWS_LOG: 'views_log' };
        let currentSectionId = 'home';

        // DOM Elements
        const sidebar = document.getElementById('sidebar');
        const mobileSidebarToggle = document.getElementById('mobileSidebarToggle');
        const contentWrapper = document.getElementById('contentWrapper');
        const pageContentArea = document.getElementById('pageContentArea');
        const dashboardOverviewContainer = document.getElementById('dashboardOverviewContainer');
        const standardSectionContentPlaceholder = document.getElementById('standardSectionContentPlaceholder');
        const currentSectionTitle = document.getElementById('currentSectionTitle');
        const breadcrumbs = document.getElementById('breadcrumbs');
        const userNameDisplayHeader = document.getElementById('userNameDisplayHeader');
        const userAvatar = document.getElementById('userAvatar');
        const welcomeUserNameDashboard = document.getElementById('welcomeUserNameDashboard');
        const kbVersionDashboard = document.getElementById('kbVersionDashboard');
        const lastKbUpdateDashboard = document.getElementById('lastKbUpdateDashboard');
        const footerKbVersion = document.getElementById('footerKbVersion');
        const recentUpdatesList = document.getElementById('recentUpdatesList');
        const htmlElement = document.documentElement;

        Auth.protectPage();
        const currentUser = Auth.getCurrentUser();

        if (currentUser) {
            const displayName = currentUser.fullName || currentUser.email || 'User';
            userNameDisplayHeader.textContent = displayName;
            welcomeUserNameDashboard.textContent = `Welcome, ${displayName}!`;
            userAvatar.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&size=36&background=4f46e5&color=fff&rounded=true`;
        }
        if (kbSystemData.meta) {
            kbVersionDashboard.textContent = kbSystemData.meta.version;
            lastKbUpdateDashboard.textContent = new Date(kbSystemData.meta.lastGlobalUpdate).toLocaleDateString('en-EG', { timeZone: 'Africa/Cairo' });
            footerKbVersion.textContent = kbSystemData.meta.version;
        }

        const themeSwitcher = document.getElementById('themeSwitcher');
        const themeIcon = document.getElementById('themeIcon');
        const themeText = document.getElementById('themeText');

        function applyTheme(theme) {
            if (theme === 'dark') {
                htmlElement.classList.add('dark');
                themeIcon.classList.replace('fa-moon', 'fa-sun');
                themeText.textContent = 'Light Mode';
            } else {
                htmlElement.classList.remove('dark');
                themeIcon.classList.replace('fa-sun', 'fa-moon');
                themeText.textContent = 'Dark Mode';
            }
            [usersChartInstance, casesChartInstance].forEach(chart => {
                if (chart) {
                    const isDark = htmlElement.classList.contains('dark');
                    chart.options.plugins.legend.labels.color = isDark ? '#e2e8f0' : '#1a202c';
                    if (chart.options.scales && chart.options.scales.y) {
                        chart.options.scales.y.ticks.color = isDark ? '#94a3b8' : '#4a5568';
                        chart.options.scales.y.grid.color = isDark ? '#374151' : '#e5e7eb';
                        chart.options.scales.x.ticks.color = isDark ? '#94a3b8' : '#4a5568';
                        chart.options.scales.x.grid.color = isDark ? '#374151' : '#e5e7eb';
                    }
                    chart.update();
                }
            });
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            applyTheme(savedTheme);
        }

        themeSwitcher.addEventListener('click', () => {
            const newTheme = htmlElement.classList.contains('dark') ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        });

        loadTheme();

        mobileSidebarToggle.addEventListener('click', () => sidebar.classList.toggle('open'));
        sidebar.querySelectorAll('.sidebar-link').forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth < 768) sidebar.classList.remove('open');
            });
        });

        document.getElementById('logoutButton').addEventListener('click', () => Auth.logout());
        document.getElementById('reportErrorBtn').addEventListener('click', () => Swal.fire({
            icon: 'info',
            title: 'Report an Issue',
            text: 'Please contact support to report an issue.',
            showConfirmButton: true
        }));

        const addContentModalOverlay = document.getElementById('addContentModalOverlay');
        const closeAddContentModalBtn = document.getElementById('closeAddContentModalBtn');
        const addContentForm = document.getElementById('addContentForm');
        const cancelAddContentBtn = document.getElementById('cancelAddContentBtn');
        const contentTypeSelect = document.getElementById('contentType');
        const contentUrlContainer = document.getElementById('contentUrlContainer');
        const resolutionStepsContainer = document.getElementById('resolutionStepsContainer');
        const loadContentBtn = document.getElementById('loadContentBtn');
        const contentDisplay = document.getElementById('contentDisplay');

        function loadContent() {
            const urlInput = document.querySelector('input[name="url"]');
            if (urlInput && contentDisplay) {
                const url = urlInput.value.trim();
                if (url) {
                    contentDisplay.innerHTML = '<p class="text-gray-500">Loading...</p>';
                    fetch(url)
                        .then(response => {
                            if (!response.ok) throw new Error('Network response was not ok');
                            return response.text();
                        })
                        .then(html => {
                            contentDisplay.innerHTML = `<div class="preview-content">${html}</div>`;
                        })
                        .catch(error => {
                            contentDisplay.innerHTML = `<p class="text-red-500">Error loading content: ${error.message}</p>`;
                        });
                } else {
                    contentDisplay.innerHTML = '<p class="text-red-500">Please enter a valid URL.</p>';
                }
            }
        }

        loadContentBtn.addEventListener('click', loadContent);

        const quillToolbarOptions = [
            ['bold', 'italic', 'underline', 'strike'],
            ['blockquote', 'code-block'],
            [{ 'header': 1 }, { 'header': 2 }, { 'header': [3, 4, 5, 6, false] }],
            [{ 'list': 'ordered' }, { 'list': 'bullet' }],
            [{ 'script': 'sub' }, { 'script': 'super' }],
            [{ 'indent': '-1' }, { 'indent': '+1' }],
            [{ 'direction': 'rtl' }],
            [{ 'size': ['small', false, 'large', 'huge'] }],
            [{ 'color': [] }, { 'background': [] }],
            [{ 'font': [] }],
            [{ 'align': [] }],
            ['link', 'image', 'video'],
            ['clean']
        ];

        function openAddContentModal(sectionId, preselectedType = null) {
            currentSectionId = sectionId;
            addContentModalOverlay.classList.remove('hidden');
            addContentModalOverlay.setAttribute('aria-hidden', 'false');
            if (!contentEditorQuill) {
                contentEditorQuill = new Quill('#quillEditor', {
                    theme: 'snow',
                    modules: { toolbar: quillToolbarOptions },
                    placeholder: 'Detailed content or resolution steps...'
                });
            }
            addContentForm.reset();
            contentEditorQuill.setText('');
            contentDisplay.innerHTML = '';

            let targetType = preselectedType;
            const validTypes = Array.from(contentTypeSelect.options).map(opt => opt.value);

            if (preselectedType && !validTypes.includes(preselectedType)) {
                console.warn(`Content type "${preselectedType}" is not a valid option. Defaulting to 'case'.`);
                targetType = 'case';
            } else if (!preselectedType) {
                targetType = 'case';
            }
            contentTypeSelect.value = targetType;

            const event = new Event('change', { bubbles: true });
            contentTypeSelect.dispatchEvent(event);

            document.getElementById('contentTitle').focus();
        }
        window.openAddContentModal = openAddContentModal;

        function closeAddContentModal() {
            addContentModalOverlay.classList.add('hidden');
            addContentModalOverlay.setAttribute('aria-hidden', 'true');
        }

        contentTypeSelect.addEventListener('change', () => {
            const type = contentTypeSelect.value;
            if (type === 'case') {
                contentUrlContainer.classList.add('hidden');
                document.getElementById('contentUrl').required = false;
                resolutionStepsContainer.classList.remove('hidden');
            } else {
                contentUrlContainer.classList.remove('hidden');
                document.getElementById('contentUrl').required = true;
                resolutionStepsContainer.classList.add('hidden');
            }
        });

        closeAddContentModalBtn.addEventListener('click', closeAddContentModal);
        cancelAddContentBtn.addEventListener('click', closeAddContentModal);
        addContentForm.addEventListener('submit', async e => {
            e.preventDefault();
            await saveContentToSupabase();
        });

        async function saveContentToSupabase() {
            const type = contentTypeSelect.value;
            const title = document.getElementById('contentTitle').value.trim();
            const summary = document.getElementById('contentSummary').value.trim();
            let contentData = { title, summary, type };

            if (type === 'case') {
                contentData.resolution_steps = contentEditorQuill.root.innerHTML;
                contentData.status = 'New';
            } else {
                contentData.url = document.getElementById('contentUrl').value.trim();
                if (!contentData.url) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'URL is required for this content type.'
                    });
                    return;
                }
            }

            const user = Auth.getCurrentUser();
            contentData.created_by_email = user.id;
            contentData.created_by_name = user.fullName;
            contentData.section_id = currentSectionId;

            const section = kbSystemData.sections.find(s => s.id === currentSectionId);
            if (!section) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: `Section with ID ${currentSectionId} not found.`
                });
                return;
            }

            if (type === 'case') {
                const { data, error } = await supabase.from(TABLES.CASES).insert([contentData]).select();
                if (error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: `Error saving case: ${error.message}`
                    });
                    return;
                }
                if (!section.cases) section.cases = [];
                section.cases.push({ ...data[0], id: data[0].id.toString() });
                logUserView(data[0].id, 'case_created');
            } else {
                if (!section.items) section.items = [];
                const newId = `${type}_${Date.now()}`;
                const newItem = { ...contentData, id: newId };
                section.items.push(newItem);
                logUserView(newId, `${type}_added`);
            }

            Swal.fire({
                icon: 'success',
                title: 'Success',
                text: 'Content saved successfully!',
                timer: 1500,
                showConfirmButton: false
            });
            closeAddContentModal();
            displaySectionContent(currentSectionId);
        }

        async function initCharts(viewData = []) {
            const isDark = htmlElement.classList.contains('dark');
            const legendColor = isDark ? '#e2e8f0' : '#1a202c';
            const ticksColor = isDark ? '#94a3b8' : '#4a5568';
            const gridColor = isDark ? '#374151' : '#e5e7eb';

            const chartOptions = (type) => ({
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { labels: { color: legendColor } } },
                scales: type === 'bar' ? {
                    y: { ticks: { color: ticksColor, beginAtZero: true }, grid: { color: gridColor } },
                    x: { ticks: { color: ticksColor }, grid: { color: gridColor } }
                } : {}
            });

            const userCounts = viewData.reduce((acc, view) => {
                acc[view.user_identifier] = (acc[view.user_identifier] || 0) + 1;
                return acc;
            }, {});

            if (usersChartInstance) usersChartInstance.destroy();
            const usersCtx = document.getElementById('usersChart')?.getContext('2d');
            if (usersCtx) {
                usersChartInstance = new Chart(usersCtx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(userCounts),
                        datasets: [{ label: 'User Views', data: Object.values(userCounts), backgroundColor: 'rgba(59, 130, 246, 0.7)' }]
                    },
                    options: chartOptions('bar')
                });
            }

            if (casesChartInstance) casesChartInstance.destroy();
            const casesCtx = document.getElementById('casesChart')?.getContext('2d');
            if (casesCtx) {
                const caseViews = viewData.filter(v => v.item_type === 'case_created' || v.item_type === 'case_viewed').reduce((acc, view) => {
                    const caseTitle = kbSystemData.sections.flatMap(s => s.cases || []).find(c => c.id === view.item_id)?.title || view.item_id;
                    acc[caseTitle] = (acc[caseTitle] || 0) + 1;
                    return acc;
                }, {});
                casesChartInstance = new Chart(casesCtx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(caseViews),
                        datasets: [{ data: Object.values(caseViews), backgroundColor: ['#10b981', '#f59e0b', '#ef4444', '#3b82f6', '#8b5cf6'] }]
                    },
                    options: chartOptions('pie')
                });
            }

            const sortedViewData = viewData.sort((a, b) => new Date(b.viewed_at) - new Date(a.viewed_at));
            recentUpdatesList.innerHTML = sortedViewData.slice(0, 5).map(v => {
                const timeFormatted = new Date(v.viewed_at).toLocaleString('en-EG', {
                    timeZone: 'Africa/Cairo',
                    hour12: true,
                    hour: 'numeric',
                    minute: '2-digit',
                    day: 'numeric',
                    month: 'short',
                    year: 'numeric'
                });

                let typeDesc = '';
                let itemTitle = v.item_id;

                if (v.item_type === 'case_created') {
                    typeDesc = 'Created a new case';
                    const createdCase = kbSystemData.sections.flatMap(s => s.cases || []).find(c => c.id.toString() === v.item_id.toString());
                    if (createdCase) itemTitle = `"${createdCase.title}"`; else itemTitle = `(${v.item_id})`;
                } else if (v.item_type === 'article_view') {
                    typeDesc = 'Viewed article';
                    const viewedArticle = kbSystemData.sections.flatMap(s => s.articles || []).find(a => a.id === v.item_id);
                    if (viewedArticle) itemTitle = `"${viewedArticle.title}"`; else itemTitle = `(${v.item_id})`;
                } else if (v.item_type.endsWith('_added')) {
                    typeDesc = `Added ${v.item_type.split('_')[0]}`;
                    const addedItem = kbSystemData.sections.flatMap(s => s.items || []).find(i => i.id === v.item_id);
                    if (addedItem) itemTitle = `"${addedItem.title}"`; else itemTitle = `(${v.item_id})`;
                } else if (v.item_type === 'navigation') {
                    typeDesc = 'Navigated to section';
                    const section = kbSystemData.sections.find(s => s.id === v.item_id);
                    itemTitle = section ? section.name : v.item_id;
                } else {
                    typeDesc = `Interacted with`;
                }

                return `
                <li class="py-2 border-b border-gray-200 dark:border-gray-700 last:border-b-0">
                    <div>
                        <span class="font-semibold text-indigo-600 dark:text-indigo-400">${escapeHTML(v.user_identifier)}</span>
                        <span class="text-sm text-gray-600 dark:text-gray-400"> ${escapeHTML(typeDesc)} ${escapeHTML(itemTitle)}</span>
                    </div>
                    <span class="text-xs text-gray-500 dark:text-gray-500 block mt-0.5">${escapeHTML(timeFormatted)}</span>
                </li>`;
            }).join('');
        }

        const filterUserSelect = document.getElementById('filterUser');
        async function populateUserFilter() {
            const { data, error } = await supabase.rpc('get_distinct_viewers');
            if (error) {
                console.error('Error fetching distinct viewers:', error);
                return;
            }
            if (data && filterUserSelect) {
                filterUserSelect.innerHTML = '<option value="">All Users</option>';
                data.forEach(u => {
                    if (u.user_identifier) filterUserSelect.add(new Option(u.user_identifier, u.user_identifier));
                });
            }
        }

        document.getElementById('applyFilterBtn').addEventListener('click', async () => {
            const date = document.getElementById('filterDate').value;
            const user = filterUserSelect.value;
            const interaction = document.getElementById('filterInteraction').value;
            let query = supabase.from(TABLES.VIEWS_LOG).select('*');
            if (date) query = query.gte('viewed_at', `${date}T00:00:00Z`).lte('viewed_at', `${date}T23:59:59Z`);
            if (user) query = query.eq('user_identifier', user);
            if (interaction) query = query.eq('item_type', interaction);
            const { data: filteredData, error } = await query;
            if (error) console.error('Error fetching filtered data:', error);
            else initCharts(filteredData || []);
        });

        function escapeHTML(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/[&<>"']/g, m => ({ '&': '&', '<': '<', '>': '>', '"': '"', "'": ''' })[m]);
        }

        function highlightText(text, query) {
            if (!text) return '';
            const safeText = escapeHTML(text);
            if (!query) return safeText;
            try {
                const rgx = new RegExp(`(${query.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')})`, 'gi');
                return safeText.replace(rgx, '<mark>$1</mark>');
            } catch (e) {
                return safeText;
            }
        }

        function truncateText(text, len) {
            if (!text || text.length <= len) return text;
            return text.substring(0, len) + '...';
        }

        function stripHtml(html) {
            const tmp = document.createElement('DIV');
            tmp.innerHTML = html;
            return tmp.textContent || tmp.innerText || '';
        }

        function getThemeColors(themeColorInput = 'gray') {
            const colorMap = {
                blue: { bg: 'bg-blue-100 dark:bg-blue-900', text: 'text-blue-600 dark:text-blue-400', iconContainer: 'bg-blue-100 dark:bg-blue-800/50', icon: 'text-blue-500 dark:text-blue-400', cta: 'text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300', border: 'border-blue-500', tagBg: 'bg-blue-100 dark:bg-blue-500/20', tagText: 'text-blue-700 dark:text-blue-300', statusBg: 'bg-blue-100 dark:bg-blue-500/20', statusText: 'text-blue-700 dark:text-blue-400', addBtn: 'bg-blue-500 hover:bg-blue-600' },
                teal: { bg: 'bg-teal-100 dark:bg-teal-900', text: 'text-teal-600 dark:text-teal-400', iconContainer: 'bg-teal-100 dark:bg-teal-800/50', icon: 'text-teal-500 dark:text-teal-400', cta: 'text-teal-600 hover:text-teal-700 dark:text-teal-400 dark:hover:text-teal-300', border: 'border-teal-500', tagBg: 'bg-teal-100 dark:bg-teal-500/20', tagText: 'text-teal-700 dark:text-teal-300', statusBg: 'bg-teal-100 dark:bg-teal-500/20', statusText: 'text-teal-700 dark:text-teal-400', addBtn: 'bg-teal-500 hover:bg-teal-600' },
                green: { bg: 'bg-green-100 dark:bg-green-900', text: 'text-green-600 dark:text-green-400', iconContainer: 'bg-green-100 dark:bg-green-800/50', icon: 'text-green-500 dark:text-green-400', cta: 'text-green-600 hover:text-green-700 dark:text-green-400 dark:hover:text-green-300', border: 'border-green-500', tagBg: 'bg-green-100 dark:bg-green-500/20', tagText: 'text-green-700 dark:text-green-300', statusBg: 'bg-green-100 dark:bg-green-500/20', statusText: 'text-green-700 dark:text-green-400', addBtn: 'bg-green-500 hover:bg-green-600' },
                indigo: { bg: 'bg-indigo-100 dark:bg-indigo-900', text: 'text-indigo-600 dark:text-indigo-400', iconContainer: 'bg-indigo-100 dark:bg-indigo-800/50', icon: 'text-indigo-500 dark:text-indigo-400', cta: 'text-indigo-600 hover:text-indigo-700 dark:text-indigo-400 dark:hover:text-indigo-300', border: 'border-indigo-500', tagBg: 'bg-indigo-100 dark:bg-indigo-500/20', tagText: 'text-indigo-700 dark:text-indigo-300', statusBg: 'bg-indigo-100 dark:bg-indigo-500/20', statusText: 'text-indigo-700 dark:text-indigo-400', addBtn: 'bg-indigo-500 hover:bg-indigo-600' },
                cyan: { bg: 'bg-cyan-100 dark:bg-cyan-900', text: 'text-cyan-600 dark:text-cyan-400', iconContainer: 'bg-cyan-100 dark:bg-cyan-800/50', icon: 'text-cyan-500 dark:text-cyan-400', cta: 'text-cyan-600 hover:text-cyan-700 dark:text-cyan-400 dark:hover:text-cyan-300', border: 'border-cyan-500', tagBg: 'bg-cyan-100 dark:bg-cyan-500/20', tagText: 'text-cyan-700 dark:text-cyan-300', statusBg: 'bg-cyan-100 dark:bg-cyan-500/20', statusText: 'text-cyan-700 dark:text-cyan-400', addBtn: 'bg-cyan-500 hover:bg-cyan-600' },
                lime: { bg: 'bg-lime-100 dark:bg-lime-900', text: 'text-lime-600 dark:text-lime-400', iconContainer: 'bg-lime-100 dark:bg-lime-800/50', icon: 'text-lime-500 dark:text-lime-400', cta: 'text-lime-600 hover:text-lime-700 dark:text-lime-400 dark:hover:text-lime-300', border: 'border-lime-500', tagBg: 'bg-lime-100 dark:bg-lime-500/20', tagText: 'text-lime-700 dark:text-lime-300', statusBg: 'bg-lime-100 dark:bg-lime-500/20', statusText: 'text-lime-700 dark:text-lime-400', addBtn: 'bg-lime-500 hover:bg-lime-600' },
                yellow: { bg: 'bg-yellow-100 dark:bg-yellow-900', text: 'text-yellow-600 dark:text-yellow-400', iconContainer: 'bg-yellow-100 dark:bg-yellow-800/50', icon: 'text-yellow-500 dark:text-yellow-400', cta: 'text-yellow-600 hover:text-yellow-700 dark:text-yellow-400 dark:hover:text-yellow-300', border: 'border-yellow-500', tagBg: 'bg-yellow-100 dark:bg-yellow-500/20', tagText: 'text-yellow-700 dark:text-yellow-300', statusBg: 'bg-yellow-100 dark:bg-yellow-500/20', statusText: 'text-yellow-700 dark:text-yellow-400', addBtn: 'bg-yellow-500 hover:bg-yellow-600' },
                pink: { bg: 'bg-pink-100 dark:bg-pink-900', text: 'text-pink-600 dark:text-pink-400', iconContainer: 'bg-pink-100 dark:bg-pink-800/50', icon: 'text-pink-500 dark:text-pink-400', cta: 'text-pink-600 hover:text-pink-700 dark:text-pink-400 dark:hover:text-pink-300', border: 'border-pink-500', tagBg: 'bg-pink-100 dark:bg-pink-500/20', tagText: 'text-pink-700 dark:text-pink-300', statusBg: 'bg-pink-100 dark:bg-pink-500/20', statusText: 'text-pink-700 dark:text-pink-400', addBtn: 'bg-pink-500 hover:bg-pink-600' },
                red: { bg: 'bg-red-100 dark:bg-red-900', text: 'text-red-600 dark:text-red-400', iconContainer: 'bg-red-100 dark:bg-red-800/50', icon: 'text-red-500 dark:text-red-400', cta: 'text-red-600 hobby:text-red-700 dark:text-red-400 dark:hover:text-red-300', border: 'border-red-500', tagBg: 'bg-red-100 dark:bg-red-500/20', tagText: 'text-red-700 dark:text-red-300', statusBg: 'bg-red-100 dark:bg-red-500/20', statusText: 'text-red-700 dark:text-red-400', addBtn: 'bg-red-500 hover:bg-red-600' },
                sky: { bg: 'bg-sky-100 dark:bg-sky-900', text: 'text-sky-600 dark:text-sky-400', iconContainer: 'bg-sky-100 dark:bg-sky-800/50', icon: 'text-sky-500 dark:text-sky-400', cta: 'text-sky-600 hover:text-sky-700 dark:text-sky-400 dark:hover:text-sky-300', border: 'border-sky-500', tagBg: 'bg-sky-100 dark:bg-sky-500/20', tagText: 'text-sky-700 dark:text-sky-300', statusBg: 'bg-sky-100 dark:bg-sky-500/20', statusText: 'text-sky-700 dark:text-sky-400', addBtn: 'bg-sky-500 hover:bg-sky-600' },
                amber: { bg: 'bg-amber-100 dark:bg-amber-900', text: 'text-amber-600 dark:text-amber-400', iconContainer: 'bg-amber-100 dark:bg-amber-800/50', icon: 'text-amber-500 dark:text-amber-400', cta: 'text-amber-600 hover:text-amber-700 dark:text-amber-400 dark:hover:text-amber-300', border: 'border-amber-500', tagBg: 'bg-amber-100 dark:bg-amber-500/20', tagText: 'text-amber-700 dark:text-amber-300', statusBg: 'bg-amber-100 dark:bg-amber-500/20', statusText: 'text-amber-700 dark:text-amber-400', addBtn: 'bg-amber-500 hover:bg-amber-600' },
                slate: { bg: 'bg-slate-100 dark:bg-slate-900', text: 'text-slate-600 dark:text-slate-400', iconContainer: 'bg-slate-100 dark:bg-slate-800/50', icon: 'text-slate-500 dark:text-slate-400', cta: 'text-slate-600 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-300', border: 'border-slate-500', tagBg: 'bg-slate-100 dark:bg-slate-500/20', tagText: 'text-slate-700 dark:text-slate-300', statusBg: 'bg-slate-100 dark:bg-slate-500/20', statusText: 'text-slate-700 dark:text-slate-400', addBtn: 'bg-slate-500 hover:bg-slate-600' },
                purple: { bg: 'bg-purple-100 dark:bg-purple-900', text: 'text-purple-600 dark:text-purple-400', iconContainer: 'bg-purple-100 dark:bg-purple-800/50', icon: 'text-purple-500 dark:text-purple-400', cta: 'text-purple-600 hover:text-purple-700 dark:text-purple-400 dark:hover:text-purple-300', border: 'border-purple-500', tagBg: 'bg-purple-100 dark:bg-purple-500/20', tagText: 'text-purple-700 dark:text-purple-300', statusBg: 'bg-purple-100 dark:bg-purple-500/20', statusText: 'text-purple-700 dark:text-purple-400', addBtn: 'bg-purple-500 hover:bg-purple-600' },
                gray: { bg: 'bg-gray-100 dark:bg-gray-800', text: 'text-gray-600 dark:text-gray-400', iconContainer: 'bg-gray-100 dark:bg-gray-700', icon: 'text-gray-500 dark:text-gray-400', cta: 'text-indigo-600 hover:text-indigo-700 dark:text-indigo-400 dark:hover:text-indigo-300', border: 'border-gray-500', tagBg: 'bg-gray-200 dark:bg-gray-700', tagText: 'text-gray-700 dark:text-gray-300', statusBg: 'bg-gray-200 dark:bg-gray-600', statusText: 'text-gray-700 dark:text-gray-300', addBtn: 'bg-indigo-500 hover:bg-indigo-600' }
            };
            const effectiveThemeColor = (typeof themeColorInput === 'string' ? themeColorInput.toLowerCase() : 'gray');
            const selectedTheme = colorMap[effectiveThemeColor] || colorMap.gray;
            if (!selectedTheme.addBtn) selectedTheme.addBtn = colorMap.indigo.addBtn;
            return selectedTheme;
        }

        function renderArticleCard(article, sectionData) {
            const theme = getThemeColors(sectionData.themeColor);
            const cardIconClass = sectionData.icon || 'fas fa-file-alt';
            return `
                <div class="card border-t-4 ${theme.border}" data-item-id="${article.id}" data-item-type="article">
                    <div class="flex items-center mb-3">
                        <div class="p-3 rounded-full ${theme.iconContainer} mr-4"><i class="${cardIconClass} text-xl ${theme.icon}"></i></div>
                        <h3 class="font-semibold text-lg leading-tight">${escapeHTML(article.title)}</h3>
                    </div>
                    <p class="text-sm mb-4 flex-grow text-gray-600 dark:text-gray-400">${escapeHTML(article.summary || 'No summary.')}</p>
                    ${article.tags && article.tags.length ? `<div class="mb-4">${article.tags.map(tag => `<span class="text-xs ${theme.tagBg} ${theme.tagText} px-2 py-1 rounded-full mr-1 mb-1 font-medium">${escapeHTML(tag)}</span>`).join('')}</div>` : ''}
                    <div class="mt-auto flex justify-between items-center pt-3 border-t border-gray-200 dark:border-gray-700">
                        <div></div>
                        <a href="${escapeHTML(article.contentPath) || '#'}" target="_blank" class="text-sm font-medium ${theme.cta}">Read More <i class="fas fa-arrow-right ml-1 text-xs"></i></a>
                    </div>
                </div>`;
        }

        function renderCaseCard(caseItem, sectionData) {
            const theme = getThemeColors(sectionData.themeColor);
            return `
                <div class="card border-t-4 ${theme.border}" data-item-id="${caseItem.id}" data-item-type="case">
                    <div class="flex items-center mb-3">
                        <div class="p-3 rounded-full ${theme.iconContainer} mr-4"><i class="fas fa-briefcase text-xl ${theme.icon}"></i></div>
                        <h3 class="font-semibold text-lg leading-tight">${escapeHTML(caseItem.title)}</h3>
                    </div>
                    <p class="text-sm mb-2 flex-grow text-gray-600 dark:text-gray-400">${escapeHTML(caseItem.summary || 'No summary.')}</p>
                    ${caseItem.resolution_steps ? `<p class="text-xs italic mb-3 text-gray-500 dark:text-gray-500">Preview: ${escapeHTML(truncateText(stripHtml(caseItem.resolution_steps), 100))}</p>` : ''}
                    <div class="mt-auto flex justify-between items-center pt-3 border-t border-gray-200 dark:border-gray-700">
                        <span class="text-sm font-medium px-3 py-1 rounded-full ${theme.statusBg} ${theme.statusText}">${escapeHTML(caseItem.status)}</span>
                        <a href="#${sectionData.id}/${caseItem.id}" class="text-sm font-medium ${theme.cta}">Details <i class="fas fa-arrow-right ml-1 text-xs"></i></a>
                    </div>
                </div>`;
        }

        function renderItemCard(item, sectionData) {
            const theme = getThemeColors(sectionData.themeColor);
            return `
                <div class="card border-t-4 ${theme.border}" data-item-id="${item.id}" data-item-type="item">
                    <div class="flex items-center mb-3">
                        <div class="p-3 rounded-full ${theme.iconContainer} mr-4"><i class="${sectionData.icon || 'fas fa-archive'} text-xl ${theme.icon}"></i></div>
                        <h3 class="font-semibold text-lg leading-tight">${escapeHTML(item.title)}</h3>
                    </div>
                    <p class="text-sm mb-4 flex-grow text-gray-600 dark:text-gray-400">${escapeHTML(item.summary || 'No description.')}</p>
                    <div class="mt-auto flex justify-between items-center pt-3 border-t border-gray-200 dark:border-gray-700">
                        <span class="text-xs ${theme.tagBg} ${theme.tagText} px-3 py-2 rounded-full uppercase font-semibold">${escapeHTML(item.type)}</span>
                        <a href="${escapeHTML(item.url)}" target="_blank" class="text-sm font-medium ${theme.cta}">Open <i class="fas fa-external-link-alt ml-1 text-xs"></i></a>
                    </div>
                </div>`;
        }

        function checkUserRoleAccess(sectionId) {
            const user = Auth.getCurrentUser();
            const sectionExists = kbSystemData.sections.some(s => s.id === sectionId);

            if (sectionId === 'home') return true;

            if (!sectionExists && sectionId !== 'home') {
                console.warn(`Access check for unknown section: ${sectionId}. Denying access.`);
                return false;
            }

            if (user.role === 'super_admin') return true;

            if (user.role === 'admin') {
                if (sectionId === 'logistics_admin') return false;
                return true;
            }

            if (user.role === 'viewer') {
                return ['support', 'partner_care', 'customer_care'].includes(sectionId);
            }

            return false;
        }

        async function displaySectionContent(sectionId, itemIdToFocus = null, subCategoryFilter = null) {
            currentSectionId = sectionId;

            if (!checkUserRoleAccess(sectionId)) {
                standardSectionContentPlaceholder.innerHTML = `<div class="p-6 text-center"><h2 class="text-xl font-semibold text-red-600 dark:text-red-500">Access Denied</h2><p>You do not have permission to view this section.</p></div>`;
                dashboardOverviewContainer.classList.add('hidden');
                standardSectionContentPlaceholder.classList.remove('hidden');
                currentSectionTitle.textContent = 'Access Denied';
                breadcrumbs.innerHTML = `<span class="font-medium">Access Denied</span>`;
                return;
            }

            dashboardOverviewContainer.classList.add('hidden');
            standardSectionContentPlaceholder.classList.remove('hidden');
            standardSectionContentPlaceholder.innerHTML = '';

            if (sectionId === 'home') {
                dashboardOverviewContainer.classList.remove('hidden');
                standardSectionContentPlaceholder.classList.add('hidden');
                currentSectionTitle.textContent = 'Dashboard Overview';
                breadcrumbs.innerHTML = `<span class="font-medium">Home</span>`;
                const { data: viewData } = await supabase.from(TABLES.VIEWS_LOG).select('*');
                initCharts(viewData || []);
                populateUserFilter();
                return;
            }

            const sectionData = kbSystemData.sections.find(s => s.id === sectionId);
            if (!sectionData) {
                standardSectionContentPlaceholder.innerHTML = `<div class="p-6 text-center"><h2 class="text-xl font-semibold">Section Not Found: ${escapeHTML(sectionId)}</h2></div>`;
                currentSectionTitle.textContent = 'Not Found';
                breadcrumbs.innerHTML = `<span class="font-medium">Not Found</span>`;
                return;
            }

            currentSectionTitle.textContent = sectionData.name;
            let bcHTML = `<a href="#home" class="hover:underline">Home</a> <span class="mx-1">></span> <span class="font-medium">${escapeHTML(sectionData.name)}</span>`;
            if (itemIdToFocus) {
                const item = (sectionData.cases || []).concat(sectionData.items || []).find(i => i.id === itemIdToFocus);
                if (item) {
                    bcHTML += ` <span class="mx-1">></span> <span>${escapeHTML(item.title)}</span>`;
                }
            }
            breadcrumbs.innerHTML = bcHTML;

            const theme = getThemeColors(sectionData.themeColor);
            let sectionHTML = `
                <div class="card">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full ${theme.iconContainer} mr-4"><i class="${sectionData.icon || 'fas fa-folder'} text-xl ${theme.icon}"></i></div>
                            <div>
                                <h2 class="text-2xl font-bold">${escapeHTML(sectionData.name)}</h2>
                                <p class="text-sm text-gray-600 dark:text-gray-400">${escapeHTML(sectionData.description || 'No description available.')}</p>
                            </div>
                        </div>
                        ${currentUser.role !== 'viewer' ? `
                        <button onclick="openAddContentModal('${sectionData.id}')" class="px-4 py-2 ${theme.addBtn} text-white rounded-md">
                            <i class="fas fa-plus mr-2"></i> Add Content
                        </button>` : ''}
                    </div>
                </div>
            `;

            if (itemIdToFocus) {
                const item = (sectionData.cases || []).find(i => i.id === itemIdToFocus) || (sectionData.items || []).find(i => i.id === itemIdToFocus);
                if (item) {
                    if (item.type === 'case') {
                        sectionHTML += `
                            <div class="card">
                                <h3 class="text-xl font-semibold mb-3">${escapeHTML(item.title)}</h3>
                                <p class="text-sm mb-3 text-gray-600 dark:text-gray-400">${escapeHTML(item.summary)}</p>
                                <div class="prose dark:prose-invert mb-4">${item.resolution_steps}</div>
                                <div class="flex justify-between items-center pt-3 border-t border-gray-200 dark:border-gray-700">
                                    <span class="text-sm font-medium px-3 py-1 rounded-full ${theme.statusBg} ${theme.statusText}">${escapeHTML(item.status)}</span>
                                    <span class="text-xs text-gray-500 dark:text-gray-400">Created by ${escapeHTML(item.created_by_name || item.created_by_email)} on ${new Date(item.created_at || Date.now()).toLocaleDateString('en-EG', { timeZone: 'Africa/Cairo' })}</span>
                                </div>
                            </div>`;
                    } else {
                        sectionHTML += `
                            <div class="card">
                                <h3 class="text-xl font-semibold mb-3">${escapeHTML(item.title)}</h3>
                                <p class="text-sm mb-3 text-gray-600 dark:text-gray-400">${escapeHTML(item.summary)}</p>
                                <p class="text-sm mb-3"><strong>Type:</strong> ${escapeHTML(item.type)}</p>
                                <a href="${escapeHTML(item.url)}" target="_blank" class="text-sm font-medium ${theme.cta}">Open Resource <i class="fas fa-external-link-alt ml-1 text-xs"></i></a>
                            </div>`;
                    }
                    logUserView(itemIdToFocus, item.type === 'case' ? 'case_viewed' : 'item_viewed');
                } else {
                    sectionHTML += `<div class="card"><p class="text-red-600 dark:text-red-500">Item with ID ${escapeHTML(itemIdToFocus)} not found in section ${escapeHTML(sectionData.name)}.</p></div>`;
                }
            } else {
                const articles = sectionData.articles || [];
                const cases = sectionData.cases || [];
                const items = sectionData.items || [];

                if (articles.length === 0 && cases.length === 0 && items.length === 0) {
                    sectionHTML += `<div class="card text-center py-8"><p class="text-gray-600 dark:text-gray-400">No content available in this section yet.</p></div>`;
                } else {
                    if (articles.length > 0) {
                        sectionHTML += `
                            <div class="mb-8">
                                <h3 class="text-xl font-semibold mb-4">Articles</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    ${articles.map(article => renderArticleCard(article, sectionData)).join('')}
                                </div>
                            </div>`;
                    }
                    if (cases.length > 0) {
                        sectionHTML += `
                            <div class="mb-8">
                                <h3 class="text-xl font-semibold mb-4">Cases</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    ${cases.map(caseItem => renderCaseCard(caseItem, sectionData)).join('')}
                                </div>
                            </div>`;
                    }
                    if (items.length > 0) {
                        sectionHTML += `
                            <div class="mb-8">
                                <h3 class="text-xl font-semibold mb-4">Resources</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    ${items.map(item => renderItemCard(item, sectionData)).join('')}
                                </div>
                            </div>`;
                    }
                }
            }

            standardSectionContentPlaceholder.innerHTML = sectionHTML;
            logUserView(sectionId, 'navigation');
        }

        async function logUserView(itemId, itemType) {
            const user = Auth.getCurrentUser();
            const viewData = {
                item_id: itemId.toString(),
                item_type: itemType,
                user_identifier: user.id,
                viewed_at: new Date().toISOString()
            };
            const { error } = await supabase.from(TABLES.VIEWS_LOG).insert([viewData]);
            if (error) console.error('Error logging view:', error);
        }

        function handleNavigation() {
            const hash = window.location.hash.slice(1) || 'home';
            const [sectionId, itemId] = hash.split('/');

            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('data-section') === sectionId) {
                    link.classList.add('active');
                }
            });

            displaySectionContent(sectionId, itemId);
        }

        window.addEventListener('hashchange', handleNavigation);
        document.querySelectorAll('.sidebar-link').forEach(link => {
            link.addEventListener('click', () => {
                document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
                link.classList.add('active');
            });
        });

        const globalSearchInput = document.getElementById('globalSearchInput');
        const searchResults = document.getElementById('searchResults');

        globalSearchInput.addEventListener('input', async () => {
            const query = globalSearchInput.value.trim();
            if (query.length < 2) {
                searchResults.classList.add('hidden');
                searchResults.innerHTML = '';
                return;
            }

            const results = [];
            kbSystemData.sections.forEach(section => {
                if (!checkUserRoleAccess(section.id)) return;

                (section.articles || []).forEach(article => {
                    if (article.title.toLowerCase().includes(query.toLowerCase()) || (article.summary || '').toLowerCase().includes(query.toLowerCase())) {
                        results.push({ type: 'article', sectionId: section.id, sectionName: section.name, item: article });
                    }
                });

                (section.cases || []).forEach(caseItem => {
                    if (caseItem.title.toLowerCase().includes(query.toLowerCase()) || (caseItem.summary || '').toLowerCase().includes(query.toLowerCase())) {
                        results.push({ type: 'case', sectionId: section.id, sectionName: section.name, item: caseItem });
                    }
                });

                (section.items || []).forEach(item => {
                    if (item.title.toLowerCase().includes(query.toLowerCase()) || (item.summary || '').toLowerCase().includes(query.toLowerCase())) {
                        results.push({ type: 'item', sectionId: section.id, sectionName: section.name, item: item });
                    }
                });
            });

            if (results.length === 0) {
                searchResults.innerHTML = `<div class="p-4 text-center text-gray-600 dark:text-gray-400">No results found for "${escapeHTML(query)}".</div>`;
            } else {
                searchResults.innerHTML = results.map(result => {
                    const theme = getThemeColors(kbSystemData.sections.find(s => s.id === result.sectionId)?.themeColor || 'gray');
                    return `
                        <a href="#${result.sectionId}/${result.item.id}" class="block p-4 border-b border-gray-200 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-600">
                            <div class="flex items-center">
                                <i class="${result.type === 'case' ? 'fas fa-briefcase' : result.type === 'article' ? 'fas fa-file-alt' : 'fas fa-archive'} ${theme.icon} mr-3"></i>
                                <div>
                                    <div class="font-medium ${theme.text}">${highlightText(result.item.title, query)}</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">${highlightText(truncateText(result.item.summary || 'No summary.', 50), query)}</div>
                                    <div class="text-xs text-gray-500 dark:text-gray-500 mt-1">In ${escapeHTML(result.sectionName)}</div>
                                </div>
                            </div>
                        </a>`;
                }).join('');
            }
            searchResults.classList.remove('hidden');
        });

        globalSearchInput.addEventListener('blur', () => {
            setTimeout(() => searchResults.classList.add('hidden'), 200);
        });

        globalSearchInput.addEventListener('focus', () => {
            if (searchResults.innerHTML) searchResults.classList.remove('hidden');
        });

        globalSearchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && searchResults.children.length > 0) {
                const firstResult = searchResults.querySelector('a');
                if (firstResult) firstResult.click();
            }
        });

        handleNavigation();
    </script>
</body>
</html>
