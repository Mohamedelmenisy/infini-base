<!DOCTYPE html>
<html lang="en" dir="ltr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InfiniBase - Knowledge Base</title>
    <!-- Updated Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32' width='32' height='32'><rect width='32' height='32' rx='4' fill='%236366f1'/><text x='50%' y='55%' dominant-baseline='middle' text-anchor='middle' font-family='Arial, sans-serif' font-size='18' font-weight='bold' fill='white'>IB</text></svg>">
    
    <!-- CDNs -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>


    <style>
        :root {
            /* Permanent Dark Theme Variables */
            --primary-color: #6366f1; /* Brighter Indigo for dark */
            --primary-color-hover: #4f46e5;
            --secondary-color: #9ca3af;

            --text-color: #d1d5db;
            --text-color-muted: #9ca3af;
            --text-color-inverted: #ffffff; 
            --text-color-subtle: #9ca3af;

            --bg-color: #111827; /* Dark gray */
            --bg-color-alt: #1f2937; /* Slightly lighter dark gray for cards/modals */
            --bg-color-sidebar: #1f2937;
            --bg-color-header: rgba(31, 41, 55, 0.9);
            --bg-color-modal: #1f2937;
            --bg-color-hover: #374151;
            --bg-color-active: var(--primary-color);

            --border-color: #374151;
            --border-color-darker: #4b5563;

            --card-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            --card-hover-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            
            --border-radius: 0.5rem; 
            --border-radius-lg: 0.75rem;
            --header-height: 70px;
            --sidebar-width: 260px;

            --yes-color: #22c55e; /* Green for Yes */
            --no-color: #ef4444;   /* Red for No */
            --rating-color: #fbbf24; /* Amber 400 for ratings */
            --step-done-color: #22c55e;
            --step-pending-color: #f59e0b;
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            line-height: 1.6;
            font-size: 16px;
        }

        a { /* Apply to all links */
            text-decoration-skip-ink: none;
        }

        .container-fluid {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-color-sidebar);
            padding: 1.5rem;
            border-right: 1px solid var(--border-color); /* LTR */
            position: fixed;
            top: 0;
            left: 0; /* LTR */
            height: 100vh;
            overflow-y: auto;
            transition: transform 0.3s ease-in-out, background-color 0.3s ease, border-color 0.3s ease;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }
        .sidebar.closed {
            transform: translateX(-100%); /* LTR */
        }
        @media (min-width: 768px) {
            .sidebar.closed { transform: translateX(0); }
        }

        .sidebar-header {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            color: var(--text-color); 
        }
        .sidebar-header i { 
            margin-right: 0.75rem; /* LTR */
            color: var(--primary-color);
            font-size: 1.8rem;
        }
        .sidebar-logo-text {
             color: var(--text-color);
        }

        .sidebar-nav { flex-grow: 1; }

        .sidebar-section-title {
            padding-left: 0.75rem; /* LTR */
            font-size: 0.75rem;
            font-weight: 700; /* Increased font-weight for better visibility */
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--text-color-muted);
        }

        .sidebar-link {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-radius: var(--border-radius);
            transition: background-color 0.2s ease, color 0.2s ease;
            font-weight: 500;
            color: var(--text-color-subtle);
            text-decoration: none;
            margin-bottom: 0.25rem;
        }
        .sidebar-link i {
            margin-right: 0.75rem; /* LTR */
            width: 1.5rem; /* Adjusted for font-size */
            font-size: 1.5rem; /* Increased icon size */
            text-align: center;
            transition: color 0.2s ease;
        }
        .sidebar-link:hover {
            background-color: var(--bg-color-hover);
            color: var(--text-color);
        }
        .sidebar-link.active {
            background-color: var(--bg-color-active); /* Primary color */
            color: var(--text-color-inverted) !important; /* White text */
            font-weight: 600;
        }
        .sidebar-link.active i {
            color: var(--text-color-inverted) !important; /* White icon on primary background */
        }

        .sidebar-footer {
            margin-top: auto; 
            padding-top: 1rem;
        }
        .sidebar-footer button {
            width: 100%;
            margin-top: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sidebar-footer button i { margin-right: 0.5rem; }


        .content-wrapper {
            flex-grow: 1;
            padding-right: 1.5rem; /* LTR */
            padding-left: 1.5rem;
            transition: margin-left 0.3s ease-in-out; /* LTR */
            height: 100vh;
            overflow-y: auto;
        }
        @media (min-width: 768px) {
             .content-wrapper { margin-left: var(--sidebar-width); /* LTR */ }
             .sidebar.closed + .content-wrapper { margin-left: 0; /* LTR */ }
        }

        .content-header {
            background-color: var(--bg-color-header);
            padding: 1.25rem 2rem; 
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky; 
            top: 0;
            left: var(--sidebar-width); /* LTR, adjusted for fixed sidebar */
            right: 0;
            height: var(--header-height);
            z-index: 50;
            backdrop-filter: blur(8px); 
        }
         @media (max-width: 767px) { /* Mobile: header spans full width */
            .content-header {
                left: 0;
            }
        }
        .header-left-content { display: flex; align-items: center; } 
        #currentSectionTitle {
            font-size: 1.5rem; 
            font-weight: bold;
            margin: 0;
        }
        #breadcrumbs {
            font-size: 0.875rem; 
            color: var(--text-color-muted);
            margin-top: 0.25rem;
        }
        #breadcrumbs a { color: var(--primary-color); text-decoration: none; }
        #breadcrumbs a:hover { text-decoration: underline; }

        .header-right-content { display: flex; align-items: center; gap: 1rem; }
        .search-container { position: relative; }
        .search-container input[type="search"] {
            padding: 0.625rem 1rem 0.625rem 2.5rem; /* py-2.5 pl-10 pr-4 for LTR */
            border: 1px solid var(--border-color-darker);
            border-radius: 9999px; 
            min-width: 250px; 
            background-color: var(--bg-color-alt); 
            color: var(--text-color);
        }
        .search-container input[type="search"]::placeholder {
            color: var(--text-color-muted);
            opacity: 0.8;
        }
        .search-container .search-icon {
            position: absolute;
            inset-inline-start: 0.75rem; 
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-color-muted);
        }
        #searchResultsContainer {
            position: absolute;
            background-color: var(--bg-color-alt);
            border: 1px solid var(--border-color);
            border-top: none;
            width: 100%; 
            max-height: 300px; 
            overflow-y: auto;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); 
            z-index: 60; 
            border-radius: 0 0 var(--border-radius) var(--border-radius);
        }
        #searchResultsContainer a {
            display: block;
            padding: 0.75rem; 
            text-decoration: none;
            color: var(--text-color);
        }
        #searchResultsContainer a:hover { background-color: var(--bg-color-hover); }
        #searchResultsContainer mark { background-color: #78350f; color: #f3f4f6; }


        .user-profile { display: flex; align-items: center; gap: 0.5rem; }
        .user-profile img { width: 36px; height: 36px; border-radius: 50%; }
        #userNameDisplayHeader { font-weight: 500; }
        @media (max-width: 640px) { 
            #userNameDisplayHeader { display: none; }
        }

        main { padding: 1.5rem 0; }

        .card {
            background-color: var(--bg-color-alt);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg); 
            padding: 1.5rem;
            margin-bottom: 1.5rem; 
            box-shadow: var(--card-shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease, border-color 0.3s ease;
            display: flex;
            flex-direction: column; 
            min-height: 150px; 
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--card-hover-shadow);
        }
        .card-header-icon {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .card-icon-container {
            padding: 0.75rem;
            border-radius: 50%;
            margin-right: 1rem; /* LTR */
            background-color: var(--primary-color-hover); 
        }
        .card-icon-container i {
            font-size: 1.25rem;
            color: var(--text-color-inverted);  
        }
        .card h3 { margin-top: 0; font-size: 1.125rem; font-weight: 600; color: var(--text-color); line-height: 1.3; }
        .card p { margin-bottom: 1rem; font-size: 0.875rem; color: var(--text-color-subtle); flex-grow: 1; }
        .card .item-meta-info {
            margin-top: auto; 
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border-color);
        }
        .card .item-cta-link {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500; 
            font-size: 0.875rem;
        }
        .card .item-cta-link:hover { text-decoration: underline; color: var(--primary-color-hover); }
        .item-type-badge {
            font-size: 0.75rem; 
            padding: 0.25rem 0.75rem; 
            border-radius: 9999px; 
            background-color: var(--bg-color-hover); 
            color: var(--text-color-subtle); 
            font-weight: 600; 
            text-transform: uppercase;
        }
        .card-tags span {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 10px;
            background-color: var(--bg-color-hover);
            color: var(--text-color-subtle);
            display: inline-block;
            margin: 0 5px 5px 0; /* LTR */
        }

        .button, button {
            background-color: var(--primary-color);
            color: var(--text-color-inverted);
            border: 1px solid transparent;
            padding: 0.625rem 1rem; 
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.875rem; 
            font-weight: 500; 
            transition: background-color 0.2s, border-color 0.2s, color 0.2s;
            text-decoration: none; 
            display: inline-flex; 
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .button:hover, button:hover {
            background-color: var(--primary-color-hover);
        }
        .button-secondary {
            background-color: transparent;
            color: var(--text-color-subtle);
            border-color: var(--border-color-darker);
        }
        .button-secondary:hover { background-color: var(--bg-color-hover); color: var(--text-color); }
        .button-danger {
            background-color: #dc2626; 
            color: var(--text-color-inverted);
        }
        .button-danger:hover { background-color: #b91c1c; }
        input:focus, button:focus, select:focus, textarea:focus, a:focus { 
            outline: 2px solid transparent;
            outline-offset: 2px;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.6); 
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.75); 
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.2s ease-out;
        }
        .modal-overlay:not(.hidden) { opacity: 1; }
        .modal-content {
            background-color: var(--bg-color-modal);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 48rem; 
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.95);
            opacity: 0;
            transition: transform 0.2s ease-out, opacity 0.2s ease-out, background-color 0.3s ease, border-color 0.3s ease;
        }
        .modal-overlay:not(.hidden) .modal-content { transform: scale(1); opacity: 1; }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem; 
        }
        .modal-header h2 { margin-top: 0; font-size: 1.5rem; font-weight: 700; }
        .modal-header .close-button { 
            background: none; border: none; font-size: 1.5rem; color: var(--text-color-muted); cursor: pointer;
            padding: 0.25rem; line-height: 1; border-radius: 50%;
        }
        .modal-header .close-button:hover { background-color: var(--bg-color-hover); }
        
        .modal-body { /* For modals with just text content like confirm */
            padding-bottom: 1rem;
            font-size: 1rem;
            color: var(--text-color);
        }

        .modal-actions {
            margin-top: 1.5rem; 
            text-align: right; /* LTR */
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end; /* LTR */
            gap: 0.75rem; 
        }
         .modal-actions.no-border {
            border-top: none;
            padding-top: 0;
        }


        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.25rem; font-weight: 500; font-size: 0.875rem; }
        .form-group input[type="text"],
        .form-group input[type="url"],
        .form-group input[type="email"], /* Added for feedback modal */
        .form-group input[type="file"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.625rem; 
            border: 1px solid var(--border-color-darker); 
            border-radius: var(--border-radius);
            box-sizing: border-box;
            background-color: var(--bg-color); 
            color: var(--text-color);
        }
        .form-group textarea { min-height: 100px; }
        
        /* New: for image URL input group in modal */
        .form-group-inline {
            display: flex;
            gap: 0.5rem;
            align-items: flex-end;
        }
        .form-group-inline .form-control {
            flex-grow: 1;
        }
        .form-group-inline .button {
            flex-shrink: 0;
            padding: 0.6rem 0.8rem; /* Adjust padding to match input height */
        }
        
        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: var(--text-color-muted);
            opacity: 0.8; /* Ensure it's not too faint */
        }
        
        /* Styles for Add Content Template Selection */
        #templateSelectionContainer { margin-bottom: 1.5rem; }
        #templateSelectionContainer h3 { font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-color); }
        .template-buttons-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .template-button {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color-darker);
            color: var(--text-color-subtle);
            padding: 1rem;
            border-radius: var(--border-radius);
            text-align: left; /* Maintained */
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex; /* Added for flex alignment */
            flex-direction: column; /* Stack items vertically */
            align-items: flex-start; /* Align items to the start (left) */
        }
        .template-button:hover {
            border-color: var(--primary-color);
            background-color: var(--bg-color-hover);
            color: var(--text-color);
        }
        .template-button i { 
            font-size: 1.5rem; 
            margin-bottom: 0.75rem; /* Increased margin */
            display: block; 
            color: var(--primary-color); 
            width: 100%; /* Ensure icon container takes width for alignment if needed */
            text-align: left; /* Ensure icon itself is left-aligned */
        }
        .template-button h4 { 
            font-size: 1rem; 
            font-weight: 600; 
            margin-bottom: 0.5rem; /* Increased margin */
        }
        .template-button p { 
            font-size: 0.8rem; 
            line-height: 1.4; 
            color: var(--text-color-muted); /* Consistent with other paragraph text */
        }


        .ql-toolbar {
            background: var(--bg-color);
            border-color: var(--border-color-darker) !important;
            border-top-left-radius: var(--border-radius);
            border-top-right-radius: var(--border-radius);
        }
        .ql-toolbar .ql-stroke { stroke: var(--text-color-muted); }
        .ql-toolbar .ql-fill { fill: var(--text-color-muted); }
        .ql-toolbar .ql-picker-label { color: var(--text-color-muted); }
        .ql-snow .ql-picker.ql-expanded .ql-picker-options { background-color: var(--bg-color-alt); border-color: var(--border-color-darker); }
        .ql-snow .ql-picker-options .ql-picker-item:hover { color: var(--primary-color); }


        .ql-container {
            background: var(--bg-color-alt);
            border-color: var(--border-color-darker) !important;
            color: var(--text-color);
            min-height: 150px; 
            border-bottom-left-radius: var(--border-radius);
            border-bottom-right-radius: var(--border-radius);
            font-size: 1rem;
        }
        .ql-editor { padding: 12px; }
        .ql-editor.ql-blank::before {
            color: var(--text-color-muted);
            opacity: 0.6;
        }


        footer {
            text-align: center;
            padding: 1.5rem;
            font-size: 0.875rem;
            color: var(--text-color-muted);
            border-top: 1px solid var(--border-color);
            margin-top: auto; 
        }

        .mobile-sidebar-toggle {
            display: block;
            position: fixed;
            top: calc((var(--header-height) - 40px) / 2); 
            left: 1.5rem; /* LTR */
            z-index: 101; 
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 0.75rem; 
            border-radius: var(--border-radius);
            font-size: 1.25rem; 
            line-height: 1;
        }
        @media (min-width: 768px) {
            .mobile-sidebar-toggle { display: none; }
            .header-left-content #currentSectionTitle { margin-left: 0; } /* No toggle on desktop */
        }
        @media (max-width: 767px) {
            .header-left-content #currentSectionTitle { margin-left: 0.5rem; } /* Space for toggle */
            .content-header { padding: 1rem; }
            .header-right-content .search-container { display:none; } 
        }

        .toast-notification {
            position: fixed;
            bottom: 20px;
            right: 20px; /* LTR */
            padding: 12px 18px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 2000; 
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            display: flex;
            align-items: center;
            background-color: var(--bg-color-alt); 
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }
        .toast-notification.show { opacity: 1; transform: translateY(0); }
        .toast-icon { margin-right: 10px; /* LTR */ font-size: 1.2em; }
        .toast-success { background-color: #10b981; color: white; border-color: #059669; } 
        .toast-error { background-color: #ef4444; color: white; border-color: #dc2626; } 
        .toast-info { background-color: #3b82f6; color: white; border-color: #2563eb; } 

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 1.5rem; 
        }

        .kb-content h1, .kb-content h2, .kb-content h3 { margin-top: 1.5em; margin-bottom: 0.5em; color: var(--text-color); }
        .kb-content p { margin-bottom: 1em; }
        .kb-content ol { margin-bottom: 1em; padding-left: 20px; }
        .kb-content ul { margin-bottom: 1em; padding-left: 20px; }
        .kb-content li { margin-bottom: 0.5em; }
        .kb-content strong { font-weight: bold; }
        .kb-content em { font-style: italic; }
        .kb-content a { color: var(--primary-color); text-decoration: underline; }
        .kb-content pre {
            background-color: var(--bg-color);
            padding: 10px;
            border-radius: var(--border-radius);
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            border: 1px solid var(--border-color);
            color: var(--text-color); /* Ensure pre content is visible */
        }
         .kb-content code { /* More specific for inline code if needed */
            background-color: var(--bg-color-hover);
            padding: 0.2em 0.4em;
            margin: 0;
            font-size: 85%;
            border-radius: 3px;
        }
        /* UPDATED: Style for images inside content */
        .kb-content img.kb-img {
            max-width: 100%;
            height: auto;
            border-radius: var(--border-radius);
            margin: 1.5rem 0; /* Increased margin for better spacing */
            border: 1px solid var(--border-color);
            display: block; /* Ensures margin works correctly */
        }
        mark {
            padding: 0.1em 0.2em; border-radius: 0.2em; font-weight: bold;
            background-color: #78350f; color: #f3f4f6; 
        }

        .hidden { display: none !important; }

        .chart-container {
            position: relative;
            padding: 1rem;
            border-radius: var(--border-radius-lg);
            background-color: var(--bg-color-alt);
            height: 320px; 
            display: flex; /* For centering canvas */
            flex-direction: column; /* For centering canvas */
            justify-content: center; /* For centering canvas */
            align-items: center; /* For centering canvas */
        }
        .chart-container canvas { /* Ensure canvas does not overflow */
            max-width: 100%;
            max-height: 100%;
        }
        .chart-container h3 {
            font-size: 1.125rem; 
            font-weight: 600; 
            margin-bottom: 0.5rem;
            text-align: center;
            width: 100%; /* Ensure title takes full width above chart */
        }
        .mermaid-diagram-card { /* Specific card for Mermaid diagrams */
            background-color: var(--bg-color-alt);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--card-shadow);
            margin-bottom: 1.5rem;
        }
        .mermaid-diagram-card h3 { /* Title within the card */
            margin-top: 0;
            margin-bottom: 1rem;
            font-size: 1.25rem;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }
        .mermaid-diagram-container {
            overflow-x: auto; /* For wide diagrams */
            padding: 10px; 
            background-color: var(--bg-color-alt); /* Diagram area background */
            border-radius: var(--border-radius);
        }
        .mermaid-diagram-container svg { 
            display: block;
            margin: 0 auto; 
            max-width: 100%; 
            min-height: 350px; /* Reduced min-height for diagram clarity */
            height: auto; /* Allow height to adjust based on content */
        }
        /* Mermaid dark theme overrides */
        .mermaid-diagram-container text { 
            fill: var(--text-color) !important; 
            font-family: 'Inter', sans-serif !important; 
            font-size: 14px !important; /* Increased font size for clarity */
        }
        .mermaid-diagram-container .edgeLabel { 
            color: var(--text-color) !important; 
        } 
         .mermaid-diagram-container .edgeLabel span { 
            font-size: 14px !important; /* Ensure consistent font size */
        }
        .mermaid-diagram-container .label { color: var(--text-color) !important; }
        .mermaid-diagram-container .actor { stroke: var(--text-color-muted) !important; fill: var(--bg-color-alt) !important; }
        .mermaid-diagram-container .messageText { fill: var(--text-color) !important; }
        .mermaid-diagram-container rect, 
        .mermaid-diagram-container polygon, 
        .mermaid-diagram-container ellipse,
        .mermaid-diagram-container circle {
            stroke: var(--primary-color) !important; /* Node border */
            fill: var(--bg-color-alt) !important; /* Node background, same as diagram for border emphasis */
        }
        .mermaid-diagram-container .cluster rect {
             fill: var(--bg-color) !important; /* Darker fill for cluster background */
             stroke: var(--border-color-darker) !important;
        }
        .mermaid-diagram-container .arrowheadPath {
            fill: var(--primary-color) !important;
        }
        .mermaid-diagram-container .edgePaths path {
            stroke: var(--primary-color) !important;
        }


        /* Item Detail View Specific */
        #itemDetailViewPlaceholder .card { /* General card within detail view */
            /* border-top: 4px solid var(--primary-color);  Removed to avoid double top border on standard card */
        }
        #itemDetailViewPlaceholder .item-title-area {
            display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;
        }
        #itemDetailViewPlaceholder .item-title-area i.fa-title-icon { /* Specific class for title icon */
            font-size: 2rem; color: var(--primary-color); 
        }
        #itemDetailViewPlaceholder .item-title-area h2 { font-size: 1.8rem; margin:0; }
        #itemDetailViewPlaceholder .item-summary { color: var(--text-color-subtle); margin-bottom: 1rem; font-style: italic; }
        #itemDetailViewPlaceholder hr.title-content-divider { /* Specific class for this hr */
             margin: 1.5rem 0; border-color: var(--border-color); 
        }
        #itemDetailViewPlaceholder .kb-content ul { list-style-type: disc; }
        #itemDetailViewPlaceholder .child-items-list { list-style-type: none; padding-left: 0; }
        #itemDetailViewPlaceholder .child-items-list li { margin-bottom: 0.5rem; }
        #itemDetailViewPlaceholder .child-items-list a { color: var(--primary-color); text-decoration: none; }
        #itemDetailViewPlaceholder .child-items-list a:hover { text-decoration: underline; }
        .item-actions-bar { display: flex; gap: 0.75rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .item-feedback-section { margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color); }
        .item-feedback-section h4 { font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; }
        .rating-buttons button { background: none; border: 1px solid var(--border-color); color: var(--text-color-muted); padding: 0.5rem 0.75rem; border-radius: var(--border-radius); cursor: pointer; transition: all 0.2s; }
        .rating-buttons button:hover, .rating-buttons button.active { border-color: var(--rating-color); color: var(--rating-color); background-color: rgba(251, 191, 36, 0.1); }
        .rating-buttons button i { margin-right: 0.5rem; }
        .read-stats { font-size: 0.875rem; color: var(--text-color-muted); margin-left: 1rem; }
        
        /* UPDATED: Comments Section Styles */
        .comments-section { margin-top: 2rem; }
        .comments-section h4 {
            font-size: 1.25rem;
            font-weight: 600;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 1.5rem;
        }
        .comments-section .comment-form textarea { width: 100%; min-height: 80px; margin-bottom: 0.5rem;}
        .comments-section .comment-display-area { 
            margin-top: 1rem; 
            min-height: 50px; 
        }
        .comment {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.25rem;
        }
        .comment-avatar img {
            width: 36px; height: 36px; border-radius: 50%;
        }
        .comment-body { flex-grow: 1; }
        .comment-header {
            display: flex; align-items: baseline; gap: 0.5rem; margin-bottom: 0.25rem;
        }
        .comment-author {
            font-weight: 600; color: var(--text-color); font-size: 0.9rem;
        }
        .comment-timestamp {
            font-weight: normal; color: var(--text-color-muted); font-size: 0.75rem;
        }
        .comment-text {
            font-size: 0.95rem; line-height: 1.5; color: var(--text-color-subtle);
            white-space: pre-wrap; /* Preserve line breaks in comments */
        }
        .comment-actions { margin-top: 0.5rem; }
        .comment-actions button {
            background: none; border: none; color: var(--text-color-muted); font-size: 0.8rem; cursor: pointer; padding: 0.25rem;
        }
        .comment-actions button:hover { color: var(--primary-color); }
        .comment-replies {
            padding-left: calc(36px + 1rem); /* Align with parent comment body */
            margin-top: 1.25rem;
        }
        .reply-form { margin-top: 0.75rem; padding-left: calc(36px + 1rem); }
        
        /* Dashboard specific styles */
        .dashboard-stat-card {
            background-color: var(--bg-color-alt);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--card-shadow);
            text-align: center;
        }
        .dashboard-stat-card i {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 0.75rem;
        }
        .dashboard-stat-card .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            display: block;
            margin-bottom: 0.25rem;
        }
        .dashboard-stat-card .stat-label {
            font-size: 0.875rem;
            color: var(--text-color-muted);
        }
        .dashboard-quicklink-card, .dashboard-info-card { /* Combined for similar styling */
             background-color: var(--bg-color-alt);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--card-shadow);
        }
         .dashboard-quicklink-card h3, .dashboard-info-card h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }
        .dashboard-quicklink-card ul, .dashboard-info-card ul {
            list-style: none;
            padding: 0;
        }
        .dashboard-quicklink-card ul li a, .dashboard-info-card ul li a {
            display: block;
            padding: 0.5rem 0;
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
        }
         .dashboard-quicklink-card ul li a:hover, .dashboard-info-card ul li a:hover {
            text-decoration: underline;
        }
         .dashboard-info-card ul li {
            font-size: 0.9rem;
            color: var(--text-color-subtle);
            padding: 0.3rem 0;
         }
         .dashboard-info-card ul li strong {
            color: var(--text-color);
         }
         .dashboard-info-card ul li .meta {
            font-size: 0.75rem;
            display: block;
            color: var(--text-color-muted);
         }
         /* Viewer Dashboard Message */
        .viewer-dashboard-message .card {
            text-align: center;
            padding: 40px 20px;
            min-height: auto; /* Override general card min-height if needed */
        }
        .viewer-dashboard-message .card i {
            font-size: 2.5rem; /* Larger icon for emphasis */
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
        .viewer-dashboard-message .card h2 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--text-color);
        }
        .viewer-dashboard-message .card p {
            font-size: 1rem;
            color: var(--text-color-muted);
            margin-bottom: 0; /* Adjust as needed */
        }
        .viewer-dashboard-message .card p.subtle-note {
             font-size: 0.9rem;
             margin-top: 1rem;
        }

        /* ============== UPDATED & POLISHED: Interactive Flow Styles ============== */
        .interactive-flow-container {
            background-color: transparent; /* No extra container background */
            padding: 0;
            border: none;
        }
        .flow-title-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color-darker);
        }
        .flow-title-bar h2 {
            font-size: 1.8rem; /* Larger title for emphasis */
            margin: 0; 
            color: var(--text-color);
            display: flex; 
            align-items: center;
        }
        .flow-title-bar h2 i {
            margin-right: 1rem; 
            color: var(--primary-color); 
            font-size: 2rem;
        }
        .flow-title-bar #flowTopActions button {
            padding: 0.5rem 0.8rem; font-size: 0.8rem;
        }

        .flow-controls {
            display: flex; flex-wrap: wrap; gap: 0.75rem;
            margin-bottom: 1.5rem; padding: 1rem;
            background-color: var(--bg-color-alt);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
        }
        .flow-controls .button i { margin-right: 0.5rem; }

        .step-card {
            background: var(--bg-color-alt);
            border-left: 5px solid var(--primary-color);
            border-radius: var(--border-radius);
            margin-bottom: 1.25rem;
            box-shadow: var(--card-shadow);
            overflow: hidden;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        
        .step-card.done {
            border-left-color: var(--step-done-color);
            background: #132a22; /* Subtle green background for done steps */
        }
        .step-card.done .step-header {
            background-color: transparent; /* Inherit from card */
        }
        .step-card.done .step-number {
             color: var(--step-done-color);
        }

        .step-header {
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            background-color: transparent;
            transition: background-color 0.2s;
        }
        .step-header:hover {
            background-color: var(--bg-color-hover);
        }
        
        .step-header-main {
            display: flex; align-items: center; flex-grow: 1;
        }
        .step-number {
            color: var(--primary-color);
            font-weight: 700;
            margin-right: 1rem;
            font-size: 1.2em;
            transition: color 0.3s ease;
        }
        .step-title {
            font-weight: 600; font-size: 1.2em; color: var(--text-color);
            margin-right: 1rem;
        }
        .step-header-actions {
            display: flex; align-items: center; gap: 1rem;
        }

        .mark-step-done-btn {
            padding: 0.4rem 0.8rem; font-size: 0.8rem;
            border: 1px solid var(--border-color-darker);
            background-color: var(--bg-color);
            border-radius: var(--border-radius);
            transition: all 0.2s;
            color: var(--text-color-subtle);
        }
        .mark-step-done-btn.done {
            background-color: var(--step-done-color);
            border-color: var(--step-done-color);
            color: var(--text-color-inverted);
            font-weight: bold;
        }
        .mark-step-done-btn:hover:not(.done) {
            border-color: var(--step-done-color);
            color: var(--step-done-color);
        }
        .mark-step-done-btn .fa-circle, .mark-step-done-btn .fa-check-circle {
            transition: transform 0.2s;
        }
        .mark-step-done-btn:hover .fa-circle { transform: scale(1.2); }

        .toggle-step-details-btn {
            background: none; border: none;
            color: var(--text-color-muted);
            font-size: 1.2rem;
            padding: 0.25rem;
        }
        .toggle-step-details-btn i.fa-chevron-down {
            transition: transform 0.3s ease-in-out;
        }
        .step-card.expanded .toggle-step-details-btn i.fa-chevron-down {
            transform: rotate(180deg);
        }

        .step-body {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out, opacity 0.3s ease-in-out, padding 0.4s ease-out;
            padding: 0 1.5rem;
            background-color: var(--bg-color);
        }
        .step-card.expanded > .step-body {
            max-height: 2000px; /* Large enough for content */
            opacity: 1;
            padding: 1.5rem 1.5rem;
            border-top: 1px solid var(--border-color-darker);
        }
        
        .step-body .kb-content { padding: 0; } 
        .step-body p, .step-body ul, .step-body ol {
            margin-bottom: 0.75em; color: var(--text-color-subtle); font-size: 0.95rem;
        }
        .step-body strong { color: var(--text-color); }
        .step-body ul, .step-body ol { padding-left: 25px; } 
        
        .step-link {
            color: #60a5fa; font-weight: 500;
            text-decoration: none;
            border-bottom: 1px dotted #60a5fa;
            text-decoration-skip-ink: none;
        }
        .step-link:hover {
            text-decoration: underline;
            border-bottom-style: solid;
            color: #7dd3fc;
        }
        
        .important-notes-card {
            background: rgba(251, 191, 36, 0.05);
            border-left: 4px solid var(--rating-color);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-top: 1.5rem;
            box-shadow: var(--card-shadow);
        }
        .important-notes-card h3 {
            font-size: 1.2em; font-weight: 600; color: var(--text-color);
            margin-top: 0; margin-bottom: 0.75rem;
            display: flex; align-items: center;
        }
        .important-notes-card h3 i {
            margin-right: 0.75rem; color: var(--rating-color);
        }
        .important-notes-card ul {
            padding-left: 20px; list-style: disc; color: var(--text-color-subtle);
        }
        
        .agent-script-block {
            background-color: var(--bg-color-hover);
            padding: 1.25rem 1.5rem;
            border-radius: var(--border-radius);
            margin: 1.5rem 0;
            border-left: 4px solid var(--primary-color);
            color: var(--text-color);
            position: relative;
            font-style: italic;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .agent-script-block i.fa-comment-dots {
            margin-right: 0.75rem; color: var(--primary-color);
        }
        .copy-script-btn {
            position: absolute; top: 0.5rem; right: 0.5rem; /* LTR */
            background: var(--bg-color);
            color: var(--text-color-muted);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s, background-color 0.2s;
            z-index: 1;
        }
        .agent-script-block:hover .copy-script-btn { opacity: 0.8; }
        .copy-script-btn:hover { opacity: 1; background-color: var(--primary-color-hover); color: white; }

        /* Hide non-script elements in Agent Script Mode */
        .agent-script-mode-active .step-body > .kb-content > *:not(.agent-script-block) {
            display: none;
        }
        .agent-script-mode-active .step-body > .kb-content > .agent-script-block {
            display: block !important; /* Ensure it's shown */
            margin-bottom: 1rem; /* Add some spacing between script blocks */
        }
        .agent-script-mode-active .important-notes-card {
            display: none;
        }
        /* =================================================================== */

        /* Quill editor for in-place flow editing */
        #flowInPlaceEditorContainer {
            margin-top: 1rem;
            border: 1px solid var(--border-color-darker);
            border-radius: var(--border-radius-lg);
            padding: 1rem;
            background-color: var(--bg-color-alt);
        }
        #flowQuillEditor { min-height: 300px; } /* Container for Quill */
        .flow-editor-actions {
            margin-top: 1rem;
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        /* NEW: Styles for Interactive Hover Pop-outs */
        .interactive-hover-item {
            position: relative;
            cursor: help;
            color: #60a5fa; /* A nice blue color */
            font-weight: 500;
            border-bottom: 1px dotted #60a5fa;
        }
        .hover-popout {
            display: none; /* Managed by JS */
            position: absolute;
            bottom: 100%; /* Position above the text */
            left: 50%;
            transform: translateX(-50%) translateY(-10px); /* Center and add gap */
            background-color: var(--bg-color);
            border: 1px solid var(--border-color-darker);
            border-radius: var(--border-radius);
            padding: 1rem;
            box-shadow: var(--card-hover-shadow);
            z-index: 10;
            width: max-content;
            min-width: 250px;
            text-align: left;
            font-size: 0.9rem;
            color: var(--text-color);
        }
        .interactive-hover-item:hover .hover-popout {
            display: block;
        }
        .hover-popout h4 {
            margin-top: 0;
            margin-bottom: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }
        .hover-popout ul {
            list-style-type: none;
            padding-left: 0;
            margin-bottom: 0;
        }
        .hover-popout li {
            padding: 0.25rem 0;
            color: var(--text-color-subtle);
        }
        .hover-popout li strong {
            color: var(--text-color);
        }
        .hover-popout small {
            display: block;
            margin-top: 0.75rem;
            padding-top: 0.5rem;
            border-top: 1px dashed var(--border-color);
            color: var(--text-color-muted);
            font-style: italic;
        }


        /* Print Styles */
        @media print {
            body, .container-fluid {
                margin: 0; padding: 0;
                background-color: white !important; color: black !important;
                font-size: 12pt;
            }
            .sidebar, .content-header, .sidebar-footer, footer,
            .mobile-sidebar-toggle, #toastContainer,
            .item-actions-bar, .flow-controls, .flow-title-bar #flowTopActions,
            .item-feedback-section, .comments-section, .modal-overlay, .copy-script-btn,
            .dashboard-overview-container, .search-container, .user-profile,
            .mark-step-done-btn, .toggle-step-details-btn,
            #openAddContentBtnInSection, .interactive-hover-item .hover-popout
            {
                display: none !important;
            }
            .interactive-hover-item {
                border-bottom: none; color: inherit !important; font-weight: inherit;
            }

            .content-wrapper {
                margin-left: 0 !important; padding: 1cm !important;
                overflow: visible !important; height: auto !important; width: 100% !important;
            }
            #pageContentArea { padding: 0 !important; }
            
            #itemDetailViewPlaceholder, #standardSectionContentPlaceholder, .interactive-flow-container {
                display: block !important;
            }
            .card, .interactive-flow-container, .mermaid-diagram-card, .step-card {
                box-shadow: none !important; border: 1px solid #ccc !important;
                margin-bottom: 0.5cm !important;
                background-color: white !important;
                page-break-inside: avoid;
            }
            
            .card *, .interactive-flow-container *, .mermaid-diagram-card *, .step-card * {
                color: black !important; background-color: transparent !important;
            }
             h1, h2, h3, h4, h5, h6 { color: black !important; }

            /* Force expand all step bodies for print */
            .step-body {
                display: block !important;
                max-height: none !important;
                opacity: 1 !important;
                padding: 0 1.5rem 1.5rem 1.5rem !important;
                border-top: 1px solid #ccc !important;
            }
            .step-card.expanded > .step-body {
                 padding: 0 1.5rem 1.5rem 1.5rem !important; /* Ensure padding is consistent */
            }
             .toggle-step-details-btn { display: none !important; }

            .important-notes-card, .agent-script-block { display: block !important; }
            .agent-script-mode-active .step-body > .kb-content > * {
                display: block !important;
            }

            .kb-content a {
                color: #0066cc !important; text-decoration: underline !important;
            }
            .kb-content a[href^="http"]::after, .kb-content a[href^="https"]::after {
                content: " (" attr(href) ")";
                font-size: 0.8em; color: #555 !important; word-break: break-all;
            }
            .kb-content a[href^="#"]::after, .step-link::after { content: ""; }


            /* Mermaid diagrams for print */
            .mermaid-diagram-container { background-color: white !important; }
            .mermaid-diagram-container svg {
                background-color: white !important; max-width: 100% !important; height: auto !important;
            }
            .mermaid-diagram-container text,
            .mermaid-diagram-container .edgeLabel,
            .mermaid-diagram-container .label,
            .mermaid-diagram-container .messageText {
                fill: black !important; font-family: 'Arial', sans-serif !important;
            }
            .mermaid-diagram-container .actor { stroke: #333 !important; fill: white !important; }
            .mermaid-diagram-container rect, .mermaid-diagram-container polygon,
            .mermaid-diagram-container ellipse, .mermaid-diagram-container circle {
                stroke: #333 !important; fill: #f0f0f0 !important;
            }
            .mermaid-diagram-container .cluster rect {
                fill: #e8e8e8 !important; stroke: #aaa !important;
            }
            .mermaid-diagram-container .arrowheadPath { fill: #333 !important; }
            .mermaid-diagram-container .edgePaths path { stroke: #333 !important; }
            pre.mermaid {
                background-color: #f8f8f8 !important; border: 1px solid #ddd !important; padding: 8px !important;
            }
        }
    </style>
</head>
<body>

    <div id="addContentModalOverlay" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="addContentModalTitle">Add New Content</h2>
                <button id="closeAddContentModalBtn" class="close-button" aria-label="Close">×</button>
            </div>

            <div id="templateSelectionContainer" class="hidden">
                <h3>Choose a Template</h3>
                <div class="template-buttons-grid">
                    <button class="template-button" data-template="standard_article">
                        <i class="fas fa-newspaper"></i>
                        <h4>Standard Article</h4>
                        <p>For general information, announcements, or detailed explanations.</p>
                    </button>
                    <button class="template-button" data-template="troubleshooting_guide">
                        <i class="fas fa-tools"></i>
                        <h4>Troubleshooting Guide / Case</h4>
                        <p>Step-by-step solutions for common issues or case documentation.</p>
                    </button>
                     <button class="template-button" data-template="interactive_flow">
                        <i class="fas fa-project-diagram"></i>
                        <h4>Interactive Flow</h4>
                        <p>A guided, step-by-step process for agents to follow.</p>
                    </button>
                    <button class="template-button" data-template="policy_document">
                        <i class="fas fa-gavel"></i>
                        <h4>Policy Document</h4>
                        <p>Formal policies, procedures, or official guidelines.</p>
                    </button>
                     <button class="template-button" data-template="blank">
                        <i class="fas fa-file"></i>
                        <h4>Blank Document</h4>
                        <p>Start with a completely empty document of any type.</p>
                    </button>
                </div>
                <hr style="border-color: var(--border-color-darker); margin: 1.5rem 0;">
            </div>

            <form id="addContentForm" class="hidden">
                <input type="hidden" id="editingItemId"> <!-- For storing ID when editing -->
                <div class="form-group">
                    <label for="contentType">Content Type</label>
                    <select id="contentType">
                        <option value="article">Article</option>
                        <option value="interactive_flow">Interactive Flow</option>
                        <option value="case">Case</option>
                        <option value="form_sheet">Form/Sheet (Link)</option>
                        <option value="design">Design (Link)</option>
                        <option value="guide">Guide</option>
                        <option value="policy">Policy</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="contentTitle">Title</label>
                    <input type="text" id="contentTitle" required>
                </div>
                <div class="form-group">
                    <label for="contentSummary">Summary / Description</label>
                    <textarea id="contentSummary" rows="3" required></textarea>
                </div>
                
                <div class="form-group hidden" id="contentUrlContainer">
                    <label for="contentUrl">Link (for Forms, Designs, etc.)</label>
                    <input type="url" id="contentUrl">
                </div>

                <div class="form-group" id="contentDetailContainer">
                    <label for="contentDetail" id="contentDetailLabel">Details / Content</label>
                    <div id="quillEditor"></div> <!-- Quill editor container -->
                </div>

                <!-- NEW: Image URL input -->
                 <h3 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; margin-top: 1.5rem; color: var(--text-color);">Attachments & Media</h3>

                <div class="form-group">
                    <label for="contentImageUrl">Insert Image from URL (Optional)</label>
                    <div class="form-group-inline">
                        <div class="form-control">
                            <input type="url" id="contentImageUrl" placeholder="https://example.com/image.png">
                        </div>
                        <button type="button" id="insertImageBtn" class="button button-secondary"><i class="fas fa-link"></i> Insert into Content</button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="imageFile">Upload and Insert Image from Device</label>
                    <input type="file" id="imageFile" accept="image/*">
                </div>
                <div class="form-group">
                    <label for="pdfFile">Upload PDF (Attachment Simulation)</label>
                    <input type="file" id="pdfFile" accept=".pdf">
                </div>
                <div class="form-group">
                    <label for="videoLink">Video Link (e.g., YouTube, Vimeo)</label>
                    <input type="url" id="videoLink" placeholder="https://">
                </div>
                <div class="form-group">
                    <label for="driveLink">Google Drive Link</label>
                    <input type="url" id="driveLink" placeholder="https://docs.google.com/... or https://drive.google.com/...">
                </div>

                 <div class="form-group">
                    <label for="contentTags">Tags (comma-separated)</label>
                    <input type="text" id="contentTags" placeholder="e.g., important, update, billing">
                </div>

                <div class="modal-actions">
                    <button type="submit" id="saveContentBtn" class="button"><i class="fas fa-save"></i> Save Content</button>
                    <button type="button" id="cancelAddContentBtn" class="button-secondary"><i class="fas fa-times"></i> Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div id="logoutConfirmModalOverlay" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 28rem;"> <!-- Smaller modal for confirm -->
            <div class="modal-header">
                <h2 id="logoutConfirmModalTitle">Confirm Logout</h2>
                <button id="closeLogoutConfirmModalBtn" class="close-button" aria-label="Close">×</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to logout from InfiniBase?</p>
            </div>
            <div class="modal-actions no-border"> 
                <button type="button" id="confirmLogoutBtn" class="button button-danger"><i class="fas fa-sign-out-alt"></i> Confirm Logout</button>
                <button type="button" id="cancelLogoutBtn" class="button-secondary"><i class="fas fa-times"></i> Cancel</button>
            </div>
        </div>
    </div>

    <!-- Report Feedback Modal -->
    <div id="reportFeedbackModalOverlay" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 32rem;">
            <div class="modal-header">
                <h2 id="reportFeedbackModalTitle">Report Feedback</h2>
                <button id="closeReportFeedbackModalBtn" class="close-button" aria-label="Close">×</button>
            </div>
            <form id="reportFeedbackForm">
                <input type="hidden" id="feedbackItemId">
                <input type="hidden" id="feedbackItemTitle">
                <div class="modal-body" style="padding-bottom:0;">
                    <p style="margin-bottom: 1rem;">Provide your feedback for: <strong id="feedbackItemTitleDisplay"></strong></p>
                    <div class="form-group">
                        <label for="feedbackUserName">Your Name</label>
                        <input type="text" id="feedbackUserName" readonly>
                    </div>
                    <div class="form-group">
                        <label for="feedbackUserEmail">Your Email</label>
                        <input type="email" id="feedbackUserEmail" readonly>
                    </div>
                    <div class="form-group">
                        <label for="feedbackComment">Your Feedback / Comments</label>
                        <textarea id="feedbackComment" rows="5" required placeholder="Please describe the issue or suggestion..."></textarea>
                    </div>
                </div>
                <div class="modal-actions"> 
                    <button type="submit" id="submitFeedbackBtn" class="button"><i class="fas fa-paper-plane"></i> Submit Feedback</button>
                    <button type="button" id="cancelFeedbackBtn" class="button-secondary"><i class="fas fa-times"></i> Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmModalOverlay" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 30rem;">
            <div class="modal-header">
                <h2 id="deleteConfirmModalTitle">Confirm Deletion</h2>
                <button id="closeDeleteConfirmModalBtn" class="close-button" aria-label="Close">×</button>
            </div>
            <div class="modal-body">
                <p id="deleteConfirmMessage">Are you sure you want to delete this item? This action cannot be undone.</p>
            </div>
            <div class="modal-actions no-border">
                <button type="button" id="confirmDeleteItemBtn" class="button button-danger"><i class="fas fa-trash-alt"></i> Confirm Delete</button>
                <button type="button" id="cancelDeleteItemBtn" class="button-secondary"><i class="fas fa-times"></i> Cancel</button>
            </div>
        </div>
    </div>


    <div class="container-fluid">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-database"></i> <span class="sidebar-logo-text">InfiniBase</span>
            </div>
            <nav id="navigationMenu" class="sidebar-nav">
                <!-- Links will be dynamically generated -->
            </nav>
            <div class="sidebar-footer">
                <button id="logoutButton" class="button button-danger">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
                 <div id="userRoleDisplaySidebar" style="font-size: 0.8rem; color: var(--text-color-muted); text-align: center; margin-top: 0.5rem;">Role: <span id="currentUserRoleSpan"></span></div>
            </div>
        </aside>

        <div class="content-wrapper" id="contentWrapper">
            <header class="content-header">
                <div class="header-left-content">
                    <button id="mobileSidebarToggle" class="mobile-sidebar-toggle"><i class="fas fa-bars"></i></button>
                    <div>
                        <h1 id="currentSectionTitle">Welcome</h1>
                        <div id="breadcrumbs">Home</div>
                    </div>
                </div>
                <div class="header-right-content">
                    <div class="search-container">
                        <span class="search-icon"><i class="fas fa-search"></i></span>
                        <input type="search" id="globalSearchInput" placeholder="Search the knowledge base...">
                        <div id="searchResultsContainer" class="hidden"></div>
                    </div>
                    <div id="userProfileContainer" class="user-profile">
                        <img id="userAvatar" src="https://ui-avatars.com/api/?name=U&size=36&background=6366f1&color=fff&rounded=true" alt="User">
                        <span id="userNameDisplayHeader" style="font-weight: 500;">User</span>
                    </div>
                </div>
            </header>

            <main id="pageContentArea" class="p-6 md:p-8">
                <div id="dashboardOverviewContainer" class="hidden">
                    <!-- Dashboard content will be injected here -->
                </div>
                <div id="standardSectionContentPlaceholder">
                    <!-- Section content will be injected here -->
                </div>
                <div id="itemDetailViewPlaceholder" class="hidden" data-mermaid-rendered="false">
                    <!-- Item detail view OR Interactive Flow View -->
                </div>
            </main>

            <footer class="mt-auto p-6 text-center text-sm">
                <span>© <script>document.write(new Date().getFullYear())</script> InfiniBase.Elmenisy. Version <span id="footerKbVersion">0.1.0</span></span>
            </footer>
        </div>
    </div>
    <div id="toastContainer"></div>

<script type="module">
    import { supabase } from './supabase.js';

    // =================================================================================
    // IMMEDIATE SESSION CHECK
    // =================================================================================
    const { data: { session: initialSession }, error: initialSessionError } = await supabase.auth.getSession();

    if (initialSessionError) {
        console.error("Critical error during initial session check. Redirecting.", initialSessionError.message);
        window.location.href = 'login.html';
    } else if (!initialSession) {
        console.log("No initial session found. Redirecting to login.");
        window.location.href = 'login.html';
    }
    // =================================================================================


    // --- Initialize Mermaid ---
    mermaid.initialize({ 
        startOnLoad: false,
        theme: 'dark', 
        fontFamily: 'Inter, sans-serif',
        flowchart: { 
            htmlLabels: true,
            useMaxWidth: true,
        },
        themeVariables: {
            fontSize: '14px', 
            background: getComputedStyle(document.documentElement).getPropertyValue('--bg-color-alt').trim(), 
            primaryColor: getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim(),
            primaryTextColor: getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim(),
            lineColor: getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim(),
            textColor: getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim(),
            nodeBorder: getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim(),
        }
    });
    
    /**
     * @typedef {object} UserProfile
     * @property {string} id - User UUID from Supabase Auth
     * @property {string} [name] - User's full name (from 'users' table, column 'name')
     * @property {string} email - User's email
     * @property {string} role - User's role (e.g., 'viewer', 'admin')
     * @property {string} [lastLogin] - ISO string of last login time (optional in this type, added by client)
     */

    // --- Supabase Auth & User Management ---
    const Auth = {
        /** @returns {Promise<UserProfile|null>} */
        async getCurrentUserProfile() {
            const { data: { session }, error: sessionError } = await supabase.auth.getSession();

            if (sessionError || !session || !session.user) {
                console.error("Error fetching Supabase session or session invalid:", sessionError);
                window.location.href = 'login.html';
                return null; 
            }

            const authUser = session.user;
            const userId = authUser.id;

            let { data: userDataFromDB, error: dbError } = await supabase
                .from("users")
                .select("id, name, email, role") 
                .eq("id", userId)
                .single();

            if (dbError && dbError.code !== 'PGRST116') {
                console.error("Unexpected DB error fetching user profile:", dbError);
                await supabase.auth.signOut();
                window.location.href = "login.html";
                return null;
            }

            if (!userDataFromDB) {
                console.warn(`Profile for user ${userId} not found. Creating a new profile in 'users' table.`);
                
                const { data: newProfile, error: insertError } = await supabase
                    .from('users')
                    .insert({
                        id: userId,
                        email: authUser.email,
                        name: authUser.user_metadata?.full_name || authUser.email.split('@')[0], 
                        role: 'viewer'
                    })
                    .select()
                    .single();

                if (insertError) {
                    console.error("Fatal: Failed to create new user profile in DB after login:", insertError);
                    await supabase.auth.signOut();
                    window.location.href = "login.html";
                    return null;
                }
                
                console.log("Successfully created and fetched new user profile:", newProfile);
                userDataFromDB = newProfile;
            }
            
            /** @type {UserProfile} */
            const comprehensiveUserProfile = {
                ...userDataFromDB, 
                lastLogin: new Date().toISOString() 
            };

            localStorage.setItem("infiniBaseUser", JSON.stringify(comprehensiveUserProfile));
            return comprehensiveUserProfile;
        },
        async logout() {
            const { error } = await supabase.auth.signOut();
            if (error) {
                console.error("Error during sign out:", error);
                showToast('Error signing out. Please try again.', 'error');
            } else {
                localStorage.removeItem('infiniBaseUser');
                localStorage.removeItem('justLoggedIn');
                localStorage.removeItem('infiniBase_agentScriptMode');
                showToast('You have been logged out successfully!', 'success');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 1500);
            }
        }
    };

    // --- NEW: Database Interaction Module ---
    const Db = {
        async getComments(itemUuid) {
            const { data, error } = await supabase
                .from('kb_comments')
                .select('*')
                .eq('item_id', itemUuid)
                .order('created_at', { ascending: true });
            
            if (error) {
                console.error("Error fetching comments:", error);
                showToast("Could not load comments.", "error");
                return [];
            }
            return data;
        },
        async postComment({ itemUuid, parentId, body }) {
            if (!currentUser) return { error: { message: "User not logged in" } };
            const { data, error } = await supabase
                .from('kb_comments')
                .insert({
                    item_id: itemUuid,
                    parent_id: parentId || null,
                    body: body,
                    author_id: currentUser.id,
                    author_name: currentUser.name || currentUser.email
                })
                .select()
                .single();
            
            if (error) {
                console.error("Error posting comment:", error);
                showToast("Failed to post comment.", "error");
            }
            return { data, error };
        },
        async postFeedback({ itemUuid, rating, reason }) {
            if (!currentUser) return { error: { message: "User not logged in" } };
            const { data, error } = await supabase
                .from('kb_feedback')
                .insert({
                    item_id: itemUuid,
                    user_id: currentUser.id,
                    rating: rating,
                    reason: reason || null
                });

            if (error) {
                console.error("Error submitting feedback:", error);
                showToast("Failed to submit feedback.", "error");
            }
            return { data, error };
        },
        async logView(itemUuid) {
            const today = new Date().toISOString().split('T')[0];
            const viewKey = `viewed_${itemUuid}_${today}`;

            if (localStorage.getItem(viewKey)) {
                return; // Already viewed today
            }

            const { error } = await supabase
                .from('views_log')
                .insert({
                    scenario_id: itemUuid,
                    user_id: currentUser?.id,
                    user_email: currentUser?.email,
                    // Optional: add session_id, device_info if needed
                });

            if (error) {
                console.error("Error logging view:", error);
                // Don't show toast for this, it's a background task
            } else {
                localStorage.setItem(viewKey, 'true');
            }
        },
        async getViewCount(itemUuid) {
            const { count, error } = await supabase
                .from('views_log')
                .select('*', { count: 'exact', head: true })
                .eq('scenario_id', itemUuid);

            if (error) {
                console.error("Error getting view count:", error);
                return 'N/A';
            }
            return count;
        }
    };


    // --- KB Data ---
    let kbSystemData = {
        meta: { version: '1.0.0', lastGlobalUpdate: new Date().toISOString(), lastArticleAdded: null, editsThisWeek: 0 }, 
        sections: [
            { id: 'home', name: 'Home', icon: 'fas fa-home', description: 'Dashboard and overview.', iconColor: 'var(--primary-color)' },
            {
                id: 'support', name: 'Support', icon: 'fas fa-headset', description: 'Support resources and flows.', iconColor: '#c084fc', 
                items: [
                     { 
                        id: 'sup_flow_compensation',
                        uuid: 'a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d',
                        type: 'interactive_flow', 
                        title: 'Scenario: Customer Inquiry – Compensation Flow for Delays', 
                        summary: 'A structured, interactive guide for handling customer compensation due to order delays based on The Chefz policies. Includes agent scripts and validation steps.',
                        content: `
                            <p>This is an interactive guide for handling customer compensation due to order delays. Follow the steps below. Use the "Agent Script View" for direct communication scripts.</p>
                            
                            <ol>
                                <li id="comp_step_1">
                                    <strong>Initial Response & Verification</strong>
                                    <p>When a customer reports a delay, the first step is to respond with empathy and gather information. This should be done within the first 2 minutes of the interaction.</p>
                                    <img src="https://placehold.co/600x150/1f2937/d1d5db?text=1.+Acknowledge+%26+Verify" alt="Diagram showing Acknowledge and Verify steps" class="kb-img" loading="lazy">
                                    <blockquote><i class="fas fa-comment-dots"></i> "I completely understand your frustration with the delay, and I sincerely apologize for the inconvenience. Let me check the exact status of your order right now to see what's going on."</blockquote>
                                    <p>Quickly check the order status in the internal system to confirm the delay and get the latest ETA.</p>
                                </li>
                                <li id="comp_step_2">
                                    <strong>Assess Delay & Determine Compensation Tier</strong>
                                    <p>If the delay exceeds 15 minutes from the original ETA, compensation procedures are initiated. The compensation amount depends on the order type and total delay duration.</p>
                                    <img src="https://placehold.co/600x200/1f2937/d1d5db?text=2.+Consult+Compensation+Matrix" alt="Image of a compensation matrix" class="kb-img" loading="lazy">
                                    <p>Reference the official policy: <a href="#compensation_policies/cp_policy_01" class="step-link">General Compensation Policy v2.1</a>. The key tiers are:</p>
                                    <ul>
                                        <li><strong>16-30 mins:</strong> Delivery fee refund.</li>
                                        <li><strong>31-45 mins:</strong> 25% of food value as credit.</li>
                                        <li><strong>&gt;45 mins:</strong> 50-100% credit (refer to policy for specifics).</li>
                                    </ul>
                                    <blockquote><i class="fas fa-comment-dots"></i> "Thank you for waiting. I see the delay is now [XX] minutes. Based on our policy for this situation, I've gone ahead and processed a [compensation type, e.g., delivery fee refund] for you. You'll see this reflected in your account shortly."</blockquote>
                                </li>
                                <li id="comp_step_3">
                                    <strong>Internal Action & Documentation</strong>
                                    <p>After resolving the issue with the customer, it's crucial to document the incident internally to ensure accountability and process improvement.</p>
                                    <img src="https://placehold.co/600x150/1f2937/d1d5db?text=3.+Document+Internally" alt="Illustration of internal documentation" class="kb-img" loading="lazy">
                                    <ol>
                                        <li>Determine the party responsible for the delay (Store, Driver, or Company).</li>
                                        <li>Apply necessary deductions or penalties in the system as per the policy.</li>
                                        <li>Tag the case with 'delay_compensation' for review by the quality assurance team.</li>
                                    </ol>
                                    <blockquote><i class="fas fa-comment-dots"></i> (Internal Note) Case tagged for QA review. Penalty applied to driver account due to unscheduled stop. Customer compensated with 25% credit.</blockquote>
                                </li>
                            </ol>
                        `,
                        tags: ['compensation', 'customer service', 'delay', 'flow', 'chefz policy', 'sop', 'interactive'],
                        createdAt: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000).toISOString(), 
                    },
                    {
                        id: 'sup_child_example',
                        uuid: 'b2c3d4e5-f6a7-4b8c-9d0e-1f2a3b4c5d6e',
                        type: 'article',
                        parentId: 'sup_flow_compensation',
                        title: 'Child Article: Detailed Scenarios for Driver Responsibility',
                        summary: 'Examples of when a driver is considered responsible for delays.',
                        content: '<p>This article dives deeper into specific situations regarding driver responsibility for order delays.</p><ul><li>Example 1: Driver took an unnecessarily long route.</li><li>Example 2: Driver had multiple unscheduled stops.</li><li>Example 3: Driver did not promptly head to customer after pickup.</li></ul>',
                        tags: ['driver', 'responsibility', 'delay'],
                        createdAt: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(), 
                    }
                ]
            },
            { id: 'partner_care', name: 'Partner Care', icon: 'fas fa-handshake', description: 'Resources for partner management.', iconColor: '#2dd4bf', items: [
                 { id: 'pc_case_01', uuid: 'c3d4e5f6-a7b8-4c9d-0e1f-2a3b4c5d6e7f', type: 'case', title: 'Case: Partner Payment Dispute', summary: 'Investigating a partner claim about incorrect payment.', createdAt: new Date(Date.now() - 20 * 24 * 60 * 60 * 1000).toISOString(), resolution_steps: '<p>1. Verify partner contract. 2. Check payment logs. 3. Escalate to finance if discrepancy found.</p>', status: 'Open' }
            ] }, 
            { id: 'logistics', name: 'Logistics', icon: 'fas fa-truck', description: 'Logistics operations and information.', iconColor: '#4ade80', items: [] }, 
            { id: 'customer_care', name: 'Customer Care', icon: 'fas fa-users', description: 'Customer service guidelines and FAQs.', iconColor: '#a78bfa', items: [] }, 
            { id: 'distribution_followup', name: 'Distribution & Follow-up', icon: 'fas fa-people-carry', description: 'Distribution processes and tracking.', iconColor: '#22d3ee', items: [] }, 
            { id: 'logistics_driver_complaints', name: 'Logistics (Driver Complaints)', icon: 'fas fa-shipping-fast', description: 'Handling driver-related complaints.', iconColor: '#84cc16', items: [] }, 
            { id: 'logistics_3pl', name: 'Logistics-3PL', icon: 'fas fa-boxes-stacked', description: 'Third-party logistics information.', iconColor: '#facc15', items: [] }, 
            { id: 'order_at_store_mac', name: 'Order at Store (Mac)', icon: 'fas fa-store', description: 'Procedures for Mac orders at store.', iconColor: '#f472b6', items: [] }, 
            { id: 'logistics_admin', name: 'Logistics-Admin', icon: 'fas fa-user-shield', description: 'Administrative tasks for logistics.', iconColor: '#fb7185', items: [] }, 
            { id: 'operating_systems', name: 'Operating Systems', icon: 'fab fa-windows', description: 'OS troubleshooting and guides.', iconColor: '#38bdf8', items: [] }, 
            { id: 'compensation_policies', name: 'Compensation Policies', icon: 'fas fa-hand-holding-usd', description: 'Detailed compensation policies.', iconColor: '#f59e0b', items: [
                { id: 'cp_policy_01', uuid: 'd4e5f6a7-b8c9-4d0e-1f2a-3b4c5d6e7f8a', type: 'policy', title: 'General Compensation Policy v2.1', summary: 'The main policy document for all compensation scenarios.', createdAt: new Date(Date.now() - 45 * 24 * 60 * 60 * 1000).toISOString(), content: '<h1>Policy v2.1</h1><p>Details about the compensation policy...</p><pre class="mermaid">graph TD;\nA[Order Delayed > 15m] -->|Yes| B{Check Order Type};\nB -->|FAST Order| C[Apply FAST Tier Matrix];\nB -->|SCHEDULED Order| D[Apply SCHEDULED Tier Matrix];\nA -->|No| E[Apologize & Monitor];\n</pre>' }
            ] }, 
            { id: 'operational_instructions', name: 'Operational Instructions', icon: 'fas fa-clipboard-list', description: 'Standard operating procedures.', iconColor: '#93c5fd', items: [] }, 
            { id: 'forms_templates', name: 'Forms/Templates', icon: 'fas fa-file-alt', description: 'Standard forms and templates.', iconColor: '#a5b4fc', items: [] }
        ]
    };

    // --- DOM Elements ---
    const sidebar = document.getElementById('sidebar');
    const mobileSidebarToggle = document.getElementById('mobileSidebarToggle');
    const navigationMenu = document.getElementById('navigationMenu');
    const currentSectionTitleEl = document.getElementById('currentSectionTitle');
    const breadcrumbsContainer = document.getElementById('breadcrumbs');
    const pageContentArea = document.getElementById('pageContentArea');
    const dashboardOverviewContainer = document.getElementById('dashboardOverviewContainer');
    const standardSectionContentPlaceholder = document.getElementById('standardSectionContentPlaceholder');
    const itemDetailViewPlaceholder = document.getElementById('itemDetailViewPlaceholder');
    const userNameDisplayHeader = document.getElementById('userNameDisplayHeader');
    const userAvatar = document.getElementById('userAvatar');
    const footerKbVersion = document.getElementById('footerKbVersion');
    const currentUserRoleSpan = document.getElementById('currentUserRoleSpan');


    const addContentModalOverlay = document.getElementById('addContentModalOverlay');
    const closeAddContentModalBtn = document.getElementById('closeAddContentModalBtn');
    const addContentForm = document.getElementById('addContentForm');
    const templateSelectionContainer = document.getElementById('templateSelectionContainer');
    const cancelAddContentBtn = document.getElementById('cancelAddContentBtn');
    const contentTypeSelect = document.getElementById('contentType');
    const contentUrlContainer = document.getElementById('contentUrlContainer');
    const contentDetailContainer = document.getElementById('contentDetailContainer');
    const contentDetailLabel = document.getElementById('contentDetailLabel');
    const contentTagsInput = document.getElementById('contentTags');
    const editingItemIdInput = document.getElementById('editingItemId');
    const insertImageBtn = document.getElementById('insertImageBtn');
    const imageFileInput = document.getElementById('imageFile');
    const contentImageUrlInput = document.getElementById('contentImageUrl');

    
    const globalSearchInput = document.getElementById('globalSearchInput');
    const searchResultsContainer = document.getElementById('searchResultsContainer');

    const logoutButton = document.getElementById('logoutButton');
    const logoutConfirmModalOverlay = document.getElementById('logoutConfirmModalOverlay');
    const closeLogoutConfirmModalBtn = document.getElementById('closeLogoutConfirmModalBtn');
    const confirmLogoutBtn = document.getElementById('confirmLogoutBtn');
    const cancelLogoutBtn = document.getElementById('cancelLogoutBtn');

    const reportFeedbackModalOverlay = document.getElementById('reportFeedbackModalOverlay');
    const closeReportFeedbackModalBtn = document.getElementById('closeReportFeedbackModalBtn');
    const reportFeedbackForm = document.getElementById('reportFeedbackForm');
    const cancelFeedbackBtn = document.getElementById('cancelFeedbackBtn');
    const feedbackItemIdInput = document.getElementById('feedbackItemId');
    const feedbackItemTitleInput = document.getElementById('feedbackItemTitle');
    const feedbackItemTitleDisplay = document.getElementById('feedbackItemTitleDisplay');
    const feedbackUserNameInput = document.getElementById('feedbackUserName');
    const feedbackUserEmailInput = document.getElementById('feedbackUserEmail');
    const feedbackCommentTextarea = document.getElementById('feedbackComment');

    // Delete Confirmation Modal Elements
    const deleteConfirmModalOverlay = document.getElementById('deleteConfirmModalOverlay');
    const closeDeleteConfirmModalBtn = document.getElementById('closeDeleteConfirmModalBtn');
    const confirmDeleteItemBtn = document.getElementById('confirmDeleteItemBtn');
    const cancelDeleteItemBtn = document.getElementById('cancelDeleteItemBtn');
    const deleteConfirmMessage = document.getElementById('deleteConfirmMessage');


    let mainQuillEditor; // For the modal
    let flowInPlaceQuillEditor; // For in-place editing of flow content
    /** @type {UserProfile|null} */
    let currentUser = null; 
    let currentOpenItem = null; // Stores { sectionId, itemId, title }
    let visitorsChartInstance, casesChartInstance, articlesChartInstance; 

    // State for interactive flow
    let flowState = {
        isAgentScriptModeActive: localStorage.getItem('infiniBase_agentScriptMode') === 'true',
        expandedSteps: new Set(), // Stores IDs of expanded steps
    };

    // --- Utility Functions ---
    function escapeHTML(str) {
        if (typeof str !== 'string') return '';
        const el = document.createElement('div');
        el.textContent = str;
        return el.innerHTML;
    }

    function highlightText(text, query) {
        if (!text) return '';
        const safeText = escapeHTML(text);
        if (!query) return safeText;
        try {
            const rgx = new RegExp(`(${query.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')})`, 'gi');
            return safeText.replace(rgx, '<mark>$1</mark>');
        } catch (e) { return safeText; }
    }

    function truncateText(text, len) {
        if (!text || text.length <= len) return text;
        return text.substring(0, len) + '...';
    }
    function stripHtml(html){
       if(!html) return "";
       let tmp = document.createElement("DIV");
       tmp.innerHTML = html;
       return tmp.textContent || tmp.innerText || "";
    }

    function showToast(message, type = 'info', duration = 3000) {
        const toastContainer = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast-notification toast-${type}`;
        
        let iconClass = 'fas fa-info-circle';
        if (type === 'success') iconClass = 'fas fa-check-circle';
        else if (type === 'error') iconClass = 'fas fa-times-circle';

        toast.innerHTML = `<i class="toast-icon ${iconClass}"></i> <span>${escapeHTML(message)}</span>`;
        toastContainer.appendChild(toast);

        setTimeout(() => toast.classList.add('show'), 10);

        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, duration);
    }
    
    function applyPermanentDarkMode() { 
        [visitorsChartInstance, casesChartInstance, articlesChartInstance].forEach(chart => {
            if (chart) {
                const legendColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim();
                const ticksColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color-muted').trim();
                const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim();
                
                chart.options.plugins.legend.labels.color = legendColor;
                if (chart.options.scales && chart.options.scales.y) {
                    chart.options.scales.y.ticks.color = ticksColor;
                    chart.options.scales.y.grid.color = gridColor;
                }
                if (chart.options.scales && chart.options.scales.x) { 
                    chart.options.scales.x.ticks.color = ticksColor;
                    chart.options.scales.x.grid.color = gridColor;
                }
                chart.update();
            }
        });
    }

    // --- Sidebar and Navigation ---
    function populateSidebar() {
        let menuHTML = '';
        const mainSections = ['home'];
        const knowledgeAreas = [
            'support', 'partner_care', 'logistics', 'customer_care', 
            'distribution_followup', 'logistics_driver_complaints', 'logistics_3pl', 
            'order_at_store_mac', 'logistics_admin', 'operating_systems'
        ];
        const resourcesPolicies = [
            'compensation_policies', 'operational_instructions', 'forms_templates'
        ];

        menuHTML += `<div class="sidebar-section-title">MAIN</div>`;
        kbSystemData.sections.filter(s => mainSections.includes(s.id)).forEach(section => {
            const iconStyle = section.iconColor ? `style="color: ${section.iconColor};"` : '';
            menuHTML += `<a href="#${section.id}" class="sidebar-link" data-section="${section.id}">
                <i class="${section.icon || 'fas fa-file-alt'}" ${iconStyle}></i>${escapeHTML(section.name)}
            </a>`;
        });
        
        menuHTML += `<div class="sidebar-section-title">KNOWLEDGE AREAS</div>`;
        kbSystemData.sections.filter(s => knowledgeAreas.includes(s.id)).forEach(section => {
            const iconStyle = section.iconColor ? `style="color: ${section.iconColor};"` : '';
            menuHTML += `<a href="#${section.id}" class="sidebar-link" data-section="${section.id}">
                <i class="${section.icon || 'fas fa-folder'}" ${iconStyle}></i>${escapeHTML(section.name)}
            </a>`;
        });

        menuHTML += `<div class="sidebar-section-title">RESOURCES & POLICIES</div>`;
        kbSystemData.sections.filter(s => resourcesPolicies.includes(s.id)).forEach(section => {
            const iconStyle = section.iconColor ? `style="color: ${section.iconColor};"` : '';
            menuHTML += `<a href="#${section.id}" class="sidebar-link" data-section="${section.id}">
                <i class="${section.icon || 'fas fa-book'}" ${iconStyle}></i>${escapeHTML(section.name)}
            </a>`;
        });

        navigationMenu.innerHTML = menuHTML;
    }

    mobileSidebarToggle.addEventListener('click', () => sidebar.classList.toggle('closed'));
    sidebar.addEventListener('click', (e) => {
        if (e.target.closest('.sidebar-link') && window.innerWidth < 768) {
            sidebar.classList.add('closed');
        }
    });

    function highlightSidebarLink(sectionId) {
        document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
        const activeLink = document.querySelector(`.sidebar-link[data-section="${sectionId}"]`);
        if (activeLink) activeLink.classList.add('active');
    }
    
    async function renderMermaidDiagramsInElement(element) {
        const mermaidElements = element.querySelectorAll('pre.mermaid');
        if (mermaidElements.length === 0) return;

        // Temporarily un-hide parents to allow Mermaid to calculate dimensions
        const initiallyHiddenParents = [];
        let currentEl = mermaidElements[0];
        while(currentEl && currentEl !== document.body) {
            if (currentEl.classList.contains('hidden') || (currentEl.style && currentEl.style.display === 'none')) {
                initiallyHiddenParents.unshift(currentEl); // Store from inner to outer
            }
            currentEl = currentEl.parentElement;
        }
        initiallyHiddenParents.forEach(p => {
             if (p.style) p.dataset.originalDisplay = p.style.display;
             p.classList.remove('hidden'); 
             if (p.style) p.style.display = 'block';
        });
        
        try {
            await new Promise(resolve => setTimeout(resolve, 50)); 
            await mermaid.run({ nodes: mermaidElements, suppressErrors: true });
            element.dataset.mermaidRendered = 'true';
        } catch (error) {
            console.error("Mermaid rendering error:", error);
        } finally {
            // Restore original visibility
            initiallyHiddenParents.forEach(p => {
                p.classList.add('hidden');
                if (p.style && p.dataset.originalDisplay) {
                    p.style.display = p.dataset.originalDisplay;
                    delete p.dataset.originalDisplay;
                }
            });
        }
    }


    // --- Content Display ---
    function renderItemCard(item, sectionData) {
        let itemIconClass = 'fas fa-file-alt'; 
        let ctaText = 'View Details';
        let ctaLink = `#${sectionData.id}/${item.id}`;
        let target = '';
        let itemTypeDisplay = item.type.replace(/_/g, ' ');

        switch(item.type) {
            case 'article': itemIconClass = 'fas fa-newspaper'; break;
            case 'case': itemIconClass = 'fas fa-briefcase'; break;
            case 'guide': itemIconClass = 'fas fa-book-open'; break;
            case 'policy': itemIconClass = 'fas fa-gavel'; break;
            case 'interactive_flow': itemIconClass = 'fas fa-project-diagram'; ctaText = 'Start Flow'; break;
            case 'form_sheet':
                itemIconClass = 'fas fa-file-invoice';
                ctaText = 'Open Link';
                ctaLink = item.url || '#';
                target = '_blank';
                break;
            case 'design':
                itemIconClass = 'fas fa-palette';
                ctaText = 'View Design';
                ctaLink = item.url || '#';
                target = '_blank';
                break;
        }

        const cardIconContainerColor = 'var(--primary-color-hover)'; 
        const cardIconColor = 'var(--text-color-inverted)';

        return `
        <div class="card" data-item-id="${item.id}" data-item-type="${item.type}">
            <div class="card-header-icon">
                <div class="card-icon-container" style="background-color: ${cardIconContainerColor};">
                    <i class="${itemIconClass}" style="color: ${cardIconColor};"></i>
                </div>
                <h3>${escapeHTML(item.title)}</h3>
            </div>
            <p>${escapeHTML(truncateText(stripHtml(item.summary), 120))}</p>
            ${item.tags && item.tags.length ? `<div class="card-tags">${item.tags.map(tag => `<span>${escapeHTML(tag)}</span>`).join('')}</div>` : ''}
            <div class="item-meta-info">
                <span class="item-type-badge">${escapeHTML(itemTypeDisplay)}</span>
                <a href="${escapeHTML(ctaLink)}" ${target ? `target="${target}" rel="noopener noreferrer"` : ''} class="item-cta-link"
                   data-item-id="${item.id}" data-section-id="${sectionData.id}" data-item-type="${item.type}">
                   ${ctaText} <i class="fas fa-arrow-right"></i>
                </a>
            </div>
        </div>`;
    }

    async function displayDashboard() {
        dashboardOverviewContainer.classList.remove('hidden');
        standardSectionContentPlaceholder.classList.add('hidden');
        itemDetailViewPlaceholder.classList.add('hidden');
        itemDetailViewPlaceholder.dataset.mermaidRendered = 'false'; 
        currentSectionTitleEl.textContent = 'Dashboard';
        breadcrumbsContainer.innerHTML = `<span style="font-weight: bold; color: var(--primary-color);">Home</span>`;

        if (!currentUser || currentUser.role !== 'admin') {
            dashboardOverviewContainer.innerHTML = `
                <div class="viewer-dashboard-message">
                    <div class="card">
                        <i class="fas fa-user-shield"></i>
                        <h2>Access Restricted</h2>
                        <p>The dashboard overview is available for administrators only.</p>
                        <p class="subtle-note">You can navigate using the sidebar to view knowledge base content.</p>
                    </div>
                </div>
            `;
            return;
        }

        const welcomeUser = currentUser.name || currentUser.email || 'Admin'; 
        const allItems = kbSystemData.sections.flatMap(s => s.items || []);
        const totalArticles = allItems.filter(i => ['article', 'guide', 'policy', 'interactive_flow'].includes(i.type)).length;
        const totalCases = allItems.filter(i => i.type === 'case').length;
        
        kbSystemData.meta.editsThisWeek = Math.floor(Math.random() * 15); 
        if (!kbSystemData.meta.lastArticleAdded && allItems.length > 0) {
            const latestItem = [...allItems].sort((a,b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0))[0];
            if (latestItem) {
                 kbSystemData.meta.lastArticleAdded = { title: latestItem.title, date: new Date(latestItem.createdAt || Date.now()).toLocaleDateString() };
            }
        }
        if (!kbSystemData.meta.lastArticleAdded) {
            kbSystemData.meta.lastArticleAdded = { title: "N/A", date: "N/A" };
        }
        
        const compensationFlowItem = kbSystemData.sections.find(s => s.id === 'support')?.items?.find(i => i.id === 'sup_flow_compensation');

        const mostUsedItemsData = await Promise.all(allItems.map(async item => {
            const viewCount = await Db.getViewCount(item.uuid);
            return { ...item, views: viewCount };
        }));

        const mostUsedArticles = mostUsedItemsData.sort((a,b) => (b.views || 0) - (a.views || 0)).slice(0,3);

        const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
        const recentCases = allItems.filter(i => i.type === 'case' && i.createdAt && new Date(i.createdAt) >= sevenDaysAgo).slice(0,3);
        const sixMonthsAgo = new Date();
        sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
        const articlesNeedingUpdate = allItems.filter(i => i.createdAt && new Date(i.createdAt) < sixMonthsAgo && (i.type === 'article' || i.type === 'policy' || i.type === 'guide')).slice(0,3);


        dashboardOverviewContainer.innerHTML = `
            <div class="card" style="background: linear-gradient(to right, var(--primary-color), #4c1d95); color: white; min-height: auto;">
                <h2 style="font-size: 1.75rem; margin-bottom: 4px;">Welcome back, ${escapeHTML(welcomeUser)}!</h2>
                <p style="opacity: 0.95; font-size: 0.95rem; color: var(--text-color-inverted);">Overview of your knowledge base activity.</p>
            </div>

            <div class="cards-grid md:grid-cols-2 lg:grid-cols-4 my-6">
                <div class="dashboard-stat-card">
                    <i class="fas fa-folder-open"></i>
                    <span class="stat-value">${kbSystemData.sections.length -1}</span>
                    <span class="stat-label">Total Sections</span>
                </div>
                <div class="dashboard-stat-card">
                    <i class="fas fa-newspaper"></i>
                    <span class="stat-value">${totalArticles}</span>
                    <span class="stat-label">Total Articles & Guides</span>
                </div>
                 <div class="dashboard-stat-card">
                    <i class="fas fa-briefcase"></i>
                    <span class="stat-value">${totalCases}</span>
                    <span class="stat-label">Total Cases</span>
                </div>
                <div class="dashboard-stat-card">
                    <i class="fas fa-edit"></i>
                    <span class="stat-value">${kbSystemData.meta.editsThisWeek}</span>
                    <span class="stat-label">Edits This Week</span>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <div class="dashboard-info-card">
                    <h3>🔥 Most Used Articles</h3>
                    <ul>${mostUsedArticles.length ? mostUsedArticles.map(item => `<li><a href="#${kbSystemData.sections.find(s => s.items && s.items.includes(item)).id}/${item.id}">${escapeHTML(item.title)}</a> <span class="meta">(${item.views || 0} views)</span></li>`).join('') : '<li>No data yet.</li>'}</ul>
                </div>
                <div class="dashboard-info-card">
                    <h3>⏳ Articles Needing Update</h3>
                    <ul>${articlesNeedingUpdate.length ? articlesNeedingUpdate.map(item => `<li><a href="#${kbSystemData.sections.find(s => s.items && s.items.includes(item)).id}/${item.id}">${escapeHTML(item.title)}</a> <span class="meta">Created: ${new Date(item.createdAt).toLocaleDateString()}</span></li>`).join('') : '<li>All articles up-to-date.</li>'}</ul>
                </div>
                <div class="dashboard-info-card">
                    <h3>✅ Recent Cases (Last 7 Days)</h3>
                     <ul>${recentCases.length ? recentCases.map(item => `<li><a href="#${kbSystemData.sections.find(s => s.items && s.items.includes(item)).id}/${item.id}">${escapeHTML(item.title)}</a> <span class="meta">Created: ${new Date(item.createdAt).toLocaleDateString()}</span></li>`).join('') : '<li>No recent cases.</li>'}</ul>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card chart-container">
                        <h3>Visitors Activity (Mock)</h3>
                        <canvas id="visitorsChart"></canvas>
                    </div>
                    <div class="card chart-container">
                        <h3>Content Types (Mock)</h3>
                        <canvas id="articlesChart"></canvas>
                    </div>
                </div>
                <div class="dashboard-quicklink-card card" style="min-height: auto;">
                    <h3>Quick Links</h3>
                    <ul>
                        ${compensationFlowItem ? `<li><a href="#support/${compensationFlowItem.id}"><i class="fas fa-project-diagram fa-fw"></i> View Support Flow</a></li>` : ''}
                        <li><a href="#support"><i class="fas fa-headset fa-fw"></i> All Support Articles</a></li>
                        <li><a href="#forms_templates"><i class="fas fa-file-alt fa-fw"></i> Browse Templates</a></li>
                    </ul>
                     <h3 style="margin-top: 1.5rem;">💡 Content Suggestions</h3>
                     <p style="font-size: 0.9rem; color: var(--text-color-subtle);">Consider adding a guide for "New Partner Onboarding" in Partner Care.</p>
                     <h3 style="margin-top: 1.5rem;">Last Added</h3>
                     <p style="font-size: 0.9rem; color: var(--text-color-subtle);">${escapeHTML(kbSystemData.meta.lastArticleAdded.title)} <br><small>(${escapeHTML(kbSystemData.meta.lastArticleAdded.date)})</small></p>
                </div>
            </div>
        `;
        
        const legendColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim();
        const ticksColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color-muted').trim();
        const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim();

        const chartOptions = (type) => ({
            responsive: true, maintainAspectRatio: false,
            plugins: { 
                legend: { 
                    labels: { color: legendColor, font: { family: 'Inter, sans-serif' } },
                    position: 'top', 
                },
                tooltip: {
                    bodyFont: { family: 'Inter, sans-serif' },
                    titleFont: { family: 'Inter, sans-serif' }
                }
            },
            scales: type === 'bar' || type === 'line' ? {
                y: { ticks: { color: ticksColor, beginAtZero: true, font: { family: 'Inter, sans-serif' } }, grid: { color: gridColor } },
                x: { ticks: { color: ticksColor, font: { family: 'Inter, sans-serif' } }, grid: { color: gridColor } }
            } : {}
        });

        if (visitorsChartInstance) visitorsChartInstance.destroy();
        const visitorsCtx = document.getElementById('visitorsChart')?.getContext('2d');
        if (visitorsCtx) {
            visitorsChartInstance = new Chart(visitorsCtx, {
                type: 'line',
                data: { labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'], datasets: [{ label: 'Page Views', data: [65, 59, 80, 81, 56, 55, 40], borderColor: 'rgba(99, 102, 241, 0.8)', backgroundColor: 'rgba(99, 102, 241, 0.2)', tension: 0.3, fill: true }] },
                options: chartOptions('line')
            });
        }

        if (articlesChartInstance) articlesChartInstance.destroy();
        const articlesCtx = document.getElementById('articlesChart')?.getContext('2d');
        if (articlesCtx) {
            const policyCount = allItems.filter(i=>i.type === 'policy').length;
            const guideCount = allItems.filter(i=>i.type === 'guide').length;
            const flowCount = allItems.filter(i=>i.type === 'interactive_flow').length;
            let mainArticleCount = totalArticles - policyCount - guideCount - flowCount;
            if (mainArticleCount < 0) mainArticleCount = 0; 

            articlesChartInstance = new Chart(articlesCtx, {
                type: 'doughnut', 
                data: { labels: ['Articles', 'Cases', 'Flows', 'Guides', 'Policies'], datasets: [{ data: [mainArticleCount, totalCases, flowCount, guideCount, policyCount], backgroundColor: ['#6366f1', '#ec4899', '#10b981', '#22d3ee', '#f59e0b'] }] },
                options: chartOptions('doughnut') 
            });
        }
        applyPermanentDarkMode(); 
    }
    
    function initializeInteractiveHoverItems() {
        const items = document.querySelectorAll('.interactive-hover-item');
        items.forEach(item => {
            const content = item.dataset.content;
            if (!content) return;

            const popout = document.createElement('div');
            popout.className = 'hover-popout';
            popout.innerHTML = content;
            
            item.addEventListener('mouseenter', () => {
                if (!item.contains(popout)) {
                    item.appendChild(popout);
                }
            });

            item.addEventListener('mouseleave', () => {
                if (item.contains(popout)) {
                    item.removeChild(popout);
                }
            });
        });
    }


    async function displaySectionContent(sectionId, subCategoryFilter = null) {
        currentOpenItem = null;
        dashboardOverviewContainer.classList.add('hidden');
        standardSectionContentPlaceholder.classList.remove('hidden');
        itemDetailViewPlaceholder.classList.add('hidden');
        itemDetailViewPlaceholder.dataset.mermaidRendered = 'false'; 

        const sectionData = kbSystemData.sections.find(s => s.id === sectionId);
        if (!sectionData) {
            standardSectionContentPlaceholder.innerHTML = `<div class="card" style="text-align: center;"><h2 style="color: red;">Section not found: ${escapeHTML(sectionId)}</h2></div>`;
            currentSectionTitleEl.textContent = 'Not Found';
            return;
        }

        currentSectionTitleEl.textContent = sectionData.name;
        let bcHTML = `<a href="#home">Home</a> <span style="margin: 0 5px;">›</span> <span style="font-weight: bold; color: var(--primary-color);">${escapeHTML(sectionData.name)}</span>`;
        breadcrumbsContainer.innerHTML = bcHTML;

        let contentHTML = `<div>`;
        
        if (currentUser && currentUser.role === 'admin' && sectionId !== 'home') {
             contentHTML += `
                <div style="text-align: right; margin-bottom: 1.5rem;">
                    <button id="openAddContentBtnInSection" class="button" data-section-id="${sectionData.id}">
                        <i class="fas fa-plus-circle"></i> Add Content to ${escapeHTML(sectionData.name)}
                    </button>
                </div>`;
        }

        const itemsToDisplay = (sectionData.items || [])
            .filter(item => !item.parentId) 
            .filter(item => !subCategoryFilter || (item.tags && item.tags.includes(subCategoryFilter)));
        
        if (itemsToDisplay.length > 0) {
            contentHTML += `<div class="cards-grid">`;
            itemsToDisplay.forEach(item => contentHTML += renderItemCard(item, sectionData));
            contentHTML += `</div>`;
        }
        
        if (sectionId !== 'support' && !subCategoryFilter && sectionData.subCategories && sectionData.subCategories.length > 0) {
            contentHTML += `<h3 style="font-size: 1.5rem; font-weight: 600; margin-top: 30px; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 8px;">Subcategories</h3><div class="cards-grid">`;
            sectionData.subCategories.forEach(subCat => {
                contentHTML += `<a href="#${sectionData.id}/${subCat.id}" class="card" style="text-align: center; text-decoration: none; color: var(--text-color);">
                    <i class="${subCat.icon || sectionData.icon || 'fas fa-folder-open'}" style="font-size: 2rem; display: block; margin-bottom: 10px; color: var(--primary-color);"></i>
                    <h4 style="margin:0; font-weight: 500;">${escapeHTML(subCat.name)}</h4>
                </a>`;
            });
            contentHTML += `</div>`;
        }

        if (itemsToDisplay.length === 0 && (!sectionData.subCategories || sectionData.subCategories.length === 0 || subCategoryFilter)) {
             contentHTML += `<div class="card" style="text-align: center; padding: 40px 20px; min-height: auto;"><p style="font-size: 1.2rem; color: var(--text-color-muted);">No content in this section${subCategoryFilter ? ' or subcategory' : ''} yet.</p></div>`;
        }

        contentHTML += `</div>`;
        standardSectionContentPlaceholder.innerHTML = contentHTML;

        const openAddBtnInSection = document.getElementById('openAddContentBtnInSection');
        if (openAddBtnInSection) {
            openAddBtnInSection.addEventListener('click', (e) => {
                const currentSecId = e.currentTarget.dataset.sectionId;
                openAddContentModal(currentSecId);
            });
        }
    }
    
    function findParentItem(parentId) {
        for (const section of kbSystemData.sections) {
            if (section.items) {
                const parentItem = section.items.find(item => item.id === parentId);
                if (parentItem) {
                    return { ...parentItem, sectionId: section.id };
                }
            }
        }
        return null;
    }

    async function renderComments(itemUuid, commentsContainerId) {
        const commentsContainer = document.getElementById(commentsContainerId);
        if (!commentsContainer) return;

        const comments = await Db.getComments(itemUuid);
        if (!comments || comments.length === 0) {
            commentsContainer.innerHTML = `<p style="color: var(--text-color-muted); padding: 1rem 0;">No comments yet. Be the first to discuss!</p>`;
            return;
        }

        const commentsById = new Map(comments.map(c => [c.id, c]));
        const rootComments = [];
        comments.forEach(c => {
            if (c.parent_id && commentsById.has(c.parent_id)) {
                const parent = commentsById.get(c.parent_id);
                if (!parent.children) parent.children = [];
                parent.children.push(c);
            } else {
                rootComments.push(c);
            }
        });

        const generateCommentHTML = (comment) => {
            const authorName = escapeHTML(comment.author_name || 'Anonymous');
            const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(authorName)}&size=36&background=4b5563&color=fff&rounded=true`;
            return `
                <div class="comment" data-comment-id="${comment.id}">
                    <div class="comment-avatar"><img src="${avatarUrl}" alt="${authorName}"></div>
                    <div class="comment-body">
                        <div class="comment-header">
                            <span class="comment-author">${authorName}</span>
                            <span class="comment-timestamp">${new Date(comment.created_at).toLocaleString()}</span>
                        </div>
                        <div class="comment-text">${escapeHTML(comment.body)}</div>
                        <div class="comment-actions">
                            <button class="reply-btn" data-comment-id="${comment.id}"><i class="fas fa-reply"></i> Reply</button>
                        </div>
                        ${comment.children ? `<div class="comment-replies">${comment.children.map(generateCommentHTML).join('')}</div>` : ''}
                    </div>
                </div>
            `;
        };
        
        commentsContainer.innerHTML = rootComments.map(generateCommentHTML).join('');
        attachCommentActionListeners(itemUuid, commentsContainerId);
    }
    
    function attachCommentActionListeners(itemUuid, containerId) {
        const container = document.getElementById(containerId);
        if (!container) return;
        container.querySelectorAll('.reply-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const commentId = e.currentTarget.dataset.commentId;
                const commentBody = e.currentTarget.closest('.comment-body');
                
                // Remove any existing reply forms
                const existingForm = commentBody.querySelector('.reply-form');
                if (existingForm) {
                    existingForm.remove();
                    return; // Toggle off
                }

                const replyForm = document.createElement('div');
                replyForm.className = 'reply-form';
                replyForm.innerHTML = `
                    <form class="comment-form">
                        <textarea placeholder="Write a reply..." required style="min-height: 60px;"></textarea>
                        <button type="submit" class="button" style="margin-top: 0.5rem; padding: 0.4rem 0.8rem; font-size: 0.8rem;">Post Reply</button>
                    </form>
                `;
                commentBody.appendChild(replyForm);
                const textarea = replyForm.querySelector('textarea');
                textarea.focus();

                replyForm.querySelector('form').addEventListener('submit', async (submitEvent) => {
                    submitEvent.preventDefault();
                    const body = textarea.value.trim();
                    if (!body) return;

                    await Db.postComment({ itemUuid: itemUuid, parentId: commentId, body: body });
                    renderComments(itemUuid, containerId); // Re-render all comments to show the new one
                });
            });
        });
    }


    async function renderInteractiveFlowContent(itemData, sectionId, container) {
        container.innerHTML = ''; // Clear previous content
        
        const flowContainer = document.createElement('div');
        flowContainer.className = 'interactive-flow-container';
        if (flowState.isAgentScriptModeActive) {
            flowContainer.classList.add('agent-script-mode-active');
        }

        const titleBar = document.createElement('div');
        titleBar.className = 'flow-title-bar';
        titleBar.innerHTML = `
            <h2><i class="fas fa-project-diagram"></i> ${escapeHTML(itemData.title)}</h2>
            ${currentUser?.role === 'admin' ? `<div id="flowTopActions">
                <button id="editItemBtn" class="button button-secondary" data-section-id="${sectionId}" data-item-id="${itemData.id}"><i class="fas fa-edit"></i> Edit Flow</button>
            </div>` : ''}`;
        flowContainer.appendChild(titleBar);

        const controlsBar = document.createElement('div');
        controlsBar.className = 'flow-controls';
        controlsBar.innerHTML = `
            <button id="expandAllStepsBtn" class="button button-secondary"><i class="fas fa-expand-arrows-alt"></i> Expand All</button>
            <button id="collapseAllStepsBtn" class="button button-secondary"><i class="fas fa-compress-arrows-alt"></i> Collapse All</button>
            <button id="toggleAgentScriptModeBtn" class="button button-secondary">
                <i class="fas fa-comment-dots"></i> <span id="agentScriptModeBtnText">${flowState.isAgentScriptModeActive ? 'Show Full Detail' : 'Agent Script View'}</span>
            </button>
            <button id="resetFlowProgressBtn" class="button button-secondary"><i class="fas fa-undo"></i> Reset Progress</button>
        `;
        flowContainer.appendChild(controlsBar);
        
        const stepsArea = document.createElement('div');
        stepsArea.className = 'flow-steps-area';
        flowContainer.appendChild(stepsArea);

        const parser = new DOMParser();
        const doc = parser.parseFromString(itemData.content, 'text/html');
        
        // Add summary paragraph if it exists
        const summaryP = doc.querySelector('body > p:first-of-type');
        if (summaryP) {
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'card';
            summaryDiv.style.marginBottom = '1.5rem';
            summaryDiv.style.backgroundColor = 'var(--bg-color)';
            summaryDiv.innerHTML = `<p style="color: var(--text-color-subtle); font-style: italic;">${summaryP.innerHTML}</p>`;
            stepsArea.appendChild(summaryDiv);
            summaryP.remove(); // Don't render it again inside a step
        }

        const mainOl = doc.querySelector('body > ol:first-of-type'); 
        const steps = mainOl ? Array.from(mainOl.children).filter(el => el.tagName === 'LI') : [];
        
        const doneStepsKey = `infiniBase_doneSteps_${itemData.id}`;
        let doneSteps = JSON.parse(localStorage.getItem(doneStepsKey) || '{}');

        steps.forEach((stepLi, index) => {
            const stepId = stepLi.id || `${itemData.id}_auto_step_${index}`;
            
            const stepCard = document.createElement('div');
            stepCard.className = 'step-card';
            stepCard.id = stepId;
            stepCard.dataset.stepId = stepId; // Add for event delegation
            if (doneSteps[stepId]) stepCard.classList.add('done');

            if (flowState.expandedSteps.has(stepId)) {
                stepCard.classList.add('expanded');
            }

            let stepTitleText = `Step ${index + 1}`;
            const strongTitle = stepLi.querySelector('strong:first-child');
            if (strongTitle) {
                stepTitleText = strongTitle.textContent.trim();
                strongTitle.remove(); // Remove from content to avoid duplication
            }

            const stepHeader = document.createElement('div');
            stepHeader.className = 'step-header';
            stepHeader.innerHTML = `
                <div class="step-header-main">
                    <span class="step-number">Step ${index + 1}:</span>
                    <span class="step-title">${escapeHTML(stepTitleText)}</span>
                </div>
                <div class="step-header-actions">
                    <button class="mark-step-done-btn ${doneSteps[stepId] ? 'done' : ''}">
                        <i class="fas ${doneSteps[stepId] ? 'fa-check-circle' : 'fa-circle'}"></i> 
                        <span class="mark-step-text">${doneSteps[stepId] ? 'Done' : 'Mark Done'}</span>
                    </button>
                    <button class="toggle-step-details-btn"><i class="fas fa-chevron-down"></i></button>
                </div>
            `;

            const stepBody = document.createElement('div');
            stepBody.className = 'step-body';
            
            const cleanStepLiContent = stepLi.cloneNode(true);
            cleanStepLiContent.querySelectorAll('blockquote').forEach(bq => {
                const scriptTextForCopy = bq.textContent.trim();
                bq.classList.add('agent-script-block');
                const copyBtn = document.createElement('button');
                copyBtn.className = 'copy-script-btn';
                copyBtn.innerHTML = '<i class="fas fa-copy"></i> Copy';
                copyBtn.title = 'Copy script';
                copyBtn.onclick = (e) => {
                    e.stopPropagation();
                    navigator.clipboard.writeText(scriptTextForCopy)
                        .then(() => showToast('Script copied!', 'success'))
                        .catch(err => console.error('Failed to copy script: ', err));
                };
                bq.appendChild(copyBtn);
            });
            // Ensure images have the correct class and lazy loading
            cleanStepLiContent.querySelectorAll('img').forEach(img => {
                img.classList.add('kb-img');
                img.loading = 'lazy';
            });
            stepBody.innerHTML = `<div class="kb-content">${cleanStepLiContent.innerHTML}</div>`;
            
            stepCard.appendChild(stepHeader);
            stepCard.appendChild(stepBody);
            stepsArea.appendChild(stepCard);
        });
        
        // Handle Important Notes card
        const notesElement = doc.querySelector('.important-notes-card');
        if (notesElement) {
             flowContainer.appendChild(notesElement.cloneNode(true));
        }

        container.appendChild(flowContainer);

        // --- FIXED: Event Delegation for Step Cards ---
        stepsArea.addEventListener('click', (e) => {
            const stepHeader = e.target.closest('.step-header');
            if (!stepHeader) return;

            const stepCard = stepHeader.closest('.step-card');
            const stepId = stepCard.dataset.stepId;

            // Handle "Mark as Done" button
            if (e.target.closest('.mark-step-done-btn')) {
                e.stopPropagation();
                const markBtn = e.target.closest('.mark-step-done-btn');
                doneSteps[stepId] = !doneSteps[stepId];
                localStorage.setItem(doneStepsKey, JSON.stringify(doneSteps));
                markBtn.classList.toggle('done', doneSteps[stepId]);
                stepCard.classList.toggle('done', doneSteps[stepId]);
                markBtn.querySelector('i').className = `fas ${doneSteps[stepId] ? 'fa-check-circle' : 'fa-circle'}`;
                markBtn.querySelector('.mark-step-text').textContent = doneSteps[stepId] ? 'Done' : 'Mark Done';
                return;
            }

            // Handle header click for expand/collapse
            stepCard.classList.toggle('expanded');
            if (stepCard.classList.contains('expanded')) {
                flowState.expandedSteps.add(stepId);
            } else {
                flowState.expandedSteps.delete(stepId);
            }
        });


        // Add event listeners for flow controls
        const expandAllBtn = document.getElementById('expandAllStepsBtn');
        if(expandAllBtn) expandAllBtn.addEventListener('click', () => {
            stepsArea.querySelectorAll('.step-card:not(.expanded)').forEach(sc => sc.classList.add('expanded'));
        });
        
        const collapseAllBtn = document.getElementById('collapseAllStepsBtn');
        if(collapseAllBtn) collapseAllBtn.addEventListener('click', () => {
            stepsArea.querySelectorAll('.step-card.expanded').forEach(sc => sc.classList.remove('expanded'));
        });

        const toggleAgentModeBtn = document.getElementById('toggleAgentScriptModeBtn');
        if(toggleAgentModeBtn) toggleAgentModeBtn.addEventListener('click', () => {
            flowState.isAgentScriptModeActive = !flowState.isAgentScriptModeActive;
            localStorage.setItem('infiniBase_agentScriptMode', flowState.isAgentScriptModeActive);
            flowContainer.classList.toggle('agent-script-mode-active', flowState.isAgentScriptModeActive);
            const btnText = document.getElementById('agentScriptModeBtnText');
            if(btnText) btnText.textContent = flowState.isAgentScriptModeActive ? 'Show Full Detail' : 'Agent Script View';
        });
        
        const resetProgressBtn = document.getElementById('resetFlowProgressBtn');
        if(resetProgressBtn) resetProgressBtn.addEventListener('click', () => {
             localStorage.removeItem(doneStepsKey);
             doneSteps = {};
             stepsArea.querySelectorAll('.step-card.done').forEach(sc => {
                sc.classList.remove('done');
                const btn = sc.querySelector('.mark-step-done-btn');
                btn.classList.remove('done');
                btn.querySelector('i').className = 'fas fa-circle';
                btn.querySelector('.mark-step-text').textContent = 'Mark Done';
             });
             showToast('Flow progress has been reset.', 'info');
        });

        const editBtn = flowContainer.querySelector('#editItemBtn');
        if(editBtn) editBtn.addEventListener('click', (e) => {
            const sId = e.currentTarget.dataset.sectionId;
            const iId = e.currentTarget.dataset.itemId;
            const item = kbSystemData.sections.find(s => s.id === sId)?.items?.find(i => i.id === iId);
            if (item) openAddContentModal(sId, item);
        });
    }

    async function downloadItemAsPDF(itemToDownload) {
        if (!itemToDownload || !itemToDownload.title) {
            showToast('Error preparing PDF: Item data is missing.', 'error');
            return;
        }
        const filename = `${itemToDownload.title.replace(/[^a-z0-9_]+/gi, '_').toLowerCase()}.pdf`;
        showToast('Generating PDF, please wait...', 'info', 5000);

        const element = document.getElementById('itemDetailViewPlaceholder');
        if (!element) {
            showToast('Error preparing PDF: Content area not found.', 'error');
            return;
        }
        
        const elementToPrint = element.cloneNode(true);
        elementToPrint.querySelectorAll('.step-card:not(.expanded)').forEach(sc => sc.classList.add('expanded'));
        
        const selectorsToRemove = [
            '.item-actions-bar', '.flow-controls', '.item-feedback-section', 
            '.comments-section', '#flowInPlaceEditorContainer', '.copy-script-btn',
            '.mark-step-done-btn', '.toggle-step-details-btn', '.hover-popout'
        ];
        selectorsToRemove.forEach(selector => {
            elementToPrint.querySelectorAll(selector).forEach(el => el.remove());
        });
        
        elementToPrint.style.position = 'absolute';
        elementToPrint.style.left = '-9999px';
        elementToPrint.style.width = "210mm"; 
        elementToPrint.style.backgroundColor = "white"; 
        document.body.appendChild(elementToPrint);

        if (elementToPrint.querySelector('pre.mermaid')) {
            await renderMermaidDiagramsInElement(elementToPrint);
        }
        
        const opt = {
            margin:       [10, 10, 10, 10],
            filename:     filename,
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 2, logging: false, useCORS: true },
            jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
            pagebreak:    { mode: ['avoid-all', 'css', 'legacy'] }
        };

        try {
            await html2pdf().from(elementToPrint).set(opt).save();
        } catch (error) {
            console.error("Error generating PDF:", error);
            showToast('Error generating PDF. Check console.', 'error');
        } finally {
             document.body.removeChild(elementToPrint);
        }
    }


    async function displayItemDetail(sectionId, itemId) {
        const sectionData = kbSystemData.sections.find(s => s.id === sectionId);
        const itemData = sectionData?.items?.find(i => i.id === itemId);

        if (!sectionData || !itemData) {
            itemDetailViewPlaceholder.innerHTML = `<div class="card"><p style="color: red;">Error: Item not found.</p></div>`;
            return;
        }

        // Log the view in the database using the UUID
        await Db.logView(itemData.uuid);
        
        currentOpenItem = { sectionId, itemId, title: itemData.title };
        itemDetailViewPlaceholder.dataset.mermaidRendered = 'false'; 

        dashboardOverviewContainer.classList.add('hidden');
        standardSectionContentPlaceholder.classList.add('hidden');
        itemDetailViewPlaceholder.classList.remove('hidden');
        itemDetailViewPlaceholder.innerHTML = ''; // Clear previous content

        let bcHTML = `
            <a href="#home">Home</a> <span style="margin: 0 5px;">›</span>
            <a href="#${sectionData.id}">${escapeHTML(sectionData.name)}</a> <span style="margin: 0 5px;">›</span>
            <span style="font-weight: bold; color: var(--primary-color);">${escapeHTML(itemData.title)}</span>`;
        breadcrumbsContainer.innerHTML = bcHTML;
        currentSectionTitleEl.textContent = itemData.title;

        let actionsBarHTML = `<div class="item-actions-bar">
                                <button id="backToSectionBtn" class="button button-secondary">
                                    <i class="fas fa-arrow-left"></i> Back to ${escapeHTML(sectionData.name)}
                                </button>`;
        if (itemData.parentId) {
            const parentItemFull = findParentItem(itemData.parentId);
            if (parentItemFull) {
                actionsBarHTML += `<button id="backToParentBtn" class="button button-secondary" data-parent-section="${parentItemFull.sectionId}" data-parent-id="${parentItemFull.id}">
                                <i class="fas fa-level-up-alt"></i> Back to Parent
                               </button>`;
            }
        }
        if (currentUser?.role === 'admin' && itemData.type !== 'interactive_flow') {
             actionsBarHTML += `<button id="editItemBtn" class="button" data-section-id="${sectionId}" data-item-id="${itemId}"><i class="fas fa-edit"></i> Edit</button>`;
        }
        if (currentUser?.role === 'admin') {
             actionsBarHTML += `<button id="deleteItemBtn" class="button button-danger" data-section-id="${sectionId}" data-item-id="${itemId}" data-item-title="${escapeHTML(itemData.title)}"><i class="fas fa-trash-alt"></i> Delete</button>`;
        }
        actionsBarHTML += `<button id="printItemBtn" class="button button-secondary"><i class="fas fa-print"></i> Print</button>
                           <button id="downloadPdfItemBtn" class="button button-secondary"><i class="fas fa-file-pdf"></i> PDF</button>
                           <button id="shareItemBtn" class="button button-secondary"><i class="fas fa-share-alt"></i> Share</button>
                         </div>`;
        itemDetailViewPlaceholder.innerHTML += actionsBarHTML;


        if (itemData.type === 'interactive_flow') {
            await renderInteractiveFlowContent(itemData, sectionId, itemDetailViewPlaceholder);
        } else {
            let itemIconClass = 'fas fa-file-alt';
            switch (itemData.type) {
                case 'case': itemIconClass = 'fas fa-briefcase'; break;
                case 'article': itemIconClass = 'fas fa-newspaper'; break;
                case 'guide': itemIconClass = 'fas fa-book-open'; break;
                case 'policy': itemIconClass = 'fas fa-gavel'; break;
            }

            let detailHTML = `<div class="card">
                    <div class="item-title-area">
                        <i class="${itemIconClass} fa-title-icon"></i>
                        <h2>${escapeHTML(itemData.title)}</h2>
                    </div>
                    <p class="item-summary">${escapeHTML(stripHtml(itemData.summary))}</p>
                    ${itemData.tags && itemData.tags.length ? `<div class="card-tags" style="margin-bottom: 1rem;">${itemData.tags.map(tag => `<span>${escapeHTML(tag)}</span>`).join('')}</div>` : ''}
                    <hr class="title-content-divider">
                    <div class="kb-content">${itemData.content || itemData.resolution_steps || '<p>No detailed content.</p>'}</div>
                </div>`;
            itemDetailViewPlaceholder.innerHTML += detailHTML;
        }

        const childItems = kbSystemData.sections.flatMap(s => s.items || [])
                               .filter(child => child.parentId === itemData.id)
                               .map(child => ({...child, sectionId: kbSystemData.sections.find(s => s.items?.includes(child))?.id }));

        if (childItems.length > 0) {
            let childItemsHTML = `<div class="card" style="margin-top: 1.5rem;">
                            <h3 style="font-size: 1.25rem; font-weight:600; margin-bottom:1rem;">Related Items</h3>
                            <ul class="child-items-list">`;
            childItems.forEach(child => {
                 childItemsHTML += `<li><a href="#${child.sectionId}/${child.id}"><i class="fas fa-angle-right"></i> ${escapeHTML(child.title)} (${escapeHTML(child.type)})</a></li>`;
            });
            childItemsHTML += `</ul></div>`;
            itemDetailViewPlaceholder.innerHTML += childItemsHTML;
        }
        
        // Fetch real view count using UUID
        const viewCount = await Db.getViewCount(itemData.uuid);

        let commonSectionsHTML = `
            <div class="item-feedback-section card">
                <h4>Was this content helpful?</h4>
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                    <div class="rating-buttons">
                        <button id="rateUpBtn"><i class="fas fa-thumbs-up"></i> Helpful</button>
                        <button id="rateDownBtn"><i class="fas fa-thumbs-down"></i> Not Helpful</button>
                    </div>
                    <span id="readStatsContainer" class="read-stats">(Total Reads: ${viewCount})</span>
                </div>
                <button id="reportFeedbackForItemBtn" class="button button-secondary" data-item-uuid="${itemData.uuid}" data-item-title="${escapeHTML(itemData.title)}"><i class="fas fa-flag"></i> Report another issue</button>
            </div>
            <div class="comments-section card" style="margin-top: 1.5rem;">
                <h4><i class="fas fa-comments"></i> Comments & Discussion</h4>
                <div class="comment-display-area" id="commentDisplayAreaForItem"></div>
                <form id="commentForm" class="comment-form" style="margin-top: 1rem; border-top: 1px solid var(--border-color); padding-top: 1.5rem;">
                    <textarea id="newCommentText" placeholder="Add a comment..." required></textarea>
                    <button id="postCommentBtn" type="submit" class="button"><i class="fas fa-paper-plane"></i> Post Comment</button>
                </form>
            </div>`;
        itemDetailViewPlaceholder.innerHTML += commonSectionsHTML;
        await renderComments(itemData.uuid, 'commentDisplayAreaForItem');
        
        if (itemDetailViewPlaceholder.querySelector('pre.mermaid') && itemDetailViewPlaceholder.dataset.mermaidRendered !== 'true') {
            await renderMermaidDiagramsInElement(itemDetailViewPlaceholder);
        }
        initializeInteractiveHoverItems();
        
        // --- Attach Common Event Listeners (with null checks) ---
        const backToSectionBtn = document.getElementById('backToSectionBtn');
        if (backToSectionBtn) backToSectionBtn.addEventListener('click', () => window.location.hash = `#${sectionId}`);
        
        const backToParentBtn = document.getElementById('backToParentBtn');
        if (backToParentBtn) {
            backToParentBtn.addEventListener('click', (e) => window.location.hash = `#${e.currentTarget.dataset.parentSection}/${e.currentTarget.dataset.parentId}`);
        }
        
        const editBtn = document.getElementById('editItemBtn');
        if(editBtn) editBtn.addEventListener('click', (e) => {
            openAddContentModal(e.currentTarget.dataset.sectionId, itemData);
        });
        
        const deleteBtn = document.getElementById('deleteItemBtn');
        if(deleteBtn) deleteBtn.addEventListener('click', (e) => {
            openDeleteConfirmModal(e.currentTarget.dataset.sectionId, e.currentTarget.dataset.itemId, e.currentTarget.dataset.itemTitle);
        });
        
        const printBtn = document.getElementById('printItemBtn');
        if(printBtn) printBtn.addEventListener('click', () => window.print());

        const shareBtn = document.getElementById('shareItemBtn');
        if(shareBtn) shareBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(window.location.href)
                .then(() => showToast('Link copied!', 'success'))
                .catch(() => showToast('Failed to copy.', 'error'));
        });
        
        const downloadPdfBtn = document.getElementById('downloadPdfItemBtn');
        if(downloadPdfBtn) downloadPdfBtn.addEventListener('click', () => downloadItemAsPDF(itemData));
        
        // Feedback button listeners
        const rateUpBtn = document.getElementById('rateUpBtn');
        const rateDownBtn = document.getElementById('rateDownBtn');
        if(rateUpBtn) rateUpBtn.addEventListener('click', async () => {
            await Db.postFeedback({ itemUuid: itemData.uuid, rating: 1 });
            showToast('Thanks for your feedback!', 'success');
            rateUpBtn.classList.add('active');
            if(rateDownBtn) rateDownBtn.classList.remove('active');
        });
        if(rateDownBtn) rateDownBtn.addEventListener('click', () => {
            const reason = prompt("Sorry to hear that. What could be improved?");
            if (reason !== null) { // User didn't cancel prompt
                Db.postFeedback({ itemUuid: itemData.uuid, rating: 0, reason: reason });
                showToast('Thanks! We will review this content.', 'info');
                rateDownBtn.classList.add('active');
                if(rateUpBtn) rateUpBtn.classList.remove('active');
            }
        });

        const reportFeedbackBtn = document.getElementById('reportFeedbackForItemBtn');
        if(reportFeedbackBtn) reportFeedbackBtn.addEventListener('click', (e) => {
            // This modal is separate, using its own logic. Ensure it has what it needs.
            openReportFeedbackModal(e.currentTarget.dataset.itemUuid, e.currentTarget.dataset.itemTitle);
        });

        // Comment form listener
        const commentForm = document.getElementById('commentForm');
        if(commentForm) commentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const commentTextEl = document.getElementById('newCommentText');
            const body = commentTextEl.value.trim();
            if (!body) return;
            
            await Db.postComment({ itemUuid: itemData.uuid, body });
            commentTextEl.value = ''; 
            showToast('Comment posted!', 'success');
            await renderComments(itemData.uuid, 'commentDisplayAreaForItem');
        });
    }

    const contentTemplates = {
        standard_article: {
            type: 'article', titlePrefix: 'New Article: ',
            summary: 'A general article about [topic].',
            content: `<h2>Introduction</h2><p>[Provide a brief introduction.]</p><h2>Main Content</h2><p>[Elaborate here.]</p>`,
            tags: ['article']
        },
        troubleshooting_guide: {
            type: 'case', titlePrefix: 'Case: Troubleshooting ',
            summary: 'A step-by-step guide to resolve [issue].',
            content: `<h3>Case Description</h3><p>[Describe the problem.]</p><h3>Resolution Steps</h3><ol><li><strong>Step 1:</strong> [Action to take]</li></ol>`,
            tags: ['troubleshooting', 'guide', 'case']
        },
        interactive_flow: {
            type: 'interactive_flow', titlePrefix: 'Flow: ',
            summary: 'An interactive, step-by-step process for agents to follow regarding [process name].',
            content: `<p>This is an interactive guide. Follow the steps below.</p><ol><li id="flow_step_1"><strong>Step One Title</strong><p>Description of the first step.</p><blockquote>Agent script for step one.</blockquote></li><li id="flow_step_2"><strong>Step Two Title</strong><p>Description of the second step.</p><blockquote>Agent script for step two.</blockquote></li></ol>`,
            tags: ['flow', 'interactive', 'sop']
        },
        policy_document: {
            type: 'policy', titlePrefix: 'Policy: ',
            summary: 'Official policy regarding [subject matter].',
            content: `<h1>[Policy Title]</h1><p><strong>Version:</strong> 1.0</p><h2>1. Purpose</h2><p>[State the purpose.]</p>`,
            tags: ['policy', 'official']
        },
        blank: {
            type: 'article', titlePrefix: '', summary: '',
            content: `<p><br></p>`, tags: []
        }
    };

    function applyTemplate(templateKey) {
        const template = contentTemplates[templateKey];
        if (!template) return;

        contentTypeSelect.value = template.type;
        document.getElementById('contentTitle').value = template.titlePrefix;
        document.getElementById('contentSummary').value = template.summary;
        if (mainQuillEditor) mainQuillEditor.root.innerHTML = template.content;
        contentTagsInput.value = template.tags.join(', ');
        
        addContentForm.classList.remove('hidden');
        templateSelectionContainer.classList.add('hidden');
        contentTypeSelect.dispatchEvent(new Event('change')); 
        document.getElementById('contentTitle').focus();
    }


    // --- Add Content Modal Logic ---
    function openAddContentModal(sectionIdForContent, itemToEdit = null) {
        addContentForm.reset();
        addContentForm.dataset.sectionId = sectionIdForContent;
        editingItemIdInput.value = ""; 
        
        if (!mainQuillEditor) {
            mainQuillEditor = new Quill('#quillEditor', { 
                theme: 'snow',
                modules: { 
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ 'color': [] }, { 'background': [] }],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        [{ 'align': [] }],
                        ['link', 'image', 'video', 'blockquote', 'code-block'], 
                        ['clean']
                    ]
                },
                placeholder: 'Enter detailed content here...'
            });
        }
        mainQuillEditor.root.innerHTML = '<p><br></p>'; 

        if (itemToEdit) {
            document.getElementById('addContentModalTitle').textContent = 'Edit Content';
            editingItemIdInput.value = itemToEdit.id; 
            document.getElementById('contentTitle').value = itemToEdit.title;
            document.getElementById('contentSummary').value = itemToEdit.summary;
            contentTypeSelect.value = itemToEdit.type;
            if (itemToEdit.url) document.getElementById('contentUrl').value = itemToEdit.url;
            
            let contentToEdit = itemToEdit.content || itemToEdit.resolution_steps;
            mainQuillEditor.root.innerHTML = contentToEdit || '<p><br></p>';
            
            contentTagsInput.value = (itemToEdit.tags || []).join(', ');
            
            if (itemToEdit.attachments) {
                if(itemToEdit.attachments.video) document.getElementById('videoLink').value = itemToEdit.attachments.video;
                if(itemToEdit.attachments.drive) document.getElementById('driveLink').value = itemToEdit.attachments.drive;
            }
            templateSelectionContainer.classList.add('hidden');
            addContentForm.classList.remove('hidden');
            document.getElementById('contentTitle').focus();
        } else {
            document.getElementById('addContentModalTitle').textContent = 'Add New Content';
            templateSelectionContainer.classList.remove('hidden');
            addContentForm.classList.add('hidden');
        }
        
        contentTypeSelect.dispatchEvent(new Event('change'));
        addContentModalOverlay.classList.remove('hidden');
    }

    document.querySelectorAll('.template-button').forEach(button => {
        button.addEventListener('click', () => applyTemplate(button.dataset.template));
    });

    insertImageBtn.addEventListener('click', () => {
        const url = contentImageUrlInput.value.trim();
        if (url && mainQuillEditor) {
            try {
                new URL(url); // Basic validation
                const range = mainQuillEditor.getSelection(true);
                mainQuillEditor.insertEmbed(range.index, 'image', url, 'user');
                mainQuillEditor.formatText(range.index, 1, { class: 'kb-img', loading: 'lazy' });
                contentImageUrlInput.value = '';
                showToast('Image inserted from URL.', 'success');
            } catch (_) {
                showToast('Please enter a valid URL.', 'error');
            }
        }
    });


    function closeAddContentModal() {
        addContentModalOverlay.classList.add('hidden');
    }

    contentTypeSelect.addEventListener('change', (e) => {
        const type = e.target.value;
        const isLinkType = (type === 'form_sheet' || type === 'design');
        
        contentUrlContainer.classList.toggle('hidden', !isLinkType);
        contentDetailContainer.classList.toggle('hidden', isLinkType);
        
        switch(type) {
            case 'case': contentDetailLabel.textContent = 'Case Details / Resolution Steps'; break;
            case 'interactive_flow': contentDetailLabel.textContent = 'Flow Content (use ordered list for steps)'; break;
            default: contentDetailLabel.textContent = 'Details / Content'; break;
        }
    });

    addContentForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const sectionId = addContentForm.dataset.sectionId;
        const section = kbSystemData.sections.find(s => s.id === sectionId);
        if (!section) { showToast('Error: Target section not found!', 'error'); return; }
        
        const editingId = editingItemIdInput.value;
        const title = document.getElementById('contentTitle').value.trim();
        if (!title) { showToast('Title is required.', 'error'); return; }

        let itemData;
        if (editingId) { 
            itemData = section.items.find(i => i.id === editingId);
            if (!itemData) { showToast('Error: Item to edit not found!', 'error'); return; }
        } else {
            itemData = {
                id: `${sectionId}_item_${Date.now()}`,
                uuid: 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
                    const r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                }), // Generate new UUID for new item
                createdBy: currentUser.email, createdAt: new Date().toISOString()
            };
        }

        Object.assign(itemData, {
            type: contentTypeSelect.value,
            title: title,
            summary: document.getElementById('contentSummary').value.trim(),
            tags: contentTagsInput.value.split(',').map(t => t.trim()).filter(Boolean),
            lastModified: new Date().toISOString()
        });
        
        if (itemData.type === 'case') {
            itemData.resolution_steps = mainQuillEditor.root.innerHTML;
            itemData.status = itemData.status || 'New'; 
        } else if (['article', 'guide', 'policy', 'interactive_flow'].includes(itemData.type)) {
            itemData.content = mainQuillEditor.root.innerHTML;
        } else if (['form_sheet', 'design'].includes(itemData.type)) {
            itemData.url = document.getElementById('contentUrl').value.trim();
        }

        itemData.attachments = itemData.attachments || {};
        const pdfFile = document.getElementById('pdfFile').files[0];
        if (pdfFile) itemData.attachments.pdf = `simulated_uploads/${pdfFile.name}`; 
        itemData.attachments.video = document.getElementById('videoLink').value.trim() || undefined;
        itemData.attachments.drive = document.getElementById('driveLink').value.trim() || undefined;

        if (!editingId) { 
            if (!section.items) section.items = [];
            section.items.unshift(itemData); // Add to top
            kbSystemData.meta.lastArticleAdded = { title: itemData.title, date: new Date(itemData.createdAt).toLocaleDateString() };
        }

        showToast(`Content '${itemData.title}' ${editingId ? 'updated' : 'saved'}!`, 'success');
        closeAddContentModal();
        
        if (editingId && currentOpenItem?.itemId === editingId) {
            handleNavigation();
        } else {
            window.location.hash = `#${sectionId}`; 
        }
    });

    // --- Report Feedback Modal Logic ---
    function openReportFeedbackModal(itemUuid, itemTitle) {
        if (!currentUser) { showToast('Please login to report feedback.', 'error'); return; }
        reportFeedbackForm.reset();
        feedbackItemIdInput.value = itemUuid; // Storing UUID now
        feedbackItemTitleDisplay.textContent = itemTitle; 
        feedbackUserNameInput.value = currentUser.name || '';
        feedbackUserEmailInput.value = currentUser.email || '';
        reportFeedbackModalOverlay.classList.remove('hidden');
        feedbackCommentTextarea.focus();
    }

    function closeReportFeedbackModal() {
        reportFeedbackModalOverlay.classList.add('hidden');
    }

    reportFeedbackForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const itemUuid = feedbackItemIdInput.value;
        const comment = feedbackCommentTextarea.value.trim();
        if (!comment) { showToast('Please enter your feedback.', 'error'); return; }

        // This now uses the Db module correctly
        await Db.postFeedback({ itemUuid: itemUuid, rating: 0, reason: `Reported Issue: ${comment}` });
        showToast('Feedback submitted. Thank you!', 'success');
        
        closeReportFeedbackModal();
    });
    
    // --- Delete Confirmation Modal Logic ---
    function openDeleteConfirmModal(sectionId, itemId, itemTitle) {
        deleteConfirmMessage.innerHTML = `Delete "<strong>${escapeHTML(itemTitle)}</strong>"?<br>This action cannot be undone.`;
        confirmDeleteItemBtn.dataset.sectionId = sectionId;
        confirmDeleteItemBtn.dataset.itemId = itemId;
        deleteConfirmModalOverlay.classList.remove('hidden');
    }

    closeDeleteConfirmModalBtn.addEventListener('click', () => deleteConfirmModalOverlay.classList.add('hidden'));
    cancelDeleteItemBtn.addEventListener('click', () => deleteConfirmModalOverlay.classList.add('hidden'));

    confirmDeleteItemBtn.addEventListener('click', () => {
        const { sectionId, itemId } = confirmDeleteItemBtn.dataset;
        const section = kbSystemData.sections.find(s => s.id === sectionId);

        if (section?.items) {
            const itemIndex = section.items.findIndex(item => item.id === itemId);
            if (itemIndex > -1) {
                const deletedItemTitle = section.items[itemIndex].title;
                section.items.splice(itemIndex, 1);
                showToast(`Item "${deletedItemTitle}" deleted.`, 'success');
                deleteConfirmModalOverlay.classList.add('hidden');
                window.location.hash = `#${sectionId}`;
            }
        }
    });


    // --- Global Search ---
    globalSearchInput.addEventListener('input', () => {
        const query = globalSearchInput.value.trim().toLowerCase();
        if (query.length < 2) {
            searchResultsContainer.classList.add('hidden');
            return;
        }
        const results = [];
        kbSystemData.sections.forEach(s => {
            if (s.id === 'home') return; 
            s.items?.forEach(i => {
                const contentToSearch = [i.title, stripHtml(i.summary), stripHtml(i.content), stripHtml(i.resolution_steps), ...(i.tags || [])].join(' ').toLowerCase();
                if (contentToSearch.includes(query)) {
                    results.push({ ...i, sectionId: s.id, sectionName: s.name });
                }
            });
        });
        
        if (results.length) {
            searchResultsContainer.innerHTML = results.slice(0, 7).map(r => `
                <a href="#${r.sectionId}/${r.id}">
                    <div style="font-weight: bold;">${highlightText(r.title, query)}
                        <span style="font-size: 0.8em; color: var(--text-color-muted); margin-left: 5px;">(${escapeHTML(r.type.replace('_', ' '))})</span>
                    </div>
                    <p style="font-size: 0.9em; color: var(--text-color-subtle); margin: 0;">${highlightText(truncateText(stripHtml(r.summary || r.content), 70), query)}</p>
                </a>`).join('');
            searchResultsContainer.classList.remove('hidden');
        } else {
            searchResultsContainer.innerHTML = `<div style="padding: 10px; color: var(--text-color-muted);">No results.</div>`;
            searchResultsContainer.classList.remove('hidden');
        }
    });
    searchResultsContainer.addEventListener('click', () => { // Hide on result click
        searchResultsContainer.classList.add('hidden');
        globalSearchInput.value = '';
    });
    document.addEventListener('click', e => {
        if (!e.target.closest('.search-container')) {
            searchResultsContainer.classList.add('hidden');
        }
    });
    
    // --- Routing and Initialization ---
    function handleNavigation() {
        if (!currentUser) { 
            console.log("User not loaded, deferring navigation.");
            return;
        }
        const hash = window.location.hash.substring(1) || 'home';
        const [sectionId, itemId] = hash.split('/');
        
        highlightSidebarLink(sectionId);
        itemDetailViewPlaceholder.dataset.mermaidRendered = 'false'; 

        if (sectionId === 'home') {
            displayDashboard(); 
        } else if (itemId) { 
            displayItemDetail(sectionId, itemId);
        } else {
            displaySectionContent(sectionId);
        }
        document.getElementById('contentWrapper')?.scrollTo(0,0);
    }

    async function initializeApp() {
        currentUser = await Auth.getCurrentUserProfile(); 
        if (!currentUser) { return; }

        const displayName = currentUser.name || currentUser.email.split('@')[0];
        userNameDisplayHeader.textContent = displayName;
        userAvatar.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&size=36&background=6366f1&color=fff&rounded=true&font-size=0.5`;
        footerKbVersion.textContent = kbSystemData.meta.version;
        currentUserRoleSpan.textContent = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
        
        populateSidebar();
        handleNavigation(); 
        window.addEventListener('hashchange', handleNavigation);
        
        // Modal & Global Listeners
        logoutButton.addEventListener('click', () => logoutConfirmModalOverlay.classList.remove('hidden'));
        [closeLogoutConfirmModalBtn, cancelLogoutBtn].forEach(btn => btn.addEventListener('click', () => logoutConfirmModalOverlay.classList.add('hidden')));
        confirmLogoutBtn.addEventListener('click', Auth.logout);
        
        [closeAddContentModalBtn, cancelAddContentBtn].forEach(btn => btn.addEventListener('click', closeAddContentModal));
        [closeReportFeedbackModalBtn, cancelFeedbackBtn].forEach(btn => btn.addEventListener('click', closeReportFeedbackModal));

        imageFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file && mainQuillEditor && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const range = mainQuillEditor.getSelection(true);
                    mainQuillEditor.insertEmbed(range.index, 'image', event.target.result, 'user');
                    mainQuillEditor.formatText(range.index, 1, { class: 'kb-img', loading: 'lazy' });
                };
                reader.readAsDataURL(file);
            }
            e.target.value = '';
        });
        
        if (window.innerWidth < 768) sidebar.classList.add('closed');
        
        if (localStorage.getItem('justLoggedIn') === 'true') {
            showToast(`Welcome, ${displayName}!`, 'success', 4000);
            localStorage.removeItem('justLoggedIn');
        }
        console.log(`InfiniBase v${kbSystemData.meta.version} ready. User: ${displayName}, Role: ${currentUser.role}`);
    }

    initializeApp();

</script>
</body>
</html>
