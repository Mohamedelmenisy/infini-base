<!DOCTYPE html>
<html class="dark" data-hash="2025-06-24T15:30" dir="ltr" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>InfiniBase - Knowledge Base</title>
<!-- Updated Favicon -->
<link href="data:image/svg+xml,&lt;svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32' width='32' height='32'&gt;&lt;rect width='32' height='32' rx='4' fill='%236366f1'/&gt;&lt;text x='50%' y='55%' dominant-baseline='middle' text-anchor='middle' font-family='Arial, sans-serif' font-size='18' font-weight='bold' fill='white'&gt;IB&lt;/text&gt;&lt;/svg&gt;" rel="icon" type="image/svg+xml"/>
<!-- CDNs -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet"/>
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet"/>
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/quill-image-resize-module@3.0.0/image-resize.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
        :root {
            /* Permanent Dark Theme Variables */
            --primary-color: #6366f1; /* Brighter Indigo for dark */
            --primary-color-hover: #4f46e5;
            --secondary-color: #9ca3af;

            --text-color: #d1d5db;
            --text-color-muted: #9ca3af;
            --text-color-inverted: #ffffff; 
            --text-color-subtle: #9ca3af;

            --bg-color: #111827; /* Dark gray */
            --bg-color-alt: #1f2937; /* Slightly lighter dark gray for cards/modals */
            --bg-color-sidebar: #1f2937;
            --bg-color-header: rgba(31, 41, 55, 0.9);
            --bg-color-modal: #1f2937;
            --bg-color-hover: #374151;
            --bg-color-active: var(--primary-color);

            --border-color: #374151;
            --border-color-darker: #4b5563;

            --card-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            --card-hover-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            
            --border-radius: 0.5rem; 
            --border-radius-lg: 0.75rem;
            --header-height: 70px;
            --sidebar-width: 260px;

            --yes-color: #22c55e; /* Green for Yes */
            --no-color: #ef4444;   /* Red for No */
            --rating-color: #fbbf24; /* Amber 400 for ratings */
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            line-height: 1.6;
            font-size: 16px;
        }

        a { text-decoration-skip-ink: none; }

        .container-fluid {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-color-sidebar);
            padding: 1.5rem;
            border-right: 1px solid var(--border-color); /* LTR */
            position: fixed;
            top: 0;
            left: 0; /* LTR */
            height: 100vh;
            overflow-y: auto;
            transition: transform 0.3s ease-in-out, background-color 0.3s ease, border-color 0.3s ease;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }
        .sidebar.closed {
            transform: translateX(-100%); /* LTR */
        }
        @media (min-width: 768px) {
            .sidebar.closed { transform: translateX(0); }
        }

        .sidebar-header {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            color: var(--text-color); 
        }
        .sidebar-header i { 
            margin-right: 0.75rem; /* LTR */
            color: var(--primary-color);
            font-size: 1.8rem;
        }
        .sidebar-logo-text {
             color: var(--text-color);
        }

        .sidebar-nav { flex-grow: 1; }

        .sidebar-section-title {
            padding-left: 0.75rem; /* LTR */
            font-size: 0.75rem;
            font-weight: 700; /* Increased font-weight for better visibility */
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--text-color-muted);
        }

        .sidebar-link {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-radius: var(--border-radius);
            transition: background-color 0.2s ease, color 0.2s ease;
            font-weight: 500;
            color: var(--text-color-subtle);
            text-decoration: none;
            margin-bottom: 0.25rem;
        }
        .sidebar-link i {
            margin-right: 0.75rem; /* LTR */
            width: 1.5rem; /* Adjusted for font-size */
            font-size: 1.5rem; /* Increased icon size */
            text-align: center;
            transition: color 0.2s ease;
        }
        .sidebar-link:hover {
            background-color: var(--bg-color-hover);
            color: var(--text-color);
        }
        .sidebar-link.active {
            background-color: var(--bg-color-active); /* Primary color */
            color: var(--text-color-inverted) !important; /* White text */
            font-weight: 600;
        }
        .sidebar-link.active i {
            color: var(--text-color-inverted) !important; /* White icon on primary background */
        }

        .sidebar-footer {
            margin-top: auto; 
            padding-top: 1rem;
        }
        .sidebar-footer button {
            width: 100%;
            margin-top: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sidebar-footer button i { margin-right: 0.5rem; }


        .content-wrapper {
            flex-grow: 1;
            padding-right: 1.5rem; /* LTR */
            padding-left: 1.5rem;
            transition: margin-left 0.3s ease-in-out; /* LTR */
            height: 100vh;
            overflow-y: auto;
        }
        @media (min-width: 768px) {
             .content-wrapper { margin-left: var(--sidebar-width); /* LTR */ }
             .sidebar.closed + .content-wrapper { margin-left: 0; /* LTR */ }
        }

        .content-header {
            background-color: var(--bg-color-header);
            padding: 1.25rem 2rem; 
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky; 
            top: 0;
            left: var(--sidebar-width); /* LTR, adjusted for fixed sidebar */
            right: 0;
            height: var(--header-height);
            z-index: 50;
            backdrop-filter: blur(8px); 
        }
         @media (max-width: 767px) { /* Mobile: header spans full width */
            .content-header {
                left: 0;
            }
        }
        .header-left-content { display: flex; align-items: center; } 
        #currentSectionTitle {
            font-size: 1.5rem; 
            font-weight: bold;
            margin: 0;
        }
        #breadcrumbs {
            font-size: 0.875rem; 
            color: var(--text-color-muted);
            margin-top: 0.25rem;
        }
        #breadcrumbs a { color: var(--primary-color); text-decoration: none; }
        #breadcrumbs a:hover { text-decoration: underline; }

        .header-right-content { display: flex; align-items: center; gap: 1rem; }
        .search-container { position: relative; }
        .search-container input[type="search"] {
            padding: 0.625rem 1rem 0.625rem 2.5rem; /* py-2.5 pl-10 pr-4 for LTR */
            border: 1px solid var(--border-color-darker);
            border-radius: 9999px; 
            min-width: 250px; 
            background-color: var(--bg-color-alt); 
            color: var(--text-color);
        }
        .search-container input[type="search"]::placeholder {
            color: var(--text-color-muted);
            opacity: 0.8;
        }
        .search-container .search-icon {
            position: absolute;
            inset-inline-start: 0.75rem; 
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-color-muted);
        }
        #searchResultsContainer {
            position: absolute;
            background-color: var(--bg-color-alt);
            border: 1px solid var(--border-color);
            border-top: none;
            width: 100%; 
            max-height: 300px; 
            overflow-y: auto;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); 
            z-index: 60; 
            border-radius: 0 0 var(--border-radius) var(--border-radius);
        }
        #searchResultsContainer a {
            display: block;
            padding: 0.75rem; 
            text-decoration: none;
            color: var(--text-color);
        }
        #searchResultsContainer a:hover { background-color: var(--bg-color-hover); }
        #searchResultsContainer mark { background-color: #78350f; color: #f3f4f6; }


        .user-profile { display: flex; align-items: center; gap: 0.5rem; }
        #userAvatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: var(--text-color-inverted);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
        }
        #userNameDisplayHeader { font-weight: 500; }
        @media (max-width: 640px) { 
            #userNameDisplayHeader { display: none; }
        }

        main { padding: 1.5rem 0; }
        
        .card {
            background-color: var(--bg-color-alt);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg); 
            padding: 1.5rem;
            margin-bottom: 1.5rem; 
            box-shadow: var(--card-shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease, border-color 0.3s ease;
            display: flex;
            flex-direction: column; 
            min-height: 150px; 
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--card-hover-shadow);
        }
        .card-header-icon {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .card-icon-container {
            padding: 0.75rem;
            border-radius: 50%;
            margin-right: 1rem; /* LTR */
            background-color: var(--primary-color-hover); 
        }
        .card-icon-container i {
            font-size: 1.25rem;
            color: var(--text-color-inverted);  
        }
        .card-title-group {
            flex-grow: 1;
        }
        .card h3 { margin-top: 0; font-size: 1.125rem; font-weight: 600; color: var(--text-color); line-height: 1.3; }
        .card p { margin-bottom: 1rem; font-size: 0.875rem; color: var(--text-color-subtle); flex-grow: 1; }
        
        .updated-badge {
            display: inline-block;
            background-color: rgba(34, 197, 94, 0.15); /* Green with transparency */
            border: 1px solid rgba(34, 197, 94, 0.4);
            color: #22c55e;
            padding: 0.15rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            margin-top: 0.4rem;
        }
        .card-tags {
            margin-top: 0rem;
            margin-bottom: 0.75rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .card-tags .tag {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            color: var(--text-color-muted);
            padding: 0.2rem 0.6rem;
            border-radius: 9999px;
            font-size: 0.7rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }

        .card-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
            margin-top: auto;
        }
        .card-actions .button {
            padding: 0.5rem 0.75rem;
            font-size: 0.8rem;
        }

        .button, button {
            background-color: var(--primary-color);
            color: var(--text-color-inverted);
            border: 1px solid transparent;
            padding: 0.625rem 1rem; 
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.875rem; 
            font-weight: 500; 
            transition: background-color 0.2s, border-color 0.2s, color 0.2s;
            text-decoration: none; 
            display: inline-flex; 
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .button:hover, button:hover {
            background-color: var(--primary-color-hover);
        }
        .button-secondary {
            background-color: transparent;
            color: var(--text-color-subtle);
            border-color: var(--border-color-darker);
        }
        .button-secondary:hover { background-color: var(--bg-color-hover); color: var(--text-color); }
        .button-danger {
            background-color: #dc2626; 
            color: var(--text-color-inverted);
        }
        .button-danger:hover { background-color: #b91c1c; }
        input:focus, button:focus, select:focus, textarea:focus, a:focus { 
            outline: 2px solid transparent;
            outline-offset: 2px;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.6); 
        }
        button:disabled {
            background-color: var(--border-color);
            color: var(--text-color-muted);
            cursor: not-allowed;
            border-color: transparent;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.75); 
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.2s ease-out;
        }
        .modal-overlay:not(.hidden) { opacity: 1; }
        .modal-content {
            background-color: var(--bg-color-modal);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 48rem; 
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.95);
            opacity: 0;
            transition: transform 0.2s ease-out, opacity 0.2s ease-out, background-color 0.3s ease, border-color 0.3s ease;
        }
        .modal-overlay:not(.hidden) .modal-content { transform: scale(1); opacity: 1; }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem; 
        }
        .modal-header h2 { margin-top: 0; font-size: 1.5rem; font-weight: 700; }
        .modal-header .close-button { 
            background: none; border: none; font-size: 1.5rem; color: var(--text-color-muted); cursor: pointer;
            padding: 0.25rem; line-height: 1; border-radius: 50%;
        }
        .modal-header .close-button:hover { background-color: var(--bg-color-hover); }
        
        .modal-body {
            padding-bottom: 1rem;
            font-size: 1rem;
            color: var(--text-color);
        }

        .modal-actions {
            margin-top: 1.5rem; 
            text-align: right; /* LTR */
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end; /* LTR */
            gap: 0.75rem; 
        }
         .modal-actions.no-border {
            border-top: none;
            padding-top: 0;
        }


        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.25rem; font-weight: 500; font-size: 0.875rem; }
        .form-group input[type="text"],
        .form-group input[type="url"],
        .form-group input[type="email"],
        .form-group input[type="file"],
        .form-group input[type="date"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.625rem; 
            border: 1px solid var(--border-color-darker); 
            border-radius: var(--border-radius);
            box-sizing: border-box;
            background-color: var(--bg-color); 
            color: var(--text-color);
        }
        .form-group textarea { min-height: 100px; }
        
        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: var(--text-color-muted);
            opacity: 0.8;
        }
        
        #templateSelectionContainer { margin-bottom: 1.5rem; }
        #templateSelectionContainer h3 { font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-color); }
        .template-buttons-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .template-button {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color-darker);
            color: var(--text-color-subtle);
            padding: 1rem;
            border-radius: var(--border-radius);
            text-align: left;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .template-button:hover {
            border-color: var(--primary-color);
            background-color: var(--bg-color-hover);
            color: var(--text-color);
        }
        .template-button i { 
            font-size: 1.5rem; 
            margin-bottom: 0.75rem;
            display: block; 
            color: var(--primary-color); 
            width: 100%;
            text-align: left;
        }
        .template-button h4 { 
            font-size: 1rem; 
            font-weight: 600; 
            margin-bottom: 0.5rem;
        }
        .template-button p { 
            font-size: 0.8rem; 
            line-height: 1.4; 
            color: var(--text-color-muted);
        }


        .ql-toolbar {
            background: var(--bg-color);
            border-color: var(--border-color-darker) !important;
            border-top-left-radius: var(--border-radius);
            border-top-right-radius: var(--border-radius);
        }
        .ql-toolbar .ql-stroke { stroke: var(--text-color-muted); }
        .ql-toolbar .ql-fill { fill: var(--text-color-muted); }
        .ql-toolbar .ql-picker-label { color: var(--text-color-muted); }
        .ql-snow .ql-picker.ql-expanded .ql-picker-options { background-color: var(--bg-color-alt); border-color: var(--border-color-darker); }
        .ql-snow .ql-picker-options .ql-picker-item:hover { color: var(--primary-color); }


        .ql-container {
            background: var(--bg-color-alt);
            border-color: var(--border-color-darker) !important;
            color: var(--text-color);
            min-height: 250px; 
            border-bottom-left-radius: var(--border-radius);
            border-bottom-right-radius: var(--border-radius);
            font-size: 1rem;
        }
        .ql-editor { padding: 12px; }
        .ql-editor.ql-blank::before {
            color: var(--text-color-muted);
            opacity: 0.6;
        }


        footer {
            text-align: center;
            padding: 1.5rem;
            font-size: 0.875rem;
            color: var(--text-color-muted);
            border-top: 1px solid var(--border-color);
            margin-top: auto; 
        }

        .mobile-sidebar-toggle {
            display: block;
            position: fixed;
            top: calc((var(--header-height) - 40px) / 2); 
            left: 1.5rem; /* LTR */
            z-index: 101; 
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 0.75rem; 
            border-radius: var(--border-radius);
            font-size: 1.25rem; 
            line-height: 1;
        }
        @media (min-width: 768px) {
            .mobile-sidebar-toggle { display: none; }
            .header-left-content #currentSectionTitle { margin-left: 0; }
        }
        @media (max-width: 767px) {
            .header-left-content #currentSectionTitle { margin-left: 0.5rem; }
            .content-header { padding: 1rem; }
            .header-right-content .search-container { display:none; } 
        }

        .toast-notification {
            position: fixed;
            bottom: 20px;
            right: 20px; /* LTR */
            padding: 12px 18px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 2000; 
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            display: flex;
            align-items: center;
            background-color: var(--bg-color-alt); 
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }
        .toast-notification.show { opacity: 1; transform: translateY(0); }
        .toast-icon { margin-right: 10px; /* LTR */ font-size: 1.2em; }
        .toast-success { background-color: #10b981; color: white; border-color: #059669; } 
        .toast-error { background-color: #ef4444; color: white; border-color: #dc2626; } 
        .toast-info { background-color: #3b82f6; color: white; border-color: #2563eb; } 

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 1.5rem; 
        }

        .kb-content h1, .kb-content h2, .kb-content h3 { margin-top: 1.5em; margin-bottom: 0.5em; color: var(--text-color); }
        .kb-content p { margin-bottom: 1em; }
        .kb-content ul, .kb-content ol { margin-bottom: 1em; padding-left: 20px; /* LTR */ }
        .kb-content li { margin-bottom: 0.5em; }
        .kb-content strong { font-weight: bold; }
        .kb-content em { font-style: italic; }
        .kb-content a { color: var(--primary-color); text-decoration: underline; }
        .kb-content pre {
            background-color: var(--bg-color);
            padding: 10px;
            border-radius: var(--border-radius);
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            position: relative;
        }
        .kb-content img, .ql-editor img {
            display: block;
            margin: 1rem auto;
            max-width: 100%;
            height: auto;
            border-radius: var(--border-radius);
        }

        .kb-content code {
            background-color: var(--bg-color-hover);
            padding: 0.2em 0.4em;
            margin: 0;
            font-size: 85%;
            border-radius: 3px;
        }
        .kb-content blockquote {
            background-color: var(--bg-color-hover);
            padding: 0.75rem 1rem;
            border-radius: var(--border-radius);
            margin: 1em 0;
            border-left: 4px solid var(--primary-color);
            color: var(--text-color);
            position: relative;
        }
        .kb-content blockquote i.fa-comment-dots {
            margin-right: 0.5rem;
            color: var(--primary-color);
        }
        .copy-script-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: var(--bg-color);
            color: var(--text-color-muted);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
            z-index: 1;
        }
        .copy-script-btn:hover { opacity: 1; }
        
        .copyable-script-box {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color-darker);
            border-left: 4px solid var(--yes-color);
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            margin: 1.5rem 0;
        }
        .copyable-script-box .script-title {
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            color: var(--text-color);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
        }
        .copyable-script-box .script-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }
        .copyable-script-box .script-text {
            flex-grow: 1;
            color: var(--text-color-subtle);
            line-height: 1.5;
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 0.9rem;
        }
        .copyable-script-box .copy-btn {
            flex-shrink: 0;
            background-color: var(--bg-color-hover);
            border: 1px solid var(--border-color-darker);
            color: var(--text-color);
            padding: 0.4rem 0.8rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.8rem;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s ease;
        }
        .copyable-script-box .copy-btn:hover {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .content-section-box {
            background-color: var(--bg-color);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            margin-bottom: 1.5rem;
            border-left: 4px solid var(--primary-color);
        }
        .content-section-box h3 {
            margin-top: 0;
            margin-bottom: 0.75rem;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--text-color);
        }
        .compensation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .compensation-box {
            background-color: var(--bg-color-alt);
            border: 1px solid var(--border-color-darker);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
        }
        .compensation-box h4 {
            margin-top: 0;
            font-size: 1.1rem;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.75rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .compensation-box.fast-order h4 { color: #22c55e; }
        .compensation-box.scheduled-order h4 { color: #fbbf24; }
        .compensation-box ul { list-style: none; padding: 0; margin: 0; }
        .compensation-box ul li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.6rem 0;
            font-size: 0.9rem;
            border-bottom: 1px solid var(--border-color);
        }
        .compensation-box ul li:last-child { border-bottom: none; }
        .compensation-box ul li span:first-child { font-weight: 500; color: var(--text-color-subtle); }
        .compensation-box ul li .action { font-weight: 600; text-align: right; }
        
        mark {
            padding: 0.1em 0.2em; border-radius: 0.2em; font-weight: bold;
            background-color: #78350f; color: #f3f4f6; 
        }

        .hidden { display: none !important; }

        .chart-container {
            position: relative;
            padding: 1rem;
            border-radius: var(--border-radius-lg);
            background-color: var(--bg-color-alt);
            height: 320px; 
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .chart-container canvas {
            max-width: 100%;
            max-height: 100%;
        }
        .chart-container h3 {
            font-size: 1.125rem; 
            font-weight: 600; 
            margin-bottom: 0.5rem;
            text-align: center;
            width: 100%;
        }
        .mermaid-diagram-card {
            background-color: var(--bg-color-alt);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--card-shadow);
            margin-bottom: 1.5rem;
        }
        .mermaid-diagram-card h3 {
            margin-top: 0;
            margin-bottom: 1rem;
            font-size: 1.25rem;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }
        .mermaid-diagram-container {
            overflow-x: auto; 
            padding: 10px; 
            background-color: var(--bg-color-alt);
            border-radius: var(--border-radius);
        }
        .mermaid-diagram-container svg { 
            display: block;
            margin: 0 auto; 
            max-width: 100%; 
            min-height: 350px;
            height: auto;
        }
        .mermaid-diagram-container text { 
            fill: var(--text-color) !important; 
            font-family: 'Inter', sans-serif !important; 
            font-size: 14px !important;
        }
        .mermaid-diagram-container .edgeLabel,
        .mermaid-diagram-container .label,
        .mermaid-diagram-container .messageText { 
            color: var(--text-color) !important; 
            fill: var(--text-color) !important; 
        }
        .mermaid-diagram-container .actor { stroke: var(--text-color-muted) !important; fill: var(--bg-color-alt) !important; }
        .mermaid-diagram-container rect, 
        .mermaid-diagram-container polygon, 
        .mermaid-diagram-container ellipse,
        .mermaid-diagram-container circle {
            stroke: var(--primary-color) !important;
            fill: var(--bg-color-alt) !important;
        }
        .mermaid-diagram-container .cluster rect {
             fill: var(--bg-color) !important;
             stroke: var(--border-color-darker) !important;
        }
        .mermaid-diagram-container .arrowheadPath {
            fill: var(--primary-color) !important;
        }
        .mermaid-diagram-container .edgePaths path {
            stroke: var(--primary-color) !important;
        }


        #itemDetailViewPlaceholder .item-title-area {
            display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;
        }
        #itemDetailViewPlaceholder .item-title-area i.fa-title-icon {
            font-size: 2rem; color: var(--primary-color); 
        }
        #itemDetailViewPlaceholder .item-title-area h2 { font-size: 1.8rem; margin:0; }
        #itemDetailViewPlaceholder .item-summary { color: var(--text-color-subtle); margin-bottom: 1rem; font-style: italic; }
        #itemDetailViewPlaceholder hr.title-content-divider {
             margin: 1.5rem 0; border-color: var(--border-color); 
        }
        .last-updated-info {
            color: var(--yes-color); 
            font-size: 0.85rem; 
            margin-bottom: 1rem; 
            font-weight: 500;
        }
        #itemDetailViewPlaceholder .kb-content ul { list-style-type: disc; }
        #itemDetailViewPlaceholder .child-items-list { list-style-type: none; padding-left: 0; }
        #itemDetailViewPlaceholder .child-items-list li { margin-bottom: 0.5rem; }
        #itemDetailViewPlaceholder .child-items-list a { color: var(--primary-color); text-decoration: none; }
        #itemDetailViewPlaceholder .child-items-list a:hover { text-decoration: underline; }
        .item-actions-bar { display: flex; gap: 0.75rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        
        .item-feedback-section { margin-top: 2rem; padding: 1.5rem; border: 1px solid var(--border-color); border-radius: var(--border-radius-lg); background-color: var(--bg-color); }
        .item-feedback-section h4 { font-size: 1.125rem; font-weight: 600; margin-top: 0; margin-bottom: 1rem; }
        .rating-prompt { display:flex; align-items:center; gap:1rem; margin-bottom: 1rem; }
        .rating-prompt > span { font-weight: 500; }
        .rating-buttons button { background: none; border: 1px solid var(--border-color); color: var(--text-color-muted); padding: 0.5rem 0.75rem; border-radius: var(--border-radius); cursor: pointer; transition: all 0.2s; }
        .rating-buttons button:hover { border-color: var(--rating-color); color: var(--rating-color); background-color: rgba(251, 191, 36, 0.1); }
        .rating-buttons button.active.yes { border-color: var(--yes-color); color: var(--yes-color); background-color: rgba(34, 197, 94, 0.1); }
        .rating-buttons button.active.no { border-color: var(--no-color); color: var(--no-color); background-color: rgba(239, 68, 68, 0.1); }
        .rating-buttons button i { margin-right: 0.5rem; }
        .read-stats { font-size: 0.875rem; color: var(--text-color-muted); margin-top: 1.5rem; border-top: 1px solid var(--border-color); padding-top: 1rem; }
        #negativeFeedbackForm { margin-top: 1rem; }
        
        .comments-section { margin-top: 2rem; }
        .comments-section h4 { font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-color); }
        .comment-post-area {
            display: flex;
            gap: 0.75rem;
            align-items: flex-start;
            margin-bottom: 1.5rem;
        }
        .comment-post-area img { width: 36px; height: 36px; border-radius: 50%; margin-top: 5px;}
        .comment-input-wrapper { flex-grow: 1; }
        .comment-input-wrapper textarea {
            width: 100%;
            min-height: 60px;
            padding: 0.75rem;
            border: 1px solid var(--border-color-darker);
            border-radius: var(--border-radius);
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        .comment-post-actions { text-align: right; margin-top: 0.5rem; }
        
        .comment-display-area { margin-top: 1rem; display: flex; flex-direction: column; gap: 1.25rem; }
        .comment { display: flex; gap: 0.75rem; align-items: flex-start; }
        .comment img { width: 32px; height: 32px; border-radius: 50%; }
        .comment-content {
            flex-grow: 1;
            background-color: var(--bg-color-alt);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 0.75rem 1rem;
        }
        .comment-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem; }
        .comment-author { font-weight: 600; color: var(--text-color); font-size: 0.9rem; }
        .comment-timestamp { color: var(--text-color-muted); font-size: 0.75rem; }
        .comment-text {
            font-size: 0.95rem;
            line-height: 1.5;
            color: var(--text-color-subtle);
            white-space: pre-wrap;
        }
        .comment-actions { margin-top: 0.5rem; }
        .comment-actions button {
            background: none;
            border: none;
            color: var(--text-color-muted);
            font-size: 0.8rem;
            font-weight: 500;
            padding: 0.25rem 0.5rem;
            cursor: pointer;
        }
        .comment-actions button:hover { color: var(--primary-color); }

        /* Dashboard Styles */
        .dashboard-filter-bar {
            background-color: var(--bg-color-alt);
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius-lg);
            margin-bottom: 1.5rem;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 1rem;
        }
        .dashboard-filter-bar .form-group {
            margin-bottom: 0;
            flex-grow: 1;
            min-width: 180px;
        }
        .dashboard-filter-bar input {
            padding: 0.5rem 0.75rem;
        }
        .dashboard-filter-bar .filter-buttons {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-shrink: 0;
        }

        .dashboard-stat-card {
            background-color: var(--bg-color-alt);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--card-shadow);
            text-align: center;
        }
        .dashboard-stat-card i {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 0.75rem;
        }
        .dashboard-stat-card .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            display: block;
            margin-bottom: 0.25rem;
        }
        .dashboard-stat-card .stat-label {
            font-size: 0.875rem;
            color: var(--text-color-muted);
        }
        .dashboard-quicklink-card, .dashboard-info-card {
             background-color: var(--bg-color-alt);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--card-shadow);
        }
         .dashboard-quicklink-card h3, .dashboard-info-card h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }
        .dashboard-quicklink-card ul, .dashboard-info-card ul {
            list-style: none;
            padding: 0;
        }
        .dashboard-quicklink-card ul li a, .dashboard-info-card ul li a {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0;
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
        }
         .dashboard-quicklink-card ul li a:hover, .dashboard-info-card ul li a:hover {
            text-decoration: underline;
        }
         .dashboard-info-card ul li {
            font-size: 0.9rem;
            color: var(--text-color-subtle);
            padding: 0.3rem 0;
         }
         .dashboard-info-card ul li strong {
            color: var(--text-color);
         }
         .dashboard-info-card ul li .meta {
            font-size: 0.75rem;
            display: block;
            color: var(--text-color-muted);
         }
        .viewer-dashboard-message .card {
            text-align: center;
            padding: 40px 20px;
            min-height: auto;
        }
        .viewer-dashboard-message .card i {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
        .viewer-dashboard-message .card h2 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--text-color);
        }
        .viewer-dashboard-message .card p {
            font-size: 1rem;
            color: var(--text-color-muted);
            margin-bottom: 0;
        }
        .viewer-dashboard-message .card p.subtle-note {
             font-size: 0.9rem;
             margin-top: 1rem;
        }

        .dashboard-table-card {
            background-color: var(--bg-color-alt);
            padding: 0;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--card-shadow);
            grid-column: 1 / -1;
            overflow: hidden;
        }
        .dashboard-table-card h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin: 0;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        .dashboard-table-wrapper {
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }
        .dashboard-table-card table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
        }
        .dashboard-table-card th, .dashboard-table-card td {
            padding: 0.75rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }
        .dashboard-table-card th {
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-color-muted);
            background-color: var(--bg-color);
        }
        .dashboard-table-card tr:last-child td {
            border-bottom: none;
        }
        .dashboard-table-card td {
            font-size: 0.9rem;
            color: var(--text-color-subtle);
        }
        .dashboard-table-card td .user-name-cell {
            font-weight: 500;
            color: var(--text-color);
        }
        .dashboard-table-card td .email-cell {
            font-size: 0.85rem;
        }
        .dashboard-table-card .action-badge {
            display: inline-block;
            padding: 0.2rem 0.6rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: capitalize;
        }
        .dashboard-table-card .action-badge.view,
        .dashboard-table-card .action-badge.viewed { background-color: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .dashboard-table-card .action-badge.comment,
        .dashboard-table-card .action-badge.commented { background-color: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .dashboard-table-card .action-badge.create,
        .dashboard-table-card .action-badge.created { background-color: rgba(167, 139, 250, 0.2); color: #a78bfa; }
        .dashboard-table-card .action-badge.edit,
        .dashboard-table-card .action-badge.updated { background-color: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        .dashboard-table-card .action-badge.positive_feedback { background-color: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        
        .dashboard-table-card td a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
        }
        .dashboard-table-card td a:hover {
            text-decoration: underline;
        }
        
        /* ✅ View History Table Formatting Fix */
        #viewHistorySection table {
            table-layout: fixed;
            width: 100%;
            border-collapse: collapse;
        }
        #viewHistorySection th, #viewHistorySection td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            white-space: normal;
            word-break: break-word;
            text-align: left;
        }
        #viewHistorySection th {
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-color-muted);
            background-color: var(--bg-color);
        }
        #viewHistorySection th:nth-child(1), #viewHistorySection td:nth-child(1) { width: 40%; }
        #viewHistorySection th:nth-child(2), #viewHistorySection td:nth-child(2) { width: 25%; text-align: center;}
        #viewHistorySection th:nth-child(3), #viewHistorySection td:nth-child(3) { width: 35%; text-align: right; }
        #viewHistorySection .action-badge { margin: 0 auto; }


        @media print {
            body, .container-fluid {
                margin: 0;
                padding: 0;
                background-color: white !important;
                color: black !important;
                font-size: 12pt;
            }
            .sidebar, .content-header, .sidebar-footer, footer,
            .mobile-sidebar-toggle, #toastContainer,
            .item-actions-bar .button:not(#printItemBtn):not(#downloadPdfItemBtn),
            .item-actions-bar button[id*="edit"], .item-actions-bar button[id*="delete"], .item-actions-bar button[id*="share"],
            .item-feedback-section, .comments-section,
            .modal-overlay,
            .copy-script-btn, .copyable-script-box .copy-btn,
            .dashboard-overview-container,
            .search-container, .user-profile,
            #openAddContentBtnInSection,
            .card-hover-details,
            .card-actions,
            .updated-badge, .last-updated-info
            {
                display: none !important;
            }

            .content-wrapper {
                margin-left: 0 !important;
                padding: 1cm !important;
                overflow: visible !important;
                height: auto !important;
                width: 100% !important;
            }
            #pageContentArea { padding: 0 !important; }
            
            #itemDetailViewPlaceholder, #standardSectionContentPlaceholder {
                display: block !important;
            }
            .card, .mermaid-diagram-card, .compensation-box, .content-section-box, .copyable-script-box {
                box-shadow: none !important;
                border: 1px solid #ccc !important;
                margin-bottom: 0.5cm !important;
                background-color: white !important;
                page-break-inside: avoid;
            }
            
            .card *, .mermaid-diagram-card *, .compensation-box *, .content-section-box *, .copyable-script-box * {
                color: black !important;
                background-color: transparent !important;
            }
             h1, h2, h3, h4, h5, h6 { color: black !important; }

            .kb-content a {
                color: #0066cc !important;
                text-decoration: underline !important;
            }
            .kb-content a[href^="http"]::after, 
            .kb-content a[href^="https"]::after {
                content: " (" attr(href) ")";
                font-size: 0.8em;
                color: #555 !important;
                word-break: break-all;
            }
            .kb-content a[href^="#"]::after {
                content: "";
            }

            .mermaid-diagram-container { background-color: white !important; }
            .mermaid-diagram-container svg {
                background-color: white !important;
                max-width: 100% !important;
                height: auto !important;
            }
            .mermaid-diagram-container text,
            .mermaid-diagram-container .edgeLabel,
            .mermaid-diagram-container .label,
            .mermaid-diagram-container .messageText {
                fill: black !important;
                font-family: 'Arial', sans-serif !important;
            }
            .mermaid-diagram-container .actor {
                stroke: #333 !important;
                fill: white !important;
            }
            .mermaid-diagram-container rect,
            .mermaid-diagram-container polygon,
            .mermaid-diagram-container ellipse,
            .mermaid-diagram-container circle {
                stroke: #333 !important;
                fill: #f0f0f0 !important;
            }
            .mermaid-diagram-container .cluster rect {
                fill: #e8e8e8 !important;
                stroke: #aaa !important;
            }
            .mermaid-diagram-container .arrowheadPath {
                fill: #333 !important;
            }
            .mermaid-diagram-container .edgePaths path {
                stroke: #333 !important;
            }
            pre.mermaid {
                background-color: #f8f8f8 !important;
                border: 1px solid #ddd !important;
                padding: 8px !important;
            }
        }

    </style>
</head>
<body>
<div class="modal-overlay hidden" id="addContentModalOverlay">
<div class="modal-content">
<div class="modal-header">
<h2 id="addContentModalTitle">Add New Content</h2>
<button aria-label="Close" class="close-button" id="closeAddContentModalBtn">×</button>
</div>
<div class="hidden" id="templateSelectionContainer">
<h3>Choose a Template</h3>
<div class="template-buttons-grid">
<button class="template-button" data-template="standard_article">
<i class="fas fa-newspaper"></i>
<h4>Standard Article</h4>
<p>For general information, announcements, or detailed explanations.</p>
</button>
<button class="template-button" data-template="troubleshooting_guide">
<i class="fas fa-tools"></i>
<h4>Troubleshooting Guide / Case</h4>
<p>Step-by-step solutions for common issues or case documentation.</p>
</button>
<button class="template-button" data-template="policy_document">
<i class="fas fa-gavel"></i>
<h4>Policy Document</h4>
<p>Formal policies, procedures, or official guidelines.</p>
</button>
<button class="template-button" data-template="blank">
<i class="fas fa-file"></i>
<h4>Blank Document</h4>
<p>Start with a completely empty document of any type.</p>
</button>
</div>
<hr style="border-color: var(--border-color-darker); margin: 1.5rem 0;"/>
</div>
<form class="hidden" id="addContentForm">
<input id="editingItemId" type="hidden"/> 
<div class="form-group">
<label for="contentType">Content Type</label>
<select id="contentType">
<option value="article">Article</option>
<option value="case">Case</option>
<option value="form_sheet">Form/Sheet (Link)</option>
<option value="design">Design (Link)</option>
<option value="guide">Guide</option>
<option value="policy">Policy</option>
</select>
</div>
<div class="form-group">
<label for="contentTitle">Title</label>
<input id="contentTitle" required="" type="text"/>
</div>
<div class="form-group">
<label for="contentSummary">Summary / Description</label>
<textarea id="contentSummary" required="" rows="3"></textarea>
</div>
<div class="form-group hidden" id="contentUrlContainer">
<label for="contentUrl">Link (for Forms, Designs, etc.)</label>
<input id="contentUrl" type="url"/>
</div>
<div class="form-group" id="contentDetailContainer">
<label for="contentDetail" id="contentDetailLabel">Details / Content</label>
<div id="quillEditor"></div> 
</div>
<div class="form-group">
<label for="contentTags">Tags (comma-separated)</label>
<input id="contentTags" placeholder="e.g., important, update, billing" type="text"/>
</div>
<div class="form-group" id="parentItemContainer">
<label for="parentItem">Parent Item (Optional)</label>
<p style="font-size: 0.8rem; color: var(--text-color-muted); margin-top: -0.25rem; margin-bottom: 0.5rem;">
    Link this content as a child to another item in this section. It will appear as a "Related Topic" on the parent's page.
</p>
<select id="parentItem">
<option value="">-- None (Top-Level Item) --</option>
</select>
</div>
<hr style="border-color: var(--border-color-darker); margin: 1.5rem 0;"/>
<h3 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-color);">Attachments (Optional)</h3>
<div class="form-group">
<label for="pdfFile">Upload PDF</label>
<input accept=".pdf" id="pdfFile" type="file"/>
</div>
<div class="form-group">
<label for="imageFile">Upload Image (Inserts into content)</label>
<input accept="image/*" id="imageFile" type="file"/>
</div>
<div class="form-group">
<label for="videoLink">Video Link (e.g., YouTube, Vimeo)</label>
<input id="videoLink" placeholder="https://..." type="url"/>
</div>
<div class="form-group">
<label for="driveLink">Google Drive Link</label>
<input id="driveLink" placeholder="https://docs.google.com/... or https://drive.google.com/..." type="url"/>
</div>
<div class="modal-actions">
<button class="button" id="saveContentBtn" type="submit"><i class="fas fa-save"></i> Save Content</button>
<button class="button-secondary" id="cancelAddContentBtn" type="button"><i class="fas fa-times"></i> Cancel</button>
</div>
</form>
</div>
</div>
<!-- Logout Confirmation Modal -->
<div class="modal-overlay hidden" id="logoutConfirmModalOverlay">
<div class="modal-content" style="max-width: 28rem;">
<div class="modal-header">
<h2 id="logoutConfirmModalTitle">Confirm Logout</h2>
<button aria-label="Close" class="close-button" id="closeLogoutConfirmModalBtn">×</button>
</div>
<div class="modal-body">
<p>Are you sure you want to logout from InfiniBase?</p>
</div>
<div class="modal-actions no-border">
<button class="button button-danger" id="confirmLogoutBtn" type="button"><i class="fas fa-sign-out-alt"></i> Confirm Logout</button>
<button class="button-secondary" id="cancelLogoutBtn" type="button"><i class="fas fa-times"></i> Cancel</button>
</div>
</div>
</div>
<!-- Report Feedback Modal -->
<div class="modal-overlay hidden" id="reportFeedbackModalOverlay">
<div class="modal-content" style="max-width: 32rem;">
<div class="modal-header">
<h2 id="reportFeedbackModalTitle">Report Feedback</h2>
<button aria-label="Close" class="close-button" id="closeReportFeedbackModalBtn">×</button>
</div>
<form id="reportFeedbackForm">
<input id="feedbackItemId" type="hidden"/>
<input id="feedbackItemTitle" type="hidden"/>
<div class="modal-body" style="padding-bottom:0;">
<p style="margin-bottom: 1rem;">Provide your feedback for: <strong id="feedbackItemTitleDisplay"></strong></p>
<div class="form-group">
<label for="feedbackUserName">Your Name</label>
<input id="feedbackUserName" readonly="" type="text"/>
</div>
<div class="form-group">
<label for="feedbackUserEmail">Your Email</label>
<input id="feedbackUserEmail" readonly="" type="email"/>
</div>
<div class="form-group">
<label for="feedbackComment">Your Feedback / Comments</label>
<textarea id="feedbackComment" placeholder="Please describe the issue or suggestion..." required="" rows="5"></textarea>
</div>
</div>
<div class="modal-actions">
<button class="button" id="submitFeedbackBtn" type="submit"><i class="fas fa-paper-plane"></i> Submit Feedback</button>
<button class="button-secondary" id="cancelFeedbackBtn" type="button"><i class="fas fa-times"></i> Cancel</button>
</div>
</form>
</div>
</div>
<!-- Delete Confirmation Modal -->
<div class="modal-overlay hidden" id="deleteConfirmModalOverlay">
<div class="modal-content" style="max-width: 30rem;">
<div class="modal-header">
<h2 id="deleteConfirmModalTitle">Confirm Deletion</h2>
<button aria-label="Close" class="close-button" id="closeDeleteConfirmModalBtn">×</button>
</div>
<div class="modal-body">
<p id="deleteConfirmMessage">Are you sure you want to delete this item? This action cannot be undone.</p>
</div>
<div class="modal-actions no-border">
<button class="button button-danger" id="confirmDeleteItemBtn" type="button"><i class="fas fa-trash-alt"></i> Confirm Delete</button>
<button class="button-secondary" id="cancelDeleteItemBtn" type="button"><i class="fas fa-times"></i> Cancel</button>
</div>
</div>
</div>
<div class="container-fluid">
<aside class="sidebar" id="sidebar">
<div class="sidebar-header">
<i class="fas fa-database"></i> <span class="sidebar-logo-text">InfiniBase</span>
</div>
<nav class="sidebar-nav" id="navigationMenu">
</nav>
<div class="sidebar-footer">
<button class="button button-danger" id="logoutButton">
<i class="fas fa-sign-out-alt"></i> Logout
                </button>
<div id="userRoleDisplaySidebar" style="font-size: 0.8rem; color: var(--text-color-muted); text-align: center; margin-top: 0.5rem;">Role: <span id="currentUserRoleSpan"></span></div>
</div>
</aside>
<div class="content-wrapper" id="contentWrapper">
<header class="content-header">
<div class="header-left-content">
<button class="mobile-sidebar-toggle" id="mobileSidebarToggle"><i class="fas fa-bars"></i></button>
<div>
<h1 id="currentSectionTitle">Welcome</h1>
<div id="breadcrumbs">Home</div>
</div>
</div>
<div class="header-right-content">
<div class="search-container">
<span class="search-icon"><i class="fas fa-search"></i></span>
<input id="globalSearchInput" placeholder="Search the knowledge base..." type="search"/>
<div class="hidden" id="searchResultsContainer"></div>
</div>
<div class="user-profile" id="userProfileContainer">
<div id="userAvatar">U</div>
<span id="userNameDisplayHeader" style="font-weight: 500;">User</span>
</div>
</div>
</header>
<main class="p-6 md:p-8" id="pageContentArea">
<div class="hidden" id="dashboardOverviewContainer">
</div>
<div id="standardSectionContentPlaceholder">
</div>
<div class="hidden" data-mermaid-rendered="false" id="itemDetailViewPlaceholder">
</div>
</main>
<footer class="mt-auto p-6 text-center text-sm">
<span>© <script>document.write(new Date().getFullYear())</script> InfiniBase.Elmenisy.</span>
</footer>
</div>
</div>
<div id="toastContainer"></div>

<script type="module">
    // =================================================================================
    // SUPABASE & APP LOGIC - FULLY INTEGRATED
    // =================================================================================
    import { supabase } from './supabase.js';

    // --- Supabase Logic Layer (Functions to interact with the database) ---
    
    async function getCurrentUserProfile() {
        const { data: { user }, error: authError } = await supabase.auth.getUser();
        if (authError || !user) {
            console.error('No logged-in user found:', authError);
            return null;
        }
        const { data: profile, error } = await supabase.from('users').select('*').eq('id', user.id).single();
        if (error) {
            console.error('Error fetching user profile:', error);
            // Fallback for users who exist in auth but not in the 'users' table
            return { id: user.id, email: user.email, role: 'viewer', name: user.email };
        }
        return profile;
    }

    async function logout() {
        await supabase.auth.signOut();
        window.location.href = 'login.html';
    }
    
    async function fetchSubCategories() {
        const { data, error } = await supabase.from('sub_categories').select('*').order('position');
        if (error) {
            console.error('Error fetching sub-categories:', error);
            showToast('Failed to load knowledge areas.', 'error');
            return [];
        }
        return data;
    }

    async function fetchArticles() {
        const { data, error } = await supabase
            .from('cases')
            .select(`*`)
            .order('created_at', { ascending: false });
        
        if (error) {
            console.error('Error fetching articles:', error);
            showToast('Failed to load articles from the database.', 'error');
            return [];
        }
        return data.map(article => ({
            ...article,
            comments: article.comments || [],
            feedback: article.feedback || [],
        }));
    }
    
    async function addComment(articleId, commentText, user) {
        const { data, error } = await supabase.from('kb_comments').insert([{
            item_id: articleId,
            author_id: user.id,
            author_name: user.name,
            body: commentText,
        }]).select().single();
        if (error) {
            console.error('Error posting comment:', error);
            return {data: null, error};
        }
        await logActivity(currentUser, articleId, 'comment', 'commented');
        return { data, error: null };
    }

    async function submitFeedback(articleId, rating, reason, user) {
        const { error } = await supabase.from('kb_feedback').insert([{
            item_id: articleId,
            user_id: user.id,
            rating,
            reason,
        }]);
        if (error) {
            console.error('Error submitting feedback:', error);
        } else {
             await logActivity(user, articleId, 'feedback', rating === 1 ? 'positive_feedback' : 'negative_feedback', { reason });
        }
    }
    
    async function saveVersion(article, user) {
        try {
            const { error } = await supabase.from('version_history').insert([{
                item_id: article.id,
                title: article.title,
                content: article.content,
                author_id: user.id,
            }]);
            if (error) throw error;
        } catch(e) {
            console.warn("Could not save to version_history. Ensure the table exists and RLS is configured.", e.message);
        }
    }

    async function logActivity(user, itemId, itemType, action, details = {}) {
        if (!user || !user.id) {
            console.warn("Attempted to log activity without a valid user.");
            return;
        }
        const { error } = await supabase.from('activity_log').insert([{
            user_id: user.id,
            user_name: user.name,
            item_id: itemId,
            item_type: itemType,
            action: action,
            details: details,
        }]);
        if (error) console.error('Error logging activity:', error);
    }

    async function fetchInsights() {
      const { data, error } = await supabase.from('v_kb_insights').select('*');
      if (error) {
        console.error('Error fetching insights:', error);
        return [];
      }
      return data;
    }

    async function fetchDashboardTableData() {
        const { data: users, error: usersError } = await supabase.from('users').select('id, name, email');
        if(usersError) console.error("Could not fetch users for email mapping:", usersError);

        const [activity, insights] = await Promise.all([
            supabase.from('activity_log').select('*').order('timestamp', { ascending: false }).limit(100),
            fetchInsights()
        ]);
        
        const activityLogWithEmail = (activity.data || []).map(log => {
            const user = (users || []).find(u => u.id === log.user_id);
            return { ...log, user_email: user?.email || null };
        });

        return {
            activityLog: activityLogWithEmail,
            articleViews: insights || [] // ✅ FIX: Directly use the result from fetchInsights
        };
    }

    mermaid.initialize({ 
        startOnLoad: false,
        theme: 'dark', 
        fontFamily: 'Inter, sans-serif',
        flowchart: { 
            htmlLabels: true,
            useMaxWidth: true,
        },
        themeVariables: {
            fontSize: '14px', 
            background: getComputedStyle(document.documentElement).getPropertyValue('--bg-color-alt').trim(), 
            primaryColor: getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim(),
            primaryTextColor: getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim(),
            lineColor: getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim(),
            textColor: getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim(),
            nodeBorder: getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim(),
        }
    });
    
    let kbSystemData = { sections: [] };
    let mainQuillEditor;
    let currentUser = null; 
    let currentOpenItem = null;
    let visitorsChartInstance;
    let originalDashboardData = { activityLog: [], articleViews: [] };

    const sidebar = document.getElementById('sidebar');
    const mobileSidebarToggle = document.getElementById('mobileSidebarToggle');
    const navigationMenu = document.getElementById('navigationMenu');
    const currentSectionTitleEl = document.getElementById('currentSectionTitle');
    const breadcrumbsContainer = document.getElementById('breadcrumbs');
    const pageContentArea = document.getElementById('pageContentArea');
    const dashboardOverviewContainer = document.getElementById('dashboardOverviewContainer');
    const standardSectionContentPlaceholder = document.getElementById('standardSectionContentPlaceholder');
    const itemDetailViewPlaceholder = document.getElementById('itemDetailViewPlaceholder');
    const userNameDisplayHeader = document.getElementById('userNameDisplayHeader');
    const userAvatar = document.getElementById('userAvatar');
    const currentUserRoleSpan = document.getElementById('currentUserRoleSpan');
    const addContentModalOverlay = document.getElementById('addContentModalOverlay');
    const closeAddContentModalBtn = document.getElementById('closeAddContentModalBtn');
    const addContentForm = document.getElementById('addContentForm');
    const templateSelectionContainer = document.getElementById('templateSelectionContainer');
    const cancelAddContentBtn = document.getElementById('cancelAddContentBtn');
    const contentTypeSelect = document.getElementById('contentType');
    const contentUrlContainer = document.getElementById('contentUrlContainer');
    const contentDetailContainer = document.getElementById('contentDetailContainer');
    const contentDetailLabel = document.getElementById('contentDetailLabel');
    const contentTagsInput = document.getElementById('contentTags');
    const editingItemIdInput = document.getElementById('editingItemId');
    const globalSearchInput = document.getElementById('globalSearchInput');
    const searchResultsContainer = document.getElementById('searchResultsContainer');
    const logoutButton = document.getElementById('logoutButton');
    const logoutConfirmModalOverlay = document.getElementById('logoutConfirmModalOverlay');
    const closeLogoutConfirmModalBtn = document.getElementById('closeLogoutConfirmModalBtn');
    const confirmLogoutBtn = document.getElementById('confirmLogoutBtn');
    const cancelLogoutBtn = document.getElementById('cancelLogoutBtn');
    const deleteConfirmModalOverlay = document.getElementById('deleteConfirmModalOverlay');
    const closeDeleteConfirmModalBtn = document.getElementById('closeDeleteConfirmModalBtn');
    const confirmDeleteItemBtn = document.getElementById('confirmDeleteItemBtn');
    const cancelDeleteItemBtn = document.getElementById('cancelDeleteItemBtn');
    const deleteConfirmMessage = document.getElementById('deleteConfirmMessage');

    function escapeHTML(str) {
        if (typeof str !== 'string') return '';
        const el = document.createElement('div');
        el.textContent = str;
        return el.innerHTML;
    }

    function formatReadableDate(isoString) {
        if (!isoString) return 'N/A';
        return new Date(isoString).toLocaleString('en-GB', {
            day: '2-digit', month: 'short', year: 'numeric',
            hour: '2-digit', minute: '2-digit', hour12: true
        });
    }

    function highlightText(text, query) {
        if (!text) return '';
        const safeText = escapeHTML(text);
        if (!query) return safeText;
        try {
            const rgx = new RegExp(`(${query.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')})`, 'gi');
            return safeText.replace(rgx, '<mark>$1</mark>');
        } catch (e) { return safeText; }
    }

    function truncateText(text, len) {
        if (!text || text.length <= len) return text;
        return text.substring(0, len) + '...';
    }

    function stripHtml(html){
       if (!html) return "";
       let tmp = document.createElement("DIV");
       tmp.innerHTML = html;
       return tmp.textContent || tmp.innerText || "";
    }
    
    // ✅ NEW: Slug creation function for user-friendly URLs
    function createSlug(text) {
        if (!text) return 'untitled';
        return text
            .toString()
            .toLowerCase()
            .trim()
            .replace(/\s+/g, '-') // Replace spaces with -
            .replace(/&/g, '-and-') // Replace & with 'and'
            .replace(/[^\w\-]+/g, '') // Remove all non-word chars
            .replace(/\-\-+/g, '-'); // Replace multiple - with single -
    }

    function showToast(message, type = 'info', duration = 3000) {
        const toastContainer = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast-notification toast-${type}`;
        let iconClass = 'fas fa-info-circle';
        if (type === 'success') iconClass = 'fas fa-check-circle';
        else if (type === 'error') iconClass = 'fas fa-times-circle';
        toast.innerHTML = `<i class="toast-icon ${iconClass}"></i> <span>${escapeHTML(message)}</span>`;
        toastContainer.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, duration);
    }
    
    function copyScriptToClipboard(btnElement) {
        const textToCopy = btnElement.previousElementSibling.textContent.trim();
        navigator.clipboard.writeText(textToCopy).then(() => {
            showToast('Message copied to clipboard!', 'success');
            btnElement.textContent = 'Copied!';
            setTimeout(() => { btnElement.textContent = 'Copy'; }, 2000);
        }).catch(err => {
            console.error('Failed to copy text: ', err);
            showToast('Failed to copy message.', 'error');
        });
    }
    window.copyScriptToClipboard = copyScriptToClipboard;

    async function loadAndStructureData() {
        console.log("Loading data from Supabase...");
        const [categories, articles] = await Promise.all([
            fetchSubCategories(),
            fetchArticles()
        ]);
        
        const sections = categories.map(cat => ({
            ...cat, 
            slug: createSlug(cat.name),
            items: []
        }));

        articles.forEach(article => {
            const parentSection = sections.find(s => s.id === article.sub_category_id);
            if (parentSection) {
                // ✅ ADD: Create a slug for each article title
                parentSection.items.push({ ...article, slug: createSlug(article.title) });
            } else {
                console.warn(`Article "${article.title}" has an unknown sub_category_id: ${article.sub_category_id}`);
            }
        });
        
        kbSystemData.sections = sections;
        console.log("Data loaded and structured:", kbSystemData);
    }

    function populateSidebar() {
        let menuHTML = '';
        const homeSection = { id: 'home', name: 'Home', icon: 'fas fa-home', color: 'var(--primary-color)', slug: 'home' };

        menuHTML += `<div class="sidebar-section-title">MAIN</div>`;
        menuHTML += `<a href="#${homeSection.slug}" class="sidebar-link" data-section-slug="${homeSection.slug}">
            <i class="${homeSection.icon}" style="color: ${homeSection.color};"></i>${escapeHTML(homeSection.name)}
        </a>`;

        const sectionsFromDB = kbSystemData.sections;
        
        const groupedSections = sectionsFromDB.reduce((acc, section) => {
            const sectionId = section.section_id || 'knowledge_areas';
            if (!acc[sectionId]) {
                acc[sectionId] = [];
            }
            acc[sectionId].push(section);
            return acc;
        }, {});

        const sectionTitles = {
            'knowledge_areas': 'KNOWLEDGE AREAS',
            'resources_policies': 'RESOURCES & POLICIES'
        };
        
        const sectionOrder = ['knowledge_areas', 'resources_policies'];

        sectionOrder.forEach(sectionId => {
            if (groupedSections[sectionId]) {
                const title = sectionTitles[sectionId] || sectionId.replace(/_/g, ' ').toUpperCase();
                menuHTML += `<div class="sidebar-section-title">${escapeHTML(title)}</div>`;
                
                const items = groupedSections[sectionId];
                items.sort((a, b) => (a.position || 0) - (b.position || 0)); 

                items.forEach(section => {
                    const iconStyle = section.color ? `style="color: ${section.color};"` : '';
                    menuHTML += `<a href="#${section.slug}" class="sidebar-link" data-section-slug="${section.slug}">
                        <i class="${section.icon || 'fas fa-folder'}" ${iconStyle}></i>${escapeHTML(section.name)}
                    </a>`;
                });
            }
        });
        
        if (sectionsFromDB.length === 0) {
            menuHTML += `<div class="sidebar-section-title">KNOWLEDGE AREAS</div>`;
            menuHTML += `<div class="sidebar-link" style="color: var(--text-color-muted); pointer-events: none; padding-left: 0.75rem;">No areas found.</div>`;
        }
        
        navigationMenu.innerHTML = menuHTML;
    }

    mobileSidebarToggle.addEventListener('click', () => sidebar.classList.toggle('closed'));
    sidebar.addEventListener('click', (e) => {
        if (e.target.closest('.sidebar-link') && window.innerWidth < 768) {
            sidebar.classList.add('closed');
        }
    });

    function highlightSidebarLink(sectionSlug) {
        document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
        const activeLink = document.querySelector(`.sidebar-link[data-section-slug="${sectionSlug}"]`);
        if (activeLink) activeLink.classList.add('active');
    }
    
    async function renderMermaidDiagramsInElement(element) {
        const mermaidElements = element.querySelectorAll('pre.mermaid');
        if (mermaidElements.length === 0) return;
        try {
            await new Promise(resolve => setTimeout(resolve, 50)); 
            await mermaid.run({ nodes: mermaidElements, suppressErrors: false });
            element.dataset.mermaidRendered = 'true';
        } catch (error) {
            console.error("Mermaid rendering error:", error);
        }
    }

    function renderItemCard(item, sectionData) {
        let itemIconClass = 'fas fa-file-alt'; 
        if (item.type === 'article') { itemIconClass = 'fas fa-newspaper'; }
        else if (item.type === 'case') { itemIconClass = 'fas fa-briefcase'; }
        else if (item.type === 'form_sheet') { itemIconClass = 'fas fa-file-invoice'; }
        else if (item.type === 'design') { itemIconClass = 'fas fa-palette'; }
        else if (item.type === 'guide') { itemIconClass = 'fas fa-book-open'; }
        else if (item.type === 'policy') { itemIconClass = 'fas fa-gavel'; }

        const isAdmin = currentUser?.role === 'admin';
        // ✅ FIX: Use item.slug in the URL
        const viewButton = `<a href="#${sectionData.slug}/${item.slug}" class="button button-secondary" title="View Item"><i class="fas fa-eye"></i> View</a>`;
        const editButton = isAdmin ? `<button class="button button-secondary" onclick="event.stopPropagation(); window.openEditModal('${sectionData.id}', '${item.id}')" title="Edit Item"><i class="fas fa-edit"></i> Edit</button>` : '';
        const deleteButton = isAdmin ? `<button class="button button-danger" onclick="event.stopPropagation(); window.openDeleteModal('${sectionData.id}', '${item.id}', '${escapeHTML(item.title)}')" title="Delete Item"><i class="fas fa-trash-alt"></i></button>` : '';
        
        const tagsHTML = item.tags && item.tags.length > 0
            ? `<div class="card-tags">${item.tags.map(tag => `<span class="tag">${escapeHTML(tag)}</span>`).join('')}</div>`
            : '';
        
        let updatedBadgeHTML = '';
        const createdAt = new Date(item.created_at);
        const lastModified = new Date(item.last_modified || item.created_at);
        if (lastModified.getTime() > createdAt.getTime() + 60000) {
            updatedBadgeHTML = `<div class="updated-badge">Updated</div>`;
        }

        return `
            <div class="card" data-item-id="${item.id}" data-section-id="${sectionData.id}">
                <div class="card-header-icon">
                    <div class="card-icon-container">
                        <i class="${itemIconClass}"></i>
                    </div>
                    <div class="card-title-group">
                        <h3>${escapeHTML(item.title)}</h3>
                        ${updatedBadgeHTML}
                    </div>
                </div>
                ${tagsHTML}
                <p>${escapeHTML(truncateText(stripHtml(item.description), 120))}</p>
                <div class="card-actions">
                    ${viewButton}
                    ${editButton}
                    ${deleteButton}
                </div>
            </div>`;
    }

    async function displayDashboard() {
        dashboardOverviewContainer.classList.remove('hidden');
        standardSectionContentPlaceholder.classList.add('hidden');
        itemDetailViewPlaceholder.classList.add('hidden');
        currentSectionTitleEl.textContent = 'Dashboard';
        breadcrumbsContainer.innerHTML = `<span style="font-weight: bold; color: var(--primary-color);">Home</span>`;

        if (!currentUser || currentUser.role !== 'admin') {
            dashboardOverviewContainer.innerHTML = `
                <div class="viewer-dashboard-message">
                    <div class="card">
                        <i class="fas fa-user-shield"></i>
                        <h2>Access Restricted</h2>
                        <p>The dashboard overview is available for administrators only.</p>
                        <p class="subtle-note">You can navigate using the sidebar to view knowledge base content.</p>
                    </div>
                </div>`;
            return;
        }

        originalDashboardData = await fetchDashboardTableData();
        
        const welcomeUser = currentUser.name || 'Admin'; 
        const allItems = kbSystemData.sections.flatMap(s => s.items || []);
        const totalArticles = allItems.filter(i => ['article', 'guide', 'policy'].includes(i.type)).length;
        const totalCases = allItems.filter(i => i.type === 'case').length;
        
        const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
        const editsThisWeek = allItems.filter(i => i.last_modified && new Date(i.last_modified) > sevenDaysAgo).length;
        
        const mostUsedArticles = (originalDashboardData.articleViews || []).sort((a,b) => (b.total_views || 0) - (a.total_views || 0)).slice(0,3);

        dashboardOverviewContainer.innerHTML = `
            <div class="card" style="background: linear-gradient(to right, var(--primary-color), #4c1d95); color: white; min-height: auto;">
                <h2 style="font-size: 1.75rem; margin-bottom: 4px;">Welcome back, ${escapeHTML(welcomeUser)}!</h2>
                <p style="opacity: 0.95; font-size: 0.95rem; color: var(--text-color-inverted);">Overview of your knowledge base activity.</p>
            </div>
            <div class="cards-grid md:grid-cols-2 lg:grid-cols-4 my-6">
                <div class="dashboard-stat-card"><i class="fas fa-folder-open"></i><span class="stat-value">${kbSystemData.sections.length}</span><span class="stat-label">Total Sections</span></div>
                <div class="dashboard-stat-card"><i class="fas fa-newspaper"></i><span class="stat-value">${totalArticles}</span><span class="stat-label">Total Articles & Guides</span></div>
                <div class="dashboard-stat-card"><i class="fas fa-briefcase"></i><span class="stat-value">${totalCases}</span><span class="stat-label">Total Cases</span></div>
                <div class="dashboard-stat-card"><i class="fas fa-edit"></i><span class="stat-value">${editsThisWeek}</span><span class="stat-label">Edits This Week</span></div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="dashboard-info-card">
                    <h3>🔥 Most Used Articles</h3>
                    <ul id="mostUsedList"></ul>
                </div>
                <div class="dashboard-quicklink-card">
                     <h3>💡 Quick Links</h3>
                     <ul>
                        <li><a href="#" id="addNewArticleLink"><i class="fas fa-plus-circle fa-fw"></i> Add New Content</a></li>
                        <li><a href="#" id="browseTemplatesLink"><i class="fas fa-file-alt fa-fw"></i> Browse Templates</a></li>
                     </ul>
                </div>
            </div>
            <div class="card chart-container" style="height: 350px;">
                <h3>Content Activity (Last 7 Days)</h3>
                <canvas id="visitorsChart"></canvas>
            </div>
            
            <!-- ✅ NEW: Container for filters and tables -->
            <div class="dashboard-tables-container" style="margin-top: 1.5rem;">
                <div class="dashboard-filter-bar">
                    <div class="form-group">
                        <input type="text" id="filterUserName" placeholder="Filter by User Name..." autocomplete="off">
                    </div>
                    <div class="form-group">
                        <input type="email" id="filterUserEmail" placeholder="Filter by User Email..." autocomplete="off">
                    </div>
                    <div class="form-group">
                        <input type="date" id="filterDate" title="Filter by date">
                    </div>
                    <div class="filter-buttons">
                        <button id="applyFiltersBtn" class="button"><i class="fas fa-filter"></i> Apply</button>
                        <button id="clearFiltersBtn" class="button-secondary"><i class="fas fa-times"></i> Clear</button>
                    </div>
                </div>
                <div class="dashboard-table-card" style="margin-top: 1.5rem;">
                    <h3>Article Insights</h3>
                    <div class="dashboard-table-wrapper">
                        <table>
                            <thead><tr><th>Article Title</th><th>Views</th><th>Comments</th><th>Positive Feedback</th><th>Last Viewed</th><th>Last Viewed By</th></tr></thead>
                            <tbody id="articleViewsTbody"></tbody>
                        </table>
                    </div>
                </div>
                <div class="dashboard-table-card" style="margin-top: 1.5rem;">
                    <h3>Recent Activity Log</h3>
                    <div class="dashboard-table-wrapper">
                        <table>
                            <thead><tr><th>User</th><th>Email</th><th>Item</th><th>Action</th><th>Timestamp</th></tr></thead>
                            <tbody id="activityLogTbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
        
        // Populate most used list
        document.getElementById('mostUsedList').innerHTML = mostUsedArticles.length ? mostUsedArticles.map(item => {
            const fullItem = findItem(item.article_id);
            const sectionSlug = fullItem ? fullItem.sectionSlug : 'home';
            const itemSlug = fullItem ? fullItem.slug : item.article_id;
            return `<li>
                <a href="#${sectionSlug}/${itemSlug}">${escapeHTML(item.article_title)}</a> 
                <span class="meta"><i class="fas fa-eye"></i> ${item.total_views || 0} views &nbsp;&nbsp; <i class="fas fa-comments"></i> ${item.total_comments || 0} comments</span>
            </li>`
        }).join('') : '<li>No data yet.</li>';

        // Add event listeners for quick links
        const handleQuickAdd = (e) => {
            e.preventDefault();
            const firstSectionId = kbSystemData.sections[0]?.id;
            if (firstSectionId) {
                openAddContentModal(firstSectionId);
            } else {
                showToast('Please create a section first before adding content.', 'error');
            }
        };
        document.getElementById('addNewArticleLink').addEventListener('click', handleQuickAdd);
        document.getElementById('browseTemplatesLink').addEventListener('click', handleQuickAdd);

        // Setup filter listeners
        document.getElementById('applyFiltersBtn').addEventListener('click', applyDashboardFilters);
        document.getElementById('clearFiltersBtn').addEventListener('click', () => {
            document.getElementById('filterUserName').value = '';
            document.getElementById('filterUserEmail').value = '';
            document.getElementById('filterDate').value = '';
            renderDashboardTables(originalDashboardData); // Re-render with original data
        });

        
        renderDashboardTables(originalDashboardData);

        const legendColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim();
        const ticksColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color-muted').trim();
        const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim();

        const chartOptions = {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { labels: { color: legendColor, font: { family: 'Inter, sans-serif' } }, position: 'top', },
                tooltip: { bodyFont: { family: 'Inter, sans-serif' }, titleFont: { family: 'Inter, sans-serif' } }
            },
            scales: {
                y: { ticks: { color: ticksColor, beginAtZero: true, font: { family: 'Inter, sans-serif' } }, grid: { color: gridColor } },
                x: { ticks: { color: ticksColor, font: { family: 'Inter, sans-serif' } }, grid: { color: gridColor } }
            }
        };

        if (visitorsChartInstance) visitorsChartInstance.destroy();
        const visitorsCtx = document.getElementById('visitorsChart')?.getContext('2d');
        if (visitorsCtx && originalDashboardData.activityLog.length > 0) {
            const labels = [...Array(7)].map((_, i) => {
                const d = new Date();
                d.setDate(d.getDate() - i);
                return d.toLocaleDateString('en-US', { weekday: 'short' });
            }).reverse();

            const viewsData = labels.map(label => originalDashboardData.activityLog.filter(log => log.action === 'viewed' && new Date(log.timestamp).toLocaleDateString('en-US', { weekday: 'short' }) === label).length);
            const commentsData = labels.map(label => originalDashboardData.activityLog.filter(log => log.action === 'commented' && new Date(log.timestamp).toLocaleDateString('en-US', { weekday: 'short' }) === label).length);

            visitorsChartInstance = new Chart(visitorsCtx, {
                type: 'bar',
                data: { 
                    labels: labels, 
                    datasets: [
                        { label: 'Views', data: viewsData, backgroundColor: 'rgba(99, 102, 241, 0.7)'},
                        { label: 'Comments', data: commentsData, backgroundColor: 'rgba(34, 197, 94, 0.7)'}
                    ]
                },
                options: chartOptions
            });
        }
    }

    function applyDashboardFilters() {
        const nameFilter = document.getElementById('filterUserName').value.toLowerCase();
        const emailFilter = document.getElementById('filterUserEmail').value.toLowerCase();
        const dateFilter = document.getElementById('filterDate').value;

        let filteredActivity = originalDashboardData.activityLog;
        let filteredViews = originalDashboardData.articleViews;

        if (nameFilter) {
            filteredActivity = filteredActivity.filter(log => log.user_name && log.user_name.toLowerCase().includes(nameFilter));
            filteredViews = filteredViews.filter(view => view.last_viewed_by && view.last_viewed_by.toLowerCase().includes(nameFilter));
        }
        if (emailFilter) {
            filteredActivity = filteredActivity.filter(log => log.user_email && log.user_email.toLowerCase().includes(emailFilter));
        }
        if (dateFilter) {
            filteredActivity = filteredActivity.filter(log => log.timestamp && log.timestamp.startsWith(dateFilter));
            filteredViews = filteredViews.filter(view => view.last_viewed && view.last_viewed.startsWith(dateFilter));
        }

        renderDashboardTables({ activityLog: filteredActivity, articleViews: filteredViews });
    }

    function renderDashboardTables(data) {
        const { activityLog, articleViews } = data;
        const articleViewsTbody = document.getElementById('articleViewsTbody');
        const activityLogTbody = document.getElementById('activityLogTbody');

        if (articleViewsTbody) {
            articleViewsTbody.innerHTML = (articleViews || []).map(row => {
                 const item = findItem(row.article_id);
                 const sectionSlug = item ? item.sectionSlug : 'home';
                 const itemSlug = item ? item.slug : row.article_id; // Fallback to ID if not found
                 return `
                    <tr>
                        <td><a href="#${sectionSlug}/${itemSlug}" class="user-name-cell">${escapeHTML(row.article_title)}</a></td>
                        <td>${row.total_views || 0}</td>
                        <td>${row.total_comments || 0}</td>
                        <td>${row.positive_feedback_count || 0}</td>
                        <td>${formatReadableDate(row.last_viewed)}</td>
                        <td>${escapeHTML(row.last_viewed_by || 'N/A')}</td>
                    </tr>
                `}).join('') || '<tr><td colspan="6" style="text-align:center; padding: 1rem;">No insight data found for the current filters.</td></tr>';
        }

        if (activityLogTbody) {
            activityLogTbody.innerHTML = (activityLog || []).map(row => {
                const item = findItem(row.item_id);
                const itemTitle = item ? item.title : 'Unknown Item';
                const itemLink = item ? `#${item.sectionSlug}/${item.slug}` : '#';
                return `
                    <tr>
                        <td class="user-name-cell">${escapeHTML(row.user_name)}</td>
                        <td>${escapeHTML(row.user_email || 'N/A')}</td>
                        <td><a href="${itemLink}">${escapeHTML(truncateText(itemTitle, 30))}</a></td>
                        <td><span class="action-badge ${row.action.toLowerCase().replace(/ /g, '_')}">${escapeHTML(row.action)}</span></td>
                        <td>${formatReadableDate(row.timestamp)}</td>
                    </tr>
                `}).join('') || '<tr><td colspan="5" style="text-align:center; padding: 1rem;">No activity found for the current filters.</td></tr>';
        }
    }
    
    function displaySectionContent(sectionSlug) {
        currentOpenItem = null;
        dashboardOverviewContainer.classList.add('hidden');
        standardSectionContentPlaceholder.classList.remove('hidden');
        itemDetailViewPlaceholder.classList.add('hidden');

        const sectionData = kbSystemData.sections.find(s => s.slug === sectionSlug);
        if (!sectionData) {
            standardSectionContentPlaceholder.innerHTML = `<div class="card" style="text-align: center;"><h2 style="color: red;">Section not found: ${escapeHTML(sectionSlug)}</h2></div>`;
            currentSectionTitleEl.textContent = 'Not Found';
            return;
        }

        currentSectionTitleEl.textContent = sectionData.name;
        breadcrumbsContainer.innerHTML = `<a href="#home">Home</a> <span style="margin: 0 5px;">›</span> <span style="font-weight: bold; color: var(--primary-color);">${escapeHTML(sectionData.name)}</span>`;

        let contentHTML = `<div>`;
        if (currentUser?.role === 'admin' && sectionSlug !== 'home') {
             contentHTML += `<div style="text-align: right; margin-bottom: 1.5rem;">
                <button id="openAddContentBtnInSection" class="button" data-section-id="${sectionData.id}">
                    <i class="fas fa-plus-circle"></i> Add Content to ${escapeHTML(sectionData.name)}
                </button>
            </div>`;
        }

        const itemsToDisplay = (sectionData.items || []).filter(item => !item.parent_id);
        
        if (itemsToDisplay.length > 0) {
            contentHTML += `<div class="cards-grid">`;
            itemsToDisplay.forEach(item => contentHTML += renderItemCard(item, sectionData));
            contentHTML += `</div>`;
        } else {
             contentHTML += `<div class="card" style="text-align: center; padding: 40px 20px; min-height: auto;"><p style="font-size: 1.2rem; color: var(--text-color-muted);">No content in this section yet.</p></div>`;
        }
        contentHTML += `</div>`;
        standardSectionContentPlaceholder.innerHTML = contentHTML;

        document.getElementById('openAddContentBtnInSection')?.addEventListener('click', (e) => {
            openAddContentModal(e.currentTarget.dataset.sectionId);
        });
    }
    
    // ✅ NEW: Find item by ID
    function findItem(itemId) {
        for (const section of kbSystemData.sections) {
            const item = section.items?.find(i => i.id === itemId);
            if (item) return { ...item, sectionId: section.id, sectionSlug: section.slug };
        }
        return null;
    }
    
    // ✅ NEW: Find item by Slug
    function findItemBySlug(sectionSlug, itemSlug) {
        const section = kbSystemData.sections.find(s => s.slug === sectionSlug);
        if (section) {
            const item = section.items.find(i => i.slug === itemSlug);
            if (item) return { ...item, sectionId: section.id, sectionSlug: section.slug };
        }
        return null;
    }

    async function displayItemDetail(sectionSlug, itemSlug) {
        const itemData = findItemBySlug(sectionSlug, itemSlug);
        
        if (!itemData) {
            standardSectionContentPlaceholder.innerHTML = `<p style="color: red;">Error: Item not found with slug "${itemSlug}".</p>`;
            return;
        }

        const { error: rpcError } = await supabase.rpc('record_unique_view', {
            p_article_id: itemData.id,
            p_user_id: currentUser.id
        });
        if(rpcError) console.error("Error calling record_unique_view RPC:", rpcError);
        
        // This is a full refresh, might be slow but ensures data consistency
        await loadAndStructureData(); 
        const updatedItemData = findItem(itemData.id); // Find by ID to get fresh data

        if (!updatedItemData) {
             standardSectionContentPlaceholder.innerHTML = `<p style="color: red;">Error: Item data could not be refreshed.</p>`;
            return;
        }

        currentOpenItem = { sectionId: updatedItemData.sectionId, itemId: updatedItemData.id, title: updatedItemData.title };
        dashboardOverviewContainer.classList.add('hidden');
        standardSectionContentPlaceholder.classList.add('hidden');
        itemDetailViewPlaceholder.classList.remove('hidden');

        breadcrumbsContainer.innerHTML = `
            <a href="#home">Home</a> <span style="margin: 0 5px;">›</span>
            <a href="#${updatedItemData.sectionSlug}">${escapeHTML(updatedItemData.sectionSlug.replace(/-/g, ' '))}</a> <span style="margin: 0 5px;">›</span>
            <span style="font-weight: bold; color: var(--primary-color);">${escapeHTML(updatedItemData.title)}</span>`;
        currentSectionTitleEl.textContent = updatedItemData.title;

        let itemIconClass = 'fas fa-file-alt';
        if (updatedItemData.type === 'case') itemIconClass = 'fas fa-briefcase';
        else if (updatedItemData.type === 'article') itemIconClass = 'fas fa-newspaper';
        else if (updatedItemData.type === 'guide') itemIconClass = 'fas fa-book-open';
        else if (updatedItemData.type === 'policy') itemIconClass = 'fas fa-gavel';

        const parentItemInfo = updatedItemData.parent_id ? findItem(updatedItemData.parent_id) : null;
        const backLinkHref = parentItemInfo ? `#${parentItemInfo.sectionSlug}/${parentItemInfo.slug}` : `#${sectionSlug}`;
        const backLinkText = parentItemInfo ? `Back to: ${escapeHTML(truncateText(parentItemInfo.title, 25))}` : 'Back to Section';
        
        let detailHTML = `<div class="item-actions-bar">
            <a href="${backLinkHref}" class="button button-secondary"><i class="fas fa-arrow-left"></i> ${backLinkText}</a>`;
        if (currentUser?.role === 'admin') {
             detailHTML += `<button id="editItemBtn" class="button"><i class="fas fa-edit"></i> Edit Item</button>`;
             detailHTML += `<button id="deleteItemBtn" class="button button-danger"><i class="fas fa-trash-alt"></i> Delete Item</button>`;
        }
        detailHTML += `<button id="downloadPdfItemBtn" class="button-secondary"><i class="fas fa-file-pdf"></i> Export as PDF</button></div>`;
        
        const lastModified = new Date(updatedItemData.last_modified || updatedItemData.created_at);
        const lastUpdatedHTML = `<div class="last-updated-info">Updated on: ${lastModified.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</div>`;

        detailHTML += `<div class="card">
            <div class="item-title-area"><i class="${itemIconClass} fa-title-icon"></i><h2>${escapeHTML(updatedItemData.title)}</h2></div>
            <p class="item-summary">${escapeHTML(stripHtml(updatedItemData.description))}</p>
            ${updatedItemData.tags?.length ? `<div class="card-tags" style="margin-bottom: 1rem;">${updatedItemData.tags.map(tag => `<span class="tag">${escapeHTML(tag)}</span>`).join('')}</div>` : ''}
            <hr class="title-content-divider">${lastUpdatedHTML}
            <div class="kb-content">${updatedItemData.content || '<p>No detailed content available.</p>'}</div>
        </div>`;
        
        const childItems = kbSystemData.sections.flatMap(s => s.items || []).filter(child => child.parent_id === updatedItemData.id);
        if (childItems.length > 0) {
            detailHTML += `<div class="card" style="margin-top: 1.5rem;">
                <h3 style="font-size: 1.25rem; font-weight:600; margin-bottom:1rem; margin-top:0;">Related Topics</h3>
                <ul class="child-items-list">${childItems.map(child => {
                     const childSection = findItem(child.id);
                     return `<li><a href="#${childSection?.sectionSlug || sectionSlug}/${child.slug}"><i class="fas fa-angle-right"></i> ${escapeHTML(child.title)}</a></li>`
                    }).join('')}</ul>
            </div>`;
        }

        const userAvatarHtml = `<div id="userAvatar" style="width:36px; height:36px; margin-top:5px;">${(currentUser.name || 'U').split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase()}</div>`;
        detailHTML += `<div class="item-feedback-section">
            <h4 id="feedbackPrompt">Was this article helpful?</h4>
            <div id="feedbackInteractionContainer">
                <div class="rating-prompt"><div class="rating-buttons" id="ratingButtons">
                    <button id="rateYesBtn"><i class="fas fa-thumbs-up"></i> Yes</button>
                    <button id="rateNoBtn"><i class="fas fa-thumbs-down"></i> No</button>
                </div></div>
                <form id="negativeFeedbackForm" class="hidden">
                    <div class="form-group"><textarea id="feedbackReason" rows="3" placeholder="Your feedback is valuable to us..."></textarea></div>
                    <button type="submit" class="button">Submit Feedback</button>
                    <button type="button" id="cancelNegativeFeedbackBtn" class="button button-secondary">Cancel</button>
                </form>
            </div>
            <div class="read-stats">Total Views: <span id="readStatsCount">${(updatedItemData.views || 0).toLocaleString()}</span></div>
        </div>`;
        detailHTML += `<div class="comments-section">
            <h4><i class="fas fa-comments"></i> Management Notes</h4>
            <div class="comment-post-area">
                ${userAvatarHtml}
                <div class="comment-input-wrapper">
                    <textarea id="newCommentText" placeholder="Add an internal note..."></textarea>
                    <div class="comment-post-actions"><button id="postCommentBtn" class="button">Post Note</button></div>
                </div>
            </div>
            <div class="comment-display-area" id="commentDisplayAreaForItem"></div>
        </div>`;
        
        detailHTML += `
            <div class="comments-section" id="viewHistorySection" style="margin-top: 1rem;">
                <h4><i class="fas fa-history"></i> View History</h4>
                <div class="dashboard-table-wrapper" style="max-height: 250px;">
                    <table>
                        <thead><tr><th>User</th><th>Action</th><th>Timestamp</th></tr></thead>
                        <tbody id="viewHistoryTbody">
                            <tr><td colspan="3" style="text-align:center; padding: 1rem;">Loading history...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>`;

        itemDetailViewPlaceholder.innerHTML = detailHTML;
        setupItemDetailEventListeners(updatedItemData);
    }
    
    async function setupItemDetailEventListeners(itemData) {
        renderComments(itemData.id);
        
        if (itemDetailViewPlaceholder.querySelector('pre.mermaid')) {
            renderMermaidDiagramsInElement(itemDetailViewPlaceholder);
        }

        document.getElementById('editItemBtn')?.addEventListener('click', () => openAddContentModal(itemData.sub_category_id, itemData));
        document.getElementById('deleteItemBtn')?.addEventListener('click', () => openDeleteConfirmModal(itemData.sub_category_id, itemData.id, itemData.title));
        
        document.getElementById('downloadPdfItemBtn')?.addEventListener('click', () => {
            const elementToPrint = document.getElementById('itemDetailViewPlaceholder').cloneNode(true);
            elementToPrint.querySelector('.item-actions-bar')?.remove();
            elementToPrint.querySelector('.item-feedback-section')?.remove();
            elementToPrint.querySelector('.comments-section')?.remove();
            elementToPrint.querySelector('#viewHistorySection')?.remove();
            showToast('Generating PDF...', 'info', 4000);
            const options = { margin: 0.5, filename: `${itemData.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true, logging: false }, jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' } };
            html2pdf().set(options).from(elementToPrint).save();
        });

        document.getElementById('rateYesBtn')?.addEventListener('click', async () => {
            await submitFeedback(itemData.id, 1, null, currentUser);
            document.getElementById('ratingButtons').innerHTML = 'Thank you for your feedback!';
            showToast('Feedback received!', 'success');
        });

        document.getElementById('rateNoBtn')?.addEventListener('click', () => {
            document.getElementById('ratingButtons')?.classList.add('hidden');
            document.getElementById('negativeFeedbackForm')?.classList.remove('hidden');
        });

        document.getElementById('cancelNegativeFeedbackBtn')?.addEventListener('click', () => {
            document.getElementById('negativeFeedbackForm')?.classList.add('hidden');
            document.getElementById('ratingButtons')?.classList.remove('hidden');
        });

        document.getElementById('negativeFeedbackForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const reason = document.getElementById('feedbackReason').value.trim();
            if (reason) {
                await submitFeedback(itemData.id, 0, reason, currentUser);
                document.getElementById('feedbackInteractionContainer').innerHTML = '<h4>Thank you for your feedback!</h4><p>We will review your comments to improve this article.</p>';
                showToast('Feedback received, we will review it.', 'info');
            } else {
                showToast('Please provide a reason.', 'error');
            }
        });

        document.getElementById('postCommentBtn')?.addEventListener('click', async () => {
            const commentTextEl = document.getElementById('newCommentText');
            const commentText = commentTextEl.value.trim();
            if (!commentText) { showToast('Please enter a note.', 'error'); return; }

            const { error } = await addComment(itemData.id, commentText, currentUser);
            if (error) { showToast('Failed to post note.', 'error'); return; }

            renderComments(itemData.id); 
            commentTextEl.value = ''; 
        });
        
        displayViewHistory(itemData.id);
    }
    
    async function renderComments(itemId) {
        const container = document.getElementById('commentDisplayAreaForItem');
        if (!container) return;

        const { data: comments, error } = await supabase.from('kb_comments').select('*').eq('item_id', itemId).order('created_at', { ascending: false });
        if (error || !comments || comments.length === 0) {
            container.innerHTML = `<p style="text-align:center; color: var(--text-color-muted); padding: 1rem;">No notes yet.</p>`;
            return;
        }

        container.innerHTML = comments.map(comment => {
            const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(comment.author_name || 'A')}&background=random&color=fff&rounded=true&font-size=0.5`;
            return `
                <div class="comment" data-comment-id="${comment.id}">
                    <img src="${avatarUrl}" alt="${escapeHTML(comment.author_name)}'s avatar">
                    <div class="comment-content">
                        <div class="comment-header">
                            <span class="comment-author">${escapeHTML(comment.author_name)}</span>
                            <span class="comment-timestamp">${formatReadableDate(comment.created_at)}</span>
                        </div>
                        <div class="comment-text">${escapeHTML(comment.body).replace(/\n/g, '<br>')}</div>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    async function displayViewHistory(itemId) {
        const historyTbody = document.getElementById('viewHistoryTbody');
        if (!historyTbody) return;

        const { data, error } = await supabase
            .from('activity_log')
            .select('user_name, action, timestamp')
            .eq('item_id', itemId)
            .order('timestamp', { ascending: false });

        if (error) {
            console.error('Error fetching view history:', error);
            historyTbody.innerHTML = `<tr><td colspan="3" style="text-align:center; color:red;">Failed to load history.</td></tr>`;
            return;
        }

        if (data.length === 0) {
            historyTbody.innerHTML = `<tr><td colspan="3" style="text-align:center;">No activity recorded for this item yet.</td></tr>`;
            return;
        }

        historyTbody.innerHTML = data.map(log => `
            <tr>
                <td>${escapeHTML(log.user_name)}</td>
                <td><span class="action-badge ${log.action.toLowerCase().replace(/ /g, '_')}">${escapeHTML(log.action)}</span></td>
                <td>${formatReadableDate(log.timestamp)}</td>
            </tr>
        `).join('');
    }

    const contentTemplates = {
        standard_article: { type: 'article', titlePrefix: 'New Article: ', summary: 'A general article about [topic].', content: '<h2>Introduction</h2><p>[Provide a brief introduction to the topic.]</p><h2>Main Content</h2><p>[Elaborate on the main points here.]</p><ul><li>Point 1</li><li>Point 2</li></ul>', tags: ['article'] },
        troubleshooting_guide: { type: 'case', titlePrefix: 'Case: Troubleshooting ', summary: 'A step-by-step guide to resolve [issue].', content: '<h3>Issue Description</h3><p>[Clearly describe the problem.]</p><h3>Resolution Steps</h3><ol><li><strong>Step 1:</strong> [Action to take]</li></ol>', tags: ['troubleshooting', 'guide', 'case'] },
        policy_document: { type: 'policy', titlePrefix: 'Policy: ', summary: 'Official policy regarding [subject matter].', content: '<h1>[Policy Title]</h1><p><strong>Version:</strong> 1.0</p><h2>1. Purpose</h2><p>[State the purpose of this policy.]</p>', tags: ['policy', 'official'] },
        blank: { type: 'article', titlePrefix: '', summary: '', content: '<p><br></p>', tags: [] }
    };

    function applyTemplate(templateKey) {
        const template = contentTemplates[templateKey];
        if (!template) return;
        contentTypeSelect.value = template.type;
        document.getElementById('contentTitle').value = template.titlePrefix;
        document.getElementById('contentSummary').value = template.summary;
        if (mainQuillEditor) mainQuillEditor.root.innerHTML = template.content;
        contentTagsInput.value = template.tags.join(', ');
        addContentForm.classList.remove('hidden');
        templateSelectionContainer.classList.add('hidden');
        contentTypeSelect.dispatchEvent(new Event('change')); 
        document.getElementById('contentTitle').focus();
    }

    function openAddContentModal(sectionIdForContent, itemToEdit = null) {
        addContentForm.reset();
        addContentForm.dataset.sectionId = sectionIdForContent;
        editingItemIdInput.value = ""; 
        
        if (!mainQuillEditor) {
            Quill.register('modules/imageResize', window.ImageResize.default);
            mainQuillEditor = new Quill('#quillEditor', { 
                theme: 'snow',
                modules: { 
                    toolbar: [
      [{ 'font': [] }, { 'size': ['small', false, 'large', 'huge'] }],
      ['bold', 'italic', 'underline', 'strike'],
      [{ 'color': [] }, { 'background': [] }],
      [{ 'script': 'sub'}, { 'script': 'super' }],
      [{ 'header': 1 }, { 'header': 2 }],
      [{ 'list': 'ordered'}, { 'list': 'bullet' }],
      [{ 'indent': '-1'}, { 'indent': '+1' }],
      [{ 'direction': 'rtl' }],
      [{ 'align': [] }],
      ['link', 'image', 'video'],
      ['clean']
    ],
                    imageResize: { modules: [ 'Resize', 'DisplaySize', 'Toolbar' ] }
                },
                placeholder: 'Enter detailed content here...'
            });
            document.getElementById('imageFile').addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file?.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = e => mainQuillEditor.insertEmbed(mainQuillEditor.getSelection(true).index, 'image', e.target.result);
                    reader.readAsDataURL(file);
                }
            });
        }

        const parentItemSelect = document.getElementById('parentItem');
        parentItemSelect.innerHTML = '<option value="">-- None (Top-Level Item) --</option>';
        const sectionForDropdown = kbSystemData.sections.find(s => s.id === sectionIdForContent);
        if (sectionForDropdown) {
            sectionForDropdown.items.forEach(item => {
                if (!itemToEdit || item.id !== itemToEdit.id) {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = item.title;
                    parentItemSelect.appendChild(option);
                }
            });
        }

        if (itemToEdit) {
            document.getElementById('addContentModalTitle').textContent = 'Edit Content';
            editingItemIdInput.value = itemToEdit.id; 
            document.getElementById('contentTitle').value = itemToEdit.title;
            document.getElementById('contentSummary').value = itemToEdit.description; 
            contentTypeSelect.value = itemToEdit.type;
            if (itemToEdit.url) document.getElementById('contentUrl').value = itemToEdit.url;
            if (itemToEdit.parent_id) parentItemSelect.value = itemToEdit.parent_id;
            mainQuillEditor.clipboard.dangerouslyPasteHTML(0, itemToEdit.content || '<p><br></p>');
            contentTagsInput.value = (itemToEdit.tags || []).join(', ');
            templateSelectionContainer.classList.add('hidden');
            addContentForm.classList.remove('hidden');
        } else {
            document.getElementById('addContentModalTitle').textContent = 'Add New Content';
            mainQuillEditor.setContents([{ insert: '\n' }], 'silent');
            templateSelectionContainer.classList.remove('hidden');
            addContentForm.classList.add('hidden');
        }
        
        contentTypeSelect.dispatchEvent(new Event('change'));
        addContentModalOverlay.classList.remove('hidden');
    }

    document.querySelectorAll('.template-button').forEach(button => {
        button.addEventListener('click', () => applyTemplate(button.dataset.template));
    });

    function closeAddContentModal() {
        addContentModalOverlay.classList.add('hidden');
    }

    contentTypeSelect.addEventListener('change', (e) => {
        const type = e.target.value;
        contentUrlContainer.classList.toggle('hidden', !['form_sheet', 'design'].includes(type));
        contentDetailContainer.classList.toggle('hidden', ['form_sheet', 'design'].includes(type));
        contentDetailLabel.textContent = type === 'case' ? 'Case Details / Resolution Steps' : 'Content';
    });

    addContentForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const sectionId = addContentForm.dataset.sectionId;
        const editingId = editingItemIdInput.value;

        const itemData = {
            title: document.getElementById('contentTitle').value.trim(),
            description: document.getElementById('contentSummary').value.trim(),
            tags: contentTagsInput.value.split(',').map(t => t.trim()).filter(Boolean),
            type: contentTypeSelect.value,
            content: mainQuillEditor.root.innerHTML,
            url: document.getElementById('contentUrl').value.trim() || null,
            sub_category_id: sectionId,
            parent_id: document.getElementById('parentItem').value || null,
            last_modified: new Date().toISOString(),
            author_id: currentUser.id,
            version: 1.0
        };
        if (editingId) itemData.id = editingId;

        if (!itemData.title || !itemData.description) {
            showToast('Title and Summary/Description are required.', 'error');
            return;
        }

        const { data: savedItem, error } = await supabase.from('cases').upsert(itemData).select().single();
        if (error) {
            console.error("Error saving content:", error);
            showToast(`Failed to save content: ${error.message}`, 'error');
            return;
        }

        await saveVersion(savedItem, currentUser);
        if(!editingId) {
            await logActivity(currentUser, savedItem.id, savedItem.type, 'created');
        } else {
             await logActivity(currentUser, savedItem.id, savedItem.type, 'updated');
        }
        
        showToast(`Content '${savedItem.title}' saved successfully!`, 'success');
        closeAddContentModal();
        await loadAndStructureData();
        handleNavigation();
    });

    window.openEditModal = (sectionId, itemId) => {
        const item = findItem(itemId);
        if (item) openAddContentModal(sectionId, item);
    };
    window.openDeleteModal = (sectionId, itemId, itemTitle) => {
        openDeleteConfirmModal(sectionId, itemId, itemTitle);
    };

    function openDeleteConfirmModal(sectionId, itemId, itemTitle) {
        deleteConfirmMessage.innerHTML = `Are you sure you want to delete "<strong>${escapeHTML(itemTitle)}</strong>"? This cannot be undone.`;
        confirmDeleteItemBtn.dataset.itemId = itemId;
        deleteConfirmModalOverlay.classList.remove('hidden');
    }

    confirmDeleteItemBtn.addEventListener('click', async () => {
        const itemId = confirmDeleteItemBtn.dataset.itemId;
        const { error } = await supabase.from('cases').delete().eq('id', itemId);
        
        if (error) {
            showToast(`Error deleting item: ${error.message}`, 'error');
            return;
        }

        showToast(`Item deleted.`, 'success');
        deleteConfirmModalOverlay.classList.add('hidden');
        await loadAndStructureData();
        
        if (window.location.hash.includes(itemId)) { // Check if the deleted item ID is in the hash
            window.location.hash = `#home`;
        } else {
            handleNavigation();
        }
    });

    globalSearchInput.addEventListener('input', () => {
        const query = globalSearchInput.value.trim().toLowerCase();
        searchResultsContainer.innerHTML = ''; 

        if (query.length < 2) { 
            searchResultsContainer.classList.add('hidden'); 
            return; 
        }
        
        const allItems = kbSystemData.sections.flatMap(s => s.items.map(i => ({...i, sectionName: s.name, sectionSlug: s.slug })));
        const results = allItems.filter(i => i.title.toLowerCase().includes(query) || stripHtml(i.description).toLowerCase().includes(query));
        
        if (results.length > 0) {
            results.slice(0, 7).forEach(r => {
                const linkEl = document.createElement('a');
                linkEl.href = `#${r.sectionSlug}/${r.slug}`;
                linkEl.innerHTML = `<div>${highlightText(r.title, query)} <span style="font-size: 0.8em; color: var(--text-color-muted);">(${escapeHTML(r.sectionName)})</span></div>`;
                searchResultsContainer.appendChild(linkEl);
            });
        } else {
            searchResultsContainer.innerHTML = `<div style="padding: 0.75rem; color: var(--text-color-muted); text-align: center;">No results found.</div>`;
        }
        searchResultsContainer.classList.remove('hidden');
    });

    function handleNavigation() {
        if (!currentUser) return;
        const hash = window.location.hash.substring(1) || 'home';
        // ✅ FIX: Split to get section and item slugs
        const [sectionSlug, itemSlug] = hash.split('/');
        
        highlightSidebarLink(sectionSlug);

        if (sectionSlug === 'home') displayDashboard();
        else if (itemSlug) displayItemDetail(sectionSlug, itemSlug);
        else if (sectionSlug) displaySectionContent(sectionSlug);
        else displayDashboard(); 

        document.getElementById('contentWrapper')?.scrollTo(0,0);
    }

    async function initializeApp() {
        currentUser = await getCurrentUserProfile();
        if (!currentUser) {
            window.location.href = "login.html";
            return;
        }

        userNameDisplayHeader.textContent = currentUser.name;
        const initials = (currentUser.name || 'U').split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        userAvatar.textContent = initials;
        currentUserRoleSpan.textContent = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
        
        showToast("Connecting to database...", 'info', 1500);
        await loadAndStructureData();

        populateSidebar();
        handleNavigation(); 
        
        window.addEventListener('hashchange', handleNavigation);
        
        logoutButton.addEventListener('click', () => logoutConfirmModalOverlay.classList.remove('hidden'));
        [closeLogoutConfirmModalBtn, cancelLogoutBtn].forEach(btn => btn.addEventListener('click', () => logoutConfirmModalOverlay.classList.add('hidden')));
        confirmLogoutBtn.addEventListener('click', logout);
        
        [closeAddContentModalBtn, cancelAddContentBtn].forEach(btn => btn.addEventListener('click', closeAddContentModal));
        [closeDeleteConfirmModalBtn, cancelDeleteItemBtn].forEach(btn => btn.addEventListener('click', () => deleteConfirmModalOverlay.classList.add('hidden')));

        document.addEventListener('click', e => {
            if (!globalSearchInput.contains(e.target)) searchResultsContainer.classList.add('hidden');
        });
        
        showToast(`Welcome back, ${currentUser.name}!`, 'success', 3000);
    }

    initializeApp();
</script>
</body>
</html>
