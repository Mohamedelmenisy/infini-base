<!DOCTYPE html>
<html lang="en" dir="ltr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InfiniBase - Knowledge Base</title>
    <!-- Updated Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32' width='32' height='32'><rect width='32' height='32' rx='4' fill='%236366f1'/><text x='50%' y='55%' dominant-baseline='middle' text-anchor='middle' font-family='Arial, sans-serif' font-size='18' font-weight='bold' fill='white'>IB</text></svg>">
    
    <!-- CDNs -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>

    <style>
        :root {
            /* Permanent Dark Theme Variables */
            --primary-color: #6366f1; /* Brighter Indigo for dark */
            --primary-color-hover: #4f46e5;
            --secondary-color: #9ca3af;

            --text-color: #d1d5db;
            --text-color-muted: #9ca3af;
            --text-color-inverted: #ffffff; 
            --text-color-subtle: #9ca3af;

            --bg-color: #111827; /* Dark gray */
            --bg-color-alt: #1f2937; /* Slightly lighter dark gray for cards/modals */
            --bg-color-sidebar: #1f2937;
            --bg-color-header: rgba(31, 41, 55, 0.9);
            --bg-color-modal: #1f2937;
            --bg-color-hover: #374151;
            --bg-color-active: var(--primary-color);

            --border-color: #374151;
            --border-color-darker: #4b5563;

            --card-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            --card-hover-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            
            --border-radius: 0.5rem; 
            --border-radius-lg: 0.75rem;
            --header-height: 70px;
            --sidebar-width: 260px;

            --yes-color: #22c55e; /* Green for Yes */
            --no-color: #ef4444;   /* Red for No */
            --rating-color: #fbbf24; /* Amber 400 for ratings */
            --step-done-color: #22c55e;
            --step-pending-color: #f59e0b;
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            line-height: 1.6;
            font-size: 16px;
        }

        .container-fluid {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-color-sidebar);
            padding: 1.5rem;
            border-right: 1px solid var(--border-color); /* LTR */
            position: fixed;
            top: 0;
            left: 0; /* LTR */
            height: 100vh;
            overflow-y: auto;
            transition: transform 0.3s ease-in-out, background-color 0.3s ease, border-color 0.3s ease;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }
        .sidebar.closed {
            transform: translateX(-100%); /* LTR */
        }
        @media (min-width: 768px) {
            .sidebar.closed { transform: translateX(0); }
        }

        .sidebar-header {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            color: var(--text-color); 
        }
        .sidebar-header i { 
            margin-right: 0.75rem; /* LTR */
            color: var(--primary-color);
            font-size: 1.8rem;
        }
        .sidebar-logo-text {
             color: var(--text-color);
        }

        .sidebar-nav { flex-grow: 1; }

        .sidebar-section-title {
            padding-left: 0.75rem; /* LTR */
            font-size: 0.75rem;
            font-weight: 700; /* Increased font-weight for better visibility */
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--text-color-muted);
        }

        .sidebar-link {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-radius: var(--border-radius);
            transition: background-color 0.2s ease, color 0.2s ease;
            font-weight: 500;
            color: var(--text-color-subtle);
            text-decoration: none;
            margin-bottom: 0.25rem;
        }
        .sidebar-link i {
            margin-right: 0.75rem; /* LTR */
            width: 1.5rem; /* Adjusted for font-size */
            font-size: 1.5rem; /* Increased icon size */
            text-align: center;
            transition: color 0.2s ease;
        }
        .sidebar-link:hover {
            background-color: var(--bg-color-hover);
            color: var(--text-color);
        }
        .sidebar-link.active {
            background-color: var(--bg-color-active); /* Primary color */
            color: var(--text-color-inverted) !important; /* White text */
            font-weight: 600;
        }
        .sidebar-link.active i {
            color: var(--text-color-inverted) !important; /* White icon on primary background */
        }

        .sidebar-footer {
            margin-top: auto; 
            padding-top: 1rem;
        }
        .sidebar-footer button {
            width: 100%;
            margin-top: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sidebar-footer button i { margin-right: 0.5rem; }


        .content-wrapper {
            flex-grow: 1;
            padding-right: 1.5rem; /* LTR */
            padding-left: 1.5rem;
            transition: margin-left 0.3s ease-in-out; /* LTR */
            height: 100vh;
            overflow-y: auto;
        }
        @media (min-width: 768px) {
             .content-wrapper { margin-left: var(--sidebar-width); /* LTR */ }
             .sidebar.closed + .content-wrapper { margin-left: 0; /* LTR */ }
        }

        .content-header {
            background-color: var(--bg-color-header);
            padding: 1.25rem 2rem; 
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky; 
            top: 0;
            left: var(--sidebar-width); /* LTR, adjusted for fixed sidebar */
            right: 0;
            height: var(--header-height);
            z-index: 50;
            backdrop-filter: blur(8px); 
        }
         @media (max-width: 767px) { /* Mobile: header spans full width */
            .content-header {
                left: 0;
            }
        }
        .header-left-content { display: flex; align-items: center; } 
        #currentSectionTitle {
            font-size: 1.5rem; 
            font-weight: bold;
            margin: 0;
        }
        #breadcrumbs {
            font-size: 0.875rem; 
            color: var(--text-color-muted);
            margin-top: 0.25rem;
        }
        #breadcrumbs a { color: var(--primary-color); text-decoration: none; }
        #breadcrumbs a:hover { text-decoration: underline; }

        .header-right-content { display: flex; align-items: center; gap: 1rem; }
        .search-container { position: relative; }
        .search-container input[type="search"] {
            padding: 0.625rem 1rem 0.625rem 2.5rem; /* py-2.5 pl-10 pr-4 for LTR */
            border: 1px solid var(--border-color-darker);
            border-radius: 9999px; 
            min-width: 250px; 
            background-color: var(--bg-color-alt); 
            color: var(--text-color);
        }
        .search-container input[type="search"]::placeholder {
            color: var(--text-color-muted);
            opacity: 0.8;
        }
        .search-container .search-icon {
            position: absolute;
            inset-inline-start: 0.75rem; 
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-color-muted);
        }
        #searchResultsContainer {
            position: absolute;
            background-color: var(--bg-color-alt);
            border: 1px solid var(--border-color);
            border-top: none;
            width: 100%; 
            max-height: 300px; 
            overflow-y: auto;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); 
            z-index: 60; 
            border-radius: 0 0 var(--border-radius) var(--border-radius);
        }
        #searchResultsContainer a {
            display: block;
            padding: 0.75rem; 
            text-decoration: none;
            color: var(--text-color);
        }
        #searchResultsContainer a:hover { background-color: var(--bg-color-hover); }
        #searchResultsContainer mark { background-color: #78350f; color: #f3f4f6; }


        .user-profile { display: flex; align-items: center; gap: 0.5rem; }
        .user-profile img { width: 36px; height: 36px; border-radius: 50%; }
        #userNameDisplayHeader { font-weight: 500; }
        @media (max-width: 640px) { 
            #userNameDisplayHeader { display: none; }
        }

        main { padding: 1.5rem 0; }

        .card {
            background-color: var(--bg-color-alt);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg); 
            padding: 1.5rem;
            margin-bottom: 1.5rem; 
            box-shadow: var(--card-shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease, border-color 0.3s ease;
            display: flex;
            flex-direction: column; 
            min-height: 150px; 
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--card-hover-shadow);
        }
        .card-header-icon {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .card-icon-container {
            padding: 0.75rem;
            border-radius: 50%;
            margin-right: 1rem; /* LTR */
            background-color: var(--primary-color-hover); 
        }
        .card-icon-container i {
            font-size: 1.25rem;
            color: var(--text-color-inverted);  
        }
        .card h3 { margin-top: 0; font-size: 1.125rem; font-weight: 600; color: var(--text-color); line-height: 1.3; }
        .card p { margin-bottom: 1rem; font-size: 0.875rem; color: var(--text-color-subtle); flex-grow: 1; }
        .card .item-meta-info {
            margin-top: auto; 
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border-color);
        }
        .card .item-cta-link {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500; 
            font-size: 0.875rem;
        }
        .card .item-cta-link:hover { text-decoration: underline; color: var(--primary-color-hover); }
        .item-type-badge {
            font-size: 0.75rem; 
            padding: 0.25rem 0.75rem; 
            border-radius: 9999px; 
            background-color: var(--bg-color-hover); 
            color: var(--text-color-subtle); 
            font-weight: 600; 
            text-transform: uppercase;
        }
        .card-tags span {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 10px;
            background-color: var(--bg-color-hover);
            color: var(--text-color-subtle);
            display: inline-block;
            margin: 0 5px 5px 0; /* LTR */
        }

        .button, button {
            background-color: var(--primary-color);
            color: var(--text-color-inverted);
            border: 1px solid transparent;
            padding: 0.625rem 1rem; 
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.875rem; 
            font-weight: 500; 
            transition: background-color 0.2s, border-color 0.2s, color 0.2s;
            text-decoration: none; 
            display: inline-flex; 
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .button:hover, button:hover {
            background-color: var(--primary-color-hover);
        }
        .button-secondary {
            background-color: transparent;
            color: var(--text-color-subtle);
            border-color: var(--border-color-darker);
        }
        .button-secondary:hover { background-color: var(--bg-color-hover); color: var(--text-color); }
        .button-danger {
            background-color: #dc2626; 
            color: var(--text-color-inverted);
        }
        .button-danger:hover { background-color: #b91c1c; }
        input:focus, button:focus, select:focus, textarea:focus, a:focus { 
            outline: 2px solid transparent;
            outline-offset: 2px;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.6); 
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.75); 
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.2s ease-out;
        }
        .modal-overlay:not(.hidden) { opacity: 1; }
        .modal-content {
            background-color: var(--bg-color-modal);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 48rem; 
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.95);
            opacity: 0;
            transition: transform 0.2s ease-out, opacity 0.2s ease-out, background-color 0.3s ease, border-color 0.3s ease;
        }
        .modal-overlay:not(.hidden) .modal-content { transform: scale(1); opacity: 1; }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem; 
        }
        .modal-header h2 { margin-top: 0; font-size: 1.5rem; font-weight: 700; }
        .modal-header .close-button { 
            background: none; border: none; font-size: 1.5rem; color: var(--text-color-muted); cursor: pointer;
            padding: 0.25rem; line-height: 1; border-radius: 50%;
        }
        .modal-header .close-button:hover { background-color: var(--bg-color-hover); }
        
        .modal-body { /* For modals with just text content like confirm */
            padding-bottom: 1rem;
            font-size: 1rem;
            color: var(--text-color);
        }

        .modal-actions {
            margin-top: 1.5rem; 
            text-align: right; /* LTR */
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end; /* LTR */
            gap: 0.75rem; 
        }
         .modal-actions.no-border {
            border-top: none;
            padding-top: 0;
        }


        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.25rem; font-weight: 500; font-size: 0.875rem; }
        .form-group input[type="text"],
        .form-group input[type="url"],
        .form-group input[type="email"], /* Added for feedback modal */
        .form-group input[type="file"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.625rem; 
            border: 1px solid var(--border-color-darker); 
            border-radius: var(--border-radius);
            box-sizing: border-box;
            background-color: var(--bg-color); 
            color: var(--text-color);
        }
        .form-group textarea { min-height: 100px; }
        
        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: var(--text-color-muted);
            opacity: 0.8; /* Ensure it's not too faint */
        }
        
        /* Styles for Add Content Template Selection */
        #templateSelectionContainer { margin-bottom: 1.5rem; }
        #templateSelectionContainer h3 { font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-color); }
        .template-buttons-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .template-button {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color-darker);
            color: var(--text-color-subtle);
            padding: 1rem;
            border-radius: var(--border-radius);
            text-align: left; /* Maintained */
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex; /* Added for flex alignment */
            flex-direction: column; /* Stack items vertically */
            align-items: flex-start; /* Align items to the start (left) */
        }
        .template-button:hover {
            border-color: var(--primary-color);
            background-color: var(--bg-color-hover);
            color: var(--text-color);
        }
        .template-button i { 
            font-size: 1.5rem; 
            margin-bottom: 0.75rem; /* Increased margin */
            display: block; 
            color: var(--primary-color); 
            width: 100%; /* Ensure icon container takes width for alignment if needed */
            text-align: left; /* Ensure icon itself is left-aligned */
        }
        .template-button h4 { 
            font-size: 1rem; 
            font-weight: 600; 
            margin-bottom: 0.5rem; /* Increased margin */
        }
        .template-button p { 
            font-size: 0.8rem; 
            line-height: 1.4; 
            color: var(--text-color-muted); /* Consistent with other paragraph text */
        }


        .ql-toolbar {
            background: var(--bg-color);
            border-color: var(--border-color-darker) !important;
            border-top-left-radius: var(--border-radius);
            border-top-right-radius: var(--border-radius);
        }
        .ql-toolbar .ql-stroke { stroke: var(--text-color-muted); }
        .ql-toolbar .ql-fill { fill: var(--text-color-muted); }
        .ql-toolbar .ql-picker-label { color: var(--text-color-muted); }
        .ql-snow .ql-picker.ql-expanded .ql-picker-options { background-color: var(--bg-color-alt); border-color: var(--border-color-darker); }
        .ql-snow .ql-picker-options .ql-picker-item:hover { color: var(--primary-color); }


        .ql-container {
            background: var(--bg-color-alt);
            border-color: var(--border-color-darker) !important;
            color: var(--text-color);
            min-height: 150px; 
            border-bottom-left-radius: var(--border-radius);
            border-bottom-right-radius: var(--border-radius);
            font-size: 1rem;
        }
        .ql-editor { padding: 12px; }
        .ql-editor.ql-blank::before {
            color: var(--text-color-muted);
            opacity: 0.6;
        }


        footer {
            text-align: center;
            padding: 1.5rem;
            font-size: 0.875rem;
            color: var(--text-color-muted);
            border-top: 1px solid var(--border-color);
            margin-top: auto; 
        }

        .mobile-sidebar-toggle {
            display: block;
            position: fixed;
            top: calc((var(--header-height) - 40px) / 2); 
            left: 1.5rem; /* LTR */
            z-index: 101; 
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 0.75rem; 
            border-radius: var(--border-radius);
            font-size: 1.25rem; 
            line-height: 1;
        }
        @media (min-width: 768px) {
            .mobile-sidebar-toggle { display: none; }
            .header-left-content #currentSectionTitle { margin-left: 0; } /* No toggle on desktop */
        }
        @media (max-width: 767px) {
            .header-left-content #currentSectionTitle { margin-left: 0.5rem; } /* Space for toggle */
            .content-header { padding: 1rem; }
            .header-right-content .search-container { display:none; } 
        }

        .toast-notification {
            position: fixed;
            bottom: 20px;
            right: 20px; /* LTR */
            padding: 12px 18px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 2000; 
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            display: flex;
            align-items: center;
            background-color: var(--bg-color-alt); 
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }
        .toast-notification.show { opacity: 1; transform: translateY(0); }
        .toast-icon { margin-right: 10px; /* LTR */ font-size: 1.2em; }
        .toast-success { background-color: #10b981; color: white; border-color: #059669; } 
        .toast-error { background-color: #ef4444; color: white; border-color: #dc2626; } 
        .toast-info { background-color: #3b82f6; color: white; border-color: #2563eb; } 

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 1.5rem; 
        }

        .kb-content h1, .kb-content h2, .kb-content h3 { margin-top: 1.5em; margin-bottom: 0.5em; color: var(--text-color); }
        .kb-content p { margin-bottom: 1em; }
        .kb-content ul, .kb-content ol { margin-bottom: 1em; padding-left: 20px; /* LTR */ }
        .kb-content li { margin-bottom: 0.5em; }
        .kb-content strong { font-weight: bold; }
        .kb-content em { font-style: italic; }
        .kb-content a { color: var(--primary-color); text-decoration: underline; }
        .kb-content pre:not(.mermaid) { 
            background-color: var(--bg-color);
            padding: 10px;
            border-radius: var(--border-radius);
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            border: 1px solid var(--border-color);
            color: var(--text-color); 
        }
         .kb-content code { 
            background-color: var(--bg-color-hover);
            padding: 0.2em 0.4em;
            margin: 0;
            font-size: 85%;
            border-radius: 3px;
        }
        mark {
            padding: 0.1em 0.2em; border-radius: 0.2em; font-weight: bold;
            background-color: #78350f; color: #f3f4f6; 
        }

        .hidden { display: none !important; }

        .chart-container {
            position: relative;
            padding: 1rem;
            border-radius: var(--border-radius-lg);
            background-color: var(--bg-color-alt);
            height: 320px; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
        }
        .chart-container canvas { 
            max-width: 100%;
            max-height: 100%;
        }
        .chart-container h3 {
            font-size: 1.125rem; 
            font-weight: 600; 
            margin-bottom: 0.5rem;
            text-align: center;
            width: 100%; 
        }

        /* Mermaid Diagram Specific CSS Styles */
        .mermaid-flow-card { 
            background-color: var(--bg-color-alt);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--card-shadow);
            margin-bottom: 1.5rem;
        }
        .mermaid-flow-card .flow-title-area {
            display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;
        }
        .mermaid-flow-card .flow-title-area i.fa-flow-icon {
            font-size: 2rem; color: var(--primary-color); 
        }
        .mermaid-flow-card .flow-title-area h2 { font-size: 1.8rem; margin:0; }
        .mermaid-flow-card .flow-summary { color: var(--text-color-subtle); margin-bottom: 1rem; font-style: italic; }

        .mermaid-diagram-container {
            overflow-x: auto; 
            padding: 10px; 
            background-color: var(--bg-color); /* Diagram area BG */
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            min-height: 400px; /* Ensure space for diagram */
        }
        .mermaid-diagram-container svg { 
            display: block; /* Helps with centering and layout */
            margin: 0 auto; 
            max-width: 100%; 
            height: auto; /* Let height adjust based on content */
        }
        /* Base Mermaid text styling */
        .mermaid-diagram-container text { 
            fill: var(--text-color) !important; 
            font-family: 'Inter', sans-serif !important; 
            font-size: 13px !important; /* Base text size in diagram */
        }
        /* Edge labels and general labels */
        .mermaid-diagram-container .edgeLabel,
        .mermaid-diagram-container .edgeLabel span, /* For labels on edges */
        .mermaid-diagram-container .label { /* For labels inside nodes if not overridden by class */
            color: var(--text-color) !important;
            fill: var(--text-color) !important;
            font-size: 12px !important; /* Slightly smaller for edge labels */
        }
        /* Specific Mermaid elements */
        .mermaid-diagram-container .actor { stroke: var(--text-color-muted) !important; fill: var(--bg-color-alt) !important; }
        .mermaid-diagram-container .messageText { fill: var(--text-color) !important; }
        
        /* General Mermaid node shapes - These are often overridden by classDef in diagram and specific CSS below */
        .mermaid-diagram-container rect, 
        .mermaid-diagram-container polygon, 
        .mermaid-diagram-container ellipse,
        .mermaid-diagram-container circle {
            stroke: var(--primary-color) !important; 
            fill: var(--bg-color-alt) !important; 
            stroke-width: 1.5px !important; /* Default stroke width */
        }
        /* For subgraph/cluster backgrounds */
        .mermaid-diagram-container .cluster rect {
             fill: var(--bg-color) !important; /* Darker fill for cluster background */
             stroke: var(--border-color-darker) !important;
        }
        /* Arrowheads and Edges */
        .mermaid-diagram-container .arrowheadPath {
            fill: var(--primary-color) !important;
        }
        .mermaid-diagram-container .edgePaths path, .edgePath { /* Class for edges */
            stroke: var(--primary-color) !important;
            stroke-width: 1.5px !important;
        }

        /* CSS for node classes defined in Mermaid graph (sup_flow_compensation) */
        .mermaid-diagram-container .decision rect, .mermaid-diagram-container .decision polygon { /* Diamond shape for decisions */
            fill: var(--primary-color) !important; 
            stroke: var(--text-color-inverted) !important; 
            rx: 5px !important; ry: 5px !important; /* Border radius for decision nodes */
        }
        .mermaid-diagram-container .decision text { 
            fill: var(--text-color-inverted) !important; 
            font-weight: 500 !important;
        }

        .mermaid-diagram-container .process rect { /* Rectangle for process steps */
            fill: var(--bg-color-alt) !important; 
            stroke: var(--primary-color) !important; 
            rx: 5px !important; ry: 5px !important; /* Border radius */
        }
        .mermaid-diagram-container .process text { fill: var(--text-color) !important; }
        
        .mermaid-diagram-container .startEnd rect { /* Rounded rectangle for start/end */
            fill: var(--yes-color) !important; 
            stroke: var(--bg-color) !important; 
            rx: 20px !important; ry: 20px !important; /* More pronounced rounding */
        }
        .mermaid-diagram-container .startEnd text { 
            fill: var(--text-color-inverted) !important; 
            font-weight: bold !important;
        }

        .mermaid-diagram-container .actionNode rect { /* For nodes requiring user action */
            fill: var(--rating-color) !important; /* Amber color */
            stroke: var(--bg-color) !important; 
            rx: 5px !important; ry: 5px !important;
        }
        .mermaid-diagram-container .actionNode text { 
            fill: var(--bg-color) !important; /* Dark text on amber */
            font-weight: 500 !important;
        }
        
        /* Style for the small text (script examples) inside nodes */
        .mermaid-diagram-container .scriptText tspan { /* Mermaid wraps multi-line text in tspan */
            fill: var(--text-color-subtle) !important;
            font-style: italic !important;
            font-size: 11px !important;
        }
        
        /* Styling for clickable buttons inside Mermaid nodes (OLD - kept for reference if used elsewhere) */
        .mermaid-diagram-container .mermaid-action-btn {
            background-color: var(--primary-color-hover); 
            color: white; 
            border:none; 
            padding: 4px 8px; 
            font-size: 11px; 
            border-radius:3px; 
            cursor:pointer; 
            margin-top:4px; 
            display: inline-block;
        }
        .mermaid-diagram-container .mermaid-action-btn:hover { 
            background-color: var(--primary-color); 
        }
        /* NEW: Styling for text that indicates an action when using click directive */
        .mermaid-diagram-container .mermaid-action-text {
            color: var(--primary-color); /* Link color */
            text-decoration: underline;
            font-weight: 500; /* Make it stand out a bit */
            display: inline-block; /* If needed for layout */
            margin-top: 4px; /* Consistent with old button margin */
            font-size: 11px; /* Consistent small size */
        }

        /* Links inside nodes */
        .mermaid-diagram-container a { color: var(--primary-color); fill: var(--primary-color) !important; } 
        .mermaid-diagram-container a text { color: var(--primary-color) !important; fill: var(--primary-color) !important; }


        /* Item Detail View Specific */
        #itemDetailViewPlaceholder .card { 
            /* Styles for general cards within detail view if needed */
        }
        #itemDetailViewPlaceholder .item-title-area {
            display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;
        }
        #itemDetailViewPlaceholder .item-title-area i.fa-title-icon { 
            font-size: 2rem; color: var(--primary-color); 
        }
        #itemDetailViewPlaceholder .item-title-area h2 { font-size: 1.8rem; margin:0; }
        #itemDetailViewPlaceholder .item-summary { color: var(--text-color-subtle); margin-bottom: 1rem; font-style: italic; }
        #itemDetailViewPlaceholder hr.title-content-divider { 
             margin: 1.5rem 0; border-color: var(--border-color); 
        }
        #itemDetailViewPlaceholder .kb-content ul { list-style-type: disc; }
        #itemDetailViewPlaceholder .child-items-list { list-style-type: none; padding-left: 0; }
        #itemDetailViewPlaceholder .child-items-list li { margin-bottom: 0.5rem; }
        #itemDetailViewPlaceholder .child-items-list a { color: var(--primary-color); text-decoration: none; }
        #itemDetailViewPlaceholder .child-items-list a:hover { text-decoration: underline; }
        .item-actions-bar { display: flex; gap: 0.75rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        
        .item-feedback-section, .item-comments-section, .item-feedback-display-section { 
            margin-top: 2rem; 
            padding-top: 0; /* Padding is in card already */
        }
        .item-feedback-section h4, .item-comments-section h4, .item-feedback-display-section h4 { 
            font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; margin-top:0; 
        }
        
        .rating-buttons button { background: none; border: 1px solid var(--border-color); color: var(--text-color-muted); padding: 0.5rem 0.75rem; border-radius: var(--border-radius); cursor: pointer; transition: all 0.2s; }
        .rating-buttons button:hover, .rating-buttons button.active { border-color: var(--rating-color); color: var(--rating-color); background-color: rgba(251, 191, 36, 0.1); }
        .rating-buttons button i { margin-right: 0.5rem; }
        .read-stats { font-size: 0.875rem; color: var(--text-color-muted); margin-left: 1rem; }
        
        .item-comments-section textarea#newCommentText, 
        .item-feedback-display-section textarea#newFeedbackText { /* For direct feedback on diagram page */
            width: 100%; min-height: 80px; margin-bottom: 0.5rem;
            background-color: var(--bg-color); color: var(--text-color);
            border: 1px solid var(--border-color-darker); border-radius: var(--border-radius); padding: 0.5rem;
        }
        .item-comments-section .comment-display-area, 
        .item-feedback-display-section .feedback-display-area { 
            margin-top: 1rem; 
            padding: 1rem; 
            background-color: var(--bg-color); 
            border-radius: var(--border-radius); 
            min-height: 50px; 
            border: 1px solid var(--border-color-darker);
        }
        .comment-display-area .comment, .feedback-display-area .feedback-item {
            border-bottom: 1px solid var(--border-color);
            padding: 0.75rem 0;
            margin-bottom: 0.75rem;
        }
        .comment-display-area .comment:last-child, .feedback-display-area .feedback-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .comment-author, .feedback-author {
            font-weight: 600;
            color: var(--text-color);
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }
        .comment-author .comment-timestamp, .feedback-author .feedback-timestamp {
            font-weight: normal;
            color: var(--text-color-muted);
            font-size: 0.75rem;
            margin-left: 0.5rem;
        }
        .comment-text, .feedback-text {
            font-size: 0.95rem;
            line-height: 1.5;
            color: var(--text-color-subtle);
            white-space: pre-wrap; /* Preserve line breaks */
        }

        /* Dashboard specific styles */
        .dashboard-stat-card {
            background-color: var(--bg-color-alt);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--card-shadow);
            text-align: center;
        }
        .dashboard-stat-card i {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 0.75rem;
        }
        .dashboard-stat-card .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            display: block;
            margin-bottom: 0.25rem;
        }
        .dashboard-stat-card .stat-label {
            font-size: 0.875rem;
            color: var(--text-color-muted);
        }
        .dashboard-quicklink-card, .dashboard-info-card { /* Combined for similar styling */
             background-color: var(--bg-color-alt);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--card-shadow);
        }
         .dashboard-quicklink-card h3, .dashboard-info-card h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }
        .dashboard-quicklink-card ul, .dashboard-info-card ul {
            list-style: none;
            padding: 0;
        }
        .dashboard-quicklink-card ul li a, .dashboard-info-card ul li a {
            display: block;
            padding: 0.5rem 0;
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
        }
         .dashboard-quicklink-card ul li a:hover, .dashboard-info-card ul li a:hover {
            text-decoration: underline;
        }
         .dashboard-info-card ul li {
            font-size: 0.9rem;
            color: var(--text-color-subtle);
            padding: 0.3rem 0;
         }
         .dashboard-info-card ul li strong {
            color: var(--text-color);
         }
         .dashboard-info-card ul li .meta {
            font-size: 0.75rem;
            display: block;
            color: var(--text-color-muted);
         }
         /* Viewer Dashboard Message */
        .viewer-dashboard-message .card {
            text-align: center;
            padding: 40px 20px;
            min-height: auto; /* Override general card min-height if needed */
        }
        .viewer-dashboard-message .card i {
            font-size: 2.5rem; /* Larger icon for emphasis */
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
        .viewer-dashboard-message .card h2 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--text-color);
        }
        .viewer-dashboard-message .card p {
            font-size: 1rem;
            color: var(--text-color-muted);
            margin-bottom: 0; /* Adjust as needed */
        }
        .viewer-dashboard-message .card p.subtle-note {
             font-size: 0.9rem;
             margin-top: 1rem;
        }

        /* Interactive Flow / Diagram Edit Styles */
        .flow-diagram-editor-container {
            margin-top: 1.5rem;
            padding: 1.5rem;
            background-color: var(--bg-color-alt);
            border: 1px solid var(--border-color-darker);
            border-radius: var(--border-radius-lg);
        }
        .flow-diagram-editor-container h3 {
            margin-top: 0; margin-bottom: 1rem; font-size: 1.25rem; font-weight: 600;
        }
        .flow-diagram-editor-container textarea {
            width: 100%;
            min-height: 300px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            background-color: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 0.75rem;
        }
        .flow-diagram-editor-actions {
            margin-top: 1rem; display: flex; justify-content: flex-end; gap: 0.75rem;
        }
        .important-notes-section {
            background: var(--bg-color-alt);
            border-left: 4px solid var(--rating-color);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-top: 1.5rem;
            box-shadow: var(--card-shadow);
        }
        .important-notes-section h3 {
            font-size: 1.2em; font-weight: 600; color: var(--text-color);
            margin-top: 0; margin-bottom: 0.75rem; display: flex; align-items: center;
        }
        .important-notes-section h3 i { margin-right: 0.75rem; color: var(--rating-color); }
        .important-notes-section ul { padding-left: 20px; list-style: disc; color: var(--text-color-subtle); }
        .important-notes-section ul li { margin-bottom: 0.5em; }

    </style>
</head>
<body>

    <div id="addContentModalOverlay" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="addContentModalTitle">Add New Content</h2>
                <button id="closeAddContentModalBtn" class="close-button" aria-label="Close">×</button>
            </div>

            <div id="templateSelectionContainer" class="hidden">
                <h3>Choose a Template</h3>
                <div class="template-buttons-grid">
                    <button class="template-button" data-template="standard_article">
                        <i class="fas fa-newspaper"></i>
                        <h4>Standard Article</h4>
                        <p>For general information, announcements, or detailed explanations.</p>
                    </button>
                    <button class="template-button" data-template="troubleshooting_guide">
                        <i class="fas fa-tools"></i>
                        <h4>Troubleshooting Guide / Case</h4>
                        <p>Step-by-step solutions for common issues or case documentation.</p>
                    </button>
                    <button class="template-button" data-template="policy_document">
                        <i class="fas fa-gavel"></i>
                        <h4>Policy Document</h4>
                        <p>Formal policies, procedures, or official guidelines.</p>
                    </button>
                     <button class="template-button" data-template="blank">
                        <i class="fas fa-file"></i>
                        <h4>Blank Document</h4>
                        <p>Start with a completely empty document of any type.</p>
                    </button>
                </div>
                <hr style="border-color: var(--border-color-darker); margin: 1.5rem 0;">
            </div>

            <form id="addContentForm" class="hidden">
                <input type="hidden" id="editingItemId"> <!-- For storing ID when editing -->
                <div class="form-group">
                    <label for="contentType">Content Type</label>
                    <select id="contentType">
                        <option value="article">Article</option>
                        <option value="case">Case</option>
                        <option value="form_sheet">Form/Sheet (Link)</option>
                        <option value="design">Design (Link)</option>
                        <option value="guide">Guide</option>
                        <option value="policy">Policy</option>
                        <option value="interactive_flow">Interactive Flow (Mermaid)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="contentTitle">Title</label>
                    <input type="text" id="contentTitle" required>
                </div>
                <div class="form-group">
                    <label for="contentSummary">Summary / Description</label>
                    <textarea id="contentSummary" rows="3" required></textarea>
                </div>
                
                <div class="form-group hidden" id="contentUrlContainer">
                    <label for="contentUrl">Link (for Forms, Designs, etc.)</label>
                    <input type="url" id="contentUrl">
                </div>

                <div class="form-group" id="contentDetailContainer">
                    <label for="contentDetail" id="contentDetailLabel">Details / Content</label>
                    <div id="quillEditor"></div> <!-- Quill editor container -->
                </div>
                
                <div class="form-group hidden" id="mermaidGraphContainer">
                    <label for="mermaidGraphContent">Mermaid Graph Definition</label>
                    <textarea id="mermaidGraphContent" rows="10" placeholder="Enter Mermaid graph definition here... e.g., graph TD; A-->B;"></textarea>
                    <small style="color: var(--text-color-muted);">For 'Interactive Flow' type. This will be rendered as a diagram.</small>
                </div>


                <div class="form-group">
                    <label for="contentTags">Tags (comma-separated)</label>
                    <input type="text" id="contentTags" placeholder="e.g., important, update, billing">
                </div>

                <hr style="border-color: var(--border-color-darker); margin: 1.5rem 0;">
                <h3 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-color);">Attachments (Optional)</h3>
                
                <div class="form-group">
                    <label for="pdfFile">Upload PDF</label>
                    <input type="file" id="pdfFile" accept=".pdf">
                </div>
                <div class="form-group">
                    <label for="imageFile">Upload Image</label>
                    <input type="file" id="imageFile" accept="image/*">
                </div>
                <div class="form-group">
                    <label for="videoLink">Video Link (e.g., YouTube, Vimeo)</label>
                    <input type="url" id="videoLink" placeholder="https://">
                </div>
                <div class="form-group">
                    <label for="driveLink">Google Drive Link</label>
                    <input type="url" id="driveLink" placeholder="https://docs.google.com/... or https://drive.google.com/...">
                </div>


                <div class="modal-actions">
                    <button type="submit" id="saveContentBtn" class="button"><i class="fas fa-save"></i> Save Content</button>
                    <button type="button" id="cancelAddContentBtn" class="button-secondary"><i class="fas fa-times"></i> Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div id="logoutConfirmModalOverlay" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 28rem;"> <!-- Smaller modal for confirm -->
            <div class="modal-header">
                <h2 id="logoutConfirmModalTitle">Confirm Logout</h2>
                <button id="closeLogoutConfirmModalBtn" class="close-button" aria-label="Close">×</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to logout from InfiniBase?</p>
            </div>
            <div class="modal-actions no-border"> 
                <button type="button" id="confirmLogoutBtn" class="button button-danger"><i class="fas fa-sign-out-alt"></i> Confirm Logout</button>
                <button type="button" id="cancelLogoutBtn" class="button-secondary"><i class="fas fa-times"></i> Cancel</button>
            </div>
        </div>
    </div>

    <!-- Report Feedback Modal -->
    <div id="reportFeedbackModalOverlay" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 32rem;">
            <div class="modal-header">
                <h2 id="reportFeedbackModalTitle">Report Feedback</h2>
                <button id="closeReportFeedbackModalBtn" class="close-button" aria-label="Close">×</button>
            </div>
            <form id="reportFeedbackForm">
                <input type="hidden" id="feedbackItemId">
                <input type="hidden" id="feedbackItemTitle">
                <div class="modal-body" style="padding-bottom:0;">
                    <p style="margin-bottom: 1rem;">Provide your feedback for: <strong id="feedbackItemTitleDisplay"></strong></p>
                    <div class="form-group">
                        <label for="feedbackUserName">Your Name</label>
                        <input type="text" id="feedbackUserName" readonly>
                    </div>
                    <div class="form-group">
                        <label for="feedbackUserEmail">Your Email</label>
                        <input type="email" id="feedbackUserEmail" readonly>
                    </div>
                    <div class="form-group">
                        <label for="feedbackComment">Your Feedback / Comments</label>
                        <textarea id="feedbackComment" rows="5" required placeholder="Please describe the issue or suggestion..."></textarea>
                    </div>
                </div>
                <div class="modal-actions"> 
                    <button type="submit" id="submitFeedbackBtn" class="button"><i class="fas fa-paper-plane"></i> Submit Feedback</button>
                    <button type="button" id="cancelFeedbackBtn" class="button-secondary"><i class="fas fa-times"></i> Cancel</button>
                </div>
            </form>
        </div>
    </div>


    <div class="container-fluid">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-database"></i> <span class="sidebar-logo-text">InfiniBase</span>
            </div>
            <nav id="navigationMenu" class="sidebar-nav">
                <!-- Links will be dynamically generated -->
            </nav>
            <div class="sidebar-footer">
                <button id="logoutButton" class="button button-danger">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
                 <div id="userRoleDisplaySidebar" style="font-size: 0.8rem; color: var(--text-color-muted); text-align: center; margin-top: 0.5rem;">Role: <span id="currentUserRoleSpan"></span></div>
            </div>
        </aside>

        <div class="content-wrapper" id="contentWrapper">
            <header class="content-header">
                <div class="header-left-content">
                    <button id="mobileSidebarToggle" class="mobile-sidebar-toggle"><i class="fas fa-bars"></i></button>
                    <div>
                        <h1 id="currentSectionTitle">Welcome</h1>
                        <div id="breadcrumbs">Home</div>
                    </div>
                </div>
                <div class="header-right-content">
                    <div class="search-container">
                        <span class="search-icon"><i class="fas fa-search"></i></span>
                        <input type="search" id="globalSearchInput" placeholder="Search the knowledge base...">
                        <div id="searchResultsContainer" class="hidden"></div>
                    </div>
                    <div id="userProfileContainer" class="user-profile">
                        <img id="userAvatar" src="https://ui-avatars.com/api/?name=U&size=36&background=6366f1&color=fff&rounded=true" alt="User">
                        <span id="userNameDisplayHeader" style="font-weight: 500;">User</span>
                    </div>
                </div>
            </header>

            <main id="pageContentArea" class="p-6 md:p-8">
                <div id="dashboardOverviewContainer" class="hidden">
                    <!-- Dashboard content will be injected here -->
                </div>
                <div id="standardSectionContentPlaceholder">
                    <!-- Section content will be injected here -->
                </div>
                <div id="itemDetailViewPlaceholder" class="hidden" data-mermaid-rendered="false">
                    <!-- Item detail view OR Interactive Flow View -->
                </div>
            </main>

            <footer class="mt-auto p-6 text-center text-sm">
                <span>© <script>document.write(new Date().getFullYear())</script> InfiniBase.Elmenisy. Version <span id="footerKbVersion">0.1.0</span></span>
            </footer>
        </div>
    </div>
    <div id="toastContainer"></div>

<script type="module">
    import { supabase } from './supabase.js';

    // --- Initialize Mermaid ---
    mermaid.initialize({ 
        startOnLoad: false, 
        theme: 'dark', 
        fontFamily: 'Inter, sans-serif',
        flowchart: { 
            htmlLabels: true, // Still useful for <br> and <span class='scriptText'>
            useMaxWidth: true,
        },
        themeVariables: { 
            fontSize: '13px', 
            background: getComputedStyle(document.documentElement).getPropertyValue('--bg-color').trim(), 
            primaryColor: getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim(),
            primaryTextColor: getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim(),
            lineColor: getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim(), 
            textColor: getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim(), 
            nodeBorder: getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim(),
            mainBkg: getComputedStyle(document.documentElement).getPropertyValue('--bg-color-alt').trim(), 
        }
    });
    
    /**
     * @typedef {object} UserProfile
     * @property {string} id - User UUID from Supabase Auth
     * @property {string} [name] - User's full name (from 'users' table, column 'name')
     * @property {string} email - User's email
     * @property {string} role - User's role (e.g., 'viewer', 'admin')
     * @property {string} [lastLogin] - ISO string of last login time (optional in this type, added by client)
     */

    // --- Supabase Auth & User Management ---
    const Auth = {
        /** @returns {Promise<UserProfile|null>} */
        async getCurrentUserProfile() {
            const { data: { session }, error: sessionError } = await supabase.auth.getSession();

            if (sessionError) {
                console.error("Error fetching Supabase session:", sessionError);
            }

            if (!session || !session.user) {
                console.log('No active Supabase session. Redirecting to login.');
                if (window.location.pathname.includes("index.html") || window.location.pathname === '/' || window.location.pathname === '') {
                     window.location.href = 'login.html';
                }
                return null; 
            }

            const userId = session.user.id;

            const { data: userDataFromDB, error: dbError } = await supabase
                .from("users")
                .select("id, name, email, role") 
                .eq("id", userId)
                .single();

            if (dbError || !userDataFromDB) {
                console.error("Failed to fetch user profile from DB for user ID:", userId, dbError);
                await supabase.auth.signOut();
                localStorage.removeItem("infiniBaseUser"); 
                if (window.location.pathname.includes("index.html") || window.location.pathname === '/' || window.location.pathname === '') {
                    window.location.href = "login.html";
                }
                return null;
            }
            
            /** @type {UserProfile} */
            const comprehensiveUserProfile = {
                ...userDataFromDB, 
                lastLogin: new Date().toISOString() 
            };

            localStorage.setItem("infiniBaseUser", JSON.stringify(comprehensiveUserProfile));
            return comprehensiveUserProfile;
        },
        async logout() {
            const { error } = await supabase.auth.signOut();
            if (error) {
                console.error("Error during sign out:", error);
                showToast('Error signing out. Please try again.', 'error');
            } else {
                localStorage.removeItem('infiniBaseUser');
                localStorage.removeItem('justLoggedIn'); 
                showToast('You have been logged out successfully!', 'success');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 1500);
            }
        }
    };

    // --- KB Data ---
    let kbSystemData = {
        meta: { version: '0.9.2-mermaid-click-directive', lastGlobalUpdate: new Date().toISOString(), lastArticleAdded: null, editsThisWeek: 0 }, 
        sections: [
            { id: 'home', name: 'Home', icon: 'fas fa-home', description: 'Dashboard and overview.', iconColor: 'var(--primary-color)' },
            {
                id: 'support', name: 'Support', icon: 'fas fa-headset', description: 'Support resources and flows.', iconColor: '#c084fc', 
                items: [
                     { 
                        id: 'sup_flow_compensation', type: 'interactive_flow', 
                        title: 'Scenario: Customer Inquiry – Compensation Flow for Delays', 
                        summary: 'Interactive flowchart for handling customer compensation due to order delays based on The Chefz policies.',
                        content: `<p>This interactive flowchart outlines the steps for handling customer inquiries regarding order delays and potential compensation, adhering to The Chefz guidelines. Click on nodes for more details or actions where applicable.</p>
                                  <h4>Original Key Information (For Reference during transition)</h4>
                                  <ul>
                                    <li><strong>FAST Orders Delays:</strong>
                                        <ul>
                                            <li>16–30 min: Delivery fees.</li>
                                            <li>31–45 min: Delivery fees + 25% food.</li>
                                            <li>46–60 min: Delivery fees + 50% food.</li>
                                            <li>&gt;60 min: Full order.</li>
                                        </ul>
                                    </li>
                                    <li><strong>SCHEDULED Orders Delays (Driver Left):</strong>
                                        <ul>
                                            <li>31–60 min: 50%–100% total order value.</li>
                                            <li>&gt;60 min: Full order value + 50 SAR goodwill.</li>
                                        </ul>
                                    </li>
                                  </ul>
                                  <p>Use the "Edit Item" button (Admins only) to modify the flowchart logic (Mermaid code) directly.</p>`,
                        mermaidGraph: `graph TD
    %% Styles definition for mermaid nodes - use supported properties
    classDef decision fill:#6366f1,stroke:#ffffff,stroke-width:1px,color:#ffffff;
    classDef process fill:#1f2937,stroke:#6366f1,stroke-width:1.5px,color:#d1d5db;
    classDef startEnd fill:#22c55e,stroke:#1f2937,stroke-width:1.5px,color:#ffffff,font-weight:bold;
    classDef actionNode fill:#f59e0b,stroke:#111827,stroke-width:1px,color:#111827;
    classDef scriptText fill:#9ca3af,font-style:italic,font-size:11px;
    classDef linkClass fill:#3b82f6,color:#ffffff;

    %% Nodes
    Start((Customer Inquiry: Delay)):::startEnd
    S1["Acknowledge & Listen to Customer <br/><span class='scriptText'>'Hello, ... How can I help?'</span>"]:::process
    D1{"Is complaint about a delay?"}:::decision
    
    S2_Other["Handle Other Issue (Non-Delay) <br/><span class='scriptText'>'Could you provide more details...?'</span><br/><span class='mermaid-action-text'>View Other Issues SOP</span>"]:::process
    S2_ConcludeOther["Conclude Call for Other Issue <br/><span class='scriptText'>'Anything else...? Thank you!'</span>"]:::process
    EndOther((End Interaction)):::startEnd

    S3_Apologize["Apologize for Delay <br/><span class='scriptText'>'I understand your order is late...'</span>"]:::process
    D2{"Assess Delivery Time: Exceeded?"}:::decision
    
    S3_NotExceeded["Inform: Still within ETA. Add Order Note.<br/><span class='scriptText'>'Checked order, still within ETA [ETA]...'</span>"]:::process
    S3_Exceeded0_15["Inform: Slight delay (0-15 min). New ETA. Add Note.<br/><span class='scriptText'>'Slight delay... new ETA is [New ETA]...'</span>"]:::process
    S3_Exceeded15Plus["Inform: Significant delay (>15 min). Add Note.<br/><span class='scriptText'>'Very sorry for significant delay...'</span>"]:::process

    D3_OrderType{"Check Order Type"}:::decision

    %% Fast Order Branch
    Fast_D_DelayDur{"FAST Order: Delay Duration Post-15min?"}:::decision
    Fast_Comp1["Offer: Delivery Fees Refund <br/>(16-30 min total)<br/><span class='mermaid-action-text'>Apply Comp</span>"]:::actionNode
    Fast_Comp2["Offer: Delivery + 25% Food Refund <br/>(31-45 min total)<br/><span class='mermaid-action-text'>Apply Comp</span>"]:::actionNode
    Fast_Comp3["Offer: Delivery + 50% Food Refund <br/>(46-60 min total)<br/><span class='mermaid-action-text'>Apply Comp</span>"]:::actionNode
    Fast_Comp4["Offer: Full Order Refund <br/>(>60 min total)<br/><span class='mermaid-action-text'>Apply Comp</span>"]:::actionNode

    %% Scheduled Order Branch
    Sched_D_DriverLeft{"SCHEDULED Order: Driver Left Store?"}:::decision
    Sched_NotLeft["Inform: Driver not left. Expedite Prep. Add Note.<br/><span class='scriptText'>'Driver hasn't left, expediting...'</span>"]:::process
    Sched_Left_D_DelayDur{"Driver Left: Delay Duration Post-15min?"}:::decision
    Sched_Comp1["Offer: 50-100% Total Order Value <br/>(31-60 min total, Agent Discretion)<br/><span class='mermaid-action-text'>Apply Comp (Supervisor?)</span>"]:::actionNode
    Sched_Comp2["Offer: Full Order Value + 50 SAR Goodwill <br/>(>60 min total)<br/><span class='mermaid-action-text'>Apply Comp + Goodwill</span>"]:::actionNode

    S5_Responsibility["INTERNAL: Determine Delay Responsibility <br/>(Store/Driver/Company) & Apply Deductions <br/><span class='mermaid-action-text'>View Deduction Policy</span>"]:::process
    
    D4_CustReqComp{"Cust. Explicitly Requests Comp <br/>OR Proactive Offer Due?"}:::decision
    S6_OfferComp["Inform Eligible Compensation Clearly <br/><span class='scriptText'>'Based on the situation... we offer [Comp Details]...'</span>"]:::process
    S6_NoReqComp["Thank for Understanding. Note Delay.<br/><span class='scriptText'>'Thank you for your understanding...'</span>"]:::process
    
    S7_ConcludeCall["Conclude Call Courteously<br/><span class='scriptText'>'Anything else...? Thank you for calling...'</span>"]:::process
    LogDetails["Log All Interaction Details & Compensation (if any) in System"]:::process
    End((End Interaction)):::startEnd

    %% Connections
    Start --> S1; S1 --> D1
    D1 --No--> S2_Other; S2_Other --> S2_ConcludeOther; S2_ConcludeOther --> EndOther
    D1 --Yes--> S3_Apologize; S3_Apologize --> D2
    
    D2 -- Not Yet Exceeded --> S3_NotExceeded; S3_NotExceeded --> S5_Responsibility
    D2 -- Exceeded 0-15 min --> S3_Exceeded0_15; S3_Exceeded0_15 --> S5_Responsibility
    D2 -- Exceeded >15 min --> S3_Exceeded15Plus; S3_Exceeded15Plus --> D3_OrderType

    D3_OrderType -- FAST Order --> Fast_D_DelayDur
    Fast_D_DelayDur -- 16-30 min --> Fast_Comp1; Fast_Comp1 --> S5_Responsibility
    Fast_D_DelayDur -- 31-45 min --> Fast_Comp2; Fast_Comp2 --> S5_Responsibility
    Fast_D_DelayDur -- 46-60 min --> Fast_Comp3; Fast_Comp3 --> S5_Responsibility
    Fast_D_DelayDur -- ">60 min" --> Fast_Comp4; Fast_Comp4 --> S5_Responsibility
    
    D3_OrderType -- SCHEDULED Order --> Sched_D_DriverLeft
    Sched_D_DriverLeft -- No --> Sched_NotLeft; Sched_NotLeft --> S5_Responsibility
    Sched_D_DriverLeft -- Yes --> Sched_Left_D_DelayDur
    Sched_Left_D_DelayDur -- 31-60 min --> Sched_Comp1; Sched_Comp1 --> S5_Responsibility
    Sched_Left_D_DelayDur -- ">60 min" --> Sched_Comp2; Sched_Comp2 --> S5_Responsibility
    
    S5_Responsibility --> D4_CustReqComp
    D4_CustReqComp -- Yes/Proactive --> S6_OfferComp; S6_OfferComp --> S7_ConcludeCall
    D4_CustReqComp -- No --> S6_NoReqComp; S6_NoReqComp --> S7_ConcludeCall
    
    S7_ConcludeCall --> LogDetails; LogDetails --> End

    %% Click Actions
    click S2_Other call handleMermaidAction("view_sop","other_issues_sop") "View SOP for other issues"
    click Fast_Comp1 call handleMermaidAction("offer_compensation","delivery_fees_fast") "Apply Delivery Fees Compensation"
    click Fast_Comp2 call handleMermaidAction("offer_compensation","delivery_25_food_fast") "Apply Delivery + 25% Food Compensation"
    click Fast_Comp3 call handleMermaidAction("offer_compensation","delivery_50_food_fast") "Apply Delivery + 50% Food Compensation"
    click Fast_Comp4 call handleMermaidAction("offer_compensation","full_refund_fast") "Apply Full Refund Compensation"
    click Sched_Comp1 call handleMermaidAction("offer_compensation","50_100_total_sched") "Apply 50-100% Total Order Compensation"
    click Sched_Comp2 call handleMermaidAction("offer_compensation","full_50sar_sched") "Apply Full Order + 50 SAR Goodwill Compensation"
    click S5_Responsibility call handleMermaidAction("internal_sop","deduction_policy") "View Deduction Policy"`,
                        importantNotesHTML: `<ul>
                                <li>Always determine the responsibility for the delay (Store, Driver, or Company) to apply any necessary deductions. This is critical for internal review.</li>
                                <li>The maximum compensation for delivery fees is typically capped (e.g., $5 or local equivalent) if the actual delivery fee is less than this amount. Refer to the latest compensation matrix for exact figures.</li>
                                <li>If the customer specifically asks for compensation, even for minor delays, address it empathetically based on the policy. Do not dismiss their request.</li>
                                <li>Maintain a polite and professional tone throughout the interaction, even if the customer is upset.</li>
                                <li>Document everything: notes on the delay, communication with the customer, and any compensation provided.</li>
                            </ul>`, 
                        tags: ['compensation', 'customer service', 'delay', 'flowchart', 'chefz policy', 'sop', 'interactive', 'mermaid'],
                        createdAt: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000).toISOString(), 
                        views: Math.floor(Math.random()*150)+75,
                        comments: [],
                        feedback: [] 
                    },
                    {
                        id: 'sup_child_example', type: 'article', parentId: 'sup_flow_compensation',
                        title: 'Child Article: Detailed Scenarios for Driver Responsibility',
                        summary: 'Examples of when a driver is considered responsible for delays.',
                        content: '<p>This article dives deeper into specific situations regarding driver responsibility for order delays.</p><ul><li>Example 1: Driver took an unnecessarily long route.</li><li>Example 2: Driver had multiple unscheduled stops.</li><li>Example 3: Driver did not promptly head to customer after pickup.</li></ul>',
                        tags: ['driver', 'responsibility', 'delay'],
                        createdAt: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(), 
                        views: Math.floor(Math.random()*80)+30,
                        comments: [],
                        feedback: []
                    }
                ]
            },
            { id: 'partner_care', name: 'Partner Care', icon: 'fas fa-handshake', description: 'Resources for partner management.', iconColor: '#2dd4bf', items: [
                 { id: 'pc_case_01', type: 'case', title: 'Case: Partner Payment Dispute', summary: 'Investigating a partner claim about incorrect payment.', createdAt: new Date(Date.now() - 20 * 24 * 60 * 60 * 1000).toISOString(), resolution_steps: '<p>1. Verify partner contract. 2. Check payment logs. 3. Escalate to finance if discrepancy found.</p>', status: 'Open', views: Math.floor(Math.random()*40)+15, comments: [], feedback: [] }
            ] }, 
            { id: 'logistics', name: 'Logistics', icon: 'fas fa-truck', description: 'Logistics operations and information.', iconColor: '#4ade80', items: [] }, 
            { id: 'customer_care', name: 'Customer Care', icon: 'fas fa-users', description: 'Customer service guidelines and FAQs.', iconColor: '#a78bfa', items: [] }, 
            { id: 'distribution_followup', name: 'Distribution & Follow-up', icon: 'fas fa-people-carry', description: 'Distribution processes and tracking.', iconColor: '#22d3ee', items: [] }, 
            { id: 'logistics_driver_complaints', name: 'Logistics (Driver Complaints)', icon: 'fas fa-shipping-fast', description: 'Handling driver-related complaints.', iconColor: '#84cc16', items: [] }, 
            { id: 'logistics_3pl', name: 'Logistics-3PL', icon: 'fas fa-boxes-stacked', description: 'Third-party logistics information.', iconColor: '#facc15', items: [] }, 
            { id: 'order_at_store_mac', name: 'Order at Store (Mac)', icon: 'fas fa-store', description: 'Procedures for Mac orders at store.', iconColor: '#f472b6', items: [] }, 
            { id: 'logistics_admin', name: 'Logistics-Admin', icon: 'fas fa-user-shield', description: 'Administrative tasks for logistics.', iconColor: '#fb7185', items: [] }, 
            { id: 'operating_systems', name: 'Operating Systems', icon: 'fab fa-windows', description: 'OS troubleshooting and guides.', iconColor: '#38bdf8', items: [] }, 
            { id: 'compensation_policies', name: 'Compensation Policies', icon: 'fas fa-hand-holding-usd', description: 'Detailed compensation policies.', iconColor: '#f59e0b', items: [
                { id: 'cp_policy_01', type: 'policy', title: 'General Compensation Policy v2.1', summary: 'The main policy document for all compensation scenarios.', createdAt: new Date(Date.now() - 45 * 24 * 60 * 60 * 1000).toISOString(), content: '<h1>Policy v2.1</h1><p>Details about the compensation policy...</p>', mermaidGraph: 'graph TD;\nA[Policy Start] --> B{Is eligible?}; B -- Yes --> C[Grant Compensation]; B -- No --> D[Deny Compensation]; C --> E((End)); D --> E', views: Math.floor(Math.random()*300)+100, comments: [], feedback: [] }
            ] }, 
            { id: 'operational_instructions', name: 'Operational Instructions', icon: 'fas fa-clipboard-list', description: 'Standard operating procedures.', iconColor: '#93c5fd', items: [] }, 
            { id: 'forms_templates', name: 'Forms/Templates', icon: 'fas fa-file-alt', description: 'Standard forms and templates.', iconColor: '#a5b4fc', items: [] }
        ]
    };

    // --- DOM Elements ---
    const sidebar = document.getElementById('sidebar');
    const mobileSidebarToggle = document.getElementById('mobileSidebarToggle');
    const navigationMenu = document.getElementById('navigationMenu');
    const currentSectionTitleEl = document.getElementById('currentSectionTitle');
    const breadcrumbsContainer = document.getElementById('breadcrumbs');
    const pageContentArea = document.getElementById('pageContentArea');
    const dashboardOverviewContainer = document.getElementById('dashboardOverviewContainer');
    const standardSectionContentPlaceholder = document.getElementById('standardSectionContentPlaceholder');
    const itemDetailViewPlaceholder = document.getElementById('itemDetailViewPlaceholder');
    const userNameDisplayHeader = document.getElementById('userNameDisplayHeader');
    const userAvatar = document.getElementById('userAvatar');
    const footerKbVersion = document.getElementById('footerKbVersion');
    const currentUserRoleSpan = document.getElementById('currentUserRoleSpan');


    const addContentModalOverlay = document.getElementById('addContentModalOverlay');
    const closeAddContentModalBtn = document.getElementById('closeAddContentModalBtn');
    const addContentForm = document.getElementById('addContentForm');
    const templateSelectionContainer = document.getElementById('templateSelectionContainer');
    const cancelAddContentBtn = document.getElementById('cancelAddContentBtn');
    const contentTypeSelect = document.getElementById('contentType');
    const contentUrlContainer = document.getElementById('contentUrlContainer');
    const contentDetailContainer = document.getElementById('contentDetailContainer');
    const contentDetailLabel = document.getElementById('contentDetailLabel');
    const mermaidGraphContainer = document.getElementById('mermaidGraphContainer'); 
    const mermaidGraphContentTextarea = document.getElementById('mermaidGraphContent'); 
    const contentTagsInput = document.getElementById('contentTags');
    const editingItemIdInput = document.getElementById('editingItemId');
    
    const globalSearchInput = document.getElementById('globalSearchInput');
    const searchResultsContainer = document.getElementById('searchResultsContainer');

    const logoutButton = document.getElementById('logoutButton');
    const logoutConfirmModalOverlay = document.getElementById('logoutConfirmModalOverlay');
    const closeLogoutConfirmModalBtn = document.getElementById('closeLogoutConfirmModalBtn');
    const confirmLogoutBtn = document.getElementById('confirmLogoutBtn');
    const cancelLogoutBtn = document.getElementById('cancelLogoutBtn');

    const reportFeedbackModalOverlay = document.getElementById('reportFeedbackModalOverlay');
    const closeReportFeedbackModalBtn = document.getElementById('closeReportFeedbackModalBtn');
    const reportFeedbackForm = document.getElementById('reportFeedbackForm');
    const cancelFeedbackBtn = document.getElementById('cancelFeedbackBtn');
    const feedbackItemIdInput = document.getElementById('feedbackItemId');
    const feedbackItemTitleInput = document.getElementById('feedbackItemTitle');
    const feedbackItemTitleDisplay = document.getElementById('feedbackItemTitleDisplay');
    const feedbackUserNameInput = document.getElementById('feedbackUserName');
    const feedbackUserEmailInput = document.getElementById('feedbackUserEmail');
    const feedbackCommentTextarea = document.getElementById('feedbackComment');


    let mainQuillEditor; 
    /** @type {UserProfile|null} */
    let currentUser = null; 
    let currentOpenItem = null;
    let visitorsChartInstance, casesChartInstance, articlesChartInstance; 

    // --- Utility Functions ---
    function escapeHTML(str) {
        if (typeof str !== 'string') return '';
        const el = document.createElement('div');
        el.textContent = str;
        return el.innerHTML;
    }

    function highlightText(text, query) {
        if (!text) return '';
        const safeText = escapeHTML(text);
        if (!query) return safeText;
        try {
            const rgx = new RegExp(`(${query.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')})`, 'gi');
            return safeText.replace(rgx, '<mark>$1</mark>');
        } catch (e) { return safeText; }
    }

    function truncateText(text, len) {
        if (!text || text.length <= len) return text;
        return text.substring(0, len) + '...';
    }
    function stripHtml(html){
       let tmp = document.createElement("DIV");
       tmp.innerHTML = html;
       return tmp.textContent || tmp.innerText || "";
    }

    function showToast(message, type = 'info', duration = 3000) {
        const toastContainer = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast-notification toast-${type}`;
        
        let iconClass = 'fas fa-info-circle';
        if (type === 'success') iconClass = 'fas fa-check-circle';
        else if (type === 'error') iconClass = 'fas fa-times-circle';

        toast.innerHTML = `<i class="toast-icon ${iconClass}"></i> <span>${escapeHTML(message)}</span>`;
        toastContainer.appendChild(toast);

        setTimeout(() => toast.classList.add('show'), 10);

        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, duration);
    }
    
    function applyPermanentDarkMode() { 
        [visitorsChartInstance, casesChartInstance, articlesChartInstance].forEach(chart => {
            if (chart) {
                const legendColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim();
                const ticksColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color-muted').trim();
                const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim();
                
                chart.options.plugins.legend.labels.color = legendColor;
                if (chart.options.scales && chart.options.scales.y) {
                    chart.options.scales.y.ticks.color = ticksColor;
                    chart.options.scales.y.grid.color = gridColor;
                }
                if (chart.options.scales && chart.options.scales.x) { 
                    chart.options.scales.x.ticks.color = ticksColor;
                    chart.options.scales.x.grid.color = gridColor;
                }
                chart.update();
            }
        });
    }

    // --- Sidebar and Navigation ---
    function populateSidebar() {
        let menuHTML = '';
        const mainSections = ['home'];
        const knowledgeAreas = [
            'support', 'partner_care', 'logistics', 'customer_care', 
            'distribution_followup', 'logistics_driver_complaints', 'logistics_3pl', 
            'order_at_store_mac', 'logistics_admin', 'operating_systems'
        ];
        const resourcesPolicies = [
            'compensation_policies', 'operational_instructions', 'forms_templates'
        ];

        menuHTML += `<div class="sidebar-section-title">MAIN</div>`;
        kbSystemData.sections.filter(s => mainSections.includes(s.id)).forEach(section => {
            const iconStyle = section.iconColor ? `style="color: ${section.iconColor};"` : '';
            menuHTML += `<a href="#${section.id}" class="sidebar-link" data-section="${section.id}">
                <i class="${section.icon || 'fas fa-file-alt'}" ${iconStyle}></i>${escapeHTML(section.name)}
            </a>`;
        });
        
        menuHTML += `<div class="sidebar-section-title">KNOWLEDGE AREAS</div>`;
        kbSystemData.sections.filter(s => knowledgeAreas.includes(s.id)).forEach(section => {
            const iconStyle = section.iconColor ? `style="color: ${section.iconColor};"` : '';
            menuHTML += `<a href="#${section.id}" class="sidebar-link" data-section="${section.id}">
                <i class="${section.icon || 'fas fa-folder'}" ${iconStyle}></i>${escapeHTML(section.name)}
            </a>`;
        });

        menuHTML += `<div class="sidebar-section-title">RESOURCES & POLICIES</div>`;
        kbSystemData.sections.filter(s => resourcesPolicies.includes(s.id)).forEach(section => {
            const iconStyle = section.iconColor ? `style="color: ${section.iconColor};"` : '';
            menuHTML += `<a href="#${section.id}" class="sidebar-link" data-section="${section.id}">
                <i class="${section.icon || 'fas fa-book'}" ${iconStyle}></i>${escapeHTML(section.name)}
            </a>`;
        });

        navigationMenu.innerHTML = menuHTML;
    }

    mobileSidebarToggle.addEventListener('click', () => sidebar.classList.toggle('closed'));
    sidebar.addEventListener('click', (e) => {
        if (e.target.closest('.sidebar-link') && window.innerWidth < 768) {
            sidebar.classList.add('closed');
        }
    });

    function highlightSidebarLink(sectionId) {
        document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
        const activeLink = document.querySelector(`.sidebar-link[data-section="${sectionId}"]`);
        if (activeLink) activeLink.classList.add('active');
    }
    
    window.handleMermaidAction = function(actionType, data) { // Make sure it's globally accessible
        console.log("Mermaid Action Triggered via click directive:", actionType, data);
        let message = `Action: ${actionType}`;
        if (data) message += `\nData: ${data}`;
        
        if (actionType === 'offer_compensation') {
            showToast(`Compensation action: ${data} applied (simulated).`, 'success');
        } else if (actionType === 'view_sop') {
            showToast(`Opening SOP: ${data} (simulated).`, 'info');
        } else if (actionType === 'internal_sop') {
             showToast(`Viewing internal policy: ${data} (simulated).`, 'info');
        }
        else {
            showToast(message, 'info');
        }
    }

    async function renderMermaidDiagramInElement(elementToRenderIn, mermaidDefinition, itemId) {
        if (!elementToRenderIn || !mermaidDefinition) {
            console.error("Missing element or definition for Mermaid rendering.");
            if (elementToRenderIn) elementToRenderIn.innerHTML = "<p style='color:red;'>Error: Diagram definition missing.</p>";
            return;
        }
        
        elementToRenderIn.innerHTML = ''; 
        const uniqueDiagramId = `mermaid-${itemId}-${Date.now()}`; 

        // const pre = document.createElement('pre'); // Not needed if using mermaid.render to string
        // pre.id = uniqueDiagramId; 
        // pre.className = 'mermaid';
        // pre.textContent = mermaidDefinition;
        
        try {
            const hiddenAncestors = [];
            let parent = elementToRenderIn.parentElement;
            while(parent && parent !== document.body) {
                if (getComputedStyle(parent).display === 'none') {
                    hiddenAncestors.push({el: parent, originalDisplay: parent.style.display});
                    parent.style.display = 'block'; 
                }
                parent = parent.parentElement;
            }

            const {svg, bindFunctions} = await mermaid.render(uniqueDiagramId + "_svg", mermaidDefinition);
            elementToRenderIn.innerHTML = svg; 
            if (bindFunctions && elementToRenderIn.firstChild) { 
                 bindFunctions(elementToRenderIn.firstChild); 
            }
            elementToRenderIn.dataset.mermaidRendered = 'true';

            hiddenAncestors.forEach(item => item.el.style.display = item.originalDisplay);

        } catch (error) {
            console.error("Mermaid rendering error for ID", uniqueDiagramId, ":", error);
            elementToRenderIn.innerHTML = `
                <p style="color:red; padding:10px; border:1px solid red; border-radius: var(--border-radius);">
                    <strong><i class="fas fa-exclamation-triangle"></i> Error Rendering Diagram</strong><br>
                    Details: ${escapeHTML(error.message || String(error))}
                </p>
                <details style="margin-top:10px;">
                    <summary style="cursor:pointer; color:var(--primary-color);">View Mermaid Code</summary>
                    <pre style="white-space:pre-wrap; padding:10px; background:var(--bg-color-hover); border-radius: var(--border-radius); margin-top:5px; border:1px solid var(--border-color); max-height:200px; overflow-y:auto;">${escapeHTML(mermaidDefinition)}</pre>
                </details>`;
            elementToRenderIn.dataset.mermaidRendered = 'error';
        }
    }


    // --- Content Display ---
    function renderItemCard(item, sectionData) {
        let itemIconClass = 'fas fa-file-alt'; 
        let ctaText = 'View Details';
        let ctaLink = `#${sectionData.id}/${item.id}`;
        let target = '';
        let itemTypeDisplay = item.type.replace(/_/g, ' '); 

        if (item.type === 'article') { itemIconClass = 'fas fa-newspaper'; }
        else if (item.type === 'case') { itemIconClass = 'fas fa-briefcase'; }
        else if (item.type === 'form_sheet') { itemIconClass = 'fas fa-file-invoice'; ctaText = 'Open Link'; ctaLink = item.url || '#'; target = '_blank'; }
        else if (item.type === 'design') {itemIconClass = 'fas fa-palette'; ctaText = 'View Design'; ctaLink = item.url || '#'; target = '_blank';}
        else if (item.type === 'guide') { itemIconClass = 'fas fa-book-open'; }
        else if (item.type === 'policy') { itemIconClass = 'fas fa-gavel'; }
        else if (item.type === 'interactive_flow') { itemIconClass = 'fas fa-project-diagram'; itemTypeDisplay = 'Interactive Flow';}


        const cardIconContainerColor = 'var(--primary-color-hover)'; 
        const cardIconColor = 'var(--text-color-inverted)';

        return `
        <div class="card" data-item-id="${item.id}" data-item-type="${item.type}">
            <div class="card-header-icon">
                <div class="card-icon-container" style="background-color: ${cardIconContainerColor};">
                    <i class="${itemIconClass}" style="color: ${cardIconColor};"></i>
                </div>
                <h3>${escapeHTML(item.title)}</h3>
            </div>
            <p>${escapeHTML(truncateText(stripHtml(item.summary), 120))}</p>
            ${item.tags && item.tags.length ? `<div class="card-tags">${item.tags.map(tag => `<span>${escapeHTML(tag)}</span>`).join('')}</div>` : ''}
            <div class="item-meta-info">
                <span class="item-type-badge">${escapeHTML(itemTypeDisplay)}</span>
                <a href="${escapeHTML(ctaLink)}" ${target ? `target="${target}" rel="noopener noreferrer"` : ''} class="item-cta-link"
                   data-item-id="${item.id}" data-section-id="${sectionData.id}" data-item-type="${item.type}">
                   ${ctaText} <i class="fas fa-arrow-right"></i>
                </a>
            </div>
        </div>`;
    }

    async function displayDashboard() {
        dashboardOverviewContainer.classList.remove('hidden');
        standardSectionContentPlaceholder.classList.add('hidden');
        itemDetailViewPlaceholder.classList.add('hidden');
        itemDetailViewPlaceholder.dataset.mermaidRendered = 'false'; 
        currentSectionTitleEl.textContent = 'Dashboard';
        breadcrumbsContainer.innerHTML = `<span style="font-weight: bold; color: var(--primary-color);">Home</span>`;

        if (!currentUser || currentUser.role !== 'admin') {
            dashboardOverviewContainer.innerHTML = `
                <div class="viewer-dashboard-message">
                    <div class="card">
                        <i class="fas fa-user-shield"></i>
                        <h2>Access Restricted</h2>
                        <p>The dashboard overview is available for administrators only.</p>
                        <p class="subtle-note">You can navigate using the sidebar to view knowledge base content.</p>
                    </div>
                </div>
            `;
            return;
        }

        const welcomeUser = currentUser.name || currentUser.email || 'Admin'; 
        const allItems = kbSystemData.sections.flatMap(s => s.items || []);
        const totalArticles = allItems.filter(i => ['article', 'guide', 'policy'].includes(i.type)).length;
        const totalCases = allItems.filter(i => i.type === 'case').length;
        const totalInteractiveFlows = allItems.filter(i => i.type === 'interactive_flow').length;
        
        kbSystemData.meta.editsThisWeek = Math.floor(Math.random() * 15); 
        if (!kbSystemData.meta.lastArticleAdded && allItems.length > 0) {
            const latestItem = [...allItems].sort((a,b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0))[0];
            if (latestItem) {
                 kbSystemData.meta.lastArticleAdded = { title: latestItem.title, date: new Date(latestItem.createdAt || Date.now()).toLocaleDateString() };
            }
        }
        if (!kbSystemData.meta.lastArticleAdded) {
            kbSystemData.meta.lastArticleAdded = { title: "N/A", date: "N/A" };
        }
        
        const compensationFlowItem = kbSystemData.sections.find(s => s.id === 'support')?.items?.find(i => i.id === 'sup_flow_compensation');

        const mostUsedArticles = [...allItems].sort((a,b) => (b.views || 0) - (a.views || 0)).slice(0,3);
        const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
        const recentCases = allItems.filter(i => i.type === 'case' && i.createdAt && new Date(i.createdAt) >= sevenDaysAgo).slice(0,3);
        const sixMonthsAgo = new Date();
        sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
        const articlesNeedingUpdate = allItems.filter(i => i.createdAt && new Date(i.createdAt) < sixMonthsAgo && (i.type === 'article' || i.type === 'policy' || i.type === 'guide')).slice(0,3);


        dashboardOverviewContainer.innerHTML = `
            <div class="card" style="background: linear-gradient(to right, var(--primary-color), #4c1d95); color: white; min-height: auto;">
                <h2 style="font-size: 1.75rem; margin-bottom: 4px;">Welcome back, ${escapeHTML(welcomeUser)}!</h2>
                <p style="opacity: 0.95; font-size: 0.95rem; color: var(--text-color-inverted);">Overview of your knowledge base activity.</p>
            </div>

            <div class="cards-grid md:grid-cols-2 lg:grid-cols-4 my-6">
                <div class="dashboard-stat-card">
                    <i class="fas fa-folder-open"></i>
                    <span class="stat-value">${kbSystemData.sections.length -1}</span>
                    <span class="stat-label">Total Sections</span>
                </div>
                <div class="dashboard-stat-card">
                    <i class="fas fa-newspaper"></i>
                    <span class="stat-value">${totalArticles}</span>
                    <span class="stat-label">Articles & Guides</span>
                </div>
                 <div class="dashboard-stat-card">
                    <i class="fas fa-briefcase"></i>
                    <span class="stat-value">${totalCases}</span>
                    <span class="stat-label">Total Cases</span>
                </div>
                <div class="dashboard-stat-card">
                    <i class="fas fa-project-diagram"></i>
                    <span class="stat-value">${totalInteractiveFlows}</span>
                    <span class="stat-label">Interactive Flows</span>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <div class="dashboard-info-card">
                    <h3>🔥 Most Used Content</h3>
                    <ul>${mostUsedArticles.length ? mostUsedArticles.map(item => `<li><a href="#${kbSystemData.sections.find(s => s.items && s.items.includes(item)).id}/${item.id}">${escapeHTML(item.title)}</a> <span class="meta">(${item.views || 0} views)</span></li>`).join('') : '<li>No data yet.</li>'}</ul>
                </div>
                <div class="dashboard-info-card">
                    <h3>⏳ Articles Needing Update</h3>
                    <ul>${articlesNeedingUpdate.length ? articlesNeedingUpdate.map(item => `<li><a href="#${kbSystemData.sections.find(s => s.items && s.items.includes(item)).id}/${item.id}">${escapeHTML(item.title)}</a> <span class="meta">Created: ${new Date(item.createdAt).toLocaleDateString()}</span></li>`).join('') : '<li>All articles up-to-date.</li>'}</ul>
                </div>
                <div class="dashboard-info-card">
                    <h3>✅ Recent Cases (Last 7 Days)</h3>
                     <ul>${recentCases.length ? recentCases.map(item => `<li><a href="#${kbSystemData.sections.find(s => s.items && s.items.includes(item)).id}/${item.id}">${escapeHTML(item.title)}</a> <span class="meta">Created: ${new Date(item.createdAt).toLocaleDateString()}</span></li>`).join('') : '<li>No recent cases.</li>'}</ul>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card chart-container">
                        <h3>Visitors Activity (Mock)</h3>
                        <canvas id="visitorsChart"></canvas>
                    </div>
                    <div class="card chart-container">
                        <h3>Content Types (Mock)</h3>
                        <canvas id="articlesChart"></canvas>
                    </div>
                </div>
                <div class="dashboard-quicklink-card card" style="min-height: auto;">
                    <h3>Quick Links</h3>
                    <ul>
                        ${compensationFlowItem ? `<li><a href="#support/${compensationFlowItem.id}"><i class="fas fa-project-diagram fa-fw"></i> View Compensation Flow</a></li>` : ''}
                        <li><a href="#forms_templates"><i class="fas fa-file-alt fa-fw"></i> Browse Templates</a></li>
                         ${currentUser && currentUser.role === 'admin' ? `<li><button id="openAddContentBtnFromDashboard" class="button-secondary" style="padding: 0.5rem 0; width: auto; display: inline;"><i class="fas fa-plus-circle fa-fw"></i> Add New Content</button></li>` : ''}
                    </ul>
                     <h3 style="margin-top: 1.5rem;">💡 Content Suggestions</h3>
                     <p style="font-size: 0.9rem; color: var(--text-color-subtle);">Consider adding a guide for "New Partner Onboarding" in Partner Care.</p>
                     <h3 style="margin-top: 1.5rem;">Last Added</h3>
                     <p style="font-size: 0.9rem; color: var(--text-color-subtle);">${escapeHTML(kbSystemData.meta.lastArticleAdded.title)} <br><small>(${escapeHTML(kbSystemData.meta.lastArticleAdded.date)})</small></p>
                </div>
            </div>
        `;
        
        const addContentBtnDashboard = document.getElementById('openAddContentBtnFromDashboard');
        if (addContentBtnDashboard) {
            addContentBtnDashboard.addEventListener('click', () => openAddContentModal('home')); 
        }

        const legendColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim();
        const ticksColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color-muted').trim();
        const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim();

        const chartOptions = (type) => ({
            responsive: true, maintainAspectRatio: false,
            plugins: { 
                legend: { 
                    labels: { color: legendColor, font: { family: 'Inter, sans-serif' } },
                    position: 'top', 
                },
                tooltip: {
                    bodyFont: { family: 'Inter, sans-serif' },
                    titleFont: { family: 'Inter, sans-serif' }
                }
            },
            scales: type === 'bar' || type === 'line' ? {
                y: { ticks: { color: ticksColor, beginAtZero: true, font: { family: 'Inter, sans-serif' } }, grid: { color: gridColor } },
                x: { ticks: { color: ticksColor, font: { family: 'Inter, sans-serif' } }, grid: { color: gridColor } }
            } : {}
        });

        if (visitorsChartInstance) visitorsChartInstance.destroy();
        const visitorsCtx = document.getElementById('visitorsChart')?.getContext('2d');
        if (visitorsCtx) {
            visitorsChartInstance = new Chart(visitorsCtx, {
                type: 'line',
                data: { labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'], datasets: [{ label: 'Page Views', data: [65, 59, 80, 81, 56, 55, 40], borderColor: 'rgba(99, 102, 241, 0.8)', backgroundColor: 'rgba(99, 102, 241, 0.2)', tension: 0.3, fill: true }] },
                options: chartOptions('line')
            });
        }

        if (articlesChartInstance) articlesChartInstance.destroy();
        const articlesCtx = document.getElementById('articlesChart')?.getContext('2d');
        if (articlesCtx) {
            const policyCount = allItems.filter(i=>i.type === 'policy').length;
            const guideCount = allItems.filter(i=>i.type === 'guide').length;
            let mainArticleCount = totalArticles - policyCount - guideCount;
            if (mainArticleCount < 0) mainArticleCount = 0; 

            articlesChartInstance = new Chart(articlesCtx, {
                type: 'doughnut', 
                data: { labels: ['Articles', 'Cases', 'Guides', 'Policies', 'Flows'], datasets: [{ data: [mainArticleCount, totalCases, guideCount, policyCount, totalInteractiveFlows], backgroundColor: ['#6366f1', '#ec4899', '#22d3ee', '#f59e0b', '#10b981'] }] },
                options: chartOptions('doughnut') 
            });
        }
        applyPermanentDarkMode(); 
    }
    
    async function displaySectionContent(sectionId, subCategoryFilter = null) {
        currentOpenItem = null;
        dashboardOverviewContainer.classList.add('hidden');
        standardSectionContentPlaceholder.classList.remove('hidden');
        itemDetailViewPlaceholder.classList.add('hidden');
        itemDetailViewPlaceholder.dataset.mermaidRendered = 'false'; 

        const sectionData = kbSystemData.sections.find(s => s.id === sectionId);
        if (!sectionData) {
            standardSectionContentPlaceholder.innerHTML = `<div class="card" style="text-align: center;"><h2 style="color: red;">Section not found: ${escapeHTML(sectionId)}</h2></div>`;
            currentSectionTitleEl.textContent = 'Not Found';
            return;
        }

        currentSectionTitleEl.textContent = sectionData.name;
        let bcHTML = `<a href="#home">Home</a> <span style="margin: 0 5px;">›</span> <span style="font-weight: bold; color: var(--primary-color);">${escapeHTML(sectionData.name)}</span>`;
        breadcrumbsContainer.innerHTML = bcHTML;

        let contentHTML = `<div>`;
        
        if (currentUser && currentUser.role === 'admin' && sectionId !== 'home') {
             contentHTML += `
                <div style="text-align: right; margin-bottom: 1.5rem;">
                    <button id="openAddContentBtnInSection" class="button" data-section-id="${sectionData.id}">
                        <i class="fas fa-plus-circle"></i> Add Content to ${escapeHTML(sectionData.name)}
                    </button>
                </div>`;
        }

        const itemsToDisplay = (sectionData.items || [])
            .filter(item => !item.parentId) 
            .filter(item => !subCategoryFilter || (item.tags && item.tags.includes(subCategoryFilter)));
        
        if (itemsToDisplay.length > 0) {
            contentHTML += `<div class="cards-grid">`;
            itemsToDisplay.forEach(item => contentHTML += renderItemCard(item, sectionData));
            contentHTML += `</div>`;
        }
        
        if (sectionId !== 'support' && !subCategoryFilter && sectionData.subCategories && sectionData.subCategories.length > 0) {
            contentHTML += `<h3 style="font-size: 1.5rem; font-weight: 600; margin-top: 30px; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 8px;">Subcategories</h3><div class="cards-grid">`;
            sectionData.subCategories.forEach(subCat => {
                contentHTML += `<a href="#${sectionData.id}/${subCat.id}" class="card" style="text-align: center; text-decoration: none; color: var(--text-color);">
                    <i class="${subCat.icon || sectionData.icon || 'fas fa-folder-open'}" style="font-size: 2rem; display: block; margin-bottom: 10px; color: var(--primary-color);"></i>
                    <h4 style="margin:0; font-weight: 500;">${escapeHTML(subCat.name)}</h4>
                </a>`;
            });
            contentHTML += `</div>`;
        }

        if (itemsToDisplay.length === 0 && (!sectionData.subCategories || sectionData.subCategories.length === 0 || subCategoryFilter)) {
             contentHTML += `<div class="card" style="text-align: center; padding: 40px 20px; min-height: auto;"><p style="font-size: 1.2rem; color: var(--text-color-muted);">No content in this section${subCategoryFilter ? ' or subcategory' : ''} yet.</p></div>`;
        }

        contentHTML += `</div>`;
        standardSectionContentPlaceholder.innerHTML = contentHTML;

        const openAddBtnInSection = document.getElementById('openAddContentBtnInSection');
        if (openAddBtnInSection) {
            openAddBtnInSection.addEventListener('click', (e) => {
                const currentSecId = e.currentTarget.dataset.sectionId;
                openAddContentModal(currentSecId);
            });
        }
    }
    
    function findParentItem(parentId) {
        for (const section of kbSystemData.sections) {
            if (section.items) {
                const parentItem = section.items.find(item => item.id === parentId);
                if (parentItem) {
                    return { ...parentItem, sectionId: section.id };
                }
            }
        }
        return null;
    }

    function renderCommentsOrFeedback(itemData, containerId, type = 'comments') {
        const container = document.getElementById(containerId);
        if (!container) return;

        const dataArray = type === 'comments' ? itemData.comments : itemData.feedback;
        const itemClass = type === 'comments' ? 'comment' : 'feedback-item';
        const authorClass = type === 'comments' ? 'comment-author' : 'feedback-author';
        const timestampClass = type === 'comments' ? 'comment-timestamp' : 'feedback-timestamp';
        const textClass = type === 'comments' ? 'comment-text' : 'feedback-text';
        const noDataMessage = type === 'comments' ? 'No comments yet. Be the first to discuss!' : 'No feedback yet for this item.';

        if (!dataArray || dataArray.length === 0) {
            container.innerHTML = `<p style="color: var(--text-color-muted);">${noDataMessage}</p>`;
            return;
        }
        let html = '';
        const sortedData = [...dataArray].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));

        sortedData.forEach(entry => {
            const authorName = entry.authorName || entry.userName || entry.authorEmail || entry.userEmail || 'Anonymous';
            html += `
                <div class="${itemClass}" data-${type.slice(0,-1)}-id="${entry.id}">
                    <div class="${authorClass}">
                        <i class="fas ${type === 'comments' ? 'fa-user-circle' : 'fa-user-tag'}" style="margin-right: 5px;"></i> ${escapeHTML(authorName)}
                        <span class="${timestampClass}">${new Date(entry.timestamp).toLocaleString()}</span>
                    </div>
                    <div class="${textClass}">${escapeHTML(entry.text || entry.comment)}</div>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    async function displayItemDetail(sectionId, itemId) {
        const sectionData = kbSystemData.sections.find(s => s.id === sectionId);
        const itemData = sectionData?.items?.find(i => i.id === itemId);

        if (!sectionData || !itemData) {
            standardSectionContentPlaceholder.innerHTML = `<p style="color: red;">Error: Item not found.</p>`;
            itemDetailViewPlaceholder.classList.add('hidden');
            standardSectionContentPlaceholder.classList.remove('hidden');
            itemDetailViewPlaceholder.dataset.mermaidRendered = 'false'; 
            return;
        }
        currentOpenItem = { sectionId, itemId }; 
        itemDetailViewPlaceholder.dataset.mermaidRendered = 'false'; 

        dashboardOverviewContainer.classList.add('hidden');
        standardSectionContentPlaceholder.classList.add('hidden');
        itemDetailViewPlaceholder.classList.remove('hidden');
        itemDetailViewPlaceholder.innerHTML = ''; 

        let bcHTML = `
            <a href="#home">Home</a> <span style="margin: 0 5px;">›</span>
            <a href="#${sectionData.id}">${escapeHTML(sectionData.name)}</a> <span style="margin: 0 5px;">›</span>
            <span style="font-weight: bold; color: var(--primary-color);">${escapeHTML(itemData.title)}</span>`;
        breadcrumbsContainer.innerHTML = bcHTML;
        currentSectionTitleEl.textContent = itemData.title;

        let actionsBarHTML = `<div class="item-actions-bar">
                            <button id="backToSectionBtn" class="button button-secondary">
                                <i class="fas fa-arrow-left"></i> Back to ${escapeHTML(sectionData.name)}
                            </button>`;
        if (itemData.parentId) {
            const parentItemFull = findParentItem(itemData.parentId);
            if (parentItemFull) {
                actionsBarHTML += `<button id="backToParentBtn" class="button button-secondary" data-parent-section="${parentItemFull.sectionId}" data-parent-id="${parentItemFull.id}">
                                <i class="fas fa-level-up-alt"></i> Back to Parent: ${escapeHTML(truncateText(parentItemFull.title, 25))}
                               </button>`;
            }
        }
        if (currentUser && currentUser.role === 'admin') {
            actionsBarHTML += `<button id="editItemBtn" class="button" data-section-id="${sectionId}" data-item-id="${itemId}"><i class="fas fa-edit"></i> Edit Item</button>`;
            actionsBarHTML += `<button id="deleteItemBtn" class="button button-danger" data-section-id="${sectionId}" data-item-id="${itemId}"><i class="fas fa-trash-alt"></i> Delete Item</button>`;
        }
        actionsBarHTML += `   <button id="printItemBtn" class="button button-secondary"><i class="fas fa-print"></i> Print</button>
                          <button id="shareItemBtn" class="button button-secondary"><i class="fas fa-share-alt"></i> Share Link</button>
                          <button id="downloadPdfItemBtn" class="button button-secondary"><i class="fas fa-file-pdf"></i> Download PDF</button>
                      </div>`;
        itemDetailViewPlaceholder.innerHTML += actionsBarHTML;


        if (itemData.type === 'interactive_flow' && itemData.mermaidGraph) {
            const itemIconClass = 'fas fa-project-diagram';
            let flowHTML = `<div class="mermaid-flow-card">
                                <div class="flow-title-area">
                                    <i class="${itemIconClass} fa-flow-icon"></i>
                                    <h2>${escapeHTML(itemData.title)}</h2>
                                </div>
                                <p class="flow-summary">${escapeHTML(stripHtml(itemData.summary))}</p>
                                ${itemData.tags && itemData.tags.length ? `<div class="card-tags" style="margin-bottom: 1rem;">${itemData.tags.map(tag => `<span>${escapeHTML(tag)}</span>`).join('')}</div>` : ''}
                                <hr class="title-content-divider" style="margin-bottom: 1rem;">`;
            
            if (itemData.content) {
                flowHTML += `<div class="kb-content" style="margin-bottom: 1.5rem;">${itemData.content}</div>`;
            }
            
            flowHTML += `<div class="mermaid-diagram-container" id="mermaidDiagramContainer_${itemId}">
                                    <p style="text-align:center; padding:20px;">Loading diagram...</p>
                                 </div>
                             </div>`; 
            itemDetailViewPlaceholder.innerHTML += flowHTML;

            const diagramContainer = document.getElementById(`mermaidDiagramContainer_${itemId}`);
            await renderMermaidDiagramInElement(diagramContainer, itemData.mermaidGraph, itemId);

            if (currentUser && currentUser.role === 'admin') {
                itemDetailViewPlaceholder.innerHTML += `
                    <div id="editFlowDiagramSection" class="flow-diagram-editor-container hidden">
                        <h3>Edit Flow Diagram (Mermaid Code)</h3>
                        <textarea id="mermaidGraphEditTextarea" rows="15">${escapeHTML(itemData.mermaidGraph)}</textarea>
                        <div class="flow-diagram-editor-actions">
                            <button id="saveMermaidGraphBtn" class="button"><i class="fas fa-save"></i> Save Diagram</button>
                            <button id="cancelMermaidEditBtn" class="button-secondary"><i class="fas fa-times"></i> Cancel</button>
                        </div>
                    </div>`;
            }
            if (itemData.importantNotesHTML) {
                 itemDetailViewPlaceholder.innerHTML += `<div class="important-notes-section">
                                                            <h3><i class="fas fa-exclamation-triangle"></i> Important Notes</h3>
                                                            ${itemData.importantNotesHTML}
                                                         </div>`;
            }

        } else { 
            let itemIconClass = 'fas fa-file-alt';
            if (itemData.type === 'case') itemIconClass = 'fas fa-briefcase';
            else if (itemData.type === 'article') itemIconClass = 'fas fa-newspaper';
            else if (itemData.type === 'form_sheet') itemIconClass = 'fas fa-file-invoice';
            else if (itemData.type === 'design') itemIconClass = 'fas fa-palette';
            else if (itemData.type === 'guide') itemIconClass = 'fas fa-book-open';
            else if (itemData.type === 'policy') itemIconClass = 'fas fa-gavel';
            
            let detailHTML = `<div class="card">
                                <div class="item-title-area">
                                    <i class="${itemIconClass} fa-title-icon"></i>
                                    <h2>${escapeHTML(itemData.title)}</h2>
                                </div>
                                <p class="item-summary">${escapeHTML(stripHtml(itemData.summary))}</p>
                                ${itemData.tags && itemData.tags.length ? `<div class="card-tags" style="margin-bottom: 1rem;">${itemData.tags.map(tag => `<span>${escapeHTML(tag)}</span>`).join('')}</div>` : ''}
                                <hr class="title-content-divider">
                                <div class="kb-content">`;

            if (itemData.content) { 
                detailHTML += itemData.content;
            } else if (itemData.resolution_steps) { 
                 detailHTML += itemData.resolution_steps;
            } else if ((itemData.type === 'form_sheet' || itemData.type === 'design') && itemData.url) {
                detailHTML += `<p>This content is an external link:</p><p><a href="${escapeHTML(itemData.url)}" target="_blank" rel="noopener noreferrer" class="button"><i class="fas fa-external-link-alt"></i> Open Link</a></p>`;
            } else if (itemData.type === 'interactive_flow' && !itemData.mermaidGraph) { 
                detailHTML += `<p style="color:orange;">This is an interactive flow, but the diagram definition is missing or couldn't be loaded.</p>`;
                if (itemData.content) detailHTML += `<p>Fallback content:</p>${itemData.content}`;
            }
            else {
                detailHTML += `<p>No detailed content available for this item.</p>`;
            }

            if (itemData.attachments && Object.keys(itemData.attachments).length > 0 && (itemData.attachments.pdf || itemData.attachments.image || itemData.attachments.video || itemData.attachments.drive) ) {
                detailHTML += `<hr class="title-content-divider"><h4 style="margin-top:1.5rem; margin-bottom:1rem; font-weight:600;">Attachments:</h4><ul>`;
                if(itemData.attachments.pdf) detailHTML += `<li><i class="fas fa-file-pdf"></i> <a href="${escapeHTML(itemData.attachments.pdf)}" target="_blank">View PDF</a> (Simulated)</li>`;
                if(itemData.attachments.image) detailHTML += `<li><i class="fas fa-file-image"></i> <a href="${escapeHTML(itemData.attachments.image)}" target="_blank">View Image</a> (Simulated)</li>`;
                if(itemData.attachments.video) detailHTML += `<li><i class="fas fa-video"></i> <a href="${escapeHTML(itemData.attachments.video)}" target="_blank">Watch Video</a></li>`;
                if(itemData.attachments.drive) detailHTML += `<li><i class="fab fa-google-drive"></i> <a href="${escapeHTML(itemData.attachments.drive)}" target="_blank">Open Drive Link</a></li>`;
                detailHTML += `</ul>`;
            }
             detailHTML += `</div></div>`; 
            itemDetailViewPlaceholder.innerHTML += detailHTML;
            
            if (itemData.mermaidGraph && itemDetailViewPlaceholder.dataset.mermaidRendered !== 'true') {
                const mermaidContainer = document.createElement('div');
                mermaidContainer.className = 'mermaid-diagram-container'; 
                mermaidContainer.id = `mermaidDiagramContainer_${itemId}_inline`;
                mermaidContainer.style.marginTop = '1.5rem';
                itemDetailViewPlaceholder.querySelector('.kb-content').appendChild(mermaidContainer);
                await renderMermaidDiagramInElement(mermaidContainer, itemData.mermaidGraph, itemId + "_inline");
            }
        }

        const childItems = kbSystemData.sections.flatMap(s => s.items || [])
                               .filter(child => child.parentId === itemData.id)
                               .map(child => ({...child, sectionId: kbSystemData.sections.find(s => s.items && s.items.includes(child)).id }));
        if (childItems.length > 0) {
            let childHTML = `<div class="card" style="margin-top: 1.5rem;">
                            <h3 style="font-size: 1.25rem; font-weight:600; margin-bottom:1rem;">Child Items</h3>
                            <ul class="child-items-list">`;
            childItems.forEach(child => {
                 childHTML += `<li><a href="#${child.sectionId}/${child.id}"><i class="fas fa-angle-right"></i> ${escapeHTML(child.title)} (${escapeHTML(child.type.replace('_',' '))})</a></li>`;
            });
            childHTML += `</ul></div>`;
            itemDetailViewPlaceholder.innerHTML += childHTML;
        }

        itemDetailViewPlaceholder.innerHTML += `
            <div class="item-feedback-section card">
                <h4>Rate this Content</h4>
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                    <div class="rating-buttons">
                        <button id="rateUpBtn"><i class="fas fa-thumbs-up"></i> Helpful</button>
                        <button id="rateDownBtn"><i class="fas fa-thumbs-down"></i> Not Helpful</button>
                    </div>
                    <span class="read-stats">(Total Reads: ${itemData.views || Math.floor(Math.random() * 200) + 10})</span>
                </div>
                <button id="reportFeedbackForItemBtn" class="button button-secondary" data-item-id="${itemData.id}" data-item-title="${escapeHTML(itemData.title)}"><i class="fas fa-flag"></i> Report Feedback</button>
            </div>
            <div class="item-feedback-display-section card" style="margin-top:1.5rem;">
                 <h4><i class="fas fa-user-edit"></i> Reported Feedback</h4>
                 <div class="feedback-display-area" id="feedbackDisplayAreaForItem">
                    <!-- Feedback will be rendered here -->
                 </div>
            </div>
            <div class="item-comments-section card" style="margin-top: 1.5rem;">
                <h4><i class="fas fa-comments"></i> Comments & Discussion</h4>
                <div class="comment-display-area" id="commentDisplayAreaForItem">
                   <!-- Comments will be rendered here -->
                </div>
                <textarea id="newCommentText" class="form-group" placeholder="Type your comment here..."></textarea>
                <button id="postCommentBtn" class="button" style="margin-top:0.5rem;"><i class="fas fa-paper-plane"></i> Post Comment</button>
            </div>`;
        
        renderCommentsOrFeedback(itemData, 'commentDisplayAreaForItem', 'comments'); 
        renderCommentsOrFeedback(itemData, 'feedbackDisplayAreaForItem', 'feedback');

        document.getElementById('backToSectionBtn')?.addEventListener('click', () => { window.location.hash = `#${sectionId}`; });
        
        const backToParentBtn = document.getElementById('backToParentBtn');
        if (backToParentBtn) {
            backToParentBtn.addEventListener('click', (e) => {
                window.location.hash = `#${e.currentTarget.dataset.parentSection}/${e.currentTarget.dataset.parentId}`;
            });
        }

        const editItemButton = document.getElementById('editItemBtn');
        if (editItemButton) {
            editItemButton.addEventListener('click', (e) => {
                const sId = e.currentTarget.dataset.sectionId;
                const iId = e.currentTarget.dataset.itemId;
                const sec = kbSystemData.sections.find(s => s.id === sId);
                const item = sec?.items?.find(i => i.id === iId);
                if (item) {
                    if (item.type === 'interactive_flow' && document.getElementById('editFlowDiagramSection')) {
                        document.getElementById('editFlowDiagramSection').classList.remove('hidden');
                        const mermaidTextarea = document.getElementById('mermaidGraphEditTextarea');
                        mermaidTextarea.value = item.mermaidGraph; 
                        mermaidTextarea.focus();
                        const mainDiagramContainer = document.getElementById(`mermaidDiagramContainer_${itemId}`);
                        if(mainDiagramContainer) mainDiagramContainer.classList.add('hidden');
                    } else {
                        openAddContentModal(sId, item); 
                    }
                }
            });
        }
        
        const deleteItemButton = document.getElementById('deleteItemBtn');
        if (deleteItemButton) {
            deleteItemButton.addEventListener('click', (e) => {
                const sId = e.currentTarget.dataset.sectionId;
                const iId = e.currentTarget.dataset.itemId;
                if(confirm(`Are you sure you want to delete item "${itemData.title}"? This cannot be undone.`)){
                    const sec = kbSystemData.sections.find(s => s.id === sId);
                    if(sec && sec.items){
                        sec.items = sec.items.filter(item => item.id !== iId);
                        showToast('Item deleted successfully.', 'success');
                        window.location.hash = `#${sId}`; 
                    }
                }
            });
        }

        document.getElementById('printItemBtn')?.addEventListener('click', () => window.print());
        document.getElementById('shareItemBtn')?.addEventListener('click', () => {
            navigator.clipboard.writeText(window.location.href)
                .then(() => showToast('Link copied to clipboard!', 'success'))
                .catch(() => showToast('Failed to copy link.', 'error'));
        });
        document.getElementById('downloadPdfItemBtn')?.addEventListener('click', () => showToast('PDF Download (simulated).', 'info'));
        document.getElementById('rateUpBtn')?.addEventListener('click', () => showToast('Thanks for your feedback!', 'success'));
        document.getElementById('rateDownBtn')?.addEventListener('click', () => showToast('Thanks for your feedback! We will review this content.', 'info'));
        
        const reportFeedbackForItemBtn = document.getElementById('reportFeedbackForItemBtn');
        if(reportFeedbackForItemBtn) {
            reportFeedbackForItemBtn.addEventListener('click', (e) => {
                openReportFeedbackModal(e.currentTarget.dataset.itemId, e.currentTarget.dataset.itemTitle);
            });
        }

        document.getElementById('postCommentBtn')?.addEventListener('click', () => {
            const commentTextEl = document.getElementById('newCommentText');
            const commentText = commentTextEl.value.trim();
            if (!commentText) {
                showToast('Please enter a comment.', 'error');
                commentTextEl.focus();
                return;
            }

            const currentItemData = kbSystemData.sections.find(s => s.id === currentOpenItem.sectionId)?.items?.find(i => i.id === currentOpenItem.itemId);
            if (currentItemData && currentUser) { 
                if (!currentItemData.comments) currentItemData.comments = [];
                currentItemData.comments.push({
                    id: `cmt_${Date.now()}`, authorEmail: currentUser.email, authorName: currentUser.name, 
                    text: commentText, timestamp: new Date().toISOString()
                });
                renderCommentsOrFeedback(currentItemData, 'commentDisplayAreaForItem', 'comments'); 
                commentTextEl.value = ''; 
                showToast('Comment posted!', 'success');
            } else {
                showToast('Error posting comment. Item or user data not found.', 'error');
            }
        });

        const saveMermaidBtn = document.getElementById('saveMermaidGraphBtn');
        if (saveMermaidBtn) {
            saveMermaidBtn.addEventListener('click', async () => {
                const newMermaidGraph = document.getElementById('mermaidGraphEditTextarea').value;
                itemData.mermaidGraph = newMermaidGraph; 
                showToast('Mermaid diagram updated! Re-rendering...', 'success');
                document.getElementById('editFlowDiagramSection').classList.add('hidden');
                const diagramContainer = document.getElementById(`mermaidDiagramContainer_${itemId}`);
                if (diagramContainer) {
                    diagramContainer.classList.remove('hidden'); 
                     await renderMermaidDiagramInElement(diagramContainer, newMermaidGraph, itemId);
                }
            });
        }
        const cancelMermaidEditBtn = document.getElementById('cancelMermaidEditBtn');
        if (cancelMermaidEditBtn) {
            cancelMermaidEditBtn.addEventListener('click', () => {
                document.getElementById('mermaidGraphEditTextarea').value = itemData.mermaidGraph; 
                document.getElementById('editFlowDiagramSection').classList.add('hidden');
                const diagramContainer = document.getElementById(`mermaidDiagramContainer_${itemId}`);
                if (diagramContainer) diagramContainer.classList.remove('hidden'); 
            });
        }
    }


    const contentTemplates = {
        standard_article: {
            type: 'article', titlePrefix: 'New Article: ', summary: 'A general article about [topic].',
            content: '<h2>Introduction</h2><p>[Provide a brief introduction to the topic.]</p><h2>Main Content</h2><p>[Elaborate on the main points here. You can use lists, paragraphs, etc.]</p><ul><li>Point 1</li><li>Point 2</li></ul><h2>Conclusion</h2><p>[Summarize the key takeaways.]</p>',
            tags: ['article']
        },
        troubleshooting_guide: {
            type: 'case', titlePrefix: 'Case: Troubleshooting ', summary: 'A step-by-step guide to resolve [issue].',
            content: '<h3>Issue Description</h3><p>[Clearly describe the problem or issue this guide addresses.]</p><h3>Symptoms</h3><ul><li>[Symptom 1]</li><li>[Symptom 2]</li></ul><h3>Resolution Steps</h3><ol><li><strong>Step 1:</strong> [Action to take]</li><li><strong>Step 2:</strong> [Another action]</li></ol><h3>Verification</h3><p>[How to verify the issue is resolved.]</p>',
            tags: ['troubleshooting', 'guide', 'case']
        },
        policy_document: {
            type: 'policy', titlePrefix: 'Policy: ', summary: 'Official policy regarding [subject matter].',
            content: '<h1>[Policy Title]</h1><p><strong>Version:</strong> 1.0</p><p><strong>Effective Date:</strong> [Date]</p><h2>1. Purpose</h2><p>[State the purpose of this policy.]</p><h2>2. Scope</h2><p>[Define who this policy applies to.]</p><h2>3. Policy Statement</h2><p>[Detail the policy rules and guidelines.]</p><h2>4. Responsibilities</h2><p>[Outline responsibilities related to this policy.]</p>',
            tags: ['policy', 'official']
        },
         blank: {
            type: 'article', titlePrefix: '', summary: '', content: '<p><br></p>', tags: []
        }
    };

    function applyTemplate(templateKey) {
        const template = contentTemplates[templateKey];
        if (!template) return;

        contentTypeSelect.value = template.type;
        document.getElementById('contentTitle').value = template.titlePrefix;
        document.getElementById('contentSummary').value = template.summary;
        if (mainQuillEditor) mainQuillEditor.root.innerHTML = template.content;
        contentTagsInput.value = template.tags.join(', ');
        
        mermaidGraphContentTextarea.value = '';
        
        addContentForm.classList.remove('hidden');
        templateSelectionContainer.classList.add('hidden');
        contentTypeSelect.dispatchEvent(new Event('change')); 
        document.getElementById('contentTitle').focus();
    }


    function openAddContentModal(sectionIdForContent, itemToEdit = null) {
        addContentForm.reset();
        addContentForm.dataset.sectionId = sectionIdForContent;
        editingItemIdInput.value = ""; 
        
        if (!mainQuillEditor) {
            mainQuillEditor = new Quill('#quillEditor', { 
                theme: 'snow',
                modules: { 
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }], ['bold', 'italic', 'underline', 'strike'],
                        [{ 'color': [] }, { 'background': [] }],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }], [{ 'align': [] }],
                        ['link', 'image', 'video', 'blockquote', 'code-block'], ['clean']
                    ]
                },
                placeholder: 'Enter detailed content here...'
            });
        }
        mainQuillEditor.root.innerHTML = '<p><br></p>'; 
        mermaidGraphContentTextarea.value = ''; 

        if (itemToEdit) {
            document.getElementById('addContentModalTitle').textContent = 'Edit Content';
            editingItemIdInput.value = itemToEdit.id; 
            document.getElementById('contentTitle').value = itemToEdit.title;
            document.getElementById('contentSummary').value = itemToEdit.summary;
            contentTypeSelect.value = itemToEdit.type;
            if (itemToEdit.url) document.getElementById('contentUrl').value = itemToEdit.url;
            
            let contentToEdit = '';
            if (itemToEdit.content) contentToEdit = itemToEdit.content;
            else if (itemToEdit.resolution_steps) contentToEdit = itemToEdit.resolution_steps;
            mainQuillEditor.root.innerHTML = contentToEdit || '<p><br></p>';
            
            if (itemToEdit.type === 'interactive_flow' && itemToEdit.mermaidGraph) {
                mermaidGraphContentTextarea.value = itemToEdit.mermaidGraph;
            } else if (itemToEdit.mermaidGraph) { 
                 mermaidGraphContentTextarea.value = itemToEdit.mermaidGraph;
            }
            
            contentTagsInput.value = (itemToEdit.tags || []).join(', ');
            
            if (itemToEdit.attachments) {
                if(itemToEdit.attachments.video) document.getElementById('videoLink').value = itemToEdit.attachments.video;
                if(itemToEdit.attachments.drive) document.getElementById('driveLink').value = itemToEdit.attachments.drive;
            }
            templateSelectionContainer.classList.add('hidden');
            addContentForm.classList.remove('hidden');
            document.getElementById('contentTitle').focus();
        } else {
            document.getElementById('addContentModalTitle').textContent = 'Add New Content';
            templateSelectionContainer.classList.remove('hidden');
            addContentForm.classList.add('hidden');
        }
        
        contentTypeSelect.dispatchEvent(new Event('change'));
        addContentModalOverlay.classList.remove('hidden');
    }

    document.querySelectorAll('.template-button').forEach(button => {
        button.addEventListener('click', () => {
            applyTemplate(button.dataset.template);
        });
    });


    function closeAddContentModal() {
        addContentModalOverlay.classList.add('hidden');
        templateSelectionContainer.classList.add('hidden'); 
        addContentForm.classList.add('hidden'); 
        editingItemIdInput.value = ""; 
    }

    contentTypeSelect.addEventListener('change', (e) => {
        const type = e.target.value;
        contentUrlContainer.classList.add('hidden');
        contentDetailContainer.classList.remove('hidden'); 
        mermaidGraphContainer.classList.add('hidden'); 

        if (type === 'form_sheet' || type === 'design') {
            contentUrlContainer.classList.remove('hidden');
            contentDetailContainer.classList.add('hidden'); 
        } else if (type === 'interactive_flow') {
            mermaidGraphContainer.classList.remove('hidden'); 
            contentDetailLabel.textContent = 'Introduction / Description (Optional)'; 
        } else if (type === 'case') {
            contentDetailLabel.textContent = 'Case Details / Resolution Steps';
        } else if (type === 'article') {
            contentDetailLabel.textContent = 'Article Content';
        } else if (type === 'guide') {
            contentDetailLabel.textContent = 'Guide Content';
        } else if (type === 'policy') {
            contentDetailLabel.textContent = 'Policy Details';
            mermaidGraphContainer.classList.remove('hidden'); 
        }
    });

    addContentForm.addEventListener('submit', (e) => {
        e.preventDefault();
        if (!currentUser) {
            showToast('Error: User not authenticated.', 'error');
            return;
        }
        const sectionId = addContentForm.dataset.sectionId;
        const section = kbSystemData.sections.find(s => s.id === sectionId);
        if (!section) {
            showToast('Error: Target section not found!', 'error'); return;
        }
        
        const editingId = editingItemIdInput.value; 
        let itemData;

        const commonData = {
            type: contentTypeSelect.value,
            title: document.getElementById('contentTitle').value.trim(),
            summary: document.getElementById('contentSummary').value.trim(),
            tags: contentTagsInput.value.split(',').map(tag => tag.trim()).filter(tag => tag),
        };

        if (!commonData.title || !commonData.summary) {
            showToast('Title and Summary are required.', 'error');
            return;
        }

        if (editingId) { 
            itemData = section.items.find(i => i.id === editingId);
            if (!itemData) { showToast('Error: Item to edit not found!', 'error'); return; }
            Object.assign(itemData, commonData); 
            itemData.lastModified = new Date().toISOString();
            itemData.views = itemData.views || 0;
            itemData.comments = itemData.comments || [];
            itemData.feedback = itemData.feedback || []; 
        } else { 
            itemData = {
                ...commonData,
                id: `${sectionId}_item_${Date.now()}`,
                createdBy: currentUser.email, 
                createdAt: new Date().toISOString(),
                views: 0,
                comments: [],
                feedback: [] 
            };
            kbSystemData.meta.lastArticleAdded = { title: itemData.title, date: new Date(itemData.createdAt).toLocaleDateString() };
            kbSystemData.meta.editsThisWeek = (kbSystemData.meta.editsThisWeek || 0) + 1;
        }
        
        if (itemData.type === 'interactive_flow' || itemData.type === 'policy') {
            itemData.mermaidGraph = mermaidGraphContentTextarea.value.trim() || null; 
             if (itemData.type === 'interactive_flow' && !itemData.mermaidGraph) { 
                showToast('Mermaid graph definition is required for Interactive Flow.', 'error'); return; 
            }
        } else {
            delete itemData.mermaidGraph; 
        }

        if (itemData.type === 'case') {
            itemData.resolution_steps = mainQuillEditor.root.innerHTML;
            itemData.status = itemData.status || 'New'; 
            delete itemData.content; 
        } else if (['article', 'guide', 'interactive_flow', 'policy'].includes(itemData.type)) {
            itemData.content = mainQuillEditor.root.innerHTML;
            delete itemData.resolution_steps; 
        } else if (itemData.type === 'form_sheet' || itemData.type === 'design') {
            itemData.url = document.getElementById('contentUrl').value.trim();
            if (!itemData.url) { showToast('A URL is required for this content type.', 'error'); return; }
            delete itemData.content; 
            delete itemData.resolution_steps;
        }


        itemData.attachments = itemData.attachments || {};
        const pdfFile = document.getElementById('pdfFile').files[0];
        const imageFile = document.getElementById('imageFile').files[0];
        const videoLink = document.getElementById('videoLink').value.trim();
        const driveLink = document.getElementById('driveLink').value.trim();

        if (pdfFile) itemData.attachments.pdf = `simulated_uploads/${pdfFile.name}`; 
        if (imageFile) itemData.attachments.image = `simulated_uploads/${imageFile.name}`; 
        if (videoLink) itemData.attachments.video = videoLink; else delete itemData.attachments.video;
        if (driveLink) itemData.attachments.drive = driveLink; else delete itemData.attachments.drive;


        if (!editingId) { 
            if (!section.items) section.items = [];
            section.items.push(itemData);
        }

        showToast(`Content '${itemData.title}' ${editingId ? 'updated' : 'saved'} successfully!`, 'success');
        closeAddContentModal();
        
        if (editingId && currentOpenItem && currentOpenItem.itemId === editingId) {
            displayItemDetail(currentOpenItem.sectionId, currentOpenItem.itemId); 
        } else {
            window.location.hash = `#${sectionId}`; 
        }
    });

    function openReportFeedbackModal(itemId, itemTitle) {
        if (!currentUser) {
            showToast('Please login to report feedback.', 'error');
            return;
        }
        reportFeedbackForm.reset();
        feedbackItemIdInput.value = itemId;
        feedbackItemTitleInput.value = itemTitle; 
        feedbackItemTitleDisplay.textContent = itemTitle; 
        feedbackUserNameInput.value = currentUser.name || '';
        feedbackUserEmailInput.value = currentUser.email || '';
        reportFeedbackModalOverlay.classList.remove('hidden');
        feedbackCommentTextarea.focus();
    }

    function closeReportFeedbackModal() {
        reportFeedbackModalOverlay.classList.add('hidden');
    }

    reportFeedbackForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const itemId = feedbackItemIdInput.value;
        const comment = feedbackCommentTextarea.value.trim();

        if (!comment) {
            showToast('Please enter your feedback.', 'error');
            feedbackCommentTextarea.focus();
            return;
        }

        const item = kbSystemData.sections.flatMap(s => s.items || []).find(i => i.id === itemId);
        if (item) {
            if (!item.feedback) item.feedback = [];
            item.feedback.push({
                id: `fb_${Date.now()}`, 
                userName: feedbackUserNameInput.value,
                userEmail: feedbackUserEmailInput.value,
                comment: comment, 
                timestamp: new Date().toISOString()
            });
            showToast('Feedback submitted successfully. Thank you!', 'success');
            console.log("Feedback submitted for item:", itemId, item.feedback.slice(-1)[0]);
            if (currentOpenItem && currentOpenItem.itemId === itemId) {
                 renderCommentsOrFeedback(item, 'feedbackDisplayAreaForItem', 'feedback');
            }
        } else {
            showToast('Error: Could not find item to attach feedback to.', 'error');
        }
        closeReportFeedbackModal();
    });


    globalSearchInput.addEventListener('input', () => {
        const query = globalSearchInput.value.trim().toLowerCase();
        if (query.length < 2) {
            searchResultsContainer.classList.add('hidden');
            return;
        }
        const results = [];
        kbSystemData.sections.forEach(s => {
            if (s.id === 'home') return; 
            s.items?.forEach(i => {
                if (i.title.toLowerCase().includes(query) || 
                    (i.summary && stripHtml(i.summary).toLowerCase().includes(query)) || 
                    (i.content && stripHtml(i.content).toLowerCase().includes(query)) ||
                    (i.resolution_steps && stripHtml(i.resolution_steps).toLowerCase().includes(query)) ||
                    (i.tags && i.tags.some(tag => tag.toLowerCase().includes(query)))) {
                    results.push({ ...i, sectionId: s.id, sectionName: s.name });
                }
            });
        });
        searchResultsContainer.innerHTML = '';
        if (results.length) {
            results.slice(0, 7).forEach(r => {
                const linkEl = document.createElement('a');
                linkEl.href = `#${r.sectionId}/${r.id}`;
                 linkEl.addEventListener('click', () => {
                    searchResultsContainer.classList.add('hidden');
                    globalSearchInput.value = '';
                });

                linkEl.innerHTML = `
                    <div style="font-weight: bold;">${highlightText(r.title, query)}
                        <span style="font-size: 0.8em; color: var(--text-color-muted); margin-left: 5px;">(${escapeHTML(r.type.replace('_', ' '))} in ${escapeHTML(r.sectionName)})</span>
                    </div>
                    <p style="font-size: 0.9em; color: var(--text-color-subtle); margin: 0;">${highlightText(truncateText(stripHtml(r.summary || r.content || r.resolution_steps), 70), query)}</p>`;
                searchResultsContainer.appendChild(linkEl);
            });
            searchResultsContainer.classList.remove('hidden');
        } else {
            searchResultsContainer.innerHTML = `<div style="padding: 10px; font-size: 0.9em; color: var(--text-color-muted);">No results found.</div>`;
            searchResultsContainer.classList.remove('hidden');
        }
    });
    document.addEventListener('click', e => {
        if (!globalSearchInput.contains(e.target) && !searchResultsContainer.contains(e.target)) {
            searchResultsContainer.classList.add('hidden');
        }
    });
    
    function handleNavigation() {
        if (!currentUser) { 
            console.log("Current user not yet loaded, deferring navigation.");
            return;
        }
        const hash = window.location.hash.substring(1) || 'home';
        const parts = hash.split('/');
        const sectionId = parts[0];
        const itemIdOrSubCategory = parts[1]; 

        highlightSidebarLink(sectionId);
        if (itemDetailViewPlaceholder) itemDetailViewPlaceholder.dataset.mermaidRendered = 'false'; 

        if (sectionId === 'home') {
            displayDashboard(); 
        } else if (itemIdOrSubCategory && sectionId) { 
            const sectionData = kbSystemData.sections.find(s => s.id === sectionId);
            const itemExists = sectionData?.items?.some(i => i.id === itemIdOrSubCategory);
            if(itemExists) {
                displayItemDetail(sectionId, itemIdOrSubCategory);
            } else { 
                displaySectionContent(sectionId, itemIdOrSubCategory); 
            }
        } else if (sectionId) {
            displaySectionContent(sectionId);
        } else { 
            displayDashboard(); 
        }
        const contentWrapper = document.getElementById('contentWrapper');
        if (contentWrapper) contentWrapper.scrollTo(0,0);
    }

    async function initializeApp() {
        currentUser = await Auth.getCurrentUserProfile(); 
        
        if (!currentUser) {
            console.error("Initialization failed: No current user profile.");
            return; 
        }

        const displayName = currentUser.name || currentUser.email || 'User'; 
        userNameDisplayHeader.textContent = displayName;
        userAvatar.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName.split(' ').join('+'))}&size=36&background=6366f1&color=fff&rounded=true&font-size=0.5`;
        footerKbVersion.textContent = kbSystemData.meta.version;
        currentUserRoleSpan.textContent = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
        
        const currentYear = new Date().getFullYear();
        document.querySelector('footer span:first-child').innerHTML = `© ${currentYear} InfiniBase.Elmenisy. Version <span id="footerKbVersion">${kbSystemData.meta.version}</span>`;

        populateSidebar();
        applyPermanentDarkMode(); 
        handleNavigation(); 

        window.addEventListener('hashchange', handleNavigation);
        
        logoutButton.addEventListener('click', () => {
            logoutConfirmModalOverlay.classList.remove('hidden');
        });
        closeLogoutConfirmModalBtn.addEventListener('click', () => logoutConfirmModalOverlay.classList.add('hidden'));
        cancelLogoutBtn.addEventListener('click', () => logoutConfirmModalOverlay.classList.add('hidden'));
        confirmLogoutBtn.addEventListener('click', async () => {
            await Auth.logout(); 
            logoutConfirmModalOverlay.classList.add('hidden');
        });
        
        closeAddContentModalBtn.addEventListener('click', closeAddContentModal);
        cancelAddContentBtn.addEventListener('click', closeAddContentModal);
        
        closeReportFeedbackModalBtn.addEventListener('click', closeReportFeedbackModal);
        cancelFeedbackBtn.addEventListener('click', closeReportFeedbackModal);
        
        if (window.innerWidth < 768) {
            sidebar.classList.add('closed');
        }
        
        if (localStorage.getItem('justLoggedIn') === 'true') {
            showToast(`InfiniBase v${kbSystemData.meta.version} loaded. Welcome, ${displayName}!`, 'success', 4000);
            localStorage.removeItem('justLoggedIn');
        } else {
            showToast(`InfiniBase v${kbSystemData.meta.version} ready.`, 'info', 2000);
        }
        console.log(`InfiniBase v${kbSystemData.meta.version} initialized. User: ${displayName}, Role: ${currentUser.role}`);
    }

    initializeApp();

</script>
</body>
</html>
