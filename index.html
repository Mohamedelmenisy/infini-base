<!DOCTYPE html>
<html lang="en" dir="ltr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InfiniBase - Knowledge Base</title>
    <!-- Updated Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32' width='32' height='32'><rect width='32' height='32' rx='4' fill='%236366f1'/><text x='50%' y='55%' dominant-baseline='middle' text-anchor='middle' font-family='Arial, sans-serif' font-size='18' font-weight='bold' fill='white'>IB</text></svg>">
    
    <!-- CDNs -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>


    <style>
        :root {
            /* Permanent Dark Theme Variables */
            --primary-color: #6366f1; /* Brighter Indigo for dark */
            --primary-color-hover: #4f46e5;
            --secondary-color: #9ca3af;

            --text-color: #d1d5db;
            --text-color-muted: #9ca3af;
            --text-color-inverted: #ffffff; 
            --text-color-subtle: #9ca3af;

            --bg-color: #111827; /* Dark gray */
            --bg-color-alt: #1f2937; /* Slightly lighter dark gray for cards/modals */
            --bg-color-sidebar: #1f2937;
            --bg-color-header: rgba(31, 41, 55, 0.9);
            --bg-color-modal: #1f2937;
            --bg-color-hover: #374151;
            --bg-color-active: var(--primary-color);

            --border-color: #374151;
            --border-color-darker: #4b5563;

            --card-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            --card-hover-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            
            --border-radius: 0.5rem; 
            --border-radius-lg: 0.75rem;
            --header-height: 70px;
            --sidebar-width: 260px;

            --yes-color: #22c55e; /* Green for Yes */
            --no-color: #ef4444;   /* Red for No */
            --rating-color: #fbbf24; /* Amber 400 for ratings */
            --step-done-color: #22c55e;
            --step-pending-color: #f59e0b;
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            line-height: 1.6;
            font-size: 16px;
        }

        a { /* Apply to all links */
            text-decoration-skip-ink: none;
        }

        .container-fluid {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-color-sidebar);
            padding: 1.5rem;
            border-right: 1px solid var(--border-color); /* LTR */
            position: fixed;
            top: 0;
            left: 0; /* LTR */
            height: 100vh;
            overflow-y: auto;
            transition: transform 0.3s ease-in-out, background-color 0.3s ease, border-color 0.3s ease;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }
        .sidebar.closed {
            transform: translateX(-100%); /* LTR */
        }
        @media (min-width: 768px) {
            .sidebar.closed { transform: translateX(0); }
        }

        .sidebar-header {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            color: var(--text-color); 
        }
        .sidebar-header i { 
            margin-right: 0.75rem; /* LTR */
            color: var(--primary-color);
            font-size: 1.8rem;
        }
        .sidebar-logo-text {
             color: var(--text-color);
        }

        .sidebar-nav { flex-grow: 1; }

        .sidebar-section-title {
            padding-left: 0.75rem; /* LTR */
            font-size: 0.75rem;
            font-weight: 700; /* Increased font-weight for better visibility */
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--text-color-muted);
        }

        .sidebar-link {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-radius: var(--border-radius);
            transition: background-color 0.2s ease, color 0.2s ease;
            font-weight: 500;
            color: var(--text-color-subtle);
            text-decoration: none;
            margin-bottom: 0.25rem;
        }
        .sidebar-link i {
            margin-right: 0.75rem; /* LTR */
            width: 1.5rem; /* Adjusted for font-size */
            font-size: 1.5rem; /* Increased icon size */
            text-align: center;
            transition: color 0.2s ease;
        }
        .sidebar-link:hover {
            background-color: var(--bg-color-hover);
            color: var(--text-color);
        }
        .sidebar-link.active {
            background-color: var(--bg-color-active); /* Primary color */
            color: var(--text-color-inverted) !important; /* White text */
            font-weight: 600;
        }
        .sidebar-link.active i {
            color: var(--text-color-inverted) !important; /* White icon on primary background */
        }

        .sidebar-footer {
            margin-top: auto; 
            padding-top: 1rem;
        }
        .sidebar-footer button {
            width: 100%;
            margin-top: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sidebar-footer button i { margin-right: 0.5rem; }


        .content-wrapper {
            flex-grow: 1;
            padding-right: 1.5rem; /* LTR */
            padding-left: 1.5rem;
            transition: margin-left 0.3s ease-in-out; /* LTR */
            height: 100vh;
            overflow-y: auto;
        }
        @media (min-width: 768px) {
             .content-wrapper { margin-left: var(--sidebar-width); /* LTR */ }
             .sidebar.closed + .content-wrapper { margin-left: 0; /* LTR */ }
        }

        .content-header {
            background-color: var(--bg-color-header);
            padding: 1.25rem 2rem; 
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky; 
            top: 0;
            left: var(--sidebar-width); /* LTR, adjusted for fixed sidebar */
            right: 0;
            height: var(--header-height);
            z-index: 50;
            backdrop-filter: blur(8px); 
        }
         @media (max-width: 767px) { /* Mobile: header spans full width */
            .content-header {
                left: 0;
            }
        }
        .header-left-content { display: flex; align-items: center; } 
        #currentSectionTitle {
            font-size: 1.5rem; 
            font-weight: bold;
            margin: 0;
        }
        #breadcrumbs {
            font-size: 0.875rem; 
            color: var(--text-color-muted);
            margin-top: 0.25rem;
        }
        #breadcrumbs a { color: var(--primary-color); text-decoration: none; }
        #breadcrumbs a:hover { text-decoration: underline; }

        .header-right-content { display: flex; align-items: center; gap: 1rem; }
        .search-container { position: relative; }
        .search-container input[type="search"] {
            padding: 0.625rem 1rem 0.625rem 2.5rem; /* py-2.5 pl-10 pr-4 for LTR */
            border: 1px solid var(--border-color-darker);
            border-radius: 9999px; 
            min-width: 250px; 
            background-color: var(--bg-color-alt); 
            color: var(--text-color);
        }
        .search-container input[type="search"]::placeholder {
            color: var(--text-color-muted);
            opacity: 0.8;
        }
        .search-container .search-icon {
            position: absolute;
            inset-inline-start: 0.75rem; 
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-color-muted);
        }
        #searchResultsContainer {
            position: absolute;
            background-color: var(--bg-color-alt);
            border: 1px solid var(--border-color);
            border-top: none;
            width: 100%; 
            max-height: 300px; 
            overflow-y: auto;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); 
            z-index: 60; 
            border-radius: 0 0 var(--border-radius) var(--border-radius);
        }
        #searchResultsContainer a {
            display: block;
            padding: 0.75rem; 
            text-decoration: none;
            color: var(--text-color);
        }
        #searchResultsContainer a:hover { background-color: var(--bg-color-hover); }
        #searchResultsContainer mark { background-color: #78350f; color: #f3f4f6; }


        .user-profile { display: flex; align-items: center; gap: 0.5rem; }
        .user-profile img { width: 36px; height: 36px; border-radius: 50%; }
        #userNameDisplayHeader { font-weight: 500; }
        @media (max-width: 640px) { 
            #userNameDisplayHeader { display: none; }
        }

        main { padding: 1.5rem 0; }

        .card {
            background-color: var(--bg-color-alt);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg); 
            padding: 1.5rem;
            margin-bottom: 1.5rem; 
            box-shadow: var(--card-shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease, border-color 0.3s ease;
            display: flex;
            flex-direction: column; 
            min-height: 150px; 
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--card-hover-shadow);
        }
        .card-header-icon {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .card-icon-container {
            padding: 0.75rem;
            border-radius: 50%;
            margin-right: 1rem; /* LTR */
            background-color: var(--primary-color-hover); 
        }
        .card-icon-container i {
            font-size: 1.25rem;
            color: var(--text-color-inverted);  
        }
        .card h3 { margin-top: 0; font-size: 1.125rem; font-weight: 600; color: var(--text-color); line-height: 1.3; }
        .card p { margin-bottom: 1rem; font-size: 0.875rem; color: var(--text-color-subtle); flex-grow: 1; }
        .card .item-meta-info {
            margin-top: auto; 
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border-color);
        }
        .card .item-cta-link {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500; 
            font-size: 0.875rem;
        }
        .card .item-cta-link:hover { text-decoration: underline; color: var(--primary-color-hover); }
        .item-type-badge {
            font-size: 0.75rem; 
            padding: 0.25rem 0.75rem; 
            border-radius: 9999px; 
            background-color: var(--bg-color-hover); 
            color: var(--text-color-subtle); 
            font-weight: 600; 
            text-transform: uppercase;
        }
        .card-tags span {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 10px;
            background-color: var(--bg-color-hover);
            color: var(--text-color-subtle);
            display: inline-block;
            margin: 0 5px 5px 0; /* LTR */
        }

        .button, button {
            background-color: var(--primary-color);
            color: var(--text-color-inverted);
            border: 1px solid transparent;
            padding: 0.625rem 1rem; 
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.875rem; 
            font-weight: 500; 
            transition: background-color 0.2s, border-color 0.2s, color 0.2s;
            text-decoration: none; 
            display: inline-flex; 
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .button:hover, button:hover {
            background-color: var(--primary-color-hover);
        }
        .button-secondary {
            background-color: transparent;
            color: var(--text-color-subtle);
            border-color: var(--border-color-darker);
        }
        .button-secondary:hover { background-color: var(--bg-color-hover); color: var(--text-color); }
        .button-danger {
            background-color: #dc2626; 
            color: var(--text-color-inverted);
        }
        .button-danger:hover { background-color: #b91c1c; }
        input:focus, button:focus, select:focus, textarea:focus, a:focus { 
            outline: 2px solid transparent;
            outline-offset: 2px;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.6); 
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.75); 
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.2s ease-out;
        }
        .modal-overlay:not(.hidden) { opacity: 1; }
        .modal-content {
            background-color: var(--bg-color-modal);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 48rem; 
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.95);
            opacity: 0;
            transition: transform 0.2s ease-out, opacity 0.2s ease-out, background-color 0.3s ease, border-color 0.3s ease;
        }
        .modal-overlay:not(.hidden) .modal-content { transform: scale(1); opacity: 1; }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem; 
        }
        .modal-header h2 { margin-top: 0; font-size: 1.5rem; font-weight: 700; }
        .modal-header .close-button { 
            background: none; border: none; font-size: 1.5rem; color: var(--text-color-muted); cursor: pointer;
            padding: 0.25rem; line-height: 1; border-radius: 50%;
        }
        .modal-header .close-button:hover { background-color: var(--bg-color-hover); }
        
        .modal-body { /* For modals with just text content like confirm */
            padding-bottom: 1rem;
            font-size: 1rem;
            color: var(--text-color);
        }

        .modal-actions {
            margin-top: 1.5rem; 
            text-align: right; /* LTR */
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end; /* LTR */
            gap: 0.75rem; 
        }
         .modal-actions.no-border {
            border-top: none;
            padding-top: 0;
        }


        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.25rem; font-weight: 500; font-size: 0.875rem; }
        .form-group input[type="text"],
        .form-group input[type="url"],
        .form-group input[type="email"], /* Added for feedback modal */
        .form-group input[type="file"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.625rem; 
            border: 1px solid var(--border-color-darker); 
            border-radius: var(--border-radius);
            box-sizing: border-box;
            background-color: var(--bg-color); 
            color: var(--text-color);
        }
        .form-group textarea { min-height: 100px; }
        
        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: var(--text-color-muted);
            opacity: 0.8; /* Ensure it's not too faint */
        }
        
        /* Styles for Add Content Template Selection */
        #templateSelectionContainer { margin-bottom: 1.5rem; }
        #templateSelectionContainer h3 { font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-color); }
        .template-buttons-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .template-button {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color-darker);
            color: var(--text-color-subtle);
            padding: 1rem;
            border-radius: var(--border-radius);
            text-align: left; /* Maintained */
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex; /* Added for flex alignment */
            flex-direction: column; /* Stack items vertically */
            align-items: flex-start; /* Align items to the start (left) */
        }
        .template-button:hover {
            border-color: var(--primary-color);
            background-color: var(--bg-color-hover);
            color: var(--text-color);
        }
        .template-button i { 
            font-size: 1.5rem; 
            margin-bottom: 0.75rem; /* Increased margin */
            display: block; 
            color: var(--primary-color); 
            width: 100%; /* Ensure icon container takes width for alignment if needed */
            text-align: left; /* Ensure icon itself is left-aligned */
        }
        .template-button h4 { 
            font-size: 1rem; 
            font-weight: 600; 
            margin-bottom: 0.5rem; /* Increased margin */
        }
        .template-button p { 
            font-size: 0.8rem; 
            line-height: 1.4; 
            color: var(--text-color-muted); /* Consistent with other paragraph text */
        }


        .ql-toolbar {
            background: var(--bg-color);
            border-color: var(--border-color-darker) !important;
            border-top-left-radius: var(--border-radius);
            border-top-right-radius: var(--border-radius);
        }
        .ql-toolbar .ql-stroke { stroke: var(--text-color-muted); }
        .ql-toolbar .ql-fill { fill: var(--text-color-muted); }
        .ql-toolbar .ql-picker-label { color: var(--text-color-muted); }
        .ql-snow .ql-picker.ql-expanded .ql-picker-options { background-color: var(--bg-color-alt); border-color: var(--border-color-darker); }
        .ql-snow .ql-picker-options .ql-picker-item:hover { color: var(--primary-color); }


        .ql-container {
            background: var(--bg-color-alt);
            border-color: var(--border-color-darker) !important;
            color: var(--text-color);
            min-height: 150px; 
            border-bottom-left-radius: var(--border-radius);
            border-bottom-right-radius: var(--border-radius);
            font-size: 1rem;
        }
        .ql-editor { padding: 12px; }
        .ql-editor.ql-blank::before {
            color: var(--text-color-muted);
            opacity: 0.6;
        }
        .ql-editor img {
            max-width: 100%;
            height: auto;
            border-radius: var(--border-radius);
            display: block;
            margin: 1rem auto;
        }


        footer {
            text-align: center;
            padding: 1.5rem;
            font-size: 0.875rem;
            color: var(--text-color-muted);
            border-top: 1px solid var(--border-color);
            margin-top: auto; 
        }

        .mobile-sidebar-toggle {
            display: block;
            position: fixed;
            top: calc((var(--header-height) - 40px) / 2); 
            left: 1.5rem; /* LTR */
            z-index: 101; 
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 0.75rem; 
            border-radius: var(--border-radius);
            font-size: 1.25rem; 
            line-height: 1;
        }
        @media (min-width: 768px) {
            .mobile-sidebar-toggle { display: none; }
            .header-left-content #currentSectionTitle { margin-left: 0; } /* No toggle on desktop */
        }
        @media (max-width: 767px) {
            .header-left-content #currentSectionTitle { margin-left: 0.5rem; } /* Space for toggle */
            .content-header { padding: 1rem; }
            .header-right-content .search-container { display:none; } 
        }

        .toast-notification {
            position: fixed;
            bottom: 20px;
            right: 20px; /* LTR */
            padding: 12px 18px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 2000; 
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            display: flex;
            align-items: center;
            background-color: var(--bg-color-alt); 
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }
        .toast-notification.show { opacity: 1; transform: translateY(0); }
        .toast-icon { margin-right: 10px; /* LTR */ font-size: 1.2em; }
        .toast-success { background-color: #10b981; color: white; border-color: #059669; } 
        .toast-error { background-color: #ef4444; color: white; border-color: #dc2626; } 
        .toast-info { background-color: #3b82f6; color: white; border-color: #2563eb; } 

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 1.5rem; 
        }

        .kb-content h1, .kb-content h2, .kb-content h3 { margin-top: 1.5em; margin-bottom: 0.5em; color: var(--text-color); }
        .kb-content p { margin-bottom: 1em; }
        .kb-content ul, .kb-content ol { margin-bottom: 1em; padding-left: 20px; /* LTR */ }
        .kb-content li { margin-bottom: 0.5em; }
        .kb-content strong { font-weight: bold; }
        .kb-content em { font-style: italic; }
        .kb-content a { color: var(--primary-color); text-decoration: underline; }
        .kb-content pre {
            background-color: var(--bg-color);
            padding: 10px;
            border-radius: var(--border-radius);
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            border: 1px solid var(--border-color);
            color: var(--text-color); /* Ensure pre content is visible */
        }
         .kb-content code { /* More specific for inline code if needed */
            background-color: var(--bg-color-hover);
            padding: 0.2em 0.4em;
            margin: 0;
            font-size: 85%;
            border-radius: 3px;
        }
        mark {
            padding: 0.1em 0.2em; border-radius: 0.2em; font-weight: bold;
            background-color: #78350f; color: #f3f4f6; 
        }

        .hidden { display: none !important; }

        .chart-container {
            position: relative;
            padding: 1rem;
            border-radius: var(--border-radius-lg);
            background-color: var(--bg-color-alt);
            height: 320px; 
            display: flex; /* For centering canvas */
            flex-direction: column; /* For centering canvas */
            justify-content: center; /* For centering canvas */
            align-items: center; /* For centering canvas */
        }
        .chart-container canvas { /* Ensure canvas does not overflow */
            max-width: 100%;
            max-height: 100%;
        }
        .chart-container h3 {
            font-size: 1.125rem; 
            font-weight: 600; 
            margin-bottom: 0.5rem;
            text-align: center;
            width: 100%; /* Ensure title takes full width above chart */
        }
        .mermaid-diagram-card { /* Specific card for Mermaid diagrams */
            background-color: var(--bg-color-alt);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--card-shadow);
            margin-bottom: 1.5rem;
        }
        .mermaid-diagram-card h3 { /* Title within the card */
            margin-top: 0;
            margin-bottom: 1rem;
            font-size: 1.25rem;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }
        .mermaid-diagram-container {
            overflow-x: auto; /* For wide diagrams */
            padding: 10px; 
            background-color: var(--bg-color-alt); /* Diagram area background */
            border-radius: var(--border-radius);
        }
        .mermaid-diagram-container svg { 
            display: block;
            margin: 0 auto; 
            max-width: 100%; 
            min-height: 350px; /* Reduced min-height for diagram clarity */
            height: auto; /* Allow height to adjust based on content */
        }
        /* Mermaid dark theme overrides */
        .mermaid-diagram-container text { 
            fill: var(--text-color) !important; 
            font-family: 'Inter', sans-serif !important; 
            font-size: 14px !important; /* Increased font size for clarity */
        }
        .mermaid-diagram-container .edgeLabel { 
            color: var(--text-color) !important; 
        } 
         .mermaid-diagram-container .edgeLabel span { 
            font-size: 14px !important; /* Ensure consistent font size */
        }
        .mermaid-diagram-container .label { color: var(--text-color) !important; }
        .mermaid-diagram-container .actor { stroke: var(--text-color-muted) !important; fill: var(--bg-color-alt) !important; }
        .mermaid-diagram-container .messageText { fill: var(--text-color) !important; }
        .mermaid-diagram-container rect, 
        .mermaid-diagram-container polygon, 
        .mermaid-diagram-container ellipse,
        .mermaid-diagram-container circle {
            stroke: var(--primary-color) !important; /* Node border */
            fill: var(--bg-color-alt) !important; /* Node background, same as diagram for border emphasis */
        }
        .mermaid-diagram-container .cluster rect {
             fill: var(--bg-color) !important; /* Darker fill for cluster background */
             stroke: var(--border-color-darker) !important;
        }
        .mermaid-diagram-container .arrowheadPath {
            fill: var(--primary-color) !important;
        }
        .mermaid-diagram-container .edgePaths path {
            stroke: var(--primary-color) !important;
        }


        /* Item Detail View Specific */
        #itemDetailViewPlaceholder .card { /* General card within detail view */
            /* border-top: 4px solid var(--primary-color);  Removed to avoid double top border on standard card */
        }
        #itemDetailViewPlaceholder .item-title-area {
            display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;
        }
        #itemDetailViewPlaceholder .item-title-area i.fa-title-icon { /* Specific class for title icon */
            font-size: 2rem; color: var(--primary-color); 
        }
        #itemDetailViewPlaceholder .item-title-area h2 { font-size: 1.8rem; margin:0; }
        #itemDetailViewPlaceholder .item-summary { color: var(--text-color-subtle); margin-bottom: 1rem; font-style: italic; }
        #itemDetailViewPlaceholder hr.title-content-divider { /* Specific class for this hr */
             margin: 1.5rem 0; border-color: var(--border-color); 
        }
        #itemDetailViewPlaceholder .kb-content ul { list-style-type: disc; }
        #itemDetailViewPlaceholder .child-items-list { list-style-type: none; padding-left: 0; }
        #itemDetailViewPlaceholder .child-items-list li { margin-bottom: 0.5rem; }
        #itemDetailViewPlaceholder .child-items-list a { color: var(--primary-color); text-decoration: none; }
        #itemDetailViewPlaceholder .child-items-list a:hover { text-decoration: underline; }
        .item-actions-bar { display: flex; gap: 0.75rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .item-feedback-section { margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color); }
        .item-feedback-section h4 { font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; }
        .rating-buttons button { background: none; border: 1px solid var(--border-color); color: var(--text-color-muted); padding: 0.5rem 0.75rem; border-radius: var(--border-radius); cursor: pointer; transition: all 0.2s; }
        .rating-buttons button:hover, .rating-buttons button.active { border-color: var(--rating-color); color: var(--rating-color); background-color: rgba(251, 191, 36, 0.1); }
        .rating-buttons button i { margin-right: 0.5rem; }
        .read-stats { font-size: 0.875rem; color: var(--text-color-muted); margin-left: 1rem; }
        
        .comments-section { margin-top: 2rem; }
        .comments-section .comment-form textarea { width: 100%; min-height: 80px; margin-bottom: 0.5rem;}
        .comments-section .comment-form { margin-top: 1rem; }
        .comments-section .comment-display-area { 
            margin-top: 1rem; 
            padding: 1rem; 
            background-color: var(--bg-color); 
            border-radius: var(--border-radius); 
            min-height: 50px; 
            border: 1px solid var(--border-color-darker);
        }
        .comment-display-area .comment {
            border-bottom: 1px solid var(--border-color);
            padding: 0.75rem 0;
            margin-bottom: 0.75rem;
        }
        .comment-display-area .comment:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .comment-author {
            font-weight: 600;
            color: var(--text-color);
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }
        .comment-author .comment-timestamp {
            font-weight: normal;
            color: var(--text-color-muted);
            font-size: 0.75rem;
            margin-left: 0.5rem;
        }
        .comment-text {
            font-size: 0.95rem;
            line-height: 1.5;
            color: var(--text-color-subtle);
            white-space: pre-wrap; /* Preserve line breaks in comments */
        }
        .comment-actions {
            margin-top: 0.5rem;
            font-size: 0.8rem;
        }
        .comment-actions .reply-btn {
            color: var(--primary-color);
            cursor: pointer;
            font-weight: 500;
        }
        .comment-replies {
            padding-left: 2rem;
            border-left: 2px solid var(--border-color);
            margin-top: 0.75rem;
        }
        .comment .comment-form {
            margin-top: 0.75rem;
        }
        .comment .comment-form textarea {
            min-height: 60px;
        }
        .comment .comment-form button {
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
        }


        /* Dashboard specific styles */
        .dashboard-stat-card {
            background-color: var(--bg-color-alt);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--card-shadow);
            text-align: center;
        }
        .dashboard-stat-card i {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 0.75rem;
        }
        .dashboard-stat-card .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            display: block;
            margin-bottom: 0.25rem;
        }
        .dashboard-stat-card .stat-label {
            font-size: 0.875rem;
            color: var(--text-color-muted);
        }
        .dashboard-quicklink-card, .dashboard-info-card { /* Combined for similar styling */
             background-color: var(--bg-color-alt);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--card-shadow);
        }
         .dashboard-quicklink-card h3, .dashboard-info-card h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }
        .dashboard-quicklink-card ul, .dashboard-info-card ul {
            list-style: none;
            padding: 0;
        }
        .dashboard-quicklink-card ul li a, .dashboard-info-card ul li a {
            display: block;
            padding: 0.5rem 0;
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
        }
         .dashboard-quicklink-card ul li a:hover, .dashboard-info-card ul li a:hover {
            text-decoration: underline;
        }
         .dashboard-info-card ul li {
            font-size: 0.9rem;
            color: var(--text-color-subtle);
            padding: 0.3rem 0;
         }
         .dashboard-info-card ul li strong {
            color: var(--text-color);
         }
         .dashboard-info-card ul li .meta {
            font-size: 0.75rem;
            display: block;
            color: var(--text-color-muted);
         }
         /* Viewer Dashboard Message */
        .viewer-dashboard-message .card {
            text-align: center;
            padding: 40px 20px;
            min-height: auto; /* Override general card min-height if needed */
        }
        .viewer-dashboard-message .card i {
            font-size: 2.5rem; /* Larger icon for emphasis */
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
        .viewer-dashboard-message .card h2 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--text-color);
        }
        .viewer-dashboard-message .card p {
            font-size: 1rem;
            color: var(--text-color-muted);
            margin-bottom: 0; /* Adjust as needed */
        }
        .viewer-dashboard-message .card p.subtle-note {
             font-size: 0.9rem;
             margin-top: 1rem;
        }

        /* Interactive Flow Styles (for sup_flow_compensation) */
        .interactive-flow-container {
            background-color: var(--bg-color); /* Slightly different from card for distinction */
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--border-color);
        }
        .flow-title-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color-darker);
        }
        .flow-title-bar h2 {
            font-size: 1.6rem;
            margin: 0;
            color: var(--text-color);
            display: flex;
            align-items: center;
        }
        .flow-title-bar h2 i {
            margin-right: 0.75rem;
            color: var(--primary-color);
            font-size: 1.8rem;
        }
        .flow-title-bar #flowTopActions button { /* Ensure buttons in title bar are styled correctly */
            padding: 0.5rem 0.8rem; /* Smaller padding if needed */
            font-size: 0.8rem;
        }


        .flow-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        .flow-controls .button i { margin-right: 0.5rem; }

        .step-card {
            background: var(--bg-color-alt);
            border-left: 4px solid var(--primary-color);
            border-radius: var(--border-radius);
            padding: 0; /* Padding moved to header/body */
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            overflow: hidden; /* For smooth expand/collapse */
        }
        .step-header {
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            background-color: var(--bg-color-alt); /* Ensure header has bg */
            border-bottom: 1px solid var(--border-color); /* Separator when collapsed */
        }
        .step-card.expanded > .step-header {
             border-bottom-color: var(--border-color-darker); /* Stronger separator when expanded */
        }

        .step-header-main {
            display: flex;
            align-items: center;
            flex-grow: 1;
        }
        .step-number {
            color: var(--primary-color);
            font-weight: 700;
            margin-right: 0.75rem;
            font-size: 1.1em;
        }
        .step-title {
            font-weight: 600;
            font-size: 1.1em;
            color: var(--text-color);
            margin-right: 1rem; /* Added to give space from actions */
        }
        .step-header-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .mark-step-done-btn {
            padding: 0.3rem 0.6rem;
            font-size: 0.8rem;
            border: 1px solid var(--border-color-darker);
            background-color: transparent;
            border-radius: var(--border-radius);
            transition: all 0.2s;
            color: var(--text-color-subtle); /* Default color */
        }
        .mark-step-done-btn.done {
            background-color: var(--step-done-color);
            border-color: var(--step-done-color);
            color: var(--text-color-inverted);
        }
        .mark-step-done-btn.pending { /* Not explicitly used if default is pending */
            background-color: var(--step-pending-color);
            border-color: var(--step-pending-color);
            color: var(--text-color-inverted);
        }
        .mark-step-done-btn:hover:not(.done):not(.pending) {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .toggle-step-details-btn {
            background: none;
            border: none;
            color: var(--text-color-muted);
            font-size: 1.2rem;
            padding: 0.25rem;
        }
        .toggle-step-details-btn i.fa-chevron-down { transition: transform 0.2s ease-in-out; }
        .step-card.expanded .toggle-step-details-btn i.fa-chevron-down { transform: rotate(180deg); }

        .step-body {
            padding: 0 1.5rem 1.5rem 1.5rem; /* No top padding, handled by header bottom padding */
            display: none; /* Collapsed by default */
            background-color: var(--bg-color); /* Slightly darker for content area */
        }
        .step-card.expanded > .step-body { 
            display: block; 
            border-top: 1px solid var(--border-color-darker); /* Add separator only when expanded */
        }
        
        .step-body .kb-content { padding-top: 1rem; } 
        .step-body p, .step-body ul, .step-body ol {
            margin-bottom: 0.75em;
            color: var(--text-color-subtle);
        }
        .step-body strong { color: var(--text-color); }
        .step-body ul, .step-body ol { padding-left: 25px; } 
        
        /* Updated .step-link style per request */
        .step-link {
            color: #60a5fa; /* A nice blue color */
            font-weight: 500;
            text-decoration: none;
            border-bottom: 1px dotted #60a5fa;
            text-decoration-skip-ink: none;
        }
        .step-link:hover {
            text-decoration: underline;
            border-bottom-style: solid;
            color: #7dd3fc;
        }
        
        .important-notes-card {
            background: var(--bg-color-alt);
            border-left: 4px solid var(--rating-color); /* Amber color for important notes */
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-top: 1.5rem;
            box-shadow: var(--card-shadow);
        }
        .important-notes-card h3 {
            font-size: 1.2em;
            font-weight: 600;
            color: var(--text-color);
            margin-top: 0;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
        }
        .important-notes-card h3 i {
            margin-right: 0.75rem;
            color: var(--rating-color);
        }
        .important-notes-card ul {
            padding-left: 20px;
            list-style: disc;
            color: var(--text-color-subtle);
        }
        /* Agent Script Mode styles */
        .agent-script-block { /* Generic block for script related content */
            background-color: var(--bg-color-hover);
            padding: 0.75rem 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 0.5rem;
            border-left: 3px solid var(--primary-color);
            color: var(--text-color);
            position: relative;
        }
        .agent-script-block i.fa-comment-dots { /* Specific for blockquote icon */
            margin-right: 0.5rem;
            color: var(--primary-color);
        }
        .copy-script-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem; /* LTR */
            background: var(--bg-color);
            color: var(--text-color-muted);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
            z-index: 1; /* Ensure it's above text */
        }
        .copy-script-btn:hover { opacity: 1; }

        /* Hide non-script elements in Agent Script Mode */
        .agent-script-mode-active .step-body > .kb-content > *:not(.agent-script-block) {
            display: none;
        }
        .agent-script-mode-active .step-body > .kb-content > .agent-script-block {
            display: block !important; /* Ensure it's shown */
            margin-bottom: 1rem; /* Add some spacing between script blocks */
        }
        /* Quill editor for in-place flow editing */
        #flowInPlaceEditorContainer {
            margin-top: 1rem;
            border: 1px solid var(--border-color-darker);
            border-radius: var(--border-radius-lg);
            padding: 1rem;
            background-color: var(--bg-color-alt);
        }
        #flowQuillEditor { min-height: 300px; } /* Container for Quill */
        .flow-editor-actions {
            margin-top: 1rem;
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        /* Print Styles */
        @media print {
            body, .container-fluid {
                margin: 0;
                padding: 0;
                background-color: white !important;
                color: black !important;
                font-size: 12pt; /* Adjust base font size for print */
            }
            .sidebar, .content-header, .sidebar-footer, footer,
            .mobile-sidebar-toggle, #toastContainer,
            .item-actions-bar .button:not(#printItemBtn):not(#downloadPdfItemBtn), /* Keep Print/PDF button placeholders if needed, or hide all */
            .item-actions-bar button[id*="edit"], .item-actions-bar button[id*="delete"], .item-actions-bar button[id*="share"], /* More specific hiding */
            .flow-controls, .flow-title-bar #flowTopActions,
            .item-feedback-section, .comments-section,
            .modal-overlay,
            .copy-script-btn,
            .dashboard-overview-container,
            .search-container, .user-profile,
            .mark-step-done-btn, .toggle-step-details-btn,
            #openAddContentBtnInSection
            {
                display: none !important;
            }

            .content-wrapper {
                margin-left: 0 !important;
                padding: 1cm !important; /* A4-like margins */
                overflow: visible !important;
                height: auto !important;
                width: 100% !important;
            }
            #pageContentArea { padding: 0 !important; }
            
            #itemDetailViewPlaceholder, #standardSectionContentPlaceholder, .interactive-flow-container {
                display: block !important; /* Ensure the content is visible */
            }
            .card, .interactive-flow-container, .mermaid-diagram-card, .step-card {
                box-shadow: none !important;
                border: 1px solid #ccc !important;
                margin-bottom: 0.5cm !important;
                background-color: white !important;
                page-break-inside: avoid;
            }
            
            .card *, .interactive-flow-container *, .mermaid-diagram-card *, .step-card * {
                color: black !important;
                background-color: transparent !important;
            }
             h1, h2, h3, h4, h5, h6 { color: black !important; } /* Ensure heading colors */

            .step-card.expanded > .step-body,
            .interactive-flow-container .step-card .step-body { /* Force expand all step bodies for print */
                display: block !important;
            }
             .interactive-flow-container .step-card:not(.expanded) .step-body { /* Alternative for non-expanded steps */
                display: block !important;
            }
             .step-card .toggle-step-details-btn i.fa-chevron-down {
                transform: rotate(180deg); /* Visually indicate expansion if icon not hidden */
            }
            .important-notes-card { display: block !important; } /* Show important notes */
            .agent-script-mode-active .step-body > .kb-content > *:not(.agent-script-block) {
                display: block !important; /* Show all content if agent script mode was active */
            }


            .kb-content a {
                color: #0066cc !important;
                text-decoration: underline !important;
            }
            .kb-content a[href^="http"]::after, 
            .kb-content a[href^="https"]::after { /* Show URL for external links */
                content: " (" attr(href) ")";
                font-size: 0.8em;
                color: #555 !important;
                word-break: break-all;
            }
            .kb-content a[href^="#"]::after { /* Don't show URL for internal/anchor links */
                content: "";
            }
             .step-link::after { content: ""; } /* Ensure step links don't show href */


            /* Mermaid diagrams for print */
            .mermaid-diagram-container { background-color: white !important; }
            .mermaid-diagram-container svg {
                background-color: white !important;
                max-width: 100% !important; /* Ensure it fits */
                height: auto !important;
            }
            .mermaid-diagram-container text,
            .mermaid-diagram-container .edgeLabel,
            .mermaid-diagram-container .label,
            .mermaid-diagram-container .messageText {
                fill: black !important;
                font-family: 'Arial', sans-serif !important; /* Common print font */
            }
            .mermaid-diagram-container .actor {
                stroke: #333 !important;
                fill: white !important;
            }
            .mermaid-diagram-container rect,
            .mermaid-diagram-container polygon,
            .mermaid-diagram-container ellipse,
            .mermaid-diagram-container circle {
                stroke: #333 !important;
                fill: #f0f0f0 !important; /* Light fill for nodes */
            }
            .mermaid-diagram-container .cluster rect {
                fill: #e8e8e8 !important; /* Slightly darker for clusters */
                stroke: #aaa !important;
            }
            .mermaid-diagram-container .arrowheadPath {
                fill: #333 !important;
            }
            .mermaid-diagram-container .edgePaths path {
                stroke: #333 !important;
            }
            pre.mermaid { /* Ensure mermaid code block itself is not overly styled for print */
                background-color: #f8f8f8 !important;
                border: 1px solid #ddd !important;
                padding: 8px !important;
            }
        }

    </style>
</head>
<body>

    <div id="addContentModalOverlay" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="addContentModalTitle">Add New Content</h2>
                <button id="closeAddContentModalBtn" class="close-button" aria-label="Close">×</button>
            </div>

            <!-- Template selection is kept from the original file -->
            <div id="templateSelectionContainer">
                <h3>Choose a Template</h3>
                <div class="template-buttons-grid">
                    <button class="template-button" data-template="standard_article">
                        <i class="fas fa-newspaper"></i>
                        <h4>Standard Article</h4>
                        <p>For general information, announcements, or detailed explanations.</p>
                    </button>
                    <button class="template-button" data-template="troubleshooting_guide">
                        <i class="fas fa-tools"></i>
                        <h4>Troubleshooting Guide / Case</h4>
                        <p>Step-by-step solutions for common issues or case documentation.</p>
                    </button>
                    <button class="template-button" data-template="policy_document">
                        <i class="fas fa-gavel"></i>
                        <h4>Policy Document</h4>
                        <p>Formal policies, procedures, or official guidelines.</p>
                    </button>
                     <button class="template-button" data-template="blank">
                        <i class="fas fa-file"></i>
                        <h4>Blank Document</h4>
                        <p>Start with a completely empty document of any type.</p>
                    </button>
                </div>
                <hr style="border-color: var(--border-color-darker); margin: 1.5rem 0;">
            </div>
            
            <!-- This form is now used for creating/editing scenarios (call_scenarios table) -->
            <form id="addContentForm" class="hidden">
                <input type="hidden" id="editingItemId"> <!-- For storing scenario UUID when editing -->
                <div class="form-group">
                    <label for="contentTitle">Title</label>
                    <input type="text" id="contentTitle" required>
                </div>
                <div class="form-group">
                    <label for="contentSlug">Slug (e.g., sup_flow_compensation)</label>
                    <input type="text" id="contentSlug" required placeholder="Must be unique, starts with section prefix">
                </div>
                <div class="form-group">
                    <label for="contentSummary">Summary / Description</label>
                    <textarea id="contentSummary" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label>Details / Content (Steps)</label>
                    <div id="quillEditor"></div>
                </div>
                <div class="form-group">
                    <label for="contentTags">Tags (comma-separated)</label>
                    <input type="text" id="contentTags" placeholder="e.g., important, update, billing">
                </div>
                <div class="modal-actions">
                    <button type="submit" id="saveContentBtn" class="button"><i class="fas fa-save"></i> Save Content</button>
                    <button type="button" id="cancelAddContentBtn" class="button-secondary"><i class="fas fa-times"></i> Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div id="logoutConfirmModalOverlay" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 28rem;">
            <div class="modal-header">
                <h2 id="logoutConfirmModalTitle">Confirm Logout</h2>
                <button class="close-button" aria-label="Close">×</button>
            </div>
            <div class="modal-body"><p>Are you sure you want to logout from InfiniBase?</p></div>
            <div class="modal-actions no-border"> 
                <button type="button" id="confirmLogoutBtn" class="button button-danger"><i class="fas fa-sign-out-alt"></i> Confirm Logout</button>
                <button type="button" class="button-secondary" data-close-modal><i class="fas fa-times"></i> Cancel</button>
            </div>
        </div>
    </div>

    <!-- Report General Feedback Modal -->
    <div id="reportFeedbackModalOverlay" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 32rem;">
            <div class="modal-header">
                <h2 id="reportFeedbackModalTitle">Report General Feedback</h2>
                <button class="close-button" aria-label="Close">×</button>
            </div>
            <form id="reportFeedbackForm">
                <input type="hidden" id="feedbackItemId">
                <div class="modal-body" style="padding-bottom:0;">
                    <p style="margin-bottom: 1rem;">Provide your feedback for: <strong id="feedbackItemTitleDisplay"></strong></p>
                    <div class="form-group">
                        <label for="feedbackComment">Your Feedback / Comments</label>
                        <textarea id="feedbackComment" rows="5" required placeholder="Please describe the issue or suggestion..."></textarea>
                    </div>
                </div>
                <div class="modal-actions"> 
                    <button type="submit" class="button"><i class="fas fa-paper-plane"></i> Submit Feedback</button>
                    <button type="button" class="button-secondary" data-close-modal><i class="fas fa-times"></i> Cancel</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Not Helpful Reason Modal (NEW) -->
    <div id="notHelpfulModalOverlay" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 30rem;">
            <div class="modal-header">
                <h2>Reason for Rating</h2>
                <button class="close-button" aria-label="Close">×</button>
            </div>
            <form id="notHelpfulForm">
                <div class="modal-body" style="padding-bottom:0;">
                    <p style="margin-bottom: 1rem;">Please let us know why this content was not helpful. Your feedback is valuable.</p>
                    <div class="form-group">
                        <label for="notHelpfulReason">Reason</label>
                        <textarea id="notHelpfulReason" rows="4" required placeholder="e.g., The information is outdated, the steps are unclear..."></textarea>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="button"><i class="fas fa-paper-plane"></i> Submit Feedback</button>
                    <button type="button" class="button-secondary" data-close-modal>Cancel</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmModalOverlay" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 30rem;">
            <div class="modal-header">
                <h2 id="deleteConfirmModalTitle">Confirm Deletion</h2>
                <button class="close-button" aria-label="Close">×</button>
            </div>
            <div class="modal-body">
                <p id="deleteConfirmMessage">Are you sure you want to delete this item? This action cannot be undone.</p>
            </div>
            <div class="modal-actions no-border">
                <button type="button" id="confirmDeleteItemBtn" class="button button-danger"><i class="fas fa-trash-alt"></i> Confirm Delete</button>
                <button type="button" class="button-secondary" data-close-modal><i class="fas fa-times"></i> Cancel</button>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-database"></i> <span class="sidebar-logo-text">InfiniBase</span>
            </div>
            <nav id="navigationMenu" class="sidebar-nav">
                <!-- Links will be dynamically generated -->
            </nav>
            <div class="sidebar-footer">
                <button id="logoutButton" class="button button-danger">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
                 <div id="userRoleDisplaySidebar" style="font-size: 0.8rem; color: var(--text-color-muted); text-align: center; margin-top: 0.5rem;">Role: <span id="currentUserRoleSpan"></span></div>
            </div>
        </aside>

        <div class="content-wrapper" id="contentWrapper">
            <header class="content-header">
                <div class="header-left-content">
                    <button id="mobileSidebarToggle" class="mobile-sidebar-toggle"><i class="fas fa-bars"></i></button>
                    <div>
                        <h1 id="currentSectionTitle">Welcome</h1>
                        <div id="breadcrumbs">Home</div>
                    </div>
                </div>
                <div class="header-right-content">
                    <div class="search-container">
                        <span class="search-icon"><i class="fas fa-search"></i></span>
                        <input type="search" id="globalSearchInput" placeholder="Search the knowledge base...">
                        <div id="searchResultsContainer" class="hidden"></div>
                    </div>
                    <div id="userProfileContainer" class="user-profile">
                        <img id="userAvatar" src="https://ui-avatars.com/api/?name=U&size=36&background=6366f1&color=fff&rounded=true" alt="User">
                        <span id="userNameDisplayHeader" style="font-weight: 500;">User</span>
                    </div>
                </div>
            </header>

            <main id="pageContentArea" class="p-6 md:p-8">
                <div id="dashboardOverviewContainer" class="hidden">
                    <!-- Dashboard content will be injected here -->
                </div>
                <div id="standardSectionContentPlaceholder">
                    <!-- Section content will be injected here -->
                </div>
                <div id="itemDetailViewPlaceholder" class="hidden" data-mermaid-rendered="false">
                    <!-- Item detail view OR Interactive Flow View -->
                </div>
            </main>

            <footer class="mt-auto p-6 text-center text-sm">
                <span>© <script>document.write(new Date().getFullYear())</script> InfiniBase.Elmenisy. Version <span id="footerKbVersion">1.0.0</span></span>
            </footer>
        </div>
    </div>
    <div id="toastContainer"></div>

<script type="module">
    // =================================================================================
    // SUPABASE CLIENT SETUP
    // IMPORTANT: Create 'supabase.js' and export your client from there.
    // Example `supabase.js`:
    //
    // import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
    // const SUPABASE_URL = 'YOUR_SUPABASE_URL';
    // const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
    // export const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    //
    // =================================================================================
    import { supabase } from './supabase.js';

    // =================================================================================
    // IMMEDIATE SESSION CHECK
    // =================================================================================
    const { data: { session: initialSession }, error: initialSessionError } = await supabase.auth.getSession();

    if (initialSessionError) {
        console.error("Critical error during initial session check. Redirecting.", initialSessionError.message);
        window.location.href = 'login.html';
    } else if (!initialSession) {
        console.log("No initial session found. Redirecting to login.");
        window.location.href = 'login.html';
    }
    // If a session exists, the script continues.
    // =================================================================================

    // --- Initialize Mermaid ---
    mermaid.initialize({ 
        startOnLoad: false,
        theme: 'dark', 
        fontFamily: 'Inter, sans-serif'
    });
    
    // --- Application State & Data ---
    const appData = {
        scenarios: [], // Holds all scenarios from `call_scenarios` table
        sections: [
            { id: 'home', name: 'Home', icon: 'fas fa-home', slug_prefix: null, color: 'var(--primary-color)' },
            { id: 'support', name: 'Support', icon: 'fas fa-headset', slug_prefix: 'sup_', color: '#c084fc' },
            { id: 'partner_care', name: 'Partner Care', icon: 'fas fa-handshake', slug_prefix: 'pc_', color: '#2dd4bf' },
            { id: 'logistics', name: 'Logistics', icon: 'fas fa-truck', slug_prefix: 'log_', color: '#4ade80' },
            // Add more sections here, they will automatically filter scenarios based on slug_prefix
        ],
        meta: {
            version: '1.0.0-supabase'
        },
        currentOpenScenario: null // Holds the full data of the currently viewed scenario
    };

    /** @type {UserProfile|null} */
    let currentUser = null; 
    let mainQuillEditor;
    let flowInPlaceQuillEditor;
    
    // --- DOM Elements ---
    const sidebar = document.getElementById('sidebar');
    const mobileSidebarToggle = document.getElementById('mobileSidebarToggle');
    const navigationMenu = document.getElementById('navigationMenu');
    const currentSectionTitleEl = document.getElementById('currentSectionTitle');
    const breadcrumbsContainer = document.getElementById('breadcrumbs');
    const pageContentArea = document.getElementById('pageContentArea');
    const dashboardOverviewContainer = document.getElementById('dashboardOverviewContainer');
    const standardSectionContentPlaceholder = document.getElementById('standardSectionContentPlaceholder');
    const itemDetailViewPlaceholder = document.getElementById('itemDetailViewPlaceholder');
    const userNameDisplayHeader = document.getElementById('userNameDisplayHeader');
    const userAvatar = document.getElementById('userAvatar');
    const footerKbVersion = document.getElementById('footerKbVersion');
    const currentUserRoleSpan = document.getElementById('currentUserRoleSpan');

    // --- Utility Functions ---
    const escapeHTML = (str) => {
        if (typeof str !== 'string') return '';
        const el = document.createElement('div');
        el.textContent = str;
        return el.innerHTML;
    };
    const stripHtml = (html) => {
       if (!html) return "";
       const tmp = document.createElement("DIV");
       tmp.innerHTML = html;
       return tmp.textContent || tmp.innerText || "";
    };
    const truncateText = (text, len) => {
        if (!text || text.length <= len) return text;
        return text.substring(0, len) + '...';
    }
    const showToast = (message, type = 'info', duration = 3000) => {
        const toastContainer = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast-notification toast-${type}`;
        const iconClass = type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-times-circle' : 'fa-info-circle';
        toast.innerHTML = `<i class="toast-icon fas ${iconClass}"></i> <span>${escapeHTML(message)}</span>`;
        toastContainer.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, duration);
    };

    // =================================================================================
    // SUPABASE DATA HELPERS
    // =================================================================================

    const Auth = {
        async getCurrentUserProfile() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session || !session.user) { window.location.href = 'login.html'; return null; }
            const { data: profile, error } = await supabase.from('users').select('*').eq('id', session.user.id).single();
            if (error && error.code !== 'PGRST116') {
                console.error("DB error fetching user profile:", error);
                await supabase.auth.signOut();
                window.location.href = "login.html";
                return null;
            }
            if (!profile) {
                console.warn(`Profile for user ${session.user.id} not found. Creating one.`);
                const { data: newProfile, error: insertError } = await supabase.from('users').insert({
                    id: session.user.id,
                    email: session.user.email,
                    name: session.user.user_metadata?.full_name || session.user.email.split('@')[0],
                    role: 'viewer'
                }).select().single();
                if (insertError) {
                    console.error("Failed to create user profile:", insertError);
                    await supabase.auth.signOut();
                    window.location.href = "login.html";
                    return null;
                }
                return newProfile;
            }
            return profile;
        },
        async logout() {
            await supabase.auth.signOut();
            localStorage.clear();
            showToast('You have been logged out.', 'success');
            setTimeout(() => { window.location.href = 'login.html'; }, 1500);
        }
    };

    async function fetchScenarioBySlug(slug) {
        const { data, error } = await supabase.from('call_scenarios').select('*').eq('slug', slug).single();
        if (error) {
            console.error(`Error fetching scenario with slug ${slug}:`, error.message);
            return null;
        }
        return data;
    }

    async function logView(scenarioId) {
        if (!scenarioId || !currentUser) return;
        const key = `viewed_${scenarioId}`;
        const twelveHours = 12 * 60 * 60 * 1000;
        const lastViewed = localStorage.getItem(key);
        if (!lastViewed || Date.now() - Number(lastViewed) > twelveHours) {
            const { error } = await supabase.from("views_log").insert({
                scenario_id: scenarioId,
                user_id: currentUser.id,
                user_email: currentUser.email
            });
            if (error) {
                console.error("Error logging view:", error);
            } else {
                localStorage.setItem(key, Date.now().toString());
            }
        }
    }

    async function getViewsCount(scenarioId) {
        const { count, error } = await supabase.from('views_log').select('*', { count: 'exact', head: true }).eq('scenario_id', scenarioId);
        return error ? 0 : count;
    }
    
    async function fetchComments(scenarioId) {
        const { data, error } = await supabase.from('kb_comments').select('*').eq('item_id', scenarioId).order('created_at', { ascending: true });
        return error ? [] : data;
    }

    async function postComment(scenarioId, body, parentId = null) {
        if (!currentUser) { showToast('You must be logged in to comment.', 'error'); return; }
        const { error } = await supabase.from('kb_comments').insert({
            item_id: scenarioId,
            parent_id: parentId,
            author_id: currentUser.id,
            author_name: currentUser.name || currentUser.email,
            body: body
        });
        if (error) {
            showToast('Failed to post comment.', 'error');
            console.error(error);
        } else {
            showToast('Comment posted!', 'success');
            // Refresh the view
            displayItemDetail(appData.currentOpenScenario.sectionId, appData.currentOpenScenario.slug);
        }
    }

    async function submitFeedback(scenarioId, isHelpful, reason = null) {
        if (!currentUser) return;
        const { error } = await supabase.from('kb_feedback').insert({
            scenario_id: scenarioId,
            user_id: currentUser.id,
            is_helpful: isHelpful,
            reason: reason
        });
        if (error) {
            showToast('Failed to submit feedback.', 'error');
        } else {
            showToast('Thank you for your feedback!', 'success');
        }
    }

    async function uploadImageToSupabase(file) {
        if (!file) return null;
        const fileName = `public/${currentUser.id}/${Date.now()}_${file.name}`;
        // BUCKET NAME: Make sure 'kb-images' exists and is public in your Supabase project.
        const { data, error } = await supabase.storage.from('kb-images').upload(fileName, file);
        if (error) {
            showToast(`Image upload failed: ${error.message}`, 'error');
            return null;
        }
        const { data: { publicUrl } } = supabase.storage.from('kb-images').getPublicUrl(data.path);
        return publicUrl;
    }

    function quillImageHandler() {
        const input = document.createElement('input');
        input.setAttribute('type', 'file');
        input.setAttribute('accept', 'image/*');
        input.click();
        input.onchange = async () => {
            const file = input.files[0];
            if (file) {
                const loadingToast = showToast('Uploading image...', 'info', 10000);
                const url = await uploadImageToSupabase(file);
                if (url) {
                    const range = this.quill.getSelection(true);
                    this.quill.insertEmbed(range.index, 'image', url);
                    this.quill.setSelection(range.index + 1);
                    showToast('Image uploaded successfully!', 'success');
                }
            }
        };
    }

    // --- Sidebar and Navigation ---
    function populateSidebar() {
        let menuHTML = '';
        const mainSections = ['home'];
        const knowledgeAreas = appData.sections.filter(s => s.id !== 'home');

        menuHTML += `<div class="sidebar-section-title">MAIN</div>`;
        appData.sections.filter(s => mainSections.includes(s.id)).forEach(section => {
            menuHTML += `<a href="#${section.id}" class="sidebar-link" data-section="${section.id}"><i class="${section.icon}" style="color: ${section.color};"></i>${escapeHTML(section.name)}</a>`;
        });
        
        menuHTML += `<div class="sidebar-section-title">KNOWLEDGE AREAS</div>`;
        knowledgeAreas.forEach(section => {
            const itemsInSection = appData.scenarios.filter(s => s.slug.startsWith(section.slug_prefix));
            if (itemsInSection.length > 0) {
                 menuHTML += `<a href="#${section.id}" class="sidebar-link" data-section="${section.id}"><i class="${section.icon}" style="color: ${section.color};"></i>${escapeHTML(section.name)}</a>`;
            }
        });
        navigationMenu.innerHTML = menuHTML;
    }

    function highlightSidebarLink(sectionId) {
        document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
        const activeLink = document.querySelector(`.sidebar-link[data-section="${sectionId}"]`);
        if (activeLink) activeLink.classList.add('active');
    }

    // --- Content Display ---
    function renderItemCard(item, section) {
        const itemIconClass = section.icon || 'fas fa-project-diagram';
        const ctaLink = `#${section.id}/${item.slug}`;
        return `
        <a href="${ctaLink}" class="card" style="text-decoration: none;" data-item-id="${item.id}" data-item-slug="${item.slug}">
            <div class="card-header-icon">
                <div class="card-icon-container" style="background-color: ${section.color || 'var(--primary-color)'};">
                    <i class="${itemIconClass}" style="color: var(--text-color-inverted);"></i>
                </div>
                <h3>${escapeHTML(item.title)}</h3>
            </div>
            <p>${escapeHTML(truncateText(stripHtml(item.summary), 120))}</p>
            ${item.tags && item.tags.length > 0 ? `<div class="card-tags">${item.tags.map(tag => `<span>${escapeHTML(tag)}</span>`).join('')}</div>` : ''}
            <div class="item-meta-info">
                <span class="item-type-badge">Interactive Flow</span>
                <span class="item-cta-link">View Details <i class="fas fa-arrow-right"></i></span>
            </div>
        </a>`;
    }

    async function displayDashboard() {
        appData.currentOpenScenario = null;
        dashboardOverviewContainer.classList.remove('hidden');
        standardSectionContentPlaceholder.classList.add('hidden');
        itemDetailViewPlaceholder.classList.add('hidden');
        currentSectionTitleEl.textContent = 'Dashboard';
        breadcrumbsContainer.innerHTML = `<span style="font-weight: bold; color: var(--primary-color);">Home</span>`;

        if (!currentUser || currentUser.role !== 'admin') {
            dashboardOverviewContainer.innerHTML = `<div class="viewer-dashboard-message"><div class="card"><i class="fas fa-user-shield"></i><h2>Access Restricted</h2><p>The dashboard overview is available for administrators only.</p></div></div>`;
            return;
        }

        const [scenariosCount, viewsCount, commentsCount, feedbackCount] = await Promise.all([
            supabase.from('call_scenarios').select('*', { count: 'exact', head: true }),
            supabase.from('views_log').select('*', { count: 'exact', head: true }),
            supabase.from('kb_comments').select('*', { count: 'exact', head: true }),
            supabase.from('kb_feedback').select('*', { count: 'exact', head: true })
        ]);
        
        dashboardOverviewContainer.innerHTML = `
             <div class="cards-grid md:grid-cols-2 lg:grid-cols-4 my-6">
                <div class="dashboard-stat-card"><i class="fas fa-project-diagram"></i><span class="stat-value">${scenariosCount.count || 0}</span><span class="stat-label">Total Scenarios</span></div>
                <div class="dashboard-stat-card"><i class="fas fa-eye"></i><span class="stat-value">${viewsCount.count || 0}</span><span class="stat-label">Total Views</span></div>
                <div class="dashboard-stat-card"><i class="fas fa-comments"></i><span class="stat-value">${commentsCount.count || 0}</span><span class="stat-label">Total Comments</span></div>
                <div class="dashboard-stat-card"><i class="fas fa-flag"></i><span class="stat-value">${feedbackCount.count || 0}</span><span class="stat-label">Total Feedbacks</span></div>
            </div>
        `;
    }
    
    function displaySectionContent(sectionId) {
        appData.currentOpenScenario = null;
        dashboardOverviewContainer.classList.add('hidden');
        standardSectionContentPlaceholder.classList.remove('hidden');
        itemDetailViewPlaceholder.classList.add('hidden');

        const section = appData.sections.find(s => s.id === sectionId);
        if (!section) {
            standardSectionContentPlaceholder.innerHTML = `<div class="card"><h2 style="color: red;">Section not found.</h2></div>`;
            return;
        }
        
        currentSectionTitleEl.textContent = section.name;
        breadcrumbsContainer.innerHTML = `<a href="#home">Home</a> <span style="margin: 0 5px;">›</span> <span style="font-weight: bold; color: var(--primary-color);">${escapeHTML(section.name)}</span>`;
        
        const itemsToDisplay = appData.scenarios.filter(s => s.slug.startsWith(section.slug_prefix));

        let contentHTML = `<div>`;
        if (currentUser.role === 'admin') {
            contentHTML += `<div style="text-align: right; margin-bottom: 1.5rem;"><button id="openAddContentBtnInSection" class="button" data-section-id="${section.id}"><i class="fas fa-plus-circle"></i> Add Content to ${escapeHTML(section.name)}</button></div>`;
        }

        if (itemsToDisplay.length > 0) {
            contentHTML += `<div class="cards-grid">`;
            itemsToDisplay.forEach(item => contentHTML += renderItemCard(item, section));
            contentHTML += `</div>`;
        } else {
            contentHTML += `<div class="card" style="text-align: center; padding: 40px 20px;"><p style="font-size: 1.2rem; color: var(--text-color-muted);">No content in this section yet.</p></div>`;
        }
        contentHTML += `</div>`;
        standardSectionContentPlaceholder.innerHTML = contentHTML;
    }

    async function displayItemDetail(sectionId, itemSlug) {
        const scenarioData = await fetchScenarioBySlug(itemSlug);
        if (!scenarioData) {
            showToast('Error: Could not load scenario.', 'error');
            window.location.hash = '#home';
            return;
        }

        // Add sectionId to the object for context
        scenarioData.sectionId = sectionId;
        appData.currentOpenScenario = scenarioData;
        await logView(scenarioData.id);

        dashboardOverviewContainer.classList.add('hidden');
        standardSectionContentPlaceholder.classList.add('hidden');
        itemDetailViewPlaceholder.classList.remove('hidden');

        const [comments, viewsCount] = await Promise.all([
            fetchComments(scenarioData.id),
            getViewsCount(scenarioData.id)
        ]);
        
        const section = appData.sections.find(s => s.id === sectionId);
        breadcrumbsContainer.innerHTML = `<a href="#home">Home</a>›<a href="#${sectionId}">${escapeHTML(section.name)}</a>›<span style="font-weight:bold;color:var(--primary-color);">${escapeHTML(scenarioData.title)}</span>`;
        currentSectionTitleEl.textContent = scenarioData.title;

        itemDetailViewPlaceholder.innerHTML = `
            <div class="interactive-flow-container" data-scenario-id="${scenarioData.id}" data-scenario-slug="${scenarioData.slug}">
                <div class="flow-title-bar">
                    <h2><i class="${section.icon}"></i> ${escapeHTML(scenarioData.title)}</h2>
                    ${currentUser.role === 'admin' ? `<div id="flowTopActions"><button id="editFlowContentBtn" class="button button-secondary"><i class="fas fa-edit"></i> Edit Flow</button></div>` : ''}
                </div>
                <div class="flow-controls">
                    <button class="expand-all-steps-btn button button-secondary"><i class="fas fa-expand-arrows-alt"></i> Expand All</button>
                    <button class="collapse-all-steps-btn button button-secondary"><i class="fas fa-compress-arrows-alt"></i> Collapse All</button>
                </div>
                <div class="flow-steps-area">${renderFlowSteps(scenarioData.content)}</div>
            </div>
            <div class="item-actions-bar">
                <button id="printItemBtn" class="button button-secondary"><i class="fas fa-print"></i> Print</button>
                <button id="downloadPdfItemBtn" class="button button-secondary"><i class="fas fa-file-pdf"></i> Download PDF</button>
            </div>
            <div class="item-feedback-section card">
                <h4>Rate this Content</h4>
                <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1rem;">
                    <div class="rating-buttons">
                        <button class="rate-up-btn"><i class="fas fa-thumbs-up"></i> Helpful</button>
                        <button class="rate-down-btn"><i class="fas fa-thumbs-down"></i> Not Helpful</button>
                    </div>
                    <span class="read-stats">(Total Reads: ${viewsCount})</span>
                </div>
                <button class="report-feedback-btn button button-secondary"><i class="fas fa-flag"></i> Report General Feedback</button>
            </div>
            <div class="comments-section card">
                <h4><i class="fas fa-comments"></i> Comments & Discussion</h4>
                <div class="comment-display-area">${renderCommentsSection(buildCommentTree(comments))}</div>
                <div class="comment-form" data-parent-id="">
                    <textarea id="newCommentText" placeholder="Add a new comment..."></textarea>
                    <button id="postCommentBtn" class="button"><i class="fas fa-paper-plane"></i> Post Comment</button>
                </div>
            </div>
        `;
    }
    
    function buildCommentTree(comments, parentId = null) {
        return comments
            .filter(comment => comment.parent_id === parentId)
            .map(comment => ({ ...comment, replies: buildCommentTree(comments, comment.id) }));
    }

    function renderComment(comment) {
        return `
        <div class="comment" data-comment-id="${comment.id}">
            <div class="comment-author">
                ${escapeHTML(comment.author_name)}
                <span class="comment-timestamp">${new Date(comment.created_at).toLocaleString()}</span>
            </div>
            <div class="comment-text">${escapeHTML(comment.body)}</div>
            <div class="comment-actions"><span class="reply-btn">Reply</span></div>
            <div class="comment-replies">${comment.replies.map(renderComment).join('')}</div>
            <div class="comment-form hidden" data-parent-id="${comment.id}">
                <textarea placeholder="Write a reply..."></textarea>
                <button class="button post-reply-btn">Post Reply</button>
                <button type="button" class="button-secondary cancel-reply-btn">Cancel</button>
            </div>
        </div>`;
    }

    function renderCommentsSection(commentsTree) {
        if (!commentsTree || commentsTree.length === 0) {
            return `<p style="color:var(--text-color-muted);">No comments yet.</p>`;
        }
        return commentsTree.map(renderComment).join('');
    }

    function renderFlowSteps(contentHTML) {
        if (!contentHTML) return '<p>No steps defined for this flow.</p>';
        const parser = new DOMParser();
        const doc = parser.parseFromString(contentHTML, 'text/html');
        const steps = Array.from(doc.body.children);
        
        return steps.map((stepNode, index) => {
            const stepId = stepNode.id || `step_${index}`;
            const titleNode = stepNode.querySelector('strong, h3, h4');
            const stepTitle = titleNode ? titleNode.textContent.trim() : `Step ${index + 1}`;
            if(titleNode) titleNode.remove(); // Remove title from body to avoid duplication
            
            return `
            <div class="step-card" id="${stepId}">
                <div class="step-header">
                    <div class="step-header-main">
                        <span class="step-number">Step ${index + 1}:</span>
                        <span class="step-title">${escapeHTML(stepTitle)}</span>
                    </div>
                    <div class="step-header-actions">
                         <button class="toggle-step-details-btn"><i class="fas fa-chevron-down"></i></button>
                    </div>
                </div>
                <div class="step-body"><div class="kb-content">${stepNode.innerHTML}</div></div>
            </div>`;
        }).join('');
    }
    
    // --- Routing and Initialization ---
    async function handleNavigation() {
        if (!currentUser || !appData.scenarios) { return; }
        const hash = window.location.hash.substring(1) || 'home';
        const [sectionId, itemSlug] = hash.split('/');
        
        highlightSidebarLink(sectionId);

        if (sectionId === 'home') {
            await displayDashboard();
        } else if (itemSlug) {
            await displayItemDetail(sectionId, itemSlug);
        } else {
            displaySectionContent(sectionId);
        }
        document.getElementById('contentWrapper')?.scrollTo(0, 0);
    }
    
    async function initializeApp() {
        currentUser = await Auth.getCurrentUserProfile(); 
        if (!currentUser) { return; }

        appData.scenarios = await supabase.from('call_scenarios').select('*').then(res => res.data || []);

        const displayName = currentUser.name || currentUser.email; 
        userNameDisplayHeader.textContent = displayName;
        userAvatar.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName.split(' ').join('+'))}&size=36&background=6366f1&color=fff&rounded=true&font-size=0.5`;
        footerKbVersion.textContent = appData.meta.version;
        currentUserRoleSpan.textContent = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
        
        populateSidebar();
        handleNavigation();

        window.addEventListener('hashchange', handleNavigation);
        
        if (localStorage.getItem('justLoggedIn') === 'true') {
            showToast(`Welcome, ${displayName}!`, 'success', 4000);
            localStorage.removeItem('justLoggedIn');
        }
        console.log(`InfiniBase v${appData.meta.version} initialized for ${displayName}.`);
    }

    // --- Global Event Listeners using Delegation ---
    document.addEventListener('click', async (e) => {
        // --- Modals ---
        if (e.target.closest('[data-close-modal]')) {
            e.target.closest('.modal-overlay').classList.add('hidden');
        }
        if (e.target.closest('.modal-header .close-button')) {
             e.target.closest('.modal-overlay').classList.add('hidden');
        }

        // --- Sidebar ---
        if (e.target.closest('#mobileSidebarToggle')) {
            sidebar.classList.toggle('closed');
        }
        if (e.target.closest('.sidebar-link') && window.innerWidth < 768) {
            sidebar.classList.add('closed');
        }

        // --- Logout ---
        if (e.target.closest('#logoutButton')) {
            document.getElementById('logoutConfirmModalOverlay').classList.remove('hidden');
        }
        if (e.target.closest('#confirmLogoutBtn')) {
            await Auth.logout();
        }

        // --- Add/Edit Content ---
        if (e.target.closest('#openAddContentBtnInSection')) {
            // Logic to open add/edit modal (simplified for brevity)
            document.getElementById('addContentModalOverlay').classList.remove('hidden');
            document.getElementById('templateSelectionContainer').classList.remove('hidden');
            document.getElementById('addContentForm').classList.add('hidden');
        }
        if (e.target.closest('#closeAddContentModalBtn, #cancelAddContentBtn')) {
            document.getElementById('addContentModalOverlay').classList.add('hidden');
        }
        
        // --- Detail View Actions ---
        const detailView = e.target.closest('#itemDetailViewPlaceholder');
        if (detailView) {
            const scenario = appData.currentOpenScenario;
            if (!scenario) return;

            // Step Expand/Collapse
            const stepHeader = e.target.closest('.step-header');
            if (stepHeader && !e.target.closest('button, a')) {
                stepHeader.parentElement.classList.toggle('expanded');
            }
            if (e.target.closest('.toggle-step-details-btn')) {
                 e.target.closest('.step-card').classList.toggle('expanded');
            }
            if(e.target.closest('.expand-all-steps-btn')) {
                detailView.querySelectorAll('.step-card:not(.expanded)').forEach(c => c.classList.add('expanded'));
            }
            if(e.target.closest('.collapse-all-steps-btn')) {
                detailView.querySelectorAll('.step-card.expanded').forEach(c => c.classList.remove('expanded'));
            }
            
            // Feedback/Rating
            if (e.target.closest('.rate-up-btn')) {
                await submitFeedback(scenario.id, true);
            }
            if (e.target.closest('.rate-down-btn')) {
                document.getElementById('notHelpfulModalOverlay').classList.remove('hidden');
                document.getElementById('notHelpfulReason').focus();
            }
             if (e.target.closest('.report-feedback-btn')) {
                document.getElementById('feedbackItemId').value = scenario.id;
                document.getElementById('feedbackItemTitleDisplay').textContent = scenario.title;
                document.getElementById('reportFeedbackModalOverlay').classList.remove('hidden');
            }

            // Comments
            if (e.target.closest('#postCommentBtn')) {
                const text = detailView.querySelector('#newCommentText').value.trim();
                if (text) await postComment(scenario.id, text);
            }
            if (e.target.closest('.reply-btn')) {
                const commentNode = e.target.closest('.comment');
                commentNode.querySelector('.comment-form').classList.toggle('hidden');
            }
            if (e.target.closest('.cancel-reply-btn')) {
                 e.target.closest('.comment-form').classList.add('hidden');
            }
            if (e.target.closest('.post-reply-btn')) {
                const form = e.target.closest('.comment-form');
                const text = form.querySelector('textarea').value.trim();
                const parentId = form.dataset.parentId;
                if (text && parentId) await postComment(scenario.id, text, parentId);
            }
            
            // Print/PDF
            if (e.target.closest('#printItemBtn')) window.print();
            if (e.target.closest('#downloadPdfItemBtn')) {
                // Simplified PDF download, can be enhanced
                showToast('Preparing PDF...', 'info');
                html2pdf().from(detailView).save(`${scenario.slug}.pdf`);
            }
        }
    });

    // --- Forms Submission ---
    document.getElementById('notHelpfulForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const reason = e.target.querySelector('#notHelpfulReason').value.trim();
        const scenario = appData.currentOpenScenario;
        if (reason && scenario) {
            await submitFeedback(scenario.id, false, reason);
            e.target.closest('.modal-overlay').classList.add('hidden');
            e.target.reset();
        }
    });

    document.getElementById('reportFeedbackForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const scenarioId = e.target.querySelector('#feedbackItemId').value;
        const comment = e.target.querySelector('#feedbackComment').value.trim();
        if (comment && scenarioId) {
            // Submitting general feedback as a comment for now.
            await postComment(scenarioId, `[General Feedback]: ${comment}`);
            e.target.closest('.modal-overlay').classList.add('hidden');
            e.target.reset();
        }
    });

    // Initialize Quill & Start App
    mainQuillEditor = new Quill('#quillEditor', {
        theme: 'snow',
        modules: {
            toolbar: {
                container: [
                    [{ 'header': [1, 2, 3, false] }], ['bold', 'italic', 'underline', 'strike'],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    ['link', 'image', 'blockquote', 'code-block'], ['clean']
                ],
                handlers: { 'image': quillImageHandler }
            }
        }
    });
    
    initializeApp();

</script>
</body>
</html>
