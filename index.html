<!DOCTYPE html>
<html lang="en" dir="ltr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InfiniBase - Knowledge Base</title>
    <!-- Updated Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32' width='32' height='32'><rect width='32' height='32' rx='4' fill='%236366f1'/><text x='50%' y='55%' dominant-baseline='middle' text-anchor='middle' font-family='Arial, sans-serif' font-size='18' font-weight='bold' fill='white'>IB</text></svg>">
    
    <!-- CDNs -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>


    <style>
        :root {
            /* Permanent Dark Theme Variables */
            --primary-color: #6366f1; /* Brighter Indigo for dark */
            --primary-color-hover: #4f46e5;
            --secondary-color: #9ca3af;

            --text-color: #d1d5db;
            --text-color-muted: #9ca3af;
            --text-color-inverted: #ffffff; 
            --text-color-subtle: #9ca3af;

            --bg-color: #111827; /* Dark gray */
            --bg-color-alt: #1f2937; /* Slightly lighter dark gray for cards/modals */
            --bg-color-sidebar: #1f2937;
            --bg-color-header: rgba(31, 41, 55, 0.9);
            --bg-color-modal: #1f2937;
            --bg-color-hover: #374151;
            --bg-color-active: var(--primary-color);

            --border-color: #374151;
            --border-color-darker: #4b5563;

            --card-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            --card-hover-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            
            --border-radius: 0.5rem; 
            --border-radius-lg: 0.75rem;
            --header-height: 70px;
            --sidebar-width: 260px;

            --yes-color: #22c55e; /* Green for Yes */
            --no-color: #ef4444;   /* Red for No */
            --rating-color: #fbbf24; /* Amber 400 for ratings */
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            line-height: 1.6;
            font-size: 16px;
        }

        a { text-decoration-skip-ink: none; }

        .container-fluid {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-color-sidebar);
            padding: 1.5rem;
            border-right: 1px solid var(--border-color); /* LTR */
            position: fixed;
            top: 0;
            left: 0; /* LTR */
            height: 100vh;
            overflow-y: auto;
            transition: transform 0.3s ease-in-out, background-color 0.3s ease, border-color 0.3s ease;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }
        .sidebar.closed {
            transform: translateX(-100%); /* LTR */
        }
        @media (min-width: 768px) {
            .sidebar.closed { transform: translateX(0); }
        }

        .sidebar-header {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            color: var(--text-color); 
        }
        .sidebar-header i { 
            margin-right: 0.75rem; /* LTR */
            color: var(--primary-color);
            font-size: 1.8rem;
        }
        .sidebar-logo-text {
             color: var(--text-color);
        }

        .sidebar-nav { flex-grow: 1; }

        .sidebar-section-title {
            padding-left: 0.75rem; /* LTR */
            font-size: 0.75rem;
            font-weight: 700; /* Increased font-weight for better visibility */
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--text-color-muted);
        }

        .sidebar-link {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-radius: var(--border-radius);
            transition: background-color 0.2s ease, color 0.2s ease;
            font-weight: 500;
            color: var(--text-color-subtle);
            text-decoration: none;
            margin-bottom: 0.25rem;
        }
        .sidebar-link i {
            margin-right: 0.75rem; /* LTR */
            width: 1.5rem; /* Adjusted for font-size */
            font-size: 1.5rem; /* Increased icon size */
            text-align: center;
            transition: color 0.2s ease;
        }
        .sidebar-link:hover {
            background-color: var(--bg-color-hover);
            color: var(--text-color);
        }
        .sidebar-link.active {
            background-color: var(--bg-color-active); /* Primary color */
            color: var(--text-color-inverted) !important; /* White text */
            font-weight: 600;
        }
        .sidebar-link.active i {
            color: var(--text-color-inverted) !important; /* White icon on primary background */
        }

        .sidebar-footer {
            margin-top: auto; 
            padding-top: 1rem;
        }
        .sidebar-footer button {
            width: 100%;
            margin-top: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sidebar-footer button i { margin-right: 0.5rem; }


        .content-wrapper {
            flex-grow: 1;
            padding-right: 1.5rem; /* LTR */
            padding-left: 1.5rem;
            transition: margin-left 0.3s ease-in-out; /* LTR */
            height: 100vh;
            overflow-y: auto;
        }
        @media (min-width: 768px) {
             .content-wrapper { margin-left: var(--sidebar-width); /* LTR */ }
             .sidebar.closed + .content-wrapper { margin-left: 0; /* LTR */ }
        }

        .content-header {
            background-color: var(--bg-color-header);
            padding: 1.25rem 2rem; 
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky; 
            top: 0;
            left: var(--sidebar-width); /* LTR, adjusted for fixed sidebar */
            right: 0;
            height: var(--header-height);
            z-index: 50;
            backdrop-filter: blur(8px); 
        }
         @media (max-width: 767px) { /* Mobile: header spans full width */
            .content-header {
                left: 0;
            }
        }
        .header-left-content { display: flex; align-items: center; } 
        #currentSectionTitle {
            font-size: 1.5rem; 
            font-weight: bold;
            margin: 0;
        }
        #breadcrumbs {
            font-size: 0.875rem; 
            color: var(--text-color-muted);
            margin-top: 0.25rem;
        }
        #breadcrumbs a { color: var(--primary-color); text-decoration: none; }
        #breadcrumbs a:hover { text-decoration: underline; }

        .header-right-content { display: flex; align-items: center; gap: 1rem; }
        .search-container { position: relative; }
        .search-container input[type="search"] {
            padding: 0.625rem 1rem 0.625rem 2.5rem; /* py-2.5 pl-10 pr-4 for LTR */
            border: 1px solid var(--border-color-darker);
            border-radius: 9999px; 
            min-width: 250px; 
            background-color: var(--bg-color-alt); 
            color: var(--text-color);
        }
        .search-container input[type="search"]::placeholder {
            color: var(--text-color-muted);
            opacity: 0.8;
        }
        .search-container .search-icon {
            position: absolute;
            inset-inline-start: 0.75rem; 
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-color-muted);
        }
        #searchResultsContainer {
            position: absolute;
            background-color: var(--bg-color-alt);
            border: 1px solid var(--border-color);
            border-top: none;
            width: 100%; 
            max-height: 300px; 
            overflow-y: auto;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); 
            z-index: 60; 
            border-radius: 0 0 var(--border-radius) var(--border-radius);
        }
        #searchResultsContainer a {
            display: block;
            padding: 0.75rem; 
            text-decoration: none;
            color: var(--text-color);
        }
        #searchResultsContainer a:hover { background-color: var(--bg-color-hover); }
        #searchResultsContainer mark { background-color: #78350f; color: #f3f4f6; }


        .user-profile { display: flex; align-items: center; gap: 0.5rem; }
        .user-profile img { width: 36px; height: 36px; border-radius: 50%; }
        #userNameDisplayHeader { font-weight: 500; }
        @media (max-width: 640px) { 
            #userNameDisplayHeader { display: none; }
        }

        main { padding: 1.5rem 0; }

        .card {
            background-color: var(--bg-color-alt);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg); 
            padding: 1.5rem;
            margin-bottom: 1.5rem; 
            box-shadow: var(--card-shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease, border-color 0.3s ease;
            display: flex;
            flex-direction: column; 
            min-height: 150px; 
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--card-hover-shadow);
        }
        .card-header-icon {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .card-icon-container {
            padding: 0.75rem;
            border-radius: 50%;
            margin-right: 1rem; /* LTR */
            background-color: var(--primary-color-hover); 
        }
        .card-icon-container i {
            font-size: 1.25rem;
            color: var(--text-color-inverted);  
        }
        .card-title-group {
            flex-grow: 1;
        }
        .card h3 { margin-top: 0; font-size: 1.125rem; font-weight: 600; color: var(--text-color); line-height: 1.3; }
        .card p { margin-bottom: 1rem; font-size: 0.875rem; color: var(--text-color-subtle); flex-grow: 1; }
        
        /* NEW: Updated Badge Style */
        .updated-badge {
            display: inline-block;
            background-color: rgba(34, 197, 94, 0.15); /* Green with transparency */
            border: 1px solid rgba(34, 197, 94, 0.4);
            color: #22c55e;
            padding: 0.15rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            margin-top: 0.4rem;
        }

        /* NEW: Tag styles for cards */
        .card-tags {
            margin-top: 0rem;
            margin-bottom: 0.75rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .card-tags .tag {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            color: var(--text-color-muted);
            padding: 0.2rem 0.6rem;
            border-radius: 9999px;
            font-size: 0.7rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }

        .card-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
            margin-top: auto;
        }
        .card-actions .button {
            padding: 0.5rem 0.75rem;
            font-size: 0.8rem;
        }
        
        .button, button {
            background-color: var(--primary-color);
            color: var(--text-color-inverted);
            border: 1px solid transparent;
            padding: 0.625rem 1rem; 
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.875rem; 
            font-weight: 500; 
            transition: background-color 0.2s, border-color 0.2s, color 0.2s;
            text-decoration: none; 
            display: inline-flex; 
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .button:hover, button:hover {
            background-color: var(--primary-color-hover);
        }
        .button-secondary {
            background-color: transparent;
            color: var(--text-color-subtle);
            border-color: var(--border-color-darker);
        }
        .button-secondary:hover { background-color: var(--bg-color-hover); color: var(--text-color); }
        .button-danger {
            background-color: #dc2626; 
            color: var(--text-color-inverted);
        }
        .button-danger:hover { background-color: #b91c1c; }
        input:focus, button:focus, select:focus, textarea:focus, a:focus { 
            outline: 2px solid transparent;
            outline-offset: 2px;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.6); 
        }
        button:disabled {
            background-color: var(--border-color);
            color: var(--text-color-muted);
            cursor: not-allowed;
            border-color: transparent;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.75); 
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.2s ease-out;
        }
        .modal-overlay:not(.hidden) { opacity: 1; }
        .modal-content {
            background-color: var(--bg-color-modal);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 48rem; 
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.95);
            opacity: 0;
            transition: transform 0.2s ease-out, opacity 0.2s ease-out, background-color 0.3s ease, border-color 0.3s ease;
        }
        .modal-overlay:not(.hidden) .modal-content { transform: scale(1); opacity: 1; }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem; 
        }
        .modal-header h2 { margin-top: 0; font-size: 1.5rem; font-weight: 700; }
        .modal-header .close-button { 
            background: none; border: none; font-size: 1.5rem; color: var(--text-color-muted); cursor: pointer;
            padding: 0.25rem; line-height: 1; border-radius: 50%;
        }
        .modal-header .close-button:hover { background-color: var(--bg-color-hover); }
        
        .modal-body { /* For modals with just text content like confirm */
            padding-bottom: 1rem;
            font-size: 1rem;
            color: var(--text-color);
        }

        .modal-actions {
            margin-top: 1.5rem; 
            text-align: right; /* LTR */
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end; /* LTR */
            gap: 0.75rem; 
        }
         .modal-actions.no-border {
            border-top: none;
            padding-top: 0;
        }


        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.25rem; font-weight: 500; font-size: 0.875rem; }
        .form-group input[type="text"],
        .form-group input[type="url"],
        .form-group input[type="email"], /* Added for feedback modal */
        .form-group input[type="file"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.625rem; 
            border: 1px solid var(--border-color-darker); 
            border-radius: var(--border-radius);
            box-sizing: border-box;
            background-color: var(--bg-color); 
            color: var(--text-color);
        }
        .form-group textarea { min-height: 100px; }
        
        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: var(--text-color-muted);
            opacity: 0.8; /* Ensure it's not too faint */
        }
        
        /* Styles for Add Content Template Selection */
        #templateSelectionContainer { margin-bottom: 1.5rem; }
        #templateSelectionContainer h3 { font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-color); }
        .template-buttons-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .template-button {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color-darker);
            color: var(--text-color-subtle);
            padding: 1rem;
            border-radius: var(--border-radius);
            text-align: left; /* Maintained */
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex; /* Added for flex alignment */
            flex-direction: column; /* Stack items vertically */
            align-items: flex-start; /* Align items to the start (left) */
        }
        .template-button:hover {
            border-color: var(--primary-color);
            background-color: var(--bg-color-hover);
            color: var(--text-color);
        }
        .template-button i { 
            font-size: 1.5rem; 
            margin-bottom: 0.75rem; /* Increased margin */
            display: block; 
            color: var(--primary-color); 
            width: 100%; /* Ensure icon container takes width for alignment if needed */
            text-align: left; /* Ensure icon itself is left-aligned */
        }
        .template-button h4 { 
            font-size: 1rem; 
            font-weight: 600; 
            margin-bottom: 0.5rem; /* Increased margin */
        }
        .template-button p { 
            font-size: 0.8rem; 
            line-height: 1.4; 
            color: var(--text-color-muted); /* Consistent with other paragraph text */
        }


        .ql-toolbar {
            background: var(--bg-color);
            border-color: var(--border-color-darker) !important;
            border-top-left-radius: var(--border-radius);
            border-top-right-radius: var(--border-radius);
        }
        .ql-toolbar .ql-stroke { stroke: var(--text-color-muted); }
        .ql-toolbar .ql-fill { fill: var(--text-color-muted); }
        .ql-toolbar .ql-picker-label { color: var(--text-color-muted); }
        .ql-snow .ql-picker.ql-expanded .ql-picker-options { background-color: var(--bg-color-alt); border-color: var(--border-color-darker); }
        .ql-snow .ql-picker-options .ql-picker-item:hover { color: var(--primary-color); }


        .ql-container {
            background: var(--bg-color-alt);
            border-color: var(--border-color-darker) !important;
            color: var(--text-color);
            min-height: 150px; 
            border-bottom-left-radius: var(--border-radius);
            border-bottom-right-radius: var(--border-radius);
            font-size: 1rem;
        }
        .ql-editor { padding: 12px; }
        .ql-editor.ql-blank::before {
            color: var(--text-color-muted);
            opacity: 0.6;
        }


        footer {
            text-align: center;
            padding: 1.5rem;
            font-size: 0.875rem;
            color: var(--text-color-muted);
            border-top: 1px solid var(--border-color);
            margin-top: auto; 
        }

        .mobile-sidebar-toggle {
            display: block;
            position: fixed;
            top: calc((var(--header-height) - 40px) / 2); 
            left: 1.5rem; /* LTR */
            z-index: 101; 
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 0.75rem; 
            border-radius: var(--border-radius);
            font-size: 1.25rem; 
            line-height: 1;
        }
        @media (min-width: 768px) {
            .mobile-sidebar-toggle { display: none; }
            .header-left-content #currentSectionTitle { margin-left: 0; } /* No toggle on desktop */
        }
        @media (max-width: 767px) {
            .header-left-content #currentSectionTitle { margin-left: 0.5rem; } /* Space for toggle */
            .content-header { padding: 1rem; }
            .header-right-content .search-container { display:none; } 
        }

        .toast-notification {
            position: fixed;
            bottom: 20px;
            right: 20px; /* LTR */
            padding: 12px 18px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 2000; 
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            display: flex;
            align-items: center;
            background-color: var(--bg-color-alt); 
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }
        .toast-notification.show { opacity: 1; transform: translateY(0); }
        .toast-icon { margin-right: 10px; /* LTR */ font-size: 1.2em; }
        .toast-success { background-color: #10b981; color: white; border-color: #059669; } 
        .toast-error { background-color: #ef4444; color: white; border-color: #dc2626; } 
        .toast-info { background-color: #3b82f6; color: white; border-color: #2563eb; } 

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 1.5rem; 
        }

        .kb-content h1, .kb-content h2, .kb-content h3 { margin-top: 1.5em; margin-bottom: 0.5em; color: var(--text-color); }
        .kb-content p { margin-bottom: 1em; }
        .kb-content ul, .kb-content ol { margin-bottom: 1em; padding-left: 20px; /* LTR */ }
        .kb-content li { margin-bottom: 0.5em; }
        .kb-content strong { font-weight: bold; }
        .kb-content em { font-style: italic; }
        .kb-content a { color: var(--primary-color); text-decoration: underline; }
        .kb-content pre {
            background-color: var(--bg-color);
            padding: 10px;
            border-radius: var(--border-radius);
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            border: 1px solid var(--border-color);
            color: var(--text-color); /* Ensure pre content is visible */
            position: relative; /* For copy button */
        }
        .kb-content code { /* More specific for inline code if needed */
            background-color: var(--bg-color-hover);
            padding: 0.2em 0.4em;
            margin: 0;
            font-size: 85%;
            border-radius: 3px;
        }
        .kb-content blockquote {
            background-color: var(--bg-color-hover);
            padding: 0.75rem 1rem;
            border-radius: var(--border-radius);
            margin: 1em 0;
            border-left: 4px solid var(--primary-color);
            color: var(--text-color);
            position: relative;
        }
        .kb-content blockquote i.fa-comment-dots {
            margin-right: 0.5rem;
            color: var(--primary-color);
        }
        .copy-script-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: var(--bg-color);
            color: var(--text-color-muted);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
            z-index: 1;
        }
        .copy-script-btn:hover { opacity: 1; }

        mark {
            padding: 0.1em 0.2em; border-radius: 0.2em; font-weight: bold;
            background-color: #78350f; color: #f3f4f6; 
        }

        .hidden { display: none !important; }

        .chart-container {
            position: relative;
            padding: 1rem;
            border-radius: var(--border-radius-lg);
            background-color: var(--bg-color-alt);
            height: 320px; 
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .chart-container canvas {
            max-width: 100%;
            max-height: 100%;
        }
        .chart-container h3 {
            font-size: 1.125rem; 
            font-weight: 600; 
            margin-bottom: 0.5rem;
            text-align: center;
            width: 100%;
        }
       
        /* NEW: Styles for improved knowledge article view */
        .update-banner {
            background-color: var(--bg-color);
            border: 1px solid var(--primary-color);
            color: var(--text-color);
            padding: 0.75rem 1.25rem;
            border-radius: var(--border-radius);
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .update-banner i {
            color: var(--primary-color);
            font-size: 1.2rem;
        }
        .content-section-box {
            background-color: var(--bg-color);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            margin-bottom: 1.5rem;
            border-left: 4px solid var(--primary-color);
        }
        .content-section-box h3 {
            margin-top: 0;
            margin-bottom: 0.75rem;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--text-color);
        }
        .compensation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .compensation-box {
            background-color: var(--bg-color-alt);
            border: 1px solid var(--border-color-darker);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
        }
        .compensation-box h4 {
            margin-top: 0;
            font-size: 1.1rem;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.75rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .compensation-box.fast-order h4 { color: #f59e0b; }
        .compensation-box.scheduled-order h4 { color: #38bdf8; }
        .compensation-box ul { list-style: none; padding: 0; margin: 0; }
        .compensation-box ul li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.6rem 0;
            font-size: 0.9rem;
            border-bottom: 1px solid var(--border-color);
        }
        .compensation-box ul li:last-child { border-bottom: none; }
        .compensation-box ul li span:first-child { font-weight: 500; color: var(--text-color-subtle); }
        .compensation-box ul li .action { font-weight: 600; text-align: right; }


        /* Item Detail View Specific */
        #itemDetailViewPlaceholder .item-title-area {
            display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;
        }
        #itemDetailViewPlaceholder .item-title-area i.fa-title-icon {
            font-size: 2rem; color: var(--primary-color); 
        }
        #itemDetailViewPlaceholder .item-title-area h2 { font-size: 1.8rem; margin:0; }
        #itemDetailViewPlaceholder .item-summary { color: var(--text-color-subtle); margin-bottom: 1rem; font-style: italic; }
        #itemDetailViewPlaceholder hr.title-content-divider {
             margin: 1.5rem 0; border-color: var(--border-color); 
        }
        /* MODIFIED: last-updated-info style */
        .last-updated-info {
            color: var(--yes-color); 
            font-size: 0.85rem; 
            margin-bottom: 1rem; 
            font-weight: 500;
        }
        #itemDetailViewPlaceholder .kb-content ul { list-style-type: disc; }
        #itemDetailViewPlaceholder .child-items-list { list-style-type: none; padding-left: 0; }
        #itemDetailViewPlaceholder .child-items-list li { margin-bottom: 0.5rem; }
        #itemDetailViewPlaceholder .child-items-list a { color: var(--primary-color); text-decoration: none; }
        #itemDetailViewPlaceholder .child-items-list a:hover { text-decoration: underline; }
        .item-actions-bar { display: flex; gap: 0.75rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        
        .item-feedback-section { margin-top: 2rem; padding: 1.5rem; border: 1px solid var(--border-color); border-radius: var(--border-radius-lg); background-color: var(--bg-color); }
        .item-feedback-section h4 { font-size: 1.125rem; font-weight: 600; margin-top: 0; margin-bottom: 1rem; }
        .rating-prompt { display:flex; align-items:center; gap:1rem; margin-bottom: 1rem; }
        .rating-prompt > span { font-weight: 500; }
        .rating-buttons button { background: none; border: 1px solid var(--border-color); color: var(--text-color-muted); padding: 0.5rem 0.75rem; border-radius: var(--border-radius); cursor: pointer; transition: all 0.2s; }
        .rating-buttons button:hover { border-color: var(--rating-color); color: var(--rating-color); background-color: rgba(251, 191, 36, 0.1); }
        .rating-buttons button.active, .rating-buttons button:disabled { cursor: not-allowed; opacity: 0.7; }
        .rating-buttons button.yes { border-color: var(--yes-color); color: var(--yes-color); background-color: rgba(34, 197, 94, 0.1); }
        .rating-buttons button.no { border-color: var(--no-color); color: var(--no-color); background-color: rgba(239, 68, 68, 0.1); }
        .rating-buttons button i { margin-right: 0.5rem; }
        .read-stats { font-size: 0.875rem; color: var(--text-color-muted); margin-top: 1.5rem; border-top: 1px solid var(--border-color); padding-top: 1rem; }
        #negativeFeedbackForm { margin-top: 1rem; }
        
        /* New Comments Section Style */
        .comments-section { margin-top: 2rem; }
        .comments-section h4 { font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-color); }
        .comment-post-area {
            display: flex;
            gap: 0.75rem;
            align-items: flex-start;
            margin-bottom: 1.5rem;
        }
        .comment-post-area img { width: 36px; height: 36px; border-radius: 50%; margin-top: 5px;}
        .comment-input-wrapper { flex-grow: 1; }
        .comment-input-wrapper textarea {
            width: 100%;
            min-height: 60px;
            padding: 0.75rem;
            border: 1px solid var(--border-color-darker);
            border-radius: var(--border-radius);
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        .comment-post-actions { text-align: right; margin-top: 0.5rem; }
        
        .comment-display-area { margin-top: 1rem; display: flex; flex-direction: column; gap: 1.25rem; }
        .comment { display: flex; gap: 0.75rem; align-items: flex-start; }
        .comment img { width: 32px; height: 32px; border-radius: 50%; }
        .comment-content {
            flex-grow: 1;
            background-color: var(--bg-color-alt);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 0.75rem 1rem;
        }
        .comment-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem; }
        .comment-author { font-weight: 600; color: var(--text-color); font-size: 0.9rem; }
        .comment-timestamp { color: var(--text-color-muted); font-size: 0.75rem; }
        .comment-text {
            font-size: 0.95rem;
            line-height: 1.5;
            color: var(--text-color-subtle);
            white-space: pre-wrap;
        }
        .comment-actions { margin-top: 0.5rem; }
        .comment-actions button {
            background: none;
            border: none;
            color: var(--text-color-muted);
            font-size: 0.8rem;
            font-weight: 500;
            padding: 0.25rem 0.5rem;
            cursor: pointer;
        }
        .comment-actions button:hover { color: var(--primary-color); }


        /* Dashboard specific styles */
        .dashboard-stat-card {
            background-color: var(--bg-color-alt);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--card-shadow);
            text-align: center;
        }
        .dashboard-stat-card i {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 0.75rem;
        }
        .dashboard-stat-card .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            display: block;
            margin-bottom: 0.25rem;
        }
        .dashboard-stat-card .stat-label {
            font-size: 0.875rem;
            color: var(--text-color-muted);
        }
        .dashboard-quicklink-card, .dashboard-info-card {
             background-color: var(--bg-color-alt);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--card-shadow);
        }
         .dashboard-quicklink-card h3, .dashboard-info-card h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }
        .dashboard-quicklink-card ul, .dashboard-info-card ul {
            list-style: none;
            padding: 0;
        }
        .dashboard-quicklink-card ul li a, .dashboard-info-card ul li a {
            display: block;
            padding: 0.5rem 0;
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
        }
         .dashboard-quicklink-card ul li a:hover, .dashboard-info-card ul li a:hover {
            text-decoration: underline;
        }
         .dashboard-info-card ul li {
            font-size: 0.9rem;
            color: var(--text-color-subtle);
            padding: 0.3rem 0;
         }
         .dashboard-info-card ul li strong {
            color: var(--text-color);
         }
         .dashboard-info-card ul li .meta {
            font-size: 0.75rem;
            display: block;
            color: var(--text-color-muted);
         }
         /* Viewer Dashboard Message */
        .viewer-dashboard-message .card {
            text-align: center;
            padding: 40px 20px;
            min-height: auto;
        }
        .viewer-dashboard-message .card i {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
        .viewer-dashboard-message .card h2 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--text-color);
        }
        .viewer-dashboard-message .card p {
            font-size: 1rem;
            color: var(--text-color-muted);
            margin-bottom: 0;
        }
        .viewer-dashboard-message .card p.subtle-note {
             font-size: 0.9rem;
             margin-top: 1rem;
        }

        /* Print Styles */
        @media print {
            body, .container-fluid {
                margin: 0;
                padding: 0;
                background-color: white !important;
                color: black !important;
                font-size: 12pt;
            }
            .sidebar, .content-header, .sidebar-footer, footer,
            .mobile-sidebar-toggle, #toastContainer,
            .item-actions-bar .button:not(#printItemBtn):not(#downloadPdfItemBtn),
            .item-actions-bar button[id*="edit"], .item-actions-bar button[id*="delete"], .item-actions-bar button[id*="share"],
            .item-feedback-section, .comments-section,
            .modal-overlay,
            .copy-script-btn,
            .dashboard-overview-container,
            .search-container, .user-profile,
            #openAddContentBtnInSection,
            .card-hover-details,
            .update-banner, /* Hide new banner from print */
            .last-updated-info /* Hide last updated text from print */,
            .updated-badge /* Hide updated badge from print */
            {
                display: none !important;
            }

            .content-wrapper {
                margin-left: 0 !important;
                padding: 1cm !important;
                overflow: visible !important;
                height: auto !important;
                width: 100% !important;
            }
            #pageContentArea { padding: 0 !important; }
            
            #itemDetailViewPlaceholder, #standardSectionContentPlaceholder {
                display: block !important;
            }
            .card, .content-section-box, .compensation-box {
                box-shadow: none !important;
                border: 1px solid #ccc !important;
                margin-bottom: 0.5cm !important;
                background-color: white !important;
                page-break-inside: avoid;
            }
            
            .card *, .content-section-box *, .compensation-box * {
                color: black !important;
                background-color: transparent !important;
            }
             h1, h2, h3, h4, h5, h6 { color: black !important; }

            .kb-content a {
                color: #0066cc !important;
                text-decoration: underline !important;
            }
            .kb-content a[href^="http"]::after, 
            .kb-content a[href^="https"]::after {
                content: " (" attr(href) ")";
                font-size: 0.8em;
                color: #555 !important;
                word-break: break-all;
            }
            .kb-content a[href^="#"]::after {
                content: "";
            }
        }

    </style>
</head>
<body>

    <div id="addContentModalOverlay" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="addContentModalTitle">Add New Content</h2>
                <button id="closeAddContentModalBtn" class="close-button" aria-label="Close">×</button>
            </div>

            <div id="templateSelectionContainer" class="hidden">
                <h3>Choose a Template</h3>
                <div class="template-buttons-grid">
                    <button class="template-button" data-template="standard_article">
                        <i class="fas fa-newspaper"></i>
                        <h4>Standard Article</h4>
                        <p>For general information, announcements, or detailed explanations.</p>
                    </button>
                    <button class="template-button" data-template="troubleshooting_guide">
                        <i class="fas fa-tools"></i>
                        <h4>Troubleshooting Guide / Case</h4>
                        <p>Step-by-step solutions for common issues or case documentation.</p>
                    </button>
                    <button class="template-button" data-template="policy_document">
                        <i class="fas fa-gavel"></i>
                        <h4>Policy Document</h4>
                        <p>Formal policies, procedures, or official guidelines.</p>
                    </button>
                     <button class="template-button" data-template="blank">
                        <i class="fas fa-file"></i>
                        <h4>Blank Document</h4>
                        <p>Start with a completely empty document of any type.</p>
                    </button>
                </div>
                <hr style="border-color: var(--border-color-darker); margin: 1.5rem 0;">
            </div>

            <form id="addContentForm" class="hidden">
                <input type="hidden" id="editingItemId"> <!-- For storing ID when editing -->
                <div class="form-group">
                    <label for="contentType">Content Type</label>
                    <select id="contentType">
                        <option value="article">Article</option>
                        <option value="case">Case</option>
                        <option value="form_sheet">Form/Sheet (Link)</option>
                        <option value="design">Design (Link)</option>
                        <option value="guide">Guide</option>
                        <option value="policy">Policy</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="contentTitle">Title</label>
                    <input type="text" id="contentTitle" required>
                </div>
                <div class="form-group">
                    <label for="contentSummary">Summary / Description</label>
                    <textarea id="contentSummary" rows="3" required></textarea>
                </div>
                
                <div class="form-group hidden" id="contentUrlContainer">
                    <label for="contentUrl">Link (for Forms, Designs, etc.)</label>
                    <input type="url" id="contentUrl">
                </div>

                <div class="form-group" id="contentDetailContainer">
                    <label for="contentDetail" id="contentDetailLabel">Details / Content</label>
                    <div id="quillEditor"></div> <!-- Quill editor container -->
                </div>

                <div class="form-group">
                    <label for="contentTags">Tags (comma-separated)</label>
                    <input type="text" id="contentTags" placeholder="e.g., important, update, billing">
                </div>

                <hr style="border-color: var(--border-color-darker); margin: 1.5rem 0;">
                <h3 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-color);">Attachments (Optional)</h3>
                
                <div class="form-group">
                    <label for="pdfFile">Upload PDF</label>
                    <input type="file" id="pdfFile" accept=".pdf">
                </div>
                <div class="form-group">
                    <label for="imageFile">Upload Image</label>
                    <input type="file" id="imageFile" accept="image/*">
                </div>
                <div class="form-group">
                    <label for="videoLink">Video Link (e.g., YouTube, Vimeo)</label>
                    <input type="url" id="videoLink" placeholder="https://">
                </div>
                <div class="form-group">
                    <label for="driveLink">Google Drive Link</label>
                    <input type="url" id="driveLink" placeholder="https://docs.google.com/... or https://drive.google.com/...">
                </div>


                <div class="modal-actions">
                    <button type="submit" id="saveContentBtn" class="button"><i class="fas fa-save"></i> Save Content</button>
                    <button type="button" id="cancelAddContentBtn" class="button-secondary"><i class="fas fa-times"></i> Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div id="logoutConfirmModalOverlay" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 28rem;"> <!-- Smaller modal for confirm -->
            <div class="modal-header">
                <h2 id="logoutConfirmModalTitle">Confirm Logout</h2>
                <button id="closeLogoutConfirmModalBtn" class="close-button" aria-label="Close">×</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to logout from InfiniBase?</p>
            </div>
            <div class="modal-actions no-border"> 
                <button type="button" id="confirmLogoutBtn" class="button button-danger"><i class="fas fa-sign-out-alt"></i> Confirm Logout</button>
                <button type="button" id="cancelLogoutBtn" class="button-secondary"><i class="fas fa-times"></i> Cancel</button>
            </div>
        </div>
    </div>

    <!-- Report Feedback Modal -->
    <div id="reportFeedbackModalOverlay" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 32rem;">
            <div class="modal-header">
                <h2 id="reportFeedbackModalTitle">Report Feedback</h2>
                <button id="closeReportFeedbackModalBtn" class="close-button" aria-label="Close">×</button>
            </div>
            <form id="reportFeedbackForm">
                <input type="hidden" id="feedbackItemId">
                <input type="hidden" id="feedbackItemTitle">
                <div class="modal-body" style="padding-bottom:0;">
                    <p style="margin-bottom: 1rem;">Provide your feedback for: <strong id="feedbackItemTitleDisplay"></strong></p>
                    <div class="form-group">
                        <label for="feedbackUserName">Your Name</label>
                        <input type="text" id="feedbackUserName" readonly>
                    </div>
                    <div class="form-group">
                        <label for="feedbackUserEmail">Your Email</label>
                        <input type="email" id="feedbackUserEmail" readonly>
                    </div>
                    <div class="form-group">
                        <label for="feedbackComment">Your Feedback / Comments</label>
                        <textarea id="feedbackComment" rows="5" required placeholder="Please describe the issue or suggestion..."></textarea>
                    </div>
                </div>
                <div class="modal-actions"> 
                    <button type="submit" id="submitFeedbackBtn" class="button"><i class="fas fa-paper-plane"></i> Submit Feedback</button>
                    <button type="button" id="cancelFeedbackBtn" class="button-secondary"><i class="fas fa-times"></i> Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmModalOverlay" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 30rem;">
            <div class="modal-header">
                <h2 id="deleteConfirmModalTitle">Confirm Deletion</h2>
                <button id="closeDeleteConfirmModalBtn" class="close-button" aria-label="Close">×</button>
            </div>
            <div class="modal-body">
                <p id="deleteConfirmMessage">Are you sure you want to delete this item? This action cannot be undone.</p>
            </div>
            <div class="modal-actions no-border">
                <button type="button" id="confirmDeleteItemBtn" class="button button-danger"><i class="fas fa-trash-alt"></i> Confirm Delete</button>
                <button type="button" id="cancelDeleteItemBtn" class="button-secondary"><i class="fas fa-times"></i> Cancel</button>
            </div>
        </div>
    </div>


    <div class="container-fluid">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-database"></i> <span class="sidebar-logo-text">InfiniBase</span>
            </div>
            <nav id="navigationMenu" class="sidebar-nav">
                <!-- Links will be dynamically generated -->
            </nav>
            <div class="sidebar-footer">
                <button id="logoutButton" class="button button-danger">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
                 <div id="userRoleDisplaySidebar" style="font-size: 0.8rem; color: var(--text-color-muted); text-align: center; margin-top: 0.5rem;">Role: <span id="currentUserRoleSpan"></span></div>
            </div>
        </aside>

        <div class="content-wrapper" id="contentWrapper">
            <header class="content-header">
                <div class="header-left-content">
                    <button id="mobileSidebarToggle" class="mobile-sidebar-toggle"><i class="fas fa-bars"></i></button>
                    <div>
                        <h1 id="currentSectionTitle">Welcome</h1>
                        <div id="breadcrumbs">Home</div>
                    </div>
                </div>
                <div class="header-right-content">
                    <div class="search-container">
                        <span class="search-icon"><i class="fas fa-search"></i></span>
                        <input type="search" id="globalSearchInput" placeholder="Search the knowledge base...">
                        <div id="searchResultsContainer" class="hidden"></div>
                    </div>
                    <div id="userProfileContainer" class="user-profile">
                        <img id="userAvatar" src="https://ui-avatars.com/api/?name=U&size=36&background=6366f1&color=fff&rounded=true" alt="User">
                        <span id="userNameDisplayHeader" style="font-weight: 500;">User</span>
                    </div>
                </div>
            </header>

            <main id="pageContentArea" class="p-6 md:p-8">
                <div id="dashboardOverviewContainer" class="hidden">
                    <!-- Dashboard content will be injected here -->
                </div>
                <div id="standardSectionContentPlaceholder">
                    <!-- Section content will be injected here -->
                </div>
                <div id="itemDetailViewPlaceholder" class="hidden">
                    <!-- Item detail view -->
                </div>
            </main>

            <footer class="mt-auto p-6 text-center text-sm">
                <!-- MODIFIED: Removed version number span -->
                <span>© <script>document.write(new Date().getFullYear())</script> InfiniBase.Elmenisy.</span>
            </footer>
        </div>
    </div>
    <div id="toastContainer"></div>

<script type="module">
    import { supabase } from './supabase.js';

    // =================================================================================
    // IMMEDIATE SESSION CHECK
    // =================================================================================
    const { data: { session: initialSession }, error: initialSessionError } = await supabase.auth.getSession();

    if (initialSessionError) {
        console.error("Critical error during initial session check. Redirecting.", initialSessionError.message);
        window.location.href = 'login.html';
    } else if (!initialSession) {
        console.log("No initial session found. Redirecting to login.");
        window.location.href = 'login.html';
    }
    // =================================================================================
    
    /**
     * @typedef {object} UserProfile
     * @property {string} id - User UUID from Supabase Auth
     * @property {string} [name] - User's full name
     * @property {string} email - User's email
     * @property {string} role - User's role (e.g., 'viewer', 'admin')
     * @property {string} avatar_url - URL for user's avatar
     * @property {string} [lastLogin] - ISO string of last login time
     */

    // --- Supabase Auth & User Management ---
    const Auth = {
        /** @returns {Promise<UserProfile|null>} */
        async getCurrentUserProfile() {
            const { data: { session }, error: sessionError } = await supabase.auth.getSession();

            if (sessionError || !session || !session.user) {
                console.error("Error fetching Supabase session or session invalid:", sessionError);
                window.location.href = 'login.html';
                return null; 
            }

            const authUser = session.user;
            const userId = authUser.id;

            let { data: userDataFromDB, error: dbError } = await supabase
                .from("users")
                .select("id, name, email, role") 
                .eq("id", userId)
                .single();

            if (dbError && dbError.code !== 'PGRST116') {
                console.error("Unexpected DB error fetching user profile:", dbError);
                await supabase.auth.signOut();
                window.location.href = "login.html";
                return null;
            }

            if (!userDataFromDB) {
                console.warn(`Profile for user ${userId} not found. Creating a new profile in 'users' table.`);
                const name = authUser.user_metadata?.full_name || authUser.email.split('@')[0];
                const { data: newProfile, error: insertError } = await supabase
                    .from('users')
                    .insert({ id: userId, email: authUser.email, name: name, role: 'viewer' })
                    .select()
                    .single();

                if (insertError) {
                    console.error("Fatal: Failed to create new user profile in DB after login:", insertError);
                    await supabase.auth.signOut();
                    window.location.href = "login.html";
                    return null;
                }
                
                console.log("Successfully created and fetched new user profile:", newProfile);
                userDataFromDB = newProfile;
            }
            
            const displayName = userDataFromDB.name || userDataFromDB.email || 'User';
            /** @type {UserProfile} */
            const comprehensiveUserProfile = {
                ...userDataFromDB,
                avatar_url: `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName.split(' ').join('+'))}&background=6366f1&color=fff&rounded=true&font-size=0.5`,
                lastLogin: new Date().toISOString() 
            };

            localStorage.setItem("infiniBaseUser", JSON.stringify(comprehensiveUserProfile));
            return comprehensiveUserProfile;
        },
        async logout() {
            const { error } = await supabase.auth.signOut();
            if (error) {
                console.error("Error during sign out:", error);
                showToast('Error signing out. Please try again.', 'error');
            } else {
                localStorage.clear(); // Clear all local storage on logout for a clean state
                showToast('You have been logged out successfully!', 'success');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 1500);
            }
        }
    };

    // --- KB Data ---
    // This is the single source of truth for the *current* version of the data.
    let kbSystemData = {
        meta: { version: '1.3.0', lastGlobalUpdate: new Date().toISOString(), lastArticleAdded: null }, 
        sections: [
            { id: 'home', name: 'Home', icon: 'fas fa-home', description: 'Dashboard and overview.', iconColor: 'var(--primary-color)' },
            {
                id: 'support', name: 'Support', icon: 'fas fa-headset', description: 'Support resources and flows.', iconColor: '#c084fc', 
                items: [
                     { 
                        id: 'sup_flow_compensation', type: 'article', 
                        title: 'Scenario: Customer Inquiry – Compensation Flow for Delays', 
                        summary: 'A comprehensive guide for handling customer compensation due to order delays, based on The Chefz policies.',
                        content: `
                            <div class="content-section-box">
                                <h3><i class="fas fa-book-open"></i> Introduction: Understanding the Compensation Policy</h3>
                                <p>This article provides a comprehensive guide for support agents on handling customer inquiries related to order delays and potential compensation. The goal is to resolve customer issues efficiently while adhering to The Chefz's quality standards and compensation matrix. A positive and empathetic approach is key to customer retention.</p>
                            </div>
                            
                            <div class="content-section-box">
                                <h3><i class="fas fa-headset"></i> Initial Contact and Inquiry Identification</h3>
                                <p>When a customer contacts support regarding a late order, the first step is to acknowledge their concern and verify the order details.</p>
                                <blockquote>
                                    <i class="fas fa-comment-dots"></i> "Hello, thank you for contacting The Chefz. My name is [Your Name]. I understand you're calling about a delay with your order. Could you please provide me with your order number so I can look into it for you?"
                                </blockquote>
                                <p>Once the order is located, confirm the nature of the inquiry. If it's a delay, proceed to the next step. If it's another issue (e.g., chef quality), navigate to the relevant knowledge article for that topic.</p>
                            </div>

                            <div class="content-section-box">
                                <h3><i class="fas fa-clock"></i> Assessing the Delay and Order Type</h3>
                                <p>Using the company system, determine the exact duration of the delay against the estimated delivery time (ETA). It's crucial to identify if the order is a <strong>Fast Order</strong> or a <strong>Scheduled Order</strong>, as compensation policies differ.</p>
                                <ul>
                                    <li><strong>Delay of 0-15 minutes:</strong> The order is slightly delayed. Apologize and provide a new, realistic ETA. No compensation is typically offered at this stage unless the customer is highly dissatisfied.</li>
                                    <li><strong>Delay of more than 15 minutes:</strong> A significant delay has occurred. A proactive approach is required.</li>
                                </ul>
                                <blockquote>
                                    <i class="fas fa-comment-dots"></i> "I sincerely apologize for this significant delay. This is not the standard of service we aim to provide. Let me check the specifics of your order to see how we can best resolve this for you."
                                </blockquote>
                            </div>

                            <div class="content-section-box">
                                <h3><i class="fas fa-calculator"></i> Applying the Compensation Matrix</h3>
                                <p>Based on the delay duration and order type, apply the official compensation policy. Agent discretion may be used within the defined limits.</p>
                                <div class="compensation-grid">
                                    <div class="compensation-box fast-order">
                                        <h4><i class="fas fa-shipping-fast"></i> Fast Orders (&gt; 15 mins)</h4>
                                        <ul>
                                            <li><span>16–30 mins</span> <span class="action">Delivery Fees</span></li>
                                            <li><span>31–45 mins</span> <span class="action">Fees + 25% Chef Total</span></li>
                                            <li><span>46–60 mins</span> <span class="action">Fees + 50% Chef Total</span></li>
                                            <li><span>&gt; 60 mins</span> <span class="action">Total Order</span></li>
                                        </ul>
                                    </div>
                                    <div class="compensation-box scheduled-order">
                                        <h4><i class="fas fa-calendar-alt"></i> Scheduled Orders (&gt; 30 mins)</h4>
                                        <ul>
                                            <li><span>31–60 mins</span> <span class="action">50-100% of Total Order</span></li>
                                            <li><span>&gt; 60 mins</span> <span class="action">Total Order + 50 SAR</span></li>
                                        </ul>
                                    </div>
                                </div>
                                <blockquote>
                                    <i class="fas fa-comment-dots"></i> "Based on the [duration] delay with your [Fast/Scheduled] order, we will be processing a compensation of [state specific compensation]. This will be reflected in your account within 24-48 hours. We are very sorry for the inconvenience this has caused."
                                </blockquote>
                            </div>

                            <div class="content-section-box">
                                <h3><i class="fas fa-clipboard-check"></i> Finalizing the Case & Documentation</h3>
                                <p>The agent must finalize the action directly in the company system by:</p>
                                <ul>
                                    <li>Logging the note on the order</li>
                                    <li>Recording the compensation amount and reason clearly</li>
                                    <li>Selecting the responsible party (Store, Driver, Company)</li>
                                </ul>
                            </div>
                        `,
                        tags: ['compensation', 'customer service', 'chefz policy', 'sop', 'delay'],
                        createdAt: '2024-05-20T10:00:00.000Z',
                        lastModified: '2025-06-22T14:30:00.000Z',
                        version: 1.1,
                        views: 183,
                        comments: [
                            { id: 'cmt_1', authorId: 'user_2', authorName: 'Rahma', text: 'This new format is much clearer. Thank you!', timestamp: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString() },
                            { id: 'cmt_2', authorId: 'user_1', authorName: 'Developer (Mohamed Elmenisy)', text: 'Glad you find it helpful, Rahma! We are working on updating all major scenarios to this new knowledge article format.', timestamp: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString() }
                        ],
                        feedback: [
                            { type: 'positive', userId: 'user_2', timestamp: new Date().toISOString() }
                        ]
                    },
                    {
                        id: 'sup_child_example', type: 'article', parentId: 'sup_flow_compensation',
                        title: 'Child Article: Detailed Scenarios for Driver Responsibility',
                        summary: 'Examples of when a driver is considered responsible for delays.',
                        content: '<p>This article dives deeper into specific situations regarding driver responsibility for order delays.</p><ul><li>Example 1: Driver took an unnecessarily long route.</li><li>Example 2: Driver had multiple unscheduled stops.</li><li>Example 3: Driver did not promptly head to customer after pickup.</li></ul>',
                        tags: ['driver', 'responsibility', 'delay'],
                        createdAt: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(), // ~5 days ago
                        lastModified: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(),
                        views: 78,
                        comments: [],
                        feedback: []
                    }
                ]
            },
            { id: 'partner_care', name: 'Partner Care', icon: 'fas fa-handshake', description: 'Resources for partner management.', iconColor: '#2dd4bf', items: [
                 { id: 'pc_case_01', type: 'case', title: 'Case: Partner Payment Dispute', summary: 'Investigating a partner claim about incorrect payment.', createdAt: "2023-09-20T09:00:00.000Z", lastModified: "2023-09-20T09:00:00.000Z", resolution_steps: '<p>1. Verify partner contract. 2. Check payment logs. 3. Escalate to finance if discrepancy found.</p>', status: 'Open', views: 42, comments: [], feedback: [] }
            ] }, 
            { id: 'logistics', name: 'Logistics', icon: 'fas fa-truck', description: 'Logistics operations and information.', iconColor: '#4ade80', items: [] }, 
            { id: 'customer_care', name: 'Customer Care', icon: 'fas fa-users', description: 'Customer service guidelines and FAQs.', iconColor: '#a78bfa', items: [] }, 
            { id: 'distribution_followup', name: 'Distribution & Follow-up', icon: 'fas fa-people-carry', description: 'Distribution processes and tracking.', iconColor: '#22d3ee', items: [] }, 
            { id: 'logistics_driver_complaints', name: 'Logistics (Driver Complaints)', icon: 'fas fa-shipping-fast', description: 'Handling driver-related complaints.', iconColor: '#84cc16', items: [] }, 
            { id: 'logistics_3pl', name: 'Logistics-3PL', icon: 'fas fa-boxes-stacked', description: 'Third-party logistics information.', iconColor: '#facc15', items: [] }, 
            { id: 'order_at_store_mac', name: 'Order at Store (Mac)', icon: 'fas fa-store', description: 'Procedures for Mac orders at store.', iconColor: '#f472b6', items: [] }, 
            { id: 'logistics_admin', name: 'Logistics-Admin', icon: 'fas fa-user-shield', description: 'Administrative tasks for logistics.', iconColor: '#fb7185', items: [] }, 
            { id: 'operating_systems', name: 'Operating Systems', icon: 'fab fa-windows', description: 'OS troubleshooting and guides.', iconColor: '#38bdf8', items: [] }, 
            { id: 'compensation_policies', name: 'Compensation Policies', icon: 'fas fa-hand-holding-usd', description: 'Detailed compensation policies.', iconColor: '#f59e0b', items: [
                { id: 'cp_policy_01', type: 'policy', title: 'General Compensation Policy v2.1', summary: 'The main policy document for all compensation scenarios.', createdAt: "2023-08-01T11:00:00.000Z", lastModified: "2023-08-01T11:00:00.000Z", content: '<h1>Policy v2.1</h1><p>Details about the compensation policy...</p>', views: 312, comments: [], feedback: [] }
            ] }, 
            { id: 'operational_instructions', name: 'Operational Instructions', icon: 'fas fa-clipboard-list', description: 'Standard operating procedures.', iconColor: '#93c5fd', items: [] }, 
            { id: 'forms_templates', name: 'Forms/Templates', icon: 'fas fa-file-alt', description: 'Standard forms and templates.', iconColor: '#a5b4fc', items: [] }
        ]
    };

    // --- Data Loading Strategy ---
    // The application is configured to always load data directly from the
    // 'kbSystemData' object defined in this script. The use of localStorage
    // for persisting this data has been removed to ensure that any content
    // updates in the source code are immediately reflected for all users on
    // page load, without requiring a cache clear.
    
    function saveDataToLocalStorage() {
        // This function is intentionally left empty. Any in-memory data
        // modifications (like adding comments or tracking views) will only
        // persist for the duration of the current user session and will be
        // reset on the next page load. This fulfills the requirement of
        // loading fresh content every time.
        return;
    }
    
    // The loadDataFromLocalStorage() function and its initial call have been
    // removed to enforce loading from the hardcoded 'kbSystemData' object.


    // --- DOM Elements ---
    const sidebar = document.getElementById('sidebar');
    const mobileSidebarToggle = document.getElementById('mobileSidebarToggle');
    const navigationMenu = document.getElementById('navigationMenu');
    const currentSectionTitleEl = document.getElementById('currentSectionTitle');
    const breadcrumbsContainer = document.getElementById('breadcrumbs');
    const pageContentArea = document.getElementById('pageContentArea');
    const dashboardOverviewContainer = document.getElementById('dashboardOverviewContainer');
    const standardSectionContentPlaceholder = document.getElementById('standardSectionContentPlaceholder');
    const itemDetailViewPlaceholder = document.getElementById('itemDetailViewPlaceholder');
    const userNameDisplayHeader = document.getElementById('userNameDisplayHeader');
    const userAvatar = document.getElementById('userAvatar');
    const currentUserRoleSpan = document.getElementById('currentUserRoleSpan');


    const addContentModalOverlay = document.getElementById('addContentModalOverlay');
    const closeAddContentModalBtn = document.getElementById('closeAddContentModalBtn');
    const addContentForm = document.getElementById('addContentForm');
    const templateSelectionContainer = document.getElementById('templateSelectionContainer');
    const cancelAddContentBtn = document.getElementById('cancelAddContentBtn');
    const contentTypeSelect = document.getElementById('contentType');
    const contentUrlContainer = document.getElementById('contentUrlContainer');
    const contentDetailContainer = document.getElementById('contentDetailContainer');
    const contentDetailLabel = document.getElementById('contentDetailLabel');
    const contentTagsInput = document.getElementById('contentTags');
    const editingItemIdInput = document.getElementById('editingItemId');
    
    const globalSearchInput = document.getElementById('globalSearchInput');
    const searchResultsContainer = document.getElementById('searchResultsContainer');

    const logoutButton = document.getElementById('logoutButton');
    const logoutConfirmModalOverlay = document.getElementById('logoutConfirmModalOverlay');
    const closeLogoutConfirmModalBtn = document.getElementById('closeLogoutConfirmModalBtn');
    const confirmLogoutBtn = document.getElementById('confirmLogoutBtn');
    const cancelLogoutBtn = document.getElementById('cancelLogoutBtn');

    const reportFeedbackModalOverlay = document.getElementById('reportFeedbackModalOverlay');
    const closeReportFeedbackModalBtn = document.getElementById('closeReportFeedbackModalBtn');
    const reportFeedbackForm = document.getElementById('reportFeedbackForm');
    const cancelFeedbackBtn = document.getElementById('cancelFeedbackBtn');
    const feedbackItemIdInput = document.getElementById('feedbackItemId');
    const feedbackItemTitleInput = document.getElementById('feedbackItemTitle');
    const feedbackItemTitleDisplay = document.getElementById('feedbackItemTitleDisplay');
    const feedbackUserNameInput = document.getElementById('feedbackUserName');
    const feedbackUserEmailInput = document.getElementById('feedbackUserEmail');
    const feedbackCommentTextarea = document.getElementById('feedbackComment');

    const deleteConfirmModalOverlay = document.getElementById('deleteConfirmModalOverlay');
    const closeDeleteConfirmModalBtn = document.getElementById('closeDeleteConfirmModalBtn');
    const confirmDeleteItemBtn = document.getElementById('confirmDeleteItemBtn');
    const cancelDeleteItemBtn = document.getElementById('cancelDeleteItemBtn');
    const deleteConfirmMessage = document.getElementById('deleteConfirmMessage');


    let mainQuillEditor;
    /** @type {UserProfile|null} */
    let currentUser = null; 
    let currentOpenItem = null;
    let visitorsChartInstance, casesChartInstance, articlesChartInstance; 

    // --- Utility Functions ---
    function escapeHTML(str) {
        if (typeof str !== 'string') return '';
        const el = document.createElement('div');
        el.textContent = str;
        return el.innerHTML;
    }

    function highlightText(text, query) {
        if (!text) return '';
        const safeText = escapeHTML(text);
        if (!query) return safeText;
        try {
            const rgx = new RegExp(`(${query.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')})`, 'gi');
            return safeText.replace(rgx, '<mark>$1</mark>');
        } catch (e) { return safeText; }
    }

    function truncateText(text, len) {
        if (!text || text.length <= len) return text;
        return text.substring(0, len) + '...';
    }
    function stripHtml(html){
       let tmp = document.createElement("DIV");
       tmp.innerHTML = html;
       return tmp.textContent || tmp.innerText || "";
    }

    function showToast(message, type = 'info', duration = 3000) {
        const toastContainer = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast-notification toast-${type}`;
        
        let iconClass = 'fas fa-info-circle';
        if (type === 'success') iconClass = 'fas fa-check-circle';
        else if (type === 'error') iconClass = 'fas fa-times-circle';

        toast.innerHTML = `<i class="toast-icon ${iconClass}"></i> <span>${escapeHTML(message)}</span>`;
        toastContainer.appendChild(toast);

        setTimeout(() => toast.classList.add('show'), 10);

        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, duration);
    }
    
    function applyPermanentDarkMode() { 
        [visitorsChartInstance, casesChartInstance, articlesChartInstance].forEach(chart => {
            if (chart) {
                const legendColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim();
                const ticksColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color-muted').trim();
                const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim();
                
                chart.options.plugins.legend.labels.color = legendColor;
                if (chart.options.scales && chart.options.scales.y) {
                    chart.options.scales.y.ticks.color = ticksColor;
                    chart.options.scales.y.grid.color = gridColor;
                }
                if (chart.options.scales && chart.options.scales.x) { 
                    chart.options.scales.x.ticks.color = ticksColor;
                    chart.options.scales.x.grid.color = gridColor;
                }
                chart.update();
            }
        });
    }

    // --- Sidebar and Navigation ---
    function populateSidebar() {
        let menuHTML = '';
        const mainSections = ['home'];
        const knowledgeAreas = [
            'support', 'partner_care', 'logistics', 'customer_care', 
            'distribution_followup', 'logistics_driver_complaints', 'logistics_3pl', 
            'order_at_store_mac', 'logistics_admin', 'operating_systems'
        ];
        const resourcesPolicies = [
            'compensation_policies', 'operational_instructions', 'forms_templates'
        ];

        menuHTML += `<div class="sidebar-section-title">MAIN</div>`;
        kbSystemData.sections.filter(s => mainSections.includes(s.id)).forEach(section => {
            const iconStyle = section.iconColor ? `style="color: ${section.iconColor};"` : '';
            menuHTML += `<a href="#${section.id}" class="sidebar-link" data-section="${section.id}">
                <i class="${section.icon || 'fas fa-file-alt'}" ${iconStyle}></i>${escapeHTML(section.name)}
            </a>`;
        });
        
        menuHTML += `<div class="sidebar-section-title">KNOWLEDGE AREAS</div>`;
        kbSystemData.sections.filter(s => knowledgeAreas.includes(s.id)).forEach(section => {
            const iconStyle = section.iconColor ? `style="color: ${section.iconColor};"` : '';
            menuHTML += `<a href="#${section.id}" class="sidebar-link" data-section="${section.id}">
                <i class="${section.icon || 'fas fa-folder'}" ${iconStyle}></i>${escapeHTML(section.name)}
            </a>`;
        });

        menuHTML += `<div class="sidebar-section-title">RESOURCES & POLICIES</div>`;
        kbSystemData.sections.filter(s => resourcesPolicies.includes(s.id)).forEach(section => {
            const iconStyle = section.iconColor ? `style="color: ${section.iconColor};"` : '';
            menuHTML += `<a href="#${section.id}" class="sidebar-link" data-section="${section.id}">
                <i class="${section.icon || 'fas fa-book'}" ${iconStyle}></i>${escapeHTML(section.name)}
            </a>`;
        });

        navigationMenu.innerHTML = menuHTML;
    }

    mobileSidebarToggle.addEventListener('click', () => sidebar.classList.toggle('closed'));
    sidebar.addEventListener('click', (e) => {
        if (e.target.closest('.sidebar-link') && window.innerWidth < 768) {
            sidebar.classList.add('closed');
        }
    });

    function highlightSidebarLink(sectionId) {
        document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
        const activeLink = document.querySelector(`.sidebar-link[data-section="${sectionId}"]`);
        if (activeLink) activeLink.classList.add('active');
    }

    // --- Content Display ---
    function renderItemCard(item, sectionData) {
        let itemIconClass = 'fas fa-file-alt'; 
        
        if (item.type === 'article') { itemIconClass = 'fas fa-newspaper'; }
        else if (item.type === 'case') { itemIconClass = 'fas fa-briefcase'; }
        else if (item.type === 'form_sheet') { itemIconClass = 'fas fa-file-invoice'; }
        else if (item.type === 'design') { itemIconClass = 'fas fa-palette'; }
        else if (item.type === 'guide') { itemIconClass = 'fas fa-book-open'; }
        else if (item.type === 'policy') { itemIconClass = 'fas fa-gavel'; }

        const isAdmin = currentUser && currentUser.role === 'admin';
        const viewButton = `<a href="#${sectionData.id}/${item.id}" class="button button-secondary" title="View Item"><i class="fas fa-eye"></i> View</a>`;
        const editButton = isAdmin ? `<button class="button button-secondary" onclick="event.stopPropagation(); window.openEditModal('${sectionData.id}', '${item.id}')" title="Edit Item"><i class="fas fa-edit"></i> Edit</button>` : '';
        const deleteButton = isAdmin ? `<button class="button button-danger" onclick="event.stopPropagation(); window.openDeleteModal('${sectionData.id}', '${item.id}', '${escapeHTML(item.title)}')" title="Delete Item"><i class="fas fa-trash-alt"></i></button>` : '';
        
        const tagsHTML = item.tags && item.tags.length > 0
            ? `<div class="card-tags">${item.tags.map(tag => `<span class="tag">${escapeHTML(tag)}</span>`).join('')}</div>`
            : '';
        
        let updatedBadgeHTML = '';
        const createdAt = new Date(item.createdAt);
        const lastModified = new Date(item.lastModified);
        // Show "Updated" badge if modification happened at least 1 minute after creation
        if (lastModified.getTime() > createdAt.getTime() + 60000) {
            updatedBadgeHTML = `<div class="updated-badge">Updated</div>`;
        }

        return `
            <div class="card" data-item-id="${item.id}" data-section-id="${sectionData.id}">
                <div class="card-header-icon">
                    <div class="card-icon-container">
                        <i class="${itemIconClass}"></i>
                    </div>
                    <div class="card-title-group">
                        <h3>${escapeHTML(item.title)}</h3>
                        ${updatedBadgeHTML}
                    </div>
                </div>
                ${tagsHTML}
                <p>${escapeHTML(truncateText(stripHtml(item.summary), 120))}</p>
                <div class="card-actions">
                    ${viewButton}
                    ${editButton}
                    ${deleteButton}
                </div>
            </div>`;
    }

    async function displayDashboard() {
        dashboardOverviewContainer.classList.remove('hidden');
        standardSectionContentPlaceholder.classList.add('hidden');
        itemDetailViewPlaceholder.classList.add('hidden');
        currentSectionTitleEl.textContent = 'Dashboard';
        breadcrumbsContainer.innerHTML = `<span style="font-weight: bold; color: var(--primary-color);">Home</span>`;

        if (!currentUser || currentUser.role !== 'admin') {
            dashboardOverviewContainer.innerHTML = `
                <div class="viewer-dashboard-message">
                    <div class="card">
                        <i class="fas fa-user-shield"></i>
                        <h2>Access Restricted</h2>
                        <p>The dashboard overview is available for administrators only.</p>
                        <p class="subtle-note">You can navigate using the sidebar to view knowledge base content.</p>
                    </div>
                </div>
            `;
            return;
        }

        const welcomeUser = currentUser.name || 'Admin'; 
        const allItems = kbSystemData.sections.flatMap(s => s.items || []);
        const totalSections = kbSystemData.sections.length;
        const totalArticles = allItems.filter(i => ['article', 'guide', 'policy'].includes(i.type)).length;
        const totalCases = allItems.filter(i => i.type === 'case').length;
        
        const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
        const editsThisWeek = allItems.filter(i => i.lastModified && new Date(i.lastModified) > sevenDaysAgo).length;

        let lastAddedInfo = { title: "N/A", date: "N/A" };
        if (allItems.length > 0) {
            const latestItem = [...allItems].sort((a,b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0))[0];
            if (latestItem) {
                 lastAddedInfo = { title: latestItem.title, date: new Date(latestItem.createdAt || Date.now()).toLocaleDateString() };
            }
        }
        
        const mostUsedArticles = [...allItems].sort((a,b) => (b.views || 0) - (a.views || 0)).slice(0,3);

        dashboardOverviewContainer.innerHTML = `
            <div class="card" style="background: linear-gradient(to right, var(--primary-color), #4c1d95); color: white; min-height: auto;">
                <h2 style="font-size: 1.75rem; margin-bottom: 4px;">Welcome back, ${escapeHTML(welcomeUser)}!</h2>
                <p style="opacity: 0.95; font-size: 0.95rem; color: var(--text-color-inverted);">Overview of your knowledge base activity.</p>
            </div>

            <div class="cards-grid md:grid-cols-2 lg:grid-cols-4 my-6">
                <div class="dashboard-stat-card">
                    <i class="fas fa-folder-open"></i>
                    <span class="stat-value">${totalSections}</span>
                    <span class="stat-label">Total Sections</span>
                </div>
                <div class="dashboard-stat-card">
                    <i class="fas fa-newspaper"></i>
                    <span class="stat-value">${totalArticles}</span>
                    <span class="stat-label">Total Articles & Guides</span>
                </div>
                 <div class="dashboard-stat-card">
                    <i class="fas fa-briefcase"></i>
                    <span class="stat-value">${totalCases}</span>
                    <span class="stat-label">Total Cases</span>
                </div>
                <div class="dashboard-stat-card">
                    <i class="fas fa-edit"></i>
                    <span class="stat-value">${editsThisWeek}</span>
                    <span class="stat-label">Edits This Week</span>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="dashboard-info-card">
                    <h3>🔥 Most Used Articles</h3>
                    <ul>${mostUsedArticles.length ? mostUsedArticles.map(item => {
                        const section = kbSystemData.sections.find(s => s.items && s.items.includes(item));
                        return `<li>
                            <a href="#${section.id}/${item.id}">${escapeHTML(item.title)}</a> 
                            <span class="meta"><i class="fas fa-eye"></i> ${item.views || 0} views &nbsp;&nbsp; <i class="fas fa-comments"></i> ${item.comments?.length || 0} comments</span>
                        </li>`
                    }).join('') : '<li>No data yet.</li>'}</ul>
                </div>
                <div class="dashboard-info-card">
                    <h3>💡 Quick Links & System Info</h3>
                     <ul>
                        <li><a href="#support/sup_flow_compensation"><i class="fas fa-project-diagram fa-fw"></i> View Compensation Scenario</a></li>
                        <li><a href="#forms_templates"><i class="fas fa-file-alt fa-fw"></i> Browse Templates</a></li>
                        <li style="padding-top: 1rem; color: var(--text-color);"><strong>Last Added:</strong> ${escapeHTML(lastAddedInfo.title)} <span class="meta">(${escapeHTML(lastAddedInfo.date)})</span></li>
                     </ul>
                </div>
            </div>

             <div class="card chart-container" style="height: 350px;">
                <h3>Content Activity (Mock Data)</h3>
                <canvas id="visitorsChart"></canvas>
            </div>
        `;
        
        const legendColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim();
        const ticksColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color-muted').trim();
        const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim();

        const chartOptions = {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { labels: { color: legendColor, font: { family: 'Inter, sans-serif' } }, position: 'top', },
                tooltip: { bodyFont: { family: 'Inter, sans-serif' }, titleFont: { family: 'Inter, sans-serif' } }
            },
            scales: {
                y: { ticks: { color: ticksColor, beginAtZero: true, font: { family: 'Inter, sans-serif' } }, grid: { color: gridColor } },
                x: { ticks: { color: ticksColor, font: { family: 'Inter, sans-serif' } }, grid: { color: gridColor } }
            }
        };

        if (visitorsChartInstance) visitorsChartInstance.destroy();
        const visitorsCtx = document.getElementById('visitorsChart')?.getContext('2d');
        if (visitorsCtx) {
            visitorsChartInstance = new Chart(visitorsCtx, {
                type: 'bar',
                data: { 
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'], 
                    datasets: [
                        { label: 'Views', data: [65, 59, 80, 81, 56, 55, 40], backgroundColor: 'rgba(99, 102, 241, 0.7)'},
                        { label: 'Comments', data: [5, 2, 8, 3, 7, 4, 2], backgroundColor: 'rgba(34, 197, 94, 0.7)'}
                    ]
                },
                options: chartOptions
            });
        }
        applyPermanentDarkMode(); 
    }
    
    async function displaySectionContent(sectionId, subCategoryFilter = null) {
        currentOpenItem = null;
        dashboardOverviewContainer.classList.add('hidden');
        standardSectionContentPlaceholder.classList.remove('hidden');
        itemDetailViewPlaceholder.classList.add('hidden');

        const sectionData = kbSystemData.sections.find(s => s.id === sectionId);
        if (!sectionData) {
            standardSectionContentPlaceholder.innerHTML = `<div class="card" style="text-align: center;"><h2 style="color: red;">Section not found: ${escapeHTML(sectionId)}</h2></div>`;
            currentSectionTitleEl.textContent = 'Not Found';
            return;
        }

        currentSectionTitleEl.textContent = sectionData.name;
        let bcHTML = `<a href="#home">Home</a> <span style="margin: 0 5px;">›</span> <span style="font-weight: bold; color: var(--primary-color);">${escapeHTML(sectionData.name)}</span>`;
        breadcrumbsContainer.innerHTML = bcHTML;

        let contentHTML = `<div>`;
        
        if (currentUser && currentUser.role === 'admin' && sectionId !== 'home') {
             contentHTML += `
                <div style="text-align: right; margin-bottom: 1.5rem;">
                    <button id="openAddContentBtnInSection" class="button" data-section-id="${sectionData.id}">
                        <i class="fas fa-plus-circle"></i> Add Content to ${escapeHTML(sectionData.name)}
                    </button>
                </div>`;
        }

        const itemsToDisplay = (sectionData.items || []).filter(item => !item.parentId);
        
        if (itemsToDisplay.length > 0) {
            contentHTML += `<div class="cards-grid">`;
            itemsToDisplay.forEach(item => contentHTML += renderItemCard(item, sectionData));
            contentHTML += `</div>`;
        } else {
             contentHTML += `<div class="card" style="text-align: center; padding: 40px 20px; min-height: auto;"><p style="font-size: 1.2rem; color: var(--text-color-muted);">No content in this section yet.</p></div>`;
        }

        contentHTML += `</div>`;
        standardSectionContentPlaceholder.innerHTML = contentHTML;

        const openAddBtnInSection = document.getElementById('openAddContentBtnInSection');
        if (openAddBtnInSection) {
            openAddBtnInSection.addEventListener('click', (e) => {
                const currentSecId = e.currentTarget.dataset.sectionId;
                openAddContentModal(currentSecId);
            });
        }
    }
    
    function findParentItem(parentId) {
        for (const section of kbSystemData.sections) {
            if (section.items) {
                const parentItem = section.items.find(item => item.id === parentId);
                if (parentItem) {
                    return { ...parentItem, sectionId: section.id };
                }
            }
        }
        return null;
    }

    function trackView(item) {
        if (!currentUser) return;
        const viewKey = `view_log_${currentUser.id}_${item.id}`;
        const twelveHours = 12 * 60 * 60 * 1000;
        const lastView = localStorage.getItem(viewKey);
        const now = Date.now();

        if (!lastView || (now - parseInt(lastView, 10)) > twelveHours) {
            item.views = (item.views || 0) + 1;
            saveDataToLocalStorage(); // Persist view count change
            localStorage.setItem(viewKey, now.toString());
            console.log(`View tracked for item ${item.id}. New count: ${item.views}`);
            // Update the view count on the page if it's visible
            const readStatsEl = document.getElementById('readStatsCount');
            if(readStatsEl) readStatsEl.textContent = item.views.toLocaleString();
        } else {
            console.log(`View for item ${item.id} already tracked within the last 12 hours.`);
        }
    }


    async function downloadItemAsPDF(itemToDownload) {
        if (!itemToDownload || !itemToDownload.title) {
            showToast('Error preparing PDF: Item data is missing.', 'error'); return;
        }
        const filename = `${itemToDownload.title.replace(/[^a-z0-9_]+/gi, '_').toLowerCase()}.pdf`;
        showToast('Generating PDF, please wait...', 'info', 5000);

        const element = document.getElementById('itemDetailViewPlaceholder');
        if (!element) {
            showToast('Error preparing PDF: Content area not found.', 'error'); return;
        }
        const elementToPrint = element.cloneNode(true);
        elementToPrint.style.padding = "20px";
        elementToPrint.style.width = "210mm";
        elementToPrint.style.backgroundColor = "white";
        
        const selectorsToRemove = [ '.item-actions-bar', '.item-feedback-section', '.comments-section', '.copy-script-btn', '.update-banner', '.last-updated-info' ];
        selectorsToRemove.forEach(selector => elementToPrint.querySelectorAll(selector).forEach(el => el.remove()));
        
        elementToPrint.style.position = 'absolute';
        elementToPrint.style.left = '-9999px';
        document.body.appendChild(elementToPrint);

        const opt = {
            margin: [10, 10, 10, 10], filename: filename,
            image: { type: 'jpeg', quality: 0.95 },
            html2canvas: { scale: 2, logging: false, useCORS: true },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
            pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
        };

        try {
            await html2pdf().from(elementToPrint).set(opt).save();
            showToast('PDF downloaded successfully!', 'success');
        } catch (error) {
            console.error("Error generating PDF:", error);
            showToast('Error generating PDF. Check console.', 'error');
        } finally {
             document.body.removeChild(elementToPrint);
        }
    }

    async function displayItemDetail(sectionId, itemId) {
        const sectionData = kbSystemData.sections.find(s => s.id === sectionId);
        const itemData = sectionData?.items?.find(i => i.id === itemId);

        if (!sectionData || !itemData) {
            standardSectionContentPlaceholder.innerHTML = `<p style="color: red;">Error: Item not found.</p>`;
            itemDetailViewPlaceholder.classList.add('hidden');
            standardSectionContentPlaceholder.classList.remove('hidden');
            return;
        }

        trackView(itemData); // Track the view for this item

        currentOpenItem = { sectionId, itemId, title: itemData.title };

        dashboardOverviewContainer.classList.add('hidden');
        standardSectionContentPlaceholder.classList.add('hidden');
        itemDetailViewPlaceholder.classList.remove('hidden');

        let bcHTML = `
            <a href="#home">Home</a> <span style="margin: 0 5px;">›</span>
            <a href="#${sectionData.id}">${escapeHTML(sectionData.name)}</a> <span style="margin: 0 5px;">›</span>
            <span style="font-weight: bold; color: var(--primary-color);">${escapeHTML(itemData.title)}</span>`;
        breadcrumbsContainer.innerHTML = bcHTML;
        currentSectionTitleEl.textContent = itemData.title;

        let itemIconClass = 'fas fa-file-alt';
        if (itemData.type === 'case') itemIconClass = 'fas fa-briefcase';
        else if (itemData.type === 'article') itemIconClass = 'fas fa-newspaper';
        else if (itemData.type === 'guide') itemIconClass = 'fas fa-book-open';
        else if (itemData.type === 'policy') itemIconClass = 'fas fa-gavel';

        let detailHTML = '';
        
        const parentItemInfo = itemData.parentId ? findParentItem(itemData.parentId) : null;
        let backLinkHref, backLinkText;
        if (parentItemInfo) {
            backLinkHref = `#${parentItemInfo.sectionId}/${parentItemInfo.id}`;
            backLinkText = `Back to: ${escapeHTML(truncateText(parentItemInfo.title, 25))}`;
        } else {
            backLinkHref = `#${sectionId}`;
            backLinkText = 'Back to Section';
        }
        
        detailHTML += `<div class="item-actions-bar">
            <a href="${backLinkHref}" class="button button-secondary"><i class="fas fa-arrow-left"></i> ${backLinkText}</a>`;
        if (currentUser && currentUser.role === 'admin') {
             detailHTML += `<button id="editItemBtn" class="button"><i class="fas fa-edit"></i> Edit Item</button>`;
             detailHTML += `<button id="deleteItemBtn" class="button button-danger"><i class="fas fa-trash-alt"></i> Delete Item</button>`;
        }
        detailHTML += `<button id="printItemBtn" class="button button-secondary"><i class="fas fa-print"></i> Print</button>
                      <button id="downloadPdfItemBtn" class="button button-secondary"><i class="fas fa-file-pdf"></i> Download PDF</button>
                      </div>`;
        
        let lastUpdatedHTML = '';
        const createdAt = new Date(itemData.createdAt);
        const lastModified = new Date(itemData.lastModified);
        // Show update text if modified significantly after creation (e.g., > 1 minute)
        if (lastModified.getTime() > createdAt.getTime() + 60000) {
            const formattedDate = lastModified.toLocaleDateString('en-US', {
                year: 'numeric', month: 'long', day: 'numeric'
            });
            lastUpdatedHTML = `<div class="last-updated-info">
                                + Last updated on ${formattedDate}
                               </div>`;
        }

        detailHTML += `<div class="card">
                    <div class="item-title-area">
                        <i class="${itemIconClass} fa-title-icon"></i>
                        <h2>${escapeHTML(itemData.title)}</h2>
                    </div>
                    <p class="item-summary">${escapeHTML(stripHtml(itemData.summary))}</p>
                    ${itemData.tags && itemData.tags.length ? `<div class="card-tags" style="margin-bottom: 1rem;">${itemData.tags.map(tag => `<span class="tag">${escapeHTML(tag)}</span>`).join('')}</div>` : ''}
                    <hr class="title-content-divider">
                    ${lastUpdatedHTML}
                    <div class="kb-content">${itemData.content || itemData.resolution_steps || '<p>No detailed content available.</p>'}</div>
                   </div>`;
        
        const childItems = kbSystemData.sections.flatMap(s => s.items || [])
                               .filter(child => child.parentId === itemData.id)
                               .map(child => ({...child, sectionId: kbSystemData.sections.find(s => s.items && s.items.includes(child)).id }));
        if (childItems.length > 0) {
            detailHTML += `<div class="card" style="margin-top: 1.5rem;">
                            <h3 style="font-size: 1.25rem; font-weight:600; margin-bottom:1rem; margin-top:0;">Related Topics</h3>
                            <ul class="child-items-list">${childItems.map(child => `<li><a href="#${child.sectionId}/${child.id}"><i class="fas fa-angle-right"></i> ${escapeHTML(child.title)}</a></li>`).join('')}</ul>
                           </div>`;
        }

        detailHTML += `<div class="item-feedback-section">
                        <h4 id="feedbackPrompt">Was this article helpful?</h4>
                        <div id="feedbackInteractionContainer">
                           <div class="rating-prompt">
                                <div class="rating-buttons" id="ratingButtons">
                                    <button id="rateYesBtn" data-item-id="${itemId}"><i class="fas fa-thumbs-up"></i> Yes</button>
                                    <button id="rateNoBtn" data-item-id="${itemId}"><i class="fas fa-thumbs-down"></i> No</button>
                                </div>
                            </div>
                            <form id="negativeFeedbackForm" class="hidden">
                                <div class="form-group">
                                    <textarea id="feedbackReason" rows="3" placeholder="Your feedback is valuable to us..."></textarea>
                                </div>
                                <button type="submit" class="button">Submit Feedback</button>
                                <button type="button" id="cancelNegativeFeedbackBtn" class="button button-secondary">Cancel</button>
                            </form>
                        </div>
                        <div class="read-stats">Total Views: <span id="readStatsCount">${(itemData.views || 0).toLocaleString()}</span></div>
                       </div>`;
        
        detailHTML += `<div class="comments-section">
                        <h4><i class="fas fa-comments"></i> Management Notes</h4>
                        <div class="comment-post-area">
                            <img src="${currentUser.avatar_url}" alt="Your avatar">
                            <div class="comment-input-wrapper">
                                <textarea id="newCommentText" placeholder="Add an internal note..."></textarea>
                                <div class="comment-post-actions">
                                    <button id="postCommentBtn" class="button">Post Note</button>
                                </div>
                            </div>
                        </div>
                        <div class="comment-display-area" id="commentDisplayAreaForItem"></div>
                       </div>`;


        itemDetailViewPlaceholder.innerHTML = detailHTML;
        setupItemDetailEventListeners(itemData, sectionData, sectionId, itemId);
    }
    
    function setupItemDetailEventListeners(itemData, sectionData, sectionId, itemId) {
        renderComments(itemData, 'commentDisplayAreaForItem'); 
        
        // Add copy buttons to pre blocks (code)
        itemDetailViewPlaceholder.querySelectorAll('.kb-content pre').forEach(pre => {
            const copyBtn = document.createElement('button');
            copyBtn.className = 'copy-script-btn';
            copyBtn.innerHTML = '<i class="fas fa-copy"></i> Copy';
            copyBtn.title = 'Copy content';
            pre.appendChild(copyBtn);
            copyBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const textToCopy = pre.querySelector('code')?.innerText || pre.innerText.replace('Copy', '').trim();
                navigator.clipboard.writeText(textToCopy)
                    .then(() => showToast('Content copied!', 'success'))
                    .catch(err => showToast('Failed to copy.', 'error'));
            });
        });
        
        if (currentUser && currentUser.role === 'admin') {
            const editBtn = document.getElementById('editItemBtn');
            if (editBtn) {
                editBtn.addEventListener('click', () => {
                    openAddContentModal(sectionId, itemData);
                });
            }
            document.getElementById('deleteItemBtn')?.addEventListener('click', () => {
                window.openDeleteModal(sectionId, itemId, itemData.title);
            });
        }

        document.getElementById('printItemBtn').addEventListener('click', () => window.print());
        document.getElementById('downloadPdfItemBtn').addEventListener('click', () => downloadItemAsPDF(itemData));

        // Feedback logic
        const feedbackPrompt = document.getElementById('feedbackPrompt');
        const rateYesBtn = document.getElementById('rateYesBtn');
        const rateNoBtn = document.getElementById('rateNoBtn');
        const ratingButtons = document.getElementById('ratingButtons');
        const negativeFeedbackForm = document.getElementById('negativeFeedbackForm');

        const existingFeedback = itemData.feedback?.find(f => f.userId === currentUser.id);
        if (existingFeedback) {
            ratingButtons.innerHTML = 'Thank you for your feedback!';
        } else {
            rateYesBtn.addEventListener('click', () => {
                itemData.feedback = itemData.feedback || [];
                itemData.feedback.push({ type: 'positive', userId: currentUser.id, timestamp: new Date().toISOString() });
                saveDataToLocalStorage();
                ratingButtons.innerHTML = 'Thank you for your feedback!';
                showToast('Feedback received!', 'success');
            });

            rateNoBtn.addEventListener('click', () => {
                ratingButtons.classList.add('hidden');
                negativeFeedbackForm.classList.remove('hidden');
                negativeFeedbackForm.querySelector('textarea').focus();
                feedbackPrompt.textContent = 'Please tell us how we can improve:';
            });
            
            document.getElementById('cancelNegativeFeedbackBtn').addEventListener('click', () => {
                negativeFeedbackForm.classList.add('hidden');
                ratingButtons.classList.remove('hidden');
                feedbackPrompt.textContent = 'Was this article helpful?';
            });

            negativeFeedbackForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const reason = document.getElementById('feedbackReason').value.trim();
                if (reason) {
                    itemData.feedback = itemData.feedback || [];
                    itemData.feedback.push({ type: 'negative', reason: reason, userId: currentUser.id, timestamp: new Date().toISOString() });
                    saveDataToLocalStorage();
                    document.getElementById('feedbackInteractionContainer').innerHTML = '<h4>Thank you for your feedback!</h4><p>We will review your comments to improve this article.</p>';
                    showToast('Feedback received, we will review it.', 'info');
                } else {
                    showToast('Please provide a reason.', 'error');
                }
            });
        }


        // Comments logic
        document.getElementById('postCommentBtn').addEventListener('click', () => {
            const commentTextEl = document.getElementById('newCommentText');
            const commentText = commentTextEl.value.trim();
            if (!commentText) {
                showToast('Please enter a note.', 'error');
                return;
            }
            if (!itemData.comments) itemData.comments = [];
            itemData.comments.push({
                id: `cmt_${Date.now()}`,
                authorId: currentUser.id,
                authorName: currentUser.name,
                text: commentText, 
                timestamp: new Date().toISOString()
            });
            saveDataToLocalStorage();
            renderComments(itemData, 'commentDisplayAreaForItem'); 
            commentTextEl.value = ''; 
        });
    }
    
    function renderComments(itemData, containerId) {
        const container = document.getElementById(containerId);
        if (!container) return;

        if (!itemData.comments || itemData.comments.length === 0) {
            container.innerHTML = `<p style="text-align:center; color: var(--text-color-muted); padding: 1rem;">No notes yet. Be the first to add one!</p>`;
            return;
        }

        let commentsHTML = '';
        const sortedComments = [...itemData.comments].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
        const userAvatars = { [currentUser.id]: currentUser.avatar_url }; // Simple cache

        sortedComments.forEach(comment => {
            if(!userAvatars[comment.authorId]) {
                 userAvatars[comment.authorId] = `https://ui-avatars.com/api/?name=${encodeURIComponent(comment.authorName || 'A')}&background=random&color=fff&rounded=true&font-size=0.5`;
            }

            commentsHTML += `
                <div class="comment" data-comment-id="${comment.id}">
                    <img src="${userAvatars[comment.authorId]}" alt="${escapeHTML(comment.authorName)}'s avatar">
                    <div class="comment-content">
                        <div class="comment-header">
                            <span class="comment-author">${escapeHTML(comment.authorName)}</span>
                            <span class="comment-timestamp">${new Date(comment.timestamp).toLocaleString()}</span>
                        </div>
                        <div class="comment-text">${escapeHTML(comment.text).replace(/\n/g, '<br>')}</div>
                    </div>
                </div>
            `;
        });
        container.innerHTML = commentsHTML;
    }


    const contentTemplates = {
        standard_article: {
            type: 'article',
            titlePrefix: 'New Article: ',
            summary: 'A general article about [topic].',
            content: '<h2>Introduction</h2><p>[Provide a brief introduction to the topic.]</p><h2>Main Content</h2><p>[Elaborate on the main points here. You can use lists, paragraphs, etc.]</p><ul><li>Point 1</li><li>Point 2</li></ul><h2>Conclusion</h2><p>[Summarize the key takeaways.]</p>',
            tags: ['article']
        },
        troubleshooting_guide: {
            type: 'case', 
            titlePrefix: 'Case: Troubleshooting ',
            summary: 'A step-by-step guide to resolve [issue].',
            content: '<h3>Issue Description</h3><p>[Clearly describe the problem or issue this guide addresses.]</p><h3>Symptoms</h3><ul><li>[Symptom 1]</li><li>[Symptom 2]</li></ul><h3>Resolution Steps</h3><ol><li><strong>Step 1:</strong> [Action to take]</li><li><strong>Step 2:</strong> [Another action]</li></ol><h3>Verification</h3><p>[How to verify the issue is resolved.]</p>',
            tags: ['troubleshooting', 'guide', 'case']
        },
        policy_document: {
            type: 'policy',
            titlePrefix: 'Policy: ',
            summary: 'Official policy regarding [subject matter].',
            content: '<h1>[Policy Title]</h1><p><strong>Version:</strong> 1.0</p><p><strong>Effective Date:</strong> [Date]</p><h2>1. Purpose</h2><p>[State the purpose of this policy.]</p><h2>2. Scope</h2><p>[Define who this policy applies to.]</p><h2>3. Policy Statement</h2><p>[Detail the policy rules and guidelines.]</p>',
            tags: ['policy', 'official']
        },
         blank: {
            type: 'article', 
            titlePrefix: '',
            summary: '',
            content: '<p><br></p>', 
            tags: []
        }
    };

    /**
     * ✅ NEW: Safely retrieves the editable HTML content from a knowledge base item.
     * It checks for common content properties in a specific order to handle various item types.
     * @param {object} item - The knowledge base item.
     * @returns {string} The HTML content string or an empty paragraph for the editor.
     */
    function getEditableContent(item) {
        if (!item) return '<p><br></p>';
        // The order of checks is important. 'content' is the primary property.
        if (typeof item.content === 'string') return item.content;
        if (typeof item.resolution_steps === 'string') return item.resolution_steps;
        if (typeof item.body === 'string') return item.body;
        // Default empty content for Quill, ensures the editor is never null.
        return '<p><br></p>';
    }

    function applyTemplate(templateKey) {
        const template = contentTemplates[templateKey];
        if (!template) return;

        contentTypeSelect.value = template.type;
        document.getElementById('contentTitle').value = template.titlePrefix;
        document.getElementById('contentSummary').value = template.summary;
        if (mainQuillEditor) mainQuillEditor.root.innerHTML = template.content;
        contentTagsInput.value = template.tags.join(', ');
        
        addContentForm.classList.remove('hidden');
        templateSelectionContainer.classList.add('hidden');
        contentTypeSelect.dispatchEvent(new Event('change')); 
        document.getElementById('contentTitle').focus();
    }


    // --- Add/Edit Content Modal Logic ---
    function openAddContentModal(sectionIdForContent, itemToEdit = null) {
        addContentForm.dataset.sectionId = sectionIdForContent;
        
        if (!mainQuillEditor) {
            mainQuillEditor = new Quill('#quillEditor', { 
                theme: 'snow',
                modules: { 
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ 'color': [] }, { 'background': [] }],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['link', 'image', 'video', 'blockquote', 'code-block'], 
                        ['clean']
                    ]
                },
                placeholder: 'Enter detailed content here...'
            });
        }
        
        if (itemToEdit) {
            // Editing an item: pre-fill the form with data from the 'itemToEdit' object.
            document.getElementById('addContentModalTitle').textContent = 'Edit Content';
            editingItemIdInput.value = itemToEdit.id;
            
            // Core fields with fallbacks to prevent errors.
            document.getElementById('contentTitle').value = itemToEdit.title || '';
            document.getElementById('contentSummary').value = itemToEdit.summary || '';
            contentTypeSelect.value = itemToEdit.type || 'article';
            contentTagsInput.value = (itemToEdit.tags || []).join(', ');
            
            // ✅ MODIFIED: Use the new robust function to get content for the editor.
            const contentToEdit = getEditableContent(itemToEdit);
            mainQuillEditor.root.innerHTML = contentToEdit;
            
            // Link fields with fallbacks
            document.getElementById('contentUrl').value = itemToEdit.url || '';
            document.getElementById('videoLink').value = itemToEdit.videoLink || '';
            document.getElementById('driveLink').value = itemToEdit.driveLink || '';
            
            // Note: File inputs cannot be programmatically set for security reasons.
            document.getElementById('pdfFile').value = '';
            document.getElementById('imageFile').value = '';
            
            templateSelectionContainer.classList.add('hidden');
            addContentForm.classList.remove('hidden');

        } else {
            // New item: reset everything and show templates.
            addContentForm.reset();
            editingItemIdInput.value = ""; 
            mainQuillEditor.root.innerHTML = '<p><br></p>'; 
            document.getElementById('addContentModalTitle').textContent = 'Add New Content';
            templateSelectionContainer.classList.remove('hidden');
            addContentForm.classList.add('hidden');
        }
        
        contentTypeSelect.dispatchEvent(new Event('change'));
        addContentModalOverlay.classList.remove('hidden');
    }

    document.querySelectorAll('.template-button').forEach(button => {
        button.addEventListener('click', () => applyTemplate(button.dataset.template));
    });


    function closeAddContentModal() {
        addContentModalOverlay.classList.add('hidden');
        templateSelectionContainer.classList.add('hidden'); 
        addContentForm.classList.add('hidden'); 
        editingItemIdInput.value = ""; 
    }

    contentTypeSelect.addEventListener('change', (e) => {
        const type = e.target.value;
        contentUrlContainer.classList.toggle('hidden', !['form_sheet', 'design'].includes(type));
        contentDetailContainer.classList.toggle('hidden', ['form_sheet', 'design'].includes(type));
        if (type === 'case') contentDetailLabel.textContent = 'Case Details / Resolution Steps';
        else contentDetailLabel.textContent = 'Content';
    });

    addContentForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const sectionId = addContentForm.dataset.sectionId;
        const section = kbSystemData.sections.find(s => s.id === sectionId);
        if (!section) { showToast('Error: Target section not found!', 'error'); return; }
        
        const editingId = editingItemIdInput.value;
        const commonData = {
            type: contentTypeSelect.value,
            title: document.getElementById('contentTitle').value.trim(),
            summary: document.getElementById('contentSummary').value.trim(),
            tags: contentTagsInput.value.split(',').map(t => t.trim()).filter(Boolean),
            videoLink: document.getElementById('videoLink').value.trim(),
            driveLink: document.getElementById('driveLink').value.trim(),
        };
        if (!commonData.title || !commonData.summary) {
            showToast('Title and Summary are required.', 'error'); return;
        }

        let itemData;
        if (editingId) {
            itemData = section.items.find(i => i.id === editingId);
            if (!itemData) {
                showToast('Error: Item to edit not found!', 'error');
                return;
            }
            // Update existing item
            Object.assign(itemData, commonData);
            itemData.lastModified = new Date().toISOString();
            itemData.version = parseFloat(((itemData.version || 1.0) + 0.1).toFixed(1));
        } else {
            // Create new item
            const now = new Date().toISOString();
            itemData = {
                ...commonData,
                id: `${sectionId}_item_${Date.now()}`,
                createdBy: currentUser.email,
                createdAt: now,
                lastModified: now,
                version: 1.0,
                views: 0,
                comments: [],
                feedback: []
            };
        }

        // ✅ MODIFIED: Handle content based on type for both new and edited items,
        // and consolidate properties to `content` for data consistency.
        if (['article', 'guide', 'policy', 'case'].includes(itemData.type)) {
            itemData.content = mainQuillEditor.root.innerHTML;
            // Clean up old, alternative properties if they exist
            if (itemData.hasOwnProperty('resolution_steps')) delete itemData.resolution_steps;
            if (itemData.hasOwnProperty('body')) delete itemData.body;
        } else if (['form_sheet', 'design'].includes(itemData.type)) {
            itemData.url = document.getElementById('contentUrl').value.trim();
            if (!itemData.url) { showToast('A URL is required for this type.', 'error'); return; }
            // Remove content property if it exists on a link-type item
            if (itemData.hasOwnProperty('content')) delete itemData.content;
        }

        // Add to section if it's a new item
        if (!editingId) {
            if (!section.items) section.items = [];
            section.items.push(itemData);
            kbSystemData.meta.lastArticleAdded = { title: itemData.title, date: new Date().toLocaleDateString() };
        }

        saveDataToLocalStorage();
        showToast(`Content '${itemData.title}' ${editingId ? 'updated' : 'saved'}!`, 'success');
        closeAddContentModal();
        
        // Refresh the view to show changes
        const newHash = editingId ? `#${sectionId}/${editingId}` : `#${sectionId}`;
        if (window.location.hash === newHash) {
            handleNavigation(); // Force re-render if hash doesn't change
        } else {
            window.location.hash = newHash;
        }
    });
    
    // --- Global Modal Triggers ---
    window.openEditModal = (sectionId, itemId) => {
        const section = kbSystemData.sections.find(s => s.id === sectionId);
        const item = section?.items.find(i => i.id === itemId);
        if (item) {
            openAddContentModal(sectionId, item);
        } else {
            showToast('Error: Could not find item to edit.', 'error');
        }
    };
    window.openDeleteModal = (sectionId, itemId, itemTitle) => {
        openDeleteConfirmModal(sectionId, itemId, itemTitle);
    };


    // --- Other Modals Logic (Delete, Feedback, etc) ---
    function openDeleteConfirmModal(sectionId, itemId, itemTitle) {
        deleteConfirmMessage.innerHTML = `Are you sure you want to delete "<strong>${escapeHTML(itemTitle)}</strong>"? This cannot be undone.`;
        confirmDeleteItemBtn.dataset.sectionId = sectionId;
        confirmDeleteItemBtn.dataset.itemId = itemId;
        deleteConfirmModalOverlay.classList.remove('hidden');
    }
    confirmDeleteItemBtn.addEventListener('click', () => {
        const sectionId = confirmDeleteItemBtn.dataset.sectionId;
        const itemId = confirmDeleteItemBtn.dataset.itemId;
        const section = kbSystemData.sections.find(s => s.id === sectionId);
        if (section?.items) {
            const itemIndex = section.items.findIndex(item => item.id === itemId);
            if (itemIndex > -1) {
                const deletedItemTitle = section.items[itemIndex].title;
                section.items.splice(itemIndex, 1);
                saveDataToLocalStorage();

                const cardToRemove = document.querySelector(`.card[data-item-id="${itemId}"]`);
                if (cardToRemove) {
                    cardToRemove.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                    cardToRemove.style.transform = 'scale(0.95)';
                    cardToRemove.style.opacity = '0';
                    setTimeout(() => cardToRemove.remove(), 300);
                }

                showToast(`Item "${deletedItemTitle}" deleted.`, 'success');
                deleteConfirmModalOverlay.classList.add('hidden');
                
                if (window.location.hash.includes('/')) {
                    window.location.hash = `#${sectionId}`;
                }
            }
        }
    });

    closeDeleteConfirmModalBtn.addEventListener('click', () => deleteConfirmModalOverlay.classList.add('hidden'));
    cancelDeleteItemBtn.addEventListener('click', () => deleteConfirmModalOverlay.classList.add('hidden'));
    
    // Global Search
    globalSearchInput.addEventListener('input', () => {
        const query = globalSearchInput.value.trim().toLowerCase();
        if (query.length < 2) {
            searchResultsContainer.classList.add('hidden'); return;
        }
        const results = [];
        kbSystemData.sections.forEach(s => {
            s.items?.forEach(i => {
                if (i.title.toLowerCase().includes(query) || stripHtml(i.summary).toLowerCase().includes(query) || (i.tags && i.tags.some(tag => tag.toLowerCase().includes(query)))) {
                    results.push({ ...i, sectionId: s.id, sectionName: s.name });
                }
            });
        });
        searchResultsContainer.innerHTML = '';
        if (results.length) {
            results.slice(0, 7).forEach(r => {
                const linkEl = document.createElement('a');
                linkEl.href = `#${r.sectionId}/${r.id}`;
                linkEl.addEventListener('click', () => { searchResultsContainer.classList.add('hidden'); globalSearchInput.value = ''; });
                linkEl.innerHTML = `<div style="font-weight: bold;">${highlightText(r.title, query)} <span style="font-size: 0.8em; color: var(--text-color-muted); margin-left: 5px;">(${escapeHTML(r.sectionName)})</span></div>
                                    <p style="font-size: 0.9em; color: var(--text-color-subtle); margin: 0;">${highlightText(truncateText(stripHtml(r.summary), 70), query)}</p>`;
                searchResultsContainer.appendChild(linkEl);
            });
            searchResultsContainer.classList.remove('hidden');
        } else {
            searchResultsContainer.innerHTML = `<div style="padding: 10px; color: var(--text-color-muted);">No results found.</div>`;
            searchResultsContainer.classList.remove('hidden');
        }
    });
    document.addEventListener('click', e => {
        if (!globalSearchInput.contains(e.target)) searchResultsContainer.classList.add('hidden');
    });
    
    // --- Routing and Initialization ---
    function handleNavigation() {
        if (!currentUser) return;
        const hash = window.location.hash.substring(1) || 'home';
        const [sectionId, itemId] = hash.split('/');
        
        highlightSidebarLink(sectionId);

        if (sectionId === 'home') displayDashboard();
        else if (itemId) displayItemDetail(sectionId, itemId);
        else if (sectionId) displaySectionContent(sectionId);
        else displayDashboard(); 

        document.getElementById('contentWrapper')?.scrollTo(0,0);
    }

    async function initializeApp() {
        currentUser = await Auth.getCurrentUserProfile(); 
        if (!currentUser) return;

        userNameDisplayHeader.textContent = currentUser.name;
        userAvatar.src = currentUser.avatar_url;
        currentUserRoleSpan.textContent = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
        
        populateSidebar();
        applyPermanentDarkMode(); 
        handleNavigation(); 

        window.addEventListener('hashchange', handleNavigation);
        
        logoutButton.addEventListener('click', () => logoutConfirmModalOverlay.classList.remove('hidden'));
        closeLogoutConfirmModalBtn.addEventListener('click', () => logoutConfirmModalOverlay.classList.add('hidden'));
        cancelLogoutBtn.addEventListener('click', () => logoutConfirmModalOverlay.classList.add('hidden'));
        confirmLogoutBtn.addEventListener('click', Auth.logout);
        
        closeAddContentModalBtn.addEventListener('click', closeAddContentModal);
        cancelAddContentBtn.addEventListener('click', closeAddContentModal);
        
        if (localStorage.getItem('justLoggedIn') === 'true') {
            showToast(`Welcome back, ${currentUser.name}!`, 'success', 4000);
            localStorage.removeItem('justLoggedIn');
        } else {
            showToast(`InfiniBase is ready.`, 'info', 2000);
        }
    }

    initializeApp();

</script>
</body>
</html>
