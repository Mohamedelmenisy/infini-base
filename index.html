<!DOCTYPE html>
<html lang="en" dir="ltr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InfiniBase - Knowledge Base</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236366f1' width='64' height='64'><path d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z'/></svg>">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>

    <style>
        :root {
            --primary-color: #6366f1; 
            --primary-color-hover: #4f46e5;
            
            --text-color: #f1f5f9; /* New */
            --text-color-muted: #94a3b8; /* New */
            --text-color-inverted: #111827; 
            --text-color-subtle: #94a3b8; /* New - aliased to muted */

            --bg-color: #111827; 
            --bg-color-alt: #1f2937; /* New - For cards/modals */
            --bg-color-sidebar: #1f2937; /* New - For sidebar */
            --bg-color-header: rgba(17, 24, 39, 0.85); /* Updated to match --bg-color with alpha */
            --bg-color-modal: #1f2937; /* New */
            --bg-color-hover: #374151; /* New */
            --bg-color-active: var(--primary-color);

            --border-color: #334155; /* New */
            --border-color-darker: #4b5563; /* Will be less distinct from new border-color, adjust if needed */
            /* For consistency, perhaps make border-color-darker a slightly darker shade of #334155 or use border-color directly for most cases */

            --card-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            --card-hover-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            
            --border-radius: 0.5rem; 
            --border-radius-lg: 0.75rem;
            --header-height: 70px;
            --sidebar-width: 260px;
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            line-height: 1.6;
            font-size: 16px;
        }

        .container-fluid {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-color-sidebar);
            padding: 1.5rem;
            border-right: 1px solid var(--border-color); /* LTR */
            position: fixed;
            top: 0;
            left: 0; /* LTR */
            height: 100vh;
            overflow-y: auto;
            transition: transform 0.3s ease-in-out, background-color 0.3s ease, border-color 0.3s ease;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }
        .sidebar.closed {
            transform: translateX(-100%); /* LTR */
        }
        @media (min-width: 768px) {
            .sidebar.closed { transform: translateX(0); } 
        }

        .sidebar-header {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            color: var(--text-color); 
        }
        .sidebar-header i { 
            margin-right: 0.75rem; /* LTR */
            color: var(--primary-color);
            font-size: 1.8rem;
        }
        .sidebar-logo-text {
             color: var(--text-color);
        }

        .sidebar-nav { flex-grow: 1; }

        .sidebar-section-title {
            padding-left: 0.75rem; /* LTR */
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--text-color-muted);
        }

        .sidebar-link {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-radius: var(--border-radius);
            transition: background-color 0.2s ease, color 0.2s ease;
            font-weight: 500;
            color: var(--text-color-subtle);
            text-decoration: none;
            margin-bottom: 0.25rem;
        }
        .sidebar-link i {
            margin-right: 0.75rem; /* LTR */
            width: 1.25rem;
            text-align: center;
            color: var(--text-color-muted); 
            transition: color 0.2s ease;
        }
        .sidebar-link:hover {
            background-color: var(--bg-color-hover);
            color: var(--text-color);
        }
        .sidebar-link:hover i {
            color: var(--primary-color);
        }
        .sidebar-link.active {
            background-color: var(--bg-color-active);
            color: var(--text-color-inverted) !important; /* White text on primary bg */
            font-weight: 600;
            box-shadow: 0 2px 10px rgba(99, 102, 241, 0.3); /* primary-color with alpha */
        }
        .sidebar-link.active i {
            color: var(--text-color-inverted) !important; /* White icon on primary bg */
        }

        .sidebar-footer {
            margin-top: auto; 
            padding-top: 1rem;
        }
        .sidebar-footer button {
            width: 100%;
            margin-top: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sidebar-footer button i { margin-right: 0.5rem; }


        .content-wrapper {
            flex-grow: 1;
            padding-right: 1.5rem; /* LTR */
            padding-left: 1.5rem;
            transition: margin-left 0.3s ease-in-out; /* LTR */
            height: 100vh;
            overflow-y: auto;
        }
        @media (min-width: 768px) {
             .content-wrapper { margin-left: var(--sidebar-width); /* LTR */ }
        }

        .content-header {
            background-color: var(--bg-color-header);
            padding: 1.25rem 2rem; 
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky; 
            top: 0;
            left: var(--sidebar-width); 
            right: 0;
            height: var(--header-height);
            z-index: 50;
            backdrop-filter: blur(8px); 
        }
         @media (max-width: 767px) { 
            .content-header {
                left: 0;
            }
        }
        .header-left-content { display: flex; align-items: center; } 
        #currentSectionTitle {
            font-size: 1.5rem; 
            font-weight: bold;
            margin: 0;
            color: var(--text-color);
        }
        #breadcrumbs {
            font-size: 0.875rem; 
            color: var(--text-color-muted);
            margin-top: 0.25rem;
        }
        #breadcrumbs a { color: var(--primary-color); text-decoration: none; }
        #breadcrumbs a:hover { text-decoration: underline; }

        .header-right-content { display: flex; align-items: center; gap: 1rem; }
        .search-container { position: relative; }
        .search-container input[type="search"] {
            padding: 0.625rem 1rem 0.625rem 2.5rem; 
            border: 1px solid var(--border-color); /* Use main border color */
            border-radius: 9999px; 
            min-width: 250px; 
            background-color: var(--bg-color); /* Darker than card for input */
            color: var(--text-color);
        }
         .search-container input[type="search"]:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.4);
        }
        .search-container .search-icon {
            position: absolute;
            inset-inline-start: 0.75rem; 
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-color-muted);
        }
        #searchResultsContainer {
            position: absolute;
            background-color: var(--bg-color-alt);
            border: 1px solid var(--border-color);
            border-top: none;
            width: 100%; 
            max-height: 300px; 
            overflow-y: auto;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); 
            z-index: 60; 
            border-radius: 0 0 var(--border-radius) var(--border-radius);
        }
        #searchResultsContainer a {
            display: block;
            padding: 0.75rem; 
            text-decoration: none;
            color: var(--text-color);
        }
        #searchResultsContainer a:hover { background-color: var(--bg-color-hover); }
        #searchResultsContainer mark { background-color: #a55221; color: var(--text-color); } /* Adjusted mark for better contrast on dark */


        .user-profile { display: flex; align-items: center; gap: 0.5rem; }
        .user-profile img { width: 36px; height: 36px; border-radius: 50%; }
        #userNameDisplayHeader { font-weight: 500; color: var(--text-color); }
        @media (max-width: 640px) { 
            #userNameDisplayHeader { display: none; }
        }

        main { padding: 1.5rem 0; }

        .card {
            background-color: var(--bg-color-alt);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg); 
            padding: 1.5rem;
            margin-bottom: 1.5rem; 
            box-shadow: var(--card-shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease, border-color 0.3s ease;
            display: flex;
            flex-direction: column; 
            min-height: 150px; 
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--card-hover-shadow);
            background-color: var(--bg-color-hover); /* Added hover bg for card */
        }
        .card-header-icon {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .card-icon-container {
            padding: 0.75rem;
            border-radius: 50%;
            margin-right: 1rem; /* LTR */
            background-color: var(--primary-color); /* Updated to primary */
        }
        .card-icon-container i {
            font-size: 1.25rem;
            color: var(--text-color-inverted);  /* White on primary */
        }
        .card h3 { margin-top: 0; font-size: 1.125rem; font-weight: 600; color: var(--text-color); line-height: 1.3; }
        .card p { margin-bottom: 1rem; font-size: 0.875rem; color: var(--text-color-subtle); flex-grow: 1; }
        .card .item-meta-info {
            margin-top: auto; 
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border-color);
        }
        .card .item-cta-link {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500; 
            font-size: 0.875rem;
        }
        .card .item-cta-link:hover { text-decoration: underline; color: var(--primary-color-hover); }
        .item-type-badge {
            font-size: 0.75rem; 
            padding: 0.25rem 0.75rem; 
            border-radius: 9999px; 
            background-color: var(--bg-color); /* Darker than card bg */
            color: var(--text-color-subtle); 
            font-weight: 600; 
            text-transform: uppercase;
        }
        .card-tags span {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 10px;
            background-color: var(--bg-color); /* Darker than card bg */
            color: var(--text-color-subtle);
            display: inline-block;
            margin: 0 5px 5px 0; /* LTR */
        }

        .sub-item-list { margin-top: 1rem; padding-left: 1rem; border-left: 2px solid var(--primary-color); }
        .sub-item-list h5 { font-size: 0.9rem; color: var(--text-color-muted); margin-bottom: 0.25rem;}
        .sub-item-list ul { list-style: none; padding-left: 0; }
        .sub-item-list li a { color: var(--primary-color); font-size: 0.85rem; text-decoration: none; }
        .sub-item-list li a:hover { text-decoration: underline; }


        .button, button {
            background-color: var(--primary-color);
            color: var(--text-color-inverted); /* Ensuring white on primary */
            border: 1px solid transparent;
            padding: 0.625rem 1rem; 
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.875rem; 
            font-weight: 500; 
            transition: background-color 0.2s, border-color 0.2s, color 0.2s;
            text-decoration: none; 
            display: inline-flex; 
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .button:hover, button:hover {
            background-color: var(--primary-color-hover);
        }
        .button-secondary {
            background-color: transparent;
            color: var(--text-color-subtle);
            border-color: var(--border-color); /* Use main border color */
        }
        .button-secondary:hover { background-color: var(--bg-color-hover); color: var(--text-color); }
        .button-danger {
            background-color: #dc2626; /* Red-600 */
            color: var(--text-color-inverted); /* White */
        }
        .button-danger:hover { background-color: #b91c1c; /* Red-700 */ }
        input:focus, button:focus, select:focus, textarea:focus, a:focus { 
            outline: 2px solid transparent;
            outline-offset: 2px;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.6); /* primary-color with alpha */
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.75); 
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.2s ease-out;
        }
        .modal-overlay:not(.hidden) { opacity: 1; }
        .modal-content {
            background-color: var(--bg-color-modal);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 48rem; 
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.95);
            opacity: 0;
            transition: transform 0.2s ease-out, opacity 0.2s ease-out, background-color 0.3s ease, border-color 0.3s ease;
        }
        .modal-overlay:not(.hidden) .modal-content { transform: scale(1); opacity: 1; }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem; 
            border-bottom: 1px solid var(--border-color); /* Added border */
            padding-bottom: 1rem; /* Added padding */
        }
        .modal-header h2 { margin-top: 0; font-size: 1.5rem; font-weight: 700; color: var(--text-color); }
        .modal-header .close-button { 
            background: none; border: none; font-size: 1.5rem; color: var(--text-color-muted); cursor: pointer;
            padding: 0.25rem; line-height: 1; border-radius: 50%;
        }
        .modal-header .close-button:hover { background-color: var(--bg-color-hover); color: var(--text-color); }
        
        .modal-actions {
            margin-top: 1.5rem; 
            text-align: right; /* LTR */
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end; /* LTR */
            gap: 0.75rem; 
        }

        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.25rem; font-weight: 500; font-size: 0.875rem; color: var(--text-color-subtle); }
        .form-group input[type="text"],
        .form-group input[type="url"],
        .form-group input[type="file"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.625rem; 
            border: 1px solid var(--border-color); 
            border-radius: var(--border-radius);
            box-sizing: border-box;
            background-color: var(--bg-color); 
            color: var(--text-color);
        }
         .form-group input::placeholder, .form-group textarea::placeholder {
            color: var(--text-color-muted);
        }
        .form-group select option {
            background-color: var(--bg-color-alt);
            color: var(--text-color);
        }
        .form-group textarea { min-height: 100px; }
        
        .ql-toolbar {
            background: var(--bg-color);
            border-color: var(--border-color) !important;
            border-top-left-radius: var(--border-radius);
            border-top-right-radius: var(--border-radius);
        }
        .ql-toolbar .ql-stroke { stroke: var(--text-color-muted); }
        .ql-toolbar .ql-fill { fill: var(--text-color-muted); }
        .ql-toolbar .ql-picker-label { color: var(--text-color-muted); }
        .ql-snow .ql-picker.ql-expanded .ql-picker-options { background-color: var(--bg-color-alt); border-color: var(--border-color); }
        .ql-snow .ql-picker-options .ql-picker-item:hover { color: var(--primary-color); }


        .ql-container {
            background: var(--bg-color); /* Consistent with other inputs */
            border-color: var(--border-color) !important;
            color: var(--text-color);
            min-height: 150px; 
            border-bottom-left-radius: var(--border-radius);
            border-bottom-right-radius: var(--border-radius);
            font-size: 1rem;
        }
        .ql-editor { padding: 12px; }
        .ql-editor.ql-blank::before{ color: var(--text-color-muted); }


        footer {
            text-align: center;
            padding: 1.5rem;
            font-size: 0.875rem;
            color: var(--text-color-muted);
            border-top: 1px solid var(--border-color);
            margin-top: auto; 
        }
        #reportErrorBtn {
            margin-left: 1rem; /* LTR */
            color: #f87171; /* Tailwind red-400 for better visibility on dark */
            background: none; border: none; padding: 0; text-decoration: underline;
            font-size: 0.75rem; 
        }
         #reportErrorBtn:hover { color: #ef4444; } /* Tailwind red-500 */

        .mobile-sidebar-toggle {
            display: block;
            position: fixed;
            top: calc((var(--header-height) - 40px) / 2); 
            left: 1.5rem; /* LTR */
            z-index: 101; 
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 0.75rem; 
            border-radius: var(--border-radius);
            font-size: 1.25rem; 
            line-height: 1;
        }
        @media (min-width: 768px) {
            .mobile-sidebar-toggle { display: none; }
            .header-left-content #currentSectionTitle { margin-left: 0; } 
        }
        @media (max-width: 767px) {
            .header-left-content #currentSectionTitle { margin-left: 0.5rem; } 
            .content-header { padding: 1rem; }
            .header-right-content .search-container { display:none; } 
        }

        .toast-notification {
            position: fixed;
            bottom: 20px;
            right: 20px; /* LTR */
            padding: 12px 18px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 2000; 
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            display: flex;
            align-items: center;
            background-color: var(--bg-color-alt); 
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }
        .toast-notification.show { opacity: 1; transform: translateY(0); }
        .toast-icon { margin-right: 10px; /* LTR */ font-size: 1.2em; }
        .toast-success { background-color: #10b981; color: white; border-color: #059669; } /* Green-500, Green-600 */
        .toast-error { background-color: #ef4444; color: white; border-color: #dc2626; } /* Red-500, Red-600 */
        .toast-info { background-color: #3b82f6; color: white; border-color: #2563eb; } /* Blue-500, Blue-600 */
        .toast-logout { background-color: var(--primary-color); color: var(--text-color-inverted); border-color: var(--primary-color-hover); } /* Using primary for logout, as requested "blue or purple" */


        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 1.5rem; 
        }

        .kb-content h1, .kb-content h2, .kb-content h3 { margin-top: 1.5em; margin-bottom: 0.5em; color: var(--text-color); }
        .kb-content p { margin-bottom: 1em; color: var(--text-color-subtle); } /* Lighten default p color */
        .kb-content ul, .kb-content ol { margin-bottom: 1em; padding-left: 20px; /* LTR */ color: var(--text-color-subtle); }
        .kb-content li { margin-bottom: 0.5em; }
        .kb-content strong { font-weight: bold; color: var(--text-color); } /* Ensure strong is main text color */
        .kb-content em { font-style: italic; }
        .kb-content a { color: var(--primary-color); text-decoration: underline; }
        .kb-content pre {
            background-color: var(--bg-color);
            padding: 10px;
            border-radius: var(--border-radius);
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            border: 1px solid var(--border-color);
            color: var(--text-color); 
        }
         .kb-content code:not(pre code) { /* More specific for inline code */
            background-color: var(--bg-color-hover);
            padding: 0.2em 0.4em;
            margin: 0;
            font-size: 85%;
            border-radius: 3px;
            color: var(--text-color);
        }
        mark { /* Used by search highlight */
            padding: 0.1em 0.2em; border-radius: 0.2em; font-weight: bold;
            background-color: #a55221; color: var(--text-color); /* Adjusted mark for better contrast */
        }

        .hidden { display: none !important; }

        .chart-container {
            position: relative;
            padding: 1rem;
            border-radius: var(--border-radius-lg);
            background-color: var(--bg-color-alt);
            height: 320px; 
        }
        .chart-container h3 {
            font-size: 1.125rem; 
            font-weight: 600; 
            margin-bottom: 0.5rem;
            text-align: center;
            color: var(--text-color);
        }
        .mermaid-diagram-card { 
            background-color: var(--bg-color-alt);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--card-shadow);
            margin-bottom: 1.5rem;
        }
        .mermaid-diagram-card h3 {
            margin-top: 0;
            margin-bottom: 1rem;
            font-size: 1.25rem;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
            color: var(--text-color);
        }
        .mermaid-diagram-container {
            overflow-x: auto; 
            background-color: var(--bg-color-alt); 
            padding: 1rem 0;
        }
        .mermaid-diagram-container svg {
            display: block;
            margin: 0 auto; 
            max-width: 100%; /* ensure it doesn't overflow its container unnecessarily */
        }
        /* Mermaid dark theme overrides will be handled by mermaid.initialize themeVariables */


        /* Item Detail View Specific */
        #itemDetailViewPlaceholder .card {
            border-top: 4px solid var(--primary-color); 
        }
        #itemDetailViewPlaceholder .item-title-area {
            display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;
        }
        #itemDetailViewPlaceholder .item-title-area i { font-size: 2rem; color: var(--primary-color); }
        #itemDetailViewPlaceholder .item-title-area h2 { font-size: 1.8rem; margin:0; color: var(--text-color); }
        #itemDetailViewPlaceholder .item-summary { color: var(--text-color-subtle); margin-bottom: 1rem; font-style: italic; }
        #itemDetailViewPlaceholder hr { margin: 1.5rem 0; border-color: var(--border-color); }
         #itemDetailViewPlaceholder .sub-content-heading {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-color);
            margin-top: 2rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        #itemDetailViewPlaceholder .sub-content-list ul {
            list-style: none;
            padding-left: 0;
        }
        #itemDetailViewPlaceholder .sub-content-list li {
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            background-color: var(--bg-color);
            border-radius: var(--border-radius);
            border-left: 3px solid var(--primary-color);
        }
        #itemDetailViewPlaceholder .sub-content-list li a {
            color: var(--text-color);
            text-decoration: none;
            font-weight: 500;
        }
        #itemDetailViewPlaceholder .sub-content-list li a:hover {
            color: var(--primary-color);
        }


        /* Dashboard specific styles */
        .dashboard-stat-card {
            background-color: var(--bg-color-alt);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--card-shadow);
            text-align: center;
        }
        .dashboard-stat-card i {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 0.75rem;
        }
        .dashboard-stat-card .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            display: block;
            margin-bottom: 0.25rem;
            color: var(--text-color);
        }
        .dashboard-stat-card .stat-label {
            font-size: 0.875rem;
            color: var(--text-color-muted);
        }
        .dashboard-quicklink-card {
             background-color: var(--bg-color-alt);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--card-shadow);
        }
         .dashboard-quicklink-card h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-color);
        }
        .dashboard-quicklink-card ul {
            list-style: none;
            padding: 0;
        }
        .dashboard-quicklink-card ul li a {
            display: block;
            padding: 0.5rem 0;
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
        }
         .dashboard-quicklink-card ul li a:hover {
            text-decoration: underline;
            color: var(--primary-color-hover);
        }
        .dashboard-quicklink-card p { color: var(--text-color-subtle); }

    </style>
</head>
<body>

    <div id="addContentModalOverlay" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="addContentModalTitle">Add New Content</h2>
                <button id="closeAddContentModalBtn" class="close-button" aria-label="Close">×</button>
            </div>
            <form id="addContentForm">
                <div class="form-group">
                    <label for="contentType">Content Type</label>
                    <select id="contentType">
                        <option value="article">Article</option>
                        <option value="case">Case</option>
                        <option value="form_sheet">Form/Sheet (Link)</option>
                        <option value="design">Design (Link)</option>
                        <option value="guide">Guide</option>
                        <option value="policy">Policy</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="contentTitle">Title</label>
                    <input type="text" id="contentTitle" required>
                </div>
                <div class="form-group">
                    <label for="contentSummary">Summary / Description</label>
                    <textarea id="contentSummary" rows="3" required></textarea>
                </div>
                
                <div class="form-group hidden" id="contentUrlContainer">
                    <label for="contentUrl">Link (for Forms, Designs, etc.)</label>
                    <input type="url" id="contentUrl" placeholder="https://example.com">
                </div>

                <div class="form-group" id="contentDetailContainer">
                    <label for="contentDetail" id="contentDetailLabel">Details / Content</label>
                    <div id="quillEditor"></div> 
                </div>

                <div class="form-group">
                    <label for="contentTags">Tags (comma-separated)</label>
                    <input type="text" id="contentTags" placeholder="e.g., important, update, billing">
                </div>

                <div class="form-group">
                    <label for="contentParentId">Parent Item ID (Optional - for sub-content)</label>
                    <input type="text" id="contentParentId" placeholder="Enter ID of parent item in this section">
                </div>

                <hr style="border-color: var(--border-color); margin: 1.5rem 0;">
                <h3 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-color);">Attachments (Optional)</h3>
                
                <div class="form-group">
                    <label for="pdfFile">Upload PDF</label>
                    <input type="file" id="pdfFile" accept=".pdf">
                </div>
                <div class="form-group">
                    <label for="imageFile">Upload Image</label>
                    <input type="file" id="imageFile" accept="image/*">
                </div>
                <div class="form-group">
                    <label for="videoLink">Video Link (e.g., YouTube, Vimeo)</label>
                    <input type="url" id="videoLink" placeholder="https://">
                </div>
                <div class="form-group">
                    <label for="driveLink">Google Drive Link</label>
                    <input type="url" id="driveLink" placeholder="https://docs.google.com/... or https://drive.google.com/...">
                </div>


                <div class="modal-actions">
                    <button type="submit" id="saveContentBtn" class="button"><i class="fas fa-save"></i> Save Content</button>
                    <button type="button" id="cancelAddContentBtn" class="button-secondary"><i class="fas fa-times"></i> Cancel</button>
                </div>
            </form>
        </div>
    </div>


    <div class="container-fluid">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-database"></i> <span class="sidebar-logo-text">InfiniBase</span>
            </div>
            <nav id="navigationMenu" class="sidebar-nav">
                <!-- Links will be dynamically generated -->
            </nav>
            <div class="sidebar-footer">
                <button id="logoutButton" class="button button-danger">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </aside>

        <div class="content-wrapper" id="contentWrapper">
            <header class="content-header">
                <div class="header-left-content">
                    <button id="mobileSidebarToggle" class="mobile-sidebar-toggle"><i class="fas fa-bars"></i></button>
                    <div>
                        <h1 id="currentSectionTitle">Welcome</h1>
                        <div id="breadcrumbs">Home</div>
                    </div>
                </div>
                <div class="header-right-content">
                    <div class="search-container">
                        <span class="search-icon"><i class="fas fa-search"></i></span>
                        <input type="search" id="globalSearchInput" placeholder="Search the knowledge base...">
                        <div id="searchResultsContainer" class="hidden"></div>
                    </div>
                    <div id="userProfileContainer" class="user-profile">
                        <img id="userAvatar" src="https://ui-avatars.com/api/?name=U&size=36&background=6366f1&color=fff&rounded=true" alt="User">
                        <span id="userNameDisplayHeader">User</span>
                    </div>
                </div>
            </header>

            <main id="pageContentArea" class="p-6 md:p-8">
                <div id="dashboardOverviewContainer" class="hidden">
                    <!-- Dashboard content will be injected here -->
                </div>
                <div id="standardSectionContentPlaceholder">
                    <!-- Section content will be injected here -->
                </div>
                <div id="itemDetailViewPlaceholder" class="hidden">
                    <!-- Item detail view -->
                </div>
            </main>

            <footer class="mt-auto p-6 text-center text-sm">
                <span>© <script>document.write(new Date().getFullYear())</script> InfiniBase. Version <span id="footerKbVersion">0.1.0</span></span>
                <button id="reportErrorBtn">Report an Issue</button>
            </footer>
        </div>
    </div>
    <div id="toastContainer"></div>

<script type="module">
    // --- Initialize Mermaid ---
    mermaid.initialize({ 
        startOnLoad: false,
        theme: 'dark', 
        fontFamily: 'Inter, sans-serif',
        flowchart: {
            htmlLabels: true,
            useMaxWidth: true,
        },
        themeVariables: { 
            primaryColor: getComputedStyle(document.documentElement).getPropertyValue('--bg-color-alt').trim(), 
            primaryTextColor: getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim(),
            primaryBorderColor: getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim(), 
            lineColor: getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim(), 
            textColor: getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim(),
            secondaryColor: getComputedStyle(document.documentElement).getPropertyValue('--bg-color').trim(), 
            tertiaryColor: getComputedStyle(document.documentElement).getPropertyValue('--bg-color-alt').trim(),
            background: getComputedStyle(document.documentElement).getPropertyValue('--bg-color-alt').trim(), 
            
            nodeBorder: getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim(),
            clusterBkg: getComputedStyle(document.documentElement).getPropertyValue('--bg-color').trim(), 
            clusterBorder: getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim(), // Updated to main border color
            defaultLinkColor: getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim(),
            edgeLabelBackground: getComputedStyle(document.documentElement).getPropertyValue('--bg-color-alt').trim(),
            // Ensure specific node text colors for readability if needed
            nodeTextColor: getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim(),
        }
    });
    
    // --- Simulated Auth & Data ---
    const Auth = {
        isAuthenticated: () => {
            return !!localStorage.getItem('infiniBaseUser');
        },
        getCurrentUser: () => {
            const storedUser = localStorage.getItem('infiniBaseUser');
            if (storedUser) return JSON.parse(storedUser);
            return null; 
        },
        logout: () => {
            const user = Auth.getCurrentUser();
            const userName = user ? user.fullName : 'User';
            localStorage.removeItem('infiniBaseUser');
            localStorage.removeItem('justLoggedIn'); 
            showToast(`You have been logged out, ${userName}. See you soon!`, 'logout', 2500); // Updated message and type
            setTimeout(() => {
                window.location.href = 'login.html'; 
            }, 1500); // Delay already present
        }
    };

    let kbSystemData = {
        meta: { version: '0.6.0', lastGlobalUpdate: new Date().toISOString(), lastArticleAdded: null, editsThisWeek: 0 }, // Version bump
        sections: [
            { id: 'home', name: 'Home', icon: 'fas fa-home', description: 'Dashboard and overview.' },
            {
                id: 'support', name: 'Support', icon: 'fas fa-headset', description: 'Support resources and flows.',
                items: [
                     { 
                        id: 'sup_flow_compensation', type: 'article', parentId: null,
                        title: 'Scenario: Customer Inquiry - Compensation Flow for Delays', 
                        summary: 'Flowchart for handling customer compensation due to order delays, using subgraphs for clarity.',
                        content: `
                            <p>This diagram outlines the decision-making process for compensating customers due to order delays.</p>
                            <div class="mermaid-diagram-container">
                                <pre class="mermaid">
graph TD
    A[Order Delay Inquiry] --> B{Valid Delay?};
    B -- No --> B_NO[Apologize, New ETA, Monitor];
    B -- Yes --> C{Order Type?};

    C -- Fast Delivery --> FD_ROOT[Fast Delivery Path];
    subgraph Fast Delivery Compensation
        direction TD
        FD_ROOT --> FD_D1{Delay: 15-30m?};
        FD_D1 -- Yes --> FD_A1[Action: Apologize, New ETA, Monitor];
        FD_D1 -- No --> FD_D2{Delay: 31-45m?};
        FD_D2 -- Yes --> FD_A2[Action: Compensate 25% Delivery Fee];
        FD_D2 -- No --> FD_D3{Delay: 46-60m?};
        FD_D3 -- Yes --> FD_A3[Action: Compensate 50% Delivery Fee];
        FD_D3 -- No --> FD_A4[Action: Compensate Full Delivery Fee (Over 60m)];
    end

    C -- Scheduled Delivery --> SD_ROOT[Scheduled Delivery Path];
    subgraph Scheduled Delivery Compensation
        direction TD
        SD_ROOT --> SD_D1{Delay: Up to 30m?};
        SD_D1 -- Yes --> SD_A1[Action: Apologize, Reassure, Monitor];
        SD_D1 -- No --> SD_D2{Delay: 31-60m?};
        SD_D2 -- Yes --> SD_A2[Action: Compensate 100% Order (If Major Disruption)];
        SD_D2 -- No --> SD_A3[Action: Compensate Full Order + $10 Credit (Over 60m)];
    end

    B_NO --> Z_END((End Interaction));
    FD_A1 --> Z_END;
    FD_A2 --> Z_END;
    FD_A3 --> Z_END;
    FD_A4 --> Z_END;
    SD_A1 --> Z_END;
    SD_A2 --> Z_END;
    SD_A3 --> Z_END;

    subgraph Legend
        direction LR
        LEG_ACTION[Action/Info]
        LEG_DECISION{Decision}
        LEG_END((End))
    end
    
    classDef default fill:var(--bg-color),stroke:var(--primary-color),stroke-width:2px,color:var(--text-color),font-family:Inter;
    classDef decision fill:var(--bg-color-alt),stroke:var(--text-color-muted),stroke-width:1px,color:var(--text-color),font-family:Inter;
    classDef endNode fill:var(--primary-color-hover),stroke:var(--primary-color),stroke-width:2px,color:var(--text-color-inverted),font-family:Inter;
    classDef legendNode fill:var(--bg-color-alt),stroke:var(--border-color),color:var(--text-color-subtle),font-size:12px,font-family:Inter;
    classDef pathNode fill:var(--bg-color),stroke:var(--border-color),stroke-width:1px,color:var(--text-color-muted),font-family:Inter,font-style:italic;

    class A,B_NO,FD_A1,FD_A2,FD_A3,FD_A4,SD_A1,SD_A2,SD_A3 default;
    class B,C,FD_D1,FD_D2,FD_D3,SD_D1,SD_D2 decision;
    class Z_END endNode;
    class LEG_ACTION,LEG_DECISION,LEG_END legendNode;
    class FD_ROOT, SD_ROOT pathNode;

                                </pre>
                            </div>
                            <p><strong>Important Considerations:</strong></p>
                            <ul>
                                <li>Always verify the cause of the delay (Store, Driver, System). This may influence compensation details or internal follow-up.</li>
                                <li>Maximum compensation for delivery fee related issues should not exceed $5 if the original delivery fee was less than $5.</li>
                                <li>Maintain a positive and empathetic tone throughout the interaction.</li>
                            </ul>
                        `,
                        tags: ['compensation', 'customer service', 'delay', 'flowchart', 'support policy'],
                        createdAt: '2023-10-01T10:00:00Z'
                    },
                    {
                        id: 'sup_sub_article_1', type: 'article', parentId: 'sup_flow_compensation',
                        title: 'Sub-Article: Detailed Verification Steps for Delays',
                        summary: 'Specific steps to verify the cause of an order delay before proceeding with compensation.',
                        content: '<p>Before offering compensation, follow these verification steps:</p><ol><li>Check system logs for any automated delay notifications.</li><li>Contact the assigned driver (if applicable) for their status.</li><li>Contact the store/partner to confirm order readiness and any internal issues.</li></ol>',
                        tags: ['verification', 'delay', 'internal procedure'],
                        createdAt: '2023-10-01T11:00:00Z'
                    }
                ]
            },
            { id: 'partner_care', name: 'Partner Care', icon: 'fas fa-handshake', description: 'Resources for partner management.', items: [], parentId: null },
            { id: 'logistics', name: 'Logistics', icon: 'fas fa-truck', description: 'Logistics operations and information.', items: [], parentId: null },
            { id: 'customer_care', name: 'Customer Care', icon: 'fas fa-users', description: 'Customer service guidelines and FAQs.', items: [], parentId: null },
            { id: 'distribution_followup', name: 'Distribution & Follow-up', icon: 'fas fa-people-carry', description: 'Distribution processes and tracking.', items: [], parentId: null },
            { id: 'logistics_driver_complaints', name: 'Logistics (Driver Complaints)', icon: 'fas fa-shipping-fast', description: 'Handling driver-related complaints.', items: [], parentId: null },
            { id: 'logistics_3pl', name: 'Logistics-3PL', icon: 'fas fa-boxes-stacked', description: 'Third-party logistics information.', items: [], parentId: null },
            { id: 'order_at_store_mac', name: 'Order at Store (Mac)', icon: 'fas fa-store', description: 'Procedures for Mac orders at store.', items: [], parentId: null },
            { id: 'logistics_admin', name: 'Logistics-Admin', icon: 'fas fa-user-shield', description: 'Administrative tasks for logistics.', items: [], parentId: null },
            { id: 'operating_systems', name: 'Operating Systems', icon: 'fab fa-windows', description: 'OS troubleshooting and guides.', items: [], parentId: null },
            { id: 'compensation_policies', name: 'Compensation Policies', icon: 'fas fa-hand-holding-usd', description: 'Detailed compensation policies.', items: [], parentId: null },
            { id: 'operational_instructions', name: 'Operational Instructions', icon: 'fas fa-clipboard-list', description: 'Standard operating procedures.', items: [], parentId: null },
            { id: 'forms_templates', name: 'Forms/Templates', icon: 'fas fa-file-alt', description: 'Standard forms and templates.', items: [], parentId: null }
        ]
    };

    // --- DOM Elements ---
    const sidebar = document.getElementById('sidebar');
    const mobileSidebarToggle = document.getElementById('mobileSidebarToggle');
    const navigationMenu = document.getElementById('navigationMenu');
    const currentSectionTitleEl = document.getElementById('currentSectionTitle');
    const breadcrumbsContainer = document.getElementById('breadcrumbs');
    const pageContentArea = document.getElementById('pageContentArea');
    const dashboardOverviewContainer = document.getElementById('dashboardOverviewContainer');
    const standardSectionContentPlaceholder = document.getElementById('standardSectionContentPlaceholder');
    const itemDetailViewPlaceholder = document.getElementById('itemDetailViewPlaceholder');
    const userNameDisplayHeader = document.getElementById('userNameDisplayHeader');
    const userAvatar = document.getElementById('userAvatar');
    const footerKbVersion = document.getElementById('footerKbVersion');

    const addContentModalOverlay = document.getElementById('addContentModalOverlay');
    const closeAddContentModalBtn = document.getElementById('closeAddContentModalBtn');
    const addContentForm = document.getElementById('addContentForm');
    const cancelAddContentBtn = document.getElementById('cancelAddContentBtn');
    const contentTypeSelect = document.getElementById('contentType');
    const contentUrlContainer = document.getElementById('contentUrlContainer');
    const contentDetailContainer = document.getElementById('contentDetailContainer');
    const contentDetailLabel = document.getElementById('contentDetailLabel');
    const contentTagsInput = document.getElementById('contentTags');
    const contentParentIdInput = document.getElementById('contentParentId');
    
    const globalSearchInput = document.getElementById('globalSearchInput');
    const searchResultsContainer = document.getElementById('searchResultsContainer');

    let quillEditor; 
    let currentUser = null; 
    let currentOpenItem = null;
    let visitorsChartInstance, casesChartInstance, articlesChartInstance; 

    // --- Utility Functions ---
    function escapeHTML(str) {
        if (typeof str !== 'string') return '';
        const el = document.createElement('div');
        el.textContent = str;
        return el.innerHTML;
    }

    function highlightText(text, query) {
        if (!text) return '';
        const safeText = escapeHTML(text);
        if (!query) return safeText;
        try {
            const rgx = new RegExp(`(${query.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')})`, 'gi');
            return safeText.replace(rgx, '<mark>$1</mark>');
        } catch (e) { return safeText; }
    }

    function truncateText(text, len) {
        if (!text || text.length <= len) return text;
        return text.substring(0, len) + '...';
    }
    function stripHtml(html){
       if (!html) return "";
       let tmp = document.createElement("DIV");
       tmp.innerHTML = html;
       return tmp.textContent || tmp.innerText || "";
    }

    function showToast(message, type = 'info', duration = 3000) {
        const toastContainer = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast-notification toast-${type}`; // e.g. toast-success, toast-logout
        
        let iconClass = 'fas fa-info-circle';
        if (type === 'success') iconClass = 'fas fa-check-circle';
        else if (type === 'error') iconClass = 'fas fa-times-circle';
        else if (type === 'logout') iconClass = 'fas fa-door-open';


        toast.innerHTML = `<i class="toast-icon ${iconClass}"></i> <span>${escapeHTML(message)}</span>`;
        toastContainer.appendChild(toast);

        setTimeout(() => toast.classList.add('show'), 10);

        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, duration);
    }
    
    function applyPermanentDarkMode() {
        // Theme is permanently dark. Update dynamic elements if needed.
        [visitorsChartInstance, casesChartInstance, articlesChartInstance].forEach(chart => {
            if (chart) {
                const legendColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim();
                const ticksColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color-muted').trim();
                const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim();
                
                chart.options.plugins.legend.labels.color = legendColor;
                if (chart.options.scales && chart.options.scales.y) {
                    chart.options.scales.y.ticks.color = ticksColor;
                    chart.options.scales.y.grid.color = gridColor;
                    chart.options.scales.x.ticks.color = ticksColor;
                    chart.options.scales.x.grid.color = gridColor;
                }
                chart.update();
            }
        });
        if (!itemDetailViewPlaceholder.classList.contains('hidden') || !standardSectionContentPlaceholder.classList.contains('hidden')) {
             renderMermaidDiagramsInElement(pageContentArea);
        }
    }

    // --- Sidebar and Navigation ---
    function populateSidebar() {
        let menuHTML = '';
        const sectionCategories = {
            MAIN: ['home'],
            KNOWLEDGE_AREAS: [
                'support', 'partner_care', 'logistics', 'customer_care', 
                'distribution_followup', 'logistics_driver_complaints', 'logistics_3pl', 
                'order_at_store_mac', 'logistics_admin', 'operating_systems'
            ],
            RESOURCES_POLICIES: [
                'compensation_policies', 'operational_instructions', 'forms_templates'
            ]
        };

        Object.keys(sectionCategories).forEach(categoryKey => {
            const title = categoryKey.replace('_', ' & '); // Format title
            menuHTML += `<div class="sidebar-section-title">${title}</div>`;
            kbSystemData.sections
                .filter(s => sectionCategories[categoryKey].includes(s.id))
                .forEach(section => {
                    menuHTML += `<a href="#${section.id}" class="sidebar-link" data-section="${section.id}">
                        <i class="${section.icon || (categoryKey === 'KNOWLEDGE_AREAS' ? 'fas fa-folder' : 'fas fa-book')}"></i>${escapeHTML(section.name)}
                    </a>`;
                });
        });
        navigationMenu.innerHTML = menuHTML;
    }

    mobileSidebarToggle.addEventListener('click', () => sidebar.classList.toggle('closed'));
    sidebar.addEventListener('click', (e) => {
        if (e.target.closest('.sidebar-link') && window.innerWidth < 768) {
            sidebar.classList.add('closed');
        }
    });

    function highlightSidebarLink(sectionId) {
        document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
        const activeLink = document.querySelector(`.sidebar-link[data-section="${sectionId}"]`);
        if (activeLink) activeLink.classList.add('active');
    }
    
    // --- Mermaid Rendering ---
    async function renderMermaidDiagramsInElement(element) {
        const mermaidElements = element.querySelectorAll('pre.mermaid');
        if (mermaidElements.length > 0) {
            const initiallyHiddenParents = [];
            mermaidElements.forEach(el => {
                let parent = el.parentElement;
                while(parent && parent !== document.body) {
                    if (parent.classList.contains('hidden') || (parent.style.display === 'none')) {
                        const oldDisplay = parent.style.display;
                        parent.classList.remove('hidden');
                        parent.style.display = ''; 
                        initiallyHiddenParents.push({el: parent, display: oldDisplay});
                    }
                    if(parent.classList.contains('modal-overlay') || parent.classList.contains('content-wrapper') || parent.classList.contains('card')) break;
                    parent = parent.parentElement;
                }
            });
    
            for (let i = 0; i < mermaidElements.length; i++) {
                const preElement = mermaidElements[i];
                const diagramContainer = preElement.parentElement; 
                
                const existingSvg = diagramContainer.querySelector('svg');
                if(existingSvg) existingSvg.remove();
                
                preElement.style.display = 'block'; 
                preElement.removeAttribute('data-processed'); 

                try {
                    await mermaid.run({ nodes: [preElement], suppressErrors: false });
                     if (diagramContainer.querySelector('svg')) {
                        preElement.style.display = 'none';
                    } else {
                        console.warn("Mermaid.run did not replace pre with SVG. Pre content:", preElement.textContent.substring(0,100));
                        preElement.style.display = 'block'; 
                    }
                } catch (error) {
                    console.error("Mermaid rendering error:", error, "for diagram:", preElement.textContent.substring(0,100));
                    const errorMsg = document.createElement('p');
                    errorMsg.style.color = 'red';
                    errorMsg.textContent = `Error rendering diagram: ${error.message}. Check console.`;
                    diagramContainer.appendChild(errorMsg);
                    preElement.style.display = 'block'; 
                }
            }
            initiallyHiddenParents.forEach(pInfo => {
                if (pInfo.display === 'none') pInfo.el.style.display = 'none';
                else pInfo.el.classList.add('hidden'); 
            });
        }
    }


    // --- Content Display ---
    function renderItemCard(item, sectionData, allItemsInSection) {
        let itemIconClass = 'fas fa-file-alt'; 
        let ctaText = 'View Details';
        let ctaLink = `#${sectionData.id}/${item.id}`;
        let target = '';
        let itemTypeDisplay = item.type.replace('_', ' ');

        if (item.type === 'article') { itemIconClass = 'fas fa-newspaper'; itemTypeDisplay = 'Article';}
        else if (item.type === 'case') { itemIconClass = 'fas fa-briefcase'; itemTypeDisplay = 'Case';}
        else if (item.type === 'form_sheet') { itemIconClass = 'fas fa-file-invoice'; ctaText = 'Open Link'; ctaLink = item.url || '#'; target = '_blank'; itemTypeDisplay = 'Form/Sheet';}
        else if (item.type === 'design') {itemIconClass = 'fas fa-palette'; ctaText = 'View Design'; ctaLink = item.url || '#'; target = '_blank'; itemTypeDisplay = 'Design';}
        else if (item.type === 'guide') { itemIconClass = 'fas fa-book-open'; itemTypeDisplay = 'Guide';}
        else if (item.type === 'policy') { itemIconClass = 'fas fa-gavel'; itemTypeDisplay = 'Policy';}

        const children = allItemsInSection.filter(child => child.parentId === item.id);
        let childrenHTML = '';
        if (children.length > 0) {
            childrenHTML = `<div class="sub-item-list">
                <h5>Sub-items (${children.length}):</h5>
                <ul>${children.map(child => `<li><a href="#${sectionData.id}/${child.id}" data-item-id="${child.id}" data-section-id="${sectionData.id}">${escapeHTML(child.title)}</a></li>`).join('')}</ul>
            </div>`;
        }

        return `
        <div class="card" data-item-id="${item.id}" data-item-type="${item.type}">
            <div class="card-header-icon">
                <div class="card-icon-container">
                    <i class="${itemIconClass}"></i>
                </div>
                <h3>${escapeHTML(item.title)}</h3>
            </div>
            <p>${escapeHTML(truncateText(stripHtml(item.summary), 120))}</p>
            ${item.tags && item.tags.length ? `<div class="card-tags">${item.tags.map(tag => `<span>${escapeHTML(tag)}</span>`).join('')}</div>` : ''}
            ${childrenHTML}
            <div class="item-meta-info">
                <span class="item-type-badge">${escapeHTML(itemTypeDisplay)}</span>
                <a href="${escapeHTML(ctaLink)}" ${target ? `target="${target}" rel="noopener noreferrer"` : ''} class="item-cta-link"
                   data-item-id="${item.id}" data-section-id="${sectionData.id}" data-item-type="${item.type}">
                   ${ctaText} <i class="fas fa-arrow-right"></i> 
                </a>
            </div>
        </div>`;
    }

    async function displayDashboard() {
        dashboardOverviewContainer.classList.remove('hidden');
        standardSectionContentPlaceholder.classList.add('hidden');
        itemDetailViewPlaceholder.classList.add('hidden');
        currentSectionTitleEl.textContent = 'Dashboard';
        breadcrumbsContainer.innerHTML = `<span style="font-weight: bold; color: var(--primary-color);">Home</span>`;

        const welcomeUser = currentUser.fullName || 'User';
        const totalArticles = kbSystemData.sections.reduce((sum, s) => sum + (s.items?.filter(i => ['article', 'guide', 'policy'].includes(i.type)).length || 0), 0);
        const totalCases = kbSystemData.sections.reduce((sum, s) => sum + (s.items?.filter(i => i.type === 'case').length || 0), 0);
        
        kbSystemData.meta.editsThisWeek = Math.floor(Math.random() * 5) + (kbSystemData.meta.editsThisWeek || 0) ; 
        if (!kbSystemData.meta.lastArticleAdded) {
            const allItems = kbSystemData.sections.flatMap(s => s.items || []);
            if (allItems.length > 0) {
                 const latestItem = allItems.sort((a,b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0))[0];
                 if (latestItem) {
                     const itemTypeForDisplay = latestItem.type.charAt(0).toUpperCase() + latestItem.type.slice(1);
                     kbSystemData.meta.lastArticleAdded = { title: `(${itemTypeForDisplay}) ${latestItem.title}`, date: new Date(latestItem.createdAt || Date.now()).toLocaleDateString() };
                 } else {
                     kbSystemData.meta.lastArticleAdded = { title: "N/A", date: "N/A" };
                 }
            } else {
                 kbSystemData.meta.lastArticleAdded = { title: "N/A", date: "N/A" };
            }
        }


        dashboardOverviewContainer.innerHTML = `
            <div class="card" style="background: linear-gradient(135deg, var(--primary-color) 0%, ${getComputedStyle(document.documentElement).getPropertyValue('--primary-color-hover').trim()} 100%); color: var(--text-color-inverted);"> 
                <h2 style="font-size: 2rem; margin-bottom: 8px;">Welcome back, ${escapeHTML(welcomeUser)}!</h2>
                <p style="opacity: 0.9;">Overview of your knowledge base activity.</p>
                <p style="font-size: 0.9rem; opacity: 0.8; margin-top: 4px;">InfiniBase Version ${escapeHTML(kbSystemData.meta.version)} | Last Global Update: ${new Date(kbSystemData.meta.lastGlobalUpdate).toLocaleDateString()}</p>
            </div>

            <div class="cards-grid my-6" style="grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));">
                <div class="dashboard-stat-card">
                    <i class="fas fa-folder-open"></i>
                    <span class="stat-value">${kbSystemData.sections.filter(s => s.id !== 'home').length}</span>
                    <span class="stat-label">Total Sections</span>
                </div>
                <div class="dashboard-stat-card">
                    <i class="fas fa-newspaper"></i>
                    <span class="stat-value">${totalArticles}</span>
                    <span class="stat-label">Total Articles & Guides</span>
                </div>
                 <div class="dashboard-stat-card">
                    <i class="fas fa-briefcase"></i>
                    <span class="stat-value">${totalCases}</span>
                    <span class="stat-label">Total Cases</span>
                </div>
                <div class="dashboard-stat-card">
                    <i class="fas fa-edit"></i>
                    <span class="stat-value">${kbSystemData.meta.editsThisWeek}</span>
                    <span class="stat-label">Edits This Week</span>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card chart-container">
                        <h3>Visitors Activity (Mock)</h3>
                        <canvas id="visitorsChart"></canvas>
                    </div>
                    <div class="card chart-container">
                        <h3>Content Types (Mock)</h3>
                        <canvas id="articlesChart"></canvas> 
                    </div>
                </div>
                <div class="dashboard-quicklink-card card">
                    <h3>Quick Links</h3>
                    <ul>
                        <li><a href="#" id="dashboardAddContentLink"><i class="fas fa-plus-circle fa-fw"></i> Add New Content</a></li>
                        <li><a href="#support/${kbSystemData.sections.find(s=>s.id==='support').items[0]?.id || ''}"><i class="fas fa-project-diagram fa-fw"></i> View Support Flow</a></li>
                        <li><a href="#forms_templates"><i class="fas fa-file-alt fa-fw"></i> Browse Templates</a></li>
                    </ul>
                     <h3 style="margin-top: 1.5rem;">Last Added</h3>
                     <p>${escapeHTML(kbSystemData.meta.lastArticleAdded.title)} <br><small>(${escapeHTML(kbSystemData.meta.lastArticleAdded.date)})</small></p>
                     <h3 style="margin-top: 1.5rem;">Top Viewed (Placeholder)</h3>
                     <p>Feature coming soon!</p>
                </div>
            </div>
        `;
        
        document.getElementById('dashboardAddContentLink').addEventListener('click', (e) => {
            e.preventDefault();
            openAddContentModal(kbSystemData.sections.find(s => s.id !== 'home')?.id || 'support'); 
        });

        const legendColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim();
        const ticksColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color-muted').trim();
        const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim();

        const chartOptions = (type) => ({
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { labels: { color: legendColor, font: { family: 'Inter, sans-serif' } } } },
            scales: type === 'bar' || type === 'line' ? {
                y: { ticks: { color: ticksColor, beginAtZero: true, font: { family: 'Inter, sans-serif' } }, grid: { color: gridColor } },
                x: { ticks: { color: ticksColor, font: { family: 'Inter, sans-serif' } }, grid: { color: gridColor, drawOnChartArea: false } }
            } : {}
        });

        if (visitorsChartInstance) visitorsChartInstance.destroy();
        const visitorsCtx = document.getElementById('visitorsChart')?.getContext('2d');
        if (visitorsCtx) {
            visitorsChartInstance = new Chart(visitorsCtx, {
                type: 'line',
                data: { labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'], datasets: [{ label: 'Page Views', data: [65, 59, 80, 81, 56, 55, 40], borderColor: 'rgba(99, 102, 241, 0.8)', backgroundColor: 'rgba(99, 102, 241, 0.2)', tension: 0.3, fill: true }] },
                options: chartOptions('line')
            });
        }

        if (articlesChartInstance) articlesChartInstance.destroy();
        const articlesCtx = document.getElementById('articlesChart')?.getContext('2d');
        if (articlesCtx) {
            articlesChartInstance = new Chart(articlesCtx, {
                type: 'doughnut', 
                data: { labels: ['Articles', 'Cases', 'Guides', 'Policies'], datasets: [{ data: [totalArticles, totalCases, 5, 3], backgroundColor: ['#6366f1', '#ec4899', '#22d3ee', '#f59e0b'], borderWidth: 0 }] },
                options: chartOptions('doughnut') 
            });
        }
    }
    
    function displaySectionContent(sectionId, subCategoryFilter = null) { // subCategoryFilter not fully used yet, could be for tags
        currentOpenItem = null;
        dashboardOverviewContainer.classList.add('hidden');
        standardSectionContentPlaceholder.classList.remove('hidden');
        itemDetailViewPlaceholder.classList.add('hidden');

        const sectionData = kbSystemData.sections.find(s => s.id === sectionId);
        if (!sectionData) {
            standardSectionContentPlaceholder.innerHTML = `<div class="card" style="text-align: center;"><h2 style="color: var(--primary-color);">Section not found: ${escapeHTML(sectionId)}</h2></div>`;
            currentSectionTitleEl.textContent = 'Not Found';
            return;
        }

        currentSectionTitleEl.textContent = sectionData.name;
        let parentItemForBreadcrumb = null; 
        if (subCategoryFilter) { // Assuming subCategoryFilter could be a parentId if we enhance this logic
            parentItemForBreadcrumb = sectionData.items?.find(i => i.id === subCategoryFilter);
        }

        let bcHTML = `<a href="#home">Home</a> <span style="margin: 0 5px;">›</span> <span style="font-weight: bold; color: var(--primary-color);">${escapeHTML(sectionData.name)}</span>`;
        if (parentItemForBreadcrumb) { // Basic breadcrumb for a "sub-category" view if it were a parent item
             bcHTML += ` <span style="margin: 0 5px;">›</span> <span style="font-weight: bold; color: var(--primary-color);">${escapeHTML(parentItemForBreadcrumb.title)}</span>`;
        }
        breadcrumbsContainer.innerHTML = bcHTML;

        let contentHTML = `<div>`;
        if (currentUser && currentUser.role === 'admin' && sectionId !== 'home') {
             contentHTML += `
                <div style="text-align: right; margin-bottom: 20px;">
                    <button id="openAddContentBtn" class="button" data-section-id="${sectionData.id}">
                        <i class="fas fa-plus-circle"></i> Add Content to ${escapeHTML(sectionData.name)}
                    </button>
                </div>`;
        }
        
        const allItemsInSection = sectionData.items || [];
        const itemsToDisplay = allItemsInSection
            .filter(item => !item.parentId) // Only show top-level items
            .filter(item => !subCategoryFilter || (item.tags && item.tags.includes(subCategoryFilter)));


        if (itemsToDisplay.length > 0) {
             if (sectionId === 'support' && itemsToDisplay.find(it => it.id === 'sup_flow_compensation')) { 
                // Special handling for the mermaid diagram card if it's the primary content,
                // but generally, renderItemCard will handle its content.
                // This 'if' might be redundant if renderItemCard outputs the mermaid diagram correctly.
                // We will ensure sup_flow_compensation is rendered via renderItemCard and its content is handled.
                contentHTML += `<div class="cards-grid">`;
                itemsToDisplay.forEach(item => contentHTML += renderItemCard(item, sectionData, allItemsInSection));
                contentHTML += `</div>`;
            } else {
                contentHTML += `<div class="cards-grid">`;
                itemsToDisplay.forEach(item => contentHTML += renderItemCard(item, sectionData, allItemsInSection));
                contentHTML += `</div>`;
            }
        }
        
        // Sub-categories (if defined separately, not via parentId items)
        if (!subCategoryFilter && sectionData.subCategories && sectionData.subCategories.length > 0) {
            // This part might be less used if nesting is primarily via parentId
            contentHTML += `<h3 style="font-size: 1.5rem; font-weight: 600; margin-top: 30px; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; color: var(--text-color);">Subcategories</h3><div class="cards-grid">`;
            sectionData.subCategories.forEach(subCat => {
                contentHTML += `<a href="#${sectionData.id}/${subCat.id}" class="card" style="text-align: center; text-decoration: none; color: var(--text-color);">
                    <i class="${subCat.icon || sectionData.icon || 'fas fa-folder-open'}" style="font-size: 2rem; display: block; margin-bottom: 10px; color: var(--primary-color);"></i>
                    <h4 style="margin:0; font-weight: 500;">${escapeHTML(subCat.name)}</h4>
                </a>`;
            });
            contentHTML += `</div>`;
        }

        if (itemsToDisplay.length === 0 && (!sectionData.subCategories || sectionData.subCategories.length === 0 || subCategoryFilter)) {
             contentHTML += `<div class="card" style="text-align: center; padding: 40px 20px;"><p style="font-size: 1.2rem; color: var(--text-color-muted);">No top-level content in this section${subCategoryFilter ? ' or subcategory/tag' : ''} yet.</p></div>`;
        }

        contentHTML += `</div>`;
        standardSectionContentPlaceholder.innerHTML = contentHTML;
        renderMermaidDiagramsInElement(standardSectionContentPlaceholder);


        const openAddBtn = document.getElementById('openAddContentBtn');
        if (openAddBtn) {
            openAddBtn.addEventListener('click', (e) => {
                const currentSecId = e.currentTarget.dataset.sectionId;
                openAddContentModal(currentSecId);
            });
        }
    }

    function displayItemDetail(sectionId, itemId) {
        const sectionData = kbSystemData.sections.find(s => s.id === sectionId);
        const itemData = sectionData?.items?.find(i => i.id === itemId);

        if (!sectionData || !itemData) {
            standardSectionContentPlaceholder.innerHTML = `<p style="color: var(--primary-color);">Error: Item not found.</p>`;
            itemDetailViewPlaceholder.classList.add('hidden');
            standardSectionContentPlaceholder.classList.remove('hidden');
            return;
        }
        currentOpenItem = { sectionId, itemId };

        dashboardOverviewContainer.classList.add('hidden');
        standardSectionContentPlaceholder.classList.add('hidden');
        itemDetailViewPlaceholder.classList.remove('hidden');

        let parentItemTitle = null;
        if (itemData.parentId) {
            const parentItem = sectionData.items.find(p => p.id === itemData.parentId);
            if (parentItem) parentItemTitle = parentItem.title;
        }

        let bcHTML = `
            <a href="#home">Home</a> <span style="margin: 0 5px;">›</span>
            <a href="#${sectionData.id}">${escapeHTML(sectionData.name)}</a>`;
        if (parentItemTitle) {
             bcHTML += ` <span style="margin: 0 5px;">›</span> <a href="#${sectionData.id}/${itemData.parentId}">${escapeHTML(parentItemTitle)}</a>`;
        }    
        bcHTML += ` <span style="margin: 0 5px;">›</span> <span style="font-weight: bold; color: var(--primary-color);">${escapeHTML(itemData.title)}</span>`;
        
        breadcrumbsContainer.innerHTML = bcHTML;
        currentSectionTitleEl.textContent = itemData.title;

        let itemIconClass = 'fas fa-file-alt';
        if (itemData.type === 'case') itemIconClass = 'fas fa-briefcase';
        else if (itemData.type === 'article') itemIconClass = 'fas fa-newspaper';
        else if (itemData.type === 'form_sheet') itemIconClass = 'fas fa-file-invoice';
        else if (itemData.type === 'design') itemIconClass = 'fas fa-palette';
        else if (itemData.type === 'guide') itemIconClass = 'fas fa-book-open';
        else if (itemData.type === 'policy') itemIconClass = 'fas fa-gavel';


        let detailHTML = `
            <button id="backToSectionBtn" class="button button-secondary" style="margin-bottom: 20px;">
                <i class="fas fa-arrow-left"></i> Back to ${escapeHTML(parentItemTitle ? parentItemTitle : sectionData.name)}
            </button>
            <div class="card">
                <div class="item-title-area">
                    <i class="${itemIconClass}"></i>
                    <h2>${escapeHTML(itemData.title)}</h2>
                </div>
                <p class="item-summary">${escapeHTML(itemData.summary)}</p>
                ${itemData.tags && itemData.tags.length ? `<div class="card-tags" style="margin-bottom: 1rem;">${itemData.tags.map(tag => `<span>${escapeHTML(tag)}</span>`).join('')}</div>` : ''}
                <hr>
                <div class="kb-content">`;

        if (itemData.content) { 
            detailHTML += itemData.content;
        } else if (itemData.resolution_steps) { 
             detailHTML += itemData.resolution_steps;
        } else if ((itemData.type === 'form_sheet' || itemData.type === 'design') && itemData.url) {
            detailHTML += `<p>This content is an external link:</p><p><a href="${escapeHTML(itemData.url)}" target="_blank" rel="noopener noreferrer" class="button"><i class="fas fa-external-link-alt"></i> Open Link</a></p>`;
        } else {
            detailHTML += `<p>No detailed content available for this item.</p>`;
        }

        if (itemData.attachments) {
            detailHTML += `<hr><h4 style="margin-top:1.5rem; margin-bottom:1rem; font-weight:600; color:var(--text-color);">Attachments:</h4><ul>`;
            if(itemData.attachments.pdf) detailHTML += `<li><i class="fas fa-file-pdf text-red-400"></i> <a href="${escapeHTML(itemData.attachments.pdf)}" target="_blank">View PDF</a> (Simulated)</li>`;
            if(itemData.attachments.image) detailHTML += `<li><i class="fas fa-file-image text-blue-400"></i> <a href="${escapeHTML(itemData.attachments.image)}" target="_blank">View Image</a> (Simulated)</li>`;
            if(itemData.attachments.video) detailHTML += `<li><i class="fas fa-video text-purple-400"></i> <a href="${escapeHTML(itemData.attachments.video)}" target="_blank">Watch Video</a></li>`;
            if(itemData.attachments.drive) detailHTML += `<li><i class="fab fa-google-drive text-green-400"></i> <a href="${escapeHTML(itemData.attachments.drive)}" target="_blank">Open Drive Link</a></li>`;
            detailHTML += `</ul>`;
        }
        
        // Display Sub-Content
        const children = sectionData.items.filter(child => child.parentId === itemId);
        if (children.length > 0) {
            detailHTML += `<h3 class="sub-content-heading">Sub-Content (${children.length})</h3>`;
            detailHTML += `<div class="sub-content-list"><ul>`;
            children.forEach(child => {
                detailHTML += `<li><a href="#${sectionId}/${child.id}">${escapeHTML(child.title)} <small>(${child.type})</small></a></li>`;
            });
            detailHTML += `</ul></div>`;
        }


        detailHTML += `</div></div>`;
        itemDetailViewPlaceholder.innerHTML = detailHTML;
        renderMermaidDiagramsInElement(itemDetailViewPlaceholder);


        document.getElementById('backToSectionBtn').addEventListener('click', () => {
            window.location.hash = `#${sectionId}${itemData.parentId ? '/' + itemData.parentId : ''}`;
        });
    }

    // --- Add Content Modal Logic ---
    function openAddContentModal(sectionIdForContent, itemToEdit = null) {
        addContentForm.reset();
        addContentForm.dataset.sectionId = sectionIdForContent;
        
        if (!quillEditor) {
            quillEditor = new Quill('#quillEditor', {
                theme: 'snow',
                modules: { 
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ 'color': [] }, { 'background': [] }],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        [{ 'align': [] }],
                        ['link', 'image', 'video', 'blockquote', 'code-block'], 
                        ['clean']
                    ]
                },
                placeholder: 'Enter detailed content here...'
            });
        }
        quillEditor.root.innerHTML = ''; 

        if (itemToEdit) {
            document.getElementById('addContentModalTitle').textContent = 'Edit Content';
            document.getElementById('contentTitle').value = itemToEdit.title;
            document.getElementById('contentSummary').value = itemToEdit.summary;
            contentTypeSelect.value = itemToEdit.type;
            if (itemToEdit.url) document.getElementById('contentUrl').value = itemToEdit.url;
            if (itemToEdit.content) quillEditor.root.innerHTML = itemToEdit.content;
            else if (itemToEdit.resolution_steps) quillEditor.root.innerHTML = itemToEdit.resolution_steps;
            contentTagsInput.value = (itemToEdit.tags || []).join(', ');
            contentParentIdInput.value = itemToEdit.parentId || '';
            addContentForm.dataset.itemId = itemToEdit.id; 
            if (itemToEdit.attachments) {
                if(itemToEdit.attachments.video) document.getElementById('videoLink').value = itemToEdit.attachments.video;
                if(itemToEdit.attachments.drive) document.getElementById('driveLink').value = itemToEdit.attachments.drive;
            }
        } else {
            document.getElementById('addContentModalTitle').textContent = 'Add New Content';
            delete addContentForm.dataset.itemId; 
            contentTypeSelect.value = "article";
            contentParentIdInput.value = ''; // Clear parent ID for new items
        }
        
        contentTypeSelect.dispatchEvent(new Event('change'));
        addContentModalOverlay.classList.remove('hidden');
        document.getElementById('contentTitle').focus();
    }

    function closeAddContentModal() {
        addContentModalOverlay.classList.add('hidden');
    }

    contentTypeSelect.addEventListener('change', (e) => {
        const type = e.target.value;
        contentUrlContainer.classList.add('hidden');
        contentDetailContainer.classList.remove('hidden'); 

        if (type === 'form_sheet' || type === 'design') {
            contentUrlContainer.classList.remove('hidden');
            contentDetailContainer.classList.add('hidden'); 
        } else if (type === 'case') {
            contentDetailLabel.textContent = 'Case Details / Resolution Steps';
        } else if (type === 'article') {
            contentDetailLabel.textContent = 'Article Content';
        } else if (type === 'guide') {
            contentDetailLabel.textContent = 'Guide Content';
        } else if (type === 'policy') {
            contentDetailLabel.textContent = 'Policy Details';
        }
    });

    addContentForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const sectionId = addContentForm.dataset.sectionId;
        const section = kbSystemData.sections.find(s => s.id === sectionId);
        if (!section) {
            showToast('Error: Target section not found!', 'error'); return;
        }
        
        const itemIdToEdit = addContentForm.dataset.itemId; 
        let itemData;

        const parentIdValue = contentParentIdInput.value.trim() || null;

        const commonData = {
            type: contentTypeSelect.value,
            title: document.getElementById('contentTitle').value.trim(),
            summary: document.getElementById('contentSummary').value.trim(),
            tags: contentTagsInput.value.split(',').map(tag => tag.trim()).filter(tag => tag),
            parentId: parentIdValue
        };
        
        if (commonData.title.length === 0 || commonData.summary.length === 0) {
             showToast('Title and Summary are required.', 'error'); return;
        }


        if (itemIdToEdit) { 
            itemData = section.items.find(i => i.id === itemIdToEdit);
            if (!itemData) { showToast('Error: Item to edit not found!', 'error'); return; }
            Object.assign(itemData, commonData); 
            itemData.lastModified = new Date().toISOString();
        } else { 
            itemData = {
                ...commonData,
                id: `${sectionId}_item_${Date.now()}`,
                createdBy: currentUser.email,
                createdAt: new Date().toISOString()
            };
            const itemTypeForDisplay = itemData.type.charAt(0).toUpperCase() + itemData.type.slice(1);
            kbSystemData.meta.lastArticleAdded = { title: `(${itemTypeForDisplay}) ${itemData.title}`, date: new Date(itemData.createdAt).toLocaleDateString() };
            kbSystemData.meta.editsThisWeek = (kbSystemData.meta.editsThisWeek || 0) + 1;
        }
        
        // Validate parentId if provided
        if (itemData.parentId) {
            if (itemData.parentId === itemData.id) { // Prevent self-parenting
                showToast(`Error: Item cannot be its own parent. Parent ID cleared.`, 'error');
                itemData.parentId = null;
            } else {
                const parentItem = section.items.find(i => i.id === itemData.parentId);
                if (!parentItem) {
                    showToast(`Warning: Parent item with ID '${itemData.parentId}' not found in this section. Item will be top-level.`, 'info');
                    itemData.parentId = null; 
                }
            }
        }


        if (itemData.type === 'case') {
            itemData.resolution_steps = quillEditor.root.innerHTML;
            itemData.status = itemData.status || 'New'; 
        } else if (['article', 'guide', 'policy'].includes(itemData.type)) {
            itemData.content = quillEditor.root.innerHTML;
        } else if (itemData.type === 'form_sheet' || itemData.type === 'design') {
            itemData.url = document.getElementById('contentUrl').value.trim();
            if (!itemData.url || !itemData.url.startsWith('http')) { 
                showToast('A valid URL (starting with http/https) is required for this content type.', 'error'); return; 
            }
        }

        itemData.attachments = itemData.attachments || {};
        const pdfFile = document.getElementById('pdfFile').files[0];
        const imageFile = document.getElementById('imageFile').files[0];
        const videoLink = document.getElementById('videoLink').value.trim();
        const driveLink = document.getElementById('driveLink').value.trim();

        if (pdfFile) itemData.attachments.pdf = `simulated_uploads/${pdfFile.name}`; 
        if (imageFile) itemData.attachments.image = `simulated_uploads/${imageFile.name}`; 
        if (videoLink) itemData.attachments.video = videoLink;
        if (driveLink) itemData.attachments.drive = driveLink;


        if (!itemIdToEdit) { 
            if (!section.items) section.items = [];
            section.items.push(itemData);
        }

        showToast(`Content '${itemData.title}' ${itemIdToEdit ? 'updated' : 'saved'} successfully!`, 'success');
        closeAddContentModal();
        
        const currentHashParts = window.location.hash.substring(1).split('/');
        if (currentHashParts[0] === sectionId && currentHashParts.length === 1 ) { 
             displaySectionContent(sectionId); // Refresh current section view
        } else if (currentHashParts[0] === sectionId && currentHashParts[1] === itemData.id) {
            displayItemDetail(sectionId, itemData.id); // Refresh current item view if it was edited
        } else if (currentHashParts[0] === sectionId && itemData.parentId && currentHashParts[1] === itemData.parentId) {
            displayItemDetail(sectionId, itemData.parentId); // Refresh parent item view if a child was added/edited
        } else {
             handleNavigation(); // Fallback to general navigation handling
        }
    });

    // --- Global Search ---
    globalSearchInput.addEventListener('input', () => {
        const query = globalSearchInput.value.trim().toLowerCase();
        if (query.length < 2) {
            searchResultsContainer.classList.add('hidden');
            return;
        }
        const results = [];
        kbSystemData.sections.forEach(s => {
            if (s.id === 'home') return; 
            s.items?.forEach(i => {
                const contentToSearch = stripHtml(i.summary || '') + " " + stripHtml(i.content || '') + " " + stripHtml(i.resolution_steps || '');
                if (i.title.toLowerCase().includes(query) || 
                    contentToSearch.toLowerCase().includes(query) ||
                    (i.tags && i.tags.some(tag => tag.toLowerCase().includes(query)))) {
                    results.push({ ...i, sectionId: s.id, sectionName: s.name });
                }
            });
        });
        searchResultsContainer.innerHTML = '';
        if (results.length) {
            results.slice(0, 7).forEach(r => {
                const linkEl = document.createElement('a');
                linkEl.href = `#${r.sectionId}/${r.id}`;
                 linkEl.addEventListener('click', () => {
                    searchResultsContainer.classList.add('hidden');
                    globalSearchInput.value = '';
                });

                linkEl.innerHTML = `
                    <div style="font-weight: bold;">${highlightText(r.title, query)}
                        <span style="font-size: 0.8em; color: var(--text-color-muted); margin-left: 5px;">(${escapeHTML(r.type.replace('_', ' '))} in ${escapeHTML(r.sectionName)})</span>
                    </div>
                    <p style="font-size: 0.9em; color: var(--text-color-subtle); margin: 0;">${highlightText(truncateText(stripHtml(r.summary || r.content || r.resolution_steps), 70), query)}</p>`;
                searchResultsContainer.appendChild(linkEl);
            });
            searchResultsContainer.classList.remove('hidden');
        } else {
            searchResultsContainer.innerHTML = `<div style="padding: 10px; font-size: 0.9em; color: var(--text-color-muted);">No results found for "${escapeHTML(query)}".</div>`;
            searchResultsContainer.classList.remove('hidden');
        }
    });
    document.addEventListener('click', e => {
        if (!globalSearchInput.contains(e.target) && !searchResultsContainer.contains(e.target)) {
            searchResultsContainer.classList.add('hidden');
        }
    });
    
    // --- Routing and Initialization ---
    function handleNavigation() {
        const hash = window.location.hash.substring(1) || 'home';
        const parts = hash.split('/');
        const sectionId = parts[0];
        const itemIdOrSubCategoryOrParentId = parts[1]; // Can be item ID, or a "sub-category" ID (if we used that concept more), or a parent Item ID when navigating back from child.

        highlightSidebarLink(sectionId);

        if (sectionId === 'home') {
            displayDashboard();
        } else if (itemIdOrSubCategoryOrParentId && sectionId) { 
            const sectionData = kbSystemData.sections.find(s => s.id === sectionId);
            const itemExists = sectionData?.items?.some(i => i.id === itemIdOrSubCategoryOrParentId);
            if(itemExists) {
                // Check if this ID is for an item that primarily acts as a parent container for other items
                // For now, any item ID will lead to item detail view.
                displayItemDetail(sectionId, itemIdOrSubCategoryOrParentId);
            } else {
                 // If not an item ID, it might be a sub-category or tag filter (not fully implemented here)
                 // For now, assume it's just the section.
                displaySectionContent(sectionId, itemIdOrSubCategoryOrParentId); 
            }
        } else if (sectionId) {
            displaySectionContent(sectionId);
        } else {
            displayDashboard(); // Default to dashboard
        }
        window.scrollTo(0,0);
    }

    function initializeApp() {
        if (!Auth.isAuthenticated()) {
            window.location.href = 'login.html';
            return; 
        }

        currentUser = Auth.getCurrentUser();
        if (!currentUser) { 
            window.location.href = 'login.html';
            return;
        }

        const displayName = currentUser.fullName || currentUser.email || 'User';
        userNameDisplayHeader.textContent = displayName;
        userAvatar.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName.split(' ').join('+'))}&size=36&background=6366f1&color=fff&rounded=true&font-size=0.5`;
        footerKbVersion.textContent = kbSystemData.meta.version;

        populateSidebar();
        applyPermanentDarkMode(); 
        handleNavigation(); 

        window.addEventListener('hashchange', handleNavigation);
        document.getElementById('logoutButton').addEventListener('click', () => {
             if(confirm('Are you sure you want to logout?')) Auth.logout();
        });
        document.getElementById('reportErrorBtn').addEventListener('click', () => showToast('Issue reporting feature is under development.', 'info'));
        
        closeAddContentModalBtn.addEventListener('click', closeAddContentModal);
        cancelAddContentBtn.addEventListener('click', closeAddContentModal);
        
        if (window.innerWidth < 768 && !sidebar.classList.contains('closed')) {
            sidebar.classList.add('closed');
        }
        
        if (localStorage.getItem('justLoggedIn') === 'true') {
            showToast(`Welcome back, ${displayName}! You've successfully logged in.`, 'success', 4000);
            localStorage.removeItem('justLoggedIn'); 
        } else {
            showToast(`InfiniBase v${kbSystemData.meta.version} loaded. Session restored for ${displayName}.`, 'info', 4000);
        }
        console.log(`InfiniBase v${kbSystemData.meta.version} initialized for ${displayName} (Permanent Dark Mode).`);
    }

    initializeApp();

</script>
</body>
</html>
