<!DOCTYPE html>
<html lang="en" dir="ltr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InfiniBase - Knowledge Base</title>
    <!-- Favicon from indexx.txt (example) -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236366f1' width='64' height='64'><path d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z'/></svg>">
    
    <!-- CDNs -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>

    <style>
        :root {
            /* Permanent Dark Theme Variables */
            --primary-color: #6366f1; /* Brighter Indigo for dark */
            --primary-color-hover: #4f46e5;
            --secondary-color: #9ca3af;

            --text-color: #d1d5db;
            --text-color-muted: #9ca3af;
            --text-color-inverted: #111827; /* For text on primary bg */
            --text-color-subtle: #9ca3af;

            --bg-color: #111827; /* Dark gray */
            --bg-color-alt: #1f2937; /* Slightly lighter dark gray for cards/modals */
            --bg-color-sidebar: #1f2937;
            --bg-color-header: rgba(31, 41, 55, 0.9);
            --bg-color-modal: #1f2937;
            --bg-color-hover: #374151;
            --bg-color-active: var(--primary-color);

            --border-color: #374151;
            --border-color-darker: #4b5563;

            --card-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            --card-hover-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            
            --border-radius: 0.5rem; 
            --border-radius-lg: 0.75rem;
            --header-height: 70px;
            --sidebar-width: 260px;
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            line-height: 1.6;
            font-size: 16px;
        }

        .container-fluid {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-color-sidebar);
            padding: 1.5rem;
            border-right: 1px solid var(--border-color); /* LTR */
            position: fixed;
            top: 0;
            left: 0; /* LTR */
            height: 100vh;
            overflow-y: auto;
            transition: transform 0.3s ease-in-out, background-color 0.3s ease, border-color 0.3s ease;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }
        .sidebar.closed {
            transform: translateX(-100%); /* LTR */
        }
        @media (min-width: 768px) {
            .sidebar.closed { transform: translateX(0); } /* Sidebar always effectively open on desktop */
        }

        .sidebar-header {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            color: var(--text-color); 
        }
        .sidebar-header i { 
            margin-right: 0.75rem; /* LTR */
            color: var(--primary-color);
            font-size: 1.8rem;
        }
        .sidebar-logo-text {
             color: var(--text-color);
        }

        .sidebar-nav { flex-grow: 1; }

        .sidebar-section-title {
            padding-left: 0.75rem; /* LTR */
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--text-color-muted);
        }

        .sidebar-link {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-radius: var(--border-radius);
            transition: background-color 0.2s ease, color 0.2s ease;
            font-weight: 500;
            color: var(--text-color-subtle);
            text-decoration: none;
            margin-bottom: 0.25rem;
        }
        .sidebar-link i {
            margin-right: 0.75rem; /* LTR */
            width: 1.25rem;
            text-align: center;
            color: var(--text-color-muted); 
            transition: color 0.2s ease;
        }
        .sidebar-link:hover {
            background-color: var(--bg-color-hover);
            color: var(--text-color);
        }
        .sidebar-link:hover i {
            color: var(--primary-color);
        }
        .sidebar-link.active {
            background-color: var(--bg-color-active);
            color: var(--text-color-inverted) !important;
            font-weight: 600;
            box-shadow: 0 2px 10px rgba(99, 102, 241, 0.3);
        }
        .sidebar-link.active i {
            color: var(--text-color-inverted) !important;
        }

        .sidebar-footer {
            margin-top: auto; 
            padding-top: 1rem;
        }
        .sidebar-footer button {
            width: 100%;
            margin-top: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sidebar-footer button i { margin-right: 0.5rem; }


        .content-wrapper {
            flex-grow: 1;
            padding-right: 1.5rem; /* LTR */
            padding-left: 1.5rem;
            transition: margin-left 0.3s ease-in-out; /* LTR */
            height: 100vh;
            overflow-y: auto;
        }
        @media (min-width: 768px) {
             .content-wrapper { margin-left: var(--sidebar-width); /* LTR */ }
             /* .sidebar.closed + .content-wrapper { margin-left: 0; } LTR - Not needed as sidebar is always open on desktop */
        }

        .content-header {
            background-color: var(--bg-color-header);
            padding: 1.25rem 2rem; 
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky; 
            top: 0;
            left: var(--sidebar-width); /* LTR, adjusted for fixed sidebar */
            right: 0;
            height: var(--header-height);
            z-index: 50;
            backdrop-filter: blur(8px); 
        }
         @media (max-width: 767px) { /* Mobile: header spans full width */
            .content-header {
                left: 0;
            }
        }
        .header-left-content { display: flex; align-items: center; } 
        #currentSectionTitle {
            font-size: 1.5rem; 
            font-weight: bold;
            margin: 0;
        }
        #breadcrumbs {
            font-size: 0.875rem; 
            color: var(--text-color-muted);
            margin-top: 0.25rem;
        }
        #breadcrumbs a { color: var(--primary-color); text-decoration: none; }
        #breadcrumbs a:hover { text-decoration: underline; }

        .header-right-content { display: flex; align-items: center; gap: 1rem; }
        .search-container { position: relative; }
        .search-container input[type="search"] {
            padding: 0.625rem 1rem 0.625rem 2.5rem; /* py-2.5 pl-10 pr-4 for LTR */
            border: 1px solid var(--border-color-darker);
            border-radius: 9999px; 
            min-width: 250px; 
            background-color: var(--bg-color-alt); 
            color: var(--text-color);
        }
        .search-container .search-icon {
            position: absolute;
            inset-inline-start: 0.75rem; 
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-color-muted);
        }
        #searchResultsContainer {
            position: absolute;
            background-color: var(--bg-color-alt);
            border: 1px solid var(--border-color);
            border-top: none;
            width: 100%; 
            max-height: 300px; 
            overflow-y: auto;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); 
            z-index: 60; 
            border-radius: 0 0 var(--border-radius) var(--border-radius);
        }
        #searchResultsContainer a {
            display: block;
            padding: 0.75rem; 
            text-decoration: none;
            color: var(--text-color);
        }
        #searchResultsContainer a:hover { background-color: var(--bg-color-hover); }
        #searchResultsContainer mark { background-color: #78350f; color: #f3f4f6; }


        .user-profile { display: flex; align-items: center; gap: 0.5rem; }
        .user-profile img { width: 36px; height: 36px; border-radius: 50%; }
        #userNameDisplayHeader { font-weight: 500; }
        @media (max-width: 640px) { 
            #userNameDisplayHeader { display: none; }
        }

        main { padding: 1.5rem 0; }

        .card {
            background-color: var(--bg-color-alt);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg); 
            padding: 1.5rem;
            margin-bottom: 1.5rem; 
            box-shadow: var(--card-shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease, border-color 0.3s ease;
            display: flex;
            flex-direction: column; 
            min-height: 150px; 
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--card-hover-shadow);
        }
        .card-header-icon {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .card-icon-container {
            padding: 0.75rem;
            border-radius: 50%;
            margin-right: 1rem; /* LTR */
            background-color: var(--primary-color-hover); 
        }
        .card-icon-container i {
            font-size: 1.25rem;
            color: var(--text-color-inverted);  
        }
        .card h3 { margin-top: 0; font-size: 1.125rem; font-weight: 600; color: var(--text-color); line-height: 1.3; }
        .card p { margin-bottom: 1rem; font-size: 0.875rem; color: var(--text-color-subtle); flex-grow: 1; }
        .card .item-meta-info {
            margin-top: auto; 
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border-color);
        }
        .card .item-cta-link {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500; 
            font-size: 0.875rem;
        }
        .card .item-cta-link:hover { text-decoration: underline; color: var(--primary-color-hover); }
        .item-type-badge {
            font-size: 0.75rem; 
            padding: 0.25rem 0.75rem; 
            border-radius: 9999px; 
            background-color: var(--bg-color-hover); 
            color: var(--text-color-subtle); 
            font-weight: 600; 
            text-transform: uppercase;
        }
        .card-tags span {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 10px;
            background-color: var(--bg-color-hover);
            color: var(--text-color-subtle);
            display: inline-block;
            margin: 0 5px 5px 0; /* LTR */
        }

        .button, button {
            background-color: var(--primary-color);
            color: var(--text-color-inverted);
            border: 1px solid transparent;
            padding: 0.625rem 1rem; 
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.875rem; 
            font-weight: 500; 
            transition: background-color 0.2s, border-color 0.2s, color 0.2s;
            text-decoration: none; 
            display: inline-flex; 
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .button:hover, button:hover {
            background-color: var(--primary-color-hover);
        }
        .button-secondary {
            background-color: transparent;
            color: var(--text-color-subtle);
            border-color: var(--border-color-darker);
        }
        .button-secondary:hover { background-color: var(--bg-color-hover); color: var(--text-color); }
        .button-danger {
            background-color: #dc2626; 
            color: var(--text-color-inverted);
        }
        .button-danger:hover { background-color: #b91c1c; }
        input:focus, button:focus, select:focus, textarea:focus, a:focus { 
            outline: 2px solid transparent;
            outline-offset: 2px;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.6); 
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.75); 
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.2s ease-out;
        }
        .modal-overlay:not(.hidden) { opacity: 1; }
        .modal-content {
            background-color: var(--bg-color-modal);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 48rem; 
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.95);
            opacity: 0;
            transition: transform 0.2s ease-out, opacity 0.2s ease-out, background-color 0.3s ease, border-color 0.3s ease;
        }
        .modal-overlay:not(.hidden) .modal-content { transform: scale(1); opacity: 1; }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem; 
        }
        .modal-header h2 { margin-top: 0; font-size: 1.5rem; font-weight: 700; }
        .modal-header .close-button { 
            background: none; border: none; font-size: 1.5rem; color: var(--text-color-muted); cursor: pointer;
            padding: 0.25rem; line-height: 1; border-radius: 50%;
        }
        .modal-header .close-button:hover { background-color: var(--bg-color-hover); }
        
        .modal-actions {
            margin-top: 1.5rem; 
            text-align: right; /* LTR */
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end; /* LTR */
            gap: 0.75rem; 
        }

        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.25rem; font-weight: 500; font-size: 0.875rem; }
        .form-group input[type="text"],
        .form-group input[type="url"],
        .form-group input[type="file"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.625rem; 
            border: 1px solid var(--border-color-darker); 
            border-radius: var(--border-radius);
            box-sizing: border-box;
            background-color: var(--bg-color); 
            color: var(--text-color);
        }
        .form-group textarea { min-height: 100px; }
        
        .ql-toolbar {
            background: var(--bg-color);
            border-color: var(--border-color-darker) !important;
            border-top-left-radius: var(--border-radius);
            border-top-right-radius: var(--border-radius);
        }
        .ql-toolbar .ql-stroke { stroke: var(--text-color-muted); }
        .ql-toolbar .ql-fill { fill: var(--text-color-muted); }
        .ql-toolbar .ql-picker-label { color: var(--text-color-muted); }
        .ql-snow .ql-picker.ql-expanded .ql-picker-options { background-color: var(--bg-color-alt); border-color: var(--border-color-darker); }
        .ql-snow .ql-picker-options .ql-picker-item:hover { color: var(--primary-color); }


        .ql-container {
            background: var(--bg-color-alt);
            border-color: var(--border-color-darker) !important;
            color: var(--text-color);
            min-height: 150px; 
            border-bottom-left-radius: var(--border-radius);
            border-bottom-right-radius: var(--border-radius);
            font-size: 1rem;
        }
        .ql-editor { padding: 12px; }


        footer {
            text-align: center;
            padding: 1.5rem;
            font-size: 0.875rem;
            color: var(--text-color-muted);
            border-top: 1px solid var(--border-color);
            margin-top: auto; 
        }
        #reportErrorBtn {
            margin-left: 1rem; /* LTR */
            color: #ef4444; 
            background: none; border: none; padding: 0; text-decoration: underline;
            font-size: 0.75rem; 
        }

        .mobile-sidebar-toggle {
            display: block;
            position: fixed;
            top: calc((var(--header-height) - 40px) / 2); 
            left: 1.5rem; /* LTR */
            z-index: 101; 
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 0.75rem; 
            border-radius: var(--border-radius);
            font-size: 1.25rem; 
            line-height: 1;
        }
        @media (min-width: 768px) {
            .mobile-sidebar-toggle { display: none; }
            .header-left-content #currentSectionTitle { margin-left: 0; } /* No toggle on desktop */
        }
        @media (max-width: 767px) {
            .header-left-content #currentSectionTitle { margin-left: 0.5rem; } /* Space for toggle */
            .content-header { padding: 1rem; }
            .header-right-content .search-container { display:none; } 
        }

        .toast-notification {
            position: fixed;
            bottom: 20px;
            right: 20px; /* LTR */
            padding: 12px 18px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 2000; 
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            display: flex;
            align-items: center;
            background-color: var(--bg-color-alt); 
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }
        .toast-notification.show { opacity: 1; transform: translateY(0); }
        .toast-icon { margin-right: 10px; /* LTR */ font-size: 1.2em; }
        .toast-success { background-color: #10b981; color: white; border-color: #059669; } 
        .toast-error { background-color: #ef4444; color: white; border-color: #dc2626; } 
        .toast-info { background-color: #3b82f6; color: white; border-color: #2563eb; } 

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 1.5rem; 
        }

        .kb-content h1, .kb-content h2, .kb-content h3 { margin-top: 1.5em; margin-bottom: 0.5em; color: var(--text-color); }
        .kb-content p { margin-bottom: 1em; }
        .kb-content ul, .kb-content ol { margin-bottom: 1em; padding-left: 20px; /* LTR */ }
        .kb-content li { margin-bottom: 0.5em; }
        .kb-content strong { font-weight: bold; }
        .kb-content em { font-style: italic; }
        .kb-content a { color: var(--primary-color); text-decoration: underline; }
        .kb-content pre {
            background-color: var(--bg-color);
            padding: 10px;
            border-radius: var(--border-radius);
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            border: 1px solid var(--border-color);
            color: var(--text-color); /* Ensure pre content is visible */
        }
         .kb-content code { /* More specific for inline code if needed */
            background-color: var(--bg-color-hover);
            padding: 0.2em 0.4em;
            margin: 0;
            font-size: 85%;
            border-radius: 3px;
        }
        mark {
            padding: 0.1em 0.2em; border-radius: 0.2em; font-weight: bold;
            background-color: #78350f; color: #f3f4f6; 
        }

        .hidden { display: none !important; }

        .chart-container {
            position: relative;
            padding: 1rem;
            border-radius: var(--border-radius-lg);
            background-color: var(--bg-color-alt);
            height: 320px; 
        }
        .chart-container h3 {
            font-size: 1.125rem; 
            font-weight: 600; 
            margin-bottom: 0.5rem;
            text-align: center;
        }
        .mermaid-diagram-card { /* Specific card for Mermaid diagrams */
            background-color: var(--bg-color-alt);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--card-shadow);
            margin-bottom: 1.5rem;
        }
        .mermaid-diagram-card h3 {
            margin-top: 0;
            margin-bottom: 1rem;
            font-size: 1.25rem;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }
        .mermaid-diagram-container {
            overflow-x: auto; /* For wide diagrams */
            background-color: var(--bg-color-alt); /* Ensure diagram background matches card */
        }
        .mermaid-diagram-container svg {
            display: block;
            margin: 0 auto; 
        }
        /* Mermaid dark theme overrides (Mermaid applies its own styles) */
        .mermaid-diagram-container text { fill: var(--text-color) !important; }
        .mermaid-diagram-container .edgeLabel { background-color: var(--bg-color-alt) !important; color: var(--text-color) !important; }
        .mermaid-diagram-container .label { color: var(--text-color) !important; }
        .mermaid-diagram-container .actor { stroke: var(--text-color-muted) !important; fill: var(--bg-color-alt) !important; }
        .mermaid-diagram-container .messageText { fill: var(--text-color) !important; }
        .mermaid-diagram-container rect, 
        .mermaid-diagram-container polygon, 
        .mermaid-diagram-container ellipse,
        .mermaid-diagram-container circle {
            stroke: var(--primary-color) !important;
            fill: var(--bg-color) !important; /* Node fill */
        }
        .mermaid-diagram-container .node.default>rect {
             fill: var(--bg-color) !important; /* Explicitly target default nodes if needed */
        }
        .mermaid-diagram-container .cluster rect {
             fill: var(--bg-color-alt) !important; /* Subgraph / cluster background */
             stroke: var(--border-color-darker) !important;
        }
        .mermaid-diagram-container .arrowheadPath {
            fill: var(--primary-color) !important;
        }
        .mermaid-diagram-container .edgePaths path {
            stroke: var(--primary-color) !important;
        }


        /* Item Detail View Specific */
        #itemDetailViewPlaceholder .card {
            border-top: 4px solid var(--primary-color); 
        }
        #itemDetailViewPlaceholder .item-title-area {
            display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;
        }
        #itemDetailViewPlaceholder .item-title-area i { font-size: 2rem; color: var(--primary-color); }
        #itemDetailViewPlaceholder .item-title-area h2 { font-size: 1.8rem; margin:0; }
        #itemDetailViewPlaceholder .item-summary { color: var(--text-color-subtle); margin-bottom: 1rem; font-style: italic; }
        #itemDetailViewPlaceholder hr { margin: 1.5rem 0; border-color: var(--border-color); }

        /* Dashboard specific styles */
        .dashboard-stat-card {
            background-color: var(--bg-color-alt);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--card-shadow);
            text-align: center;
        }
        .dashboard-stat-card i {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 0.75rem;
        }
        .dashboard-stat-card .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            display: block;
            margin-bottom: 0.25rem;
        }
        .dashboard-stat-card .stat-label {
            font-size: 0.875rem;
            color: var(--text-color-muted);
        }
        .dashboard-quicklink-card {
             background-color: var(--bg-color-alt);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--card-shadow);
        }
         .dashboard-quicklink-card h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        .dashboard-quicklink-card ul {
            list-style: none;
            padding: 0;
        }
        .dashboard-quicklink-card ul li a {
            display: block;
            padding: 0.5rem 0;
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
        }
         .dashboard-quicklink-card ul li a:hover {
            text-decoration: underline;
        }

    </style>
</head>
<body>

    <div id="addContentModalOverlay" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="addContentModalTitle">Add New Content</h2>
                <button id="closeAddContentModalBtn" class="close-button" aria-label="Close">×</button>
            </div>
            <form id="addContentForm">
                <div class="form-group">
                    <label for="contentType">Content Type</label>
                    <select id="contentType">
                        <option value="article">Article</option>
                        <option value="case">Case</option>
                        <option value="form_sheet">Form/Sheet (Link)</option>
                        <option value="design">Design (Link)</option>
                        <option value="guide">Guide</option>
                        <option value="policy">Policy</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="contentTitle">Title</label>
                    <input type="text" id="contentTitle" required>
                </div>
                <div class="form-group">
                    <label for="contentSummary">Summary / Description</label>
                    <textarea id="contentSummary" rows="3" required></textarea>
                </div>
                
                <div class="form-group hidden" id="contentUrlContainer">
                    <label for="contentUrl">Link (for Forms, Designs, etc.)</label>
                    <input type="url" id="contentUrl">
                </div>

                <div class="form-group" id="contentDetailContainer">
                    <label for="contentDetail" id="contentDetailLabel">Details / Content</label>
                    <div id="quillEditor"></div> <!-- Quill editor container -->
                </div>

                <div class="form-group">
                    <label for="contentTags">Tags (comma-separated)</label>
                    <input type="text" id="contentTags" placeholder="e.g., important, update, billing">
                </div>

                <hr style="border-color: var(--border-color-darker); margin: 1.5rem 0;">
                <h3 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem;">Attachments (Optional)</h3>
                
                <div class="form-group">
                    <label for="pdfFile">Upload PDF</label>
                    <input type="file" id="pdfFile" accept=".pdf">
                </div>
                <div class="form-group">
                    <label for="imageFile">Upload Image</label>
                    <input type="file" id="imageFile" accept="image/*">
                </div>
                <div class="form-group">
                    <label for="videoLink">Video Link (e.g., YouTube, Vimeo)</label>
                    <input type="url" id="videoLink" placeholder="https://">
                </div>
                <div class="form-group">
                    <label for="driveLink">Google Drive Link</label>
                    <input type="url" id="driveLink" placeholder="https://docs.google.com/... or https://drive.google.com/...">
                </div>


                <div class="modal-actions">
                    <button type="submit" id="saveContentBtn" class="button"><i class="fas fa-save"></i> Save Content</button>
                    <button type="button" id="cancelAddContentBtn" class="button-secondary"><i class="fas fa-times"></i> Cancel</button>
                </div>
            </form>
        </div>
    </div>


    <div class="container-fluid">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-database"></i> <span class="sidebar-logo-text">InfiniBase</span>
            </div>
            <nav id="navigationMenu" class="sidebar-nav">
                <!-- Links will be dynamically generated -->
            </nav>
            <div class="sidebar-footer">
                 <!-- Theme switcher removed -->
                <button id="logoutButton" class="button button-danger">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </aside>

        <div class="content-wrapper" id="contentWrapper">
            <header class="content-header">
                <div class="header-left-content">
                    <button id="mobileSidebarToggle" class="mobile-sidebar-toggle"><i class="fas fa-bars"></i></button>
                    <div>
                        <h1 id="currentSectionTitle">Welcome</h1>
                        <div id="breadcrumbs">Home</div>
                    </div>
                </div>
                <div class="header-right-content">
                    <div class="search-container">
                        <span class="search-icon"><i class="fas fa-search"></i></span>
                        <input type="search" id="globalSearchInput" placeholder="Search the knowledge base...">
                        <div id="searchResultsContainer" class="hidden"></div>
                    </div>
                    <div id="userProfileContainer" class="user-profile">
                        <img id="userAvatar" src="https://ui-avatars.com/api/?name=U&size=36&background=6366f1&color=fff&rounded=true" alt="User">
                        <span id="userNameDisplayHeader" style="font-weight: 500;">User</span>
                    </div>
                </div>
            </header>

            <main id="pageContentArea" class="p-6 md:p-8">
                <div id="dashboardOverviewContainer" class="hidden">
                    <!-- Dashboard content will be injected here -->
                </div>
                <div id="standardSectionContentPlaceholder">
                    <!-- Section content will be injected here -->
                </div>
                <div id="itemDetailViewPlaceholder" class="hidden">
                    <!-- Item detail view -->
                </div>
            </main>

            <footer class="mt-auto p-6 text-center text-sm">
                <span>© <script>document.write(new Date().getFullYear())</script> InfiniBase. Version <span id="footerKbVersion">0.1.0</span></span>
                <button id="reportErrorBtn">Report an Issue</button>
            </footer>
        </div>
    </div>
    <div id="toastContainer"></div>

<script type="module">
    // --- Initialize Mermaid ---
    mermaid.initialize({ 
        startOnLoad: false, // We will call mermaid.run() manually after content is loaded
        theme: 'dark', 
        fontFamily: 'Inter, sans-serif',
        flowchart: {
            htmlLabels: true,
            useMaxWidth: true,
        },
        themeVariables: { // Overriding theme variables for better consistency with page style
            primaryColor: getComputedStyle(document.documentElement).getPropertyValue('--bg-color-alt').trim(), // Diagram background
            primaryTextColor: getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim(),
            primaryBorderColor: getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim(), // Node border
            lineColor: getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim(), // Edge color
            textColor: getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim(),
            secondaryColor: getComputedStyle(document.documentElement).getPropertyValue('--bg-color').trim(), // Node fill (main background)
            tertiaryColor: getComputedStyle(document.documentElement).getPropertyValue('--bg-color-alt').trim(), // Node fill for specific types if used
            background: getComputedStyle(document.documentElement).getPropertyValue('--bg-color-alt').trim(), // Diagram overall background
            
            // Ensure node specific colors are distinct if needed
            nodeBorder: getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim(),
            clusterBkg: getComputedStyle(document.documentElement).getPropertyValue('--bg-color').trim(), // Subgraph background
            clusterBorder: getComputedStyle(document.documentElement).getPropertyValue('--border-color-darker').trim(),
            defaultLinkColor: getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim(),
            edgeLabelBackground: getComputedStyle(document.documentElement).getPropertyValue('--bg-color-alt').trim(),
        }
    });
    
    // --- Simulated Auth & Data ---
    const Auth = {
        isAuthenticated: () => {
            return !!localStorage.getItem('infiniBaseUser');
        },
        getCurrentUser: () => {
            const storedUser = localStorage.getItem('infiniBaseUser');
            if (storedUser) return JSON.parse(storedUser);
            return null; 
        },
        logout: () => {
            const user = Auth.getCurrentUser();
            const userName = user ? user.fullName : 'User';
            localStorage.removeItem('infiniBaseUser');
            localStorage.removeItem('justLoggedIn'); // Clear login flag
            showToast(`${userName} logged out successfully. Redirecting to login...`, 'info');
            setTimeout(() => {
                window.location.href = 'login.html'; 
            }, 1500);
        }
    };

    let kbSystemData = {
        meta: { version: '0.5.1', lastGlobalUpdate: new Date().toISOString(), lastArticleAdded: null, editsThisWeek: 0 },
        sections: [
            { id: 'home', name: 'Home', icon: 'fas fa-home', description: 'Dashboard and overview.' },
            {
                id: 'support', name: 'Support', icon: 'fas fa-headset', description: 'Support resources and flows.',
                items: [
                     { 
                        id: 'sup_flow_compensation', type: 'article', 
                        title: 'Scenario: Customer Inquiry - Compensation Flow for Delays', 
                        summary: 'Flowchart for handling customer compensation due to order delays, simplified.',
                        content: `
                            <p>This diagram outlines the decision-making process for compensating customers due to order delays.</p>
                            <div class="mermaid-diagram-container">
                                <div class="mermaid">
graph TD
    A[Customer Inquiry: Order Delay] --> B{Initial Check: Valid Delay Confirmed?};
    B -- Yes --> C{Order Type?};
    B -- No --> X[Action: Apologize, Provide New ETA, Monitor. No Compensation Initially.];
    
    C -- Fast Delivery --> D{Delay Duration?};
    D -- 15-30 mins --> E[Action: Apologize, Set New ETA, Monitor Closely];
    D -- 31-45 mins --> F[Action: Compensate 25% Delivery Fee];
    D -- 46-60 mins --> G[Action: Compensate 50% Delivery Fee];
    D -- Over 60 mins --> H[Action: Compensate Full Delivery Fee];

    C -- Scheduled Delivery --> I{Delay Duration?};
    I -- Up to 30 mins --> J[Action: Apologize, Reassure, Monitor];
    I -- 31-60 mins --> K[Action: Compensate 100% Order Value (if major disruption)];
    I -- Over 60 mins --> L[Action: Compensate Full Order Value + Future Credit ($10)];
    
    X --> Z((End Interaction));
    E --> Z; F --> Z; G --> Z; H --> Z;
    J --> Z; K --> Z; L --> Z;

    subgraph Legend
        direction LR
        L1[Action/Information]
        L2{Decision Point}
        L3((End of Flow))
    end
    
    classDef default fill:var(--bg-color),stroke:var(--primary-color),stroke-width:2px,color:var(--text-color),font-family:Inter;
    classDef decision fill:var(--bg-color-alt),stroke:var(--text-color-muted),stroke-width:1px,color:var(--text-color),font-family:Inter;
    classDef endNode fill:var(--primary-color-hover),stroke:var(--primary-color),stroke-width:2px,color:var(--text-color-inverted),font-family:Inter;
    classDef legendNode fill:var(--bg-color-alt),stroke:var(--border-color),color:var(--text-color-subtle),font-size:12px,font-family:Inter;

    class A,E,F,G,H,J,K,L,X default;
    class B,C,D,I decision;
    class Z endNode;
    class L1,L2,L3 legendNode;

                                </div>
                            </div>
                            <p><strong>Important Considerations:</strong></p>
                            <ul>
                                <li>Always verify the cause of the delay (Store, Driver, System). This may influence compensation details or internal follow-up.</li>
                                <li>Maximum compensation for delivery fee related issues should not exceed $5 if the original delivery fee was less than $5.</li>
                                <li>Maintain a positive and empathetic tone throughout the interaction.</li>
                            </ul>
                        `,
                        tags: ['compensation', 'customer service', 'delay', 'flowchart', 'support policy']
                    },
                ]
            },
            { id: 'partner_care', name: 'Partner Care', icon: 'fas fa-handshake', description: 'Resources for partner management.', items: [] },
            { id: 'logistics', name: 'Logistics', icon: 'fas fa-truck', description: 'Logistics operations and information.', items: [] },
            { id: 'customer_care', name: 'Customer Care', icon: 'fas fa-users', description: 'Customer service guidelines and FAQs.', items: [] },
            { id: 'distribution_followup', name: 'Distribution & Follow-up', icon: 'fas fa-people-carry', description: 'Distribution processes and tracking.', items: [] },
            { id: 'logistics_driver_complaints', name: 'Logistics (Driver Complaints)', icon: 'fas fa-shipping-fast', description: 'Handling driver-related complaints.', items: [] },
            { id: 'logistics_3pl', name: 'Logistics-3PL', icon: 'fas fa-boxes-stacked', description: 'Third-party logistics information.', items: [] },
            { id: 'order_at_store_mac', name: 'Order at Store (Mac)', icon: 'fas fa-store', description: 'Procedures for Mac orders at store.', items: [] },
            { id: 'logistics_admin', name: 'Logistics-Admin', icon: 'fas fa-user-shield', description: 'Administrative tasks for logistics.', items: [] },
            { id: 'operating_systems', name: 'Operating Systems', icon: 'fab fa-windows', description: 'OS troubleshooting and guides.', items: [] },
            { id: 'compensation_policies', name: 'Compensation Policies', icon: 'fas fa-hand-holding-usd', description: 'Detailed compensation policies.', items: [] },
            { id: 'operational_instructions', name: 'Operational Instructions', icon: 'fas fa-clipboard-list', description: 'Standard operating procedures.', items: [] },
            { id: 'forms_templates', name: 'Forms/Templates', icon: 'fas fa-file-alt', description: 'Standard forms and templates.', items: [
                // "Leave Request Form" removed as per request, section is empty.
            ]}
        ]
    };

    // --- DOM Elements ---
    const sidebar = document.getElementById('sidebar');
    const mobileSidebarToggle = document.getElementById('mobileSidebarToggle');
    const navigationMenu = document.getElementById('navigationMenu');
    const currentSectionTitleEl = document.getElementById('currentSectionTitle');
    const breadcrumbsContainer = document.getElementById('breadcrumbs');
    const pageContentArea = document.getElementById('pageContentArea');
    const dashboardOverviewContainer = document.getElementById('dashboardOverviewContainer');
    const standardSectionContentPlaceholder = document.getElementById('standardSectionContentPlaceholder');
    const itemDetailViewPlaceholder = document.getElementById('itemDetailViewPlaceholder');
    const userNameDisplayHeader = document.getElementById('userNameDisplayHeader');
    const userAvatar = document.getElementById('userAvatar');
    const footerKbVersion = document.getElementById('footerKbVersion');

    const addContentModalOverlay = document.getElementById('addContentModalOverlay');
    const closeAddContentModalBtn = document.getElementById('closeAddContentModalBtn');
    const addContentForm = document.getElementById('addContentForm');
    const cancelAddContentBtn = document.getElementById('cancelAddContentBtn');
    const contentTypeSelect = document.getElementById('contentType');
    const contentUrlContainer = document.getElementById('contentUrlContainer');
    const contentDetailContainer = document.getElementById('contentDetailContainer');
    const contentDetailLabel = document.getElementById('contentDetailLabel');
    const contentTagsInput = document.getElementById('contentTags');
    
    const globalSearchInput = document.getElementById('globalSearchInput');
    const searchResultsContainer = document.getElementById('searchResultsContainer');

    let quillEditor; 
    let currentUser = null; // Will be set in initializeApp
    let currentOpenItem = null;
    let visitorsChartInstance, casesChartInstance, articlesChartInstance; 

    // --- Utility Functions ---
    function escapeHTML(str) {
        if (typeof str !== 'string') return '';
        const el = document.createElement('div');
        el.textContent = str;
        return el.innerHTML;
    }

    function highlightText(text, query) {
        if (!text) return '';
        const safeText = escapeHTML(text);
        if (!query) return safeText;
        try {
            const rgx = new RegExp(`(${query.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')})`, 'gi');
            return safeText.replace(rgx, '<mark>$1</mark>');
        } catch (e) { return safeText; }
    }

    function truncateText(text, len) {
        if (!text || text.length <= len) return text;
        return text.substring(0, len) + '...';
    }
    function stripHtml(html){
       let tmp = document.createElement("DIV");
       tmp.innerHTML = html;
       return tmp.textContent || tmp.innerText || "";
    }

    function showToast(message, type = 'info', duration = 3000) {
        const toastContainer = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast-notification toast-${type}`;
        
        let iconClass = 'fas fa-info-circle';
        if (type === 'success') iconClass = 'fas fa-check-circle';
        else if (type === 'error') iconClass = 'fas fa-times-circle';

        toast.innerHTML = `<i class="toast-icon ${iconClass}"></i> <span>${escapeHTML(message)}</span>`;
        toastContainer.appendChild(toast);

        setTimeout(() => toast.classList.add('show'), 10);

        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, duration);
    }
    
    function applyPermanentDarkMode() {
        // Theme is permanently dark via HTML class and CSS variables.
        // This function can update dynamic elements if needed, e.g., charts.
        [visitorsChartInstance, casesChartInstance, articlesChartInstance].forEach(chart => {
            if (chart) {
                const legendColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim();
                const ticksColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color-muted').trim();
                const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim();
                
                chart.options.plugins.legend.labels.color = legendColor;
                if (chart.options.scales && chart.options.scales.y) {
                    chart.options.scales.y.ticks.color = ticksColor;
                    chart.options.scales.y.grid.color = gridColor;
                    chart.options.scales.x.ticks.color = ticksColor;
                    chart.options.scales.x.grid.color = gridColor;
                }
                chart.update();
            }
        });
        // Re-render Mermaid diagrams if visible, as themeVariables might need re-application
        if (!itemDetailViewPlaceholder.classList.contains('hidden') || !standardSectionContentPlaceholder.classList.contains('hidden')) {
             renderMermaidDiagramsInElement(pageContentArea);
        }
    }

    // --- Sidebar and Navigation ---
    function populateSidebar() {
        let menuHTML = '';
        const mainSections = ['home'];
        const knowledgeAreas = [
            'support', 'partner_care', 'logistics', 'customer_care', 
            'distribution_followup', 'logistics_driver_complaints', 'logistics_3pl', 
            'order_at_store_mac', 'logistics_admin', 'operating_systems'
        ];
        const resourcesPolicies = [
            'compensation_policies', 'operational_instructions', 'forms_templates'
        ];

        menuHTML += `<div class="sidebar-section-title">MAIN</div>`;
        kbSystemData.sections.filter(s => mainSections.includes(s.id)).forEach(section => {
            menuHTML += `<a href="#${section.id}" class="sidebar-link" data-section="${section.id}">
                <i class="${section.icon || 'fas fa-file-alt'}"></i>${escapeHTML(section.name)}
            </a>`;
        });
        
        menuHTML += `<div class="sidebar-section-title">KNOWLEDGE AREAS</div>`;
        kbSystemData.sections.filter(s => knowledgeAreas.includes(s.id)).forEach(section => {
            menuHTML += `<a href="#${section.id}" class="sidebar-link" data-section="${section.id}">
                <i class="${section.icon || 'fas fa-folder'}"></i>${escapeHTML(section.name)}
            </a>`;
        });

        menuHTML += `<div class="sidebar-section-title">RESOURCES & POLICIES</div>`;
        kbSystemData.sections.filter(s => resourcesPolicies.includes(s.id)).forEach(section => {
            menuHTML += `<a href="#${section.id}" class="sidebar-link" data-section="${section.id}">
                <i class="${section.icon || 'fas fa-book'}"></i>${escapeHTML(section.name)}
            </a>`;
        });

        navigationMenu.innerHTML = menuHTML;
    }

    mobileSidebarToggle.addEventListener('click', () => sidebar.classList.toggle('closed'));
    sidebar.addEventListener('click', (e) => {
        if (e.target.closest('.sidebar-link') && window.innerWidth < 768) {
            sidebar.classList.add('closed');
        }
    });

    function highlightSidebarLink(sectionId) {
        document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
        const activeLink = document.querySelector(`.sidebar-link[data-section="${sectionId}"]`);
        if (activeLink) activeLink.classList.add('active');
    }
    
    // --- Mermaid Rendering ---
    async function renderMermaidDiagramsInElement(element) {
        const mermaidElements = element.querySelectorAll('pre.mermaid');
        if (mermaidElements.length > 0) {
            // Temporarily show hidden parents for rendering, then hide again.
            const initiallyHiddenParents = [];
            mermaidElements.forEach(el => {
                let parent = el.parentElement;
                while(parent && parent !== document.body) {
                    if (parent.classList.contains('hidden') || (parent.style.display === 'none')) {
                        const oldDisplay = parent.style.display;
                        parent.classList.remove('hidden');
                        parent.style.display = ''; // Remove inline style if it was 'none'
                        initiallyHiddenParents.push({el: parent, display: oldDisplay});
                    }
                    if(parent.classList.contains('modal-overlay') || parent.classList.contains('content-wrapper') || parent.classList.contains('card')) break;
                    parent = parent.parentElement;
                }
            });
    
            for (let i = 0; i < mermaidElements.length; i++) {
                const preElement = mermaidElements[i];
                const diagramContainer = preElement.parentElement; // Should be .mermaid-diagram-container
                
                // Remove any existing SVG sibling to prevent duplicates on re-render
                const existingSvg = diagramContainer.querySelector('svg');
                if(existingSvg) existingSvg.remove();
                
                preElement.style.display = 'block'; // Ensure pre is visible for mermaid to process
                preElement.removeAttribute('data-processed'); // Allow re-processing

                try {
                    // mermaid.run processes nodes in place.
                    await mermaid.run({ nodes: [preElement], suppressErrors: false });
                    // After run, mermaid might hide the <pre> and insert an <svg>
                    // We want to ensure the pre remains hidden if an SVG was generated.
                     if (diagramContainer.querySelector('svg')) {
                        preElement.style.display = 'none';
                    } else {
                         // Fallback if mermaid.run didn't produce SVG directly or pre is still visible
                        console.warn("Mermaid.run did not replace pre with SVG or pre is still visible. Manual rendering might be needed or check pre content.");
                        preElement.style.display = 'block'; // Keep it visible if no SVG
                    }
                } catch (error) {
                    console.error("Mermaid rendering error:", error, "for diagram:", preElement.textContent);
                    const errorMsg = document.createElement('p');
                    errorMsg.style.color = 'red';
                    errorMsg.textContent = `Error rendering diagram: ${error.message}. Check console for details.`;
                    diagramContainer.appendChild(errorMsg);
                    preElement.style.display = 'block'; // Show pre if error
                }
            }
            // Restore hidden state for parents
            initiallyHiddenParents.forEach(pInfo => {
                if (pInfo.display === 'none') pInfo.el.style.display = 'none';
                else pInfo.el.classList.add('hidden'); // If it was class-based
            });
        }
    }


    // --- Content Display ---
    function renderItemCard(item, sectionData) {
        let itemIconClass = 'fas fa-file-alt'; 
        let ctaText = 'View Details';
        let ctaLink = `#${sectionData.id}/${item.id}`;
        let target = '';
        let itemTypeDisplay = item.type.replace('_', ' ');

        if (item.type === 'article') { itemIconClass = 'fas fa-newspaper'; itemTypeDisplay = 'Article';}
        else if (item.type === 'case') { itemIconClass = 'fas fa-briefcase'; itemTypeDisplay = 'Case';}
        else if (item.type === 'form_sheet') { itemIconClass = 'fas fa-file-invoice'; ctaText = 'Open Link'; ctaLink = item.url || '#'; target = '_blank'; itemTypeDisplay = 'Form/Sheet';}
        else if (item.type === 'design') {itemIconClass = 'fas fa-palette'; ctaText = 'View Design'; ctaLink = item.url || '#'; target = '_blank'; itemTypeDisplay = 'Design';}
        else if (item.type === 'guide') { itemIconClass = 'fas fa-book-open'; itemTypeDisplay = 'Guide';}
        else if (item.type === 'policy') { itemIconClass = 'fas fa-gavel'; itemTypeDisplay = 'Policy';}


        const cardIconContainerColor = 'var(--primary-color-hover)'; 
        const cardIconColor = 'var(--text-color-inverted)';

        return `
        <div class="card" data-item-id="${item.id}" data-item-type="${item.type}">
            <div class="card-header-icon">
                <div class="card-icon-container" style="background-color: ${cardIconContainerColor};">
                    <i class="${itemIconClass}" style="color: ${cardIconColor};"></i>
                </div>
                <h3>${escapeHTML(item.title)}</h3>
            </div>
            <p>${escapeHTML(truncateText(stripHtml(item.summary), 120))}</p>
            ${item.tags && item.tags.length ? `<div class="card-tags">${item.tags.map(tag => `<span>${escapeHTML(tag)}</span>`).join('')}</div>` : ''}
            <div class="item-meta-info">
                <span class="item-type-badge">${escapeHTML(itemTypeDisplay)}</span>
                <a href="${escapeHTML(ctaLink)}" ${target ? `target="${target}" rel="noopener noreferrer"` : ''} class="item-cta-link"
                   data-item-id="${item.id}" data-section-id="${sectionData.id}" data-item-type="${item.type}">
                   ${ctaText} <i class="fas fa-arrow-right"></i> <!-- LTR arrow -->
                </a>
            </div>
        </div>`;
    }

    async function displayDashboard() {
        dashboardOverviewContainer.classList.remove('hidden');
        standardSectionContentPlaceholder.classList.add('hidden');
        itemDetailViewPlaceholder.classList.add('hidden');
        currentSectionTitleEl.textContent = 'Dashboard';
        breadcrumbsContainer.innerHTML = `<span style="font-weight: bold; color: var(--primary-color);">Home</span>`;

        const welcomeUser = currentUser.fullName || 'User';
        const totalArticles = kbSystemData.sections.reduce((sum, s) => sum + (s.items?.filter(i => i.type === 'article' || i.type === 'guide' || i.type === 'policy').length || 0), 0);
        const totalCases = kbSystemData.sections.reduce((sum, s) => sum + (s.items?.filter(i => i.type === 'case').length || 0), 0);
        
        kbSystemData.meta.editsThisWeek = Math.floor(Math.random() * 15) + (kbSystemData.meta.editsThisWeek || 0) ; // Mock some activity
        if (!kbSystemData.meta.lastArticleAdded) {
            const allItems = kbSystemData.sections.flatMap(s => s.items || []);
            if (allItems.length > 0) {
                 const latestItem = allItems.sort((a,b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0))[0];
                 if (latestItem) {
                     const itemTypeForDisplay = latestItem.type.charAt(0).toUpperCase() + latestItem.type.slice(1);
                     kbSystemData.meta.lastArticleAdded = { title: `(${itemTypeForDisplay}) ${latestItem.title}`, date: new Date(latestItem.createdAt || Date.now()).toLocaleDateString() };
                 } else {
                     kbSystemData.meta.lastArticleAdded = { title: "N/A", date: "N/A" };
                 }
            } else {
                 kbSystemData.meta.lastArticleAdded = { title: "N/A", date: "N/A" };
            }
        }


        dashboardOverviewContainer.innerHTML = `
            <div class="card" style="background: linear-gradient(to right, var(--primary-color), #4c1d95); color: white;"> <!-- LTR gradient -->
                <h2 style="font-size: 2rem; margin-bottom: 8px;">Welcome back, ${escapeHTML(welcomeUser)}!</h2>
                <p style="opacity: 0.8;">Overview of your knowledge base activity.</p>
                <p style="font-size: 0.9rem; opacity: 0.7; margin-top: 4px;">InfiniBase Version ${escapeHTML(kbSystemData.meta.version)} | Last Global Update: ${new Date(kbSystemData.meta.lastGlobalUpdate).toLocaleDateString()}</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 my-6">
                <div class="dashboard-stat-card">
                    <i class="fas fa-folder-open"></i>
                    <span class="stat-value">${kbSystemData.sections.length -1}</span> <!-- Exclude Home -->
                    <span class="stat-label">Total Sections</span>
                </div>
                <div class="dashboard-stat-card">
                    <i class="fas fa-newspaper"></i>
                    <span class="stat-value">${totalArticles}</span>
                    <span class="stat-label">Total Articles</span>
                </div>
                 <div class="dashboard-stat-card">
                    <i class="fas fa-briefcase"></i>
                    <span class="stat-value">${totalCases}</span>
                    <span class="stat-label">Total Cases</span>
                </div>
                <div class="dashboard-stat-card">
                    <i class="fas fa-edit"></i>
                    <span class="stat-value">${kbSystemData.meta.editsThisWeek}</span>
                    <span class="stat-label">Edits This Week</span>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card chart-container">
                        <h3>Visitors Activity (Mock)</h3>
                        <canvas id="visitorsChart"></canvas>
                    </div>
                    <div class="card chart-container">
                        <h3>Content Types (Mock)</h3>
                        <canvas id="articlesChart"></canvas> 
                    </div>
                </div>
                <div class="dashboard-quicklink-card card">
                    <h3>Quick Links</h3>
                    <ul>
                        <li><a href="#" id="dashboardAddContentLink"><i class="fas fa-plus-circle fa-fw"></i> Add New Content</a></li>
                        <li><a href="#support/${kbSystemData.sections.find(s=>s.id==='support').items[0]?.id || ''}"><i class="fas fa-project-diagram fa-fw"></i> View Support Flow</a></li>
                        <li><a href="#forms_templates"><i class="fas fa-file-alt fa-fw"></i> Browse Templates</a></li>
                    </ul>
                     <h3 style="margin-top: 1.5rem;">Last Added</h3>
                     <p style="font-size: 0.9rem; color: var(--text-color-subtle);">${escapeHTML(kbSystemData.meta.lastArticleAdded.title)} <br><small>(${escapeHTML(kbSystemData.meta.lastArticleAdded.date)})</small></p>
                     <h3 style="margin-top: 1.5rem;">Top Viewed (Placeholder)</h3>
                     <p style="font-size: 0.9rem; color: var(--text-color-subtle);">Feature coming soon!</p>
                </div>
            </div>
        `;
        
        document.getElementById('dashboardAddContentLink').addEventListener('click', (e) => {
            e.preventDefault();
            openAddContentModal(kbSystemData.sections.find(s => s.id !== 'home')?.id || 'support'); 
        });

        const legendColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim();
        const ticksColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color-muted').trim();
        const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim();

        const chartOptions = (type) => ({
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { labels: { color: legendColor, font: { family: 'Inter, sans-serif' } } } },
            scales: type === 'bar' || type === 'line' ? {
                y: { ticks: { color: ticksColor, beginAtZero: true, font: { family: 'Inter, sans-serif' } }, grid: { color: gridColor } },
                x: { ticks: { color: ticksColor, font: { family: 'Inter, sans-serif' } }, grid: { color: gridColor } }
            } : {}
        });

        if (visitorsChartInstance) visitorsChartInstance.destroy();
        const visitorsCtx = document.getElementById('visitorsChart')?.getContext('2d');
        if (visitorsCtx) {
            visitorsChartInstance = new Chart(visitorsCtx, {
                type: 'line',
                data: { labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'], datasets: [{ label: 'Page Views', data: [65, 59, 80, 81, 56, 55, 40], borderColor: 'rgba(99, 102, 241, 0.8)', backgroundColor: 'rgba(99, 102, 241, 0.2)', tension: 0.3, fill: true }] },
                options: chartOptions('line')
            });
        }

        if (articlesChartInstance) articlesChartInstance.destroy();
        const articlesCtx = document.getElementById('articlesChart')?.getContext('2d');
        if (articlesCtx) {
            articlesChartInstance = new Chart(articlesCtx, {
                type: 'doughnut', 
                data: { labels: ['Articles', 'Cases', 'Guides', 'Policies'], datasets: [{ data: [totalArticles, totalCases, 5, 3], backgroundColor: ['#6366f1', '#ec4899', '#22d3ee', '#f59e0b'] }] },
                options: chartOptions('doughnut') 
            });
        }
    }
    
    function displaySectionContent(sectionId, subCategoryFilter = null) {
        currentOpenItem = null;
        dashboardOverviewContainer.classList.add('hidden');
        standardSectionContentPlaceholder.classList.remove('hidden');
        itemDetailViewPlaceholder.classList.add('hidden');

        const sectionData = kbSystemData.sections.find(s => s.id === sectionId);
        if (!sectionData) {
            standardSectionContentPlaceholder.innerHTML = `<div class="card" style="text-align: center;"><h2 style="color: red;">Section not found: ${escapeHTML(sectionId)}</h2></div>`;
            currentSectionTitleEl.textContent = 'Not Found';
            return;
        }

        currentSectionTitleEl.textContent = sectionData.name;
        let bcHTML = `<a href="#home">Home</a> <span style="margin: 0 5px;">›</span> <span style="font-weight: bold; color: var(--primary-color);">${escapeHTML(sectionData.name)}</span>`;
        breadcrumbsContainer.innerHTML = bcHTML;

        let contentHTML = `<div>`;
        // Show "Add Content" button if user is admin and not on home page
        if (currentUser && currentUser.role === 'admin' && sectionId !== 'home') {
             contentHTML += `
                <div style="text-align: right; margin-bottom: 20px;"> <!-- LTR: align right -->
                    <button id="openAddContentBtn" class="button" data-section-id="${sectionData.id}">
                        <i class="fas fa-plus-circle"></i> Add Content to ${escapeHTML(sectionData.name)}
                    </button>
                </div>`;
        }

        const itemsToDisplay = (sectionData.items || [])
            .filter(item => !subCategoryFilter || (item.tags && item.tags.includes(subCategoryFilter)));

        if (itemsToDisplay.length > 0) {
             if (sectionId === 'support' && itemsToDisplay[0]?.id === 'sup_flow_compensation') { 
                const item = itemsToDisplay[0];
                contentHTML += `
                <div class="mermaid-diagram-card">
                    <h3>${escapeHTML(item.title)}</h3>
                    <p>${item.summary}</p> <!-- Assuming summary is HTML safe or plain text -->
                    ${item.content} <!-- This contains the <div class="mermaid">...</div> -->
                </div>`;

            } else {
                contentHTML += `<div class="cards-grid">`;
                itemsToDisplay.forEach(item => contentHTML += renderItemCard(item, sectionData));
                contentHTML += `</div>`;
            }
        }
        
        if (sectionId !== 'support' && !subCategoryFilter && sectionData.subCategories && sectionData.subCategories.length > 0) {
            contentHTML += `<h3 style="font-size: 1.5rem; font-weight: 600; margin-top: 30px; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 8px;">Subcategories</h3><div class="cards-grid">`;
            sectionData.subCategories.forEach(subCat => {
                contentHTML += `<a href="#${sectionData.id}/${subCat.id}" class="card" style="text-align: center; text-decoration: none; color: var(--text-color);">
                    <i class="${subCat.icon || sectionData.icon || 'fas fa-folder-open'}" style="font-size: 2rem; display: block; margin-bottom: 10px; color: var(--primary-color);"></i>
                    <h4 style="margin:0; font-weight: 500;">${escapeHTML(subCat.name)}</h4>
                </a>`;
            });
            contentHTML += `</div>`;
        }

        if (itemsToDisplay.length === 0 && (!sectionData.subCategories || sectionData.subCategories.length === 0 || subCategoryFilter)) {
             contentHTML += `<div class="card" style="text-align: center; padding: 40px 20px;"><p style="font-size: 1.2rem; color: var(--text-color-muted);">No content in this section${subCategoryFilter ? ' or subcategory' : ''} yet.</p></div>`;
        }

        contentHTML += `</div>`;
        standardSectionContentPlaceholder.innerHTML = contentHTML;
        renderMermaidDiagramsInElement(standardSectionContentPlaceholder);


        const openAddBtn = document.getElementById('openAddContentBtn');
        if (openAddBtn) {
            openAddBtn.addEventListener('click', (e) => {
                const currentSecId = e.currentTarget.dataset.sectionId;
                openAddContentModal(currentSecId);
            });
        }
    }

    function displayItemDetail(sectionId, itemId) {
        const sectionData = kbSystemData.sections.find(s => s.id === sectionId);
        const itemData = sectionData?.items?.find(i => i.id === itemId);

        if (!sectionData || !itemData) {
            standardSectionContentPlaceholder.innerHTML = `<p style="color: red;">Error: Item not found.</p>`;
            itemDetailViewPlaceholder.classList.add('hidden');
            standardSectionContentPlaceholder.classList.remove('hidden');
            return;
        }
        currentOpenItem = { sectionId, itemId };

        dashboardOverviewContainer.classList.add('hidden');
        standardSectionContentPlaceholder.classList.add('hidden');
        itemDetailViewPlaceholder.classList.remove('hidden');

        let bcHTML = `
            <a href="#home">Home</a> <span style="margin: 0 5px;">›</span>
            <a href="#${sectionData.id}">${escapeHTML(sectionData.name)}</a> <span style="margin: 0 5px;">›</span>
            <span style="font-weight: bold; color: var(--primary-color);">${escapeHTML(itemData.title)}</span>`;
        breadcrumbsContainer.innerHTML = bcHTML;
        currentSectionTitleEl.textContent = itemData.title;

        let itemIconClass = 'fas fa-file-alt';
        if (itemData.type === 'case') itemIconClass = 'fas fa-briefcase';
        else if (itemData.type === 'article') itemIconClass = 'fas fa-newspaper';
        else if (itemData.type === 'form_sheet') itemIconClass = 'fas fa-file-invoice';
        else if (itemData.type === 'design') itemIconClass = 'fas fa-palette';
        else if (itemData.type === 'guide') itemIconClass = 'fas fa-book-open';
        else if (itemData.type === 'policy') itemIconClass = 'fas fa-gavel';


        let detailHTML = `
            <button id="backToSectionBtn" class="button button-secondary" style="margin-bottom: 20px;">
                <i class="fas fa-arrow-left"></i> Back to ${escapeHTML(sectionData.name)} <!-- LTR arrow -->
            </button>
            <div class="card">
                <div class="item-title-area">
                    <i class="${itemIconClass}"></i>
                    <h2>${escapeHTML(itemData.title)}</h2>
                </div>
                <p class="item-summary">${escapeHTML(itemData.summary)}</p>
                ${itemData.tags && itemData.tags.length ? `<div class="card-tags" style="margin-bottom: 1rem;">${itemData.tags.map(tag => `<span>${escapeHTML(tag)}</span>`).join('')}</div>` : ''}
                <hr>
                <div class="kb-content">`;

        if (itemData.content) { 
            detailHTML += itemData.content;
        } else if (itemData.resolution_steps) { 
             detailHTML += itemData.resolution_steps;
        } else if ((itemData.type === 'form_sheet' || itemData.type === 'design') && itemData.url) {
            detailHTML += `<p>This content is an external link:</p><p><a href="${escapeHTML(itemData.url)}" target="_blank" rel="noopener noreferrer" class="button"><i class="fas fa-external-link-alt"></i> Open Link</a></p>`;
        } else {
            detailHTML += `<p>No detailed content available for this item.</p>`;
        }

        if (itemData.attachments) {
            detailHTML += `<hr><h4 style="margin-top:1.5rem; margin-bottom:1rem; font-weight:600;">Attachments:</h4><ul>`;
            if(itemData.attachments.pdf) detailHTML += `<li><i class="fas fa-file-pdf"></i> <a href="${escapeHTML(itemData.attachments.pdf)}" target="_blank">View PDF</a> (Simulated)</li>`;
            if(itemData.attachments.image) detailHTML += `<li><i class="fas fa-file-image"></i> <a href="${escapeHTML(itemData.attachments.image)}" target="_blank">View Image</a> (Simulated)</li>`;
            if(itemData.attachments.video) detailHTML += `<li><i class="fas fa-video"></i> <a href="${escapeHTML(itemData.attachments.video)}" target="_blank">Watch Video</a></li>`;
            if(itemData.attachments.drive) detailHTML += `<li><i class="fab fa-google-drive"></i> <a href="${escapeHTML(itemData.attachments.drive)}" target="_blank">Open Drive Link</a></li>`;
            detailHTML += `</ul>`;
        }

        detailHTML += `</div></div>`;
        itemDetailViewPlaceholder.innerHTML = detailHTML;
        renderMermaidDiagramsInElement(itemDetailViewPlaceholder);


        document.getElementById('backToSectionBtn').addEventListener('click', () => {
            window.location.hash = `#${sectionId}`;
        });
    }

    // --- Add Content Modal Logic ---
    function openAddContentModal(sectionIdForContent, itemToEdit = null) {
        addContentForm.reset();
        addContentForm.dataset.sectionId = sectionIdForContent;
        
        if (!quillEditor) {
            quillEditor = new Quill('#quillEditor', {
                theme: 'snow',
                modules: { 
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ 'color': [] }, { 'background': [] }],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        [{ 'align': [] }],
                        ['link', 'image', 'video', 'blockquote', 'code-block'], 
                        ['clean']
                    ]
                },
                placeholder: 'Enter detailed content here...'
            });
        }
        quillEditor.root.innerHTML = ''; 

        if (itemToEdit) {
            document.getElementById('addContentModalTitle').textContent = 'Edit Content';
            document.getElementById('contentTitle').value = itemToEdit.title;
            document.getElementById('contentSummary').value = itemToEdit.summary;
            contentTypeSelect.value = itemToEdit.type;
            if (itemToEdit.url) document.getElementById('contentUrl').value = itemToEdit.url;
            if (itemToEdit.content) quillEditor.root.innerHTML = itemToEdit.content;
            else if (itemToEdit.resolution_steps) quillEditor.root.innerHTML = itemToEdit.resolution_steps;
            contentTagsInput.value = (itemToEdit.tags || []).join(', ');
            addContentForm.dataset.itemId = itemToEdit.id; 
            if (itemToEdit.attachments) {
                if(itemToEdit.attachments.video) document.getElementById('videoLink').value = itemToEdit.attachments.video;
                if(itemToEdit.attachments.drive) document.getElementById('driveLink').value = itemToEdit.attachments.drive;
            }
        } else {
            document.getElementById('addContentModalTitle').textContent = 'Add New Content';
            delete addContentForm.dataset.itemId; 
            contentTypeSelect.value = "article";
        }
        
        contentTypeSelect.dispatchEvent(new Event('change'));
        addContentModalOverlay.classList.remove('hidden');
        document.getElementById('contentTitle').focus();
    }

    function closeAddContentModal() {
        addContentModalOverlay.classList.add('hidden');
    }

    contentTypeSelect.addEventListener('change', (e) => {
        const type = e.target.value;
        contentUrlContainer.classList.add('hidden');
        contentDetailContainer.classList.remove('hidden'); 

        if (type === 'form_sheet' || type === 'design') {
            contentUrlContainer.classList.remove('hidden');
            contentDetailContainer.classList.add('hidden'); 
        } else if (type === 'case') {
            contentDetailLabel.textContent = 'Case Details / Resolution Steps';
        } else if (type === 'article') {
            contentDetailLabel.textContent = 'Article Content';
        } else if (type === 'guide') {
            contentDetailLabel.textContent = 'Guide Content';
        } else if (type === 'policy') {
            contentDetailLabel.textContent = 'Policy Details';
        }
    });

    addContentForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const sectionId = addContentForm.dataset.sectionId;
        const section = kbSystemData.sections.find(s => s.id === sectionId);
        if (!section) {
            showToast('Error: Target section not found!', 'error'); return;
        }
        
        const itemId = addContentForm.dataset.itemId; 
        let itemData;

        const commonData = {
            type: contentTypeSelect.value,
            title: document.getElementById('contentTitle').value.trim(),
            summary: document.getElementById('contentSummary').value.trim(),
            tags: contentTagsInput.value.split(',').map(tag => tag.trim()).filter(tag => tag),
        };

        if (itemId) { 
            itemData = section.items.find(i => i.id === itemId);
            if (!itemData) { showToast('Error: Item to edit not found!', 'error'); return; }
            Object.assign(itemData, commonData); 
            itemData.lastModified = new Date().toISOString();
        } else { 
            itemData = {
                ...commonData,
                id: `${sectionId}_item_${Date.now()}`,
                createdBy: currentUser.email,
                createdAt: new Date().toISOString()
            };
            const itemTypeForDisplay = itemData.type.charAt(0).toUpperCase() + itemData.type.slice(1);
            kbSystemData.meta.lastArticleAdded = { title: `(${itemTypeForDisplay}) ${itemData.title}`, date: new Date(itemData.createdAt).toLocaleDateString() };
            kbSystemData.meta.editsThisWeek = (kbSystemData.meta.editsThisWeek || 0) + 1;
        }

        if (itemData.type === 'case') {
            itemData.resolution_steps = quillEditor.root.innerHTML;
            itemData.status = itemData.status || 'New'; 
        } else if (['article', 'guide', 'policy'].includes(itemData.type)) {
            itemData.content = quillEditor.root.innerHTML;
        } else if (itemData.type === 'form_sheet' || itemData.type === 'design') {
            itemData.url = document.getElementById('contentUrl').value.trim();
            if (!itemData.url) { showToast('A URL is required for this content type.', 'error'); return; }
        }

        itemData.attachments = itemData.attachments || {};
        const pdfFile = document.getElementById('pdfFile').files[0];
        const imageFile = document.getElementById('imageFile').files[0];
        const videoLink = document.getElementById('videoLink').value.trim();
        const driveLink = document.getElementById('driveLink').value.trim();

        if (pdfFile) itemData.attachments.pdf = `simulated_uploads/${pdfFile.name}`; 
        if (imageFile) itemData.attachments.image = `simulated_uploads/${imageFile.name}`; 
        if (videoLink) itemData.attachments.video = videoLink;
        if (driveLink) itemData.attachments.drive = driveLink;


        if (!itemId) { 
            if (!section.items) section.items = [];
            section.items.push(itemData);
        }

        showToast(`✔️ Content '${itemData.title}' ${itemId ? 'updated' : 'saved'} successfully!`, 'success');
        closeAddContentModal();
        
        const currentHashParts = window.location.hash.substring(1).split('/');
        if (currentHashParts[0] === sectionId && currentHashParts[1] === itemId) { 
            displayItemDetail(sectionId, itemId);
        } else if (currentHashParts[0] === sectionId) { 
            displaySectionContent(sectionId, currentHashParts[1] || null);
        } else if (window.location.hash === '#home' || window.location.hash === '') {
             displayDashboard(); 
        }
    });

    // --- Global Search ---
    globalSearchInput.addEventListener('input', () => {
        const query = globalSearchInput.value.trim().toLowerCase();
        if (query.length < 2) {
            searchResultsContainer.classList.add('hidden');
            return;
        }
        const results = [];
        kbSystemData.sections.forEach(s => {
            if (s.id === 'home') return; 
            s.items?.forEach(i => {
                if (i.title.toLowerCase().includes(query) || 
                    (i.summary && stripHtml(i.summary).toLowerCase().includes(query)) || 
                    (i.content && stripHtml(i.content).toLowerCase().includes(query)) ||
                    (i.resolution_steps && stripHtml(i.resolution_steps).toLowerCase().includes(query)) ||
                    (i.tags && i.tags.some(tag => tag.toLowerCase().includes(query)))) {
                    results.push({ ...i, sectionId: s.id, sectionName: s.name });
                }
            });
        });
        searchResultsContainer.innerHTML = '';
        if (results.length) {
            results.slice(0, 7).forEach(r => {
                const linkEl = document.createElement('a');
                linkEl.href = `#${r.sectionId}/${r.id}`;
                 linkEl.addEventListener('click', () => {
                    searchResultsContainer.classList.add('hidden');
                    globalSearchInput.value = '';
                });

                linkEl.innerHTML = `
                    <div style="font-weight: bold;">${highlightText(r.title, query)}
                        <span style="font-size: 0.8em; color: var(--text-color-muted); margin-left: 5px;">(${escapeHTML(r.type.replace('_', ' '))} in ${escapeHTML(r.sectionName)})</span>
                    </div>
                    <p style="font-size: 0.9em; color: var(--text-color-subtle); margin: 0;">${highlightText(truncateText(stripHtml(r.summary || r.content || r.resolution_steps), 70), query)}</p>`;
                searchResultsContainer.appendChild(linkEl);
            });
            searchResultsContainer.classList.remove('hidden');
        } else {
            searchResultsContainer.innerHTML = `<div style="padding: 10px; font-size: 0.9em; color: var(--text-color-muted);">No results found.</div>`;
            searchResultsContainer.classList.remove('hidden');
        }
    });
    document.addEventListener('click', e => {
        if (!globalSearchInput.contains(e.target) && !searchResultsContainer.contains(e.target)) {
            searchResultsContainer.classList.add('hidden');
        }
    });
    
    // --- Routing and Initialization ---
    function handleNavigation() {
        const hash = window.location.hash.substring(1) || 'home';
        const parts = hash.split('/');
        const sectionId = parts[0];
        const itemIdOrSubCategory = parts[1]; 

        highlightSidebarLink(sectionId);

        if (sectionId === 'home') {
            displayDashboard();
        } else if (itemIdOrSubCategory && sectionId) { 
            const sectionData = kbSystemData.sections.find(s => s.id === sectionId);
            const itemExists = sectionData?.items?.some(i => i.id === itemIdOrSubCategory);
            if(itemExists) {
                displayItemDetail(sectionId, itemIdOrSubCategory);
            } else {
                displaySectionContent(sectionId, itemIdOrSubCategory); 
            }
        } else if (sectionId) {
            displaySectionContent(sectionId);
        } else {
            displayDashboard(); 
        }
        window.scrollTo(0,0);
    }

    function initializeApp() {
        if (!Auth.isAuthenticated()) {
            window.location.href = 'login.html';
            return; 
        }

        currentUser = Auth.getCurrentUser();
        if (!currentUser) { // Should not happen if isAuthenticated check is robust
            window.location.href = 'login.html';
            return;
        }

        const displayName = currentUser.fullName || currentUser.email || 'User';
        userNameDisplayHeader.textContent = displayName;
        userAvatar.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName.split(' ').join('+'))}&size=36&background=6366f1&color=fff&rounded=true&font-size=0.5`;
        footerKbVersion.textContent = kbSystemData.meta.version;

        populateSidebar();
        applyPermanentDarkMode(); 
        handleNavigation(); 

        window.addEventListener('hashchange', handleNavigation);
        document.getElementById('logoutButton').addEventListener('click', () => {
             if(confirm('Are you sure you want to logout?')) Auth.logout();
        });
        document.getElementById('reportErrorBtn').addEventListener('click', () => showToast('Issue reporting feature is under development.', 'info'));
        
        closeAddContentModalBtn.addEventListener('click', closeAddContentModal);
        cancelAddContentBtn.addEventListener('click', closeAddContentModal);
        
        if (window.innerWidth < 768 && !sidebar.classList.contains('closed')) { // Keep sidebar closed on mobile by default
            sidebar.classList.add('closed');
        }
        
        if (localStorage.getItem('justLoggedIn') === 'true') {
            showToast(`Welcome back, ${displayName}! You've successfully logged in.`, 'success', 4000);
            localStorage.removeItem('justLoggedIn'); 
        } else {
            showToast(`InfiniBase v${kbSystemData.meta.version} loaded. Session restored for ${displayName}.`, 'info', 4000);
        }
        console.log(`InfiniBase v${kbSystemData.meta.version} initialized for ${displayName} (Permanent Dark Mode).`);
    }

    initializeApp();

</script>
</body>
</html>
