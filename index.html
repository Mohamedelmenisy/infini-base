<!DOCTYPE html>
<html lang="en" dir="ltr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InfiniBase - Knowledge Base</title>
    <!-- Updated Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32' width='32' height='32'><rect width='32' height='32' rx='4' fill='%236366f1'/><text x='50%' y='55%' dominant-baseline='middle' text-anchor='middle' font-family='Arial, sans-serif' font-size='18' font-weight='bold' fill='white'>IB</text></svg>">
    
    <!-- CDNs -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>

    <style>
        :root {
            /* Permanent Dark Theme Variables */
            --primary-color: #6366f1; /* Brighter Indigo for dark */
            --primary-color-hover: #4f46e5;
            --secondary-color: #9ca3af;

            --text-color: #d1d5db;
            --text-color-muted: #9ca3af;
            --text-color-inverted: #ffffff; 
            --text-color-subtle: #9ca3af;

            --bg-color: #111827; /* Dark gray */
            --bg-color-alt: #1f2937; /* Slightly lighter dark gray for cards/modals */
            --bg-color-sidebar: #1f2937;
            --bg-color-header: rgba(31, 41, 55, 0.9);
            --bg-color-modal: #1f2937;
            --bg-color-hover: #374151;
            --bg-color-active: var(--primary-color);

            --border-color: #374151;
            --border-color-darker: #4b5563;

            --card-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            --card-hover-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            
            --border-radius: 0.5rem; 
            --border-radius-lg: 0.75rem;
            --header-height: 70px;
            --sidebar-width: 260px;

            --yes-color: #22c55e; /* Green for Yes */
            --no-color: #ef4444;   /* Red for No */
            --rating-color: #fbbf24; /* Amber 400 for ratings */
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            line-height: 1.6;
            font-size: 16px;
        }

        .container-fluid {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-color-sidebar);
            padding: 1.5rem;
            border-right: 1px solid var(--border-color); /* LTR */
            position: fixed;
            top: 0;
            left: 0; /* LTR */
            height: 100vh;
            overflow-y: auto;
            transition: transform 0.3s ease-in-out, background-color 0.3s ease, border-color 0.3s ease;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }
        .sidebar.closed {
            transform: translateX(-100%); /* LTR */
        }
        @media (min-width: 768px) {
            .sidebar.closed { transform: translateX(0); }
        }

        .sidebar-header {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            color: var(--text-color); 
        }
        .sidebar-header i { 
            margin-right: 0.75rem; /* LTR */
            color: var(--primary-color);
            font-size: 1.8rem;
        }
        .sidebar-logo-text {
             color: var(--text-color);
        }

        .sidebar-nav { flex-grow: 1; }

        .sidebar-section-title {
            padding-left: 0.75rem; /* LTR */
            font-size: 0.75rem;
            font-weight: 700; /* Increased font-weight for better visibility */
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--text-color-muted);
        }

        .sidebar-link {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-radius: var(--border-radius);
            transition: background-color 0.2s ease, color 0.2s ease;
            font-weight: 500;
            color: var(--text-color-subtle);
            text-decoration: none;
            margin-bottom: 0.25rem;
        }
        .sidebar-link i {
            margin-right: 0.75rem; /* LTR */
            width: 1.5rem; /* Adjusted for font-size */
            font-size: 1.5rem; /* Increased icon size */
            text-align: center;
            transition: color 0.2s ease;
        }
        .sidebar-link:hover {
            background-color: var(--bg-color-hover);
            color: var(--text-color);
        }
        .sidebar-link.active {
            background-color: var(--bg-color-active); /* Primary color */
            color: var(--text-color-inverted) !important; /* White text */
            font-weight: 600;
        }
        .sidebar-link.active i {
            color: var(--text-color-inverted) !important; /* White icon on primary background */
        }

        .sidebar-footer {
            margin-top: auto; 
            padding-top: 1rem;
        }
        .sidebar-footer button {
            width: 100%;
            margin-top: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sidebar-footer button i { margin-right: 0.5rem; }


        .content-wrapper {
            flex-grow: 1;
            padding-right: 1.5rem; /* LTR */
            padding-left: 1.5rem;
            transition: margin-left 0.3s ease-in-out; /* LTR */
            height: 100vh;
            overflow-y: auto;
        }
        @media (min-width: 768px) {
             .content-wrapper { margin-left: var(--sidebar-width); /* LTR */ }
             .sidebar.closed + .content-wrapper { margin-left: 0; /* LTR */ }
        }

        .content-header {
            background-color: var(--bg-color-header);
            padding: 1.25rem 2rem; 
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky; 
            top: 0;
            left: var(--sidebar-width); /* LTR, adjusted for fixed sidebar */
            right: 0;
            height: var(--header-height);
            z-index: 50;
            backdrop-filter: blur(8px); 
        }
         @media (max-width: 767px) { /* Mobile: header spans full width */
            .content-header {
                left: 0;
            }
        }
        .header-left-content { display: flex; align-items: center; } 
        #currentSectionTitle {
            font-size: 1.5rem; 
            font-weight: bold;
            margin: 0;
        }
        #breadcrumbs {
            font-size: 0.875rem; 
            color: var(--text-color-muted);
            margin-top: 0.25rem;
        }
        #breadcrumbs a { color: var(--primary-color); text-decoration: none; }
        #breadcrumbs a:hover { text-decoration: underline; }

        .header-right-content { display: flex; align-items: center; gap: 1rem; }
        .search-container { position: relative; }
        .search-container input[type="search"] {
            padding: 0.625rem 1rem 0.625rem 2.5rem; /* py-2.5 pl-10 pr-4 for LTR */
            border: 1px solid var(--border-color-darker);
            border-radius: 9999px; 
            min-width: 250px; 
            background-color: var(--bg-color-alt); 
            color: var(--text-color);
        }
        .search-container input[type="search"]::placeholder {
            color: var(--text-color-muted);
            opacity: 0.8;
        }
        .search-container .search-icon {
            position: absolute;
            inset-inline-start: 0.75rem; 
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-color-muted);
        }
        #searchResultsContainer {
            position: absolute;
            background-color: var(--bg-color-alt);
            border: 1px solid var(--border-color);
            border-top: none;
            width: 100%; 
            max-height: 300px; 
            overflow-y: auto;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); 
            z-index: 60; 
            border-radius: 0 0 var(--border-radius) var(--border-radius);
        }
        #searchResultsContainer a {
            display: block;
            padding: 0.75rem; 
            text-decoration: none;
            color: var(--text-color);
        }
        #searchResultsContainer a:hover { background-color: var(--bg-color-hover); }
        #searchResultsContainer mark { background-color: #78350f; color: #f3f4f6; }


        .user-profile { display: flex; align-items: center; gap: 0.5rem; }
        .user-profile img { width: 36px; height: 36px; border-radius: 50%; }
        #userNameDisplayHeader { font-weight: 500; }
        @media (max-width: 640px) { 
            #userNameDisplayHeader { display: none; }
        }

        main { padding: 1.5rem 0; }

        .card {
            background-color: var(--bg-color-alt);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg); 
            padding: 1.5rem;
            margin-bottom: 1.5rem; 
            box-shadow: var(--card-shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease, border-color 0.3s ease;
            display: flex;
            flex-direction: column; 
            min-height: 150px; 
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--card-hover-shadow);
        }
        .card-header-icon {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .card-icon-container {
            padding: 0.75rem;
            border-radius: 50%;
            margin-right: 1rem; /* LTR */
            background-color: var(--primary-color-hover); 
        }
        .card-icon-container i {
            font-size: 1.25rem;
            color: var(--text-color-inverted);  
        }
        .card h3 { margin-top: 0; font-size: 1.125rem; font-weight: 600; color: var(--text-color); line-height: 1.3; }
        .card p { margin-bottom: 1rem; font-size: 0.875rem; color: var(--text-color-subtle); flex-grow: 1; }
        .card .item-meta-info {
            margin-top: auto; 
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border-color);
        }
        .card .item-cta-link {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500; 
            font-size: 0.875rem;
        }
        .card .item-cta-link:hover { text-decoration: underline; color: var(--primary-color-hover); }
        .item-type-badge {
            font-size: 0.75rem; 
            padding: 0.25rem 0.75rem; 
            border-radius: 9999px; 
            background-color: var(--bg-color-hover); 
            color: var(--text-color-subtle); 
            font-weight: 600; 
            text-transform: uppercase;
        }
        .card-tags span {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 10px;
            background-color: var(--bg-color-hover);
            color: var(--text-color-subtle);
            display: inline-block;
            margin: 0 5px 5px 0; /* LTR */
        }

        .button, button {
            background-color: var(--primary-color);
            color: var(--text-color-inverted);
            border: 1px solid transparent;
            padding: 0.625rem 1rem; 
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.875rem; 
            font-weight: 500; 
            transition: background-color 0.2s, border-color 0.2s, color 0.2s;
            text-decoration: none; 
            display: inline-flex; 
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .button:hover, button:hover {
            background-color: var(--primary-color-hover);
        }
        .button-secondary {
            background-color: transparent;
            color: var(--text-color-subtle);
            border-color: var(--border-color-darker);
        }
        .button-secondary:hover { background-color: var(--bg-color-hover); color: var(--text-color); }
        .button-danger {
            background-color: #dc2626; 
            color: var(--text-color-inverted);
        }
        .button-danger:hover { background-color: #b91c1c; }
        input:focus, button:focus, select:focus, textarea:focus, a:focus { 
            outline: 2px solid transparent;
            outline-offset: 2px;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.6); 
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.75); 
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.2s ease-out;
        }
        .modal-overlay:not(.hidden) { opacity: 1; }
        .modal-content {
            background-color: var(--bg-color-modal);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 48rem; 
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.95);
            opacity: 0;
            transition: transform 0.2s ease-out, opacity 0.2s ease-out, background-color 0.3s ease, border-color 0.3s ease;
        }
        .modal-overlay:not(.hidden) .modal-content { transform: scale(1); opacity: 1; }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem; 
        }
        .modal-header h2 { margin-top: 0; font-size: 1.5rem; font-weight: 700; }
        .modal-header .close-button { 
            background: none; border: none; font-size: 1.5rem; color: var(--text-color-muted); cursor: pointer;
            padding: 0.25rem; line-height: 1; border-radius: 50%;
        }
        .modal-header .close-button:hover { background-color: var(--bg-color-hover); }
        
        .modal-body { /* For modals with just text content like confirm */
            padding-bottom: 1rem;
            font-size: 1rem;
            color: var(--text-color);
        }

        .modal-actions {
            margin-top: 1.5rem; 
            text-align: right; /* LTR */
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end; /* LTR */
            gap: 0.75rem; 
        }
         .modal-actions.no-border {
            border-top: none;
            padding-top: 0;
        }


        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.25rem; font-weight: 500; font-size: 0.875rem; }
        .form-group input[type="text"],
        .form-group input[type="url"],
        .form-group input[type="file"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.625rem; 
            border: 1px solid var(--border-color-darker); 
            border-radius: var(--border-radius);
            box-sizing: border-box;
            background-color: var(--bg-color); 
            color: var(--text-color);
        }
        .form-group textarea { min-height: 100px; }
        
        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: var(--text-color-muted);
            opacity: 0.8; /* Ensure it's not too faint */
        }
        
        /* Styles for Add Content Template Selection */
        #templateSelectionContainer { margin-bottom: 1.5rem; }
        #templateSelectionContainer h3 { font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-color); }
        .template-buttons-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .template-button {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color-darker);
            color: var(--text-color-subtle);
            padding: 1rem;
            border-radius: var(--border-radius);
            text-align: left;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .template-button:hover {
            border-color: var(--primary-color);
            background-color: var(--bg-color-hover);
            color: var(--text-color);
        }
        .template-button i { font-size: 1.5rem; margin-bottom: 0.5rem; display: block; color: var(--primary-color); }
        .template-button h4 { font-size: 1rem; font-weight: 600; margin-bottom: 0.25rem; }
        .template-button p { font-size: 0.8rem; line-height: 1.4; }


        .ql-toolbar {
            background: var(--bg-color);
            border-color: var(--border-color-darker) !important;
            border-top-left-radius: var(--border-radius);
            border-top-right-radius: var(--border-radius);
        }
        .ql-toolbar .ql-stroke { stroke: var(--text-color-muted); }
        .ql-toolbar .ql-fill { fill: var(--text-color-muted); }
        .ql-toolbar .ql-picker-label { color: var(--text-color-muted); }
        .ql-snow .ql-picker.ql-expanded .ql-picker-options { background-color: var(--bg-color-alt); border-color: var(--border-color-darker); }
        .ql-snow .ql-picker-options .ql-picker-item:hover { color: var(--primary-color); }


        .ql-container {
            background: var(--bg-color-alt);
            border-color: var(--border-color-darker) !important;
            color: var(--text-color);
            min-height: 150px; 
            border-bottom-left-radius: var(--border-radius);
            border-bottom-right-radius: var(--border-radius);
            font-size: 1rem;
        }
        .ql-editor { padding: 12px; }


        footer {
            text-align: center;
            padding: 1.5rem;
            font-size: 0.875rem;
            color: var(--text-color-muted);
            border-top: 1px solid var(--border-color);
            margin-top: auto; 
        }

        .mobile-sidebar-toggle {
            display: block;
            position: fixed;
            top: calc((var(--header-height) - 40px) / 2); 
            left: 1.5rem; /* LTR */
            z-index: 101; 
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 0.75rem; 
            border-radius: var(--border-radius);
            font-size: 1.25rem; 
            line-height: 1;
        }
        @media (min-width: 768px) {
            .mobile-sidebar-toggle { display: none; }
            .header-left-content #currentSectionTitle { margin-left: 0; } /* No toggle on desktop */
        }
        @media (max-width: 767px) {
            .header-left-content #currentSectionTitle { margin-left: 0.5rem; } /* Space for toggle */
            .content-header { padding: 1rem; }
            .header-right-content .search-container { display:none; } 
        }

        .toast-notification {
            position: fixed;
            bottom: 20px;
            right: 20px; /* LTR */
            padding: 12px 18px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 2000; 
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            display: flex;
            align-items: center;
            background-color: var(--bg-color-alt); 
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }
        .toast-notification.show { opacity: 1; transform: translateY(0); }
        .toast-icon { margin-right: 10px; /* LTR */ font-size: 1.2em; }
        .toast-success { background-color: #10b981; color: white; border-color: #059669; } 
        .toast-error { background-color: #ef4444; color: white; border-color: #dc2626; } 
        .toast-info { background-color: #3b82f6; color: white; border-color: #2563eb; } 

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 1.5rem; 
        }

        .kb-content h1, .kb-content h2, .kb-content h3 { margin-top: 1.5em; margin-bottom: 0.5em; color: var(--text-color); }
        .kb-content p { margin-bottom: 1em; }
        .kb-content ul, .kb-content ol { margin-bottom: 1em; padding-left: 20px; /* LTR */ }
        .kb-content li { margin-bottom: 0.5em; }
        .kb-content strong { font-weight: bold; }
        .kb-content em { font-style: italic; }
        .kb-content a { color: var(--primary-color); text-decoration: underline; }
        .kb-content pre {
            background-color: var(--bg-color);
            padding: 10px;
            border-radius: var(--border-radius);
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            border: 1px solid var(--border-color);
            color: var(--text-color); /* Ensure pre content is visible */
        }
         .kb-content code { /* More specific for inline code if needed */
            background-color: var(--bg-color-hover);
            padding: 0.2em 0.4em;
            margin: 0;
            font-size: 85%;
            border-radius: 3px;
        }
        mark {
            padding: 0.1em 0.2em; border-radius: 0.2em; font-weight: bold;
            background-color: #78350f; color: #f3f4f6; 
        }

        .hidden { display: none !important; }

        .chart-container {
            position: relative;
            padding: 1rem;
            border-radius: var(--border-radius-lg);
            background-color: var(--bg-color-alt);
            height: 320px; 
            display: flex; /* For centering canvas */
            flex-direction: column; /* For centering canvas */
            justify-content: center; /* For centering canvas */
            align-items: center; /* For centering canvas */
        }
        .chart-container canvas { /* Ensure canvas does not overflow */
            max-width: 100%;
            max-height: 100%;
        }
        .chart-container h3 {
            font-size: 1.125rem; 
            font-weight: 600; 
            margin-bottom: 0.5rem;
            text-align: center;
            width: 100%; /* Ensure title takes full width above chart */
        }
        .mermaid-diagram-card { /* Specific card for Mermaid diagrams */
            background-color: var(--bg-color-alt);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--card-shadow);
            margin-bottom: 1.5rem;
        }
        .mermaid-diagram-card h3 { /* Title within the card */
            margin-top: 0;
            margin-bottom: 1rem;
            font-size: 1.25rem;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }
        .mermaid-diagram-container {
            overflow-x: auto; /* For wide diagrams */
            padding: 10px; 
            background-color: var(--bg-color-alt); /* Diagram area background */
            border-radius: var(--border-radius);
        }
        .mermaid-diagram-container svg { 
            display: block;
            margin: 0 auto; 
            max-width: 100%; 
            min-height: 350px; /* Reduced min-height for diagram clarity */
            height: auto; /* Allow height to adjust based on content */
        }
        /* Mermaid dark theme overrides */
        .mermaid-diagram-container text { 
            fill: var(--text-color) !important; 
            font-family: 'Inter', sans-serif !important; 
            font-size: 14px !important; /* Increased font size for clarity */
        }
        .mermaid-diagram-container .edgeLabel { 
            color: var(--text-color) !important; 
        } 
         .mermaid-diagram-container .edgeLabel span { 
            font-size: 14px !important; /* Ensure consistent font size */
        }
        .mermaid-diagram-container .label { color: var(--text-color) !important; }
        .mermaid-diagram-container .actor { stroke: var(--text-color-muted) !important; fill: var(--bg-color-alt) !important; }
        .mermaid-diagram-container .messageText { fill: var(--text-color) !important; }
        .mermaid-diagram-container rect, 
        .mermaid-diagram-container polygon, 
        .mermaid-diagram-container ellipse,
        .mermaid-diagram-container circle {
            stroke: var(--primary-color) !important; /* Node border */
            fill: var(--bg-color-alt) !important; /* Node background, same as diagram for border emphasis */
        }
        .mermaid-diagram-container .cluster rect {
             fill: var(--bg-color) !important; /* Darker fill for cluster background */
             stroke: var(--border-color-darker) !important;
        }
        .mermaid-diagram-container .arrowheadPath {
            fill: var(--primary-color) !important;
        }
        .mermaid-diagram-container .edgePaths path {
            stroke: var(--primary-color) !important;
        }


        /* Item Detail View Specific */
        #itemDetailViewPlaceholder .card {
            border-top: 4px solid var(--primary-color); 
        }
        #itemDetailViewPlaceholder .item-title-area {
            display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;
        }
        #itemDetailViewPlaceholder .item-title-area i { font-size: 2rem; color: var(--primary-color); }
        #itemDetailViewPlaceholder .item-title-area h2 { font-size: 1.8rem; margin:0; }
        #itemDetailViewPlaceholder .item-summary { color: var(--text-color-subtle); margin-bottom: 1rem; font-style: italic; }
        #itemDetailViewPlaceholder hr { margin: 1.5rem 0; border-color: var(--border-color); }
        #itemDetailViewPlaceholder .kb-content ul { list-style-type: disc; }
        #itemDetailViewPlaceholder .child-items-list { list-style-type: none; padding-left: 0; }
        #itemDetailViewPlaceholder .child-items-list li { margin-bottom: 0.5rem; }
        #itemDetailViewPlaceholder .child-items-list a { color: var(--primary-color); text-decoration: none; }
        #itemDetailViewPlaceholder .child-items-list a:hover { text-decoration: underline; }
        .item-actions-bar { display: flex; gap: 0.75rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .item-feedback-section { margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color); }
        .item-feedback-section h4 { font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; }
        .rating-buttons button { background: none; border: 1px solid var(--border-color); color: var(--text-color-muted); padding: 0.5rem 0.75rem; border-radius: var(--border-radius); cursor: pointer; transition: all 0.2s; }
        .rating-buttons button:hover, .rating-buttons button.active { border-color: var(--rating-color); color: var(--rating-color); background-color: rgba(251, 191, 36, 0.1); }
        .rating-buttons button i { margin-right: 0.5rem; }
        .read-stats { font-size: 0.875rem; color: var(--text-color-muted); margin-left: 1rem; }
        
        .comments-section { margin-top: 2rem; }
        .comments-section textarea#newCommentText { width: 100%; min-height: 80px; margin-bottom: 0.5rem;}
        .comments-section .comment-display-area { 
            margin-top: 1rem; 
            padding: 1rem; 
            background-color: var(--bg-color); 
            border-radius: var(--border-radius); 
            min-height: 50px; 
            border: 1px solid var(--border-color-darker);
        }
        .comment-display-area .comment {
            border-bottom: 1px solid var(--border-color);
            padding: 0.75rem 0;
            margin-bottom: 0.75rem;
        }
        .comment-display-area .comment:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .comment-author {
            font-weight: 600;
            color: var(--text-color);
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }
        .comment-author .comment-timestamp {
            font-weight: normal;
            color: var(--text-color-muted);
            font-size: 0.75rem;
            margin-left: 0.5rem;
        }
        .comment-text {
            font-size: 0.95rem;
            line-height: 1.5;
            color: var(--text-color-subtle);
            white-space: pre-wrap; /* Preserve line breaks in comments */
        }


        /* Dashboard specific styles */
        .dashboard-stat-card {
            background-color: var(--bg-color-alt);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--card-shadow);
            text-align: center;
        }
        .dashboard-stat-card i {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 0.75rem;
        }
        .dashboard-stat-card .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            display: block;
            margin-bottom: 0.25rem;
        }
        .dashboard-stat-card .stat-label {
            font-size: 0.875rem;
            color: var(--text-color-muted);
        }
        .dashboard-quicklink-card, .dashboard-info-card { /* Combined for similar styling */
             background-color: var(--bg-color-alt);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--card-shadow);
        }
         .dashboard-quicklink-card h3, .dashboard-info-card h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }
        .dashboard-quicklink-card ul, .dashboard-info-card ul {
            list-style: none;
            padding: 0;
        }
        .dashboard-quicklink-card ul li a, .dashboard-info-card ul li a {
            display: block;
            padding: 0.5rem 0;
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
        }
         .dashboard-quicklink-card ul li a:hover, .dashboard-info-card ul li a:hover {
            text-decoration: underline;
        }
         .dashboard-info-card ul li {
            font-size: 0.9rem;
            color: var(--text-color-subtle);
            padding: 0.3rem 0;
         }
         .dashboard-info-card ul li strong {
            color: var(--text-color);
         }
         .dashboard-info-card ul li .meta {
            font-size: 0.75rem;
            display: block;
            color: var(--text-color-muted);
         }
         /* Viewer Dashboard Message */
        .viewer-dashboard-message .card {
            text-align: center;
            padding: 40px 20px;
            min-height: auto; /* Override general card min-height if needed */
        }
        .viewer-dashboard-message .card i {
            font-size: 2.5rem; /* Larger icon for emphasis */
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
        .viewer-dashboard-message .card h2 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--text-color);
        }
        .viewer-dashboard-message .card p {
            font-size: 1rem;
            color: var(--text-color-muted);
            margin-bottom: 0; /* Adjust as needed */
        }
        .viewer-dashboard-message .card p.subtle-note {
             font-size: 0.9rem;
             margin-top: 1rem;
        }

    </style>
</head>
<body>

    <div id="addContentModalOverlay" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="addContentModalTitle">Add New Content</h2>
                <button id="closeAddContentModalBtn" class="close-button" aria-label="Close">×</button>
            </div>

            <div id="templateSelectionContainer" class="hidden">
                <h3>Choose a Template</h3>
                <div class="template-buttons-grid">
                    <button class="template-button" data-template="standard_article">
                        <i class="fas fa-newspaper"></i>
                        <h4>Standard Article</h4>
                        <p>For general information, announcements, or detailed explanations.</p>
                    </button>
                    <button class="template-button" data-template="troubleshooting_guide">
                        <i class="fas fa-tools"></i>
                        <h4>Troubleshooting Guide / Case</h4>
                        <p>Step-by-step solutions for common issues or case documentation.</p>
                    </button>
                    <button class="template-button" data-template="policy_document">
                        <i class="fas fa-gavel"></i>
                        <h4>Policy Document</h4>
                        <p>Formal policies, procedures, or official guidelines.</p>
                    </button>
                     <button class="template-button" data-template="blank">
                        <i class="fas fa-file"></i>
                        <h4>Blank Document</h4>
                        <p>Start with a completely empty document of any type.</p>
                    </button>
                </div>
                <hr style="border-color: var(--border-color-darker); margin: 1.5rem 0;">
            </div>

            <form id="addContentForm" class="hidden">
                <input type="hidden" id="editingItemId"> <!-- For storing ID when editing -->
                <div class="form-group">
                    <label for="contentType">Content Type</label>
                    <select id="contentType">
                        <option value="article">Article</option>
                        <option value="case">Case</option>
                        <option value="form_sheet">Form/Sheet (Link)</option>
                        <option value="design">Design (Link)</option>
                        <option value="guide">Guide</option>
                        <option value="policy">Policy</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="contentTitle">Title</label>
                    <input type="text" id="contentTitle" required>
                </div>
                <div class="form-group">
                    <label for="contentSummary">Summary / Description</label>
                    <textarea id="contentSummary" rows="3" required></textarea>
                </div>
                
                <div class="form-group hidden" id="contentUrlContainer">
                    <label for="contentUrl">Link (for Forms, Designs, etc.)</label>
                    <input type="url" id="contentUrl">
                </div>

                <div class="form-group" id="contentDetailContainer">
                    <label for="contentDetail" id="contentDetailLabel">Details / Content</label>
                    <div id="quillEditor"></div> <!-- Quill editor container -->
                </div>

                <div class="form-group">
                    <label for="contentTags">Tags (comma-separated)</label>
                    <input type="text" id="contentTags" placeholder="e.g., important, update, billing">
                </div>

                <hr style="border-color: var(--border-color-darker); margin: 1.5rem 0;">
                <h3 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-color);">Attachments (Optional)</h3>
                
                <div class="form-group">
                    <label for="pdfFile">Upload PDF</label>
                    <input type="file" id="pdfFile" accept=".pdf">
                </div>
                <div class="form-group">
                    <label for="imageFile">Upload Image</label>
                    <input type="file" id="imageFile" accept="image/*">
                </div>
                <div class="form-group">
                    <label for="videoLink">Video Link (e.g., YouTube, Vimeo)</label>
                    <input type="url" id="videoLink" placeholder="https://">
                </div>
                <div class="form-group">
                    <label for="driveLink">Google Drive Link</label>
                    <input type="url" id="driveLink" placeholder="https://docs.google.com/... or https://drive.google.com/...">
                </div>


                <div class="modal-actions">
                    <button type="submit" id="saveContentBtn" class="button"><i class="fas fa-save"></i> Save Content</button>
                    <button type="button" id="cancelAddContentBtn" class="button-secondary"><i class="fas fa-times"></i> Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div id="logoutConfirmModalOverlay" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 28rem;"> <!-- Smaller modal for confirm -->
            <div class="modal-header">
                <h2 id="logoutConfirmModalTitle">Confirm Logout</h2>
                <button id="closeLogoutConfirmModalBtn" class="close-button" aria-label="Close">×</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to logout from InfiniBase?</p>
            </div>
            <div class="modal-actions no-border"> 
                <button type="button" id="confirmLogoutBtn" class="button button-danger"><i class="fas fa-sign-out-alt"></i> Confirm Logout</button>
                <button type="button" id="cancelLogoutBtn" class="button-secondary"><i class="fas fa-times"></i> Cancel</button>
            </div>
        </div>
    </div>


    <div class="container-fluid">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-database"></i> <span class="sidebar-logo-text">InfiniBase</span>
            </div>
            <nav id="navigationMenu" class="sidebar-nav">
                <!-- Links will be dynamically generated -->
            </nav>
            <div class="sidebar-footer">
                <button id="logoutButton" class="button button-danger">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
                 <div id="userRoleDisplaySidebar" style="font-size: 0.8rem; color: var(--text-color-muted); text-align: center; margin-top: 0.5rem;">Role: <span id="currentUserRoleSpan"></span></div>
            </div>
        </aside>

        <div class="content-wrapper" id="contentWrapper">
            <header class="content-header">
                <div class="header-left-content">
                    <button id="mobileSidebarToggle" class="mobile-sidebar-toggle"><i class="fas fa-bars"></i></button>
                    <div>
                        <h1 id="currentSectionTitle">Welcome</h1>
                        <div id="breadcrumbs">Home</div>
                    </div>
                </div>
                <div class="header-right-content">
                    <div class="search-container">
                        <span class="search-icon"><i class="fas fa-search"></i></span>
                        <input type="search" id="globalSearchInput" placeholder="Search the knowledge base...">
                        <div id="searchResultsContainer" class="hidden"></div>
                    </div>
                    <div id="userProfileContainer" class="user-profile">
                        <img id="userAvatar" src="https://ui-avatars.com/api/?name=U&size=36&background=6366f1&color=fff&rounded=true" alt="User">
                        <span id="userNameDisplayHeader" style="font-weight: 500;">User</span>
                    </div>
                </div>
            </header>

            <main id="pageContentArea" class="p-6 md:p-8">
                <div id="dashboardOverviewContainer" class="hidden">
                    <!-- Dashboard content will be injected here -->
                </div>
                <div id="standardSectionContentPlaceholder">
                    <!-- Section content will be injected here -->
                </div>
                <div id="itemDetailViewPlaceholder" class="hidden" data-mermaid-rendered="false">
                    <!-- Item detail view -->
                </div>
            </main>

            <footer class="mt-auto p-6 text-center text-sm">
                <span>© <script>document.write(new Date().getFullYear())</script> InfiniBase.Elmenisy. Version <span id="footerKbVersion">0.1.0</span></span>
            </footer>
        </div>
    </div>
    <div id="toastContainer"></div>

<script type="module">
    import { supabase } from './supabase.js';

    // --- Initialize Mermaid ---
    mermaid.initialize({ 
        startOnLoad: false,
        theme: 'dark', 
        fontFamily: 'Inter, sans-serif',
        flowchart: { 
            htmlLabels: true,
            useMaxWidth: true,
        },
        themeVariables: {
            fontSize: '14px', 
            background: getComputedStyle(document.documentElement).getPropertyValue('--bg-color-alt').trim(), 
            primaryColor: getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim(),
            primaryTextColor: getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim(),
            lineColor: getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim(),
            textColor: getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim(),
            nodeBorder: getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim(),
        }
    });
    
    // --- JSON Data for Compensation Flowchart ---
    // This data is kept for potential future use or other diagrams, as requested.
    const compensationFlowJsonData = [
      {
        "id": "s1_receive_request", "text": "Receive the customer request.", "type": "info", "next_id": "s2_check_inquiry_type"
      },
      {
        "id": "s2_check_inquiry_type", "text": "Check the inquiry type:<br/>Is the order late?", "type": "decision",
        "options": [ {"label": "Yes, order is late", "next_id": "s3_check_delivery_time_exceeded"}, {"label": "No, other issue", "next_id": "s_handle_other_issue"} ]
      },
      {
        "id": "s3_check_delivery_time_exceeded", "text": "Has the delivery time exceeded?", "type": "decision",
        "options": [ {"label": "Yes, > 15 mins", "next_id": "s5_apologize_check_order_type"}, {"label": "Yes, 0-15 mins", "next_id": "s4_inform_wait_add_note_0_15"}, {"label": "No, not yet exceeded", "next_id": "s4_inform_wait_add_note"} ]
      },
      { "id": "s4_inform_wait_add_note", "text": "Not exceeded: Let customer wait,<br/>add note.", "type": "info", "next_id": "s17_determine_responsibility"},
      { "id": "s4_inform_wait_add_note_0_15", "text": "Exceeded 0-15 mins: Apologize,<br/>add note, new ETA.", "type": "info", "next_id": "s17_determine_responsibility"},
      {
        "id": "s5_apologize_check_order_type", "text": "Exceeded > 15 mins: Apologize, add note.<br/>Check order type: Fast or Scheduled?", "type": "decision",
        "options": [ {"label": "Fast Order", "next_id": "s7_fast_check_delay_duration"}, {"label": "Scheduled Order", "next_id": "s12_scheduled_driver_left"} ]
      },
      {
        "id": "s7_fast_check_delay_duration", "text": "Fast Order:<br/>Delay duration (after initial 15 mins)?", "type": "decision",
        "options": [ {"label": "16–30 min total", "next_id": "s8_fast_comp_16_30"}, {"label": "31–45 min total", "next_id": "s9_fast_comp_31_45"}, {"label": "46–60 min total", "next_id": "s10_fast_comp_46_60"}, {"label": "> 60 min total", "next_id": "s11_fast_comp_over_60"} ]
      },
      { "id": "s8_fast_comp_16_30", "text": "Fast (16–30 min):<br/>Compensate delivery fees only.", "type": "info", "next_id": "s17_determine_responsibility"},
      { "id": "s9_fast_comp_31_45", "text": "Fast (31–45 min):<br/>Compensate delivery fees + 25% chef total.", "type": "info", "next_id": "s17_determine_responsibility"},
      { "id": "s10_fast_comp_46_60", "text": "Fast (46–60 min):<br/>Compensate delivery fees + 50% chef total.", "type": "info", "next_id": "s17_determine_responsibility"},
      { "id": "s11_fast_comp_over_60", "text": "Fast (> 60 min):<br/>Compensate full order fees.", "type": "info", "next_id": "s17_determine_responsibility"},
      {
        "id": "s12_scheduled_driver_left", "text": "Scheduled (>15min delay):<br/>Driver left store?", "type": "decision",
        "options": [ {"label": "No, driver not left", "next_id": "s13_scheduled_inform_accelerate"}, {"label": "Yes, driver left", "next_id": "s14_scheduled_check_delay_duration"} ]
      },
      { "id": "s13_scheduled_inform_accelerate", "text": "Scheduled, driver not left:<br/>Apologize, inform order acceleration.", "type": "info", "next_id": "s17_determine_responsibility"},
      {
        "id": "s14_scheduled_check_delay_duration", "text": "Scheduled (driver left, >15min delay):<br/>Total delay duration?", "type": "decision",
        "options": [ {"label": "31–60 min total", "next_id": "s15_scheduled_comp_31_60"}, {"label": "> 60 min total", "next_id": "s16_scheduled_comp_over_60"} ]
      },
      { "id": "s15_scheduled_comp_31_60", "text": "Scheduled (31–60 min):<br/>Compensate 50%–100% order total.", "type": "info", "next_id": "s17_determine_responsibility"},
      { "id": "s16_scheduled_comp_over_60", "text": "Scheduled (> 60 min):<br/>Compensate full order + 50 SAR.", "type": "info", "next_id": "s17_determine_responsibility"},
      { "id": "s17_determine_responsibility", "text": "Determine responsibility (Store/Driver/Company),<br/>add deduction.", "type": "info", "next_id": "s18_check_customer_requests_compensation"},
      {
        "id": "s18_check_customer_requests_compensation", "text": "Customer explicitly requests compensation?", "type": "decision",
        "options": [ {"label": "Yes, requests compensation", "next_id": "s_proceed_with_compensation_actions"}, {"label": "No/Resolved by apology", "next_id": "s_conclude_call_no_comp_request"} ]
      },
      { "id": "s_handle_other_issue", "text": "Handle other non-delay issue.<br/>[Branch to other scenario]. End call.", "type": "info", "next_id": "s_conclude_call"},
      { "id": "s_proceed_with_compensation_actions", "text": "Agent: \"Alright, based on the situation,<br/>here's the compensation...\"", "type": "info", "next_id": "s_conclude_call"},
      { "id": "s_conclude_call_no_comp_request", "text": "Agent: \"Thank you for your understanding.<br/>We've noted the delay...\"", "type": "info", "next_id": "s_conclude_call"},
      { "id": "s_conclude_call", "text": "Agent: Is there anything else?<br/>... Thank you for calling The Chefz!", "type": "info" }
    ];

    // This function is kept for potential future use or other diagrams.
    function generateMermaidFromJSON(jsonData) {
        let mermaidSyntax = 'graph TD;\n';
        const definedNodeIds = new Set(jsonData.map(node => node.id.replace(/-/g, '_')));

        jsonData.forEach(node => {
            const nodeId = node.id.replace(/-/g, '_');
            let nodeLabel = `"${node.text.replace(/"/g, '#quot;')}"`; 

            if (node.type === 'decision') {
                mermaidSyntax += `    ${nodeId}{${nodeLabel}};\n`;
                if (node.options) {
                    node.options.forEach(option => {
                        const nextNodeId = option.next_id.replace(/-/g, '_');
                        let optionLabelText = option.label.replace(/"/g, '#quot;');
                        let labelColorStyle = ''; 
                        if (option.label.toLowerCase().startsWith("yes")) {
                            labelColorStyle = `color:${getComputedStyle(document.documentElement).getPropertyValue('--yes-color').trim()}; font-weight:bold;`;
                        } else if (option.label.toLowerCase().startsWith("no")) {
                            labelColorStyle = `color:${getComputedStyle(document.documentElement).getPropertyValue('--no-color').trim()}; font-weight:bold;`;
                        } else {
                            labelColorStyle = `color:${getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim()};`;
                        }
                        const optionLabel = `"<span style='${labelColorStyle}'>${optionLabelText}</span>"`;
                        
                        if (definedNodeIds.has(nextNodeId)) {
                            mermaidSyntax += `    ${nodeId} -- ${optionLabel} --> ${nextNodeId};\n`;
                        } else {
                             mermaidSyntax += `    ${nodeId} -- ${optionLabel} --> ${nextNodeId}((End: ${nextNodeId.replace(/s_/g, '').replace(/_/g, ' ')}));\n`;
                        }
                    });
                }
            } else if (node.type === 'info') {
                mermaidSyntax += `    ${nodeId}[${nodeLabel}];\n`;
                if (node.next_id) {
                    const nextNodeId = node.next_id.replace(/-/g, '_');
                    if (definedNodeIds.has(nextNodeId)) {
                        mermaidSyntax += `    ${nodeId} --> ${nextNodeId};\n`;
                    } else {
                         mermaidSyntax += `    ${nodeId} --> ${nextNodeId}((End: ${nextNodeId.replace(/s_/g, '').replace(/_/g, ' ')}));\n`;
                    }
                }
            }
        });
        return mermaidSyntax;
    }

    /**
     * @typedef {object} UserProfile
     * @property {string} id - User UUID from Supabase Auth
     * @property {string} [name] - User's full name (from 'users' table, column 'name')
     * @property {string} email - User's email
     * @property {string} role - User's role (e.g., 'viewer', 'admin')
     * @property {string} [lastLogin] - ISO string of last login time (optional in this type, added by client)
     */

    // --- Supabase Auth & User Management ---
    const Auth = {
        /** @returns {Promise<UserProfile|null>} */
        async getCurrentUserProfile() {
            const { data: { session }, error: sessionError } = await supabase.auth.getSession();

            if (sessionError) {
                console.error("Error fetching Supabase session:", sessionError);
                // Potentially redirect or handle, but for now, assume no session means redirect.
            }

            if (!session || !session.user) {
                console.log('No active Supabase session. Redirecting to login.');
                // Only redirect if on a page that requires auth.
                // This check prevents redirect loops if login.html itself calls this.
                if (window.location.pathname.includes("index.html") || window.location.pathname === '/' || window.location.pathname === '') {
                     window.location.href = 'login.html';
                }
                return null; 
            }

            const userId = session.user.id;

            const { data: userDataFromDB, error: dbError } = await supabase
                .from("users")
                .select("id, name, email, role") // Ensure these columns exist
                .eq("id", userId)
                .single();

            if (dbError || !userDataFromDB) {
                console.error("Failed to fetch user profile from DB for user ID:", userId, dbError);
                // This is a critical state: auth session exists, but no profile.
                // Sign out the user to prevent inconsistent states.
                await supabase.auth.signOut();
                localStorage.removeItem("infiniBaseUser"); // Clear any stale local storage
                if (window.location.pathname.includes("index.html") || window.location.pathname === '/' || window.location.pathname === '') {
                    window.location.href = "login.html";
                }
                return null;
            }
            
            /** @type {UserProfile} */
            const comprehensiveUserProfile = {
                ...userDataFromDB, // Spreads id, name, email, role from DB
                lastLogin: new Date().toISOString() // Add/update lastLogin time
            };

            localStorage.setItem("infiniBaseUser", JSON.stringify(comprehensiveUserProfile));
            return comprehensiveUserProfile;
        },
        async logout() {
            const { error } = await supabase.auth.signOut();
            if (error) {
                console.error("Error during sign out:", error);
                showToast('Error signing out. Please try again.', 'error');
            } else {
                localStorage.removeItem('infiniBaseUser');
                localStorage.removeItem('justLoggedIn'); 
                showToast('You have been logged out successfully!', 'success');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 1500);
            }
        }
    };

    // --- KB Data (Still client-side for this iteration) ---
    let kbSystemData = {
        meta: { version: '0.6.4-supabase', lastGlobalUpdate: new Date().toISOString(), lastArticleAdded: null, editsThisWeek: 0 }, 
        sections: [
            { id: 'home', name: 'Home', icon: 'fas fa-home', description: 'Dashboard and overview.', iconColor: 'var(--primary-color)' },
            {
                id: 'support', name: 'Support', icon: 'fas fa-headset', description: 'Support resources and flows.', iconColor: '#c084fc', 
                items: [
                     { 
                        id: 'sup_flow_compensation', type: 'article', 
                        title: 'Scenario: Customer Inquiry – Compensation Flow for Delays', 
                        summary: 'Flowchart for handling customer compensation due to order delays based on The Chefz policies.',
                        content: `
                            <p>This guide outlines the steps for handling customer inquiries regarding order delays and potential compensation, following The Chefz guidelines.</p>
                            <ol>
                                <li>
                                    <strong>Receive Customer Request:</strong>
                                    <p>Acknowledge the customer's contact and the reason for their call/message.</p>
                                </li>
                                <li>
                                    <strong>Identify Inquiry Type:</strong>
                                    <p>Ask the customer or check the system:</p>
                                    <ul>
                                        <li>
                                            <strong>Is the order late?</strong>
                                            <ul>
                                                <li>
                                                    <strong>Yes, the order is late:</strong> Proceed to Step 3.
                                                </li>
                                                <li>
                                                    <strong>No, it's another issue:</strong>
                                                    <p>Handle the other non-delay issue according to relevant procedures. Example script:</p>
                                                    <blockquote>"I understand. Could you please provide more details about the issue you're experiencing with [mention aspect like food quality, wrong item, etc.]?"</blockquote>
                                                    <p>After resolving or escalating, conclude the call:</p>
                                                    <blockquote>"Is there anything else I can help you with today? ... Thank you for calling The Chefz!"</blockquote>
                                                </li>
                                            </ul>
                                        </li>
                                    </ul>
                                </li>
                                <li>
                                    <strong>Assess Delivery Time Exceeded:</strong>
                                    <p>If the order is late, determine if the official delivery time has been exceeded.</p>
                                    <ul>
                                        <li>
                                            <strong>Delivery time NOT YET exceeded:</strong>
                                            <p>Inform the customer about the current ETA and that the order is still within the expected delivery window. Add a note to the order.</p>
                                            <blockquote>"I've checked your order, and it's currently on its way and still within the estimated delivery time of [ETA]. We're monitoring it closely. Please allow a little more time."</blockquote>
                                            <p>Then proceed to Step 5 (Determine Responsibility).</p>
                                        </li>
                                        <li>
                                            <strong>Delivery time exceeded by 0-15 minutes:</strong>
                                            <p>Apologize for the slight delay. Provide a new, realistic ETA. Add a note to the order.</p>
                                            <blockquote>"I sincerely apologize for the slight delay with your order. It's currently running about [X] minutes late. The new estimated time of arrival is [New ETA]. We're working to get it to you as soon as possible."</blockquote>
                                            <p>Then proceed to Step 5 (Determine Responsibility).</p>
                                        </li>
                                        <li>
                                            <strong>Delivery time exceeded by MORE THAN 15 minutes:</strong>
                                            <p>Apologize for the significant delay. Add a note to the order. Then, check the order type.</p>
                                            <blockquote>"I'm very sorry to hear about the significant delay with your order. This is not the experience we want you to have. Let me check the details for you."</blockquote>
                                            <p>Proceed to Step 4 (Check Order Type).</p>
                                        </li>
                                    </ul>
                                </li>
                                <li>
                                    <strong>Check Order Type (for delays > 15 minutes):</strong>
                                    <ul>
                                        <li>
                                            <strong>If it's a FAST Order:</strong>
                                            <p>Determine the total delay duration (after the initial 15-minute mark).</p>
                                            <ul>
                                                <li><strong>Delay of 16–30 minutes total:</strong> Compensate delivery fees only. Proceed to Step 5.</li>
                                                <li><strong>Delay of 31–45 minutes total:</strong> Compensate delivery fees + 25% of the chef/food total. Proceed to Step 5.</li>
                                                <li><strong>Delay of 46–60 minutes total:</strong> Compensate delivery fees + 50% of the chef/food total. Proceed to Step 5.</li>
                                                <li><strong>Delay of MORE THAN 60 minutes total:</strong> Compensate full order fees (delivery + food). Proceed to Step 5.</li>
                                            </ul>
                                        </li>
                                        <li>
                                            <strong>If it's a SCHEDULED Order:</strong>
                                            <p>Check if the driver has left the store.</p>
                                            <ul>
                                                <li>
                                                    <strong>Driver has NOT left the store:</strong>
                                                    <p>Apologize and inform the customer that the order preparation is being accelerated.</p>
                                                    <blockquote>"I apologize for the delay with your scheduled order. I've confirmed the driver hasn't left yet, and we're expediting its preparation to minimize any further waiting."</blockquote>
                                                    <p>Then proceed to Step 5 (Determine Responsibility).</p>
                                                </li>
                                                <li>
                                                    <strong>Driver HAS left the store:</strong>
                                                    <p>Determine the total delay duration.</p>
                                                    <ul>
                                                        <li><strong>Delay of 31–60 minutes total:</strong> Compensate 50%–100% of the total order value. The exact percentage may depend on specific circumstances and supervisor approval if needed. Proceed to Step 5.</li>
                                                        <li><strong>Delay of MORE THAN 60 minutes total:</strong> Compensate the full order value + an additional 50 SAR (or equivalent local currency goodwill gesture). Proceed to Step 5.</li>
                                                    </ul>
                                                </li>
                                            </ul>
                                        </li>
                                    </ul>
                                </li>
                                <li>
                                    <strong>Determine Responsibility & Add Deduction (Internal Step):</strong>
                                    <p>This is an internal step after assessing the delay and potential compensation. Identify whether the delay was due to the Store, Driver, or a Company-wide issue. Apply any necessary deductions as per internal policy. This step is crucial for internal tracking and accountability but may not be fully detailed to the customer unless relevant to the explanation.</p>
                                </li>
                                <li>
                                    <strong>Address Customer's Compensation Request:</strong>
                                    <ul>
                                        <li>
                                            <strong>If the customer EXPLICITLY requests compensation (or if compensation is proactively offered due to severe delay):</strong>
                                            <p>Inform the customer about the compensation they are eligible for, based on the assessment in Step 4.</p>
                                            <blockquote>"Alright, based on the situation and the delay you've experienced, here's the compensation we can offer: [Clearly state the compensation, e.g., 'a refund of your delivery fees,' or 'a 25% discount on your food items for this order,' or 'a full refund for your order and a 50 SAR voucher for your next one.']. This will be processed within [timeframe]."</blockquote>
                                            <p>Then proceed to conclude the call (Step 7).</p>
                                        </li>
                                        <li>
                                            <strong>If the customer does NOT explicitly request compensation, and the apology/explanation is sufficient:</strong>
                                            <p>Thank the customer for their understanding. Ensure the delay and any actions taken are noted.</p>
                                            <blockquote>"Thank you for your understanding regarding this delay. We've noted the issue and will work to ensure this doesn't happen again. Your feedback is valuable to us."</blockquote>
                                            <p>Then proceed to conclude the call (Step 7).</p>
                                        </li>
                                    </ul>
                                </li>
                                <li>
                                    <strong>Conclude the Call:</strong>
                                    <p>Offer further assistance and thank the customer.</p>
                                    <blockquote>"Is there anything else I can help you with today? ... Thank you for calling The Chefz! We appreciate your patience."</blockquote>
                                </li>
                            </ol>
                            <p style="margin-top:1.5rem;"><strong>Important Notes:</strong></p>
                            <ul>
                                <li>Always determine the responsibility for the delay (Store, Driver, or Company) to apply any necessary deductions.</li>
                                <li>Maximum compensation for delivery fees is $5 if the actual delivery fee is less than this amount (adjust currency/amount as per policy).</li>
                                <li>Follow "Yes" process if the customer specifically asks for compensation. Handle with empathy.</li>
                            </ul>
                        `,
                        tags: ['compensation', 'customer service', 'delay', 'flowchart', 'chefz policy', 'sop'],
                        createdAt: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000).toISOString(), 
                        views: Math.floor(Math.random()*150)+75,
                        comments: []
                    },
                    {
                        id: 'sup_child_example', type: 'article', parentId: 'sup_flow_compensation',
                        title: 'Child Article: Detailed Scenarios for Driver Responsibility',
                        summary: 'Examples of when a driver is considered responsible for delays.',
                        content: '<p>This article dives deeper into specific situations regarding driver responsibility for order delays.</p><ul><li>Example 1...</li><li>Example 2...</li></ul>',
                        tags: ['driver', 'responsibility', 'delay'],
                        createdAt: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(), 
                        views: Math.floor(Math.random()*80)+30,
                        comments: []
                    }
                ]
            },
            { id: 'partner_care', name: 'Partner Care', icon: 'fas fa-handshake', description: 'Resources for partner management.', iconColor: '#2dd4bf', items: [
                 { id: 'pc_case_01', type: 'case', title: 'Case: Partner Payment Dispute', summary: 'Investigating a partner claim about incorrect payment.', createdAt: new Date(Date.now() - 20 * 24 * 60 * 60 * 1000).toISOString(), resolution_steps: '<p>1. Verify partner contract. 2. Check payment logs. 3. Escalate to finance if discrepancy found.</p>', status: 'Open', views: Math.floor(Math.random()*40)+15, comments: [] }
            ] }, 
            { id: 'logistics', name: 'Logistics', icon: 'fas fa-truck', description: 'Logistics operations and information.', iconColor: '#4ade80', items: [] }, 
            { id: 'customer_care', name: 'Customer Care', icon: 'fas fa-users', description: 'Customer service guidelines and FAQs.', iconColor: '#a78bfa', items: [] }, 
            { id: 'distribution_followup', name: 'Distribution & Follow-up', icon: 'fas fa-people-carry', description: 'Distribution processes and tracking.', iconColor: '#22d3ee', items: [] }, 
            { id: 'logistics_driver_complaints', name: 'Logistics (Driver Complaints)', icon: 'fas fa-shipping-fast', description: 'Handling driver-related complaints.', iconColor: '#84cc16', items: [] }, 
            { id: 'logistics_3pl', name: 'Logistics-3PL', icon: 'fas fa-boxes-stacked', description: 'Third-party logistics information.', iconColor: '#facc15', items: [] }, 
            { id: 'order_at_store_mac', name: 'Order at Store (Mac)', icon: 'fas fa-store', description: 'Procedures for Mac orders at store.', iconColor: '#f472b6', items: [] }, 
            { id: 'logistics_admin', name: 'Logistics-Admin', icon: 'fas fa-user-shield', description: 'Administrative tasks for logistics.', iconColor: '#fb7185', items: [] }, 
            { id: 'operating_systems', name: 'Operating Systems', icon: 'fab fa-windows', description: 'OS troubleshooting and guides.', iconColor: '#38bdf8', items: [] }, 
            { id: 'compensation_policies', name: 'Compensation Policies', icon: 'fas fa-hand-holding-usd', description: 'Detailed compensation policies.', iconColor: '#f59e0b', items: [
                { id: 'cp_policy_01', type: 'policy', title: 'General Compensation Policy v2.1', summary: 'The main policy document for all compensation scenarios.', createdAt: new Date(Date.now() - 45 * 24 * 60 * 60 * 1000).toISOString(), content: '<h1>Policy v2.1</h1><p>Details about the compensation policy...</p>', views: Math.floor(Math.random()*300)+100, comments: [] }
            ] }, 
            { id: 'operational_instructions', name: 'Operational Instructions', icon: 'fas fa-clipboard-list', description: 'Standard operating procedures.', iconColor: '#93c5fd', items: [] }, 
            { id: 'forms_templates', name: 'Forms/Templates', icon: 'fas fa-file-alt', description: 'Standard forms and templates.', iconColor: '#a5b4fc', items: [] }
        ]
    };

    // --- DOM Elements ---
    const sidebar = document.getElementById('sidebar');
    const mobileSidebarToggle = document.getElementById('mobileSidebarToggle');
    const navigationMenu = document.getElementById('navigationMenu');
    const currentSectionTitleEl = document.getElementById('currentSectionTitle');
    const breadcrumbsContainer = document.getElementById('breadcrumbs');
    const pageContentArea = document.getElementById('pageContentArea');
    const dashboardOverviewContainer = document.getElementById('dashboardOverviewContainer');
    const standardSectionContentPlaceholder = document.getElementById('standardSectionContentPlaceholder');
    const itemDetailViewPlaceholder = document.getElementById('itemDetailViewPlaceholder');
    const userNameDisplayHeader = document.getElementById('userNameDisplayHeader');
    const userAvatar = document.getElementById('userAvatar');
    const footerKbVersion = document.getElementById('footerKbVersion');
    const currentUserRoleSpan = document.getElementById('currentUserRoleSpan');


    const addContentModalOverlay = document.getElementById('addContentModalOverlay');
    const closeAddContentModalBtn = document.getElementById('closeAddContentModalBtn');
    const addContentForm = document.getElementById('addContentForm');
    const templateSelectionContainer = document.getElementById('templateSelectionContainer');
    const cancelAddContentBtn = document.getElementById('cancelAddContentBtn');
    const contentTypeSelect = document.getElementById('contentType');
    const contentUrlContainer = document.getElementById('contentUrlContainer');
    const contentDetailContainer = document.getElementById('contentDetailContainer');
    const contentDetailLabel = document.getElementById('contentDetailLabel');
    const contentTagsInput = document.getElementById('contentTags');
    const editingItemIdInput = document.getElementById('editingItemId');
    
    const globalSearchInput = document.getElementById('globalSearchInput');
    const searchResultsContainer = document.getElementById('searchResultsContainer');

    const logoutButton = document.getElementById('logoutButton');
    const logoutConfirmModalOverlay = document.getElementById('logoutConfirmModalOverlay');
    const closeLogoutConfirmModalBtn = document.getElementById('closeLogoutConfirmModalBtn');
    const confirmLogoutBtn = document.getElementById('confirmLogoutBtn');
    const cancelLogoutBtn = document.getElementById('cancelLogoutBtn');


    let quillEditor; 
    /** @type {UserProfile|null} */
    let currentUser = null; 
    let currentOpenItem = null;
    let visitorsChartInstance, casesChartInstance, articlesChartInstance; 

    // --- Utility Functions ---
    function escapeHTML(str) {
        if (typeof str !== 'string') return '';
        const el = document.createElement('div');
        el.textContent = str;
        return el.innerHTML;
    }

    function highlightText(text, query) {
        if (!text) return '';
        const safeText = escapeHTML(text);
        if (!query) return safeText;
        try {
            const rgx = new RegExp(`(${query.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')})`, 'gi');
            return safeText.replace(rgx, '<mark>$1</mark>');
        } catch (e) { return safeText; }
    }

    function truncateText(text, len) {
        if (!text || text.length <= len) return text;
        return text.substring(0, len) + '...';
    }
    function stripHtml(html){
       let tmp = document.createElement("DIV");
       tmp.innerHTML = html;
       return tmp.textContent || tmp.innerText || "";
    }

    function showToast(message, type = 'info', duration = 3000) {
        const toastContainer = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast-notification toast-${type}`;
        
        let iconClass = 'fas fa-info-circle';
        if (type === 'success') iconClass = 'fas fa-check-circle';
        else if (type === 'error') iconClass = 'fas fa-times-circle';

        toast.innerHTML = `<i class="toast-icon ${iconClass}"></i> <span>${escapeHTML(message)}</span>`;
        toastContainer.appendChild(toast);

        setTimeout(() => toast.classList.add('show'), 10);

        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, duration);
    }
    
    function applyPermanentDarkMode() { 
        [visitorsChartInstance, casesChartInstance, articlesChartInstance].forEach(chart => {
            if (chart) {
                const legendColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim();
                const ticksColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color-muted').trim();
                const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim();
                
                chart.options.plugins.legend.labels.color = legendColor;
                if (chart.options.scales && chart.options.scales.y) {
                    chart.options.scales.y.ticks.color = ticksColor;
                    chart.options.scales.y.grid.color = gridColor;
                }
                if (chart.options.scales && chart.options.scales.x) { 
                    chart.options.scales.x.ticks.color = ticksColor;
                    chart.options.scales.x.grid.color = gridColor;
                }
                chart.update();
            }
        });
    }

    // --- Sidebar and Navigation ---
    function populateSidebar() {
        let menuHTML = '';
        const mainSections = ['home'];
        const knowledgeAreas = [
            'support', 'partner_care', 'logistics', 'customer_care', 
            'distribution_followup', 'logistics_driver_complaints', 'logistics_3pl', 
            'order_at_store_mac', 'logistics_admin', 'operating_systems'
        ];
        const resourcesPolicies = [
            'compensation_policies', 'operational_instructions', 'forms_templates'
        ];

        menuHTML += `<div class="sidebar-section-title">MAIN</div>`;
        kbSystemData.sections.filter(s => mainSections.includes(s.id)).forEach(section => {
            const iconStyle = section.iconColor ? `style="color: ${section.iconColor};"` : '';
            menuHTML += `<a href="#${section.id}" class="sidebar-link" data-section="${section.id}">
                <i class="${section.icon || 'fas fa-file-alt'}" ${iconStyle}></i>${escapeHTML(section.name)}
            </a>`;
        });
        
        menuHTML += `<div class="sidebar-section-title">KNOWLEDGE AREAS</div>`;
        kbSystemData.sections.filter(s => knowledgeAreas.includes(s.id)).forEach(section => {
            const iconStyle = section.iconColor ? `style="color: ${section.iconColor};"` : '';
            menuHTML += `<a href="#${section.id}" class="sidebar-link" data-section="${section.id}">
                <i class="${section.icon || 'fas fa-folder'}" ${iconStyle}></i>${escapeHTML(section.name)}
            </a>`;
        });

        menuHTML += `<div class="sidebar-section-title">RESOURCES & POLICIES</div>`;
        kbSystemData.sections.filter(s => resourcesPolicies.includes(s.id)).forEach(section => {
            const iconStyle = section.iconColor ? `style="color: ${section.iconColor};"` : '';
            menuHTML += `<a href="#${section.id}" class="sidebar-link" data-section="${section.id}">
                <i class="${section.icon || 'fas fa-book'}" ${iconStyle}></i>${escapeHTML(section.name)}
            </a>`;
        });

        navigationMenu.innerHTML = menuHTML;
    }

    mobileSidebarToggle.addEventListener('click', () => sidebar.classList.toggle('closed'));
    sidebar.addEventListener('click', (e) => {
        if (e.target.closest('.sidebar-link') && window.innerWidth < 768) {
            sidebar.classList.add('closed');
        }
    });

    function highlightSidebarLink(sectionId) {
        document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
        const activeLink = document.querySelector(`.sidebar-link[data-section="${sectionId}"]`);
        if (activeLink) activeLink.classList.add('active');
    }
    
    async function renderMermaidDiagramsInElement(element) {
        const mermaidElements = element.querySelectorAll('pre.mermaid');
        if (mermaidElements.length === 0) return;

        const initiallyHiddenParents = [];
        if (mermaidElements.length > 0) {
            let currentEl = mermaidElements[0].parentElement; 
            while(currentEl && currentEl !== document.body) {
                if (currentEl.classList.contains('hidden') || (currentEl.style && currentEl.style.display === 'none')) {
                    if(currentEl.style) currentEl.dataset.originalDisplay = currentEl.style.display;
                    currentEl.classList.remove('hidden'); 
                    if(currentEl.style) currentEl.style.display = ''; 
                    initiallyHiddenParents.push(currentEl);
                }
                if(currentEl.id === 'itemDetailViewPlaceholder' || currentEl.classList.contains('modal-overlay') || currentEl.classList.contains('content-wrapper')) break;
                currentEl = currentEl.parentElement;
            }
        }
        
        try {
            await new Promise(resolve => setTimeout(resolve, 50)); 
            await mermaid.run({ nodes: mermaidElements, suppressErrors: false });
            element.dataset.mermaidRendered = 'true';
        } catch (error) {
            console.error("Mermaid rendering error during run():", error);
            mermaidElements.forEach(preElement => {
                if (preElement.parentElement && !preElement.parentElement.querySelector('.mermaid-error-msg')) {
                    const errorMsg = document.createElement('p');
                    errorMsg.className = 'mermaid-error-msg';
                    errorMsg.style.color = 'red';
                    errorMsg.textContent = `Error rendering diagram. Check console.`;
                    preElement.parentElement.insertBefore(errorMsg, preElement.nextSibling);
                }
            });
        } finally {
            initiallyHiddenParents.forEach(p => {
                p.classList.add('hidden'); 
                if (p.dataset.originalDisplay && p.dataset.originalDisplay !== 'none') {
                     p.style.display = p.dataset.originalDisplay; 
                } else if (!p.classList.contains('hidden') && p.dataset.originalDisplay === 'none') {
                    p.style.display = 'none';
                }
                delete p.dataset.originalDisplay;
            });
        }
    }


    // --- Content Display ---
    function renderItemCard(item, sectionData) {
        let itemIconClass = 'fas fa-file-alt'; 
        let ctaText = 'View Details';
        let ctaLink = `#${sectionData.id}/${item.id}`;
        let target = '';
        let itemTypeDisplay = item.type.replace('_', ' ');

        if (item.type === 'article') { itemIconClass = 'fas fa-newspaper'; itemTypeDisplay = 'Article';}
        else if (item.type === 'case') { itemIconClass = 'fas fa-briefcase'; itemTypeDisplay = 'Case';}
        else if (item.type === 'form_sheet') { itemIconClass = 'fas fa-file-invoice'; ctaText = 'Open Link'; ctaLink = item.url || '#'; target = '_blank'; itemTypeDisplay = 'Form/Sheet';}
        else if (item.type === 'design') {itemIconClass = 'fas fa-palette'; ctaText = 'View Design'; ctaLink = item.url || '#'; target = '_blank'; itemTypeDisplay = 'Design';}
        else if (item.type === 'guide') { itemIconClass = 'fas fa-book-open'; itemTypeDisplay = 'Guide';}
        else if (item.type === 'policy') { itemIconClass = 'fas fa-gavel'; itemTypeDisplay = 'Policy';}

        const cardIconContainerColor = 'var(--primary-color-hover)'; 
        const cardIconColor = 'var(--text-color-inverted)';

        return `
        <div class="card" data-item-id="${item.id}" data-item-type="${item.type}">
            <div class="card-header-icon">
                <div class="card-icon-container" style="background-color: ${cardIconContainerColor};">
                    <i class="${itemIconClass}" style="color: ${cardIconColor};"></i>
                </div>
                <h3>${escapeHTML(item.title)}</h3>
            </div>
            <p>${escapeHTML(truncateText(stripHtml(item.summary), 120))}</p>
            ${item.tags && item.tags.length ? `<div class="card-tags">${item.tags.map(tag => `<span>${escapeHTML(tag)}</span>`).join('')}</div>` : ''}
            <div class="item-meta-info">
                <span class="item-type-badge">${escapeHTML(itemTypeDisplay)}</span>
                <a href="${escapeHTML(ctaLink)}" ${target ? `target="${target}" rel="noopener noreferrer"` : ''} class="item-cta-link"
                   data-item-id="${item.id}" data-section-id="${sectionData.id}" data-item-type="${item.type}">
                   ${ctaText} <i class="fas fa-arrow-right"></i>
                </a>
            </div>
        </div>`;
    }

    async function displayDashboard() {
        dashboardOverviewContainer.classList.remove('hidden');
        standardSectionContentPlaceholder.classList.add('hidden');
        itemDetailViewPlaceholder.classList.add('hidden');
        itemDetailViewPlaceholder.dataset.mermaidRendered = 'false'; 
        currentSectionTitleEl.textContent = 'Dashboard';
        breadcrumbsContainer.innerHTML = `<span style="font-weight: bold; color: var(--primary-color);">Home</span>`;

        if (!currentUser || currentUser.role !== 'admin') {
            dashboardOverviewContainer.innerHTML = `
                <div class="viewer-dashboard-message">
                    <div class="card">
                        <i class="fas fa-user-shield"></i>
                        <h2>Access Restricted</h2>
                        <p>The dashboard overview is available for administrators only.</p>
                        <p class="subtle-note">You can navigate using the sidebar to view knowledge base content.</p>
                    </div>
                </div>
            `;
            return;
        }

        // Admin Dashboard Content
        const welcomeUser = currentUser.name || currentUser.email || 'Admin'; // Use .name from profile
        const allItems = kbSystemData.sections.flatMap(s => s.items || []);
        const totalArticles = allItems.filter(i => ['article', 'guide', 'policy'].includes(i.type)).length;
        const totalCases = allItems.filter(i => i.type === 'case').length;
        
        kbSystemData.meta.editsThisWeek = Math.floor(Math.random() * 15); 
        if (!kbSystemData.meta.lastArticleAdded && allItems.length > 0) {
            const latestItem = [...allItems].sort((a,b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0))[0];
            if (latestItem) {
                 kbSystemData.meta.lastArticleAdded = { title: latestItem.title, date: new Date(latestItem.createdAt || Date.now()).toLocaleDateString() };
            }
        }
        if (!kbSystemData.meta.lastArticleAdded) {
            kbSystemData.meta.lastArticleAdded = { title: "N/A", date: "N/A" };
        }
        
        const compensationFlowItem = kbSystemData.sections.find(s => s.id === 'support')?.items?.find(i => i.id === 'sup_flow_compensation');

        const mostUsedArticles = [...allItems].sort((a,b) => (b.views || 0) - (a.views || 0)).slice(0,3);
        const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
        const recentCases = allItems.filter(i => i.type === 'case' && i.createdAt && new Date(i.createdAt) >= sevenDaysAgo).slice(0,3);
        const sixMonthsAgo = new Date();
        sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
        const articlesNeedingUpdate = allItems.filter(i => i.createdAt && new Date(i.createdAt) < sixMonthsAgo && (i.type === 'article' || i.type === 'policy' || i.type === 'guide')).slice(0,3);


        dashboardOverviewContainer.innerHTML = `
            <div class="card" style="background: linear-gradient(to right, var(--primary-color), #4c1d95); color: white; min-height: auto;">
                <h2 style="font-size: 1.75rem; margin-bottom: 4px;">Welcome back, ${escapeHTML(welcomeUser)}!</h2>
                <p style="opacity: 0.95; font-size: 0.95rem; color: var(--text-color-inverted);">Overview of your knowledge base activity.</p>
            </div>

            <div class="cards-grid md:grid-cols-2 lg:grid-cols-4 my-6">
                <div class="dashboard-stat-card">
                    <i class="fas fa-folder-open"></i>
                    <span class="stat-value">${kbSystemData.sections.length -1}</span>
                    <span class="stat-label">Total Sections</span>
                </div>
                <div class="dashboard-stat-card">
                    <i class="fas fa-newspaper"></i>
                    <span class="stat-value">${totalArticles}</span>
                    <span class="stat-label">Total Articles & Guides</span>
                </div>
                 <div class="dashboard-stat-card">
                    <i class="fas fa-briefcase"></i>
                    <span class="stat-value">${totalCases}</span>
                    <span class="stat-label">Total Cases</span>
                </div>
                <div class="dashboard-stat-card">
                    <i class="fas fa-edit"></i>
                    <span class="stat-value">${kbSystemData.meta.editsThisWeek}</span>
                    <span class="stat-label">Edits This Week</span>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <div class="dashboard-info-card">
                    <h3>🔥 Most Used Articles</h3>
                    <ul>${mostUsedArticles.length ? mostUsedArticles.map(item => `<li><a href="#${kbSystemData.sections.find(s => s.items && s.items.includes(item)).id}/${item.id}">${escapeHTML(item.title)}</a> <span class="meta">(${item.views || 0} views)</span></li>`).join('') : '<li>No data yet.</li>'}</ul>
                </div>
                <div class="dashboard-info-card">
                    <h3>⏳ Articles Needing Update</h3>
                    <ul>${articlesNeedingUpdate.length ? articlesNeedingUpdate.map(item => `<li><a href="#${kbSystemData.sections.find(s => s.items && s.items.includes(item)).id}/${item.id}">${escapeHTML(item.title)}</a> <span class="meta">Created: ${new Date(item.createdAt).toLocaleDateString()}</span></li>`).join('') : '<li>All articles up-to-date.</li>'}</ul>
                </div>
                <div class="dashboard-info-card">
                    <h3>✅ Recent Cases (Last 7 Days)</h3>
                     <ul>${recentCases.length ? recentCases.map(item => `<li><a href="#${kbSystemData.sections.find(s => s.items && s.items.includes(item)).id}/${item.id}">${escapeHTML(item.title)}</a> <span class="meta">Created: ${new Date(item.createdAt).toLocaleDateString()}</span></li>`).join('') : '<li>No recent cases.</li>'}</ul>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card chart-container">
                        <h3>Visitors Activity (Mock)</h3>
                        <canvas id="visitorsChart"></canvas>
                    </div>
                    <div class="card chart-container">
                        <h3>Content Types (Mock)</h3>
                        <canvas id="articlesChart"></canvas>
                    </div>
                </div>
                <div class="dashboard-quicklink-card card" style="min-height: auto;">
                    <h3>Quick Links</h3>
                    <ul>
                        ${compensationFlowItem ? `<li><a href="#support/${compensationFlowItem.id}"><i class="fas fa-project-diagram fa-fw"></i> View Support Flow</a></li>` : ''}
                        <li><a href="#forms_templates"><i class="fas fa-file-alt fa-fw"></i> Browse Templates</a></li>
                    </ul>
                     <h3 style="margin-top: 1.5rem;">💡 Content Suggestions</h3>
                     <p style="font-size: 0.9rem; color: var(--text-color-subtle);">Consider adding a guide for "New Partner Onboarding" in Partner Care.</p>
                     <h3 style="margin-top: 1.5rem;">Last Added</h3>
                     <p style="font-size: 0.9rem; color: var(--text-color-subtle);">${escapeHTML(kbSystemData.meta.lastArticleAdded.title)} <br><small>(${escapeHTML(kbSystemData.meta.lastArticleAdded.date)})</small></p>
                </div>
            </div>
        `;
        
        const legendColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim();
        const ticksColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color-muted').trim();
        const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim();

        const chartOptions = (type) => ({
            responsive: true, maintainAspectRatio: false,
            plugins: { 
                legend: { 
                    labels: { color: legendColor, font: { family: 'Inter, sans-serif' } },
                    position: 'top', 
                },
                tooltip: {
                    bodyFont: { family: 'Inter, sans-serif' },
                    titleFont: { family: 'Inter, sans-serif' }
                }
            },
            scales: type === 'bar' || type === 'line' ? {
                y: { ticks: { color: ticksColor, beginAtZero: true, font: { family: 'Inter, sans-serif' } }, grid: { color: gridColor } },
                x: { ticks: { color: ticksColor, font: { family: 'Inter, sans-serif' } }, grid: { color: gridColor } }
            } : {}
        });

        if (visitorsChartInstance) visitorsChartInstance.destroy();
        const visitorsCtx = document.getElementById('visitorsChart')?.getContext('2d');
        if (visitorsCtx) {
            visitorsChartInstance = new Chart(visitorsCtx, {
                type: 'line',
                data: { labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'], datasets: [{ label: 'Page Views', data: [65, 59, 80, 81, 56, 55, 40], borderColor: 'rgba(99, 102, 241, 0.8)', backgroundColor: 'rgba(99, 102, 241, 0.2)', tension: 0.3, fill: true }] },
                options: chartOptions('line')
            });
        }

        if (articlesChartInstance) articlesChartInstance.destroy();
        const articlesCtx = document.getElementById('articlesChart')?.getContext('2d');
        if (articlesCtx) {
            const policyCount = allItems.filter(i=>i.type === 'policy').length;
            const guideCount = allItems.filter(i=>i.type === 'guide').length;
            let mainArticleCount = totalArticles - policyCount - guideCount;
            if (mainArticleCount < 0) mainArticleCount = 0; 

            articlesChartInstance = new Chart(articlesCtx, {
                type: 'doughnut', 
                data: { labels: ['Articles', 'Cases', 'Guides', 'Policies'], datasets: [{ data: [mainArticleCount, totalCases, guideCount, policyCount], backgroundColor: ['#6366f1', '#ec4899', '#22d3ee', '#f59e0b'] }] },
                options: chartOptions('doughnut') 
            });
        }
        applyPermanentDarkMode(); 
    }
    
    async function displaySectionContent(sectionId, subCategoryFilter = null) {
        currentOpenItem = null;
        dashboardOverviewContainer.classList.add('hidden');
        standardSectionContentPlaceholder.classList.remove('hidden');
        itemDetailViewPlaceholder.classList.add('hidden');
        itemDetailViewPlaceholder.dataset.mermaidRendered = 'false'; 

        const sectionData = kbSystemData.sections.find(s => s.id === sectionId);
        if (!sectionData) {
            standardSectionContentPlaceholder.innerHTML = `<div class="card" style="text-align: center;"><h2 style="color: red;">Section not found: ${escapeHTML(sectionId)}</h2></div>`;
            currentSectionTitleEl.textContent = 'Not Found';
            return;
        }

        currentSectionTitleEl.textContent = sectionData.name;
        let bcHTML = `<a href="#home">Home</a> <span style="margin: 0 5px;">›</span> <span style="font-weight: bold; color: var(--primary-color);">${escapeHTML(sectionData.name)}</span>`;
        breadcrumbsContainer.innerHTML = bcHTML;

        let contentHTML = `<div>`;
        
        if (currentUser && currentUser.role === 'admin' && sectionId !== 'home') {
             contentHTML += `
                <div style="text-align: right; margin-bottom: 1.5rem;">
                    <button id="openAddContentBtnInSection" class="button" data-section-id="${sectionData.id}">
                        <i class="fas fa-plus-circle"></i> Add Content to ${escapeHTML(sectionData.name)}
                    </button>
                </div>`;
        }

        const itemsToDisplay = (sectionData.items || [])
            .filter(item => !item.parentId) 
            .filter(item => !subCategoryFilter || (item.tags && item.tags.includes(subCategoryFilter)));
        
        if (itemsToDisplay.length > 0) {
            contentHTML += `<div class="cards-grid">`;
            itemsToDisplay.forEach(item => contentHTML += renderItemCard(item, sectionData));
            contentHTML += `</div>`;
        }
        
        if (sectionId !== 'support' && !subCategoryFilter && sectionData.subCategories && sectionData.subCategories.length > 0) {
            contentHTML += `<h3 style="font-size: 1.5rem; font-weight: 600; margin-top: 30px; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 8px;">Subcategories</h3><div class="cards-grid">`;
            sectionData.subCategories.forEach(subCat => {
                contentHTML += `<a href="#${sectionData.id}/${subCat.id}" class="card" style="text-align: center; text-decoration: none; color: var(--text-color);">
                    <i class="${subCat.icon || sectionData.icon || 'fas fa-folder-open'}" style="font-size: 2rem; display: block; margin-bottom: 10px; color: var(--primary-color);"></i>
                    <h4 style="margin:0; font-weight: 500;">${escapeHTML(subCat.name)}</h4>
                </a>`;
            });
            contentHTML += `</div>`;
        }

        if (itemsToDisplay.length === 0 && (!sectionData.subCategories || sectionData.subCategories.length === 0 || subCategoryFilter)) {
             contentHTML += `<div class="card" style="text-align: center; padding: 40px 20px; min-height: auto;"><p style="font-size: 1.2rem; color: var(--text-color-muted);">No content in this section${subCategoryFilter ? ' or subcategory' : ''} yet.</p></div>`;
        }

        contentHTML += `</div>`;
        standardSectionContentPlaceholder.innerHTML = contentHTML;

        const openAddBtnInSection = document.getElementById('openAddContentBtnInSection');
        if (openAddBtnInSection) {
            openAddBtnInSection.addEventListener('click', (e) => {
                const currentSecId = e.currentTarget.dataset.sectionId;
                openAddContentModal(currentSecId);
            });
        }
    }
    
    function findParentItem(parentId) {
        for (const section of kbSystemData.sections) {
            if (section.items) {
                const parentItem = section.items.find(item => item.id === parentId);
                if (parentItem) {
                    return { ...parentItem, sectionId: section.id };
                }
            }
        }
        return null;
    }

    function renderComments(itemData, commentsContainerId) {
        const commentsContainer = document.getElementById(commentsContainerId);
        if (!commentsContainer) return;

        if (!itemData.comments || itemData.comments.length === 0) {
            commentsContainer.innerHTML = `<p style="color: var(--text-color-muted);">No comments yet. Be the first to discuss!</p>`;
            return;
        }
        let commentsHTML = '';
        const sortedComments = [...itemData.comments].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));

        sortedComments.forEach(comment => {
            commentsHTML += `
                <div class="comment" data-comment-id="${comment.id}">
                    <div class="comment-author">
                        ${escapeHTML(comment.authorName || comment.authorEmail || 'Anonymous')}
                        <span class="comment-timestamp">${new Date(comment.timestamp).toLocaleString()}</span>
                    </div>
                    <div class="comment-text">${escapeHTML(comment.text)}</div>
                </div>
            `;
        });
        commentsContainer.innerHTML = commentsHTML;
    }


    async function displayItemDetail(sectionId, itemId) {
        const sectionData = kbSystemData.sections.find(s => s.id === sectionId);
        const itemData = sectionData?.items?.find(i => i.id === itemId);

        if (!sectionData || !itemData) {
            standardSectionContentPlaceholder.innerHTML = `<p style="color: red;">Error: Item not found.</p>`;
            itemDetailViewPlaceholder.classList.add('hidden');
            standardSectionContentPlaceholder.classList.remove('hidden');
            itemDetailViewPlaceholder.dataset.mermaidRendered = 'false'; 
            return;
        }
        currentOpenItem = { sectionId, itemId }; 
        itemDetailViewPlaceholder.dataset.mermaidRendered = 'false'; 

        dashboardOverviewContainer.classList.add('hidden');
        standardSectionContentPlaceholder.classList.add('hidden');
        itemDetailViewPlaceholder.classList.remove('hidden');

        let bcHTML = `
            <a href="#home">Home</a> <span style="margin: 0 5px;">›</span>
            <a href="#${sectionData.id}">${escapeHTML(sectionData.name)}</a> <span style="margin: 0 5px;">›</span>
            <span style="font-weight: bold; color: var(--primary-color);">${escapeHTML(itemData.title)}</span>`;
        breadcrumbsContainer.innerHTML = bcHTML;
        currentSectionTitleEl.textContent = itemData.title;

        let itemIconClass = 'fas fa-file-alt';
        if (itemData.type === 'case') itemIconClass = 'fas fa-briefcase';
        else if (itemData.type === 'article') itemIconClass = 'fas fa-newspaper';
        else if (itemData.type === 'form_sheet') itemIconClass = 'fas fa-file-invoice';
        else if (itemData.type === 'design') itemIconClass = 'fas fa-palette';
        else if (itemData.type === 'guide') itemIconClass = 'fas fa-book-open';
        else if (itemData.type === 'policy') itemIconClass = 'fas fa-gavel';

        const childItems = kbSystemData.sections.flatMap(s => s.items || [])
                               .filter(child => child.parentId === itemData.id)
                               .map(child => ({...child, sectionId: kbSystemData.sections.find(s => s.items && s.items.includes(child)).id }));


        let detailHTML = `<div class="item-actions-bar">
                            <button id="backToSectionBtn" class="button button-secondary">
                                <i class="fas fa-arrow-left"></i> Back to ${escapeHTML(sectionData.name)}
                            </button>`;
        if (itemData.parentId) {
            const parentItemFull = findParentItem(itemData.parentId);
            if (parentItemFull) {
                detailHTML += `<button id="backToParentBtn" class="button button-secondary" data-parent-section="${parentItemFull.sectionId}" data-parent-id="${parentItemFull.id}">
                                <i class="fas fa-level-up-alt"></i> Back to Parent: ${escapeHTML(truncateText(parentItemFull.title, 25))}
                               </button>`;
            }
        }
        if (currentUser && currentUser.role === 'admin') {
             detailHTML += `<button id="editItemBtn" class="button" data-section-id="${sectionId}" data-item-id="${itemId}"><i class="fas fa-edit"></i> Edit Item</button>`;
             detailHTML += `<button id="deleteItemBtn" class="button button-danger" data-section-id="${sectionId}" data-item-id="${itemId}"><i class="fas fa-trash-alt"></i> Delete Item</button>`;
        }
        detailHTML += `   <button id="printItemBtn" class="button button-secondary"><i class="fas fa-print"></i> Print</button>
                          <button id="shareItemBtn" class="button button-secondary"><i class="fas fa-share-alt"></i> Share Link</button>
                          <button id="downloadPdfItemBtn" class="button button-secondary"><i class="fas fa-file-pdf"></i> Download PDF</button>
                      </div>`;

        // MODIFICATION: Changed how sup_flow_compensation is handled.
        // It will now fall into the general 'else' block as it no longer contains 'class="mermaid"'.
        // The 'mermaid-diagram-card' styling was specific to items that *do* render a mermaid diagram.
        // Since this item no longer does, it should use the standard card styling.
        // This also means the logic to call renderMermaidDiagramsInElement might not find a mermaid element in this specific item, which is correct.
        
        // Original check: if (itemData.id === 'sup_flow_compensation' && itemData.content.includes('class="mermaid"'))
        // This check will now be false for 'sup_flow_compensation', so it will use the standard card.
        if (itemData.content && itemData.content.includes('class="mermaid"')) { // General check for any item with a mermaid diagram
             detailHTML += `
                <div class="mermaid-diagram-card"> 
                    <div class="item-title-area" style="margin-bottom: 0.5rem;">
                         <i class="${itemIconClass}" style="font-size: 1.5rem;"></i>
                         <h2 style="font-size: 1.5rem;">${escapeHTML(itemData.title)}</h2>
                    </div>
                     <p class="item-summary" style="font-size: 0.9rem;">${escapeHTML(stripHtml(itemData.summary))}</p>
                    ${itemData.tags && itemData.tags.length ? `<div class="card-tags" style="margin-bottom: 1rem;">${itemData.tags.map(tag => `<span>${escapeHTML(tag)}</span>`).join('')}</div>` : ''}
                    <hr style="margin-bottom: 1rem;">
                    <div class="kb-content">${itemData.content}</div>
                </div>`;
        } else {
            detailHTML += `
                <div class="card">
                    <div class="item-title-area">
                        <i class="${itemIconClass}"></i>
                        <h2>${escapeHTML(itemData.title)}</h2>
                    </div>
                    <p class="item-summary">${escapeHTML(stripHtml(itemData.summary))}</p>
                    ${itemData.tags && itemData.tags.length ? `<div class="card-tags" style="margin-bottom: 1rem;">${itemData.tags.map(tag => `<span>${escapeHTML(tag)}</span>`).join('')}</div>` : ''}
                    <hr>
                    <div class="kb-content">`;

            if (itemData.content) { 
                detailHTML += itemData.content;
            } else if (itemData.resolution_steps) { 
                 detailHTML += itemData.resolution_steps;
            } else if ((itemData.type === 'form_sheet' || itemData.type === 'design') && itemData.url) {
                detailHTML += `<p>This content is an external link:</p><p><a href="${escapeHTML(itemData.url)}" target="_blank" rel="noopener noreferrer" class="button"><i class="fas fa-external-link-alt"></i> Open Link</a></p>`;
            } else {
                detailHTML += `<p>No detailed content available for this item.</p>`;
            }

            if (itemData.attachments && Object.keys(itemData.attachments).length > 0 && (itemData.attachments.pdf || itemData.attachments.image || itemData.attachments.video || itemData.attachments.drive) ) {
                detailHTML += `<hr><h4 style="margin-top:1.5rem; margin-bottom:1rem; font-weight:600;">Attachments:</h4><ul>`;
                if(itemData.attachments.pdf) detailHTML += `<li><i class="fas fa-file-pdf"></i> <a href="${escapeHTML(itemData.attachments.pdf)}" target="_blank">View PDF</a> (Simulated)</li>`;
                if(itemData.attachments.image) detailHTML += `<li><i class="fas fa-file-image"></i> <a href="${escapeHTML(itemData.attachments.image)}" target="_blank">View Image</a> (Simulated)</li>`;
                if(itemData.attachments.video) detailHTML += `<li><i class="fas fa-video"></i> <a href="${escapeHTML(itemData.attachments.video)}" target="_blank">Watch Video</a></li>`;
                if(itemData.attachments.drive) detailHTML += `<li><i class="fab fa-google-drive"></i> <a href="${escapeHTML(itemData.attachments.drive)}" target="_blank">Open Drive Link</a></li>`;
                detailHTML += `</ul>`;
            }
             detailHTML += `</div>`; 
             detailHTML += `</div>`; 
        }
        
        if (childItems.length > 0) {
            detailHTML += `<div class="card" style="margin-top: 1.5rem;">
                            <h3 style="font-size: 1.25rem; font-weight:600; margin-bottom:1rem;">Child Items</h3>
                            <ul class="child-items-list">`;
            childItems.forEach(child => {
                 detailHTML += `<li><a href="#${child.sectionId}/${child.id}"><i class="fas fa-angle-right"></i> ${escapeHTML(child.title)} (${escapeHTML(child.type)})</a></li>`;
            });
            detailHTML += `</ul></div>`;
        }

        detailHTML += `<div class="item-feedback-section card">
                        <h4>Rate this Content</h4>
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                            <div class="rating-buttons">
                                <button id="rateUpBtn"><i class="fas fa-thumbs-up"></i> Helpful</button>
                                <button id="rateDownBtn"><i class="fas fa-thumbs-down"></i> Not Helpful</button>
                            </div>
                            <span class="read-stats">(Total Reads: ${itemData.views || Math.floor(Math.random() * 200) + 10})</span>
                        </div>
                        <button id="reportIssueBtn" class="button button-secondary button-danger" style="background-color:transparent; border-color: var(--no-color); color: var(--no-color);"><i class="fas fa-flag"></i> Report an Issue with this Content</button>
                       </div>`;
        
        detailHTML += `<div class="comments-section card" style="margin-top: 1.5rem;">
                        <h4><i class="fas fa-comments"></i> Comments & Discussion</h4>
                        <div class="comment-display-area" id="commentDisplayAreaForItem">
                           <!-- Comments will be rendered here by renderComments -->
                        </div>
                        <textarea id="newCommentText" class="form-group" placeholder="Type your comment here..."></textarea>
                        <button id="postCommentBtn" class="button" style="margin-top:0.5rem;"><i class="fas fa-paper-plane"></i> Post Comment</button>
                       </div>`;


        itemDetailViewPlaceholder.innerHTML = detailHTML;
        renderComments(itemData, 'commentDisplayAreaForItem'); 
        
        if (itemDetailViewPlaceholder.querySelector('pre.mermaid') && itemDetailViewPlaceholder.dataset.mermaidRendered !== 'true') {
            await renderMermaidDiagramsInElement(itemDetailViewPlaceholder);
        }


        document.getElementById('backToSectionBtn').addEventListener('click', () => {
            window.location.hash = `#${sectionId}`;
        });
        const backToParentBtn = document.getElementById('backToParentBtn');
        if (backToParentBtn) {
            backToParentBtn.addEventListener('click', (e) => {
                window.location.hash = `#${e.currentTarget.dataset.parentSection}/${e.currentTarget.dataset.parentId}`;
            });
        }
        if (currentUser && currentUser.role === 'admin') {
            const editBtn = document.getElementById('editItemBtn');
            if(editBtn) editBtn.addEventListener('click', (e) => {
                const sId = e.currentTarget.dataset.sectionId;
                const iId = e.currentTarget.dataset.itemId;
                const sec = kbSystemData.sections.find(s => s.id === sId);
                const item = sec?.items?.find(i => i.id === iId);
                if (item) openAddContentModal(sId, item);
            });
            const deleteBtn = document.getElementById('deleteItemBtn');
             if(deleteBtn) deleteBtn.addEventListener('click', (e) => {
                const sId = e.currentTarget.dataset.sectionId;
                const iId = e.currentTarget.dataset.itemId;
                if(confirm(`Are you sure you want to delete item "${itemData.title}"? This cannot be undone.`)){
                    const sec = kbSystemData.sections.find(s => s.id === sId);
                    if(sec && sec.items){
                        sec.items = sec.items.filter(item => item.id !== iId);
                        showToast('Item deleted successfully.', 'success');
                        window.location.hash = `#${sId}`; 
                    }
                }
            });
        }

        document.getElementById('printItemBtn').addEventListener('click', () => window.print());
        document.getElementById('shareItemBtn').addEventListener('click', () => {
            navigator.clipboard.writeText(window.location.href)
                .then(() => showToast('Link copied to clipboard!', 'success'))
                .catch(() => showToast('Failed to copy link.', 'error'));
        });
        document.getElementById('downloadPdfItemBtn').addEventListener('click', () => showToast('PDF Download (simulated).', 'info'));

        document.getElementById('rateUpBtn').addEventListener('click', () => showToast('Thanks for your feedback!', 'success'));
        document.getElementById('rateDownBtn').addEventListener('click', () => showToast('Thanks for your feedback! We will review this content.', 'info'));
        document.getElementById('reportIssueBtn').addEventListener('click', () => showToast('Issue reported. Thank you!', 'info'));

        document.getElementById('postCommentBtn').addEventListener('click', () => {
            const commentTextEl = document.getElementById('newCommentText');
            const commentText = commentTextEl.value.trim();
            if (!commentText) {
                showToast('Please enter a comment.', 'error');
                commentTextEl.focus();
                return;
            }

            const currentItemData = kbSystemData.sections.find(s => s.id === currentOpenItem.sectionId)?.items?.find(i => i.id === currentOpenItem.itemId);
            if (currentItemData && currentUser) { 
                if (!currentItemData.comments) {
                    currentItemData.comments = [];
                }
                currentItemData.comments.push({
                    id: `cmt_${Date.now()}`,
                    authorEmail: currentUser.email,
                    authorName: currentUser.name, // Use .name from profile
                    text: commentText, // Added the actual comment text
                    timestamp: new Date().toISOString()
                });
                renderComments(currentItemData, 'commentDisplayAreaForItem'); 
                commentTextEl.value = ''; 
                showToast('Comment posted!', 'success');
            } else {
                showToast('Error posting comment. Item or user data not found.', 'error');
            }
        });
    }


    const contentTemplates = {
        standard_article: {
            type: 'article',
            titlePrefix: 'New Article: ',
            summary: 'A general article about [topic].',
            content: '<h2>Introduction</h2><p>[Provide a brief introduction to the topic.]</p><h2>Main Content</h2><p>[Elaborate on the main points here. You can use lists, paragraphs, etc.]</p><ul><li>Point 1</li><li>Point 2</li></ul><h2>Conclusion</h2><p>[Summarize the key takeaways.]</p>',
            tags: ['article']
        },
        troubleshooting_guide: {
            type: 'case', 
            titlePrefix: 'Case: Troubleshooting ',
            summary: 'A step-by-step guide to resolve [issue].',
            content: '<h3>Issue Description</h3><p>[Clearly describe the problem or issue this guide addresses.]</p><h3>Symptoms</h3><ul><li>[Symptom 1]</li><li>[Symptom 2]</li></ul><h3>Resolution Steps</h3><ol><li><strong>Step 1:</strong> [Action to take]</li><li><strong>Step 2:</strong> [Another action]</li></ol><h3>Verification</h3><p>[How to verify the issue is resolved.]</p>',
            tags: ['troubleshooting', 'guide', 'case']
        },
        policy_document: {
            type: 'policy',
            titlePrefix: 'Policy: ',
            summary: 'Official policy regarding [subject matter].',
            content: '<h1>[Policy Title]</h1><p><strong>Version:</strong> 1.0</p><p><strong>Effective Date:</strong> [Date]</p><h2>1. Purpose</h2><p>[State the purpose of this policy.]</p><h2>2. Scope</h2><p>[Define who this policy applies to.]</p><h2>3. Policy Statement</h2><p>[Detail the policy rules and guidelines.]</p><h2>4. Responsibilities</h2><p>[Outline responsibilities related to this policy.]</p>',
            tags: ['policy', 'official']
        },
         blank: {
            type: 'article', 
            titlePrefix: '',
            summary: '',
            content: '<p><br></p>', 
            tags: []
        }
    };

    function applyTemplate(templateKey) {
        const template = contentTemplates[templateKey];
        if (!template) return;

        contentTypeSelect.value = template.type;
        document.getElementById('contentTitle').value = template.titlePrefix;
        document.getElementById('contentSummary').value = template.summary;
        if (quillEditor) quillEditor.root.innerHTML = template.content;
        contentTagsInput.value = template.tags.join(', ');
        
        addContentForm.classList.remove('hidden');
        templateSelectionContainer.classList.add('hidden');
        contentTypeSelect.dispatchEvent(new Event('change')); 
        document.getElementById('contentTitle').focus();
    }


    // --- Add Content Modal Logic ---
    function openAddContentModal(sectionIdForContent, itemToEdit = null) {
        addContentForm.reset();
        addContentForm.dataset.sectionId = sectionIdForContent;
        editingItemIdInput.value = ""; 
        
        if (!quillEditor) {
            quillEditor = new Quill('#quillEditor', {
                theme: 'snow',
                modules: { 
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ 'color': [] }, { 'background': [] }],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        [{ 'align': [] }],
                        ['link', 'image', 'video', 'blockquote', 'code-block'], 
                        ['clean']
                    ]
                },
                placeholder: 'Enter detailed content here...'
            });
        }
        quillEditor.root.innerHTML = ''; 

        if (itemToEdit) {
            document.getElementById('addContentModalTitle').textContent = 'Edit Content';
            editingItemIdInput.value = itemToEdit.id; 
            document.getElementById('contentTitle').value = itemToEdit.title;
            document.getElementById('contentSummary').value = itemToEdit.summary;
            contentTypeSelect.value = itemToEdit.type;
            if (itemToEdit.url) document.getElementById('contentUrl').value = itemToEdit.url;
            if (itemToEdit.content) quillEditor.root.innerHTML = itemToEdit.content;
            else if (itemToEdit.resolution_steps) quillEditor.root.innerHTML = itemToEdit.resolution_steps;
            contentTagsInput.value = (itemToEdit.tags || []).join(', ');
            
            if (itemToEdit.attachments) {
                if(itemToEdit.attachments.video) document.getElementById('videoLink').value = itemToEdit.attachments.video;
                if(itemToEdit.attachments.drive) document.getElementById('driveLink').value = itemToEdit.attachments.drive;
            }
            templateSelectionContainer.classList.add('hidden');
            addContentForm.classList.remove('hidden');
            document.getElementById('contentTitle').focus();
        } else {
            document.getElementById('addContentModalTitle').textContent = 'Add New Content';
            templateSelectionContainer.classList.remove('hidden');
            addContentForm.classList.add('hidden');
        }
        
        contentTypeSelect.dispatchEvent(new Event('change'));
        addContentModalOverlay.classList.remove('hidden');
    }

    document.querySelectorAll('.template-button').forEach(button => {
        button.addEventListener('click', () => {
            applyTemplate(button.dataset.template);
        });
    });


    function closeAddContentModal() {
        addContentModalOverlay.classList.add('hidden');
        templateSelectionContainer.classList.add('hidden'); 
        addContentForm.classList.add('hidden'); 
        editingItemIdInput.value = ""; 
    }

    contentTypeSelect.addEventListener('change', (e) => {
        const type = e.target.value;
        contentUrlContainer.classList.add('hidden');
        contentDetailContainer.classList.remove('hidden'); 

        if (type === 'form_sheet' || type === 'design') {
            contentUrlContainer.classList.remove('hidden');
            contentDetailContainer.classList.add('hidden'); 
        } else if (type === 'case') {
            contentDetailLabel.textContent = 'Case Details / Resolution Steps';
        } else if (type === 'article') {
            contentDetailLabel.textContent = 'Article Content';
        } else if (type === 'guide') {
            contentDetailLabel.textContent = 'Guide Content';
        } else if (type === 'policy') {
            contentDetailLabel.textContent = 'Policy Details';
        }
    });

    addContentForm.addEventListener('submit', (e) => {
        e.preventDefault();
        if (!currentUser) {
            showToast('Error: User not authenticated.', 'error');
            return;
        }
        const sectionId = addContentForm.dataset.sectionId;
        const section = kbSystemData.sections.find(s => s.id === sectionId);
        if (!section) {
            showToast('Error: Target section not found!', 'error'); return;
        }
        
        const editingId = editingItemIdInput.value; 
        let itemData;

        const commonData = {
            type: contentTypeSelect.value,
            title: document.getElementById('contentTitle').value.trim(),
            summary: document.getElementById('contentSummary').value.trim(),
            tags: contentTagsInput.value.split(',').map(tag => tag.trim()).filter(tag => tag),
        };

        if (!commonData.title || !commonData.summary) {
            showToast('Title and Summary are required.', 'error');
            return;
        }

        if (editingId) { 
            itemData = section.items.find(i => i.id === editingId);
            if (!itemData) { showToast('Error: Item to edit not found!', 'error'); return; }
            Object.assign(itemData, commonData); 
            itemData.lastModified = new Date().toISOString();
            itemData.views = itemData.views || 0;
            itemData.comments = itemData.comments || [];
        } else { 
            itemData = {
                ...commonData,
                id: `${sectionId}_item_${Date.now()}`,
                createdBy: currentUser.email, 
                createdAt: new Date().toISOString(),
                views: 0,
                comments: []
            };
            kbSystemData.meta.lastArticleAdded = { title: itemData.title, date: new Date(itemData.createdAt).toLocaleDateString() };
            kbSystemData.meta.editsThisWeek = (kbSystemData.meta.editsThisWeek || 0) + 1;
        }

        if (itemData.type === 'case') {
            itemData.resolution_steps = quillEditor.root.innerHTML;
            itemData.status = itemData.status || 'New'; 
        } else if (['article', 'guide', 'policy'].includes(itemData.type)) {
            itemData.content = quillEditor.root.innerHTML;
        } else if (itemData.type === 'form_sheet' || itemData.type === 'design') {
            itemData.url = document.getElementById('contentUrl').value.trim();
            if (!itemData.url) { showToast('A URL is required for this content type.', 'error'); return; }
        }

        itemData.attachments = itemData.attachments || {};
        const pdfFile = document.getElementById('pdfFile').files[0];
        const imageFile = document.getElementById('imageFile').files[0];
        const videoLink = document.getElementById('videoLink').value.trim();
        const driveLink = document.getElementById('driveLink').value.trim();

        if (pdfFile) itemData.attachments.pdf = `simulated_uploads/${pdfFile.name}`; 
        if (imageFile) itemData.attachments.image = `simulated_uploads/${imageFile.name}`; 
        if (videoLink) itemData.attachments.video = videoLink; else delete itemData.attachments.video;
        if (driveLink) itemData.attachments.drive = driveLink; else delete itemData.attachments.drive;


        if (!editingId) { 
            if (!section.items) section.items = [];
            section.items.push(itemData);
        }

        showToast(`Content '${itemData.title}' ${editingId ? 'updated' : 'saved'} successfully!`, 'success');
        closeAddContentModal();
        
        if (editingId && currentOpenItem && currentOpenItem.itemId === editingId) {
            displayItemDetail(currentOpenItem.sectionId, currentOpenItem.itemId);
        } else {
            window.location.hash = `#${sectionId}`;
            handleNavigation(); 
        }
    });

    // --- Global Search ---
    globalSearchInput.addEventListener('input', () => {
        const query = globalSearchInput.value.trim().toLowerCase();
        if (query.length < 2) {
            searchResultsContainer.classList.add('hidden');
            return;
        }
        const results = [];
        kbSystemData.sections.forEach(s => {
            if (s.id === 'home') return; 
            s.items?.forEach(i => {
                if (i.title.toLowerCase().includes(query) || 
                    (i.summary && stripHtml(i.summary).toLowerCase().includes(query)) || 
                    (i.content && stripHtml(i.content).toLowerCase().includes(query)) ||
                    (i.resolution_steps && stripHtml(i.resolution_steps).toLowerCase().includes(query)) ||
                    (i.tags && i.tags.some(tag => tag.toLowerCase().includes(query)))) {
                    results.push({ ...i, sectionId: s.id, sectionName: s.name });
                }
            });
        });
        searchResultsContainer.innerHTML = '';
        if (results.length) {
            results.slice(0, 7).forEach(r => {
                const linkEl = document.createElement('a');
                linkEl.href = `#${r.sectionId}/${r.id}`;
                 linkEl.addEventListener('click', () => {
                    searchResultsContainer.classList.add('hidden');
                    globalSearchInput.value = '';
                });

                linkEl.innerHTML = `
                    <div style="font-weight: bold;">${highlightText(r.title, query)}
                        <span style="font-size: 0.8em; color: var(--text-color-muted); margin-left: 5px;">(${escapeHTML(r.type.replace('_', ' '))} in ${escapeHTML(r.sectionName)})</span>
                    </div>
                    <p style="font-size: 0.9em; color: var(--text-color-subtle); margin: 0;">${highlightText(truncateText(stripHtml(r.summary || r.content || r.resolution_steps), 70), query)}</p>`;
                searchResultsContainer.appendChild(linkEl);
            });
            searchResultsContainer.classList.remove('hidden');
        } else {
            searchResultsContainer.innerHTML = `<div style="padding: 10px; font-size: 0.9em; color: var(--text-color-muted);">No results found.</div>`;
            searchResultsContainer.classList.remove('hidden');
        }
    });
    document.addEventListener('click', e => {
        if (!globalSearchInput.contains(e.target) && !searchResultsContainer.contains(e.target)) {
            searchResultsContainer.classList.add('hidden');
        }
    });
    
    // --- Routing and Initialization ---
    function handleNavigation() {
        if (!currentUser) { 
            console.log("Current user not yet loaded, deferring navigation.");
            // initializeApp will call getCurrentUserProfile which redirects if needed.
            // If initializeApp hasn't finished, currentUser will be null.
            // We can add a small delay or rely on initializeApp to call handleNavigation again.
            // For now, if initializeApp is in progress, it will call this again once currentUser is set.
            return;
        }
        const hash = window.location.hash.substring(1) || 'home';
        const parts = hash.split('/');
        const sectionId = parts[0];
        const itemIdOrSubCategory = parts[1]; 

        highlightSidebarLink(sectionId);
        if (itemDetailViewPlaceholder) itemDetailViewPlaceholder.dataset.mermaidRendered = 'false'; 

        if (sectionId === 'home') {
            displayDashboard(); // This function now handles role-based view
        } else if (itemIdOrSubCategory && sectionId) { 
            const sectionData = kbSystemData.sections.find(s => s.id === sectionId);
            const itemExists = sectionData?.items?.some(i => i.id === itemIdOrSubCategory);
            if(itemExists) {
                displayItemDetail(sectionId, itemIdOrSubCategory);
            } else {
                displaySectionContent(sectionId, itemIdOrSubCategory); 
            }
        } else if (sectionId) {
            displaySectionContent(sectionId);
        } else {
            displayDashboard(); 
        }
        const contentWrapper = document.getElementById('contentWrapper');
        if (contentWrapper) contentWrapper.scrollTo(0,0);
    }

    async function initializeApp() {
        currentUser = await Auth.getCurrentUserProfile(); 
        
        if (!currentUser) {
            // Auth.getCurrentUserProfile() handles redirection if no valid session/profile.
            // This is a fallback or if the page isn't index.html but still tries to init.
            console.error("Initialization failed: No current user profile returned from Auth.getCurrentUserProfile().");
            // Avoid redirecting if already on login page or if not an auth-required page.
            if (window.location.pathname.includes("index.html") || window.location.pathname === '/' || window.location.pathname === '') {
                 // It's possible Auth.getCurrentUserProfile already redirected.
                 // If not, this is a last resort.
                 if (!window.location.href.includes("login.html")) {
                    window.location.href = 'login.html';
                 }
            }
            return; // Stop further initialization
        }

        // User is authenticated, and profile is fetched
        const displayName = currentUser.name || currentUser.email || 'User'; // Prioritize 'name'
        userNameDisplayHeader.textContent = displayName;
        userAvatar.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName.split(' ').join('+'))}&size=36&background=6366f1&color=fff&rounded=true&font-size=0.5`;
        footerKbVersion.textContent = kbSystemData.meta.version;
        currentUserRoleSpan.textContent = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
        
        const currentYear = new Date().getFullYear();
        document.querySelector('footer span:first-child').innerHTML = `© ${currentYear} InfiniBase.Elmenisy. Version <span id="footerKbVersion">${kbSystemData.meta.version}</span>`;

        populateSidebar();
        applyPermanentDarkMode(); 
        handleNavigation(); // Safe to call now as currentUser is populated

        window.addEventListener('hashchange', handleNavigation);
        
        logoutButton.addEventListener('click', () => {
            logoutConfirmModalOverlay.classList.remove('hidden');
        });
        closeLogoutConfirmModalBtn.addEventListener('click', () => logoutConfirmModalOverlay.classList.add('hidden'));
        cancelLogoutBtn.addEventListener('click', () => logoutConfirmModalOverlay.classList.add('hidden'));
        confirmLogoutBtn.addEventListener('click', async () => {
            await Auth.logout(); 
            logoutConfirmModalOverlay.classList.add('hidden');
        });
        
        closeAddContentModalBtn.addEventListener('click', closeAddContentModal);
        cancelAddContentBtn.addEventListener('click', closeAddContentModal);
        
        if (window.innerWidth < 768) {
            sidebar.classList.add('closed');
        }
        
        if (localStorage.getItem('justLoggedIn') === 'true') {
            showToast(`InfiniBase v${kbSystemData.meta.version} loaded. Welcome, ${displayName}!`, 'success', 4000);
            localStorage.removeItem('justLoggedIn');
        } else {
            showToast(`InfiniBase v${kbSystemData.meta.version} ready.`, 'info', 2000);
        }
        console.log(`InfiniBase v${kbSystemData.meta.version} initialized. User: ${displayName}, Role: ${currentUser.role}`);
    }

    initializeApp();

</script>
</body>
</html>
