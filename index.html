<!DOCTYPE html>
<html lang="en" dir="ltr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InfiniBase - Knowledge Base</title>
    <!-- Updated Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32' width='32' height='32'><rect width='32' height='32' rx='4' fill='%236366f1'/><text x='50%' y='55%' dominant-baseline='middle' text-anchor='middle' font-family='Arial, sans-serif' font-size='18' font-weight='bold' fill='white'>IB</text></svg>">
    
    <!-- CDNs -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>


    <style>
        :root {
            /* Permanent Dark Theme Variables */
            --primary-color: #6366f1; /* Brighter Indigo for dark */
            --primary-color-hover: #4f46e5;
            --secondary-color: #9ca3af;

            --text-color: #d1d5db;
            --text-color-muted: #9ca3af;
            --text-color-inverted: #ffffff; 
            --text-color-subtle: #9ca3af;

            --bg-color: #111827; /* Dark gray */
            --bg-color-alt: #1f2937; /* Slightly lighter dark gray for cards/modals */
            --bg-color-sidebar: #1f2937;
            --bg-color-header: rgba(31, 41, 55, 0.9);
            --bg-color-modal: #1f2937;
            --bg-color-hover: #374151;
            --bg-color-active: var(--primary-color);

            --border-color: #374151;
            --border-color-darker: #4b5563;

            --card-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            --card-hover-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            
            --border-radius: 0.5rem; 
            --border-radius-lg: 0.75rem;
            --header-height: 70px;
            --sidebar-width: 260px;

            --yes-color: #22c55e; /* Green for Yes */
            --no-color: #ef4444;   /* Red for No */
            --rating-color: #fbbf24; /* Amber 400 for ratings */
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            line-height: 1.6;
            font-size: 16px;
        }

        a { text-decoration-skip-ink: none; }

        .container-fluid {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-color-sidebar);
            padding: 1.5rem;
            border-right: 1px solid var(--border-color); /* LTR */
            position: fixed;
            top: 0;
            left: 0; /* LTR */
            height: 100vh;
            overflow-y: auto;
            transition: transform 0.3s ease-in-out, background-color 0.3s ease, border-color 0.3s ease;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }
        .sidebar.closed {
            transform: translateX(-100%); /* LTR */
        }
        @media (min-width: 768px) {
            .sidebar.closed { transform: translateX(0); }
        }

        .sidebar-header {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            color: var(--text-color); 
        }
        .sidebar-header i { 
            margin-right: 0.75rem; /* LTR */
            color: var(--primary-color);
            font-size: 1.8rem;
        }
        .sidebar-logo-text {
             color: var(--text-color);
        }

        .sidebar-nav { flex-grow: 1; }

        .sidebar-section-title {
            padding-left: 0.75rem; /* LTR */
            font-size: 0.75rem;
            font-weight: 700; /* Increased font-weight for better visibility */
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--text-color-muted);
        }

        .sidebar-link {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-radius: var(--border-radius);
            transition: background-color 0.2s ease, color 0.2s ease;
            font-weight: 500;
            color: var(--text-color-subtle);
            text-decoration: none;
            margin-bottom: 0.25rem;
        }
        .sidebar-link i {
            margin-right: 0.75rem; /* LTR */
            width: 1.5rem; /* Adjusted for font-size */
            font-size: 1.5rem; /* Increased icon size */
            text-align: center;
            transition: color 0.2s ease;
        }
        .sidebar-link:hover {
            background-color: var(--bg-color-hover);
            color: var(--text-color);
        }
        .sidebar-link.active {
            background-color: var(--bg-color-active); /* Primary color */
            color: var(--text-color-inverted) !important; /* White text */
            font-weight: 600;
        }
        .sidebar-link.active i {
            color: var(--text-color-inverted) !important; /* White icon on primary background */
        }

        .sidebar-footer {
            margin-top: auto; 
            padding-top: 1rem;
        }
        .sidebar-footer button {
            width: 100%;
            margin-top: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sidebar-footer button i { margin-right: 0.5rem; }


        .content-wrapper {
            flex-grow: 1;
            padding-right: 1.5rem; /* LTR */
            padding-left: 1.5rem;
            transition: margin-left 0.3s ease-in-out; /* LTR */
            height: 100vh;
            overflow-y: auto;
        }
        @media (min-width: 768px) {
             .content-wrapper { margin-left: var(--sidebar-width); /* LTR */ }
             .sidebar.closed + .content-wrapper { margin-left: 0; /* LTR */ }
        }

        .content-header {
            background-color: var(--bg-color-header);
            padding: 1.25rem 2rem; 
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky; 
            top: 0;
            left: var(--sidebar-width); /* LTR, adjusted for fixed sidebar */
            right: 0;
            height: var(--header-height);
            z-index: 50;
            backdrop-filter: blur(8px); 
        }
         @media (max-width: 767px) { /* Mobile: header spans full width */
            .content-header {
                left: 0;
            }
        }
        .header-left-content { display: flex; align-items: center; } 
        #currentSectionTitle {
            font-size: 1.5rem; 
            font-weight: bold;
            margin: 0;
        }
        #breadcrumbs {
            font-size: 0.875rem; 
            color: var(--text-color-muted);
            margin-top: 0.25rem;
        }
        #breadcrumbs a { color: var(--primary-color); text-decoration: none; }
        #breadcrumbs a:hover { text-decoration: underline; }

        .header-right-content { display: flex; align-items: center; gap: 1rem; }
        .search-container { position: relative; }
        .search-container input[type="search"] {
            padding: 0.625rem 1rem 0.625rem 2.5rem; /* py-2.5 pl-10 pr-4 for LTR */
            border: 1px solid var(--border-color-darker);
            border-radius: 9999px; 
            min-width: 250px; 
            background-color: var(--bg-color-alt); 
            color: var(--text-color);
        }
        .search-container input[type="search"]::placeholder {
            color: var(--text-color-muted);
            opacity: 0.8;
        }
        .search-container .search-icon {
            position: absolute;
            inset-inline-start: 0.75rem; 
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-color-muted);
        }
        #searchResultsContainer {
            position: absolute;
            background-color: var(--bg-color-alt);
            border: 1px solid var(--border-color);
            border-top: none;
            width: 100%; 
            max-height: 300px; 
            overflow-y: auto;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); 
            z-index: 60; 
            border-radius: 0 0 var(--border-radius) var(--border-radius);
        }
        #searchResultsContainer a {
            display: block;
            padding: 0.75rem; 
            text-decoration: none;
            color: var(--text-color);
        }
        #searchResultsContainer a:hover { background-color: var(--bg-color-hover); }
        #searchResultsContainer mark { background-color: #78350f; color: #f3f4f6; }


        .user-profile { display: flex; align-items: center; gap: 0.5rem; }
        .user-profile img { width: 36px; height: 36px; border-radius: 50%; }
        #userNameDisplayHeader { font-weight: 500; }
        @media (max-width: 640px) { 
            #userNameDisplayHeader { display: none; }
        }

        main { padding: 1.5rem 0; }
        
        .card {
            background-color: var(--bg-color-alt);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg); 
            padding: 1.5rem;
            margin-bottom: 1.5rem; 
            box-shadow: var(--card-shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease, border-color 0.3s ease;
            display: flex;
            flex-direction: column; 
            min-height: 150px; 
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--card-hover-shadow);
        }
        .card-header-icon {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .card-icon-container {
            padding: 0.75rem;
            border-radius: 50%;
            margin-right: 1rem; /* LTR */
            background-color: var(--primary-color-hover); 
        }
        .card-icon-container i {
            font-size: 1.25rem;
            color: var(--text-color-inverted);  
        }
        .card-title-group {
            flex-grow: 1;
        }
        .card h3 { margin-top: 0; font-size: 1.125rem; font-weight: 600; color: var(--text-color); line-height: 1.3; }
        .card p { margin-bottom: 1rem; font-size: 0.875rem; color: var(--text-color-subtle); flex-grow: 1; }
        
        .updated-badge {
            display: inline-block;
            background-color: rgba(34, 197, 94, 0.15); /* Green with transparency */
            border: 1px solid rgba(34, 197, 94, 0.4);
            color: #22c55e;
            padding: 0.15rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            margin-top: 0.4rem;
        }
        .card-tags {
            margin-top: 0rem;
            margin-bottom: 0.75rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .card-tags .tag {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            color: var(--text-color-muted);
            padding: 0.2rem 0.6rem;
            border-radius: 9999px;
            font-size: 0.7rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }

        .card-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
            margin-top: auto;
        }
        .card-actions .button {
            padding: 0.5rem 0.75rem;
            font-size: 0.8rem;
        }

        .button, button {
            background-color: var(--primary-color);
            color: var(--text-color-inverted);
            border: 1px solid transparent;
            padding: 0.625rem 1rem; 
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.875rem; 
            font-weight: 500; 
            transition: background-color 0.2s, border-color 0.2s, color 0.2s;
            text-decoration: none; 
            display: inline-flex; 
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .button:hover, button:hover {
            background-color: var(--primary-color-hover);
        }
        .button-secondary {
            background-color: transparent;
            color: var(--text-color-subtle);
            border-color: var(--border-color-darker);
        }
        .button-secondary:hover { background-color: var(--bg-color-hover); color: var(--text-color); }
        .button-danger {
            background-color: #dc2626; 
            color: var(--text-color-inverted);
        }
        .button-danger:hover { background-color: #b91c1c; }
        input:focus, button:focus, select:focus, textarea:focus, a:focus { 
            outline: 2px solid transparent;
            outline-offset: 2px;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.6); 
        }
        button:disabled {
            background-color: var(--border-color);
            color: var(--text-color-muted);
            cursor: not-allowed;
            border-color: transparent;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.75); 
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.2s ease-out;
        }
        .modal-overlay:not(.hidden) { opacity: 1; }
        .modal-content {
            background-color: var(--bg-color-modal);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 48rem; 
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.95);
            opacity: 0;
            transition: transform 0.2s ease-out, opacity 0.2s ease-out, background-color 0.3s ease, border-color 0.3s ease;
        }
        .modal-overlay:not(.hidden) .modal-content { transform: scale(1); opacity: 1; }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem; 
        }
        .modal-header h2 { margin-top: 0; font-size: 1.5rem; font-weight: 700; }
        .modal-header .close-button { 
            background: none; border: none; font-size: 1.5rem; color: var(--text-color-muted); cursor: pointer;
            padding: 0.25rem; line-height: 1; border-radius: 50%;
        }
        .modal-header .close-button:hover { background-color: var(--bg-color-hover); }
        
        .modal-body { /* For modals with just text content like confirm */
            padding-bottom: 1rem;
            font-size: 1rem;
            color: var(--text-color);
        }

        .modal-actions {
            margin-top: 1.5rem; 
            text-align: right; /* LTR */
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end; /* LTR */
            gap: 0.75rem; 
        }
         .modal-actions.no-border {
            border-top: none;
            padding-top: 0;
        }


        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.25rem; font-weight: 500; font-size: 0.875rem; }
        .form-group input[type="text"],
        .form-group input[type="url"],
        .form-group input[type="email"],
        .form-group input[type="file"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.625rem; 
            border: 1px solid var(--border-color-darker); 
            border-radius: var(--border-radius);
            box-sizing: border-box;
            background-color: var(--bg-color); 
            color: var(--text-color);
        }
        .form-group textarea { min-height: 100px; }
        
        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: var(--text-color-muted);
            opacity: 0.8;
        }
        
        #templateSelectionContainer { margin-bottom: 1.5rem; }
        #templateSelectionContainer h3 { font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-color); }
        .template-buttons-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .template-button {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color-darker);
            color: var(--text-color-subtle);
            padding: 1rem;
            border-radius: var(--border-radius);
            text-align: left;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .template-button:hover {
            border-color: var(--primary-color);
            background-color: var(--bg-color-hover);
            color: var(--text-color);
        }
        .template-button i { 
            font-size: 1.5rem; 
            margin-bottom: 0.75rem;
            display: block; 
            color: var(--primary-color); 
            width: 100%;
            text-align: left;
        }
        .template-button h4 { 
            font-size: 1rem; 
            font-weight: 600; 
            margin-bottom: 0.5rem;
        }
        .template-button p { 
            font-size: 0.8rem; 
            line-height: 1.4; 
            color: var(--text-color-muted);
        }

        .ql-toolbar {
            background: var(--bg-color);
            border-color: var(--border-color-darker) !important;
            border-top-left-radius: var(--border-radius);
            border-top-right-radius: var(--border-radius);
        }
        .ql-toolbar .ql-stroke { stroke: var(--text-color-muted); }
        .ql-toolbar .ql-fill { fill: var(--text-color-muted); }
        .ql-toolbar .ql-picker-label { color: var(--text-color-muted); }
        .ql-snow .ql-picker.ql-expanded .ql-picker-options { background-color: var(--bg-color-alt); border-color: var(--border-color-darker); }
        .ql-snow .ql-picker-options .ql-picker-item:hover { color: var(--primary-color); }


        .ql-container {
            background: var(--bg-color-alt);
            border-color: var(--border-color-darker) !important;
            color: var(--text-color);
            min-height: 150px; 
            border-bottom-left-radius: var(--border-radius);
            border-bottom-right-radius: var(--border-radius);
            font-size: 1rem;
        }
        .ql-editor { padding: 12px; }
        .ql-editor.ql-blank::before {
            color: var(--text-color-muted);
            opacity: 0.6;
        }

        .ql-editor figure {
            margin: 1em auto;
            text-align: center;
        }
        .ql-editor figure img {
            max-width: 400px;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
        }
        .ql-editor figcaption {
            font-size: 0.8em;
            color: var(--text-color-muted);
            font-style: italic;
            margin-top: 0.5em;
        }


        footer {
            text-align: center;
            padding: 1.5rem;
            font-size: 0.875rem;
            color: var(--text-color-muted);
            border-top: 1px solid var(--border-color);
            margin-top: auto; 
        }

        .mobile-sidebar-toggle {
            display: block;
            position: fixed;
            top: calc((var(--header-height) - 40px) / 2); 
            left: 1.5rem; /* LTR */
            z-index: 101; 
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 0.75rem; 
            border-radius: var(--border-radius);
            font-size: 1.25rem; 
            line-height: 1;
        }
        @media (min-width: 768px) {
            .mobile-sidebar-toggle { display: none; }
            .header-left-content #currentSectionTitle { margin-left: 0; }
        }
        @media (max-width: 767px) {
            .header-left-content #currentSectionTitle { margin-left: 0.5rem; }
            .content-header { padding: 1rem; }
            .header-right-content .search-container { display:none; } 
        }

        .toast-notification {
            position: fixed;
            bottom: 20px;
            right: 20px; /* LTR */
            padding: 12px 18px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 2000; 
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            display: flex;
            align-items: center;
            background-color: var(--bg-color-alt); 
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }
        .toast-notification.show { opacity: 1; transform: translateY(0); }
        .toast-icon { margin-right: 10px; /* LTR */ font-size: 1.2em; }
        .toast-success { background-color: #10b981; color: white; border-color: #059669; } 
        .toast-error { background-color: #ef4444; color: white; border-color: #dc2626; } 
        .toast-info { background-color: #3b82f6; color: white; border-color: #2563eb; } 

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 1.5rem; 
        }

        .kb-content h1, .kb-content h2, .kb-content h3 { margin-top: 1.5em; margin-bottom: 0.5em; color: var(--text-color); }
        .kb-content p { margin-bottom: 1em; }
        .kb-content ul, .kb-content ol { margin-bottom: 1em; padding-left: 20px; /* LTR */ }
        .kb-content li { margin-bottom: 0.5em; }
        .kb-content strong { font-weight: bold; }
        .kb-content em { font-style: italic; }
        .kb-content a { color: var(--primary-color); text-decoration: underline; }
        .kb-content pre {
            background-color: var(--bg-color);
            padding: 10px;
            border-radius: var(--border-radius);
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            position: relative;
        }
        .kb-content code {
            background-color: var(--bg-color-hover);
            padding: 0.2em 0.4em;
            margin: 0;
            font-size: 85%;
            border-radius: 3px;
        }
        .kb-content blockquote {
            background-color: var(--bg-color-hover);
            padding: 0.75rem 1rem;
            border-radius: var(--border-radius);
            margin: 1em 0;
            border-left: 4px solid var(--primary-color);
            color: var(--text-color);
            position: relative;
        }
        .kb-content blockquote i.fa-comment-dots {
            margin-right: 0.5rem;
            color: var(--primary-color);
        }
        .copy-script-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: var(--bg-color);
            color: var(--text-color-muted);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
            z-index: 1;
        }
        .copy-script-btn:hover { opacity: 1; }
        
        .copyable-script-box {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color-darker);
            border-left: 4px solid var(--yes-color);
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            margin: 1.5rem 0;
        }
        .copyable-script-box .script-title {
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            color: var(--text-color);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
        }
        .copyable-script-box .script-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }
        .copyable-script-box .script-text {
            flex-grow: 1;
            color: var(--text-color-subtle);
            line-height: 1.5;
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 0.9rem;
        }
        .copyable-script-box .copy-btn {
            flex-shrink: 0;
            background-color: var(--bg-color-hover);
            border: 1px solid var(--border-color-darker);
            color: var(--text-color);
            padding: 0.4rem 0.8rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.8rem;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s ease;
        }
        .copyable-script-box .copy-btn:hover {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .content-section-box {
            background-color: var(--bg-color);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            margin-bottom: 1.5rem;
            border-left: 4px solid var(--primary-color);
        }
        .content-section-box h3 {
            margin-top: 0;
            margin-bottom: 0.75rem;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--text-color);
        }
        .compensation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .compensation-box {
            background-color: var(--bg-color-alt);
            border: 1px solid var(--border-color-darker);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
        }
        .compensation-box h4 {
            margin-top: 0;
            font-size: 1.1rem;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.75rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .compensation-box.fast-order h4 { color: #22c55e; } /* Green */
        .compensation-box.scheduled-order h4 { color: #fbbf24; } /* Amber */
        .compensation-box ul { list-style: none; padding: 0; margin: 0; }
        .compensation-box ul li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.6rem 0;
            font-size: 0.9rem;
            border-bottom: 1px solid var(--border-color);
        }
        .compensation-box ul li:last-child { border-bottom: none; }
        .compensation-box ul li span:first-child { font-weight: 500; color: var(--text-color-subtle); }
        .compensation-box ul li .action { font-weight: 600; text-align: right; }
        
        mark {
            padding: 0.1em 0.2em; border-radius: 0.2em; font-weight: bold;
            background-color: #78350f; color: #f3f4f6; 
        }

        .hidden { display: none !important; }

        .chart-container {
            position: relative;
            padding: 1rem;
            border-radius: var(--border-radius-lg);
            background-color: var(--bg-color-alt);
            height: 320px; 
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .chart-container canvas {
            max-width: 100%;
            max-height: 100%;
        }
        .chart-container h3 {
            font-size: 1.125rem; 
            font-weight: 600; 
            margin-bottom: 0.5rem;
            text-align: center;
            width: 100%;
        }
        .mermaid-diagram-card {
            background-color: var(--bg-color-alt);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--card-shadow);
            margin-bottom: 1.5rem;
        }
        .mermaid-diagram-card h3 {
            margin-top: 0;
            margin-bottom: 1rem;
            font-size: 1.25rem;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }
        .mermaid-diagram-container {
            overflow-x: auto; 
            padding: 10px; 
            background-color: var(--bg-color-alt);
            border-radius: var(--border-radius);
        }
        .mermaid-diagram-container svg { 
            display: block;
            margin: 0 auto; 
            max-width: 100%; 
            min-height: 350px;
            height: auto;
        }
        .mermaid-diagram-container text { 
            fill: var(--text-color) !important; 
            font-family: 'Inter', sans-serif !important; 
            font-size: 14px !important;
        }
        .mermaid-diagram-container .edgeLabel,
        .mermaid-diagram-container .label,
        .mermaid-diagram-container .messageText { 
            color: var(--text-color) !important; 
            fill: var(--text-color) !important; 
        }
        .mermaid-diagram-container .actor { stroke: var(--text-color-muted) !important; fill: var(--bg-color-alt) !important; }
        .mermaid-diagram-container rect, 
        .mermaid-diagram-container polygon, 
        .mermaid-diagram-container ellipse,
        .mermaid-diagram-container circle {
            stroke: var(--primary-color) !important;
            fill: var(--bg-color-alt) !important;
        }
        .mermaid-diagram-container .cluster rect {
             fill: var(--bg-color) !important;
             stroke: var(--border-color-darker) !important;
        }
        .mermaid-diagram-container .arrowheadPath {
            fill: var(--primary-color) !important;
        }
        .mermaid-diagram-container .edgePaths path {
            stroke: var(--primary-color) !important;
        }

        #itemDetailViewPlaceholder .item-title-area {
            display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;
        }
        #itemDetailViewPlaceholder .item-title-area i.fa-title-icon {
            font-size: 2rem; color: var(--primary-color); 
        }
        #itemDetailViewPlaceholder .item-title-area h2 { font-size: 1.8rem; margin:0; }
        #itemDetailViewPlaceholder .item-summary { color: var(--text-color-subtle); margin-bottom: 1rem; font-style: italic; }
        #itemDetailViewPlaceholder hr.title-content-divider {
             margin: 1.5rem 0; border-color: var(--border-color); 
        }
        .last-updated-info {
            color: var(--yes-color); 
            font-size: 0.85rem; 
            margin-bottom: 1rem; 
            font-weight: 500;
        }
        #itemDetailViewPlaceholder .kb-content ul { list-style-type: disc; }
        #itemDetailViewPlaceholder .child-items-list { list-style-type: none; padding-left: 0; }
        #itemDetailViewPlaceholder .child-items-list li { margin-bottom: 0.5rem; }
        #itemDetailViewPlaceholder .child-items-list a { color: var(--primary-color); text-decoration: none; }
        #itemDetailViewPlaceholder .child-items-list a:hover { text-decoration: underline; }
        .item-actions-bar { display: flex; gap: 0.75rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        
        .item-feedback-section { margin-top: 2rem; padding: 1.5rem; border: 1px solid var(--border-color); border-radius: var(--border-radius-lg); background-color: var(--bg-color); }
        .item-feedback-section h4 { font-size: 1.125rem; font-weight: 600; margin-top: 0; margin-bottom: 1rem; }
        .rating-prompt { display:flex; align-items:center; gap:1rem; margin-bottom: 1rem; }
        .rating-prompt > span { font-weight: 500; }
        .rating-buttons button { background: none; border: 1px solid var(--border-color); color: var(--text-color-muted); padding: 0.5rem 0.75rem; border-radius: var(--border-radius); cursor: pointer; transition: all 0.2s; }
        .rating-buttons button:hover { border-color: var(--rating-color); color: var(--rating-color); background-color: rgba(251, 191, 36, 0.1); }
        .rating-buttons button.active.yes { border-color: var(--yes-color); color: var(--yes-color); background-color: rgba(34, 197, 94, 0.1); }
        .rating-buttons button.active.no { border-color: var(--no-color); color: var(--no-color); background-color: rgba(239, 68, 68, 0.1); }
        .rating-buttons button i { margin-right: 0.5rem; }
        .read-stats { font-size: 0.875rem; color: var(--text-color-muted); margin-top: 1.5rem; border-top: 1px solid var(--border-color); padding-top: 1rem; }
        #negativeFeedbackForm { margin-top: 1rem; }
        
        .comments-section { margin-top: 2rem; }
        .comments-section h4 { font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-color); }
        .comment-post-area {
            display: flex;
            gap: 0.75rem;
            align-items: flex-start;
            margin-bottom: 1.5rem;
        }
        .comment-post-area img { width: 36px; height: 36px; border-radius: 50%; margin-top: 5px;}
        .comment-input-wrapper { flex-grow: 1; }
        .comment-input-wrapper textarea {
            width: 100%;
            min-height: 60px;
            padding: 0.75rem;
            border: 1px solid var(--border-color-darker);
            border-radius: var(--border-radius);
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        .comment-post-actions { text-align: right; margin-top: 0.5rem; }
        
        .comment-display-area { margin-top: 1rem; display: flex; flex-direction: column; gap: 1.25rem; }
        .comment { display: flex; gap: 0.75rem; align-items: flex-start; }
        .comment img { width: 32px; height: 32px; border-radius: 50%; }
        .comment-content {
            flex-grow: 1;
            background-color: var(--bg-color-alt);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 0.75rem 1rem;
        }
        .comment-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem; }
        .comment-author { font-weight: 600; color: var(--text-color); font-size: 0.9rem; }
        .comment-timestamp { color: var(--text-color-muted); font-size: 0.75rem; }
        .comment-text {
            font-size: 0.95rem;
            line-height: 1.5;
            color: var(--text-color-subtle);
            white-space: pre-wrap;
        }
        .comment-actions { margin-top: 0.5rem; }
        .comment-actions button {
            background: none;
            border: none;
            color: var(--text-color-muted);
            font-size: 0.8rem;
            font-weight: 500;
            padding: 0.25rem 0.5rem;
            cursor: pointer;
        }
        .comment-actions button:hover { color: var(--primary-color); }

        .dashboard-stat-card {
            background-color: var(--bg-color-alt);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--card-shadow);
            text-align: center;
        }
        .dashboard-stat-card i {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 0.75rem;
        }
        .dashboard-stat-card .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            display: block;
            margin-bottom: 0.25rem;
        }
        .dashboard-stat-card .stat-label {
            font-size: 0.875rem;
            color: var(--text-color-muted);
        }
        .dashboard-quicklink-card, .dashboard-info-card {
             background-color: var(--bg-color-alt);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--card-shadow);
        }
         .dashboard-quicklink-card h3, .dashboard-info-card h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }
        .dashboard-quicklink-card ul, .dashboard-info-card ul {
            list-style: none;
            padding: 0;
        }
        .dashboard-quicklink-card ul li a, .dashboard-info-card ul li a {
            display: block;
            padding: 0.5rem 0;
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
        }
         .dashboard-quicklink-card ul li a:hover, .dashboard-info-card ul li a:hover {
            text-decoration: underline;
        }
         .dashboard-info-card ul li {
            font-size: 0.9rem;
            color: var(--text-color-subtle);
            padding: 0.3rem 0;
         }
         .dashboard-info-card ul li strong {
            color: var(--text-color);
         }
         .dashboard-info-card ul li .meta {
            font-size: 0.75rem;
            display: block;
            color: var(--text-color-muted);
         }
        .viewer-dashboard-message .card {
            text-align: center;
            padding: 40px 20px;
            min-height: auto;
        }
        .viewer-dashboard-message .card i {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
        .viewer-dashboard-message .card h2 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--text-color);
        }
        .viewer-dashboard-message .card p {
            font-size: 1rem;
            color: var(--text-color-muted);
            margin-bottom: 0;
        }
        .viewer-dashboard-message .card p.subtle-note {
             font-size: 0.9rem;
             margin-top: 1rem;
        }

        /* Sidebar Topic Tree */
        .sidebar-topic-tree details { margin-bottom: 0.25rem; }
        .sidebar-topic-tree summary {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-radius: var(--border-radius);
            font-weight: 600;
            color: var(--text-color-subtle);
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
            list-style: none; /* Hide default arrow */
        }
        .sidebar-topic-tree summary::-webkit-details-marker { display: none; }
        .sidebar-topic-tree summary:hover {
            background-color: var(--bg-color-hover);
            color: var(--text-color);
        }
        .sidebar-topic-tree summary .fa-chevron-right {
            margin-right: 0.75rem;
            font-size: 0.8rem;
            transition: transform 0.2s ease;
        }
        .sidebar-topic-tree details[open] > summary .fa-chevron-right {
            transform: rotate(90deg);
        }
        .sidebar-topic-tree .subtopic-list {
            padding-left: 1.5rem;
            margin-top: 0.25rem;
            border-left: 1px solid var(--border-color);
            margin-left: 0.5rem;
        }
        .sidebar-topic-tree .subtopic-link {
            display: block;
            padding: 0.5rem 0.75rem;
            color: var(--text-color-muted);
            text-decoration: none;
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            position: relative;
        }
         .sidebar-topic-tree .subtopic-link:hover {
            background-color: var(--bg-color-hover);
            color: var(--text-color);
         }
        .sidebar-topic-tree .subtopic-link.active {
            color: var(--primary-color);
            font-weight: 600;
        }

        @media print {
            body, .container-fluid {
                margin: 0;
                padding: 0;
                background-color: white !important;
                color: black !important;
                font-size: 12pt;
            }
            .sidebar, .content-header, .sidebar-footer, footer,
            .mobile-sidebar-toggle, #toastContainer,
            .item-actions-bar .button:not(#printItemBtn):not(#downloadPdfItemBtn),
            .item-actions-bar button[id*="edit"], .item-actions-bar button[id*="delete"], .item-actions-bar button[id*="share"],
            .item-feedback-section, .comments-section,
            .modal-overlay,
            .copy-script-btn, .copyable-script-box .copy-btn,
            .dashboard-overview-container,
            .search-container, .user-profile,
            #openAddContentBtnInSection,
            .card-hover-details,
            .card-actions,
            .updated-badge, .last-updated-info
            {
                display: none !important;
            }

            .content-wrapper {
                margin-left: 0 !important;
                padding: 1cm !important;
                overflow: visible !important;
                height: auto !important;
                width: 100% !important;
            }
            #pageContentArea { padding: 0 !important; }
            
            #itemDetailViewPlaceholder, #standardSectionContentPlaceholder {
                display: block !important;
            }
            .card, .mermaid-diagram-card, .compensation-box, .content-section-box, .copyable-script-box {
                box-shadow: none !important;
                border: 1px solid #ccc !important;
                margin-bottom: 0.5cm !important;
                background-color: white !important;
                page-break-inside: avoid;
            }
            
            .card *, .mermaid-diagram-card *, .compensation-box *, .content-section-box *, .copyable-script-box * {
                color: black !important;
                background-color: transparent !important;
            }
             h1, h2, h3, h4, h5, h6 { color: black !important; }

            .kb-content a, .sidebar-link, .subtopic-link {
                color: #0066cc !important;
                text-decoration: underline !important;
            }
            .kb-content a[href^="http"]::after, 
            .kb-content a[href^="https"]::after {
                content: " (" attr(href) ")";
                font-size: 0.8em;
                color: #555 !important;
                word-break: break-all;
            }
            .kb-content a[href^="#"]::after {
                content: "";
            }

            .mermaid-diagram-container { background-color: white !important; }
            .mermaid-diagram-container svg {
                background-color: white !important;
                max-width: 100% !important;
                height: auto !important;
            }
            .mermaid-diagram-container text,
            .mermaid-diagram-container .edgeLabel,
            .mermaid-diagram-container .label,
            .mermaid-diagram-container .messageText {
                fill: black !important;
                font-family: 'Arial', sans-serif !important;
            }
            .mermaid-diagram-container .actor {
                stroke: #333 !important;
                fill: white !important;
            }
            .mermaid-diagram-container rect,
            .mermaid-diagram-container polygon,
            .mermaid-diagram-container ellipse,
            .mermaid-diagram-container circle {
                stroke: #333 !important;
                fill: #f0f0f0 !important;
            }
            .mermaid-diagram-container .cluster rect {
                fill: #e8e8e8 !important;
                stroke: #aaa !important;
            }
            .mermaid-diagram-container .arrowheadPath {
                fill: #333 !important;
            }
            .mermaid-diagram-container .edgePaths path {
                stroke: #333 !important;
            }
            pre.mermaid {
                background-color: #f8f8f8 !important;
                border: 1px solid #ddd !important;
                padding: 8px !important;
            }
        }

    </style>
</head>
<body>

    <div id="addContentModalOverlay" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="addContentModalTitle">Add New Content</h2>
                <button id="closeAddContentModalBtn" class="close-button" aria-label="Close">×</button>
            </div>

            <div id="templateSelectionContainer" class="hidden">
                <h3>Choose a Template</h3>
                <div class="template-buttons-grid">
                    <button class="template-button" data-template="standard_article">
                        <i class="fas fa-newspaper"></i>
                        <h4>Standard Article</h4>
                        <p>For general information, announcements, or detailed explanations.</p>
                    </button>
                    <button class="template-button" data-template="troubleshooting_guide">
                        <i class="fas fa-tools"></i>
                        <h4>Troubleshooting Guide / Case</h4>
                        <p>Step-by-step solutions for common issues or case documentation.</p>
                    </button>
                    <button class="template-button" data-template="policy_document">
                        <i class="fas fa-gavel"></i>
                        <h4>Policy Document</h4>
                        <p>Formal policies, procedures, or official guidelines.</p>
                    </button>
                     <button class="template-button" data-template="blank">
                        <i class="fas fa-file"></i>
                        <h4>Blank Document</h4>
                        <p>Start with a completely empty document of any type.</p>
                    </button>
                </div>
                <hr style="border-color: var(--border-color-darker); margin: 1.5rem 0;">
            </div>

            <form id="addContentForm" class="hidden">
                <input type="hidden" id="editingItemId">
                <div class="form-group">
                    <label for="contentType">Content Type</label>
                    <select id="contentType">
                        <option value="article">Article</option>
                        <option value="case">Case</option>
                        <option value="form_sheet">Form/Sheet (Link)</option>
                        <option value="design">Design (Link)</option>
                        <option value="guide">Guide</option>
                        <option value="policy">Policy</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="contentTitle">Title</label>
                    <input type="text" id="contentTitle" required>
                </div>
                <div class="form-group">
                    <label for="contentSummary">Summary / Description</label>
                    <textarea id="contentSummary" rows="3" required></textarea>
                </div>
                
                <div class="form-group hidden" id="contentUrlContainer">
                    <label for="contentUrl">Link (for Forms, Designs, etc.)</label>
                    <input type="url" id="contentUrl">
                </div>

                <div class="form-group" id="contentDetailContainer">
                    <label for="contentDetail" id="contentDetailLabel">Details / Content</label>
                    <div id="quillEditor"></div>
                </div>

                <div class="form-group">
                    <label for="contentTags">Tags (comma-separated)</label>
                    <input type="text" id="contentTags" placeholder="e.g., important, update, billing">
                </div>

                <hr style="border-color: var(--border-color-darker); margin: 1.5rem 0;">
                <h3 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-color);">Attachments (Optional)</h3>
                
                <div class="form-group">
                    <label for="pdfFile">Upload PDF</label>
                    <input type="file" id="pdfFile" accept=".pdf">
                </div>
                <div class="form-group">
                    <label for="imageFile">Upload Image</label>
                    <input type="file" id="imageFile" accept="image/*">
                </div>
                <div class="form-group">
                    <label for="videoLink">Video Link (e.g., YouTube, Vimeo)</label>
                    <input type="url" id="videoLink" placeholder="https://">
                </div>
                <div class="form-group">
                    <label for="driveLink">Google Drive Link</label>
                    <input type="url" id="driveLink" placeholder="https://docs.google.com/... or https://drive.google.com/...">
                </div>


                <div class="modal-actions">
                    <button type="submit" id="saveContentBtn" class="button"><i class="fas fa-save"></i> Save Content</button>
                    <button type="button" id="cancelAddContentBtn" class="button-secondary"><i class="fas fa-times"></i> Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modals -->
    <div id="logoutConfirmModalOverlay" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 28rem;">
            <div class="modal-header">
                <h2>Confirm Logout</h2>
                <button id="closeLogoutConfirmModalBtn" class="close-button">×</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to logout from InfiniBase?</p>
            </div>
            <div class="modal-actions no-border"> 
                <button type="button" id="confirmLogoutBtn" class="button button-danger"><i class="fas fa-sign-out-alt"></i> Confirm Logout</button>
                <button type="button" id="cancelLogoutBtn" class="button-secondary"><i class="fas fa-times"></i> Cancel</button>
            </div>
        </div>
    </div>
    <div id="deleteConfirmModalOverlay" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 30rem;">
            <div class="modal-header">
                <h2>Confirm Deletion</h2>
                <button id="closeDeleteConfirmModalBtn" class="close-button">×</button>
            </div>
            <div class="modal-body">
                <p id="deleteConfirmMessage">Are you sure you want to delete this item? This action cannot be undone.</p>
            </div>
            <div class="modal-actions no-border">
                <button type="button" id="confirmDeleteItemBtn" class="button button-danger"><i class="fas fa-trash-alt"></i> Confirm Delete</button>
                <button type="button" id="cancelDeleteItemBtn" class="button-secondary"><i class="fas fa-times"></i> Cancel</button>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-database"></i> <span class="sidebar-logo-text">InfiniBase</span>
            </div>
            <nav id="navigationMenu" class="sidebar-nav">
                <!-- Links will be dynamically generated -->
            </nav>
            <div class="sidebar-footer">
                <button id="logoutButton" class="button button-danger">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
                 <div id="userRoleDisplaySidebar" style="font-size: 0.8rem; color: var(--text-color-muted); text-align: center; margin-top: 0.5rem;">Role: <span id="currentUserRoleSpan"></span></div>
            </div>
        </aside>

        <div class="content-wrapper" id="contentWrapper">
            <header class="content-header">
                <div class="header-left-content">
                    <button id="mobileSidebarToggle" class="mobile-sidebar-toggle"><i class="fas fa-bars"></i></button>
                    <div>
                        <h1 id="currentSectionTitle">Welcome</h1>
                        <div id="breadcrumbs">Home</div>
                    </div>
                </div>
                <div class="header-right-content">
                    <div class="search-container">
                        <span class="search-icon"><i class="fas fa-search"></i></span>
                        <input type="search" id="globalSearchInput" placeholder="Search the knowledge base...">
                        <div id="searchResultsContainer" class="hidden"></div>
                    </div>
                    <div id="userProfileContainer" class="user-profile">
                        <img id="userAvatar" src="https://ui-avatars.com/api/?name=U&size=36&background=6366f1&color=fff&rounded=true" alt="User">
                        <span id="userNameDisplayHeader" style="font-weight: 500;">User</span>
                    </div>
                </div>
            </header>

            <main id="pageContentArea" class="p-6 md:p-8">
                <div id="dashboardOverviewContainer" class="hidden"></div>
                <div id="standardSectionContentPlaceholder"></div>
                <div id="itemDetailViewPlaceholder" class="hidden" data-mermaid-rendered="false"></div>
            </main>

            <footer class="mt-auto p-6 text-center text-sm">
                <span>© <script>document.write(new Date().getFullYear())</script> InfiniBase.Elmenisy.</span>
            </footer>
        </div>
    </div>
    <div id="toastContainer"></div>

<script type="module">
    import { supabase } from './supabase.js';

    // =================================================================================
    // IMMEDIATE SESSION CHECK & VERSION CONTROL
    // =================================================================================
    const APP_VERSION = '1.4.0'; // Increment this version to force-clear localStorage for all users on next load.
    if (localStorage.getItem('appVersion') !== APP_VERSION) {
        console.warn(`App version mismatch. Stored: ${localStorage.getItem('appVersion')}, Current: ${APP_VERSION}. Clearing storage and reloading.`);
        localStorage.clear();
        localStorage.setItem('appVersion', APP_VERSION);
        location.reload();
    }

    const { data: { session: initialSession }, error: initialSessionError } = await supabase.auth.getSession();
    if (initialSessionError || !initialSession) {
        console.error("No valid session found. Redirecting to login.", initialSessionError);
        window.location.href = 'login.html';
    }
    // =================================================================================


    // --- Initialize Mermaid ---
    mermaid.initialize({ 
        startOnLoad: false, theme: 'dark', fontFamily: 'Inter, sans-serif',
        flowchart: { htmlLabels: true, useMaxWidth: true, },
        themeVariables: {
            background: getComputedStyle(document.documentElement).getPropertyValue('--bg-color-alt').trim(), 
            primaryColor: getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim(),
            primaryTextColor: getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim(),
            lineColor: getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim(),
            textColor: getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim(),
            nodeBorder: getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim(),
        }
    });
    
    /**
     * @typedef {object} UserProfile
     * @property {string} id - User UUID
     * @property {string} [name] - User's full name
     * @property {string} email - User's email
     * @property {string} role - User's role
     * @property {string} avatar_url - URL for user's avatar
     */

    // --- Supabase Auth & User Management ---
    const Auth = {
        /** @returns {Promise<UserProfile|null>} */
        async getCurrentUserProfile() {
            const { data: { session }, error: sessionError } = await supabase.auth.getSession();
            if (sessionError || !session?.user) {
                console.error("Error fetching session or session invalid:", sessionError);
                window.location.href = 'login.html';
                return null; 
            }

            const authUser = session.user;
            let { data: userDataFromDB, error: dbError } = await supabase.from("users").select("id, name, email, role").eq("id", authUser.id).single();

            if (dbError && dbError.code !== 'PGRST116') {
                console.error("DB error fetching user profile:", dbError);
                await supabase.auth.signOut(); window.location.href = "login.html"; return null;
            }

            if (!userDataFromDB) {
                const name = authUser.user_metadata?.full_name || authUser.email.split('@')[0];
                const { data: newProfile, error: insertError } = await supabase.from('users').insert({ id: authUser.id, email: authUser.email, name, role: 'viewer' }).select().single();
                if (insertError) {
                    console.error("Fatal: Failed to create new user profile:", insertError);
                    await supabase.auth.signOut(); window.location.href = "login.html"; return null;
                }
                userDataFromDB = newProfile;
            }
            
            const displayName = userDataFromDB.name || userDataFromDB.email || 'User';
            const comprehensiveUserProfile = {
                ...userDataFromDB,
                avatar_url: `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName.split(' ').join('+'))}&background=6366f1&color=fff&rounded=true&font-size=0.5`
            };
            localStorage.setItem("infiniBaseUser", JSON.stringify(comprehensiveUserProfile));
            return comprehensiveUserProfile;
        },
        async logout() {
            const { error } = await supabase.auth.signOut();
            if (error) { showToast('Error signing out.', 'error'); } 
            else {
                localStorage.clear();
                showToast('Logged out successfully!', 'success');
                setTimeout(() => { window.location.href = 'login.html'; }, 1500);
            }
        }
    };

    // --- KB DATA (LOCAL) ---
    // This data remains local and is not intended to be fetched from a DB.
    // It's the primary source of truth for the KB content.
    let kbSystemData = {
        meta: { version: APP_VERSION, lastGlobalUpdate: new Date().toISOString() }, 
        sections: [
            { id: 'home', name: 'Home', icon: 'fas fa-home', iconColor: 'var(--primary-color)' },
            { id: 'support', name: 'Support', icon: 'fas fa-headset', iconColor: '#c084fc', items: [
                { id: 'sup_flow_compensation', type: 'article', title: 'Scenario: Customer Inquiry – Compensation Flow for Delays', 
                  summary: 'A professional knowledge article for handling customer compensation due to order delays, based on The Chefz policies.',
                  content: `<div class="content-section-box"><h3><i class="fas fa-gavel"></i> Introduction: Understanding the Compensation Policy</h3><p>This article provides a comprehensive guide for support agents on handling customer inquiries related to order delays and potential compensation. The goal is to resolve customer issues efficiently while adhering to The Chefz's quality standards and compensation matrix. A positive and empathetic approach is key to customer retention.</p></div><div class="content-section-box"><h3><i class="fas fa-headset"></i> Identify the Inquiry</h3><p>When a customer contacts support regarding a late order, the first step is to acknowledge their concern and verify the order details.</p><blockquote><i class="fas fa-comment-dots"></i> Hello, thank you for contacting The Chefz. My name is [Your Name]. I understand you're calling about a delay with your order. Could you please provide me with your order number so I can look into it for you?</blockquote><p>Once the order is located, confirm the nature of the inquiry. If it's a delay, proceed to the next step. If it's another issue (e.g., food quality), navigate to the relevant knowledge article for that topic.</p></div><div class="content-section-box"><h3><i class="fas fa-clock"></i> Assess Delay & Order Type</h3><p>Using the system, determine the exact duration of the delay against the estimated delivery time (ETA). It's crucial to identify if the order is a <strong>Fast Order</strong> or a <strong>Scheduled Order</strong>, as compensation policies differ.</p><ul><li><strong>Delay of 0-15 minutes:</strong> The order is slightly delayed. Apologize and provide a new, realistic ETA. No compensation is typically offered at this stage unless the customer is highly dissatisfied.</li><li><strong>Delay of more than 15 minutes:</strong> A significant delay has occurred. A proactive approach is required.</li></ul><blockquote><i class="fas fa-comment-dots"></i> I sincerely apologize for this significant delay. This is not the standard of service we aim to provide. Let me check the specifics of your order to see how we can best resolve this for you.</blockquote></div><div class="content-section-box"><h3><i class="fas fa-calculator"></i> Apply Compensation Matrix</h3><p>Based on the delay duration and order type, apply the official compensation policy. Agent discretion may be used within the defined limits.</p><div class="compensation-grid"><div class="compensation-box fast-order"><h4><i class="fas fa-rocket"></i> Fast Orders (&gt; 15 mins)</h4><ul><li><span>16–30 mins</span> <span class="action">Delivery Fees</span></li><li><span>31–45 mins</span> <span class="action">Fees + 25% food</span></li><li><span>46–60 mins</span> <span class="action">Fees + 50% food</span></li><li><span>&gt; 60 mins</span> <span class="action">Total Order</span></li></ul></div><div class="compensation-box scheduled-order"><h4><i class="fas fa-calendar-alt"></i> Scheduled Orders (&gt; 30 mins)</h4><ul><li><span>31–60 mins</span> <span class="action">50-100% of Total Order</span></li><li><span>&gt; 60 mins</span> <span class="action">Total Order + 50 SAR</span></li></ul></div></div><div class="copyable-script-box"><div class="script-title">Ready Message to Copy</div><div class="script-content"><span class="script-text">"We apologize for the inconvenience caused by the [duration] delay in your [Fast/Scheduled] order. A compensation of [amount] will be processed and reflected in your account within 24-48 hours."</span><button class="copy-btn" onclick="window.copyScriptToClipboard(this)">Copy</button></div></div></div><div class="content-section-box"><h3><i class="fas fa-clipboard-list"></i> Document and Log the Case</h3><p>After communicating with the customer, the agent must complete the following steps to properly document the case:</p><ul style="list-style: none; padding-left: 0; margin-top: 1rem; display: flex; flex-direction: column; gap: 0.75rem;"><li style="display: flex; align-items: center; gap: 0.75rem;"><i class="fas fa-user-tag fa-fw" style="color: var(--primary-color);"></i> Select the responsible party (e.g., Store, Driver, Company).</li><li style="display: flex; align-items: center; gap: 0.75rem;"><i class="fas fa-edit fa-fw" style="color: var(--primary-color);"></i> Log a clear note on the order including the issue, compensation amount, and the reason for compensation.</li></ul></div>`,
                  tags: ['compensation', 'customer service', 'delay', 'flowchart', 'chefz policy', 'sop'], createdAt: '2024-05-20T10:00:00.000Z', lastModified: '2025-06-22T14:30:00.000Z', version: 1.2, views: 183, comments: [], feedback: [] }
            ]},
            { id: 'partner_care', name: 'Partner Care', icon: 'fas fa-handshake', iconColor: '#2dd4bf', items: [] }, 
            { id: 'logistics', name: 'Logistics', icon: 'fas fa-truck', iconColor: '#4ade80', items: [] }, 
            { id: 'operational_instructions', name: 'Operational Instructions', icon: 'fas fa-clipboard-list', iconColor: '#93c5fd', items: [] }, 
        ]
    };
    
    // --- LOCAL TOPIC/FLOW DATA ---
    // This data is managed locally within this file and is NOT part of the main kbSystemData or Supabase.
    // It's used for the "Flows & Scenarios" tree viewer.
    const localTopicsData = [
      { id: 'compensation', title: 'Scenario: Customer – Compensation', icon: 'fas fa-hand-holding-usd', children: [
          { id: 'flow_for_delays', title: 'Flow for Delays', flowFile: 'flow_for_delays.json' },
          { id: 'missing_items', title: 'Missing Items', flowFile: 'missing_items_flow.json' }
        ]
      },
      { id: 'account_issues', title: 'Scenario: Account Issues', icon: 'fas fa-user-cog', children: [
          { id: 'password_reset', title: 'Password Reset Flow', flowFile: 'password_reset_flow.json' }
        ]
      }
    ];

    const localFlowsStore = {
        'flow_for_delays.json': {
            title: "Flow for Order Delays",
            summary: "Step-by-step process for handling customer contacts regarding delayed orders.",
            steps: [
                { "title": "Step 1: Acknowledge & Verify", "content": "Empathize with the customer's frustration. Ask for the order number to verify the details in the system." },
                { "title": "Step 2: Assess Delay Time", "content": "Check the system for the real-time order status and calculate the delay against the original ETA." },
                { "title": "Step 3: Apply Compensation Matrix", "content": "Refer to the 'Compensation Flow for Delays' knowledge base article to determine the appropriate compensation based on the delay duration and order type." },
                { "title": "Step 4: Communicate & Document", "content": "Clearly inform the customer of the compensation being offered and log a detailed note in the system." }
            ]
        },
        'missing_items.json': {
            title: "Flow for Missing Items",
            summary: "Procedure for when a customer reports missing items from their order.",
            steps: [
                { "title": "Step 1: Apologize & Confirm", "content": "Apologize for the error. Ask the customer to confirm exactly which items are missing from their order." },
                { "title": "Step 2: Check with Partner", "content": "Contact the partner (restaurant) to confirm if the item was missed during packing. Document their response." },
                { "title": "Step 3: Offer Resolution", "content": "Based on policy, offer a refund for the missing item(s) or a credit for a future order. Do not offer redelivery unless explicitly permitted by a supervisor." },
                { "title": "Step 4: Process & Log", "content": "Process the agreed-upon refund/credit and log the incident, including the missing items and resolution provided." }
            ]
        },
        'password_reset_flow.json': {
            title: "Flow for Password Reset",
            summary: "Guiding a customer through resetting their account password.",
            steps: [
                { "title": "Step 1: Identify the User", "content": "Ask for the email address or phone number associated with the account." },
                { "title": "Step 2: Guide to Self-Service", "content": "Instruct the user to click the 'Forgot Password?' link on the login page and follow the on-screen instructions." },
                { "title": "Step 3: Troubleshoot", "content": "If the user is not receiving the reset email, advise them to check their spam/junk folder. Confirm the email on file is correct." }
            ]
        }
    };


    // --- DATA PERSISTENCE ---
    const KB_DATA_KEY = 'infiniBaseData';
    function saveDataToLocalStorage() {
        try { localStorage.setItem(KB_DATA_KEY, JSON.stringify(kbSystemData)); } 
        catch (e) { console.error("Failed to save data to localStorage", e); }
    }
    function loadDataFromLocalStorage() {
        const storedData = localStorage.getItem(KB_DATA_KEY);
        if (storedData) {
            try {
                const parsedData = JSON.parse(storedData);
                if (parsedData.meta && parsedData.sections) { kbSystemData = parsedData; }
            } catch (e) { console.error("Failed to parse data from localStorage, using default.", e); }
        }
    }
    loadDataFromLocalStorage();

    // --- DOM Elements ---
    const sidebar = document.getElementById('sidebar'), mobileSidebarToggle = document.getElementById('mobileSidebarToggle'),
          navigationMenu = document.getElementById('navigationMenu'), currentSectionTitleEl = document.getElementById('currentSectionTitle'),
          breadcrumbsContainer = document.getElementById('breadcrumbs'), pageContentArea = document.getElementById('pageContentArea'),
          dashboardOverviewContainer = document.getElementById('dashboardOverviewContainer'),
          standardSectionContentPlaceholder = document.getElementById('standardSectionContentPlaceholder'),
          itemDetailViewPlaceholder = document.getElementById('itemDetailViewPlaceholder'),
          userNameDisplayHeader = document.getElementById('userNameDisplayHeader'), userAvatar = document.getElementById('userAvatar'),
          currentUserRoleSpan = document.getElementById('currentUserRoleSpan'), addContentModalOverlay = document.getElementById('addContentModalOverlay'),
          closeAddContentModalBtn = document.getElementById('closeAddContentModalBtn'), addContentForm = document.getElementById('addContentForm'),
          templateSelectionContainer = document.getElementById('templateSelectionContainer'),
          cancelAddContentBtn = document.getElementById('cancelAddContentBtn'), contentTypeSelect = document.getElementById('contentType'),
          contentUrlContainer = document.getElementById('contentUrlContainer'),
          contentDetailContainer = document.getElementById('contentDetailContainer'),
          contentDetailLabel = document.getElementById('contentDetailLabel'), contentTagsInput = document.getElementById('contentTags'),
          editingItemIdInput = document.getElementById('editingItemId'), globalSearchInput = document.getElementById('globalSearchInput'),
          searchResultsContainer = document.getElementById('searchResultsContainer'), logoutButton = document.getElementById('logoutButton'),
          logoutConfirmModalOverlay = document.getElementById('logoutConfirmModalOverlay'),
          closeLogoutConfirmModalBtn = document.getElementById('closeLogoutConfirmModalBtn'),
          confirmLogoutBtn = document.getElementById('confirmLogoutBtn'), cancelLogoutBtn = document.getElementById('cancelLogoutBtn'),
          deleteConfirmModalOverlay = document.getElementById('deleteConfirmModalOverlay'),
          closeDeleteConfirmModalBtn = document.getElementById('closeDeleteConfirmModalBtn'),
          confirmDeleteItemBtn = document.getElementById('confirmDeleteItemBtn'),
          cancelDeleteItemBtn = document.getElementById('cancelDeleteItemBtn'),
          deleteConfirmMessage = document.getElementById('deleteConfirmMessage');

    let mainQuillEditor, currentUser = null, currentOpenItem = null, visitorsChartInstance; 

    // --- Utility Functions ---
    const escapeHTML = (str) => { const el = document.createElement('div'); el.textContent = str; return el.innerHTML; };
    const stripHtml = (html) => { const tmp = document.createElement("DIV"); tmp.innerHTML = html; return tmp.textContent || tmp.innerText || ""; };
    const truncateText = (text, len) => (!text || text.length <= len) ? text : text.substring(0, len) + '...';
    
    function showToast(message, type = 'info', duration = 3000) {
        const toastContainer = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast-notification toast-${type}`;
        const iconClass = type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-times-circle' : 'fa-info-circle';
        toast.innerHTML = `<i class="toast-icon fas ${iconClass}"></i> <span>${escapeHTML(message)}</span>`;
        toastContainer.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, duration);
    }
    
    window.copyScriptToClipboard = (btnElement) => {
        const textToCopy = btnElement.previousElementSibling.textContent.trim();
        navigator.clipboard.writeText(textToCopy).then(() => {
            showToast('Message copied!', 'success');
            const originalText = btnElement.textContent;
            btnElement.textContent = 'Copied!';
            setTimeout(() => { btnElement.textContent = originalText; }, 2000);
        }).catch(err => showToast('Failed to copy message.', 'error'));
    };
    
    // --- Activity Logging ---
    async function logActivity(itemId, itemType, action = 'view') {
        if (!currentUser || !currentUser.id || !itemId || !itemType) return;

        const { data: recentLogs, error: logError } = await supabase.from('activity_log').select('timestamp')
            .eq('user_id', currentUser.id).eq('item_id', itemId).eq('item_type', itemType)
            .eq('action', action).order('timestamp', { ascending: false }).limit(1);

        if (logError) { console.error('Error fetching activity log:', logError); return; }

        const alreadyLoggedRecently = recentLogs.length > 0 && (Date.now() - new Date(recentLogs[0].timestamp).getTime()) < 60 * 60 * 1000;

        if (!alreadyLoggedRecently) {
            const { error: insertError } = await supabase.from('activity_log').insert({
                user_id: currentUser.id, item_id: itemId, item_type: itemType, action: action, details: {}
            });
            if (insertError) console.error('Error inserting activity log:', insertError);
            else console.log(`Activity logged: user ${currentUser.id} '${action}' on ${itemType} '${itemId}'.`);
        }
    }

    // --- Sidebar and Navigation ---
    function populateSidebar() {
        let menuHTML = '';
        const mainSections = ['home'];
        const knowledgeAreas = ['support', 'partner_care', 'logistics'];
        const resourcesPolicies = ['operational_instructions'];

        const createLinks = (sectionIds) => {
            kbSystemData.sections.filter(s => sectionIds.includes(s.id)).forEach(section => {
                menuHTML += `<a href="#${section.id}" class="sidebar-link" data-section="${section.id}">
                    <i class="${section.icon || 'fas fa-file-alt'}" style="color:${section.iconColor || 'inherit'}"></i>${escapeHTML(section.name)}
                </a>`;
            });
        };
        
        menuHTML += `<div class="sidebar-section-title">MAIN</div>`;
        createLinks(mainSections);
        
        menuHTML += `<div class="sidebar-section-title">Flows & Scenarios</div>`;
        menuHTML += `<div id="topicTreeContainer" class="sidebar-topic-tree"></div>`;

        menuHTML += `<div class="sidebar-section-title">KNOWLEDGE AREAS</div>`;
        createLinks(knowledgeAreas);

        menuHTML += `<div class="sidebar-section-title">RESOURCES & POLICIES</div>`;
        createLinks(resourcesPolicies);

        navigationMenu.innerHTML = menuHTML;
        populateTopicsTree();
    }

    function populateTopicsTree() {
        const container = document.getElementById('topicTreeContainer');
        if (!container) return;
        let treeHTML = '';
        localTopicsData.forEach(topic => {
            treeHTML += `
                <details data-topic-id="${topic.id}">
                    <summary>
                        <i class="fas fa-chevron-right"></i>
                        <i class="${topic.icon} fa-fw" style="margin-right: 0.75rem;"></i>
                        <span>${escapeHTML(topic.title)}</span>
                    </summary>
                    <div class="subtopic-list">
                        ${topic.children.map(subtopic => `
                            <a href="#topic/${subtopic.id}" class="subtopic-link" data-flow-file="${subtopic.flowFile}">${escapeHTML(subtopic.title)}</a>
                        `).join('')}
                    </div>
                </details>
            `;
        });
        container.innerHTML = treeHTML;
    }

    function highlightSidebarLink(sectionId, subtopicId = null) {
        document.querySelectorAll('.sidebar-link, .subtopic-link').forEach(l => l.classList.remove('active'));
        if (sectionId === 'topic' && subtopicId) {
            const activeLink = document.querySelector(`.subtopic-link[href="#topic/${subtopicId}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
                const detailsElement = activeLink.closest('details');
                if (detailsElement) detailsElement.open = true;
            }
        } else {
            const activeLink = document.querySelector(`.sidebar-link[data-section="${sectionId}"]`);
            if (activeLink) activeLink.classList.add('active');
        }
    }
    
    async function renderMermaidDiagramsInElement(element) {
        const mermaidElements = element.querySelectorAll('pre.mermaid');
        if (mermaidElements.length > 0) {
            try {
                await mermaid.run({ nodes: mermaidElements, suppressErrors: false });
                element.dataset.mermaidRendered = 'true';
            } catch (error) { console.error("Mermaid rendering error:", error); }
        }
    }


    // --- Content Display ---
    function renderItemCard(item, sectionData) {
        const itemIconMap = { article: 'fa-newspaper', case: 'fa-briefcase', form_sheet: 'fa-file-invoice', design: 'fa-palette', guide: 'fa-book-open', policy: 'fa-gavel' };
        const itemIconClass = `fas ${itemIconMap[item.type] || 'fa-file-alt'}`;
        const isAdmin = currentUser?.role === 'admin';

        const tagsHTML = item.tags?.length ? `<div class="card-tags">${item.tags.map(tag => `<span class="tag">${escapeHTML(tag)}</span>`).join('')}</div>` : '';
        const lastModified = new Date(item.lastModified || item.createdAt);
        const updatedBadgeHTML = (lastModified.getTime() > new Date(item.createdAt).getTime() + 60000) ? `<div class="updated-badge">Updated</div>` : '';

        return `
            <div class="card" data-item-id="${item.id}" data-section-id="${sectionData.id}">
                <div class="card-header-icon">
                    <div class="card-icon-container"><i class="${itemIconClass}"></i></div>
                    <div class="card-title-group">
                        <h3>${escapeHTML(item.title)}</h3>
                        ${updatedBadgeHTML}
                    </div>
                </div>
                ${tagsHTML}
                <p>${escapeHTML(truncateText(stripHtml(item.summary), 120))}</p>
                <div class="card-actions">
                    <a href="#${sectionData.id}/${item.id}" class="button button-secondary"><i class="fas fa-eye"></i> View</a>
                    ${isAdmin ? `<button class="button button-secondary" onclick="event.stopPropagation(); window.openEditModal('${sectionData.id}', '${item.id}')"><i class="fas fa-edit"></i> Edit</button>` : ''}
                    ${isAdmin ? `<button class="button button-danger" onclick="event.stopPropagation(); window.openDeleteModal('${sectionData.id}', '${item.id}', '${escapeHTML(item.title)}')"><i class="fas fa-trash-alt"></i></button>` : ''}
                </div>
            </div>`;
    }

    async function getChartData() {
        // MOCK DATA: In a real scenario, this would be an async call to Supabase to aggregate activity_log data.
        // For this demo, we return static data to ensure the chart always renders.
        console.log("Fetching chart data (mock)...");
        return {
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
            datasets: [
                { label: 'Views', data: [65, 59, 80, 81, 56, 55, 40], backgroundColor: 'rgba(99, 102, 241, 0.7)'},
                { label: 'Comments', data: [5, 2, 8, 3, 7, 4, 2], backgroundColor: 'rgba(34, 197, 94, 0.7)'}
            ]
        };
    }

    async function displayDashboard() {
        dashboardOverviewContainer.classList.remove('hidden');
        standardSectionContentPlaceholder.classList.add('hidden');
        itemDetailViewPlaceholder.classList.add('hidden');
        currentSectionTitleEl.textContent = 'Dashboard';
        breadcrumbsContainer.innerHTML = `<span style="font-weight: bold; color: var(--primary-color);">Home</span>`;

        if (currentUser?.role !== 'admin') {
            dashboardOverviewContainer.innerHTML = `<div class="viewer-dashboard-message"><div class="card"><i class="fas fa-user-shield"></i><h2>Access Restricted</h2><p>The dashboard is for administrators only.</p></div></div>`;
            return;
        }

        const allItems = kbSystemData.sections.flatMap(s => s.items || []);
        const totalArticles = allItems.filter(i => ['article', 'guide', 'policy'].includes(i.type)).length;
        const chartData = await getChartData(); // Fetch chart data

        dashboardOverviewContainer.innerHTML = `
            <div class="card" style="background: linear-gradient(to right, var(--primary-color), #4c1d95); color: white; min-height: auto;">
                <h2 style="font-size: 1.75rem; margin-bottom: 4px;">Welcome back, ${escapeHTML(currentUser.name || 'Admin')}!</h2>
            </div>
            <div class="cards-grid md:grid-cols-2 lg:grid-cols-4 my-6">
                <div class="dashboard-stat-card"><i class="fas fa-folder-open"></i><span class="stat-value">${kbSystemData.sections.length}</span><span class="stat-label">Total Sections</span></div>
                <div class="dashboard-stat-card"><i class="fas fa-newspaper"></i><span class="stat-value">${totalArticles}</span><span class="stat-label">Total Articles</span></div>
                <div class="dashboard-stat-card"><i class="fas fa-eye"></i><span class="stat-value">${chartData.datasets[0].data.reduce((a,b) => a+b, 0)}</span><span class="stat-label">Views This Week</span></div>
                <div class="dashboard-stat-card"><i class="fas fa-comments"></i><span class="stat-value">${chartData.datasets[1].data.reduce((a,b) => a+b, 0)}</span><span class="stat-label">Comments This Week</span></div>
            </div>
            <div class="card chart-container" style="height: 350px;">
                <h3>Content Activity (Mock Data)</h3>
                <canvas id="visitorsChart"></canvas>
            </div>`;
        
        const visitorsCtx = document.getElementById('visitorsChart')?.getContext('2d');
        if (visitorsCtx) {
            if (visitorsChartInstance) visitorsChartInstance.destroy();
            visitorsChartInstance = new Chart(visitorsCtx, { type: 'bar', data: chartData, options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { labels: { color: 'var(--text-color)' } } },
                scales: { y: { ticks: { color: 'var(--text-color-muted)' }, grid: { color: 'var(--border-color)' } },
                          x: { ticks: { color: 'var(--text-color-muted)' }, grid: { color: 'var(--border-color)' } } }
            }});
        }
    }
    
    function displaySectionContent(sectionId) {
        currentOpenItem = null;
        dashboardOverviewContainer.classList.add('hidden');
        itemDetailViewPlaceholder.classList.add('hidden');
        standardSectionContentPlaceholder.classList.remove('hidden');

        const sectionData = kbSystemData.sections.find(s => s.id === sectionId);
        if (!sectionData) {
            standardSectionContentPlaceholder.innerHTML = `<div class="card"><h2>Section not found</h2></div>`;
            return;
        }

        currentSectionTitleEl.textContent = sectionData.name;
        breadcrumbsContainer.innerHTML = `<a href="#home">Home</a> <span style="margin: 0 5px;">›</span> <span style="font-weight: bold; color: var(--primary-color);">${escapeHTML(sectionData.name)}</span>`;
        
        const itemsToDisplay = (sectionData.items || []).filter(item => !item.parentId);
        let contentHTML = `
            ${(currentUser?.role === 'admin' && sectionId !== 'home') ? `<div style="text-align: right; margin-bottom: 1.5rem;"><button id="openAddContentBtnInSection" class="button" data-section-id="${sectionData.id}"><i class="fas fa-plus-circle"></i> Add Content</button></div>` : ''}
            ${itemsToDisplay.length > 0 ? `<div class="cards-grid">${itemsToDisplay.map(item => renderItemCard(item, sectionData)).join('')}</div>` : `<div class="card" style="text-align: center;"><p>No content in this section yet.</p></div>`}
        `;
        standardSectionContentPlaceholder.innerHTML = contentHTML;

        document.getElementById('openAddContentBtnInSection')?.addEventListener('click', (e) => {
            openAddContentModal(e.currentTarget.dataset.sectionId);
        });
    }
    
    async function displayItemDetail(sectionId, itemId) {
        const sectionData = kbSystemData.sections.find(s => s.id === sectionId);
        const itemData = sectionData?.items?.find(i => i.id === itemId);

        if (!itemData) {
            displaySectionContent(sectionId); // Fallback to section view
            return;
        }

        logActivity(itemData.id, itemData.type, 'view');

        currentOpenItem = { sectionId, itemId, title: itemData.title };
        dashboardOverviewContainer.classList.add('hidden');
        standardSectionContentPlaceholder.classList.add('hidden');
        itemDetailViewPlaceholder.classList.remove('hidden');

        currentSectionTitleEl.textContent = itemData.title;
        breadcrumbsContainer.innerHTML = `<a href="#home">Home</a><span class="mx-2">›</span><a href="#${sectionData.id}">${escapeHTML(sectionData.name)}</a><span class="mx-2">›</span><span class="font-bold">${escapeHTML(truncateText(itemData.title, 30))}</span>`;
        
        const itemIconClass = `fas ${ { article: 'fa-newspaper', case: 'fa-briefcase', policy: 'fa-gavel' }[itemData.type] || 'fa-file-alt' }`;
        const lastModified = new Date(itemData.lastModified || itemData.createdAt);
        const lastUpdatedHTML = (lastModified.getTime() > new Date(itemData.createdAt).getTime() + 60000) 
            ? `<div class="last-updated-info">Updated on: ${lastModified.toLocaleDateString()}</div>` : '';

        itemDetailViewPlaceholder.innerHTML = `
            <div class="item-actions-bar">
                <a href="#${sectionId}" class="button button-secondary"><i class="fas fa-arrow-left"></i> Back to Section</a>
                ${currentUser?.role === 'admin' ? `<button id="editItemBtn" class="button"><i class="fas fa-edit"></i> Edit</button><button id="deleteItemBtn" class="button button-danger"><i class="fas fa-trash-alt"></i> Delete</button>` : ''}
            </div>
            <div class="card">
                <div class="item-title-area">
                    <i class="${itemIconClass} fa-title-icon"></i>
                    <h2>${escapeHTML(itemData.title)}</h2>
                </div>
                <p class="item-summary">${escapeHTML(stripHtml(itemData.summary))}</p>
                <hr class="title-content-divider">
                ${lastUpdatedHTML}
                <div class="kb-content">${itemData.content || '<p>No content available.</p>'}</div>
            </div>
            <div class="comments-section">
                <h4><i class="fas fa-comments"></i> Management Notes</h4>
                <div class="comment-post-area">
                    <img src="${currentUser.avatar_url}" alt="Avatar">
                    <div class="comment-input-wrapper">
                        <textarea id="newCommentText" placeholder="Add an internal note..."></textarea>
                        <div class="comment-post-actions"><button id="postCommentBtn" class="button">Post Note</button></div>
                    </div>
                </div>
                <div class="comment-display-area" id="commentDisplayAreaForItem"></div>
            </div>
        `;
        
        setupItemDetailEventListeners(itemData, sectionId);
    }
    
    function displayLocalFlow(flowId) {
        const flowFile = localTopicsData.flatMap(t => t.children).find(st => st.id === flowId)?.flowFile;
        const flowData = localFlowsStore[flowFile];
        if (!flowData) { displayDashboard(); return; }

        dashboardOverviewContainer.classList.add('hidden');
        standardSectionContentPlaceholder.classList.add('hidden');
        itemDetailViewPlaceholder.classList.remove('hidden');

        currentSectionTitleEl.textContent = flowData.title;
        breadcrumbsContainer.innerHTML = `<a href="#home">Home</a><span class="mx-2">›</span><span style="font-weight: bold;">${escapeHTML(flowData.title)}</span>`;

        let flowHTML = `<div class="card">
            <div class="item-title-area">
                <i class="fas fa-project-diagram fa-title-icon"></i>
                <h2>${escapeHTML(flowData.title)}</h2>
            </div>
            <p class="item-summary">${escapeHTML(flowData.summary)}</p>
            <hr class="title-content-divider">
            <div class="kb-content">
                ${flowData.steps.map(step => `
                    <div class="content-section-box">
                        <h3>${escapeHTML(step.title)}</h3>
                        <p>${escapeHTML(step.content)}</p>
                    </div>
                `).join('')}
            </div>
        </div>`;
        itemDetailViewPlaceholder.innerHTML = flowHTML;
    }


    function setupItemDetailEventListeners(itemData, sectionId) {
        renderComments(itemData);
        if (itemDetailViewPlaceholder.querySelector('pre.mermaid')) {
            renderMermaidDiagramsInElement(itemDetailViewPlaceholder);
        }

        document.getElementById('editItemBtn')?.addEventListener('click', () => openAddContentModal(sectionId, itemData));
        document.getElementById('deleteItemBtn')?.addEventListener('click', () => openDeleteConfirmModal(sectionId, itemData.id, itemData.title));
        
        document.getElementById('postCommentBtn').addEventListener('click', () => {
            const commentText = document.getElementById('newCommentText').value.trim();
            if (!commentText) { showToast('Please enter a note.', 'error'); return; }
            if (!itemData.comments) itemData.comments = [];
            itemData.comments.push({
                id: `cmt_${Date.now()}`, authorId: currentUser.id, authorName: currentUser.name, text: commentText, timestamp: new Date().toISOString()
            });
            saveDataToLocalStorage();
            renderComments(itemData);
            document.getElementById('newCommentText').value = ''; 
        });
    }
    
    function renderComments(itemData) {
        const container = document.getElementById('commentDisplayAreaForItem');
        if (!container) return;
        if (!itemData.comments?.length) {
            container.innerHTML = `<p style="text-align:center; color: var(--text-color-muted);">No notes yet.</p>`;
            return;
        }
        container.innerHTML = [...itemData.comments].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)).map(comment => `
            <div class="comment" data-comment-id="${comment.id}">
                <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(comment.authorName || 'A')}" alt="avatar">
                <div class="comment-content">
                    <div class="comment-header">
                        <span class="comment-author">${escapeHTML(comment.authorName)}</span>
                        <span class="comment-timestamp">${new Date(comment.timestamp).toLocaleString()}</span>
                    </div>
                    <div class="comment-text">${escapeHTML(comment.text).replace(/\n/g, '<br>')}</div>
                </div>
            </div>`).join('');
    }

    // --- Add/Edit Modal & Quill Logic ---
    function imageHandler() {
        const url = prompt('Enter image URL:');
        if (url) {
            const range = mainQuillEditor.getSelection(true);
            const htmlToInsert = `
                <figure>
                    <img src="${escapeHTML(url)}" style="max-width: 400px; border-radius: 8px;" alt="User-inserted image" />
                    <figcaption>${escapeHTML(prompt('Enter optional caption:')) || 'Image'}</figcaption>
                </figure>
                <p><br></p>`; // Add a newline after the figure
            mainQuillEditor.clipboard.dangerouslyPasteHTML(range.index, htmlToInsert, 'user');
        }
    }

    function openAddContentModal(sectionId, itemToEdit = null) {
        addContentForm.reset();
        addContentForm.dataset.sectionId = sectionId;
        editingItemIdInput.value = ""; 
        
        if (!mainQuillEditor) {
            mainQuillEditor = new Quill('#quillEditor', { 
                theme: 'snow',
                modules: { toolbar: { 
                    container: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline', 'strike'], ['link', 'image', 'blockquote', 'code-block'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }], ['clean']
                    ],
                    handlers: { 'image': imageHandler }
                }},
                placeholder: 'Enter content...'
            });
        }

        if (itemToEdit) { // Editing
            document.getElementById('addContentModalTitle').textContent = 'Edit Content';
            editingItemIdInput.value = itemToEdit.id; 
            document.getElementById('contentTitle').value = itemToEdit.title;
            document.getElementById('contentSummary').value = itemToEdit.summary;
            contentTypeSelect.value = itemToEdit.type;
            const contentToEdit = itemToEdit.content || '<p><br></p>';
            mainQuillEditor.root.innerHTML = contentToEdit;
            contentTagsInput.value = (itemToEdit.tags || []).join(', ');
            templateSelectionContainer.classList.add('hidden');
            addContentForm.classList.remove('hidden');
        } else { // Creating
            document.getElementById('addContentModalTitle').textContent = 'Add New Content';
            mainQuillEditor.setText('');
            templateSelectionContainer.classList.remove('hidden');
            addContentForm.classList.add('hidden');
        }
        
        addContentModalOverlay.classList.remove('hidden');
    }

    addContentForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const sectionId = addContentForm.dataset.sectionId;
        const section = kbSystemData.sections.find(s => s.id === sectionId);
        if (!section) { showToast('Error: Section not found!', 'error'); return; }
        
        const editingId = editingItemIdInput.value;
        const itemData = {
            type: contentTypeSelect.value, title: document.getElementById('contentTitle').value.trim(),
            summary: document.getElementById('contentSummary').value.trim(), tags: contentTagsInput.value.split(',').map(t => t.trim()).filter(Boolean),
            content: mainQuillEditor.root.innerHTML, lastModified: new Date().toISOString()
        };
        if (!itemData.title || !itemData.summary) { showToast('Title and Summary are required.', 'error'); return; }

        if (editingId) { // Update
            const itemIndex = section.items.findIndex(i => i.id === editingId);
            if (itemIndex > -1) { Object.assign(section.items[itemIndex], itemData); }
        } else { // Create
            if (!section.items) section.items = [];
            section.items.push({ ...itemData, id: `${sectionId}_item_${Date.now()}`, createdAt: new Date().toISOString(), views: 0 });
        }
        
        saveDataToLocalStorage();
        showToast(`Content ${editingId ? 'updated' : 'saved'}!`, 'success');
        closeAddContentModal();
        handleNavigation();
    });

    function closeAddContentModal() { addContentModalOverlay.classList.add('hidden'); }
    window.openEditModal = (sectionId, itemId) => {
        const item = kbSystemData.sections.find(s => s.id === sectionId)?.items.find(i => i.id === itemId);
        if (item) openAddContentModal(sectionId, item);
    };
    
    function openDeleteConfirmModal(sectionId, itemId, itemTitle) {
        deleteConfirmMessage.innerHTML = `Delete "<strong>${escapeHTML(itemTitle)}</strong>"? This cannot be undone.`;
        confirmDeleteItemBtn.dataset.sectionId = sectionId;
        confirmDeleteItemBtn.dataset.itemId = itemId;
        deleteConfirmModalOverlay.classList.remove('hidden');
    }
    window.openDeleteModal = openDeleteConfirmModal;

    confirmDeleteItemBtn.addEventListener('click', () => {
        const { sectionId, itemId } = confirmDeleteItemBtn.dataset;
        const section = kbSystemData.sections.find(s => s.id === sectionId);
        if (section?.items) {
            const itemIndex = section.items.findIndex(item => item.id === itemId);
            if (itemIndex > -1) {
                section.items.splice(itemIndex, 1);
                saveDataToLocalStorage();
                showToast(`Item deleted.`, 'success');
                deleteConfirmModalOverlay.classList.add('hidden');
                window.location.hash = `#${sectionId}`;
            }
        }
    });


    // --- Routing and Initialization ---
    function handleNavigation() {
        if (!currentUser) return;
        const hash = window.location.hash.substring(1) || 'home';
        const [sectionId, itemId] = hash.split('/');
        
        if (sectionId === 'topic') {
            displayLocalFlow(itemId);
            highlightSidebarLink('topic', itemId);
        } else if (sectionId === 'home') {
            displayDashboard();
            highlightSidebarLink('home');
        } else if (itemId) {
            displayItemDetail(sectionId, itemId);
            highlightSidebarLink(sectionId);
        } else if (sectionId) {
            displaySectionContent(sectionId);
            highlightSidebarLink(sectionId);
        } else {
            displayDashboard();
            highlightSidebarLink('home');
        }

        document.getElementById('contentWrapper')?.scrollTo(0,0);
    }

    async function initializeApp() {
        currentUser = await Auth.getCurrentUserProfile(); 
        if (!currentUser) return;

        userNameDisplayHeader.textContent = currentUser.name;
        userAvatar.src = currentUser.avatar_url;
        currentUserRoleSpan.textContent = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
        
        populateSidebar();
        handleNavigation(); 

        window.addEventListener('hashchange', handleNavigation);
        
        // Event Listeners
        mobileSidebarToggle.addEventListener('click', () => sidebar.classList.toggle('closed'));
        logoutButton.addEventListener('click', () => logoutConfirmModalOverlay.classList.remove('hidden'));
        closeLogoutConfirmModalBtn.addEventListener('click', () => logoutConfirmModalOverlay.classList.add('hidden'));
        cancelLogoutBtn.addEventListener('click', () => logoutConfirmModalOverlay.classList.add('hidden'));
        confirmLogoutBtn.addEventListener('click', Auth.logout);
        closeAddContentModalBtn.addEventListener('click', closeAddContentModal);
        cancelAddContentBtn.addEventListener('click', closeAddContentModal);
        closeDeleteConfirmModalBtn.addEventListener('click', () => deleteConfirmModalOverlay.classList.add('hidden'));
        cancelDeleteItemBtn.addEventListener('click', () => deleteConfirmModalOverlay.classList.add('hidden'));
        document.querySelectorAll('.template-button').forEach(b => b.addEventListener('click', () => openAddContentModal(addContentForm.dataset.sectionId, null)));

        if (localStorage.getItem('justLoggedIn') === 'true') {
            showToast(`Welcome back, ${currentUser.name}!`, 'success');
            localStorage.removeItem('justLoggedIn');
        }
    }

    initializeApp();

</script>
</body>
</html>
