<!DOCTYPE html>
<html lang="en" class="dark"> <!-- Default to dark, JS can toggle -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InfiniBase - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <style>
        /* Base Styles */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s ease, color 0.3s ease; }

        .dark body { background-color: #111827; color: #d1d5db; }
        body:not(.dark) { background-color: #f3f4f6; color: #1f2937; }

        /* Sidebar */
        .sidebar { width: 288px; position: fixed; top: 0; left: 0; height: 100vh; padding: 1.5rem; overflow-y: auto; transition: transform 0.3s ease-in-out; z-index: 40; }
        .dark .sidebar { background-color: #0F172A; color: #9ca3af; border-right: 1px solid #1E293B;} /* Slightly different dark */
        body:not(.dark) .sidebar { background-color: #1e293b; color: #d1d5db; border-right: 1px solid #334155;}

        .sidebar-header { font-size: 1.875rem; font-weight: 700; margin-bottom: 2rem; padding-bottom: 1rem; display: flex; align-items: center; color: #ffffff; border-bottom: 1px solid #334155; }
        .sidebar-link { display: flex; align-items: center; padding: 0.75rem; border-radius: 0.5rem; transition: background-color 0.2s ease, color 0.2s ease; font-weight: 500; margin-bottom: 0.25rem; }
        .dark .sidebar-link { color: #9ca3af; } body:not(.dark) .sidebar-link { color: #e5e7eb; }
        .dark .sidebar-link:hover { background-color: #1E293B; color: #ffffff; } body:not(.dark) .sidebar-link:hover { background-color: #334155; color: #ffffff; }
        .sidebar-link.active { font-weight: 600; }
        .dark .sidebar-link.active { background-color: #3b82f6; color: #ffffff; } /* Blue active for dark */
        body:not(.dark) .sidebar-link.active { background-color: #3b82f6; color: #ffffff; } /* Blue active for light */
        .sidebar-link i { margin-right: 0.75rem; width: 1.25rem; text-align: center; }
        .sidebar-section-title { padding-left: 0.75rem; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; margin-top: 1.5rem; margin-bottom: 0.5rem; }
        .dark .sidebar-section-title { color: #6b7280; } body:not(.dark) .sidebar-section-title { color: #a0aec0; }
        .sidebar-bottom-actions { position: absolute; bottom: 1.5rem; left: 1.5rem; right: 1.5rem; space-y: 0.5rem; }

        /* Main Content */
        .content-wrapper { margin-left: 288px; height: 100vh; overflow-y: auto; transition: margin-left 0.3s ease-in-out; }
        .content-header { position: sticky; top: 0; padding: 1rem 1.5rem; md:padding: 1.25rem 2.5rem; margin-bottom: 1.5rem; md:margin-bottom: 2rem; z-index: 30; backdrop-filter: blur(10px); }
        .dark .content-header { background-color: rgba(17, 24, 39, 0.88); border-bottom: 1px solid #374151; }
        body:not(.dark) .content-header { background-color: rgba(249, 250, 251, 0.88); border-bottom: 1px solid #e5e7eb; }
        
        /* Cards */
        .card { border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06); transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .dark .card { background-color: #1f2937; } body:not(.dark) .card { background-color: #ffffff; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); }
        .card-animate { opacity: 0; transform: translateY(20px); animation: fadeInUp 0.5s ease-out forwards; }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }


        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 50; padding: 1rem; backdrop-filter: blur(4px); }
        .modal-content { padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); width: 100%; max-width: 42rem; /* max-w-2xl */ transform: scale(0.95); opacity: 0; transition: transform 0.2s ease-out, opacity 0.2s ease-out; }
        .dark .modal-content { background-color: #1f2937; } body:not(.dark) .modal-content { background-color: #ffffff; }
        .modal-overlay:not(.hidden) .modal-content { transform: scale(1); opacity: 1; }
        .quill-editor-container { height: 180px; margin-bottom: 1rem; border-radius: 0.375rem; overflow: hidden; border: 1px solid; }
        .dark .quill-editor-container { border-color: #4b5563; } body:not(.dark) .quill-editor-container { border-color: #d1d5db; }
        .dark .ql-toolbar { background: #374151; border-bottom: 1px solid #4b5563 !important; } .dark .ql-container { background: #2d3748; color: #d1d5db; border-top: none !important; }
        body:not(.dark) .ql-toolbar { background: #f9fafb; border-bottom: 1px solid #d1d5db !important; } body:not(.dark) .ql-container { background: #ffffff; color: #1f2937; border-top: none !important; }
        .dark .ql-editor .ql-blank::before{ color: rgba(209,213,219,0.4);} body:not(.dark) .ql-editor .ql-blank::before{ color: rgba(107,114,128,0.4);}


        /* Charts */
        .chart-wrapper { height: 300px; /* Fixed height for chart parent */ }
        .chart-container { position: relative; height: 100%; width: 100%; padding: 1rem; border-radius: 0.75rem; }
        .dark .chart-container { background-color: #1f2937; } body:not(.dark) .chart-container { background-color: #ffffff; }

        /* Responsive Sidebar */
        .sidebar-toggle-button { display: none; position: fixed; top: 1rem; left: 1rem; z-index: 60; background-color: #374151; color:white; padding:0.5rem; border-radius:0.375rem; }
        @media (max-width: 1024px) { /* Breakpoint for sidebar to hide */
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .content-wrapper { margin-left: 0; }
            .sidebar-toggle-button { display: block; }
        }
        .hidden { display: none !important; }
        input:focus, button:focus, select:focus, textarea:focus, a:focus { outline: 2px solid transparent; outline-offset: 2px; box-shadow: 0 0 0 2px #3b82f6; }
        .dark input:focus, .dark button:focus, .dark select:focus, .dark textarea:focus, .dark a:focus { box-shadow: 0 0 0 2px #60a5fa; }
        mark { padding: 0.1em 0.2em; border-radius: 0.2em; font-weight: bold; }
        .dark mark { background-color: #b45309; color: #fef3c7; } body:not(.dark) mark { background-color: #fef9c3; color: #713f12; }
    </style>
</head>
<body>
    <!-- Add Item/Case Modal -->
    <div id="addItemModalOverlay" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 id="modalTitle" class="text-2xl font-bold">Add New Item</h2>
                <button id="closeAddItemModalBtn" class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="addItemForm">
                <input type="hidden" id="currentItemType" value="case"> <!-- Default or set by button -->
                <input type="hidden" id="currentSectionIdForModal" value="">

                <div class="mb-4">
                    <label for="itemTypeSelect" class="block text-sm font-medium mb-1">Item Type</label>
                    <select id="itemTypeSelect" class="p-2.5 w-full border rounded-md bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600">
                        <option value="case">Case</option>
                        <option value="article">Article</option>
                        <option value="form_template">Form/Template Link</option>
                        <option value="video_link">Video Link</option>
                        <option value="design_link">Design Link</option>
                        <!-- Add other types as needed -->
                    </select>
                </div>

                <div class="mb-4">
                    <label for="itemTitle" class="block text-sm font-medium mb-1">Title</label>
                    <input type="text" id="itemTitle" class="p-2.5 w-full border rounded-md bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600" required>
                </div>
                <div class="mb-4">
                    <label for="itemSummary" class="block text-sm font-medium mb-1">Summary / Description</label>
                    <textarea id="itemSummary" class="p-2.5 w-full border rounded-md bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600" rows="3" required></textarea>
                </div>
                
                <!-- Fields specific to item type will be shown/hidden by JS -->
                <div id="quillFieldContainer" class="mb-6 hidden"> <!-- For Case, Article -->
                    <label class="block text-sm font-medium mb-1">Details / Content</label>
                    <div id="itemQuillEditor" class="quill-editor-container"></div>
                </div>
                <div id="urlFieldContainer" class="mb-4 hidden"> <!-- For Form, Video, Design Link -->
                     <label for="itemUrl" class="block text-sm font-medium mb-1">URL / Link</label>
                    <input type="url" id="itemUrl" class="p-2.5 w-full border rounded-md bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600" placeholder="https://example.com/document.pdf">
                </div>
                <div id="tagsFieldContainer" class="mb-4">
                     <label for="itemTags" class="block text-sm font-medium mb-1">Tags (comma-separated)</label>
                    <input type="text" id="itemTags" class="p-2.5 w-full border rounded-md bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600" placeholder="tag1, another tag, help">
                </div>


                <div class="flex justify-end gap-3 pt-4 border-t border-gray-200 dark:border-gray-700 mt-6">
                    <button type="button" id="cancelAddItemBtn" class="px-4 py-2 border rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">Cancel</button>
                    <button type="submit" id="saveAddItemBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Save Item</button>
                </div>
            </form>
        </div>
    </div>

    <div class="flex h-screen">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header"><i class="fas fa-database mr-3 text-indigo-400"></i> InfiniBase</div>
            <nav id="navigationMenu" class="space-y-1">
                <div class="sidebar-section-title">Main</div>
                <a href="#" class="sidebar-link" data-section="home"><i class="fas fa-home"></i>Home</a>
                <div class="sidebar-section-title">Knowledge Areas</div>
                <!-- Links will be populated by JS from kbSystemData.meta.sections -->
            </nav>
            <div class="sidebar-bottom-actions">
                 <button id="openAddItemModalBtnGeneral" class="w-full flex items-center justify-center py-2.5 px-4 text-sm font-medium rounded-lg transition bg-indigo-600 hover:bg-indigo-700 text-white mb-2">
                    <i class="fas fa-plus-circle mr-2"></i> Add New Item
                </button>
                <button id="themeSwitcher" class="w-full flex items-center justify-center py-2.5 px-4 text-sm font-medium rounded-lg transition border border-gray-600 dark:border-gray-500 hover:bg-gray-700 dark:hover:bg-gray-600">
                    <i id="themeIcon" class="fas fa-moon mr-2"></i> <span id="themeText">Dark Mode</span>
                </button>
                <button id="logoutButton" class="w-full mt-2 flex items-center justify-center py-2.5 px-4 text-sm font-medium rounded-lg transition bg-red-600 hover:bg-red-700 text-white">
                    <i class="fas fa-sign-out-alt mr-2"></i> Logout
                </button>
            </div>
        </aside>

        <button id="mobileSidebarToggle" class="sidebar-toggle-button"> <i class="fas fa-bars text-xl"></i> </button>

        <div class="content-wrapper" id="contentWrapper">
            <header class="content-header">
                <div class="flex justify-between items-center w-full">
                    <div class="flex items-center">
                        <button id="mobileSidebarToggleHeader" class="sidebar-toggle-button !static !block lg:!hidden mr-3 p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700"> <i class="fas fa-bars text-xl"></i> </button>
                        <div>
                           <h1 id="currentSectionTitle" class="text-xl sm:text-2xl md:text-3xl font-bold">Welcome</h1>
                           <div id="breadcrumbs" class="text-xs sm:text-sm mt-0.5 text-gray-500 dark:text-gray-400">Home</div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3 md:space-x-4">
                        <div class="relative">
                            <input type="search" id="globalSearchInput" placeholder="Search KB..." class="py-2 pl-10 pr-3 w-48 sm:w-64 md:w-80 border rounded-full bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3"><i class="fas fa-search text-gray-400"></i></span>
                            <div id="searchResultsContainer" class="hidden absolute mt-1 w-full max-h-80 overflow-y-auto rounded-md shadow-lg bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 z-10"></div>
                        </div>
                        <div id="userProfileContainer" class="flex items-center space-x-2">
                            <img id="userAvatar" src="https://ui-avatars.com/api/?name=U&size=32&background=4f46e5&color=fff&rounded=true" alt="User" class="w-8 h-8 rounded-full">
                            <span id="userNameDisplayHeader" class="font-medium hidden sm:block">User</span>
                        </div>
                    </div>
                </div>
            </header>

            <main class="p-4 md:p-6 lg:p-8" id="pageContentArea">
                 <div id="dashboardOverviewContainer" class="hidden space-y-6">
                    <div class="card bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-500 text-white">
                        <h2 class="text-2xl md:text-3xl font-bold mb-1" id="welcomeUserNameDashboard">Welcome!</h2>
                        <p class="text-indigo-100 text-sm md:text-base">Knowledge base activity overview.</p>
                        <p class="text-xs text-indigo-200 mt-2">InfiniBase v<span id="kbVersionDashboard"></span> | Last Update: <span id="lastKbUpdateDashboard"></span></p>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="card chart-wrapper"><h3 class="text-lg font-semibold mb-3 text-center">User Views (Sample)</h3><canvas id="usersChart"></canvas></div>
                            <div class="card chart-wrapper"><h3 class="text-lg font-semibold mb-3 text-center">Content Type Views (Sample)</h3><canvas id="casesChart"></canvas></div>
                        </div>
                        <div class="card">
                            <h3 class="text-lg font-semibold mb-3">Recent Activity</h3>
                            <ul id="recentActivityList" class="space-y-2 text-sm max-h-80 overflow-y-auto">
                                <li class="text-gray-500 dark:text-gray-400">Loading activity...</li>
                            </ul>
                        </div>
                    </div>
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4">Filter Activity Data</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                            <div><label for="filterDate" class="block text-sm font-medium mb-1">Date</label><input type="date" id="filterDate" class="p-2 w-full border rounded-md bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600"></div>
                            <div><label for="filterUser" class="block text-sm font-medium mb-1">User</label><select id="filterUser" class="p-2 w-full border rounded-md bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600"><option value="">All Users</option></select></div>
                            <div><label for="filterInteraction" class="block text-sm font-medium mb-1">Interaction</label><select id="filterInteraction" class="p-2 w-full border rounded-md bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600"><option value="">All</option><option value="article_view">Article View</option><option value="case_created">Case Created</option></select></div>
                            <button id="applyFilterBtn" class="px-4 py-2.5 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 h-10">Apply</button>
                        </div>
                    </div>
                </div>
                <div id="standardSectionContentPlaceholder" class="space-y-8"></div>
                 <div id="sectionAddItemBtnContainer" class="mt-8 hidden">
                    <button id="openAddItemModalForSectionBtn" class="flex items-center justify-center py-2.5 px-5 text-sm font-medium rounded-lg transition bg-green-600 hover:bg-green-700 text-white">
                        <i class="fas fa-plus-circle mr-2"></i> Add Item to This Section
                    </button>
                </div>
            </main>

            <footer class="mt-auto p-6 text-center text-xs sm:text-sm text-gray-500 dark:text-gray-400 border-t border-gray-200 dark:border-gray-700">
                <span>© <script>document.write(new Date().getFullYear())</script> InfiniBase. v<span id="footerKbVersion"></span></span>
                <button id="reportErrorBtn" class="ml-2 md:ml-4 text-xs text-red-500 hover:underline">Report Issue</button>
            </footer>
        </div>
    </div>

    <script type="module">
        // --- START SIMULATED MODULES (Replace with actual for production) ---
        const supabase = {
            from: (table) => ({
                select: async (columns = '*') => {
                    console.log(`Simulated Supabase: SELECT ${columns} FROM ${table}`);
                    await new Promise(r => setTimeout(r, 200)); // Simulate delay
                    if (table === 'views_log') return { data: [ {user_identifier: "user1@sim.com", item_type:"article_view", item_id:"sup001", viewed_at: new Date().toISOString()}, {user_identifier: "user2@sim.com", item_type:"case_created", item_id:"caseSim1", viewed_at: new Date(Date.now()-86400000).toISOString()} ], error: null };
                    if (table === 'cases') return { data: [], error: null };
                    return { data: [], error: null };
                },
                insert: async (records) => {
                    console.log(`Simulated Supabase: INSERT INTO ${table}`, records);
                    await new Promise(r => setTimeout(r, 100));
                    const newId = `sim_${table}_${Math.floor(Math.random() * 10000)}`;
                    return { data: [{ id: newId, ...records[0] }], error: null };
                },
                rpc: async (fnName, params) => {
                    if (fnName === 'get_distinct_viewers') {
                         return { data: [{ user_identifier: "user1@sim.com" }, { user_identifier: "user2@sim.com" }, {user_identifier: "demo@sim.com"}], error: null };
                    }
                    return {data: null, error: {message: "RPC not found"}};
                }
            })
        };
        const Auth = {
            isAuthenticated: () => true,
            getCurrentUser: () => ({ email: "demouser@example.com", fullName: "Demo User", role: "admin" }), // Roles: viewer, editor, admin
            logout: () => { alert("Simulated Logout"); window.location.hash = "home"; window.location.reload(); },
            protectPage: () => { if (!Auth.isAuthenticated()) { alert("Not Authorized (Simulated)"); throw "Stop Execution"; } }
        };
        const kbSystemData = { /* --- PASTE YOUR FULL kbSystemData HERE --- */
            meta: { version: "0.2.0", lastGlobalUpdate: "2024-01-15T10:00:00Z" },
            sections: [
                { id: "support", name: "Support", icon: "fas fa-headset", themeColor: "blue", description: "Customer and technical support resources.", articles: [{id:"sup001",title:"P1 Ticket Handling",summary:"Guide for P1s.",tags:["critical","p1"],contentPath:"#"}, {id:"sup002",title:"Zendesk Guide",summary:"Using Zendesk.",tags:["tool"],contentPath:"#"}], cases: [{id:"case001",title:"Alpha Outage",summary:"User Alpha disconnected.",status:"Open",tags:["outage"], resolutionStepsPreview:"Check logs."}], items:[], subCategories: [{id:"tools", name:"Support Tools"},{id:"procedures",name:"Procedures"}] },
                { id: "partner_care", name: "Partner Care", icon: "fas fa-handshake", themeColor: "teal", description: "Partner onboarding and management.", articles: [{id:"pc001", title:"New Partner Checklist", summary:"Onboarding steps.", contentPath:"#"}], items:[], cases:[]},
                { id: "forms_templates", name: "Forms/Templates", icon: "fas fa-file-alt", themeColor: "purple", description: "Centralized forms and templates.", items: [{id:"form001", title:"Incident Report", type:"form_template", url:"#", description:"Standard incident form."}], articles:[], cases:[]},
                // Add other sections as needed for testing
            ]
        };
        // --- END SIMULATED MODULES ---

        // --- START APP LOGIC ---
        let itemQuillEditor;
        let usersChartInstance, casesChartInstance; // Chart instances
        const TABLES = { CASES: 'cases', ITEMS: 'kb_items', VIEWS_LOG: 'views_log' }; // Assuming a generic items table

        // DOM Elements
        const sidebar = document.getElementById('sidebar');
        const navigationMenu = document.getElementById('navigationMenu');
        const mobileSidebarToggle = document.getElementById('mobileSidebarToggle');
        const mobileSidebarToggleHeader = document.getElementById('mobileSidebarToggleHeader');
        
        const pageContentArea = document.getElementById('pageContentArea');
        const dashboardOverviewContainer = document.getElementById('dashboardOverviewContainer');
        const standardSectionContentPlaceholder = document.getElementById('standardSectionContentPlaceholder');
        const sectionAddItemBtnContainer = document.getElementById('sectionAddItemBtnContainer');
        const openAddItemModalForSectionBtn = document.getElementById('openAddItemModalForSectionBtn');


        const currentSectionTitleEl = document.getElementById('currentSectionTitle');
        const breadcrumbsContainer = document.getElementById('breadcrumbs');
        
        const userNameDisplayHeader = document.getElementById('userNameDisplayHeader');
        const userAvatar = document.getElementById('userAvatar');
        const welcomeUserNameDashboard = document.getElementById('welcomeUserNameDashboard');
        const kbVersionDashboard = document.getElementById('kbVersionDashboard');
        const lastKbUpdateDashboard = document.getElementById('lastKbUpdateDashboard');
        const footerKbVersion = document.getElementById('footerKbVersion');

        // Modal Elements
        const addItemModalOverlay = document.getElementById('addItemModalOverlay');
        const modalTitle = document.getElementById('modalTitle');
        const itemTypeSelect = document.getElementById('itemTypeSelect');
        const itemTitleInput = document.getElementById('itemTitle');
        const itemSummaryInput = document.getElementById('itemSummary');
        const itemUrlInput = document.getElementById('itemUrl');
        const itemTagsInput = document.getElementById('itemTags');
        const quillFieldContainer = document.getElementById('quillFieldContainer');
        const urlFieldContainer = document.getElementById('urlFieldContainer');
        const addItemForm = document.getElementById('addItemForm');
        const currentSectionIdForModalInput = document.getElementById('currentSectionIdForModal');


        // Initial Setup
        Auth.protectPage();
        const currentUser = Auth.getCurrentUser();

        if (currentUser) {
            const displayName = currentUser.fullName || currentUser.email || "User";
            if (userNameDisplayHeader) userNameDisplayHeader.textContent = displayName;
            if (welcomeUserNameDashboard) welcomeUserNameDashboard.textContent = `Welcome, ${displayName}!`;
            if (userAvatar) userAvatar.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&size=32&background=4f46e5&color=fff&rounded=true`;
        }
        if (kbSystemData.meta) {
            const version = kbSystemData.meta.version;
            const update = new Date(kbSystemData.meta.lastGlobalUpdate).toLocaleDateString();
            if (kbVersionDashboard) kbVersionDashboard.textContent = version;
            if (lastKbUpdateDashboard) lastKbUpdateDashboard.textContent = update;
            if (footerKbVersion) footerKbVersion.textContent = version;
        }
        
        function populateSidebar() {
            let knowledgeAreaHTML = '';
            kbSystemData.sections.forEach(section => {
                knowledgeAreaHTML += `<a href="#" class="sidebar-link" data-section="${section.id}"><i class="${section.icon || 'fas fa-folder'} ${getThemeColors(section.themeColor).icon.split(' ')[0]}"></i>${section.name}</a>`;
            });
            navigationMenu.querySelector('.sidebar-section-title:nth-of-type(2)').insertAdjacentHTML('afterend', knowledgeAreaHTML);
        }
        populateSidebar();
        
        // Theme
        const themeSwitcher = document.getElementById('themeSwitcher');
        const htmlElement = document.documentElement;
        function applyTheme(theme) { /* ... Same as previous applyTheme, ensure chart updates ... */
            htmlElement.classList.toggle('dark', theme === 'dark');
            document.getElementById('themeIcon')?.classList.toggle('fa-moon', theme !== 'dark');
            document.getElementById('themeIcon')?.classList.toggle('fa-sun', theme === 'dark');
            document.getElementById('themeText')?.textContent = theme === 'dark' ? 'Light Mode' : 'Dark Mode';
            // Update charts if they exist
            [usersChartInstance, casesChartInstance].forEach(chart => {
                if (chart) {
                    const isDark = theme === 'dark';
                    chart.options.plugins.legend.labels.color = isDark ? '#e2e8f0' : '#1a202c';
                    if (chart.options.scales && chart.options.scales.y) {
                        chart.options.scales.y.ticks.color = isDark ? '#94a3b8' : '#4a5568';
                        chart.options.scales.y.grid.color = isDark ? '#374151' : '#e5e7eb';
                        chart.options.scales.x.ticks.color = isDark ? '#94a3b8' : '#4a5568';
                        chart.options.scales.x.grid.color = isDark ? '#374151' : '#e5e7eb';
                    }
                    chart.update();
                }
            });
        }
        function loadTheme() { applyTheme(localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light')); }
        themeSwitcher?.addEventListener('click', () => { const newTheme = htmlElement.classList.contains('dark') ? 'light' : 'dark'; localStorage.setItem('theme', newTheme); applyTheme(newTheme); });
        loadTheme();

        // Mobile Sidebar
        function toggleMobileSidebar() { sidebar.classList.toggle('open'); }
        [mobileSidebarToggle, mobileSidebarToggleHeader].forEach(btn => btn?.addEventListener('click', toggleMobileSidebar));
        sidebar.querySelectorAll('.sidebar-link').forEach(link => link.addEventListener('click', () => { if(window.innerWidth < 1024) sidebar.classList.remove('open'); }));

        // Logout & Report Error
        document.getElementById('logoutButton')?.addEventListener('click', Auth.logout);
        document.getElementById('reportErrorBtn')?.addEventListener('click', () => alert('Report Error (Simulated)'));


        // Add Item Modal Logic
        function setupModalForType(type) {
            document.getElementById('currentItemType').value = type;
            modalTitle.textContent = `Add New ${type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}`;
            quillFieldContainer.classList.toggle('hidden', !['case', 'article'].includes(type));
            urlFieldContainer.classList.toggle('hidden', !['form_template', 'video_link', 'design_link'].includes(type));

            if (['case', 'article'].includes(type) && !itemQuillEditor) {
                itemQuillEditor = new Quill('#itemQuillEditor', {
                    theme: 'snow',
                    modules: { toolbar: [[{ 'header': [1, 2, false] }], ['bold', 'italic', 'underline'], [{ 'list': 'ordered'}, { 'list': 'bullet' }]] },
                    placeholder: 'Enter details here...'
                });
            }
        }

        itemTypeSelect.addEventListener('change', (e) => setupModalForType(e.target.value));

        function openAddItemModal(sectionIdForModal = null) {
            addItemModalOverlay.classList.remove('hidden');
            addItemForm.reset();
            if(itemQuillEditor) itemQuillEditor.setText('');
            setupModalForType(itemTypeSelect.value); // Setup for default selected type
            currentSectionIdForModalInput.value = sectionIdForModal || ''; // Store section context
             // Permissions check for Add Item button (general)
            const generalAddBtn = document.getElementById('openAddItemModalBtnGeneral');
            if(generalAddBtn) generalAddBtn.style.display = currentUser.role === 'viewer' ? 'none' : 'flex';
            itemTitleInput.focus();
        }
        function closeAddItemModal() { addItemModalOverlay.classList.add('hidden'); }

        document.getElementById('openAddItemModalBtnGeneral')?.addEventListener('click', () => openAddItemModal());
        openAddItemModalForSectionBtn?.addEventListener('click', () => {
            const currentSection = window.location.hash.substring(1).split('/')[0];
            openAddItemModal(currentSection);
        });
        document.getElementById('closeAddItemModalBtn')?.addEventListener('click', closeAddItemModal);
        document.getElementById('cancelAddItemBtn')?.addEventListener('click', closeAddItemModal);
        
        addItemForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const itemType = document.getElementById('currentItemType').value;
            const title = itemTitleInput.value.trim();
            const summary = itemSummaryInput.value.trim();
            const tags = itemTagsInput.value.split(',').map(t => t.trim()).filter(t => t);
            const sectionIdContext = currentSectionIdForModalInput.value || window.location.hash.substring(1).split('/')[0] || 'uncategorized';

            if (!title || !summary) { alert("Title and Summary are required."); return; }

            let itemData = { title, summary, tags, type: itemType, lastUpdated: new Date().toISOString().split('T')[0] };
            
            if (['case', 'article'].includes(itemType)) {
                itemData.content = itemQuillEditor ? itemQuillEditor.root.innerHTML : '';
                if(itemType === 'case') itemData.status = 'New';
            } else if (['form_template', 'video_link', 'design_link'].includes(itemType)) {
                itemData.url = itemUrlInput.value.trim();
                if (!itemData.url) { alert("URL is required for this item type."); return; }
            }

            const { data: savedItem, error } = await supabase.from(TABLES.ITEMS).insert([{ ...itemData, section_id_context: sectionIdContext, created_by: currentUser.email }]).select();

            if (error) { alert(`Error saving item: ${error.message}`); console.error(error); }
            else {
                alert(`${itemType.replace(/_/g, ' ')} saved successfully!`);
                closeAddItemModal();
                logUserView(savedItem[0].id, `${itemType}_created`, sectionIdContext);

                // Add to local kbSystemData and refresh view
                const targetSection = kbSystemData.sections.find(s => s.id === sectionIdContext);
                if (targetSection) {
                    const newItemForLocal = { ...savedItem[0], id: savedItem[0].id.toString() }; // Supabase ID might be number
                    if (itemType === 'case') {
                        targetSection.cases = targetSection.cases || [];
                        targetSection.cases.unshift(newItemForLocal);
                    } else if (itemType === 'article') {
                        targetSection.articles = targetSection.articles || [];
                        targetSection.articles.unshift(newItemForLocal);
                    } else { // For form_template, video_link, etc. - assuming they go into 'items' array
                        targetSection.items = targetSection.items || [];
                        targetSection.items.unshift(newItemForLocal);
                    }
                    displaySectionContent(sectionIdContext); // Refresh current view
                } else if (sectionIdContext === 'uncategorized') {
                    // Handle items saved without a specific section context if needed
                    console.log("Item saved as uncategorized:", savedItem[0]);
                }
            }
        });
        
        // Chart Init and Data Fetching
        async function fetchAndInitDashboardData() {
            const { data: views, error } = await supabase.from(TABLES.VIEWS_LOG).select('user_identifier, item_type, item_id, viewed_at');
            if(error) console.error("Error fetching views_log for dashboard:", error);
            initCharts(views || []);
            populateUserFilter();
            populateRecentActivity(views || []);
        }
        
        function initCharts(viewData = []) { /* ... Same as your previous initCharts logic, adapted for new canvas IDs if changed ... */
            const isDark = htmlElement.classList.contains('dark');
            const legendColor = isDark ? '#e2e8f0' : '#1a202c';
            const ticksColor = isDark ? '#94a3b8' : '#4a5568';
            const gridColor = isDark ? '#374151' : '#e5e7eb';

            const chartOptions = (type) => ({
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { labels: { color: legendColor, font: {size: 10} } } },
                scales: type === 'bar' ? { y: { ticks: { color: ticksColor, beginAtZero: true, font:{size:10} }, grid: { color: gridColor } }, x: { ticks: { color: ticksColor, font:{size:10} }, grid: { color: gridColor } } } : {}
            });

            // User Views Chart (Example: views per user)
            const userViewCounts = viewData.reduce((acc, v) => { acc[v.user_identifier] = (acc[v.user_identifier] || 0) + 1; return acc; }, {});
            const usersCtx = document.getElementById('usersChart')?.getContext('2d');
            if(usersChartInstance) usersChartInstance.destroy();
            if(usersCtx) usersChartInstance = new Chart(usersCtx, { type: 'bar', data: { labels: Object.keys(userViewCounts).slice(0,5), datasets: [{ label: 'Views by User', data: Object.values(userViewCounts).slice(0,5), backgroundColor: 'rgba(59, 130, 246, 0.6)' }] }, options: chartOptions('bar') });

            // Content Type Views (Example: views per item_type)
            const typeViewCounts = viewData.reduce((acc, v) => { acc[v.item_type] = (acc[v.item_type] || 0) + 1; return acc; }, {});
            const casesCtx = document.getElementById('casesChart')?.getContext('2d');
            if(casesChartInstance) casesChartInstance.destroy();
            if(casesCtx) casesChartInstance = new Chart(casesCtx, { type: 'pie', data: { labels: Object.keys(typeViewCounts), datasets: [{ data: Object.values(typeViewCounts), backgroundColor: ['#10b981', '#f59e0b', '#ef4444', '#6366f1', '#ec4899'].slice(0, Object.keys(typeViewCounts).length) }] }, options: chartOptions('pie') });
        }
        
        async function populateUserFilter() { /* ... Same as before using RPC ... */
            const { data, error } = await supabase.rpc('get_distinct_viewers');
            const filterUserSelect = document.getElementById('filterUser');
            if (error || !filterUserSelect) { console.error("Error/element missing for user filter:", error); return; }
            filterUserSelect.innerHTML = '<option value="">All Users</option>'; // Reset
            data?.forEach(u => filterUserSelect.add(new Option(u.user_identifier, u.user_identifier)));
        }
        
        function populateRecentActivity(viewData = []) {
            const listEl = document.getElementById('recentActivityList');
            if(!listEl) return;
            listEl.innerHTML = ''; // Clear
            if(!viewData.length) { listEl.innerHTML = '<li class="text-gray-500 dark:text-gray-400">No recent activity.</li>'; return; }
            viewData.sort((a,b) => new Date(b.viewed_at) - new Date(a.viewed_at)) // Sort by most recent
                     .slice(0, 5) // Take top 5
                     .forEach(view => {
                        const li = document.createElement('li');
                        li.className = "pb-1 mb-1 border-b border-gray-200 dark:border-gray-700 last:border-b-0";
                        li.innerHTML = `<span class="font-medium text-indigo-600 dark:text-indigo-400">${view.user_identifier}</span> ${view.item_type.replace(/_/g, ' ')}: <span class="text-gray-700 dark:text-gray-300">${truncateText(view.item_id, 20)}</span> <span class="text-xs text-gray-400 dark:text-gray-500 float-right">${new Date(view.viewed_at).toLocaleTimeString()}</span>`;
                        listEl.appendChild(li);
                     });
        }

        document.getElementById('applyFilterBtn')?.addEventListener('click', async () => { /* ... Same as before, fetch filtered data and call initCharts & populateRecentActivity ... */
            const date = document.getElementById('filterDate').value;
            const user = document.getElementById('filterUser').value;
            const interaction = document.getElementById('filterInteraction').value;
            
            let query = supabase.from(TABLES.VIEWS_LOG).select('user_identifier, item_type, item_id, viewed_at');
            if(date) query = query.gte('viewed_at', `${date}T00:00:00Z`).lte('viewed_at', `${date}T23:59:59Z`);
            if(user) query = query.eq('user_identifier', user);
            if(interaction) query = query.eq('item_type', interaction);
            
            const {data: filteredData, error} = await query;
            if(error) console.error("Error fetching filtered data:", error);
            else {
                initCharts(filteredData || []);
                populateRecentActivity(filteredData || []);
            }
        });

        // Helper functions (escapeHTML, highlightText, truncateText, stripHtml, getThemeColors) - Ensure they are defined
        function escapeHTML(str) { /* ... */ return str?.replace(/[&<>"']/g, m=>({'&':'&','<':'<','>':'>','"':'"',"'":'''}[m])) || '';}
        function highlightText(text, query) { /* ... */ if (!text) return ''; const safeText=escapeHTML(text); if(!query) return safeText; try { const rgx=new RegExp(`(${query.replace(/[-\/\\^$*+?.()|[\]{}]/g,'\\$&')})`, 'gi'); return safeText.replace(rgx, '<mark>$1</mark>');} catch(e){return safeText;}}
        function truncateText(text, len) { /* ... */ if(!text || text.length <= len) return text; return text.substring(0,len)+'...';}
        function stripHtml(html){ /* ... */ const tmp=document.createElement("DIV"); tmp.innerHTML=html || ''; return tmp.textContent||tmp.innerText||""; }
        function getThemeColors(themeColor = 'gray') { /* ... Ensure this has the full color map ... */
            const colorMap = { blue: { icon: 'text-blue-400', border: 'border-blue-500', cta: 'text-blue-400', tagBg: 'bg-blue-900', tagText: 'text-blue-300', statusBg: 'bg-blue-900', statusText: 'text-blue-300', iconContainer: 'bg-blue-800/50' }, teal: { icon: 'text-teal-400', border: 'border-teal-500', cta: 'text-teal-400', tagBg: 'bg-teal-900', tagText: 'text-teal-300', statusBg: 'bg-teal-900', statusText: 'text-teal-300', iconContainer: 'bg-teal-800/50' }, /* ... Add ALL your colors ... */ gray: { icon: 'text-gray-400', border: 'border-gray-500', cta: 'text-indigo-400', tagBg: 'bg-gray-700', tagText: 'text-gray-300', statusBg: 'bg-gray-600', statusText: 'text-gray-300', iconContainer: 'bg-gray-700/50' }}; return colorMap[themeColor?.toLowerCase()] || colorMap.gray; }

        // Card Rendering
        function renderCard(item, sectionData, itemTypeOverride = null) {
            const type = itemTypeOverride || item.type || 'item'; // Determine type
            const theme = getThemeColors(sectionData.themeColor);
            let iconClass = sectionData.icon || 'fas fa-file-alt';
            if (type === 'case') iconClass = 'fas fa-briefcase';
            else if (type === 'article') iconClass = 'fas fa-newspaper';
            else if (type === 'form_template') iconClass = 'fas fa-wpforms';
            else if (type === 'video_link') iconClass = 'fas fa-video';
            else if (type === 'design_link') iconClass = 'fas fa-palette';

            let actionsHTML = '';
            if (type === 'article' || type === 'case') {
                actionsHTML = `<a href="${escapeHTML(item.contentPath || '#')}" target="_blank" class="text-sm font-medium ${theme.cta} hover:underline">View Details <i class="fas fa-arrow-right ml-1 text-xs"></i></a>`;
            } else if (item.url) {
                actionsHTML = `<a href="${escapeHTML(item.url)}" target="_blank" class="text-sm font-medium ${theme.cta} hover:underline">Open Link <i class="fas fa-external-link-alt ml-1 text-xs"></i></a>`;
            }

            return `
            <div class="card card-animate border-t-4 ${theme.border}" data-item-id="${item.id}" data-item-type="${type}">
                <div class="flex items-center mb-3">
                    <div class="p-2.5 rounded-full ${theme.iconContainer} mr-3"><i class="${iconClass} text-lg ${theme.icon}"></i></div>
                    <h3 class="font-semibold text-base md:text-lg leading-tight flex-1">${escapeHTML(item.title)}</h3>
                </div>
                <p class="text-sm mb-3 flex-grow text-gray-500 dark:text-gray-400">${escapeHTML(truncateText(item.summary || item.description, 120))}</p>
                ${item.tags && item.tags.length > 0 ? `<div class="mb-3 text-xs">${item.tags.map(tag => `<span class="${theme.tagBg} ${theme.tagText} px-2 py-0.5 rounded-full mr-1 mb-1 font-medium">${escapeHTML(tag)}</span>`).join('')}</div>` : ''}
                <div class="mt-auto flex justify-between items-center pt-2 border-t border-gray-200 dark:border-gray-700">
                    ${type === 'case' && item.status ? `<span class="text-xs font-medium px-2 py-0.5 rounded-full ${theme.statusBg} ${theme.statusText}">${escapeHTML(item.status)}</span>` : `<div></div>`}
                    ${actionsHTML}
                </div>
            </div>`;
        }
        
        // Content Display Logic
        function displaySectionContent(sectionId, itemIdToFocus = null, subCategoryFilter = null) {
            dashboardOverviewContainer.classList.add('hidden');
            standardSectionContentPlaceholder.classList.remove('hidden');
            standardSectionContentPlaceholder.innerHTML = '';
            sectionAddItemBtnContainer.classList.add('hidden'); // Hide by default

            if (sectionId === 'home') {
                dashboardOverviewContainer.classList.remove('hidden');
                standardSectionContentPlaceholder.classList.add('hidden');
                if (currentSectionTitleEl) currentSectionTitleEl.textContent = 'Dashboard';
                if (breadcrumbsContainer) breadcrumbsContainer.innerHTML = `<span class="font-medium">Home</span>`;
                fetchAndInitDashboardData(); // Fetch data for charts and lists
                return;
            }

            const sectionData = kbSystemData.sections.find(s => s.id === sectionId);
            if (!sectionData) {
                standardSectionContentPlaceholder.innerHTML = `<div class="p-10 text-center"><h2 class="text-2xl font-semibold">Section Not Found</h2><p>The section "${escapeHTML(sectionId)}" does not exist.</p></div>`;
                if(currentSectionTitleEl) currentSectionTitleEl.textContent = "Not Found";
                return;
            }

            if(currentSectionTitleEl) currentSectionTitleEl.textContent = sectionData.name;
             if (breadcrumbsContainer) { /* ... breadcrumb logic ... */
                let bcHTML = `<a href="#home" class="hover:underline">Home</a> <span class="mx-1 text-gray-400">></span>`;
                if (subCategoryFilter) {
                    const subCat = sectionData.subCategories?.find(sc => sc.id === subCategoryFilter);
                    bcHTML += `<a href="#${sectionData.id}" class="hover:underline">${escapeHTML(sectionData.name)}</a> <span class="mx-1 text-gray-400">></span> <span class="font-medium">${escapeHTML(subCat?.name || subCategoryFilter)}</span>`;
                } else {
                    bcHTML += `<span class="font-medium">${escapeHTML(sectionData.name)}</span>`;
                }
                breadcrumbsContainer.innerHTML = bcHTML;
             }

            let contentHTML = `<div class="space-y-8">`;
            let itemsDisplayed = 0;

            // Show "Add item to this section" button if user has permission
            if (currentUser.role !== 'viewer') {
                sectionAddItemBtnContainer.classList.remove('hidden');
            }
            
            // Render different types of content
            const renderContentCategory = (title, items, typeOverride = null) => {
                const filteredItems = (items || []).filter(item => !subCategoryFilter || (item.tags && item.tags.includes(subCategoryFilter)) || (item.subCategory === subCategoryFilter) );
                if (filteredItems.length) {
                    contentHTML += `<h3 class="text-2xl font-semibold mb-4 border-b pb-2 border-gray-300 dark:border-gray-700">${title}</h3><div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">`;
                    filteredItems.forEach(item => contentHTML += renderCard(item, sectionData, typeOverride));
                    contentHTML += `</div>`;
                    itemsDisplayed += filteredItems.length;
                }
            };

            renderContentCategory('Articles', sectionData.articles, 'article');
            renderContentCategory('Cases', sectionData.cases, 'case');
            renderContentCategory(sectionData.itemsLabel || 'General Items', sectionData.items); // Use a generic label or default

            // Sub-categories
            if (!subCategoryFilter && sectionData.subCategories && sectionData.subCategories.length > 0) {
                const theme = getThemeColors(sectionData.themeColor);
                contentHTML += `<h3 class="text-2xl font-semibold mt-8 mb-4 border-b pb-2 border-gray-300 dark:border-gray-700">Sub-Categories</h3><div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">`;
                sectionData.subCategories.forEach(subCat => {
                    contentHTML += `<a href="#${sectionData.id}/${subCat.id}" class="card card-animate text-center hover:border-2 hover:border-indigo-500 dark:hover:border-indigo-400">
                        <i class="${sectionData.icon || 'fas fa-folder-open'} text-3xl mb-2 ${theme.icon}"></i>
                        <h4 class="font-medium">${escapeHTML(subCat.name)}</h4></a>`;
                });
                contentHTML += `</div>`;
                itemsDisplayed++; // Count subcategory section as displayed content
            }

            if (itemsDisplayed === 0) {
                contentHTML += `<div class="text-center py-12"><i class="fas fa-box-open text-5xl text-gray-400 dark:text-gray-500 mb-4"></i><p class="text-xl text-gray-500 dark:text-gray-400">No content found for this section${subCategoryFilter ? ' or filter' : ''}.</p></div>`;
            }
            contentHTML += `</div>`;
            standardSectionContentPlaceholder.innerHTML = contentHTML;

            // Animate cards
            standardSectionContentPlaceholder.querySelectorAll('.card-animate').forEach((card, index) => {
                card.style.opacity = '0'; card.style.transform = 'translateY(15px)';
                setTimeout(() => { card.style.opacity = '1'; card.style.transform = 'translateY(0)'; card.style.transition = 'opacity 0.4s ease-out, transform 0.4s ease-out'; card.style.transitionDelay = `${index * 0.05}s`; }, 50);
            });
             if (itemIdToFocus) { /* ... scroll to item ... */
                setTimeout(() => {
                    const targetCard = standardSectionContentPlaceholder.querySelector(`[data-item-id="${itemIdToFocus}"]`);
                    if (targetCard) {
                        targetCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        targetCard.style.boxShadow = '0 0 0 3px rgba(59, 130, 246, 0.5)';
                        setTimeout(() => targetCard.style.boxShadow = '', 3500);
                    }
                }, 250);
             }
        }

        // Navigation & Routing
        function highlightSidebarLink(sectionId) { /* ... same ... */ document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active','bg-indigo-600','text-white')); const activeLink = document.querySelector(`.sidebar-link[data-section="${sectionId}"]`); if(activeLink) activeLink.classList.add('active','bg-indigo-600','text-white');}
        function handleNavigation() {
            const hash = window.location.hash.substring(1);
            const parts = hash.split('/');
            const sectionId = parts[0] || 'home';
            const subCategoryFilter = (parts.length > 1 && kbSystemData.sections.find(s=>s.id===sectionId)?.subCategories?.find(sc=>sc.id===parts[1])) ? parts[1] : null;
            const itemIdToFocus = subCategoryFilter ? (parts[2] || null) : (parts[1] || null) ;
            
            highlightSidebarLink(sectionId);
            displaySectionContent(sectionId, itemIdToFocus, subCategoryFilter);
            logUserView(hash || 'home_page_view', 'navigation');
        }
        document.querySelectorAll('.sidebar-link, [data-section], [data-subcat-filter], #breadcrumbs a').forEach(link => { // Added breadcrumbs
            link.addEventListener('click', e => {
                e.preventDefault();
                const section = link.dataset.section || link.getAttribute('href').substring(1).split('/')[0];
                const subcat = link.dataset.subcatFilter;
                let newHash = section;
                if(subcat) newHash += `/${subcat}`;
                else if (link.getAttribute('href') && link.getAttribute('href').includes('/')) { // For breadcrumbs with subcat
                     newHash = link.getAttribute('href').substring(1);
                }
                window.location.hash = newHash;
            });
        });
        // Global Search
        const globalSearchInput = document.getElementById('globalSearchInput');
        const searchResultsContainer = document.getElementById('searchResultsContainer');
        globalSearchInput?.addEventListener('input', () => { /* ... same simplified search as before ... */
             const query = globalSearchInput.value.trim();
            if (query.length < 2) { searchResultsContainer.classList.add('hidden'); return; }
            logUserView(query, 'search_query_typed');
            const results = [];
            kbSystemData.sections.forEach(s => {
                s.articles?.forEach(a => { if(a.title.toLowerCase().includes(query.toLowerCase()) || a.summary?.toLowerCase().includes(query.toLowerCase())) results.push({...a, type:'article', sectionId:s.id, sectionName:s.name});});
                s.cases?.forEach(c => { if(c.title.toLowerCase().includes(query.toLowerCase()) || c.summary?.toLowerCase().includes(query.toLowerCase())) results.push({...c, type:'case', sectionId:s.id, sectionName:s.name});});
                s.items?.forEach(i => { if(i.title.toLowerCase().includes(query.toLowerCase()) || i.description?.toLowerCase().includes(query.toLowerCase())) results.push({...i, type:i.type || 'item', sectionId:s.id, sectionName:s.name});});
                 if(s.name.toLowerCase().includes(query.toLowerCase()) || s.description?.toLowerCase().includes(query.toLowerCase())) results.push({id:s.id, title:s.name, summary:s.description, type:'section', sectionId:s.id, sectionName:s.name});
            });
            searchResultsContainer.innerHTML = '';
            if(results.length) {
                results.slice(0,7).forEach(r => {
                    const li = document.createElement('a');
                    li.href = `#${r.sectionId}${r.type !== 'section' ? '/'+r.id : ''}`;
                    li.className = 'block p-3 text-sm hover:bg-gray-100 dark:hover:bg-gray-600 border-b border-gray-200 dark:border-gray-600 last:border-b-0';
                    li.innerHTML = `<div class="font-medium">${highlightText(r.title, query)} <span class="text-xs opacity-70">(${r.type} in ${r.sectionName})</span></div>${r.summary ? `<p class="text-xs opacity-80">${highlightText(truncateText(r.summary, 60),query)}</p>`: ''}`;
                    searchResultsContainer.appendChild(li);
                });
                searchResultsContainer.classList.remove('hidden');
            } else {
                searchResultsContainer.innerHTML = `<div class="p-3 text-sm text-gray-500">No results found.</div>`;
                searchResultsContainer.classList.remove('hidden');
            }
        });
        document.addEventListener('click', e => { if (!globalSearchInput?.contains(e.target) && !searchResultsContainer?.contains(e.target)) searchResultsContainer?.classList.add('hidden'); });

        async function logUserView(itemId, itemType, details = null) { /* ... same ... */ const user = Auth.getCurrentUser(); await supabase.from(TABLES.VIEWS_LOG).insert([{ item_id: itemId, item_type: itemType, user_identifier: user.email, details_text: details, viewed_at: new Date().toISOString() }]); }
        
        window.addEventListener('hashchange', handleNavigation);
        handleNavigation(); // Initial load
        console.log("InfiniBase App Initialized (Fully Merged & Refined)");
        // --- END APP LOGIC ---
    </script>
</body>
</html>
