<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - InfiniBase</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Styles similar to signup.html for consistency */
        body {
            background: linear-gradient(135deg, #6366f1, #8b5cf6); /* InfiniBase: Slightly different Indigo/Purple */
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
            padding: 1rem;
            font-family: 'Inter', sans-serif;
        }
        .login-container { /* Adjusted from signup-container if needed */
            background: white;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            padding: 2rem;
            max-width: 450px;
            width: 100%;
        }
        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1.5rem;
            color: #4f46e5; /* Indigo-600 */
        }
        .logo-container i {
            font-size: 2.5rem;
            margin-right: 0.75rem;
        }
        .logo-container h2 {
            font-size: 1.875rem;
            font-weight: 700;
        }
        .header-text {
            text-align: center;
            margin-bottom: 2rem;
        }
        .header-text h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1f2937; /* Gray-800 */
            margin-bottom: 0.25rem;
        }
        .header-text p {
            font-size: 0.875rem;
            color: #4b5563; /* Gray-600 */
        }
        .form-group {
            margin-bottom: 1.25rem;
        }
        .form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151; /* Gray-700 */
            margin-bottom: 0.5rem;
        }
        .input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }
        .input-icon-fa {
            position: absolute;
            left: 0.75rem;
            color: #9ca3af; /* Gray-400 */
            font-size: 1rem;
        }
        .input-field {
            width: 100%;
            padding: 0.75rem 0.75rem 0.75rem 2.5rem;
            border: 1px solid #d1d5db; /* Gray-300 */
            border-radius: 0.375rem;
            font-size: 0.875rem;
            color: #1f2937;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-field:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        }
        .input-field.error-border {
             border-color: #ef4444;
        }
        .input-field.error-border:focus {
            border-color: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
        }
        .password-toggle-fa { /* For FontAwesome password toggle */
            position: absolute;
            right: 0.75rem;
            color: #9ca3af; /* Gray-400 */
            cursor: pointer;
            padding: 0.25rem;
        }
        .field-error-message {
            font-size: 0.75rem;
            color: #ef4444; /* Red-500 */
            margin-top: 0.25rem;
            display: none;
        }
        .form-message {
            padding: 0.75rem 1rem;
            margin-bottom: 1.5rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            text-align: center;
            border-width: 1px;
            border-style: solid;
            display: none;
        }
        .success-message {
            background-color: #dcfce7;
            border-color: #86efac;
            color: #166534;
        }
        .info-message { /* Added for needsconfirmation */
            background-color: #e0f2fe; /* Light blue, e.g., sky-100 */
            border-color: #7dd3fc; /* Sky-300 */
            color: #075985; /* Sky-800 */
        }
        .error-message.general-form-error {
            background-color: #fee2e2;
            border-color: #fca5a5;
            color: #991b1b;
        }
        .primary-button {
            width: 100%;
            background-color: #4f46e5;
            color: white;
            padding: 0.75rem 1rem;
            font-weight: 500;
            font-size: 0.875rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .primary-button:hover {
            background-color: #4338ca;
        }
        .primary-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        .primary-button.loading .btn-text { display: none; }
        .primary-button.loading .loading-spinner { display: inline-block; }
        .loading-spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .form-options {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.25rem;
            font-size: 0.875rem;
        }
        .remember-me label {
            margin-left: 0.5rem;
            color: #374151; /* Gray-700 */
        }
        .remember-me input[type="checkbox"] {
            border-radius: 0.25rem;
            color: #4f46e5; /* Indigo-600 */
            border-color: #d1d5db; /* Gray-300 */
        }
        .remember-me input[type="checkbox"]:focus {
            ring: #4f46e5;
        }
        .forgot-password-link {
            color: #4f46e5;
            text-decoration: none;
        }
        .forgot-password-link:hover {
            text-decoration: underline;
        }
        .links-footer {
            text-align: center;
            margin-top: 1.5rem;
            font-size: 0.875rem;
            color: #4b5563; /* Gray-600 */
        }
        .links-footer a {
            color: #4f46e5;
            font-weight: 500;
            text-decoration: none;
        }
        .links-footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="logo-container">
            <i class="fas fa-database"></i>
            <h2>InfiniBase</h2>
        </div>
        <div class="header-text">
            <h2>Welcome Back!</h2>
            <p>Please enter your credentials to access InfiniBase.</p>
        </div>

        <div id="loginGeneralMessage" class="form-message" style="display: none;"></div>

        <form id="loginForm" novalidate>
            <div class="form-group">
                <label for="email">Work Email</label>
                <div class="input-wrapper">
                    <span class="input-icon-fa"><i class="fas fa-envelope"></i></span>
                    <input type="email" id="email" name="email" required placeholder="your.name@thechefz.co" class="input-field">
                </div>
                <div id="emailError" class="field-error-message"></div>
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <div class="input-wrapper">
                    <span class="input-icon-fa"><i class="fas fa-lock"></i></span>
                    <input type="password" id="password" name="password" required placeholder="Enter your password" class="input-field">
                    <span class="password-toggle-fa" id="passwordToggle" aria-label="Show password" role="button" tabindex="0">
                        <i class="fas fa-eye"></i>
                    </span>
                </div>
                <div id="passwordError" class="field-error-message"></div>
            </div>
            <div class="form-options">
                <div class="remember-me">
                    <input type="checkbox" id="rememberMe" name="rememberMe" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                    <label for="rememberMe">Remember me</label>
                </div>
                <a href="#" id="forgotPasswordLink" class="forgot-password-link">Forgot password?</a>
            </div>

            <button type="submit" class="primary-button" id="loginButton">
                 <span class="btn-text">Sign In</span>
                 <span class="loading-spinner"></span>
            </button>
        </form>
        <div class="links-footer">
            Don't have an account? <a href="/infini-base/signup.html">Sign up</a>
        </div>
    </div>

    <!-- 1. Supabase CDN: Using specific Supabase version -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script> 
    <!-- 2. Your Supabase client initializer -->
    <script src="/infini-base/js/supabase.js"></script>
    <!-- 3. Page specific logic -->
    <script>
        let supabase; // Will be assigned window.supabaseClient

        const loginForm = document.getElementById('loginForm');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const rememberMeCheckbox = document.getElementById('rememberMe');
        const loginButton = document.getElementById('loginButton');
        const passwordToggle = document.getElementById('passwordToggle');
        const forgotPasswordLink = document.getElementById('forgotPasswordLink');

        const emailErrorEl = document.getElementById('emailError');
        const passwordErrorEl = document.getElementById('passwordError');
        const loginGeneralMessageEl = document.getElementById('loginGeneralMessage');

        const REMEMBERED_EMAIL_KEY_INFINIBASE = 'infiniBaseRememberedEmail'; 

        function displayFieldError(element, message) {
            if (element) {
                element.textContent = message;
                element.style.display = 'block';
                const inputField = element.previousElementSibling?.querySelector('input');
                if (inputField) inputField.classList.add('error-border');
            }
        }
        function clearFieldError(element) {
            if (element) {
                element.textContent = '';
                element.style.display = 'none';
                const inputField = element.previousElementSibling?.querySelector('input');
                if (inputField) inputField.classList.remove('error-border');
            }
        }
        function displayGeneralMessage(message, type = 'error') {
            if (loginGeneralMessageEl) {
                loginGeneralMessageEl.textContent = message;
                loginGeneralMessageEl.classList.remove('success-message', 'error-message', 'general-form-error', 'info-message');
                if (type === 'success') loginGeneralMessageEl.classList.add('success-message');
                else if (type === 'info') loginGeneralMessageEl.classList.add('info-message');
                else loginGeneralMessageEl.classList.add('error-message', 'general-form-error');
                loginGeneralMessageEl.style.display = 'block';
            }
        }
        function clearGeneralMessage() {
            if (loginGeneralMessageEl) loginGeneralMessageEl.style.display = 'none';
        }
        function setButtonLoading(isLoading) {
            if (loginButton) {
                loginButton.disabled = isLoading;
                loginButton.classList.toggle('loading', isLoading);
            }
        }
        function togglePasswordVisibility() {
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            const icon = passwordToggle.querySelector('i');
            icon.classList.toggle('fa-eye');
            icon.classList.toggle('fa-eye-slash');
            passwordToggle.setAttribute('aria-label', type === 'password' ? 'Show password' : 'Hide password');
        }

        function initializePage() {
            if (typeof window.supabaseClient === 'undefined' || !window.supabaseClient.auth) {
                console.error("[login.html] Supabase client (window.supabaseClient) not available.");
                displayGeneralMessage("Service unavailable. Please try again later.", "error");
                if (loginForm) loginForm.style.display = 'none';
                return;
            }
            supabase = window.supabaseClient; // Assign to local supabase variable
            console.log('[login.html] Supabase client (window.supabaseClient) ready.');

            supabase.auth.getSession().then(({ data: { session } }) => {
                if (session) {
                    console.log('[login.html] User already authenticated, redirecting to dashboard.');
                    window.location.replace('/infini-base/dashboard.html');
                }
            });

            if (passwordToggle) {
                passwordToggle.addEventListener('click', togglePasswordVisibility);
                passwordToggle.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        togglePasswordVisibility();
                    }
                });
            }
            
            const rememberedEmail = localStorage.getItem(REMEMBERED_EMAIL_KEY_INFINIBASE);
            if (rememberedEmail && emailInput) {
                emailInput.value = rememberedEmail;
                if (rememberMeCheckbox) rememberMeCheckbox.checked = true;
            }
            
            if(emailInput && passwordInput) {
                 if (emailInput.value === '') {
                    emailInput.focus();
                } else {
                    passwordInput.focus();
                }
            }
            
            const urlParams = new URLSearchParams(window.location.search);
            const currentPathWithoutQuery = window.location.pathname; // e.g., /infini-base/login.html
            
            if (urlParams.get('signedup') === 'true') {
                displayGeneralMessage("Signup successful! Please log in with your new account.", "success");
                const signedUpEmail = urlParams.get('email');
                if (signedUpEmail && emailInput && !emailInput.value) {
                     emailInput.value = signedUpEmail;
                     if (passwordInput) passwordInput.focus();
                }
                window.history.replaceState({}, document.title, currentPathWithoutQuery);
            } else if (urlParams.get('needsconfirmation') === 'true') {
                displayGeneralMessage("Account created! Please check your email to confirm your account, then log in.", "info");
                const signedUpEmail = urlParams.get('email');
                 if (signedUpEmail && emailInput && !emailInput.value) {
                    emailInput.value = signedUpEmail;
                }
                window.history.replaceState({}, document.title, currentPathWithoutQuery);
            }


            if (loginForm) {
                loginForm.addEventListener('submit', async function(event) {
                    event.preventDefault();
                    clearGeneralMessage();
                    clearFieldError(emailErrorEl);
                    clearFieldError(passwordErrorEl);
                    setButtonLoading(true);

                    const email = emailInput.value.trim().toLowerCase();
                    const password = passwordInput.value;
                    const rememberMe = rememberMeCheckbox ? rememberMeCheckbox.checked : false;

                    let isValid = true;
                    if (!email) {
                        displayFieldError(emailErrorEl, 'Email is required.');
                        isValid = false;
                    } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                        displayFieldError(emailErrorEl, 'Please enter a valid email address.');
                        isValid = false;
                    }
                    if (!password) {
                        displayFieldError(passwordErrorEl, 'Password is required.');
                        isValid = false;
                    }

                    if (!isValid) {
                        setButtonLoading(false);
                        return;
                    }

                    if (rememberMe) {
                        localStorage.setItem(REMEMBERED_EMAIL_KEY_INFINIBASE, email);
                    } else {
                        localStorage.removeItem(REMEMBERED_EMAIL_KEY_INFINIBASE);
                    }

                    try {
                        const { data, error } = await supabase.auth.signInWithPassword({
                            email: email,
                            password: password,
                        });

                        if (error) {
                            throw error;
                        }

                        if (data.user && data.session) {
                            console.log('Login successful for:', data.user.email);
                            displayGeneralMessage('Login successful! Redirecting to dashboard...', 'success');
                            setTimeout(() => {
                                window.location.replace('/infini-base/dashboard.html'); 
                            }, 1500);
                        } else {
                            throw new Error('Login successful but no user session data returned.');
                        }
                    } catch (error) {
                        console.error('Login error:', error);
                        let errorMessage = 'Login failed. Please check your credentials.';
                        if (error && error.message) {
                            if (error.message.toLowerCase().includes('invalid login credentials')) {
                                errorMessage = 'Incorrect email or password.';
                            } else if (error.message.toLowerCase().includes('email not confirmed')) {
                                errorMessage = 'Email not confirmed. Please check your inbox.';
                            } else if (error.status === 429) { // Supabase often uses status for rate limiting
                                errorMessage = "Too many login attempts. Please try again later.";
                            } else {
                                errorMessage = `Login error: ${error.message}`;
                            }
                        }
                        displayGeneralMessage(errorMessage, "error");
                        setButtonLoading(false); // Re-enable button on error if not redirecting
                    } 
                    // Ensure button is re-enabled if not redirecting
                    if (!loginGeneralMessageEl.textContent.includes("Redirecting to dashboard...")) {
                         setButtonLoading(false);
                    }
                });
            }

            if (forgotPasswordLink) {
                forgotPasswordLink.addEventListener('click', async (e) => {
                    e.preventDefault();
                    const email = emailInput.value.trim();
                    clearGeneralMessage();
                    clearFieldError(emailErrorEl);

                    if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                        displayFieldError(emailErrorEl, 'Please enter your email address above to request a password reset.');
                        emailInput.focus();
                        return;
                    }
                    
                    setButtonLoading(true); 
                    displayGeneralMessage('Sending reset instructions...', 'info');

                    try {
                        const { error } = await supabase.auth.resetPasswordForEmail(email, {
                             //redirectTo: window.location.origin + '/infini-base/reset-password.html' // Example if you have one
                        });
                        if (error) throw error;
                        displayGeneralMessage('Password reset instructions sent to your email (if your account exists). Please check your inbox and spam folder.', 'success');
                    } catch (error) {
                        console.error('Password reset error:', error);
                        displayGeneralMessage('If your email is registered, you will receive reset instructions. Please also check your spam folder.', 'success');
                    } finally {
                        setButtonLoading(false);
                    }
                });
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(initializePage, 200); 
        });

    </script>
</body>
</html>
