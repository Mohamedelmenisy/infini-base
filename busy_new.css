/* ========== الخطوط والألوان العامة (Design Tokens) ========== */
:root {
--bg-main: #0b1220;
--bg-content: #0f1724;
--bg-quick-review: #0d1320;
--bg-level-box: #1e2d42; /* لون جديد لصناديق العناوين */
--text-main: #e6eef8;
--text-secondary: #9ca3af;
--color-link: #c7d2fe;
--color-pill: #6d28d9;
--color-highlight: #93c5fd;
--border-color: #1e293b;
--font-family: 'Cairo', 'Inter', 'Segoe UI', Tahoma, Arial, sans-serif;
}

/* تطبيق الخلفية والخط الأساسي على الحاوية الرئيسية (Full Width) */
.kb-app {
font-family: var(--font-family);
background-color: var(--bg-main);
color: var(--text-main);
padding: 0;
margin: 0;
width: 100%;
box-sizing: border-box;
animation: fadeIn 0.8s ease-out;
}

/* FIX: Full-width background but contained content */
.kb-container {
width: 95%; /* 95% of viewport width */
max-width: 1100px; /* NEW: Max width for content containment */
padding: 1.5rem;
margin: 0 auto; /* Centers the content container */
box-sizing: border-box;
}

/* Keyframes for Fade-in Effect */
@keyframes fadeIn {
from { opacity: 0; }
to { opacity: 1; }
}

/* ========== تنسيق البانر وزر اللغة ========== */
.header-banner {
width: 100%;
height: 50px; /* حجم صغير */
overflow: hidden;
margin-bottom: 1.5rem;
display: flex;
align-items: center;
justify-content: flex-start;
padding: 0 1.5rem;
box-sizing: border-box;
}
.header-banner img {
max-height: 100%;
width: auto;
}

.language-toggle-wrapper {
margin: 0 1.5rem 1.5rem 1.5rem; /* محاذاة لليسار بعد البانر */
text-align: right;
}
.kb-app[dir="ltr"] .language-toggle-wrapper {
text-align: left;
}
#lang-toggle-button {
display: inline-block;
cursor: pointer;
background-color: var(--color-link);
color: var(--bg-main) !important;
border: none;
padding: 8px 15px;
border-radius: 50px;
font-weight: 600;
transition: all 0.3s;
}
#lang-toggle-button:hover {
opacity: 0.8;
}

/* ========== تنسيق العناوين والنص ========== */
.kb-app h1 {
display: none; /* تم إخفاء العنوان الكبير القديم بناءً على طلبك */
}

.kb-app h2 {
font-size: 1.15rem;
font-weight: 700;
color: var(--color-highlight);
margin: 2rem 0 1rem 0;
padding: 0.5rem 0;
border-bottom: 1px solid rgba(255, 255, 255, 0.08);
}

.kb-app h3 {
font-size: 1.05rem;
font-weight: 600;
color: var(--text-main);
margin: 1.5rem 0 1rem 0;
padding: 0.5rem 0;
border-right: 3px solid var(--color-pill);
padding-right: 10px;
}

/* New: Box style for Level Headings (e.g., L1, VIP) */
.level-heading-box {
background-color: var(--bg-level-box);
border: 1px solid var(--border-color);
border-radius: 8px;
padding: 1rem;
margin: 2rem 0 1.5rem 0;
}
.level-heading-box h3 {
margin: 0;
padding: 0;
border: none;
color: var(--color-highlight);
}
.kb-app[dir="rtl"] .level-heading-box h3 {
border-right: 3px solid var(--color-highlight);
padding-right: 10px;
}
.kb-app[dir="ltr"] .level-heading-box h3 {
border-left: 3px solid var(--color-highlight);
padding-left: 10px;
}

.kb-app p, .kb-app li {
font-size: 0.98rem;
line-height: 1.7;
color: var(--text-main);
font-weight: 500;
margin: 0 0 1rem 0;
}

.kb-app .note {
font-size: 0.92rem;
color: var(--text-secondary);
font-style: italic;
display: block;
margin-top: 1rem;
padding: 1rem;
border-radius: 6px;
background-color: rgba(156, 163, 175, 0.05);
border-right: 4px solid var(--color-link);
}

.kb-app a {
color: var(--color-link);
text-decoration: none;
transition: color 0.3s;
}
.kb-app a:hover {
color: #a5b4fc;
text-decoration: underline;
}

/* ========== تنسيق البطاقات والقوائم ========== */
.kb-card {
background-color: var(--bg-content);
border: 1px solid var(--border-color);
border-radius: 12px;
padding: 1.5rem;
margin-bottom: 2rem;
box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
transition: none; /* إزالة أي تأثيرات انتقالية تسبب الاهتزاز */
}
.kb-card:hover {
box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
/* مهم: تأكيد إزالة أي تحريك أو اهتزاز */
transform: none !important;
}


.kb-app ul {
list-style-type: none;
padding: 0;
margin: 1rem 0;
}
.kb-card ul li {
position: relative;
margin-bottom: 0.75rem;
}
/* Bullet points for Arabic (RTL) */
.ar-content ul li::before {
content: "•";
color: var(--color-link);
font-weight: bold;
display: inline-block;
width: 1em;
margin-right: -1em;
position: absolute;
right: 0;
top: 0;
}
.ar-content ul li {
padding-right: 1.5rem;
}
/* Bullet points for English (LTR) */
.en-content ul li::before {
content: "•";
color: var(--color-link);
font-weight: bold;
display: inline-block;
width: 1em;
margin-left: -1em;
position: absolute;
left: 0;
top: 0;
}
.en-content ul li {
padding-left: 1.5rem;
}


/* ========== صندوق المراجعة السريعة (Quick Overview) ========== */
.quick-review-box {
background-color: var(--bg-quick-review);
border: 1px solid rgba(255, 255, 255, 0.15);
border-radius: 12px;
padding: 1.5rem;
margin-bottom: 2rem;
}
.quick-review-box h3 {
margin-top: 0;
padding-top: 0;
border-right: 3px solid #f87171;
color: #f87171;
}

/* NEW: 4-card Quick Overview Grid */
.quick-overview-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
gap: 1rem;
margin-top: 1.5rem;
}
.quick-overview-card {
background-color: var(--bg-content);
border: 1px solid var(--border-color);
border-radius: 10px;
padding: 1rem;
box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
transition: none; /* إزالة الاهتزاز */
}
.quick-overview-card h4 {
font-size: 1rem;
color: var(--color-link);
margin-top: 0;
margin-bottom: 0.5rem;
font-weight: 700;
}
.quick-overview-card p {
font-size: 0.9rem;
line-height: 1.5;
margin: 0;
color: var(--text-secondary);
}

/* ========== تنسيق الأيقونات والروابط (Pills) ========== */
.pill-container {
display: flex;
flex-wrap: wrap;
gap: 0.75rem;
margin: 1.5rem 0;
}
.pill-link {
background-color: var(--color-pill);
color: var(--text-main) !important;
padding: 0.4rem 1rem;
border-radius: 25px;
font-size: 0.85rem;
font-weight: 600;
white-space: nowrap;
transition: background-color 0.3s, transform 0.1s;
}
.pill-link:hover {
background-color: #5b21aa;
text-decoration: none;
transform: none; /* إزالة اهتزاز الرابط */
}

/* ========== تنسيق الوسائط (صور وفيديوهات) ========== */
.media-preview {
display: block;
position: relative;
margin-bottom: 1rem;
border-radius: 8px;
overflow: hidden;
border: 1px solid var(--border-color);
transition: box-shadow 0.3s;
}
.media-preview:hover {
box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
}
.media-preview img, .media-preview video {
display: block;
width: 100%;
height: auto;
object-fit: cover;
}
.media-caption {
display: block;
background-color: rgba(0, 0, 0, 0.6);
color: var(--text-main);
text-align: center;
padding: 0.5rem;
font-size: 0.85rem;
position: absolute;
bottom: 0;
width: 100%;
box-sizing: border-box;
}

.grid-cards {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
gap: 1.5rem;
margin: 1.5rem 0;
}
.grid-item {
background-color: rgba(255, 255, 255, 0.03);
border: 1px solid var(--border-color);
border-radius: 8px;
padding: 1rem;
transition: none; /* إزالة الاهتزاز */
}
.grid-item:hover {
background-color: rgba(255, 255, 255, 0.06);
transform: none; /* إزالة الاهتزاز */
}
.grid-item h4 {
color: var(--color-highlight);
font-size: 1rem;
font-weight: 600;
margin-top: 0;
padding-bottom: 0.5rem;
border-bottom: 1px solid var(--border-color);
}

/* ========== Lightbox/Modal (Slot Feature) - Glassy Background ========== */
.css-lightbox {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
display: none; /* مخفي بشكل افتراضي */
z-index: 1000;
}
.css-lightbox.active {
display: block;
}

.lightbox-overlay {
position: absolute;
top: 0;
left: 0;
width: 100%;
height: 100%;
background-color: rgba(0, 0, 0, 0.7);
/* NEW: Glassy effect */
backdrop-filter: blur(8px);
}

.lightbox-content {
position: relative;
z-index: 1001;
background-color: var(--bg-content);
border: 1px solid var(--border-color);
border-radius: 12px;
padding: 20px;
margin: 50px auto;
max-width: 90%;
max-height: 90%;
overflow-y: auto;
box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
animation: zoomIn 0.3s ease-out;
}
@keyframes zoomIn {
from { transform: scale(0.9); opacity: 0.5; }
to { transform: scale(1); opacity: 1; }
}

.lightbox-content img, .lightbox-content video {
max-width: 100%;
height: auto;
display: block;
margin: 15px auto;
border-radius: 8px;
}
.lightbox-content p {
color: var(--text-main);
}
.lightbox-content h3 {
color: var(--color-highlight);
border: none;
margin: 0 0 1rem 0;
}

.lightbox-close {
position: absolute;
top: 10px;
right: 15px;
font-size: 30px;
font-weight: bold;
color: var(--text-secondary);
text-decoration: none;
transition: color 0.3s;
z-index: 1002;
}
.lightbox-close:hover {
color: var(--color-link);
text-decoration: none;
}

/* RTL Adjustments for Lightbox */
.kb-app[dir="rtl"] .lightbox-content {
margin: 50px auto;
}
.kb-app[dir="rtl"] .lightbox-close {
right: 15px;
left: auto;
}
.kb-app[dir="rtl"] .lightbox-content .lightbox-download {
right: 60px;
left: auto;
}

/* LTR Adjustments for Lightbox */
.kb-app[dir="ltr"] .lightbox-close {
left: 15px;
right: auto;
}
.kb-app[dir="ltr"] .lightbox-content .lightbox-download {
left: 60px;
right: auto;
}

/* ========== Back to Top Button ========== */
.back-to-top {
display: block;
width: 100%;
text-align: center;
margin-top: 2rem;
}
.back-to-top a {
background-color: #1a2333;
border: 1px solid var(--border-color);
color: var(--color-highlight) !important;
padding: 0.5rem 1.5rem;
border-radius: 25px;
font-size: 0.9rem;
font-weight: 600;
text-decoration: none;
transition: all 0.3s;
}
.back-to-top a:hover {
background-color: var(--color-pill);
color: var(--text-main) !important;
text-decoration: none;
}
```

---

### 3. ملف `busy_new.js` (السلوك والتفاعلات)

تم تعديل هذا الملف ليصبح أكثر قوة:
- إضافة **Lazy Loading** باستخدام `IntersectionObserver` لتحميل الصور والفيديوهات فقط عند ظهورها على الشاشة، مما يسرّع تحميل الصفحة بشكل كبير.
- السكربت مُصمم للعمل مع المحتوى الذي يتم إضافته ديناميكيًا (Dynamically Injected Content).

```javascript
/* busy_new.js
- Robust, works if content inserted after DOM load.
- Lazy loads images and videos for performance.
- Handles lightbox open/close via event delegation.
- Manages language switching (toggle).
- Includes a safe initialization that runs after content is ready.
*/

(function () {
    // ===== Lightbox Functions =====
    window.openLightbox = function (targetId) {
        const lb = document.getElementById(targetId);
        if (!lb) return;
        lb.classList.add('active');
        document.body.style.overflow = 'hidden';
        const video = lb.querySelector('video');
        if (video && typeof video.play === 'function') {
            video.play().catch(() => {}); // Autoplay video in lightbox
        }
    };

    window.closeLightbox = function (targetId) {
        const lb = document.getElementById(targetId);
        if (!lb) return;
        lb.classList.remove('active');
        document.body.style.overflow = '';
        const video = lb.querySelector('video');
        if (video && typeof video.pause === 'function') {
            video.pause(); // Pause video when closing
        }
    };

    // ===== Language Switch Function =====
    function switchLanguage(lang) {
        const arContent = document.getElementById('ar-content');
        const enContent = document.getElementById('en-content');
        const langToggle = document.getElementById('lang-toggle-button');
        const appWrapper = document.querySelector('.kb-app');

        if (!arContent || !enContent || !langToggle || !appWrapper) return;

        if (lang === 'ar') {
            arContent.style.display = 'block';
            enContent.style.display = 'none';
            appWrapper.setAttribute('dir', 'rtl');
            langToggle.textContent = 'Switch to English';
            langToggle.setAttribute('data-lang', 'en');
        } else {
            arContent.style.display = 'none';
            enContent.style.display = 'block';
            appWrapper.setAttribute('dir', 'ltr');
            langToggle.textContent = 'التحويل للعربية';
            langToggle.setAttribute('data-lang', 'ar');
        }
    }

    window.toggleLanguage = function () {
        const langToggle = document.getElementById('lang-toggle-button');
        if (!langToggle) return;
        const nextLang = langToggle.getAttribute('data-lang') || 'en';
        switchLanguage(nextLang);
    };
    
    // ===== Lazy Loading for Media =====
    function lazyLoadMedia() {
        const lazyMedia = document.querySelectorAll('.kb-app img[data-src], .kb-app video[data-src]');
        if ('IntersectionObserver' in window) {
            const mediaObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const media = entry.target;
                        const src = media.getAttribute('data-src');
                        media.src = src;
                        media.removeAttribute('data-src');
                        if (media.tagName === 'VIDEO') {
                           media.load();
                        }
                        observer.unobserve(media);
                    }
                });
            });
            lazyMedia.forEach(media => mediaObserver.observe(media));
        } else {
            // Fallback for older browsers
            lazyMedia.forEach(media => {
                media.src = media.getAttribute('data-src');
                media.removeAttribute('data-src');
            });
        }
    }

    // ===== Initialization Function =====
    function initBusyNew() {
        // Attach click listener to language toggle button
        const langToggle = document.getElementById('lang-toggle-button');
        if (langToggle && !langToggle._busynew_attached) {
            langToggle.addEventListener('click', (e) => {
                e.preventDefault();
                window.toggleLanguage();
            });
            langToggle._busynew_attached = true;
        }

        // Set initial view to Arabic
        if (document.getElementById('ar-content') && document.getElementById('en-content')) {
            switchLanguage('ar');
        }
        
        // Start lazy loading media
        lazyLoadMedia();

        // Attach delegated listeners for lightbox closing
        if (!document._busynew_delegated) {
            document.addEventListener('click', function (e) {
                const overlay = e.target.closest('.lightbox-overlay');
                if (overlay) {
                    const lb = overlay.closest('.css-lightbox');
                    if (lb && lb.id) {
                        closeLightbox(lb.id);
                        e.preventDefault();
                    }
                }
                const closeBtn = e.target.closest('.lightbox-close');
                 if (closeBtn) {
                    const lb = closeBtn.closest('.css-lightbox');
                    if (lb && lb.id) {
                        closeLightbox(lb.id);
                        e.preventDefault();
                    }
                }
            }, true);
            document._busynew_delegated = true;
        }
    }

    // Expose init function to be called from app.html
    window.initBusyNew = initBusyNew;

    // Fallback if script loads before DOM is ready
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
        setTimeout(initBusyNew, 0);
    } else {
        document.addEventListener('DOMContentLoaded', initBusyNew);
    }
})();
