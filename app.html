<!DOCTYPE html>
<html class="dark" data-hash="2025-06-24T15:30" dir="ltr" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>InfiniBase - Polished Dashboard</title>
<!-- Cairo Font for Arabic -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<!-- Favicon -->
<link href="data:image/svg+xml,&lt;svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32' width='32' height='32'&gt;&lt;rect width='32' height='32' rx='4' fill='%236366f1'/&gt;&lt;text x='50%' y='55%' dominant-baseline='middle' text-anchor='middle' font-family='Arial, sans-serif' font-size='18' font-weight='bold' fill='white'&gt;IB&lt;/text&gt;&lt;/svg&gt;" rel="icon" type="image/svg+xml"/>
<!-- CDNs -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet"/>
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet"/>
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/quill-image-resize-module@3.0.0/image-resize.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<!-- Spotlight.js for Lightbox Effect -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/spotlight.js/dist/css/spotlight.min.css" />
<script src="https://cdn.jsdelivr.net/npm/spotlight.js/dist/js/spotlight.min.js" defer></script>
<!-- Diff2HTML for Version History -->
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css" />
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js"></script>

<style>
        /* --- نظام التحميل الجديد --- */
        #loadingOverlay {
            position: fixed;
            inset: 0;
            background-color: #111827;
            z-index: 99999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-left-color: #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        #loadingOverlay p {
            color: #9ca3af;
            margin-top: 1rem;
            font-weight: 500;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* --- إخفاء المحتوى الرئيسي أثناء التحميل --- */
        .container-fluid {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        :root {
            /* Permanent Dark Theme Variables */
            --primary-color: #6366f1; /* Brighter Indigo for dark */
            --primary-color-hover: #4f46e5;
            --secondary-color: #9ca3af;

            --text-color: #d1d5db;
            --text-color-muted: #9ca3af;
            --text-color-inverted: #ffffff;
            --text-color-subtle: #9ca3af;

            --bg-color: #111827; /* Dark gray */
            --bg-color-alt: #1f2937; /* Slightly lighter dark gray for cards/modals */
            --bg-color-sidebar: #1f2937;
            --bg-color-header: rgba(31, 41, 55, 0.9);
            --bg-color-modal: #1f2937;
            --bg-color-hover: #374151;
            --bg-color-active: var(--primary-color);

            --border-color: #374151;
            --border-color-darker: #4b5563;

            --card-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            --card-hover-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            
            --border-radius: 0.5rem;
            --border-radius-lg: 0.75rem;
            --header-height: 70px;
            --sidebar-width: 260px;

            --yes-color: #22c55e; /* Green for Yes */
            --no-color: #ef4444;   /* Red for No */
            --rating-color: #fbbf24; /* Amber 400 for ratings */
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            line-height: 1.6;
            font-size: 16px;
        }

        .sidebar, .content-wrapper, #recentActivity {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .sidebar::-webkit-scrollbar, .content-wrapper::-webkit-scrollbar, #recentActivity::-webkit-scrollbar {
            display: none;
        }

        a { text-decoration-skip-ink: none; }
        
        [lang='ar'] {
            font-family: 'Cairo', sans-serif;
            direction: rtl;
        }

        .container-fluid {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-color-sidebar);
            padding: 1.5rem;
            border-right: 1px solid var(--border-color);
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            overflow-y: auto;
            transition: transform 0.3s ease-in-out;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }
        .sidebar.closed {
            transform: translateX(-100%);
        }
        @media (min-width: 768px) {
            .sidebar.closed { transform: translateX(0); }
        }

        .sidebar-header {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            color: #F9FAFB;
            padding-left: 0.5rem;
        }
        .sidebar-header img {
            height: 36px;
            width: auto;
            border-radius: 6px;
            margin-right: 12px;
        }
        .sidebar-logo-text {
             color: var(--text-color);
        }

        .sidebar-nav { flex-grow: 1; }

        .sidebar-section-title {
            padding-left: 0.75rem;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--text-color-muted);
        }

        .sidebar-link {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-radius: var(--border-radius);
            transition: background-color 0.2s ease, color 0.2s ease;
            font-weight: 500;
            color: var(--text-color-subtle);
            text-decoration: none;
            margin-bottom: 0.25rem;
        }
        .sidebar-link i {
            margin-right: 0.75rem;
            width: 1.5rem;
            font-size: 1.5rem;
            text-align: center;
            transition: color 0.2s ease;
        }
        .sidebar-link:hover {
            background-color: var(--bg-color-hover);
            color: var(--text-color);
        }
        .sidebar-link.active {
            background-color: var(--bg-color-active);
            color: var(--text-color-inverted) !important;
            font-weight: 600;
        }
        .sidebar-link.active i {
            color: var(--text-color-inverted) !important;
        }

        .sidebar-footer {
            margin-top: auto;
            padding-top: 1rem;
        }
        .sidebar-footer button {
            width: 100%;
            margin-top: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sidebar-footer button i { margin-right: 0.5rem; }


        .content-wrapper {
            flex-grow: 1;
            padding: 0;
            transition: margin-left 0.3s ease-in-out;
            height: 100vh;
            overflow-y: auto;
        }
        @media (min-width: 768px) {
             .content-wrapper { margin-left: var(--sidebar-width); }
             .sidebar.closed + .content-wrapper { margin-left: 0; }
        }

        .content-header {
            background-color: var(--bg-color-header);
            padding: 1.25rem 2rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 50;
            backdrop-filter: blur(8px);
        }
         @media (max-width: 767px) {
            .content-header { left: 0; }
        }
        .header-left-content { display: flex; align-items: center; }
        #currentSectionTitle {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 0;
        }
        #breadcrumbs {
            font-size: 0.875rem;
            color: var(--text-color-muted);
            margin-top: 0.25rem;
        }
        #breadcrumbs a { color: var(--primary-color); text-decoration: none; }
        #breadcrumbs a:hover { text-decoration: underline; }

        .header-right-content { display: flex; align-items: center; gap: 1rem; }
        
        .admin-toolbar {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background-color: var(--bg-color-alt);
            padding: 0.5rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }
        .admin-toolbar a {
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-color-muted);
            text-decoration: none;
            border-radius: var(--border-radius);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .admin-toolbar a:hover {
            background-color: var(--bg-color-hover);
            color: var(--text-color);
        }
        .admin-toolbar a.active {
            background-color: var(--primary-color);
            color: var(--text-color-inverted);
        }

        .search-container { position: relative; }
        .search-container input[type="search"] {
            padding: 0.625rem 1rem 0.625rem 2.5rem;
            border: 1px solid var(--border-color-darker);
            border-radius: 9999px;
            min-width: 250px;
            background-color: var(--bg-color-alt);
            color: var(--text-color);
        }
        .search-container input[type="search"]::placeholder {
            color: var(--text-color-muted);
            opacity: 0.8;
        }
        .search-container .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-color-muted);
        }
        #searchResultsContainer {
            position: absolute;
            background-color: var(--bg-color-alt);
            border: 1px solid var(--border-color);
            border-top: none;
            width: 100%;
            max-height: 300px;
            overflow-y: auto;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            z-index: 60;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
        }
        #searchResultsContainer a {
            display: block;
            padding: 0.75rem;
            text-decoration: none;
            color: var(--text-color);
        }
        #searchResultsContainer a:hover { background-color: var(--bg-color-hover); }
        #searchResultsContainer mark { background-color: #78350f; color: #f3f4f6; }


        .user-profile { display: flex; align-items: center; gap: 0.5rem; }
        #userAvatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: var(--text-color-inverted);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
        }
        #userNameDisplayHeader { font-weight: 500; }
        @media (max-width: 640px) {
            #userNameDisplayHeader { display: none; }
        }

        main { padding: 1.5rem; }

        main#pageContentArea.is-dashboard {
            padding: 0 !important;
        }
        
        .card {
            background-color: var(--bg-color-alt);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--card-shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            flex-direction: column;
            min-height: 150px;
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--card-hover-shadow);
        }
        
        /* Dashboard Styles */
        .dashboard-grid {
            display: grid;
            gap: 1.5rem;
            grid-template-columns: 1fr;
            padding: 1.5rem;
        }
        @media(min-width: 640px) {
            .dashboard-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media(min-width: 1024px) {
            .dashboard-grid { grid-template-columns: repeat(4, 1fr); }
        }
        @media(min-width: 1280px) {
             .dashboard-grid { grid-template-columns: repeat(5, 1fr); }
        }

        .dashboard-grid [class*="grid-col-span-"] { grid-column: span 1; }
        @media(min-width: 1024px) { .dashboard-grid .grid-col-span-2 { grid-column: span 2; } }
        @media(min-width: 1024px) { .dashboard-grid .grid-col-span-4 { grid-column: span 4; } }
        @media(min-width: 1280px) { .dashboard-grid .grid-col-span-5 { grid-column: span 5; } }

        .dashboard-stat-card {
            background-color: var(--bg-color-alt);
            border: 1px solid var(--border-color);
            padding: 1rem;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--card-shadow);
            display: flex;
            align-items: center;
            gap: 1rem;
            position: relative;
        }
        .dashboard-stat-card .icon-container {
            font-size: 1.5rem;
            color: var(--primary-color);
            background-color: var(--bg-color);
            height: 44px;
            width: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .dashboard-stat-card .stat-info .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            display: block;
            line-height: 1.2;
        }
        .dashboard-stat-card .stat-info .stat-label {
            font-size: 0.85rem;
            color: var(--text-color-muted);
        }
        .stat-growth {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            font-size: 0.75rem;
            font-weight: bold;
            padding: 0.1rem 0.4rem;
            border-radius: 99px;
            display: flex;
            align-items: center;
            gap: 0.2rem;
        }
        .stat-growth.positive {
            color: var(--yes-color);
            background-color: rgba(34, 197, 94, 0.15);
        }
        .stat-growth.negative {
            color: var(--no-color);
            background-color: rgba(239, 68, 68, 0.15);
        }

        .chart-container {
            position: relative;
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            background-color: var(--bg-color-alt);
            border: 1px solid var(--border-color);
            min-height: 350px;
            max-height: 400px;
            display: flex;
            flex-direction: column;
        }

        .dashboard-table-card {
            background-color: var(--bg-color-alt);
            padding: 1.25rem 1.5rem;
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--border-color);
            box-shadow: var(--card-shadow);
            overflow: hidden;
        }
        .dashboard-table-card h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0 0 1rem 0;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        #recentActivity {
            max-height: 300px;
            overflow-y: auto;
            padding-right: 0.5rem;
        }
        .activity-item {
            display: flex;
            gap: 0.75rem;
            padding-bottom: 0.75rem;
            margin-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }
        .activity-item:last-child { border-bottom: none; }
        .activity-item-content p { margin: 0; line-height: 1.4; font-size: 0.9rem; }
        .activity-item-content .activity-timestamp { font-size: 0.75rem; color: var(--text-color-muted); }
        .pagination-controls-activity {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-top: 1rem;
            gap: 0.75rem;
        }
        
        .hidden { display: none !important; }
        
        .toast-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 18px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 2000;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            display: flex;
            align-items: center;
            background-color: var(--bg-color-alt);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }
        .toast-notification.show { opacity: 1; transform: translateY(0); }
        .toast-icon { margin-right: 10px; font-size: 1.2em; }
        .toast-success { background-color: #10b981; color: white; border-color: #059669; }
        .toast-error { background-color: #ef4444; color: white; border-color: #dc2626; }
        .toast-info { background-color: #3b82f6; color: white; border-color: #2563eb; }
        
        /* ... باقي أكواد CSS كما هي ... */
</style>

</head>
<body id="pageBody">

<!-- نظام التحميل الجديد -->
<div id="loadingOverlay">
    <div class="spinner"></div>
    <p>Loading InfiniBase...</p>
</div>

<!-- باقي محتوى الصفحة الرئيسي، يبدأ مخفيًا -->
<div class="container-fluid">
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="data:image/svg+xml,&lt;svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32' width='32' height='32'&gt;&lt;rect width='32' height='32' rx='4' fill='%236366f1'/&gt;&lt;text x='50%' y='55%' dominant-baseline='middle' text-anchor='middle' font-family='Arial, sans-serif' font-size='18' font-weight='bold' fill='white'&gt;IB&lt;/text&gt;&lt;/svg&gt;" alt="InfiniBase Logo">
            <span class="sidebar-logo-text">InfiniBase</span>
        </div>
        <nav class="sidebar-nav" id="navigationMenu">
            <!-- سيتم ملء القائمة هنا بواسطة الجافاسكريبت -->
        </nav>
        <div class="sidebar-footer">
            <button class="button button-danger" id="logoutButton">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
            <div id="userRoleDisplaySidebar" style="font-size: 0.8rem; color: var(--text-color-muted); text-align: center; margin-top: 0.5rem;">Role: <span id="currentUserRoleSpan"></span></div>
        </div>
    </aside>
    <div class="content-wrapper" id="contentWrapper">
        <header class="content-header">
            <div class="header-left-content">
                <button class="mobile-sidebar-toggle" id="mobileSidebarToggle"><i class="fas fa-bars"></i></button>
                <div>
                    <h1 id="currentSectionTitle">Welcome</h1>
                    <div id="breadcrumbs">Home</div>
                </div>
            </div>
            <div class="header-right-content">
                <div class="search-container">
                    <span class="search-icon"><i class="fas fa-search"></i></span>
                    <input id="globalSearchInput" placeholder="Search the knowledge base..." type="search"/>
                    <div class="hidden" id="searchResultsContainer"></div>
                </div>
                <div class="admin-toolbar" id="adminToolbar">
                    <a href="#home" id="admin-link-dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                    <a href="audit.html" id="admin-link-audit"><i class="fas fa-history"></i> Audit Log</a>
                    <a href="insights.html" id="admin-link-insights"><i class="fas fa-chart-pie"></i> Insights</a>
                    <a href="employees.html" class="nav-link"><i class="fas fa-users"></i>Employees</a>
                </div>
                <div class="user-profile" id="userProfileContainer">
                    <div id="userAvatar">U</div>
                    <span id="userNameDisplayHeader" style="font-weight: 500;">User</span>
                </div>
            </div>
        </header>
        <main class="p-6 md:p-8" id="pageContentArea">
            <div class="hidden" id="dashboardOverviewContainer">
                <!-- سيتم ملء الداش بورد هنا -->
            </div>
            <div id="standardSectionContentPlaceholder">
                <!-- سيتم عرض محتوى الأقسام هنا -->
            </div>
            <div class="hidden" data-mermaid-rendered="false" id="itemDetailViewPlaceholder">
                <!-- سيتم عرض تفاصيل المقالات هنا -->
            </div>
        </main>
        <footer class="mt-auto p-6 text-center text-sm">
            <span>© <script>document.write(new Date().getFullYear())</script> InfiniBase.Elmenisy.</span>
        </footer>
    </div>
</div>

<div id="toastContainer"></div>
<!-- كل النوافذ المنبثقة (Modals) هنا. لم تتغير. -->
<div class="modal-overlay hidden" id="addContentModalOverlay"><!-- ... --></div>
<div class="modal-overlay hidden" id="logoutConfirmModalOverlay"><!-- ... --></div>
<!-- ... etc ... -->

<script type="module">
    // ========== 1. دمج كود الاتصال بـ Supabase مباشرة ==========
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const SUPABASE_URL = 'https://aefiigottnlcmjzilqnh.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFlZmlpZ290dG5sY21qemlscW5oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcxNzY2MDQsImV4cCI6MjA2Mjc1MjYwNH0.FypB02v3tGMnxXV9ZmZMdMC-oQpREKOJWgHMPxUzwX4';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ========== 2. تعريف كل الدوال والمتغيرات ==========
    
    // تعريف متغيرات DOM Elements
    const pageBody = document.getElementById('pageBody');
    const sidebar = document.getElementById('sidebar');
    const mobileSidebarToggle = document.getElementById('mobileSidebarToggle');
    const navigationMenu = document.getElementById('navigationMenu');
    const currentSectionTitleEl = document.getElementById('currentSectionTitle');
    const breadcrumbsContainer = document.getElementById('breadcrumbs');
    const pageContentArea = document.getElementById('pageContentArea');
    const dashboardOverviewContainer = document.getElementById('dashboardOverviewContainer');
    const standardSectionContentPlaceholder = document.getElementById('standardSectionContentPlaceholder');
    const itemDetailViewPlaceholder = document.getElementById('itemDetailViewPlaceholder');
    const userNameDisplayHeader = document.getElementById('userNameDisplayHeader');
    const userAvatar = document.getElementById('userAvatar');
    const currentUserRoleSpan = document.getElementById('currentUserRoleSpan');
    const logoutButton = document.getElementById('logoutButton');
    
    // تعريف متغيرات الحالة
    let currentUser = null;
    let kbSystemData = { sections: [] };
    let activityChartInstance, feedbackChartInstance;
    let dashboardData = { activityLog: [], overallInsights: {}, growthTrends: [], weeklyActivity: [], feedbackKpis: {} };
    let activityLogPage = 1;
    const ACTIVITY_LOG_PAGE_SIZE = 5;

    // --- دوال الاتصال بقاعدة البيانات ---
    async function getCurrentUserProfile() {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return null;
        const { data: profile, error } = await supabase.from('users').select('*').eq('id', user.id).single();
        if (error) {
            console.error('Error fetching user profile:', error);
            return { id: user.id, email: user.email, role: 'viewer', name: user.email };
        }
        return profile;
    }
    
    async function fetchDashboardData() {
        const [activity, insights, growth, weeklyActivity, feedbackKpis] = await Promise.all([
            supabase.from('v_recent_activity').select('*').limit(100),
            supabase.from('v_overall_insights').select('*').single(),
            supabase.from('v_growth_trends').select('*'),
            supabase.from('v_activity_combined_7days').select('*').order('activity_date_egypt'),
            supabase.from('v_insights_kpis').select('helpful_ratings, not_helpful_ratings').single()
        ]);
        
        if (activity.error) console.error("Error fetching recent activity:", activity.error);
        if (insights.error) console.error("Error fetching overall insights:", insights.error);

        return {
            activityLog: activity.data || [],
            overallInsights: insights.data || {},
            growthTrends: growth.data || [],
            weeklyActivity: weeklyActivity.data || [],
            feedbackKpis: feedbackKpis.data || {}
        };
    }

    async function fetchSubCategories() {
        const { data, error } = await supabase.from('sub_categories').select('*').order('position');
        if (error) { console.error('Error fetching sub-categories:', error); return []; }
        return data;
    }

    async function fetchArticles() {
        const { data, error } = await supabase.from('cases').select('id, sub_category_id, title_en, description_en, content_en, title_ar, description_ar, content_ar, tags, type, url, parent_id, created_at, last_modified, is_published, slug').eq('is_published', true);
        if (error) { console.error('Error fetching articles:', error); return []; }
        return data;
    }
    
    // --- الدوال المساعدة ---
    function isCurrentUserAdmin() {
        if (!currentUser) return false;
        return currentUser.role === 'admin' || currentUser.is_admin === true;
    }

    function escapeHTML(str) {
        if (typeof str !== 'string' && typeof str !== 'number') return '';
        const el = document.createElement('div');
        el.textContent = str;
        return el.innerHTML;
    }

    function formatReadableDate(isoString) {
        if (!isoString) return 'N/A';
        const date = new Date(isoString);
        return date.toLocaleString('en-EG', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true, timeZone: 'Africa/Cairo' });
    }
    
    function stripHtml(html){
       if (!html) return "";
       let tmp = document.createElement("DIV");
       tmp.innerHTML = html;
       return tmp.textContent || tmp.innerText || "";
    }
    
    function showToast(message, type = 'info', duration = 3000) {
        const toastContainer = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast-notification toast-${type}`;
        let iconClass = 'fas fa-info-circle';
        if (type === 'success') iconClass = 'fas fa-check-circle';
        else if (type === 'error') iconClass = 'fas fa-times-circle';
        toast.innerHTML = `<i class="toast-icon ${iconClass}"></i> <span>${escapeHTML(message)}</span>`;
        toastContainer.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, duration);
    }
    
    // --- دوال بناء الواجهة ---
    async function loadAndStructureData() {
        const [categories, articles] = await Promise.all([fetchSubCategories(), fetchArticles()]);
        kbSystemData.sections = categories.map(cat => ({
            ...cat,
            slug: cat.name.toLowerCase().replace(/\s+/g, '-'),
            items: articles.filter(a => a.sub_category_id === cat.id)
        }));
    }

    function populateSidebar() {
        let menuHTML = `<div class="sidebar-section-title">MAIN</div><a href="#home" class="sidebar-link active" data-section-slug="home"><i class="fas fa-home" style="color: var(--primary-color);"></i>Home</a>`;
        
        const grouped = kbSystemData.sections.reduce((acc, s) => {
            const group = s.section_id || 'knowledge_areas';
            if (!acc[group]) acc[group] = [];
            acc[group].push(s);
            return acc;
        }, {});

        const sectionTitles = { 'knowledge_areas': 'KNOWLEDGE AREAS', 'resources_policies': 'RESOURCES & POLICIES' };
        
        ['knowledge_areas', 'resources_policies'].forEach(groupId => {
            if (grouped[groupId]) {
                menuHTML += `<div class="sidebar-section-title">${sectionTitles[groupId]}</div>`;
                grouped[groupId].forEach(section => {
                    menuHTML += `<a href="#${section.slug}" class="sidebar-link" data-section-slug="${section.slug}"><i class="${section.icon || 'fas fa-folder'}" style="color: ${section.color || 'inherit'};"></i>${escapeHTML(section.name)}</a>`;
                });
            }
        });

        navigationMenu.innerHTML = menuHTML;
    }
    
    function highlightSidebarLink(sectionSlug) {
        document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
        const activeLink = document.querySelector(`.sidebar-link[data-section-slug="${sectionSlug}"]`);
        if (activeLink) activeLink.classList.add('active');
    }

    function renderDashboardCharts(data) {
        const legendColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim();
        const ticksColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color-muted').trim();
        const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim();

        if (activityChartInstance) activityChartInstance.destroy();
        const activityCtx = document.getElementById('activityChart')?.getContext('2d');
        if (activityCtx && data.weeklyActivity.length > 0) {
            const labels = data.weeklyActivity.map(d => new Date(d.activity_date_egypt).toLocaleDateString('en-US', {weekday: 'short'}));
            activityChartInstance = new Chart(activityCtx, {
                type: 'bar',
                data: { labels, datasets: [ { label: 'Total Views', data: data.weeklyActivity.map(d => d.total_views), backgroundColor: 'rgba(99, 102, 241, 0.6)' }, { label: 'Active Users', data: data.weeklyActivity.map(d => d.active_users), type: 'line', borderColor: '#22c55e', yAxisID: 'y1', tension: 0.3, fill: true } ] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'Content Activity (Last 7 Days)', color: legendColor, font: {size: 16} } }, scales: { y: { title: { display: true, text: 'Total Views', color: ticksColor }, ticks: {color: ticksColor}, grid: {color: gridColor} }, y1: { position: 'right', title: { display: true, text: 'Active Users', color: ticksColor }, grid: { drawOnChartArea: false }, ticks: {color: ticksColor, stepSize: 1 } } } }
            });
        }
        
        if (feedbackChartInstance) feedbackChartInstance.destroy();
        const feedbackCtx = document.getElementById('feedbackChart')?.getContext('2d');
        if (feedbackCtx && data.feedbackKpis) {
            feedbackChartInstance = new Chart(feedbackCtx, {
                type: 'doughnut',
                data: { labels: ['Helpful', 'Not Helpful'], datasets: [{ data: [data.feedbackKpis.helpful_ratings || 0, data.feedbackKpis.not_helpful_ratings || 0], backgroundColor: [getComputedStyle(document.documentElement).getPropertyValue('--yes-color').trim(), getComputedStyle(document.documentElement).getPropertyValue('--no-color').trim()], borderColor: getComputedStyle(document.documentElement).getPropertyValue('--bg-color-alt').trim(), borderWidth: 4 }] },
                options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { title: { display: true, text: 'Helpful Feedback Ratio', color: legendColor, font: {size: 16} }, legend: { position: 'bottom', labels: { color: legendColor, font: {size: 14}} } } }
            });
        }
    }

    function renderPaginatedActivityLog() {
        const container = document.getElementById('recentActivity');
        const prevBtn = document.getElementById('prevActivityBtn');
        const nextBtn = document.getElementById('nextActivityBtn');
        const pageInfo = document.getElementById('activityPageInfo');

        const totalPages = Math.ceil(dashboardData.activityLog.length / ACTIVITY_LOG_PAGE_SIZE);
        activityLogPage = Math.max(1, Math.min(activityLogPage, totalPages || 1));

        const start = (activityLogPage - 1) * ACTIVITY_LOG_PAGE_SIZE;
        const pageItems = dashboardData.activityLog.slice(start, start + ACTIVITY_LOG_PAGE_SIZE);

        container.innerHTML = pageItems.map(log => `
            <div class="activity-item"><div class="activity-item-content"><p><strong>${escapeHTML(log.user_name)}</strong> ${escapeHTML(log.action.replace(/_/g, ' ').toLowerCase())} <em>${escapeHTML(log.item_title || 'an item')}</em> in ${escapeHTML(log.section)}</p><p class="activity-timestamp">${formatReadableDate(log.activity_time_egypt)}</p></div></div>`).join('') || '<p>No activity found.</p>';

        if(pageInfo) pageInfo.textContent = `Page ${activityLogPage} of ${totalPages}`;
        if(prevBtn) prevBtn.disabled = activityLogPage === 1;
        if(nextBtn) nextBtn.disabled = activityLogPage >= totalPages;
    }

    async function renderDynamicDashboard() {
        if (!isCurrentUserAdmin()) {
            dashboardOverviewContainer.innerHTML = `<div class="viewer-dashboard-message"><div class="card"><i class="fas fa-shield-alt"></i><h2>Welcome to the InfiniBase Knowledge Center</h2><p>Your central hub for information and resources. Use the navigation on the left to explore different topics.</p></div></div>`;
            return;
        }

        dashboardData = await fetchDashboardData();
        const insights = dashboardData.overallInsights;
        
        dashboardOverviewContainer.innerHTML = `
            <div class="dashboard-grid">
                <div class="dashboard-stat-card"><div class="icon-container"><i class="fas fa-newspaper"></i></div><div class="stat-info"><span class="stat-value">${insights.total_articles || 0}</span><span class="stat-label">Total Articles</span></div></div>
                <div class="dashboard-stat-card"><div class="icon-container"><i class="fas fa-eye"></i></div><div class="stat-info"><span class="stat-value">${insights.total_views_all || 0}</span><span class="stat-label">Total Views</span></div></div>
                <div class="dashboard-stat-card"><div class="icon-container"><i class="fas fa-users"></i></div><div class="stat-info"><span class="stat-value">${insights.active_users_this_week || 0}</span><span class="stat-label">Active Users (Week)</span></div></div>
                <div class="dashboard-stat-card"><div class="icon-container"><i class="fas fa-star"></i></div><div class="stat-info"><span class="stat-value">${(insights.avg_feedback_rating || 0).toFixed(2)}</span><span class="stat-label">Avg. Feedback</span></div></div>
                <div class="dashboard-stat-card"><div class="icon-container"><i class="fas fa-edit"></i></div><div class="stat-info"><span class="stat-value">${insights.edits_this_week || 0}</span><span class="stat-label">Edits This Week</span></div></div>
                <div class="chart-container grid-col-span-2"><canvas id="activityChart"></canvas></div>
                <div class="chart-container grid-col-span-2" style="max-width: 500px; margin: auto;"><canvas id="feedbackChart"></canvas></div>
                <div class="dashboard-table-card grid-col-span-5"><h3><i class="fas fa-history" style="margin-right: 0.5rem; color: var(--primary-color);"></i> Recent Activity</h3><div id="recentActivity"></div><div class="pagination-controls-activity"><span id="activityPageInfo"></span><button id="prevActivityBtn" class="button button-secondary"><i class="fas fa-arrow-left"></i></button><button id="nextActivityBtn" class="button button-secondary"><i class="fas fa-arrow-right"></i></button></div></div>
            </div>`;
        
        renderDashboardCharts(dashboardData);
        renderPaginatedActivityLog();

        document.getElementById('prevActivityBtn').addEventListener('click', () => { if (activityLogPage > 1) { activityLogPage--; renderPaginatedActivityLog(); } });
        document.getElementById('nextActivityBtn').addEventListener('click', () => { const totalPages = Math.ceil(dashboardData.activityLog.length / ACTIVITY_LOG_PAGE_SIZE); if (activityLogPage < totalPages) { activityLogPage++; renderPaginatedActivityLog(); } });
    }

    function displaySectionContent(sectionSlug) {
        dashboardOverviewContainer.classList.add('hidden');
        standardSectionContentPlaceholder.classList.remove('hidden');
        itemDetailViewPlaceholder.classList.add('hidden');
        pageContentArea.classList.remove('is-dashboard');
        
        const sectionData = kbSystemData.sections.find(s => s.slug === sectionSlug);
        if (!sectionData) return;

        currentSectionTitleEl.textContent = sectionData.name;
        breadcrumbsContainer.innerHTML = `<a href="#home">Home</a> &rsaquo; ${escapeHTML(sectionData.name)}`;
        
        let contentHTML = `<div class="cards-grid">`;
        if (sectionData.items.length > 0) {
            contentHTML += sectionData.items.map(item => `
            <div class="card">
                <h3>${escapeHTML(item.title_en)}</h3>
                <p>${escapeHTML(stripHtml(item.description_en) || 'No description.')}</p>
                <div class="card-actions"><a href="#${sectionSlug}/${item.slug}" class="button">View</a></div>
            </div>`).join('');
        } else {
            contentHTML += `<p>No items in this section yet.</p>`;
        }
        contentHTML += `</div>`;
        standardSectionContentPlaceholder.innerHTML = contentHTML;
    }
    
    // --- دالة التشغيل الرئيسية ---
    async function initializeApp() {
        currentUser = await getCurrentUserProfile();
        if (!currentUser) {
            window.location.href = "login.html";
            return;
        }

        userNameDisplayHeader.textContent = currentUser.name;
        userAvatar.textContent = (currentUser.name || 'U').charAt(0).toUpperCase();
        currentUserRoleSpan.textContent = currentUser.role;

        await loadAndStructureData();
        populateSidebar();

        handleNavigation();
        window.addEventListener('hashchange', handleNavigation);
        
        logoutButton.addEventListener('click', async () => { await supabase.auth.signOut(); window.location.href = 'index.html'; });
        
        showToast(`Welcome back, ${currentUser.name}!`, 'success');

        // ========== إظهار الصفحة بعد انتهاء التحميل ==========
        const loadingOverlay = document.getElementById('loadingOverlay');
        const mainContainer = document.querySelector('.container-fluid');
        
        loadingOverlay.style.opacity = '0';
        mainContainer.style.visibility = 'visible';
        mainContainer.style.opacity = '1';
        
        setTimeout(() => {
            loadingOverlay.style.display = 'none';
        }, 500);
    }
    
    function handleNavigation() {
        const hash = window.location.hash.substring(1) || 'home';
        const [sectionSlug, itemSlug] = hash.split('/');
        
        highlightSidebarLink(sectionSlug);

        if (sectionSlug === 'home') {
             displayDashboard();
        } else if (itemSlug) {
            // Placeholder for item detail view
            standardSectionContentPlaceholder.innerHTML = `<h2>Viewing ${itemSlug} in ${sectionSlug}</h2>`;
            dashboardOverviewContainer.classList.add('hidden');
            standardSectionContentPlaceholder.classList.remove('hidden');
        } else {
             displaySectionContent(sectionSlug);
        }
    }
    
    async function displayDashboard() {
        dashboardOverviewContainer.classList.remove('hidden');
        standardSectionContentPlaceholder.classList.add('hidden');
        itemDetailViewPlaceholder.classList.add('hidden');
        pageContentArea.classList.add('is-dashboard');
        currentSectionTitleEl.textContent = 'Dashboard';
        breadcrumbsContainer.innerHTML = `<a href="#home">Home</a>`;
        await renderDynamicDashboard();
    }
    
    // تشغيل التطبيق
    initializeApp();

</script>

</body>
</html>
