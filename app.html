<!DOCTYPE html>
<html class="dark" data-hash="2025-06-24T15:30" dir="ltr" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>InfiniBase - Knowledge Base</title>
<!-- Updated Favicon -->
<link href="data:image/svg+xml,&lt;svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32' width='32' height='32'&gt;&lt;rect width='32' height='32' rx='4' fill='%236366f1'/&gt;&lt;text x='50%' y='55%' dominant-baseline='middle' text-anchor='middle' font-family='Arial, sans-serif' font-size='18' font-weight='bold' fill='white'&gt;IB&lt;/text&gt;&lt;/svg&gt;" rel="icon" type="image/svg+xml"/>
<!-- CDNs -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet"/>
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet"/>
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/quill-image-resize-module@3.0.0/image-resize.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<!-- Spotlight.js for Lightbox Effect -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/spotlight.js/dist/css/spotlight.min.css" />
<script src="https://cdn.jsdelivr.net/npm/spotlight.js/dist/js/spotlight.min.js" defer></script>
<!-- ✅ START: Diff2HTML Library for viewing changes -->
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css" />
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/5.1.0/diff.min.js"></script>
<!-- ✅ END: Diff2HTML Library -->
<style>
        :root {
            /* Permanent Dark Theme Variables */
            --primary-color: #6366f1; /* Brighter Indigo for dark */
            --primary-color-hover: #4f46e5;
            --secondary-color: #9ca3af;

            --text-color: #d1d5db;
            --text-color-muted: #9ca3af;
            --text-color-inverted: #ffffff; 
            --text-color-subtle: #9ca3af;

            --bg-color: #111827; /* Dark gray */
            --bg-color-alt: #1f2937; /* Slightly lighter dark gray for cards/modals */
            --bg-color-sidebar: #1f2937;
            --bg-color-header: rgba(31, 41, 55, 0.9);
            --bg-color-modal: #1f2937;
            --bg-color-hover: #374151;
            --bg-color-active: var(--primary-color);

            --border-color: #374151;
            --border-color-darker: #4b5563;

            --card-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            --card-hover-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            
            --border-radius: 0.5rem; 
            --border-radius-lg: 0.75rem;
            --header-height: 70px;
            --sidebar-width: 260px;

            --yes-color: #22c55e; /* Green for Yes */
            --no-color: #ef4444;   /* Red for No */
            --rating-color: #fbbf24; /* Amber 400 for ratings */
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            line-height: 1.6;
            font-size: 16px;
            overflow-x: hidden;
        }

        a { text-decoration-skip-ink: none; }

        .container-fluid {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-color-sidebar);
            padding: 1.5rem;
            border-right: 1px solid var(--border-color); /* LTR */
            position: fixed;
            top: 0;
            left: 0; /* LTR */
            height: 100vh;
            overflow-y: auto;
            transition: transform 0.3s ease-in-out, background-color: 0.3s ease, border-color: 0.3s ease;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }
        .sidebar.closed {
            transform: translateX(-100%); /* LTR */
        }
        @media (min-width: 768px) {
            .sidebar.closed { transform: translateX(0); }
        }

        .sidebar-header {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            color: var(--text-color); 
        }
        .sidebar-header i { 
            margin-right: 0.75rem; /* LTR */
            color: var(--primary-color);
            font-size: 1.8rem;
        }
        .sidebar-logo-text {
             color: var(--text-color);
        }

        .sidebar-nav { flex-grow: 1; }

        .sidebar-section-title {
            padding-left: 0.75rem; /* LTR */
            font-size: 0.75rem;
            font-weight: 700; /* Increased font-weight for better visibility */
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--text-color-muted);
        }

        .sidebar-link {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-radius: var(--border-radius);
            transition: background-color: 0.2s ease, color: 0.2s ease;
            font-weight: 500;
            color: var(--text-color-subtle);
            text-decoration: none;
            margin-bottom: 0.25rem;
        }
        .sidebar-link i {
            margin-right: 0.75rem; /* LTR */
            width: 1.5rem; /* Adjusted for font-size */
            font-size: 1.5rem; /* Increased icon size */
            text-align: center;
            transition: color 0.2s ease;
        }
        .sidebar-link:hover {
            background-color: var(--bg-color-hover);
            color: var(--text-color);
        }
        .sidebar-link.active {
            background-color: var(--bg-color-active); /* Primary color */
            color: var(--text-color-inverted) !important; /* White text */
            font-weight: 600;
        }
        .sidebar-link.active i {
            color: var(--text-color-inverted) !important; /* White icon on primary background */
        }

        .sidebar-footer {
            margin-top: auto; 
            padding-top: 1rem;
        }
        .sidebar-footer button {
            width: 100%;
            margin-top: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sidebar-footer button i { margin-right: 0.5rem; }


        .content-wrapper {
            flex-grow: 1;
            padding-right: 1.5rem; /* LTR */
            padding-left: 1.5rem;
            transition: margin-left 0.3s ease-in-out; /* LTR */
            height: 100vh;
            overflow-y: auto;
        }
        @media (min-width: 768px) {
             .content-wrapper { margin-left: var(--sidebar-width); /* LTR */ }
             .sidebar.closed + .content-wrapper { margin-left: 0; /* LTR */ }
        }

        .content-header {
            background-color: var(--bg-color-header);
            padding: 1.25rem 2rem; 
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky; 
            top: 0;
            left: var(--sidebar-width); /* LTR, adjusted for fixed sidebar */
            right: 0;
            height: var(--header-height);
            z-index: 50;
            backdrop-filter: blur(8px); 
        }
         @media (max-width: 767px) { /* Mobile: header spans full width */
            .content-header {
                left: 0;
            }
        }
        .header-left-content { display: flex; align-items: center; } 
        #currentSectionTitle {
            font-size: 1.5rem; 
            font-weight: bold;
            margin: 0;
        }
        #breadcrumbs {
            font-size: 0.875rem; 
            color: var(--text-color-muted);
            margin-top: 0.25rem;
        }
        #breadcrumbs a { color: var(--primary-color); text-decoration: none; }
        #breadcrumbs a:hover { text-decoration: underline; }

        .header-right-content { display: flex; align-items: center; gap: 1rem; }
        .search-container { position: relative; }
        .search-container input[type="search"] {
            padding: 0.625rem 1rem 0.625rem 2.5rem; /* py-2.5 pl-10 pr-4 for LTR */
            border: 1px solid var(--border-color-darker);
            border-radius: 9999px; 
            min-width: 250px; 
            background-color: var(--bg-color-alt); 
            color: var(--text-color);
        }
        .search-container input[type="search"]::placeholder {
            color: var(--text-color-muted);
            opacity: 0.8;
        }
        .search-container .search-icon {
            position: absolute;
            inset-inline-start: 0.75rem; 
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-color-muted);
        }
        #searchResultsContainer {
            position: absolute;
            background-color: var(--bg-color-alt);
            border: 1px solid var(--border-color);
            border-top: none;
            width: 100%; 
            max-height: 300px; 
            overflow-y: auto;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); 
            z-index: 60; 
            border-radius: 0 0 var(--border-radius) var(--border-radius);
        }
        #searchResultsContainer a {
            display: block;
            padding: 0.75rem; 
            text-decoration: none;
            color: var(--text-color);
        }
        #searchResultsContainer a:hover { background-color: var(--bg-color-hover); }
        #searchResultsContainer mark { background-color: #78350f; color: #f3f4f6; }


        .user-profile { display: flex; align-items: center; gap: 0.5rem; }
        #userAvatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: var(--text-color-inverted);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
        }
        #userNameDisplayHeader { font-weight: 500; }
        @media (max-width: 640px) { 
            #userNameDisplayHeader { display: none; }
        }

        main { padding: 1.5rem 0; }
        
        .card {
            background-color: var(--bg-color-alt);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg); 
            padding: 1.5rem;
            margin-bottom: 1.5rem; 
            box-shadow: var(--card-shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color: 0.3s ease, border-color: 0.3s ease;
            display: flex;
            flex-direction: column; 
            min-height: 150px; 
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--card-hover-shadow);
        }
        .card-header-icon {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .card-icon-container {
            padding: 0.75rem;
            border-radius: 50%;
            margin-right: 1rem; /* LTR */
            background-color: var(--primary-color-hover); 
        }
        .card-icon-container i {
            font-size: 1.25rem;
            color: var(--text-color-inverted);  
        }
        .card-title-group {
            flex-grow: 1;
        }
        .card h3 { margin-top: 0; font-size: 1.125rem; font-weight: 600; color: var(--text-color); line-height: 1.3; }
        .card p { margin-bottom: 1rem; font-size: 0.875rem; color: var(--text-color-subtle); flex-grow: 1; }
        
        .updated-badge {
            display: inline-block;
            background-color: rgba(34, 197, 94, 0.15); /* Green with transparency */
            border: 1px solid rgba(34, 197, 94, 0.4);
            color: #22c55e;
            padding: 0.15rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            margin-top: 0.4rem;
        }
        .card-tags {
            margin-top: 0rem;
            margin-bottom: 0.75rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .card-tags .tag {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            color: var(--text-color-muted);
            padding: 0.2rem 0.6rem;
            border-radius: 9999px;
            font-size: 0.7rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }

        .card-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
            margin-top: auto;
        }
        .card-actions .button {
            padding: 0.5rem 0.75rem;
            font-size: 0.8rem;
        }

        .button, button {
            background-color: var(--primary-color);
            color: var(--text-color-inverted);
            border: 1px solid transparent;
            padding: 0.625rem 1rem; 
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.875rem; 
            font-weight: 500; 
            transition: background-color: 0.2s, border-color: 0.2s, color: 0.2s;
            text-decoration: none; 
            display: inline-flex; 
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .button:hover, button:hover {
            background-color: var(--primary-color-hover);
        }
        .button-secondary {
            background-color: transparent;
            color: var(--text-color-subtle);
            border-color: var(--border-color-darker);
        }
        .button-secondary:hover { background-color: var(--bg-color-hover); color: var(--text-color); }
        .button-danger {
            background-color: #dc2626; 
            color: var(--text-color-inverted);
        }
        .button-danger:hover { background-color: #b91c1c; }
        input:focus, button:focus, select:focus, textarea:focus, a:focus { 
            outline: 2px solid transparent;
            outline-offset: 2px;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.6); 
        }
        button:disabled {
            background-color: var(--border-color);
            color: var(--text-color-muted);
            cursor: not-allowed;
            border-color: transparent;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.75); 
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.2s ease-out;
            visibility: hidden;
        }
        .modal-overlay:not(.hidden) { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: var(--bg-color-modal);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 48rem; 
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.95);
            opacity: 0;
            transition: transform 0.2s ease-out, opacity 0.2s ease-out, background-color: 0.3s ease, border-color: 0.3s ease;
        }
        .modal-overlay:not(.hidden) .modal-content { transform: scale(1); opacity: 1; }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem; 
        }
        .modal-header h2 { margin-top: 0; font-size: 1.5rem; font-weight: 700; }
        .modal-header .close-button { 
            background: none; border: none; font-size: 1.5rem; color: var(--text-color-muted); cursor: pointer;
            padding: 0.25rem; line-height: 1; border-radius: 50%;
        }
        .modal-header .close-button:hover { background-color: var(--bg-color-hover); }
        
        .modal-body {
            padding-bottom: 1rem;
            font-size: 1rem;
            color: var(--text-color);
        }

        .modal-actions {
            margin-top: 1.5rem; 
            text-align: right; /* LTR */
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end; /* LTR */
            gap: 0.75rem; 
        }
         .modal-actions.no-border {
            border-top: none;
            padding-top: 0;
        }


        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.25rem; font-weight: 500; font-size: 0.875rem; }
        .form-group input[type="text"],
        .form-group input[type="url"],
        .form-group input[type="email"],
        .form-group input[type="file"],
        .form-group input[type="date"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.625rem; 
            border: 1px solid var(--border-color-darker); 
            border-radius: var(--border-radius);
            box-sizing: border-box;
            background-color: var(--bg-color); 
            color: var(--text-color);
        }
        .form-group textarea { min-height: 100px; }
        
        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: var(--text-color-muted);
            opacity: 0.8;
        }

        .bilingual-form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1rem;
        }
         @media (max-width: 768px) {
            .bilingual-form-grid { grid-template-columns: 1fr; }
        }

        .ql-toolbar {
            background: var(--bg-color);
            border-color: var(--border-color-darker) !important;
            border-top-left-radius: var(--border-radius);
            border-top-right-radius: var(--border-radius);
        }
        .ql-toolbar .ql-stroke { stroke: var(--text-color-muted); }
        .ql-toolbar .ql-fill { fill: var(--text-color-muted); }
        .ql-toolbar .ql-picker-label { color: var(--text-color-muted); }
        .ql-snow .ql-picker.ql-expanded .ql-picker-options { background-color: var(--bg-color-alt); border-color: var(--border-color-darker); }
        .ql-snow .ql-picker-options .ql-picker-item:hover { color: var(--primary-color); }

        .ql-toolbar .ql-html::after {
            content: '</>';
            font-weight: bold;
            font-family: monospace;
            font-size: 14px;
        }

        .ql-container {
            background: var(--bg-color-alt);
            border-color: var(--border-color-darker) !important;
            color: var(--text-color);
            min-height: 250px; 
            border-bottom-left-radius: var(--border-radius);
            border-bottom-right-radius: var(--border-radius);
            font-size: 1rem;
        }
        .ql-editor { padding: 12px; }
        .ql-editor.ql-blank::before {
            color: var(--text-color-muted);
            opacity: 0.6;
        }


        footer {
            text-align: center;
            padding: 1.5rem;
            font-size: 0.875rem;
            color: var(--text-color-muted);
            border-top: 1px solid var(--border-color);
            margin-top: auto; 
        }

        .mobile-sidebar-toggle {
            display: block;
            position: fixed;
            top: calc((var(--header-height) - 40px) / 2); 
            left: 1.5rem; /* LTR */
            z-index: 101; 
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 0.75rem; 
            border-radius: var(--border-radius);
            font-size: 1.25rem; 
            line-height: 1;
        }
        @media (min-width: 768px) {
            .mobile-sidebar-toggle { display: none; }
            .header-left-content #currentSectionTitle { margin-left: 0; }
        }
        @media (max-width: 767px) {
            .header-left-content #currentSectionTitle { margin-left: 0.5rem; }
            .content-header { padding: 1rem; }
            .header-right-content .search-container { display:none; } 
        }

        .toast-notification {
            position: fixed;
            bottom: 20px;
            right: 20px; /* LTR */
            padding: 12px 18px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 2000; 
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            display: flex;
            align-items: center;
            background-color: var(--bg-color-alt); 
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }
        .toast-notification.show { opacity: 1; transform: translateY(0); }
        .toast-icon { margin-right: 10px; /* LTR */ font-size: 1.2em; }
        .toast-success { background-color: #10b981; color: white; border-color: #059669; } 
        .toast-error { background-color: #ef4444; color: white; border-color: #dc2626; } 
        .toast-info { background-color: #3b82f6; color: white; border-color: #2563eb; } 
        .toast-warning { background-color: #f59e0b; color: white; border-color: #d97706; }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 1.5rem; 
        }
        
        /* Content for language */
        [lang="ar"] { direction: rtl; }
        .bilingual-content.show-ar [lang="en"] { display: none; }
        .bilingual-content.show-en [lang="ar"] { display: none; }

        .kb-content h1, .kb-content h2, .kb-content h3 { margin-top: 1.5em; margin-bottom: 0.5em; color: var(--text-color); }
        .kb-content p { margin-bottom: 1em; line-height: 1.6; }
        .kb-content ul, .kb-content ol { margin-bottom: 1em; padding-left: 20px; }
        .kb-content[lang="ar"] ul, .kb-content[lang="ar"] ol { padding-left: 0; padding-right: 20px; }
        .kb-content li { margin-bottom: 0.5em; }
        .kb-content a { color: var(--primary-color); text-decoration: underline; }
        
        .hidden { display: none !important; }

        mark {
            padding: 0.1em 0.2em; border-radius: 0.2em; font-weight: bold;
            background-color: #78350f; color: #f3f4f6; 
        }
        
        #itemDetailViewPlaceholder .item-title-area {
            display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;
        }
        #itemDetailViewPlaceholder .item-title-area i.fa-title-icon {
            font-size: 2rem; color: var(--primary-color); 
        }
        #itemDetailViewPlaceholder .item-title-area h2 { font-size: 1.8rem; margin:0; }
        #itemDetailViewPlaceholder hr.title-content-divider {
             margin: 1.5rem 0; border-color: var(--border-color); 
        }
        .last-updated-info {
            color: var(--text-color-subtle);
            font-size: 0.85rem; 
            margin-bottom: 1rem; 
            font-weight: 500;
        }
        .item-actions-bar { display: flex; gap: 0.75rem; margin-bottom: 1.5rem; flex-wrap: wrap; align-items: center; }

        /* ✅ START: Activity Log Styles */
        .activity-log-section {
            margin-top: 2rem;
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
        }
        .activity-log-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        .activity-log-header h4 {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .activity-log-body {
            padding: 0.5rem;
            max-height: 400px;
            overflow-y: auto;
        }
        .activity-item {
            padding: 1rem 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 1rem;
        }
        .activity-item:last-child { border-bottom: none; }
        .activity-icon { font-size: 1.25rem; color: var(--text-color-muted); margin-top: 0.25rem; }
        .activity-details { flex-grow: 1; }
        .activity-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .activity-author { font-weight: 600; color: var(--text-color); }
        .activity-timestamp { font-size: 0.8rem; color: var(--text-color-muted); }
        .activity-view-changes-btn {
            font-size: 0.8rem;
            font-weight: 500;
            padding: 0.25rem 0.5rem;
        }
        #versionHistoryModal .modal-content {
            max-width: 80vw;
        }
        .d2h-file-header { display: none; }
        .d2h-diff-table { font-size: 0.9em; }
        .d2h-file-diff {
            border: 1px solid var(--border-color-darker);
            border-radius: var(--border-radius);
            overflow: hidden;
        }
        .d2h-code-line {
            background-color: var(--bg-color-alt);
            color: var(--text-color);
        }
        .d2h-code-line-ctn, .d2h-code-side-line-ctn {
            background-color: inherit;
        }
        .d2h-ins { background-color: rgba(34, 197, 94, 0.15); }
        .d2h-del { background-color: rgba(239, 68, 68, 0.15); }
        /* ✅ END: Activity Log Styles */

</style>
</head>
<body>
<!-- START: Version History Modal -->
<div class="modal-overlay hidden" id="versionHistoryModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Version History Details</h2>
            <button class="close-button" id="closeVersionHistoryModalBtn">×</button>
        </div>
        <div class="modal-body" id="versionHistoryBody">
            <p>Loading changes...</p>
        </div>
        <div class="modal-actions no-border">
            <button class="button-secondary" id="cancelVersionHistoryBtn">Close</button>
        </div>
    </div>
</div>
<!-- END: Version History Modal -->

<div class="modal-overlay hidden" id="addContentModalOverlay">
<div class="modal-content">
<div class="modal-header">
<h2 id="addContentModalTitle">Add New Content</h2>
<button aria-label="Close" class="close-button" id="closeAddContentModalBtn">×</button>
</div>
<form id="addContentForm">
<input id="editingItemId" type="hidden"/>
    <div class="form-group">
        <label for="contentType">Content Type</label>
        <select id="contentType">
            <option value="article">Article</option>
            <option value="case">Case</option>
            <option value="guide">Guide</option>
            <option value="policy">Policy</option>
        </select>
    </div>

    <!-- Bilingual Title and Description -->
    <div class="bilingual-form-grid">
        <div class="form-group">
            <label for="contentTitle_en">Title (English)</label>
            <input id="contentTitle_en" required type="text"/>
        </div>
        <div class="form-group" lang="ar">
            <label for="contentTitle_ar">العنوان (بالعربية)</label>
            <input id="contentTitle_ar" dir="rtl" type="text"/>
        </div>
    </div>
    <div class="bilingual-form-grid">
        <div class="form-group">
            <label for="contentSummary_en">Summary / Description (English)</label>
            <textarea id="contentSummary_en" required rows="3"></textarea>
        </div>
        <div class="form-group" lang="ar">
            <label for="contentSummary_ar">ملخص / وصف (بالعربية)</label>
            <textarea id="contentSummary_ar" dir="rtl" rows="3"></textarea>
        </div>
    </div>
    
    <!-- Bilingual Content Editors -->
    <div class="bilingual-form-grid">
        <div class="form-group" id="contentDetailContainer_en">
            <label for="quillEditor_en">Content (English)</label>
            <div id="quillEditor_en"></div> 
        </div>
        <div class="form-group" id="contentDetailContainer_ar" lang="ar">
            <label for="quillEditor_ar">المحتوى (بالعربية)</label>
            <div id="quillEditor_ar" dir="rtl"></div> 
        </div>
    </div>

    <div class="form-group">
        <label for="contentTags">Tags (comma-separated)</label>
        <input id="contentTags" placeholder="e.g., important, update, billing" type="text"/>
    </div>
    <div class="modal-actions">
        <button class="button" id="saveContentBtn" type="submit"><i class="fas fa-save"></i> Save Content</button>
        <button class="button-secondary" id="cancelAddContentBtn" type="button"><i class="fas fa-times"></i> Cancel</button>
    </div>
</form>
</div>
</div>

<!-- Logout Confirmation Modal -->
<div class="modal-overlay hidden" id="logoutConfirmModalOverlay">
<div class="modal-content" style="max-width: 28rem;">
<div class="modal-header">
<h2 id="logoutConfirmModalTitle">Confirm Logout</h2>
<button aria-label="Close" class="close-button" id="closeLogoutConfirmModalBtn">×</button>
</div>
<div class="modal-body">
<p>Are you sure you want to logout from InfiniBase?</p>
</div>
<div class="modal-actions no-border">
<button class="button button-danger" id="confirmLogoutBtn" type="button"><i class="fas fa-sign-out-alt"></i> Confirm Logout</button>
<button class="button-secondary" id="cancelLogoutBtn" type="button"><i class="fas fa-times"></i> Cancel</button>
</div>
</div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay hidden" id="deleteConfirmModalOverlay">
<div class="modal-content" style="max-width: 30rem;">
<div class="modal-header">
<h2 id="deleteConfirmModalTitle">Confirm Deletion</h2>
<button aria-label="Close" class="close-button" id="closeDeleteConfirmModalBtn">×</button>
</div>
<div class="modal-body">
<p id="deleteConfirmMessage">Are you sure you want to delete this item? This action cannot be undone.</p>
</div>
<div class="modal-actions no-border">
<button class="button button-danger" id="confirmDeleteItemBtn" type="button"><i class="fas fa-trash-alt"></i> Confirm Delete</button>
<button class="button-secondary" id="cancelDeleteItemBtn" type="button"><i class="fas fa-times"></i> Cancel</button>
</div>
</div>
</div>
<div class="container-fluid">
<aside class="sidebar" id="sidebar">
<div class="sidebar-header">
<i class="fas fa-database"></i> <span class="sidebar-logo-text">InfiniBase</span>
</div>
<nav class="sidebar-nav" id="navigationMenu">
</nav>
<div class="sidebar-footer">
<button class="button button-danger" id="logoutButton">
<i class="fas fa-sign-out-alt"></i> Logout
                </button>
<div id="userRoleDisplaySidebar" style="font-size: 0.8rem; color: var(--text-color-muted); text-align: center; margin-top: 0.5rem;">Role: <span id="currentUserRoleSpan"></span></div>
</div>
</aside>
<div class="content-wrapper" id="contentWrapper">
<header class="content-header">
<div class="header-left-content">
<button class="mobile-sidebar-toggle" id="mobileSidebarToggle"><i class="fas fa-bars"></i></button>
<div>
<h1 id="currentSectionTitle">Welcome</h1>
<div id="breadcrumbs">Home</div>
</div>
</div>
<div class="header-right-content">
<div class="search-container">
<span class="search-icon"><i class="fas fa-search"></i></span>
<input id="globalSearchInput" placeholder="Search the knowledge base..." type="search"/>
<div class="hidden" id="searchResultsContainer"></div>
</div>
<div class="user-profile" id="userProfileContainer">
<div id="userAvatar">U</div>
<span id="userNameDisplayHeader" style="font-weight: 500;">User</span>
</div>
</div>
</header>
<main class="p-6 md:p-8" id="pageContentArea">
<div class="hidden" id="dashboardOverviewContainer">
</div>
<div id="standardSectionContentPlaceholder">
</div>
<div class="hidden" id="itemDetailViewPlaceholder">
</div>
</main>
<footer class="mt-auto p-6 text-center text-sm">
<span>© <script>document.write(new Date().getFullYear())</script> InfiniBase.Elmenisy.</span>
</footer>
</div>
</div>
<div id="toastContainer"></div>

<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const supabase = createClient('https://aefiigottnlcmjzilqnh.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFlZmlpZ290dG5sY21qemlscW5oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcxNzY2MDQsImV4cCI6MjA2Mjc1MjYwNH0.FypB02v3tGMnxXV9ZmZMdMC0oQpREKOJWgHMPxUzwX4');

    // --- State and DOM Variables ---
    let kbSystemData = { sections: [] };
    let quillEditorEn, quillEditorAr;
    let currentUser = null;
    let currentOpenItem = null;
    let currentLanguage = 'en';
    const sidebar = document.getElementById('sidebar');
    const mobileSidebarToggle = document.getElementById('mobileSidebarToggle');
    const navigationMenu = document.getElementById('navigationMenu');
    const currentSectionTitleEl = document.getElementById('currentSectionTitle');
    const breadcrumbsContainer = document.getElementById('breadcrumbs');
    const pageContentArea = document.getElementById('pageContentArea');
    const dashboardOverviewContainer = document.getElementById('dashboardOverviewContainer');
    const standardSectionContentPlaceholder = document.getElementById('standardSectionContentPlaceholder');
    const itemDetailViewPlaceholder = document.getElementById('itemDetailViewPlaceholder');
    const userNameDisplayHeader = document.getElementById('userNameDisplayHeader');
    const userAvatar = document.getElementById('userAvatar');
    const currentUserRoleSpan = document.getElementById('currentUserRoleSpan');
    const addContentModalOverlay = document.getElementById('addContentModalOverlay');
    const closeAddContentModalBtn = document.getElementById('closeAddContentModalBtn');
    const addContentForm = document.getElementById('addContentForm');
    const cancelAddContentBtn = document.getElementById('cancelAddContentBtn');
    const editingItemIdInput = document.getElementById('editingItemId');
    const globalSearchInput = document.getElementById('globalSearchInput');
    const searchResultsContainer = document.getElementById('searchResultsContainer');
    const logoutButton = document.getElementById('logoutButton');
    const logoutConfirmModalOverlay = document.getElementById('logoutConfirmModalOverlay');
    const closeLogoutConfirmModalBtn = document.getElementById('closeLogoutConfirmModalBtn');
    const confirmLogoutBtn = document.getElementById('confirmLogoutBtn');
    const cancelLogoutBtn = document.getElementById('cancelLogoutBtn');
    const deleteConfirmModalOverlay = document.getElementById('deleteConfirmModalOverlay');
    const closeDeleteConfirmModalBtn = document.getElementById('closeDeleteConfirmModalBtn');
    const confirmDeleteItemBtn = document.getElementById('confirmDeleteItemBtn');
    const cancelDeleteItemBtn = document.getElementById('cancelDeleteItemBtn');
    const deleteConfirmMessage = document.getElementById('deleteConfirmMessage');
    const versionHistoryModal = document.getElementById('versionHistoryModal');
    const closeVersionHistoryModalBtn = document.getElementById('closeVersionHistoryModalBtn');
    const cancelVersionHistoryBtn = document.getElementById('cancelVersionHistoryBtn');
    const versionHistoryBody = document.getElementById('versionHistoryBody');

    // --- Utility Functions ---
    function escapeHTML(str) {
        if (typeof str !== 'string' || !str) return '';
        const el = document.createElement('div');
        el.textContent = str;
        return el.innerHTML;
    }
    function formatReadableDate(isoString) {
        if (!isoString) return 'N/A';
        return new Date(isoString).toLocaleString('en-GB', {
            day: '2-digit', month: 'short', year: 'numeric',
            hour: '2-digit', minute: '2-digit', hour12: true
        });
    }
    function truncateText(text, len) {
        if (!text || text.length <= len) return text;
        return text.substring(0, len) + '...';
    }
    function stripHtml(html){
       if (!html) return "";
       let tmp = document.createElement("DIV");
       tmp.innerHTML = html;
       return tmp.textContent || tmp.innerText || "";
    }
    function createSlug(text) {
        if (!text) return 'untitled';
        return text.toString().toLowerCase().trim()
            .replace(/\s+/g, '-')
            .replace(/&/g, '-and-')
            .replace(/[^\w\-]+/g, '')
            .replace(/\-\-+/g, '-');
    }
    function showToast(message, type = 'info', duration = 3000) {
        const toastContainer = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast-notification toast-${type}`;
        let iconClass = 'fas fa-info-circle';
        if (type === 'success') iconClass = 'fas fa-check-circle';
        else if (type === 'error') iconClass = 'fas fa-times-circle';
        toast.innerHTML = `<i class="toast-icon ${iconClass}"></i> <span>${escapeHTML(message)}</span>`;
        toastContainer.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, duration);
    }
    
    // --- Supabase Interaction Layer ---
    async function getCurrentUserProfile() {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return null;
        const { data: profile, error } = await supabase.from('users').select('*').eq('id', user.id).single();
        if (error) {
            console.error('Error fetching user profile:', error);
            return { id: user.id, email: user.email, role: 'viewer', name: user.email };
        }
        return profile;
    }
    async function logout() {
        await supabase.auth.signOut();
        window.location.href = 'index.html';
    }
    async function fetchSubCategories() {
        const { data, error } = await supabase.from('sub_categories').select('*').order('position');
        if (error) { console.error('Error fetching sub-categories:', error); return []; }
        return data;
    }
    async function fetchArticles() {
        const { data, error } = await supabase.from('cases').select(`*`).order('created_at', { ascending: false });
        if (error) { console.error('Error fetching articles:', error); return []; }
        return data;
    }
    async function saveToVersionHistory(itemBeforeUpdate, user) {
        if (!itemBeforeUpdate || !user) return;
        const { error } = await supabase.from('version_history').insert([{
            item_id: itemBeforeUpdate.id,
            title_en_before: itemBeforeUpdate.title_en,
            description_en_before: itemBeforeUpdate.description_en,
            content_en_before: itemBeforeUpdate.content_en,
            title_ar_before: itemBeforeUpdate.title_ar,
            description_ar_before: itemBeforeUpdate.description_ar,
            content_ar_before: itemBeforeUpdate.content_ar,
            modified_by_id: user.id,
            modified_by_name: user.name
        }]);
        if (error) console.error("Error saving to version history:", error);
    }
    
    // --- Core Application Logic ---
    async function loadAndStructureData() {
        const [categories, articles] = await Promise.all([ fetchSubCategories(), fetchArticles() ]);
        const sections = categories.map(cat => ({
            ...cat, 
            slug: createSlug(cat.name),
            items: []
        }));
        articles.forEach(article => {
            const parentSection = sections.find(s => s.id === article.sub_category_id);
            if (parentSection) {
                parentSection.items.push({ ...article, slug: createSlug(article.title_en) });
            }
        });
        kbSystemData.sections = sections;
    }

    function populateSidebar() {
        let menuHTML = '';
        const homeSection = { id: 'home', name: 'Dashboard', icon: 'fas fa-home', slug: 'home' };
        menuHTML += `<div class="sidebar-section-title">MAIN</div>
                     <a href="#${homeSection.slug}" class="sidebar-link" data-section-slug="${homeSection.slug}">
                         <i class="${homeSection.icon}"></i>${escapeHTML(homeSection.name)}
                     </a>`;

        const sectionsFromDB = kbSystemData.sections;
        if (sectionsFromDB.length > 0) {
            menuHTML += `<div class="sidebar-section-title">KNOWLEDGE AREAS</div>`;
            sectionsFromDB.forEach(section => {
                const iconStyle = section.color ? `style="color: ${section.color};"` : '';
                menuHTML += `<a href="#${section.slug}" class="sidebar-link" data-section-slug="${section.slug}">
                    <i class="${section.icon || 'fas fa-folder'}" ${iconStyle}></i>${escapeHTML(section.name)}
                </a>`;
            });
        }
        navigationMenu.innerHTML = menuHTML;
    }

    function highlightSidebarLink(sectionSlug) {
        document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
        const activeLink = document.querySelector(`.sidebar-link[data-section-slug="${sectionSlug}"]`);
        if (activeLink) activeLink.classList.add('active');
    }

    function renderItemCard(item, sectionData) {
        let itemIconClass = 'fas fa-file-alt';
        if (item.type === 'case') itemIconClass = 'fas fa-briefcase';
        
        const isAdmin = currentUser?.role === 'admin';
        const viewButton = `<a href="#${sectionData.slug}/${item.slug}" class="button button-secondary" title="View Item"><i class="fas fa-eye"></i> View</a>`;
        const editButton = isAdmin ? `<button class="button button-secondary" onclick="event.stopPropagation(); window.openEditModal('${sectionData.id}', '${item.id}')" title="Edit Item"><i class="fas fa-edit"></i> Edit</button>` : '';
        const deleteButton = isAdmin ? `<button class="button button-danger" onclick="event.stopPropagation(); window.openDeleteModal('${sectionData.id}', '${item.id}', '${escapeHTML(item.title_en)}')" title="Delete Item"><i class="fas fa-trash-alt"></i></button>` : '';
        
        const tagsHTML = item.tags && item.tags.length > 0
            ? `<div class="card-tags">${item.tags.map(tag => `<span class="tag">${escapeHTML(tag)}</span>`).join('')}</div>`
            : '';
        
        return `
            <div class="card" data-item-id="${item.id}" data-section-id="${sectionData.id}">
                <div class="card-header-icon">
                    <div class="card-icon-container"><i class="${itemIconClass}"></i></div>
                    <div class="card-title-group"><h3>${escapeHTML(item.title_en)}</h3></div>
                </div>
                ${tagsHTML}
                <p>${escapeHTML(truncateText(stripHtml(item.description_en), 120))}</p>
                <div class="card-actions">${viewButton}${editButton}${deleteButton}</div>
            </div>`;
    }

    function displaySectionContent(sectionSlug) {
        currentOpenItem = null;
        dashboardOverviewContainer.classList.add('hidden');
        standardSectionContentPlaceholder.classList.remove('hidden');
        itemDetailViewPlaceholder.classList.add('hidden');

        const sectionData = kbSystemData.sections.find(s => s.slug === sectionSlug);
        if (!sectionData) { return; }

        currentSectionTitleEl.textContent = sectionData.name;
        breadcrumbsContainer.innerHTML = `<a href="#home">Home</a> &gt; <span>${escapeHTML(sectionData.name)}</span>`;

        let contentHTML = `<div>`;
        if (currentUser?.role === 'admin') {
             contentHTML += `<div style="text-align: right; margin-bottom: 1.5rem;">
                <button id="openAddContentBtnInSection" class="button" data-section-id="${sectionData.id}">
                    <i class="fas fa-plus-circle"></i> Add Content to ${escapeHTML(sectionData.name)}
                </button>
            </div>`;
        }

        const itemsToDisplay = (sectionData.items || []);
        if (itemsToDisplay.length > 0) {
            contentHTML += `<div class="cards-grid">`;
            itemsToDisplay.forEach(item => contentHTML += renderItemCard(item, sectionData));
            contentHTML += `</div>`;
        } else {
             contentHTML += `<div class="card" style="text-align: center;"><p>No content in this section yet.</p></div>`;
        }
        contentHTML += `</div>`;
        standardSectionContentPlaceholder.innerHTML = contentHTML;

        document.getElementById('openAddContentBtnInSection')?.addEventListener('click', (e) => {
            openAddContentModal(e.currentTarget.dataset.sectionId);
        });
    }
    
    function findItem(itemId) {
        for (const section of kbSystemData.sections) {
            const item = section.items?.find(i => i.id == itemId); // Use == for type flexibility
            if (item) return { ...item, sectionId: section.id, sectionSlug: section.slug };
        }
        return null;
    }

    function findItemBySlug(sectionSlug, itemSlug) {
        const section = kbSystemData.sections.find(s => s.slug === sectionSlug);
        if (section) {
            const item = section.items.find(i => i.slug === itemSlug);
            if (item) return { ...item, sectionId: section.id, sectionSlug: section.slug };
        }
        return null;
    }
    
    async function displayItemDetail(sectionSlug, itemSlug) {
        let itemData = findItemBySlug(sectionSlug, itemSlug);
        if (!itemData) { return; }
        
        currentLanguage = 'en'; // Reset to English every time an item is opened
        currentOpenItem = { sectionId: itemData.sectionId, itemId: itemData.id, title: itemData.title_en };
        dashboardOverviewContainer.classList.add('hidden');
        standardSectionContentPlaceholder.classList.add('hidden');
        
        breadcrumbsContainer.innerHTML = `
            <a href="#home">Home</a> &gt; <a href="#${itemData.sectionSlug}">${escapeHTML(itemData.sectionSlug.replace(/-/g, ' '))}</a> &gt; 
            <span>${escapeHTML(itemData.title_en)}</span>`;
        currentSectionTitleEl.textContent = itemData.title_en;

        const lastModified = new Date(itemData.last_modified || itemData.created_at);
        const lastUpdatedHTML = `<div class="last-updated-info">
            Last updated by <strong>${escapeHTML(itemData.last_modified_by_name || 'System')}</strong> on ${lastModified.toLocaleDateString('en-GB', { year: 'numeric', month: 'long', day: 'numeric' })}
        </div>`;
            
        let detailHTML = `<div class="item-actions-bar">
            <a href="#${sectionSlug}" class="button button-secondary"><i class="fas fa-arrow-left"></i> Back to Section</a>`;
        if (currentUser?.role === 'admin') {
             detailHTML += `<button id="editItemBtn" class="button"><i class="fas fa-edit"></i> Edit</button>
                            <button id="deleteItemBtn" class="button button-danger"><i class="fas fa-trash-alt"></i> Delete</button>`;
        }
        detailHTML += `<div style="margin-left:auto;"><button id="langToggleBtn" class="button-secondary"><i class="fas fa-language"></i> العربية</button></div></div>`;
        
        detailHTML += `<div class="card bilingual-content show-en">
            <div lang="en">
                <h2>${escapeHTML(itemData.title_en)}</h2>
                <p><em>${escapeHTML(stripHtml(itemData.description_en))}</em></p>
                <hr class="title-content-divider">${lastUpdatedHTML}
                <div class="kb-content">${itemData.content_en || '<p>No content available in English.</p>'}</div>
            </div>
            <div lang="ar" dir="rtl">
                <h2>${escapeHTML(itemData.title_ar || itemData.title_en)}</h2>
                <p><em>${escapeHTML(stripHtml(itemData.description_ar || itemData.description_en))}</em></p>
                <hr class="title-content-divider">${lastUpdatedHTML}
                <div class="kb-content">${itemData.content_ar || '<p>لا يوجد محتوى باللغة العربية.</p>'}</div>
            </div>
        </div>`;

        if (currentUser?.role === 'admin') {
            detailHTML += `<div class="activity-log-section">
                <div class="activity-log-header"><h4><i class="fas fa-history"></i> Activity Log</h4></div>
                <div class="activity-log-body" id="activityLogBody"><p style="text-align:center; padding: 1rem;">Loading activity...</p></div>
            </div>`;
        }

        itemDetailViewPlaceholder.innerHTML = detailHTML;
        itemDetailViewPlaceholder.classList.remove('hidden');

        if (currentUser?.role === 'admin') {
            renderActivityLog(itemData.id);
        }
    }
    
    async function renderActivityLog(itemId) {
        const logBody = document.getElementById('activityLogBody');
        const { data, error } = await supabase.from('version_history')
            .select('*').eq('item_id', itemId).order('modified_at', { ascending: false });
        
        if (error || !data || data.length === 0) { 
            logBody.innerHTML = `<p style="text-align:center; padding: 1rem;">No modification history found.</p>`; 
            return; 
        }
        
        logBody.innerHTML = data.map(log => `
            <div class="activity-item">
                <i class="fas fa-edit activity-icon"></i>
                <div class="activity-details">
                    <div class="activity-meta">
                        <span class="activity-author">${escapeHTML(log.modified_by_name || 'Unknown User')}</span>
                        <span class="activity-timestamp">${formatReadableDate(log.modified_at)}</span>
                    </div>
                    <button class="button button-secondary activity-view-changes-btn" data-history-id="${log.id}">View Changes</button>
                </div>
            </div>
        `).join('');
    }

    async function showVersionDiff(historyId) {
        versionHistoryBody.innerHTML = '<p>Loading changes...</p>';
        versionHistoryModal.classList.remove('hidden');

        const { data: log, error } = await supabase.from('version_history').select('*').eq('id', historyId).single();
        if (error || !log) { versionHistoryBody.innerHTML = `<p>Error loading history entry.</p>`; return; }

        const { data: nextVersion } = await supabase.from('version_history')
            .select('title_en_before, content_en_before, title_ar_before, content_ar_before')
            .eq('item_id', log.item_id)
            .gt('modified_at', log.modified_at)
            .order('modified_at', { ascending: true }).limit(1).single();

        let currentItemState;
        if (nextVersion) {
            currentItemState = { 
                title_en: nextVersion.title_en_before, content_en: nextVersion.content_en_before,
                title_ar: nextVersion.title_ar_before, content_ar: nextVersion.content_ar_before
            };
        } else {
            const { data } = await supabase.from('cases').select('title_en, content_en, title_ar, content_ar').eq('id', log.item_id).single();
            currentItemState = data;
        }

        const oldContent = `Title EN: ${log.title_en_before || ''}\n\n${stripHtml(log.content_en_before || '')}\n\nTitle AR: ${log.title_ar_before || ''}\n\n${stripHtml(log.content_ar_before || '')}`;
        const newContent = `Title EN: ${currentItemState.title_en || ''}\n\n${stripHtml(currentItemState.content_en || '')}\n\nTitle AR: ${currentItemState.title_ar || ''}\n\n${stripHtml(currentItemState.content_ar || '')}`;

        const diffString = Diff.createPatch('changes.txt', oldContent, newContent);
        const diffHtml = Diff2Html.html(diffString, { drawFileList: false, matching: 'lines', outputFormat: 'side-by-side' });
        
        versionHistoryBody.innerHTML = diffHtml;
    }

    function initializeQuill(selector, placeholder) {
        Quill.register('modules/imageResize', window.ImageResize.default);
        const toolbarOptions = [
            [{ 'header': [1, 2, 3, false] }],
            ['bold', 'italic', 'underline', 'strike'],
            [{'list': 'ordered'}, {'list': 'bullet'}],
            ['link', 'image'],
            [{ 'align': [] }],
            ['clean']
        ];
        return new Quill(selector, {
            theme: 'snow',
            modules: { toolbar: toolbarOptions, imageResize: {} },
            placeholder: placeholder
        });
    }

    function openAddContentModal(sectionIdForContent, itemToEdit = null) {
        addContentForm.reset();
        addContentForm.dataset.sectionId = sectionIdForContent;
        editingItemIdInput.value = ""; 
        
        if (!quillEditorEn) quillEditorEn = initializeQuill('#quillEditor_en', 'Enter English content...');
        if (!quillEditorAr) quillEditorAr = initializeQuill('#quillEditor_ar', 'أدخل المحتوى بالعربية...');
        
        quillEditorEn.setContents([{ insert: '\n' }]);
        quillEditorAr.setContents([{ insert: '\n' }]);

        if (itemToEdit) {
            document.getElementById('addContentModalTitle').textContent = 'Edit Content';
            editingItemIdInput.value = itemToEdit.id;
            document.getElementById('contentTitle_en').value = itemToEdit.title_en;
            document.getElementById('contentTitle_ar').value = itemToEdit.title_ar;
            document.getElementById('contentSummary_en').value = itemToEdit.description_en;
            document.getElementById('contentSummary_ar').value = itemToEdit.description_ar;
            document.getElementById('contentType').value = itemToEdit.type;
            document.getElementById('contentTags').value = (itemToEdit.tags || []).join(', ');
            if (itemToEdit.content_en) quillEditorEn.clipboard.dangerouslyPasteHTML(0, itemToEdit.content_en);
            if (itemToEdit.content_ar) quillEditorAr.clipboard.dangerouslyPasteHTML(0, itemToEdit.content_ar);
        } else {
            document.getElementById('addContentModalTitle').textContent = 'Add New Content';
        }
        
        addContentModalOverlay.classList.remove('hidden');
    }

    addContentForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const sectionId = addContentForm.dataset.sectionId;
        const editingId = editingItemIdInput.value;
        let itemBeforeUpdate = null;

        if (editingId) {
            const { data } = await supabase.from('cases').select('*').eq('id', editingId).single();
            itemBeforeUpdate = data;
        }

        const itemData = {
            title_en: document.getElementById('contentTitle_en').value.trim(),
            title_ar: document.getElementById('contentTitle_ar').value.trim(),
            description_en: document.getElementById('contentSummary_en').value.trim(),
            description_ar: document.getElementById('contentSummary_ar').value.trim(),
            content_en: quillEditorEn.root.innerHTML,
            content_ar: quillEditorAr.root.innerHTML,
            tags: document.getElementById('contentTags').value.split(',').map(t => t.trim()).filter(Boolean),
            type: document.getElementById('contentType').value,
            sub_category_id: sectionId,
            last_modified: new Date().toISOString(),
            last_modified_by: currentUser.id,
            last_modified_by_name: currentUser.name,
            slug: createSlug(document.getElementById('contentTitle_en').value.trim())
        };

        if (!itemData.title_en || !itemData.description_en) { showToast('English Title and Summary are required.', 'error'); return; }
        if (editingId) itemData.id = editingId;
        
        const { data: savedItem, error } = await supabase.from('cases').upsert(itemData).select().single();
        if (error) { showToast(`Failed to save: ${error.message}`, 'error'); return; }
        
        if (editingId && itemBeforeUpdate) {
            await saveToVersionHistory(itemBeforeUpdate, currentUser);
        }
        
        showToast(`Content '${savedItem.title_en}' saved successfully!`, 'success');
        addContentModalOverlay.classList.add('hidden');
        await loadAndStructureData();
        handleNavigation(); // Refresh the view
    });
    
    function handleNavigation() {
        if (!currentUser) return;
        const hash = window.location.hash.substring(1) || 'home';
        const [sectionSlug, itemSlug] = hash.split('/');
        highlightSidebarLink(sectionSlug);
        
        if (sectionSlug === 'home' || !sectionSlug) {
             dashboardOverviewContainer.innerHTML = `<div class="card" style="text-align: center;"><h2>Welcome to the Dashboard</h2><p>Select a knowledge area from the sidebar to begin.</p></div>`;
             dashboardOverviewContainer.classList.remove('hidden');
             standardSectionContentPlaceholder.classList.add('hidden');
             itemDetailViewPlaceholder.classList.add('hidden');
             currentSectionTitleEl.textContent = 'Dashboard';
             breadcrumbsContainer.innerHTML = 'Home';
        } else if (itemSlug) {
             displayItemDetail(sectionSlug, itemSlug);
        } else {
             displaySectionContent(sectionSlug);
        }
        document.getElementById('contentWrapper')?.scrollTo(0,0);
    }
    
    // --- Event Listeners ---
    pageContentArea.addEventListener('click', (e) => {
        const langToggleBtn = e.target.closest('#langToggleBtn');
        if (langToggleBtn) {
            const contentContainer = document.querySelector('.bilingual-content');
            if (currentLanguage === 'en') {
                contentContainer.classList.replace('show-en', 'show-ar');
                langToggleBtn.innerHTML = '<i class="fas fa-language"></i> English';
                currentLanguage = 'ar';
            } else {
                contentContainer.classList.replace('show-ar', 'show-en');
                langToggleBtn.innerHTML = '<i class="fas fa-language"></i> العربية';
                currentLanguage = 'en';
            }
            return;
        }

        const viewChangesBtn = e.target.closest('.activity-view-changes-btn');
        if (viewChangesBtn) {
            showVersionDiff(viewChangesBtn.dataset.historyId);
            return;
        }

        if (e.target.id === 'editItemBtn') {
            const item = findItem(currentOpenItem.itemId);
            openAddContentModal(item.sub_category_id, item);
        }
        if (e.target.id === 'deleteItemBtn') {
            const item = findItem(currentOpenItem.itemId);
            window.openDeleteModal(item.sub_category_id, item.id, item.title_en);
        }
    });

    async function initializeApp() {
        currentUser = await getCurrentUserProfile();
        if (!currentUser) { window.location.href = "login.html"; return; }
        
        userNameDisplayHeader.textContent = currentUser.name;
        userAvatar.textContent = (currentUser.name || 'U').charAt(0).toUpperCase();
        currentUserRoleSpan.textContent = currentUser.role;
        
        await loadAndStructureData();
        populateSidebar();
        handleNavigation();
        window.addEventListener('hashchange', handleNavigation);
        
        logoutButton.addEventListener('click', () => logoutConfirmModalOverlay.classList.remove('hidden'));
        [closeLogoutConfirmModalBtn, cancelLogoutBtn].forEach(btn => btn.addEventListener('click', () => logoutConfirmModalOverlay.classList.add('hidden')));
        confirmLogoutBtn.addEventListener('click', logout);
        
        [closeAddContentModalBtn, cancelAddContentBtn].forEach(btn => btn.addEventListener('click', () => addContentModalOverlay.classList.add('hidden')));
        [closeDeleteConfirmModalBtn, cancelDeleteItemBtn].forEach(btn => btn.addEventListener('click', () => deleteConfirmModalOverlay.classList.add('hidden')));
        [closeVersionHistoryModalBtn, cancelVersionHistoryBtn].forEach(btn => btn.addEventListener('click', () => versionHistoryModal.classList.add('hidden')));

        showToast(`Welcome back, ${currentUser.name}!`, 'success');
    }
    
    window.openEditModal = (sectionId, itemId) => {
        const item = findItem(itemId);
        if (item) openAddContentModal(sectionId, item);
    };
    window.openDeleteModal = (sectionId, itemId, itemTitle) => {
        deleteConfirmMessage.innerHTML = `Are you sure you want to delete "<strong>${escapeHTML(itemTitle)}</strong>"? This action cannot be undone.`;
        confirmDeleteItemBtn.dataset.itemId = itemId;
        deleteConfirmModalOverlay.classList.remove('hidden');
    };
    
    confirmDeleteItemBtn.addEventListener('click', async (e) => {
        const itemId = e.currentTarget.dataset.itemId;
        const { error } = await supabase.from('cases').delete().eq('id', itemId);
        if (error) { showToast(`Error: ${error.message}`, 'error'); return; }
        showToast(`Item deleted.`, 'success');
        deleteConfirmModalOverlay.classList.add('hidden');
        await loadAndStructureData();
        window.location.hash = `#home`; // Navigate to home after deletion
    });

    initializeApp();
</script>
</body>
</html>

