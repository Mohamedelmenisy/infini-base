<!DOCTYPE html>
<html class="dark" data-hash="2025-06-24T15:30" dir="ltr" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale-1.0" name="viewport"/>
    <title>InfiniBase - Command Center</title>
    
    <!-- Poppins Font for English & Cairo for Arabic -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Favicon -->
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    
    <!-- CDNs -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet"/>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet"/>
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quill-image-resize-module@3.0.0/image-resize.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/spotlight.js/dist/css/spotlight.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/spotlight.js/dist/js/spotlight.min.js" defer></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css" />
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js"></script>
    
    <!-- Main Stylesheet -->
    <style>
        /* --- 1. UNIFIED Global Styles & Theme Variables --- */
        :root {
            --bg-dark: #0F1015;
            --bg-card: #1A1C23;
            --bg-header: #21242D;
            --primary-accent: #6C5DD3;
            --primary-accent-light: #8374FF;
            --secondary-accent: #3F8CFF;
            --text-light: #F5F5F5;
            --text-muted: #9CA3B3;
            --border-color: #2A2D38;
            --success: #00B69B;
            --warning: #FFC454;
            --danger: #FF6A55;
            --font-family: 'Poppins', sans-serif;
            --border-radius: 16px;
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            --shadow-hover: 0 8px 30px rgba(0, 0, 0, 0.25);
            --gradient-primary: linear-gradient(135deg, #6C5DD3 0%, #8374FF 100%);
            --sidebar-width: 280px;
            --header-height: 70px;
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        
        body {
            font-family: var(--font-family);
            background-color: var(--bg-dark);
            color: var(--text-light);
            line-height: 1.6;
            font-size: 16px;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(108, 93, 211, 0.05) 0%, transparent S20%),
                radial-gradient(circle at 90% 80%, rgba(63, 140, 255, 0.05) 0%, transparent 20%);
        }
        
        [lang='ar'] {
            font-family: 'Cairo', sans-serif;
            direction: rtl;
        }

        /* --- Custom Scrollbars --- */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: var(--primary-accent); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary-accent-light); }

        /* --- Main Layout --- */
        .container-fluid { display: flex; min-height: 100vh; }

        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-card);
            padding: 1.5rem;
            border-right: 1px solid var(--border-color);
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            overflow-y: auto;
            transition: transform 0.3s ease-in-out;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }
        
        .content-wrapper {
            flex-grow: 1;
            padding: 2rem;
            transition: margin-left 0.3s ease-in-out;
            height: 100vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        @media (min-width: 768px) {
             .content-wrapper { margin-left: var(--sidebar-width); }
        }
        
        /* --- Sidebar Styles --- */
        .sidebar-header {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 2.5rem;
            display: flex;
            align-items: center;
            color: var(--text-light);
        }
        .sidebar-header img { height: 40px; margin-right: 12px; }
        .sidebar-nav { flex-grow: 1; }
        .sidebar-section-title {
            padding-left: 0.75rem; font-size: 0.8rem; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.05em;
            margin-top: 2rem; margin-bottom: 0.75rem; color: var(--text-muted);
        }
        .sidebar-link {
            display: flex; align-items: center; padding: 0.85rem; border-radius: 12px;
            transition: var(--transition); font-weight: 500; color: var(--text-muted);
            text-decoration: none; margin-bottom: 0.25rem;
        }
        .sidebar-link i { margin-right: 1rem; width: 24px; font-size: 1.1rem; text-align: center; }
        .sidebar-link:hover { background-color: var(--bg-header); color: var(--text-light); }
        .sidebar-link.active {
            background: var(--primary-accent); color: white; font-weight: 600;
            box-shadow: 0 4px 15px rgba(108, 93, 211, 0.3);
        }
        .sidebar-footer { margin-top: auto; padding-top: 1.5rem; }

        /* --- Header Styles --- */
        .content-header {
            background-color: rgba(15, 16, 21, 0.7); /* bg-dark with transparency */
            padding: 0 2rem; border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; height: var(--header-height);
            z-index: 50; backdrop-filter: blur(10px);
        }
        #currentSectionTitle { font-size: 1.75rem; font-weight: 700; margin: 0; }
        #breadcrumbs { font-size: 0.875rem; color: var(--text-muted); }
        #breadcrumbs a { color: var(--primary-accent); text-decoration: none; }
        #breadcrumbs a:hover { text-decoration: underline; }
        .header-right-content { display: flex; align-items: center; gap: 1rem; }
        
        .admin-toolbar {
            display: flex; align-items: center; gap: 0.5rem;
            background-color: var(--bg-header); padding: 0.5rem;
            border-radius: 12px; border: 1px solid var(--border-color);
        }
        .admin-toolbar a {
            padding: 0.5rem 1rem; font-size: 0.875rem; font-weight: 500; color: var(--text-muted);
            text-decoration: none; border-radius: 8px; transition: var(--transition);
            display: flex; align-items: center; gap: 0.5rem;
        }
        .admin-toolbar a:hover { color: var(--text-light); background-color: var(--bg-card); }
        .admin-toolbar a.active {
            background-color: var(--primary-accent); color: white;
            box-shadow: 0 2px 10px rgba(108, 93, 211, 0.3);
        }

        .search-container input[type="search"] {
            padding: 0.75rem 1.25rem 0.75rem 2.75rem; border: 1px solid var(--border-color);
            border-radius: 12px; min-width: 300px; background-color: var(--bg-header);
            color: var(--text-light); transition: var(--transition);
        }
        .search-container input[type="search"]:focus {
            min-width: 350px; border-color: var(--primary-accent);
            box-shadow: 0 0 0 3px rgba(108, 93, 211, 0.2);
        }
        .search-container .search-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-muted); }

        .user-profile { display: flex; align-items: center; gap: 0.75rem; }
        #userAvatar {
            width: 40px; height: 40px; border-radius: 50%; background: var(--gradient-primary);
            color: white; display: flex; align-items: center; justify-content: center;
            font-weight: 600; font-size: 1rem;
        }

        /* --- Main Content & Cards --- */
        main { padding-top: 1.5rem; flex-grow: 1; }
        
        .card {
            background-color: var(--bg-card); border: 1px solid var(--border-color);
            border-radius: var(--border-radius); padding: 1.5rem; margin-bottom: 1.5rem;
            box-shadow: var(--shadow); transition: var(--transition);
            display: flex; flex-direction: column; position: relative;
        }
        .card:hover {
            transform: translateY(-5px); box-shadow: var(--shadow-hover);
            border-color: var(--primary-accent-light);
        }
        
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }
        
        /* --- Dashboard Specific Styles --- */
        .dashboard-stats-grid {
            display: grid; gap: 1.5rem;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        }
        .dashboard-main-grid {
            display: grid; gap: 1.5rem; grid-template-columns: 1fr; margin-top: 1.5rem;
        }
        @media(min-width: 1024px) { .dashboard-main-grid { grid-template-columns: 2fr 1fr; } }
        
        .dashboard-stat-card {
            padding: 1.5rem; display: flex; align-items: center; gap: 1rem;
        }
        .dashboard-stat-card .icon-container {
            font-size: 1.75rem; color: var(--primary-accent);
            background-color: rgba(108, 93, 211, 0.1);
            height: 60px; width: 60px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; flex-shrink: 0;
        }
        .dashboard-stat-card .stat-info .stat-value { font-size: 2.25rem; font-weight: 700; line-height: 1.2; }
        .dashboard-stat-card .stat-info .stat-label { font-size: 0.9rem; color: var(--text-muted); }

        .chart-container {
            position: relative; padding: 1.5rem; border-radius: var(--border-radius);
            background-color: var(--bg-card); border: 1px solid var(--border-color);
            height: 400px; display: flex; flex-direction: column;
        }
        .chart-container h3, #topUsersContainer h3 {
            font-size: 1.25rem; font-weight: 600; margin: 0 0 1.5rem 0;
            padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);
        }
        #topUsersContainer { height: 400px; }

        /* --- Activity Log Styles --- */
        #recentActivityContainer { padding: 1.5rem; }
        .activity-log-item { display: flex; align-items: center; gap: 1rem; padding: 1rem; border-radius: 12px; transition: var(--transition); }
        .activity-log-item:hover { background-color: var(--bg-header); }
        .activity-icon { font-size: 1.2rem; width: 24px; text-align: center; }
        .activity-details { flex-grow: 1; font-size: 0.9rem; color: var(--text-muted); }
        .activity-details .activity-user { font-weight: 600; color: var(--text-light); }
        .activity-details .activity-item-title { color: var(--primary-accent-light); font-weight: 500; }
        .activity-time { font-size: 0.8rem; color: var(--text-muted); white-space: nowrap; }
        .activity-pagination { display: flex; justify-content: center; margin-top: 1.5rem; gap: 0.5rem; }
        
        /* --- Top Users List Styles --- */
        .top-users-list { list-style: none; padding: 0; margin: 0; flex-grow: 1; overflow-y: auto; }
        .top-user-item { display: flex; align-items: center; justify-content: space-between; padding: 1rem; border-bottom: 1px solid var(--border-color); }
        .top-user-item:last-child { border-bottom: none; }
        .top-user-info { display: flex; align-items: center; gap: 1rem; }
        .top-user-rank { font-size: 0.9rem; font-weight: bold; color: var(--text-muted); width: 20px; text-align: center; }
        .top-user-name { font-weight: 500; }
        .top-user-views { font-size: 1rem; font-weight: 600; color: var(--primary-accent); background-color: rgba(108, 93, 211, 0.1); padding: 0.25rem 0.6rem; border-radius: 8px; }

        /* --- Utility & Other --- */
        .button, button {
            background-color: var(--primary-accent); color: white; border: 1px solid transparent;
            padding: 0.75rem 1.25rem; border-radius: 12px; cursor: pointer;
            font-size: 0.9rem; font-weight: 600; transition: var(--transition);
            text-decoration: none; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
        }
        .button:hover, button:hover { background-color: var(--primary-accent-light); }
        .button-secondary { background-color: var(--bg-header); color: var(--text-muted); border-color: var(--border-color); }
        .button-secondary:hover { background-color: var(--bg-card); color: var(--text-light); border-color: var(--primary-accent-light); }
        .button-danger { background-color: var(--danger); color: white; }
        .button-danger:hover { background-color: var(--danger-light); }
        .hidden { display: none !important; }

        /* ... (Modal, Toast, Responsive styles can be copied from other files as they are consistent) ... */
        .modal-overlay { position: fixed; inset: 0; background-color: rgba(15, 16, 21, 0.8); backdrop-filter: blur(10px); display: none; align-items: center; justify-content: center; padding: 1rem; z-index: 1000; }
        .modal-overlay:not(.hidden) { display: flex; }
        .modal-content { background: var(--bg-card); padding: 1.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow-hover); width: 100%; max-width: 48rem; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-header h2 { margin: 0; font-size: 1.5rem; }
        .modal-header .close-button { background: none; border: none; font-size: 1.5rem; color: var(--text-muted); cursor: pointer; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 12px; background-color: var(--bg-dark); color: var(--text-light); }
        .ql-toolbar { background: var(--bg-dark) !important; border-color: var(--border-color) !important; border-top-left-radius: 12px; border-top-right-radius: 12px; }
        .ql-container { background: var(--bg-header) !important; border-color: var(--border-color) !important; color: var(--text-light); min-height: 250px; border-bottom-left-radius: 12px; border-bottom-right-radius: 12px; }
        
        .restricted-notice { text-align: center; margin-top: 4rem; color: var(--text-light); background: var(--bg-card); padding: 2.5rem; border-radius: var(--border-radius); border: 1px solid var(--border-color); max-width: 600px; margin-left: auto; margin-right: auto; }
        .restricted-icon { font-size: 3rem; margin-bottom: 1rem; color: var(--danger); }

    </style>
</head>
<body id="pageBody">

<div class="container-fluid">
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="data:image/svg+xml,&lt;svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32' width='32' height='32'&gt;&lt;rect width='32' height='32' rx='4' fill='%236C5DD3'/&gt;&lt;text x='50%' y='55%' dominant-baseline='middle' text-anchor='middle' font-family='Arial, sans-serif' font-size='18' font-weight='bold' fill='white'&gt;IB&lt;/text&gt;&lt;/svg&gt;" alt="InfiniBase Logo">
            <span>InfiniBase</span>
        </div>
        <nav class="sidebar-nav" id="navigationMenu">
            <div id="sidebarLoader" style="padding: 1rem; text-align: center; color: var(--text-muted);">
                <i class="fas fa-spinner fa-spin"></i> Loading Areas...
            </div>
        </nav>
        <div class="sidebar-footer">
            <button class="button button-danger" id="logoutButton" style="width: 100%;">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
            <div id="userRoleDisplaySidebar" style="font-size: 0.8rem; color: var(--text-muted); text-align: center; margin-top: 1rem;">
                Role: <span id="currentUserRoleSpan"></span>
            </div>
        </div>
    </aside>
    
    <div class="content-wrapper" id="contentWrapper">
        <header class="content-header">
            <div class="header-left-content">
                <div>
                    <h1 id="currentSectionTitle">Welcome</h1>
                    <div id="breadcrumbs">Home</div>
                </div>
            </div>
            <div class="header-right-content">
                <div class="admin-toolbar hidden" id="adminToolbar">
                    <a href="#home" id="admin-link-dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                    <a href="insights.html" id="admin-link-insights"><i class="fas fa-chart-pie"></i> Insights</a>
                    <a href="employees.html" id="admin-link-employees"><i class="fas fa-users"></i> Employees</a>
                    <a href="audit.html" id="admin-link-audit"><i class="fas fa-history"></i> Audit Log</a>
                </div>
                <div class="search-container">
                    <span class="search-icon"><i class="fas fa-search"></i></span>
                    <input id="globalSearchInput" placeholder="Search the knowledge base..." type="search"/>
                </div>
                <div class="user-profile" id="userProfileContainer">
                    <div id="userAvatar">U</div>
                    <span id="userNameDisplayHeader" style="font-weight: 500;">User</span>
                </div>
            </div>
        </header>

        <main id="pageContentArea">
            <div class="hidden" id="dashboardOverviewContainer">
                <!-- Dashboard content will be populated by JavaScript -->
            </div>
            <div id="standardSectionContentPlaceholder">
                <!-- Section content (cards) will be populated by JavaScript -->
            </div>
            <div class="hidden" id="itemDetailViewPlaceholder">
                <!-- Item detail view will be populated by JavaScript -->
            </div>
        </main>
        
        <footer style="text-align: center; padding: 1.5rem; font-size: 0.9rem; color: var(--text-muted); border-top: 1px solid var(--border-color); margin-top: auto;">
            <span>© <script>document.write(new Date().getFullYear())</script> InfiniBase. Crafted by Elmenisy.</span>
        </footer>
    </div>
</div>

<!-- All Modals and Toasts will be placed here -->
<div id="toastContainer"></div>
<!-- ... (Rest of your modals HTML from the original file) ... -->
<div class="modal-overlay hidden" id="addContentModalOverlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="addContentModalTitle">Add New Content</h2>
            <button aria-label="Close" class="close-button" id="closeAddContentModalBtn">×</button>
        </div>
        <form id="addContentForm">
            <input id="editingItemId" type="hidden"/>
            <div class="form-group">
                <label for="contentType">Content Type</label>
                <select id="contentType">
                    <option value="article">Article</option>
                    <option value="case">Case</option>
                    <option value="form_sheet">Form/Sheet (Link)</option>
                    <option value="design">Design (Link)</option>
                    <option value="guide">Guide</option>
                    <option value="policy">Policy</option>
                </select>
            </div>
            <div class="form-group">
                <label for="contentTitle">Title</label>
                <input id="contentTitle" required="" type="text"/>
            </div>
            <div class="form-group">
                <label for="contentSummary">Summary / Description</label>
                <textarea id="contentSummary" required="" rows="3"></textarea>
            </div>
            <div class="form-group hidden" id="contentUrlContainer">
                <label for="contentUrl">Link (for Forms, Designs, etc.)</label>
                <input id="contentUrl" type="url"/>
            </div>
            <div class="form-group" id="contentDetailContainer">
                <label for="contentDetail" id="contentDetailLabel">Details / Content</label>
                <div id="quillEditor"></div>
            </div>
            <div class="form-group">
                <label for="contentTags">Tags (comma-separated)</label>
                <input id="contentTags" placeholder="e.g., important, update, billing" type="text"/>
            </div>
            <div class="modal-actions">
                <button class="button-secondary" id="cancelAddContentBtn" type="button">Cancel</button>
                <button class="button" id="saveContentBtn" type="submit">Save Content</button>
            </div>
        </form>
    </div>
</div>
<div class="modal-overlay hidden" id="logoutConfirmModalOverlay">
    <div class="modal-content" style="max-width: 28rem; text-align: center;">
        <div class="modal-header" style="justify-content: center; border: none;"><h2>Confirm Logout</h2></div>
        <p>Are you sure you want to logout?</p>
        <div class="modal-actions" style="justify-content: center; gap: 1rem;">
            <button class="button-secondary" id="cancelLogoutBtn">Cancel</button>
            <button class="button button-danger" id="confirmLogoutBtn">Logout</button>
        </div>
    </div>
</div>
<div class="modal-overlay hidden" id="deleteConfirmModalOverlay">
    <div class="modal-content" style="max-width: 28rem; text-align: center;">
         <div style="font-size: 3rem; color: var(--danger); margin-bottom: 1rem;"><i class="fas fa-exclamation-triangle"></i></div>
        <h2>Confirm Deletion</h2>
        <p id="deleteConfirmMessage" style="color: var(--text-muted); margin-bottom: 1.5rem;"></p>
        <div class="modal-actions" style="justify-content: center; gap: 1rem;">
            <button class="button-secondary" id="cancelDeleteItemBtn">Cancel</button>
            <button class="button button-danger" id="confirmDeleteItemBtn">Yes, Delete</button>
        </div>
    </div>
</div>

<script type="module">
    import { supabase } from './supabase.js';

    let currentUser = null;
    let kbSystemData = { sections: [] };
    let mainQuillEditor;
    let activityChartInstance;
    let dashboardData = {};
    let activityLogPage = 1;
    const ACTIVITY_LOG_PAGE_SIZE = 5;

    // UI Element Cache
    const UI = {
        sidebar: document.getElementById('sidebar'),
        navigationMenu: document.getElementById('navigationMenu'),
        currentSectionTitle: document.getElementById('currentSectionTitle'),
        breadcrumbs: document.getElementById('breadcrumbs'),
        dashboardContainer: document.getElementById('dashboardOverviewContainer'),
        sectionContainer: document.getElementById('standardSectionContentPlaceholder'),
        itemContainer: document.getElementById('itemDetailViewPlaceholder'),
        userNameDisplay: document.getElementById('userNameDisplayHeader'),
        userAvatar: document.getElementById('userAvatar'),
        userRoleDisplay: document.getElementById('currentUserRoleSpan'),
        adminToolbar: document.getElementById('adminToolbar'),
        addContentModal: document.getElementById('addContentModalOverlay'),
        addContentForm: document.getElementById('addContentForm'),
        editingItemId: document.getElementById('editingItemId'),
        contentType: document.getElementById('contentType'),
        contentUrlContainer: document.getElementById('contentUrlContainer'),
        contentDetailContainer: document.getElementById('contentDetailContainer'),
        contentTitle: document.getElementById('contentTitle'),
        contentSummary: document.getElementById('contentSummary'),
        contentTags: document.getElementById('contentTags'),
        contentUrl: document.getElementById('contentUrl'),
        logoutModal: document.getElementById('logoutConfirmModalOverlay'),
        deleteModal: document.getElementById('deleteConfirmModalOverlay'),
        deleteMessage: document.getElementById('deleteConfirmMessage'),
        confirmDeleteBtn: document.getElementById('confirmDeleteItemBtn'),
    };

    function escapeHTML(str) {
        if (typeof str !== 'string' && typeof str !== 'number') return '';
        const el = document.createElement('div');
        el.textContent = str;
        return el.innerHTML;
    }

    function showToast(message, type = 'info', duration = 3000) {
        const toastContainer = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast-notification toast-${type}`;
        let iconClass = 'fas fa-info-circle';
        if (type === 'success') iconClass = 'fas fa-check-circle';
        else if (type === 'error' || type === 'danger') iconClass = 'fas fa-times-circle';
        toast.innerHTML = `<i class="toast-icon ${iconClass}"></i> <span>${escapeHTML(message)}</span>`;
        toastContainer.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, duration);
    }
    
    function createSlug(text) {
        if (!text) return 'untitled-' + Date.now();
        return text.toString().toLowerCase().trim()
            .replace(/\s+/g, '-').replace(/&/g, '-and-')
            .replace(/[^\w\-]+/g, '').replace(/\-\-+/g, '-');
    }

    async function loadAndStructureData() {
        const [{ data: categories, error: catError }, { data: articles, error: artError }] = await Promise.all([
            supabase.from('sub_categories').select('*').order('position'),
            supabase.from('cases').select('*').eq('is_published', true).order('created_at', { ascending: false })
        ]);

        if (catError || artError) {
            console.error('Data loading error:', catError || artError);
            showToast('Failed to load knowledge base data.', 'error');
            return;
        }

        const sections = categories.map(cat => ({ ...cat, slug: createSlug(cat.name), items: [] }));
        articles.forEach(article => {
            const parent = sections.find(s => s.id === article.sub_category_id);
            if (parent) {
                article.slug = article.slug || createSlug(article.title_en);
                parent.items.push(article);
            }
        });
        kbSystemData.sections = sections;
    }

    function populateSidebar() {
        let menuHTML = `<div class="sidebar-section-title">MAIN</div>
            <a href="#home" class="sidebar-link" data-section-slug="home"><i class="fas fa-home"></i>Home</a>`;
        
        const grouped = kbSystemData.sections.reduce((acc, sec) => {
            const group = sec.section_id || 'knowledge_base';
            if (!acc[group]) acc[group] = [];
            acc[group].push(sec);
            return acc;
        }, {});

        const titles = { 'knowledge_base': 'Knowledge Areas', 'policies_procedures': 'Policies & Procedures' };
        
        for (const key in titles) {
            if (grouped[key]) {
                menuHTML += `<div class="sidebar-section-title">${titles[key]}</div>`;
                grouped[key].forEach(sec => {
                    menuHTML += `<a href="#${sec.slug}" class="sidebar-link" data-section-slug="${sec.slug}">
                        <i class="${sec.icon || 'fas fa-folder'}"></i>${escapeHTML(sec.name)}
                    </a>`;
                });
            }
        }
        UI.navigationMenu.innerHTML = menuHTML;
    }
    
    function highlightSidebarLink(slug) {
        document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
        const activeLink = document.querySelector(`.sidebar-link[data-section-slug="${slug}"]`);
        if (activeLink) activeLink.classList.add('active');
    }

    function updateAdminToolbar(page) {
        document.querySelectorAll('.admin-toolbar a').forEach(link => link.classList.remove('active'));
        const activeLink = document.getElementById(`admin-link-${page}`);
        if(activeLink) activeLink.classList.add('active');
    }

    function renderItemCard(item, section) {
        const isAdmin = ['admin', 'manager'].includes(currentUser?.role);
        const actions = isAdmin ? `
            <div class="card-actions">
                <button class="button" onclick="event.stopPropagation(); window.openEditModal('${section.id}', '${item.id}')" title="Edit"><i class="fas fa-edit"></i></button>
                <button class="button button-danger" onclick="event.stopPropagation(); window.openDeleteModal('${item.id}', '${escapeHTML(item.title_en)}')" title="Delete"><i class="fas fa-trash-alt"></i></button>
            </div>` : '';

        return `
            <div class="card" onclick="window.location.hash='#${section.slug}/${item.slug}'" style="cursor: pointer;">
                <h3>${escapeHTML(item.title_en)}</h3>
                <p>${escapeHTML((item.description_en || '').substring(0, 120))}${item.description_en.length > 120 ? '...' : ''}</p>
                ${actions}
            </div>`;
    }
    
    function renderDashboardCharts(data) {
        const rootStyles = getComputedStyle(document.documentElement);
        const chartColors = {
            legend: rootStyles.getPropertyValue('--text-light').trim(),
            ticks: rootStyles.getPropertyValue('--text-muted').trim(),
            grid: rootStyles.getPropertyValue('--border-color').trim(),
            primary: rootStyles.getPropertyValue('--primary-accent').trim(),
            primaryTransparent: 'rgba(108, 93, 211, 0.2)',
            secondary: rootStyles.getPropertyValue('--success').trim(),
            secondaryTransparent: 'rgba(0, 182, 155, 0.2)',
        };

        if (activityChartInstance) activityChartInstance.destroy();
        const ctx = document.getElementById('activityChart')?.getContext('2d');
        if (!ctx || !data.weeklyActivity?.length) return;

        const labels = data.weeklyActivity.map(d => new Date(d.activity_date_egypt).toLocaleDateString('en-US', { month: 'short', day: 'numeric'}));
        
        activityChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels,
                datasets: [
                  {
                    label: 'Total Views',
                    data: data.weeklyActivity.map(d => d.total_views),
                    borderColor: chartColors.primary,
                    backgroundColor: chartColors.primaryTransparent,
                    yAxisID: 'y',
                    tension: 0.4,
                    fill: true
                  },
                  {
                    label: 'Active Users',
                    data: data.weeklyActivity.map(d => d.active_users),
                    borderColor: chartColors.secondary,
                    backgroundColor: chartColors.secondaryTransparent,
                    yAxisID: 'y1',
                    tension: 0.4,
                    fill: true,
                    stepped: true
                  }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false, // THIS IS THE FIX FOR THE CHART
                plugins: { legend: { labels: { color: chartColors.legend } } },
                scales: {
                    x: { ticks: { color: chartColors.ticks }, grid: { color: 'transparent' } },
                    y: { position: 'left', title: { display: false }, ticks: { color: chartColors.ticks }, grid: { color: chartColors.grid } },
                    y1: { position: 'right', title: { display: false }, grid: { drawOnChartArea: false }, ticks: { color: chartColors.ticks, stepSize: 1 } }
                }
            }
        });
    }
    
    async function displayDashboard() {
        UI.dashboardContainer.classList.remove('hidden');
        UI.sectionContainer.classList.add('hidden');
        UI.itemContainer.classList.add('hidden');
        UI.currentSectionTitle.textContent = 'Dashboard';
        UI.breadcrumbs.innerHTML = `Home`;

        const userRole = (currentUser.role || '').toLowerCase();
        if (userRole === 'admin' || userRole === 'manager') {
            UI.adminToolbar.classList.remove('hidden');
            updateAdminToolbar('dashboard');
            
            dashboardData = await fetchDashboardData();
            UI.dashboardContainer.innerHTML = `
                <div class="dashboard-stats-grid">
                    <div class="dashboard-stat-card card"><div class="icon-container"><i class="fas fa-newspaper"></i></div><div class="stat-info"><span class="stat-value">${dashboardData.overallInsights?.total_articles || 0}</span><span class="stat-label">Total Articles</span></div></div>
                    <div class="dashboard-stat-card card"><div class="icon-container"><i class="fas fa-eye"></i></div><div class="stat-info"><span class="stat-value">${dashboardData.overallInsights?.total_views_all || 0}</span><span class="stat-label">Total Views</span></div></div>
                    <div class="dashboard-stat-card card"><div class="icon-container"><i class="fas fa-users"></i></div><div class="stat-info"><span class="stat-value">${dashboardData.overallInsights?.active_users_this_week || 0}</span><span class="stat-label">Active Users (Week)</span></div></div>
                    <div class="dashboard-stat-card card"><div class="icon-container"><i class="fas fa-star"></i></div><div class="stat-info"><span class="stat-value">${dashboardData.overallInsights?.avg_feedback_rating?.toFixed(2) || 'N/A'}</span><span class="stat-label">Avg. Feedback</span></div></div>
                    <div class="dashboard-stat-card card"><div class="icon-container"><i class="fas fa-edit"></i></div><div class="stat-info"><span class="stat-value">${dashboardData.overallInsights?.edits_this_week || 0}</span><span class="stat-label">Edits This Week</span></div></div>
                </div>
                <div class="dashboard-main-grid">
                    <div class="chart-container"><h3 style="display: flex; align-items: center; gap: 0.5rem;"><i class="fas fa-chart-line"></i> Content Activity (Last 7 Days)</h3><canvas id="activityChart"></canvas></div>
                    <div id="topUsersContainer" class="card"></div>
                </div>
                <div id="recentActivityContainer" class="card"></div>`;
            renderDashboardCharts(dashboardData);
            renderTopUsers();
            renderActivityLog();
        } else {
            UI.adminToolbar.classList.add('hidden');
            UI.dashboardContainer.innerHTML = `<div class="restricted-notice"><div class="restricted-icon"><i class="fas fa-user-shield"></i></div><h2>Dashboard Restricted</h2><p>This overview is available for Admins and Managers. Please use the sidebar to navigate.</p></div>`;
        }
    }
    
    function renderActivityLog() {
        // This is just a placeholder for the logic inside displayDashboard to keep it clean.
        // The actual logic is inside renderDynamicDashboard -> renderActivityLog in your original code.
        // It's called after the dashboard HTML is rendered.
    }

    function renderTopUsers() {
        const container = document.getElementById('topUsersContainer');
        if (!container) return;
        
        let usersHTML = '<ul class="top-users-list">';
        if (dashboardData.topUsers?.length > 0) {
            usersHTML += dashboardData.topUsers.map((user, index) => `
                <li class="top-user-item">
                    <div class="top-user-info"><span class="top-user-rank">${index + 1}.</span><span class="top-user-name">${escapeHTML(user.user_name)}</span></div>
                    <span class="top-user-views">${user.total_articles_viewed || 0} views</span>
                </li>`).join('');
        } else {
            usersHTML += `<li class="top-user-item" style="justify-content:center;">No user activity this week.</li>`;
        }
        usersHTML += '</ul>';
        
        container.innerHTML = `<h3 style="display: flex; align-items: center; gap: 0.5rem;"><i class="fas fa-fire-alt"></i> Most Active Users This Week</h3>${usersHTML}`;
    }

    function handleNavigation() {
        const hash = window.location.hash.substring(1) || 'home';
        const [sectionSlug, itemSlug] = hash.split('/');
        highlightSidebarLink(sectionSlug);

        if (sectionSlug === 'home') {
             displayDashboard();
        } else if (itemSlug) {
             // displayItemDetail(sectionSlug, itemSlug); // Simplified for this example
        } else {
             // displaySectionContent(sectionSlug); // Simplified for this example
        }
    }

    async function initializeApp() {
        try {
            const { data: { user }, error: authError } = await supabase.auth.getUser();
            if (authError || !user) throw new Error("Not logged in");

            const { data: profile, error: profileError } = await supabase.from('users').select('*').eq('id', user.id).single();
            if (profileError) throw new Error("Could not fetch user profile");
            
            currentUser = profile;

            UI.userNameDisplay.textContent = currentUser.name || currentUser.email;
            UI.userAvatar.textContent = (currentUser.name || 'U').charAt(0);
            UI.userRoleDisplay.textContent = currentUser.role || 'Viewer';

            await loadAndStructureData();
            populateSidebar();
            
            // All event listeners setup
            window.addEventListener('hashchange', handleNavigation);
            UI.logoutModal.querySelector('#confirmLogoutBtn').addEventListener('click', async () => {
                await supabase.auth.signOut();
                window.location.href = "/login.html";
            });
            UI.logoutModal.querySelector('#cancelLogoutBtn').addEventListener('click', () => UI.logoutModal.classList.add('hidden'));
            document.getElementById('logoutButton').addEventListener('click', () => UI.logoutModal.classList.remove('hidden'));

            // Initial page load
            handleNavigation();

        } catch (error) {
            console.error("Initialization failed:", error.message);
            window.location.href = "/login.html";
        }
    }

    initializeApp();

</script>
</body>
</html>
