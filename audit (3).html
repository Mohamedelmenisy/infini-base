<!DOCTYPE html>
<html lang=ar dir=ltr>
<head>
  <style>
/* Shared design tokens and improvements */
:root{
  --brand-500: #0b5fff; /* primary */
  --brand-600: #084fd6;
  --muted-600: #6b7280;
  --bg: #0f1724;
  --card-bg: #0b1220;
  --glass: rgba(255,255,255,0.04);
  --success: #16a34a;
  --danger: #ef4444;
  --radius: 10px;
  --gap: 12px;
  --max-width: 1200px;
  --mono: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue';
}

/* Reset small things */
body { font-family: var(--mono); margin:0; background: linear-gradient(180deg,#071428 0%, #071727 100%); color: #e6eef8; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
.container{ max-width: var(--max-width); margin: 0 auto; padding: 20px; }

/* Sticky header */
.app-header{
  position: sticky; top:0; z-index:40; background: rgba(6,11,22,0.7); backdrop-filter: blur(6px); border-bottom: 1px solid rgba(255,255,255,0.04);
  display:flex; align-items:center; justify-content:space-between; padding: 10px 18px;
}
.app-header .brand { display:flex; align-items:center; gap:10px; font-weight:700; font-size:18px; color:var(--brand-500); }
.app-header nav{ display:flex; gap:10px; align-items:center; }
.app-header a{ color: #dbeafe; text-decoration:none; padding:8px 12px; border-radius:8px; display:inline-block; font-size:14px; }
.app-header a:hover{ background: rgba(255,255,255,0.03); transform: translateY(-1px); transition: all 120ms ease; }

/* Protected link */
.protected-link{ opacity:0.6; cursor: pointer; position:relative; outline:none; }
.protected-link::after{ content: 'ðŸ”’'; margin-left:6px; font-size:12px; opacity:0.7; }

/* Sidebar */
.app-layout{ display:flex; gap:18px; align-items:flex-start; padding-top:12px; }
.sidebar{ width:260px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:14px; border-radius:12px; height: calc(100vh - 88px); position:sticky; top:76px; overflow:auto; box-shadow: 0 6px 20px rgba(2,6,23,0.6); }
.main{ flex:1; min-height: calc(100vh - 120px); padding-bottom:60px; }

/* Cards */
.card{ background: var(--card-bg); padding:16px; border-radius:var(--radius); box-shadow: 0 8px 30px rgba(2,6,23,0.6); border: 1px solid rgba(255,255,255,0.03); margin-bottom: var(--gap); }

/* Modal styles */
.protected-modal{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background: rgba(2,6,23,0.6); visibility:hidden; opacity:0; transition: all 180ms ease; z-index:80; }
.protected-modal.open{ visibility:visible; opacity:1; }
.protected-modal-card{ width:380px; background: linear-gradient(180deg, #071428, #041025); padding:18px; border-radius:12px; border:1px solid rgba(255,255,255,0.04); box-shadow: 0 8px 30px rgba(2,6,23,0.7); color:#dbeafe; }
.protected-modal-card h3{ margin:0 0 8px 0; }
.protected-modal-card p{ margin:0 0 16px 0; color:var(--muted-600); }
.protected-modal-actions{ display:flex; gap:8px; justify-content:flex-end; }
.protected-modal button{ background:transparent; color:var(--brand-500); border:1px solid rgba(255,255,255,0.04); padding:8px 10px; border-radius:8px; cursor:pointer; }

/* responsive */
@media (max-width:900px){
  .sidebar{ position:relative; width:100%; height:auto; top:0; }
  .app-layout{ flex-direction:column; }
  .app-header nav{ gap:6px; }
}

  </style>

<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<title>InfiniBase â€” Audit Trail Dashboard</title>
<link rel=icon type=image/svg+xml href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32' width='32' height='32'><rect width='32' height='32' rx='4' fill='%236366f1'/><text x='50%' y='55%' dominant-baseline='middle' text-anchor='middle' font-family='Arial, sans-serif' font-size='18' font-weight='bold' fill='white'>IB</text></svg>">
<script src=https://cdn.jsdelivr.net/npm/chart.js></script>
<script src=https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js></script>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css>
<style>
:root{--primary-color:#6366f1;--primary-color-hover:#4f46e5;--primary-glow:rgba(99, 102, 241, 0.4);--text-color:#d1d5db;--text-color-muted:#9ca3af;--bg-color:#111827;--bg-color-alt:#1f2937;--border-color:#374151;--success-color:#22c55e;--warning-color:#f59e0b;--danger-color:#ef4444;--border-radius:0.5rem;--border-radius-lg:0.75rem;--header-height:70px}
html{font-size:15px;scroll-behavior:smooth}
body{height:100%;margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background-color:var(--bg-color);color:var(--text-color);line-height:1.5;background-image:radial-gradient(circle at 1px 1px,rgba(100,116,139,.1) 1px,transparent 0), linear-gradient(180deg, var(--bg-color-alt) 0%, var(--bg-color) 100%);background-size:20px 20px;-ms-overflow-style:none;scrollbar-width:none;transition:background-color .3s,color .3s}
body::-webkit-scrollbar{display:none}
.page-wrapper{padding:1.25rem 2rem;padding-top:calc(var(--header-height) + 1.25rem)}
.page-header{position:fixed;top:0;left:0;right:0;height:var(--header-height);display:flex;justify-content:space-between;align-items:center;padding:0 2rem;background-color:rgba(17,24,39,.85);border-bottom:1px solid var(--border-color);backdrop-filter:blur(10px);z-index:100;transition:background-color .3s,border-color .3s}
.page-header .header-title{display:flex;align-items:center;gap:1rem}
.page-header .logo-icon{font-size:1.5rem;color:var(--primary-color)}
.page-header h1{font-size:1.5rem;font-weight:700;color:#fff;margin:0}
.header-actions{display:flex;align-items:center;gap:1rem}
.button,button{background-color:var(--primary-color);color:#fff;border:1px solid transparent;padding:.6rem 1.2rem;border-radius:var(--border-radius);cursor:pointer;font-size:.95rem;font-weight:600;transition:all .2s ease-in-out;text-decoration:none;display:inline-flex;align-items:center;justify-content:center;gap:.5rem}
.button:hover,button:hover{background-color:var(--primary-color-hover);transform:translateY(-2px);box-shadow:0 4px 20px var(--primary-glow)}
.button:disabled,button:disabled{background-color:#374151;cursor:not-allowed;transform:none;box-shadow:none;color:#9ca3af;opacity:0.7}
.button-secondary{background-color:var(--bg-color-alt);color:var(--text-color);border-color:var(--border-color)}
.button-secondary:hover:not(:disabled){background-color:var(--border-color);color:#fff;border-color:var(--primary-color);}
.card{background-color:var(--bg-color-alt);border:1px solid var(--border-color);border-radius:var(--border-radius-lg);padding:1.5rem;margin-bottom:1.5rem;box-shadow:0 4px 20px rgba(0,0,0,.2);transition:all .3s ease}
.card:hover{box-shadow:0 8px 30px rgba(0,0,0,.4);border-color:rgba(99,102,241,.5);transform: translateY(-2px);}
h2.section-title{font-size:1.3rem;font-weight:600;color:#fff;margin:0 0 1.25rem 0;display:flex;align-items:center;gap:.75rem}
.filters{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1rem;align-items:end}
.filters .form-group{display:flex;flex-direction:column}
.filters label{font-size:.85rem;font-weight:500;color:var(--text-color-muted);margin-bottom:.4rem}
.filters input,.filters select{height:42px;box-sizing:border-box;padding:.7rem;border:1px solid var(--border-color);border-radius:var(--border-radius);background-color:var(--bg-color);color:var(--text-color);font-size:.95rem;transition:border-color .2s,box-shadow .2s}
.filters input:focus,.filters select:focus{border-color:var(--primary-color);box-shadow:0 0 0 3px var(--primary-glow);outline:0}
.filter-buttons{grid-column:1/-1;display:flex;justify-content:flex-end;gap:.75rem;margin-top:.75rem}
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1.25rem}
.kpi-card{padding:1.25rem;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;gap:1rem;transition:transform .2s,box-shadow .2s; min-height:140px}
.kpi-card:hover{transform:translateY(-4px)}
.kpi-card .icon{font-size:1.8rem;width:50px;height:50px;display:grid;place-items:center;background:var(--bg-color);border-radius:50%;flex-shrink:0}
.kpi-card .info .value{font-size:1.8rem;font-weight:700;color:#fff}
.kpi-card .info .label{font-size:.95rem;color:var(--text-color-muted)}
.charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:1.25rem}
.chart-wrapper{position:relative;min-height:320px;width:100%}
.chart-wrapper-full{grid-column:1/-1;min-height:350px}
.table-wrap{overflow-x:auto; max-height: 600px; overflow-y: auto;}
.table-wrap::-webkit-scrollbar { width: 8px; }
.table-wrap::-webkit-scrollbar-track { background: var(--bg-color); }
.table-wrap::-webkit-scrollbar-thumb { background-color: var(--primary-color); border-radius: 20px; border: 3px solid var(--bg-color); }
table{width:100%;border-collapse:collapse}
thead th{position:sticky;top:0;z-index:10;background-color: #2a3546; border-bottom: 2px solid var(--primary-color);}
td,th{padding:.9rem 1rem;border-bottom:1px solid var(--border-color);text-align:left;vertical-align:middle;font-size:.9rem}
tbody tr{transition: background-color 0.2s ease;}
tbody tr:nth-child(even){background-color:rgba(255,255,255,0.02)}
tbody tr:hover{background-color:#2a3546; cursor: default;}
td.case-cell,td.details-cell{white-space:normal;word-break:break-word;max-width:250px}
.badge{padding:.3em .8em;font-size:.75rem;font-weight:600;border-radius:20px;color:#fff;display:inline-flex;align-items:center;gap:.4rem;text-transform:capitalize}
.badge i{font-size:.8em}.badge.Create{background-color:var(--success-color)}.badge.Update{background-color:var(--warning-color)}.badge.Delete{background-color:var(--danger-color)}.badge.viewed{background-color:#3b82f6}.badge.commented{background-color:#a855f7}.badge.positive_feedback{background-color:var(--success-color)}.badge.negative_feedback{background-color:var(--danger-color)}
.pagination-controls{display:flex;justify-content:center;align-items:center;gap:1rem;margin-top:1.25rem}
.pagination-controls button{padding: .7rem 1.4rem; box-shadow: 0 2px 8px rgba(0,0,0,0.2);}
.toast{position:fixed;top:calc(var(--header-height) + 20px);right:20px;z-index:1100;display:flex;align-items:center;gap:1rem;padding:1rem 1.25rem;border-radius:var(--border-radius);color:#fff;box-shadow:0 8px 30px rgba(0,0,0,.5);opacity:0;transform:translateX(20px);transition:all .4s cubic-bezier(.25, .46, .45, .94)}
.toast.show{opacity:1;transform:translateX(0)}
.overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(17,24,39,.8);z-index:1000;opacity:0;visibility:hidden;transition:opacity .3s}.overlay.show{opacity:1;visibility:visible}
.spinner{width:60px;height:60px;border-radius:50%;border:5px solid var(--border-color);border-top-color:var(--primary-color);animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes modal-fade-in { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
@keyframes content-fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
#dashboard { animation: content-fade-in 0.6s ease-out forwards; }
.modal{position:fixed;inset:0;z-index:2000;display:none;align-items:center;justify-content:center}.modal.show{display:flex}
.modal-content{background:var(--bg-color-alt);color:var(--text-color);border-radius:var(--border-radius-lg);padding:2rem;width:90%;max-width:700px;max-height:80vh;overflow-y:auto;border:1px solid var(--border-color);box-shadow: 0 10px 40px rgba(0,0,0,0.5);}
.modal.show .modal-content { animation: modal-fade-in 0.3s ease-out forwards; }
.modal-header{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border-color);padding-bottom:1rem;margin-bottom:1.5rem}
.modal h2{margin:0;color:#fff;font-size:1.25rem}
.modal .close-btn{background:0 0;border:none;font-size:1.5rem;color:var(--text-color-muted);cursor:pointer; transition: color 0.2s ease;}
.modal .close-btn:hover { color: var(--primary-color); }
.timeline{position:relative;padding:1rem 0;margin-left:20px}.timeline::before{content:'';position:absolute;left:20px;top:0;bottom:0;width:3px;background:var(--border-color);border-radius:2px}
.timeline-item{position:relative;padding-left:60px;margin-bottom:1.5rem}
.timeline-icon{position:absolute;left:0;top:0;width:40px;height:40px;border-radius:50%;display:grid;place-items:center;font-size:1.2rem;color:#fff;border:3px solid var(--bg-color)}
.timeline-icon.Create{background-color:var(--success-color)}.timeline-icon.Update{background-color:var(--warning-color)}.timeline-icon.Delete{background-color:var(--danger-color)}
.timeline-content .timestamp{font-size:.85rem;color:var(--text-color-muted)}
.timeline-content .details{font-weight:600;color:#fff}.timeline-content .user{color:var(--primary-color);font-weight:500}
.access-restricted-container{display:none;flex-direction:column;align-items:center;justify-content:center;text-align:center;min-height:100vh}
.access-restricted-container .card{max-width:450px;padding:3rem}.access-restricted-container .icon{font-size:3rem;color:var(--primary-color);margin-bottom:1rem}
.quick-stats{display:flex;gap:.75rem;margin-bottom:1rem;flex-wrap:wrap}
.stat-badge{background:var(--bg-color);padding:.5rem 1rem;border-radius:var(--border-radius);display:flex;align-items:center;gap:.5rem;font-size:.85rem; border: 1px solid var(--border-color);}
.stat-badge i{color:var(--primary-color)}
.table-actions{display:flex;gap:.5rem}
.table-actions button{padding:.4rem .8rem;font-size:.8rem}
.export-options{display:flex;gap:.5rem;margin-left:auto}
.refresh-indicator{display:flex;align-items:center;gap:.5rem;color:var(--text-color-muted);font-size:.9rem}
.refresh-indicator.active{color:var(--success-color)}
.refresh-indicator.active i{animation:spin 1s linear infinite}
.filter-summary{background:var(--bg-color);padding:.75rem 1rem;border-radius:var(--border-radius);margin-bottom:1rem;font-size:.9rem;color:var(--text-color-muted)}
.filter-summary strong{color:var(--text-color)}
.chart-toolbar{display:flex;justify-content:flex-end;gap:.5rem;margin-bottom:1rem}
.chart-toolbar button{padding:.4rem .8rem;font-size:.8rem}
.skeleton-loader td { padding: .9rem 1rem; }
.skeleton-loader .skeleton-bar { width: 90%; height: 20px; background-color: var(--border-color); border-radius: 4px; opacity: 0.5; animation: shimmer 1.5s infinite linear; }
@keyframes shimmer { 0% { background-color: var(--border-color); } 50% { background-color: #4a5568; } 100% { background-color: var(--border-color); } }

/* Responsive Design */
@media(max-width: 1024px) {
    .charts-grid { grid-template-columns: 1fr; }
    .page-wrapper { padding: 1rem; padding-top: calc(var(--header-height) + 1rem); }
    html { font-size: 14px; }
}
@media(max-width: 768px) {
    .page-header { padding: 0 1rem; }
    .kpi-grid { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
    .kpi-card .info .value { font-size: 1.6rem; }
    .header-actions .button span { display: none; }
    .header-actions .button i { margin-right: 0; }
    .filter-buttons { flex-direction: column; }
    .pagination-controls { gap: .5rem; }
    .pagination-controls button { padding: .6rem 1rem; }
}
</style>
</head>
<body>
<header class="app-header">
  <div class="brand">Knowledge Base</div>
  <nav>
    <a href="app.html" id="link-dashboard" data-role-required="admin,manager">Dashboard</a>
    <a href="insights.html" id="link-insights" data-role-required="admin,manager">Insights</a>
    <a href="employees.html" id="link-employees" data-role-required="admin,manager">Employees</a>
    <a href="audit.html" id="link-audit" data-role-required="admin,manager">Audit Log</a>
    <span id="role-badge" style="margin-left:12px;padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.02);font-size:13px">guest</span>
  </nav>
</header>


<div id=dashboard style=visibility:hidden>
<header class=page-header>
<div class=header-title><i class="fas fa-shield-alt logo-icon"></i><h1>Audit Trail Dashboard</h1></div>
<div class=header-actions>
<div class=refresh-indicator id=refreshIndicator>
<i class="fas fa-sync-alt"></i>
<span>Last updated: <span id=lastUpdateTime>Just now</span></span>
</div>
<a href=app.html class="button button-secondary"><i class="fas fa-arrow-left"></i> <span>Back to App</span></a>
</div>
</header>
<div class=page-wrapper>
<div id=toast class=toast role=status aria-live=polite></div>
<div id=overlay class=overlay><div class=spinner></div></div>
<div class="kpi-grid card">
<div class=kpi-card><div class=icon style=color:var(--primary-color)><i class="fas fa-edit"></i></div><div class=info><div id=kpi-today-mods class=value>0</div><div class=label>Today's Modifications</div></div></div>
<div class=kpi-card><div class=icon style=color:var(--success-color)><i class="fas fa-plus-circle"></i></div><div class=info><div id=kpi-new-cases class=value>0</div><div class=label>New Cases Today</div></div></div>
<div class=kpi-card><div class=icon style=color:var(--warning-color)><i class="fas fa-sitemap"></i></div><div class=info><div id=kpi-active-section class=value>-</div><div class=label>Most Active Section</div></div></div>
<div class=kpi-card><div class=icon style=color:var(--text-color-muted)><i class="fas fa-clock"></i></div><div class=info><div id=kpi-last-update class=value>-</div><div class=label>Last Update Time</div></div></div>
</div>
<div class=card>
<h2 class=section-title><i class="fas fa-filter"></i> Filters & Search</h2>
<div class=filters>
<div class=form-group><label for=searchInput>Search by Case Title</label><input id=searchInput placeholder="Enter case title..."></div>
<div class=form-group><label for=userSearchInput>Search by User</label><input id=userSearchInput placeholder="Enter name or email..."></div>
<div class=form-group><label for=sectionFilter>Section</label><select id=sectionFilter><option value="">All Sections</option></select></div>
<div class=form-group><label for=actionFilter>Action Type</label><select id=actionFilter><option value="">All</option><option>Create</option><option>Update</option><option>Delete</option></select></div>
<div class=form-group><label for=startDate>From Date</label><input id=startDate type=date></div>
<div class=form-group><label for=endDate>To Date</label><input id=endDate type=date></div>
<div class=filter-buttons>
<button id=clearBtn class=button-secondary><i class="fas fa-times"></i> Clear Filters</button>
<button id=saveFilterBtn class=button-secondary><i class="fas fa-bookmark"></i> Save Filter</button>
</div>
</div>
<div id=filterSummary class=filter-summary style=display:none></div>
</div>
<div class=card>
<h2 class=section-title><i class="fas fa-chart-area"></i> Analytics</h2>
<div class=chart-toolbar>
<button id=exportChartBtn class=button-secondary disabled title="Coming Soon"><i class="fas fa-download"></i> Export Charts</button>
<button id=refreshChartsBtn class=button-secondary><i class="fas fa-sync-alt"></i> Refresh</button>
</div>
<div class=charts-grid>
<div class=chart-wrapper><canvas id=dailyActivityChart></canvas></div>
<div class=chart-wrapper><canvas id=actionsPieChart></canvas></div>
<div class="chart-wrapper chart-wrapper-full"><canvas id=topCasesChart></canvas></div>
</div>
</div>
<div class=card>
<div style=display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;gap:1rem;margin-bottom:1rem>
<h2 class=section-title style=margin:0><i class="fas fa-history"></i> Activity Log</h2>
<div style=display:flex;gap:1rem;align-items:center>
<div id=live-indicator style=color:var(--success-color);display:flex;align-items:center;gap:.5rem;font-weight:600><i class="fas fa-circle"></i> Live</div>
<div id=totalRecords style=color:var(--text-color-muted)>0 records</div>
<div class=export-options>
<button id=exportCsvBtn class=button-secondary><i class="fas fa-download"></i> Export CSV</button>
<button id=exportPdfBtn class=button-secondary disabled title="Coming Soon"><i class="fas fa-file-pdf"></i> PDF</button>
</div>
</div>
</div>
<div class=quick-stats id=quickStats></div>
<div class=table-wrap>
<table>
<thead><tr><th>Date & Time</th><th>User</th><th>Email</th><th>Case</th><th>Section</th><th>Action</th><th>Details</th><th>View</th></tr></thead>
<tbody id=auditBody></tbody>
<tbody id="skeletonBody" class="skeleton-loader">
    <script>document.write('<tr>' + '<td><div class="skeleton-bar"></div></td>'.repeat(8) + '</tr>'.repeat(5));</script>
</tbody>
</table>
</div>
<div class=pagination-controls>
<button id=prevBtn class=button-secondary><i class="fas fa-arrow-left"></i> Prev</button>
<span id=pageInfo>Page 1 of 1</span>
<button id=nextBtn class=button-secondary>Next <i class="fas fa-arrow-right"></i></button>
</div>
</div>
<footer style="text-align:center;padding:2rem 0 1rem;margin-top:1.25rem;border-top:1px solid var(--border-color);color:var(--text-color-muted)">
Â© 2025 InfiniBase.Elmenisy.
</footer>
</div>
</div>
<div id=restricted-card class=access-restricted-container style=display:none>
<div class=card><div class=icon>ðŸ”’</div><h2>Access Restricted</h2><p>This page is for admins only.</p><a href=app.html class=button>Go Back</a></div>
</div>
<div id=timelineModal class="modal">
<div class=modal-content><div class=modal-header><h2 id=timelineCaseTitle>Case Timeline</h2><button class=close-btn>&times;</button></div><div id=timelineBody class=timeline></div></div>
</div>
<script type=module>import{supabase}from"./supabase.js";let auditStore=[],filteredStore=[],pageSize=10,currentPage=1,charts={},savedFilters=JSON.parse(localStorage.getItem("auditFilters")||"[]");const escapeHtml=e=>String(e||"").replace(/[&<>"']/g,(e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[e]))),formatTime=e=>e?new Date(e).toLocaleString("en-GB",{timeZone:"Africa/Cairo",year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"-";const showSkeleton=(e=!0)=>{document.getElementById("skeletonBody").style.display=e?"table-row-group":"none",document.getElementById("auditBody").style.display=e?"none":"table-row-group"};async function fetchData(){showSkeleton();try{const{data:e,error:t}=await supabase.from("v_case_history_audit").select("*").order("modified_at_egypt",{ascending:!1});if(t)throw t;auditStore=e||[],populateFilters(),applyFiltersAndRender(),updateLastUpdateTime()}catch(e){console.error("Error fetching data:",e),document.getElementById("auditBody").innerHTML='<tr><td colspan="8" style="text-align:center; padding: 2rem; color: var(--danger-color);">Failed to load data.</td></tr>'}finally{showSkeleton(!1)}}const populateFilters=()=>{const e=[...new Set(auditStore.map((e=>e.section)).filter(Boolean))],t=document.getElementById("sectionFilter");t.innerHTML='<option value="">All Sections</option>',e.sort().forEach((e=>t.add(new Option(e,e)))),savedFilters.length>0&&populateSavedFilters()},populateSavedFilters=()=>{const e=document.createElement("select");e.id="savedFilters",e.innerHTML='<option value="">Saved Filters</option>'+savedFilters.map(((e,t)=>`<option value="${t}">${e.name}</option>`)).join("");const t=document.querySelector(".filter-buttons");t.insertBefore(e,t.firstChild),e.addEventListener("change",(e=>{if(e.target.value){const t=savedFilters[e.target.value];document.getElementById("searchInput").value=t.search||"",document.getElementById("userSearchInput").value=t.userSearch||"",document.getElementById("sectionFilter").value=t.section||"",document.getElementById("actionFilter").value=t.action||"",document.getElementById("startDate").value=t.startDate||"",document.getElementById("endDate").value=t.endDate||"",applyFiltersAndRender()}}))},renderPage=()=>{const e=document.getElementById("auditBody"),t=Math.max(1,Math.ceil(filteredStore.length/pageSize));currentPage=Math.min(currentPage,t);const a=(currentPage-1)*pageSize,n=a+pageSize,i={Create:"fa-plus",Update:"fa-pencil-alt",Delete:"fa-trash"};e.innerHTML="",filteredStore.length?filteredStore.slice(a,n).forEach((t=>{const a=document.createElement("tr"),n=i[t.action]?`<i class="fas ${i[t.action]}"></i>`:"";a.innerHTML=`\n            <td>${formatTime(t.modified_at_egypt)}</td>\n            <td>${escapeHtml(t.user_name||"â€”")}</td>\n            <td>${escapeHtml(t.user_email)}</td>\n            <td class="case-cell">${escapeHtml(t.case_title)}</td><td>${escapeHtml(t.section)}</td>\n            <td><span class="badge ${t.action}">${n} ${t.action}</span></td>\n            <td class="details-cell">${escapeHtml(t.details)}</td>\n            <td><div class="table-actions"><button class="button-secondary view-timeline-btn" data-case-id="${t.case_id}" title="View Timeline"><i class="fas fa-stream"></i></button></div></td>\n          `,e.appendChild(a)})):e.innerHTML='<tr><td colspan="8" style="text-align:center; padding: 2rem;">No records match filters.</td></tr>',document.getElementById("pageInfo").textContent=`Page ${currentPage} of ${t}`,document.getElementById("prevBtn").disabled=1===currentPage,document.getElementById("nextBtn").disabled=currentPage>=t,document.getElementById("totalRecords").textContent=`${filteredStore.length} records found`},applyFiltersAndRender=()=>{const e=document.getElementById("searchInput").value.toLowerCase().trim(),t=document.getElementById("userSearchInput").value.toLowerCase().trim(),a=document.getElementById("actionFilter").value,n=document.getElementById("sectionFilter").value,i=document.getElementById("startDate").valueAsDate,s=document.getElementById("endDate").valueAsDate;s&&s.setHours(23,59,59,999),filteredStore=auditStore.filter((o=>{const r=new Date(o.modified_at_egypt),l=!t||(o.user_name||"").toLowerCase().includes(t)||(o.user_email||"").toLowerCase().includes(t);return(!i||r>=i)&&(!s||r<=s)&&(!a||o.action===a)&&(!n||o.section===n)&&(!e||(o.case_title||"").toLowerCase().includes(e))&&l})),currentPage=1,renderPage(),updateKpiCards(),updateQuickStats(),updateFilterSummary(),buildCharts()},updateKpiCards=()=>{const e=(new Date).toLocaleDateString("en-CA",{timeZone:"Africa/Cairo"}),t=auditStore.filter((t=>t.modified_at_egypt?.startsWith(e)));document.getElementById("kpi-today-mods").textContent=t.length,document.getElementById("kpi-new-cases").textContent=t.filter((e=>"Create"===e.action)).length;const a=t.reduce(((e,t)=>(t.section&&(e[t.section]=(e[t.section]||0)+1),e)),{}),n=Object.entries(a).sort(((e,t)=>t[1]-e[1]))[0];document.getElementById("kpi-active-section").textContent=n?n[0]:"-";const i=auditStore[0]?.modified_at_egypt;document.getElementById("kpi-last-update").textContent=i?new Date(i).toLocaleTimeString("en-GB",{timeZone:"Africa/Cairo",hour:"2-digit",minute:"2-digit"}):"-"},updateQuickStats=()=>{const e=document.getElementById("quickStats");if(0===filteredStore.length)return void(e.innerHTML="");const t=filteredStore.filter((e=>"Create"===e.action)).length,a=filteredStore.filter((e=>"Update"===e.action)).length,n=filteredStore.filter((e=>"Delete"===e.action)).length,i=[...new Set(filteredStore.map((e=>e.user_email)))].length,s=[...new Set(filteredStore.map((e=>e.case_title)))].length;e.innerHTML=`\n        <div class="stat-badge"><i class="fas fa-plus-circle"></i> ${t} Created</div>\n        <div class="stat-badge"><i class="fas fa-pencil-alt"></i> ${a} Updated</div>\n        <div class="stat-badge"><i class="fas fa-trash"></i> ${n} Deleted</div>\n        <div class="stat-badge"><i class="fas fa-users"></i> ${i} Users</div>\n        <div class="stat-badge"><i class="fas fa-file-alt"></i> ${s} Cases</div>\n      `},updateFilterSummary=()=>{const e=document.getElementById("filterSummary"),t=document.getElementById("searchInput").value,a=document.getElementById("userSearchInput").value,n=document.getElementById("actionFilter").value,i=document.getElementById("sectionFilter").value,s=document.getElementById("startDate").value,o=document.getElementById("endDate").value,r=[];t&&r.push(`Case: "${t}"`),a&&r.push(`User: "${a}"`),n&&r.push(`Action: ${n}`),i&&r.push(`Section: ${i}`),s&&r.push(`From: ${s}`),o&&r.push(`To: ${o}`),r.length>0?(e.innerHTML=`<strong>Active Filters:</strong> ${r.join(" â€¢ ")}`,e.style.display="block"):e.style.display="none"},createChart=(e,t,a,n)=>{charts[e]&&charts[e].destroy();const i=document.getElementById(e).getContext("2d");charts[e]=new Chart(i,{type:t,data:a,options:n})},buildCharts=()=>{const e="#d1d5db",t="#374151",a=a=>({responsive:!0,maintainAspectRatio:!1,animation:{duration:1000,easing:"easeInOutQuart"},plugins:{legend:{position:"bottom",labels:{color:e,font:{size:14},padding:20}},title:{display:!0,text:a,color:e,font:{size:16,weight:"bold"},padding:{bottom:15}},tooltip:{backgroundColor:"#111827",titleColor:"#fff",bodyColor:"#fff",borderColor:t,borderWidth:1,padding:10,callbacks:{label:e=>`${e.label}: ${e.raw.toLocaleString()}`}}},scales:{y:{ticks:{color:e},grid:{color:t}},x:{ticks:{color:e},grid:{color:t}}}}),n=filteredStore.reduce(((e,t)=>{const a=t.modified_at_egypt.slice(0,10);return e[a]=(e[a]||0)+1,e}),{});createChart("dailyActivityChart","line",{labels:Object.keys(n).sort(),datasets:[{label:"Modifications",data:Object.keys(n).sort().map((e=>n[e])),borderColor:"#6366f1",backgroundColor:"rgba(99, 102, 241, 0.2)",tension:.4,fill:!0}]},a("Daily Activity"));const i=filteredStore.reduce(((e,t)=>(e[t.action]=(e[t.action]||0)+1,e)),{});createChart("actionsPieChart","doughnut",{labels:Object.keys(i),datasets:[{data:Object.values(i),backgroundColor:["#22c55e","#f59e0b","#ef4444"],borderColor:t,borderWidth:2}]},{...a("Actions Distribution"),cutout:"60%",plugins:{...a("Actions Distribution").plugins,tooltip:{...a("Actions Distribution").plugins.tooltip,callbacks:{label:e=>`${e.label}: ${e.raw} (${Math.round(e.raw/filteredStore.length*100)}%)`}}}});const s=filteredStore.reduce(((e,t)=>(e[t.case_title]=(e[t.case_title]||0)+1,e)),{}),o=Object.entries(s).sort(((e,t)=>t[1]-e[1])).slice(0,10);createChart("topCasesChart","bar",{labels:o.map((e=>e[0].length>30?e[0].substring(0,30)+"...":e[0])),datasets:[{label:"Modifications",data:o.map((e=>e[1])),backgroundColor:"rgba(99, 102, 241, 0.7)",borderColor:"#6366f1",borderWidth:1,borderRadius:4}]},a("Top Modified Cases"))},showTimeline=async e=>{const t=document.getElementById("timelineModal"),a=document.getElementById("timelineBody"),n=document.getElementById("timelineCaseTitle");showSkeleton(!0);try{const{data:i,error:s}=await supabase.from("v_case_history_audit").select("*").eq("case_id",e).order("modified_at_egypt",{ascending:!0});if(s)throw s;const o=i||[],r=o[0];n.textContent=`Case Timeline: ${escapeHtml(r?.case_title||"Unknown")}`,a.innerHTML="",0===o.length?a.innerHTML="<p>No history found for this case.</p>":o.forEach(((e,t)=>{const n=document.createElement("div");n.className="timeline-item",n.innerHTML=`\n                        <div class="timeline-icon ${e.action}"><i class="fas ${"Create"===e.action?"fa-plus":"Update"===e.action?"fa-pencil-alt":"fa-trash"}"></i></div>\n                        <div class="timeline-content">\n                            <div class="timestamp">${formatTime(e.modified_at_egypt)}</div>\n                            <div class="details">${escapeHtml(e.action)} by <span class="user">${escapeHtml(e.user_name||e.user_email)}</span></div>\n                            <div class="details">${escapeHtml(e.details)}</div>\n                        </div>\n                    `,a.appendChild(n)})),t.classList.add("show")}catch(e){console.error("Error fetching timeline:",e),a.innerHTML="<p>Error loading timeline data.</p>"}finally{showSkeleton(!1)}},updateLastUpdateTime=()=>{const e=new Date;document.getElementById("lastUpdateTime").textContent=e.toLocaleTimeString("en-GB",{timeZone:"Africa/Cairo",hour:"2-digit",minute:"2-digit"});const t=document.getElementById("refreshIndicator");t.classList.add("active"),setTimeout((()=>t.classList.remove("active")),2e3)},saveCurrentFilter=()=>{const e=prompt("Enter a name for this filter:");if(!e)return;const t={name:e,search:document.getElementById("searchInput").value,userSearch:document.getElementById("userSearchInput").value,section:document.getElementById("sectionFilter").value,action:document.getElementById("actionFilter").value,startDate:document.getElementById("startDate").value,endDate:document.getElementById("endDate").value};savedFilters.push(t),localStorage.setItem("auditFilters",JSON.stringify(savedFilters));const a=document.getElementById("savedFilters");a&&a.remove(),populateSavedFilters(),showToast(`Filter '${e}' saved successfully`, "success");},showToast=(e,t="info")=>{const a=document.getElementById("toast"),n={"success": "var(--success-color)", "error": "var(--danger-color)", "info": "var(--primary-color)"};a.textContent=e,a.style.backgroundColor=n[t]||n.info,a.classList.add("show"),setTimeout((()=>a.classList.remove("show")),4e3)};let toastTimer;const showToastNotification=e=>{clearTimeout(toastTimer);const t=document.getElementById("toast"),a=e.new.action||"modified",n={"Create":"--success-color","Update":"--warning-color","Delete":"--danger-color"};t.style.background=`var(${n[a]||"--primary-color"})`,t.innerHTML=`<span>A record was just ${a.toLowerCase()}. Refreshing...</span>`,t.classList.add("show"),toastTimer=setTimeout((()=>t.classList.remove("show")),5e3)};async function checkAdminAccess(){try{const{data:{user:e}}=await supabase.auth.getUser();if(!e)throw new Error("Not logged in");const{data:t,error:a}=await supabase.from("users").select("role").eq("id",e.id).single();if(a||"admin"!==t?.role)throw new Error("Access denied");document.getElementById("dashboard").style.visibility="visible",await fetchData(),supabase.channel("public:case_history").on("postgres_changes",{event:"INSERT",schema:"public",table:"case_history"},(e=>{showToastNotification(e),auditStore.unshift(e.new),applyFiltersAndRender()})).subscribe()}catch(e){document.getElementById("restricted-card").style.display="flex"}}document.addEventListener("DOMContentLoaded",(()=>{checkAdminAccess(),["searchInput","userSearchInput","sectionFilter","actionFilter","startDate","endDate"].forEach((e=>{document.getElementById(e).addEventListener("input",applyFiltersAndRender)})),document.getElementById("clearBtn").addEventListener("click",(()=>{document.getElementById("searchInput").value="",document.getElementById("userSearchInput").value="",document.getElementById("sectionFilter").value="",document.getElementById("actionFilter").value="",document.getElementById("startDate").value="",document.getElementById("endDate").value="",applyFiltersAndRender()})),document.getElementById("saveFilterBtn").addEventListener("click",saveCurrentFilter),document.getElementById("prevBtn").addEventListener("click",(()=>{currentPage--,renderPage()})),document.getElementById("nextBtn").addEventListener("click",(()=>{currentPage++,renderPage()})),document.getElementById("exportCsvBtn").addEventListener("click",(()=>{if(!filteredStore.length)return alert("No data to export");const e=[["Date","User","Email","Case","Section","Action","Details"].join(",")].concat(filteredStore.map((e=>[formatTime(e.modified_at_egypt),e.user_name,e.user_email,e.case_title,e.section,e.action,e.details].map((e=>`"${String(e||"").replace(/"/g,'""')}"`)).join(",")))).join("\n"),t=new Blob([e],{type:"text/csv"}),a=URL.createObjectURL(t),n=document.createElement("a");n.href=a,n.download=`audit-trail-${(new Date).toISOString().slice(0,10)}.csv`,n.click(),URL.revokeObjectURL(a),showToast("CSV exported successfully","success")})),document.getElementById("refreshChartsBtn").addEventListener("click",(()=>{buildCharts(),updateLastUpdateTime(),showToast("Charts refreshed","success")})),document.addEventListener("click",(e=>{const t=e.target.closest(".view-timeline-btn");t&&showTimeline(t.dataset.caseId)})),document.querySelectorAll(".close-btn").forEach((e=>{e.addEventListener("click",(()=>{document.getElementById("timelineModal").classList.remove("show")}))}));document.getElementById("timelineModal").addEventListener("click",(e=>{e.target===document.getElementById("timelineModal")&&document.getElementById("timelineModal").classList.remove("show")})),setInterval(fetchData,3e5)}))</script>
<script type="module">
  import { getCurrentUserRole, applyNavVisibility } from './role-check.js';
  (async function(){
    const role = await getCurrentUserRole();
    applyNavVisibility(role);
    // allow sidebar links visible to agents (do not block), only protect header admin pages
    // optional: attach open handlers if needed
  })();
</script>

</body>
</html>
