<!DOCTYPE html>
<html class="dark" data-hash="2025-06-24T15:30" dir="ltr" lang="en">
<head>
  <style>
/* Shared design tokens and improvements */
:root{
  --brand-500: #0b5fff; /* primary */
  --brand-600: #084fd6;
  --muted-600: #6b7280;
  --bg: #0f1724;
  --card-bg: #0b1220;
  --glass: rgba(255,255,255,0.04);
  --success: #16a34a;
  --danger: #ef4444;
  --radius: 10px;
  --gap: 12px;
  --max-width: 1200px;
  --mono: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue';
}

/* Reset small things */
body { font-family: var(--mono); margin:0; background: linear-gradient(180deg,#071428 0%, #071727 100%); color: #e6eef8; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
.container{ max-width: var(--max-width); margin: 0 auto; padding: 20px; }

/* Sticky header */
.app-header{
  position: sticky; top:0; z-index:40; background: rgba(6,11,22,0.7); backdrop-filter: blur(6px); border-bottom: 1px solid rgba(255,255,255,0.04);
  display:flex; align-items:center; justify-content:space-between; padding: 10px 18px;
}
.app-header .brand { display:flex; align-items:center; gap:10px; font-weight:700; font-size:18px; color:var(--brand-500); }
.app-header nav{ display:flex; gap:10px; align-items:center; }
.app-header a{ color: #dbeafe; text-decoration:none; padding:8px 12px; border-radius:8px; display:inline-block; font-size:14px; }
.app-header a:hover{ background: rgba(255,255,255,0.03); transform: translateY(-1px); transition: all 120ms ease; }

/* Protected link */
.protected-link{ opacity:0.6; cursor: pointer; position:relative; outline:none; }
.protected-link::after{ content: '🔒'; margin-left:6px; font-size:12px; opacity:0.7; }

/* Sidebar */
.app-layout{ display:flex; gap:18px; align-items:flex-start; padding-top:12px; }
.sidebar{ width:260px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:14px; border-radius:12px; height: calc(100vh - 88px); position:sticky; top:76px; overflow:auto; box-shadow: 0 6px 20px rgba(2,6,23,0.6); }
.main{ flex:1; min-height: calc(100vh - 120px); padding-bottom:60px; }

/* Cards */
.card{ background: var(--card-bg); padding:16px; border-radius:var(--radius); box-shadow: 0 8px 30px rgba(2,6,23,0.6); border: 1px solid rgba(255,255,255,0.03); margin-bottom: var(--gap); }

/* Modal styles */
.protected-modal{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background: rgba(2,6,23,0.6); visibility:hidden; opacity:0; transition: all 180ms ease; z-index:80; }
.protected-modal.open{ visibility:visible; opacity:1; }
.protected-modal-card{ width:380px; background: linear-gradient(180deg, #071428, #041025); padding:18px; border-radius:12px; border:1px solid rgba(255,255,255,0.04); box-shadow: 0 8px 30px rgba(2,6,23,0.7); color:#dbeafe; }
.protected-modal-card h3{ margin:0 0 8px 0; }
.protected-modal-card p{ margin:0 0 16px 0; color:var(--muted-600); }
.protected-modal-actions{ display:flex; gap:8px; justify-content:flex-end; }
.protected-modal button{ background:transparent; color:var(--brand-500); border:1px solid rgba(255,255,255,0.04); padding:8px 10px; border-radius:8px; cursor:pointer; }

/* responsive */
@media (max-width:900px){
  .sidebar{ position:relative; width:100%; height:auto; top:0; }
  .app-layout{ flex-direction:column; }
  .app-header nav{ gap:6px; }
}

</style>

<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>InfiniBase - Command Center</title>
<!-- Cairo Font for Arabic -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<!-- Favicon -->
 <link rel="shortcut icon" href=favicon.ico type=image/x-icon>
<link rel=icon href=favicon.svg type=image/svg+xml>
<!-- CDNs -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet"/>
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet"/>
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/quill-image-resize-module@3.0.0/image-resize.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<!-- Spotlight.js for Lightbox Effect -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/spotlight.js/dist/css/spotlight.min.css" />
<script src="https://cdn.jsdelivr.net/npm/spotlight.js/dist/js/spotlight.min.js" defer></script>
<!-- Diff2HTML for Version History -->
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css" />
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js"></script>
<!-- ======== MODIFICATION: ADDED LINK TO NEW CSS FILE ======== -->
<link rel="stylesheet" href="busy_new.css">
<style>
        :root {
            /* Theme variables from audit.html */
            --bg-dark: #0F1015;
            --bg-card: #1A1C23;
            --bg-header: #21242D;
            --primary-accent: #6C5DD3;
            --primary-accent-light: #8374FF;
            --secondary-accent: #3F8CFF;
            --text-light: #F5F5F5;
            --text-muted: #9CA3B3;
            --border-color: #2A2D38;
            --success: #00B69B;
            --success-light: #00D6B5;
            --warning: #FFC454;
            --danger: #FF6A55;
            --font-family: 'Poppins', sans-serif;
            --border-radius: 16px;
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
            --shadow-hover: 0 8px 30px rgba(0, 0, 0, 0.35);
            --gradient-primary: linear-gradient(135deg, #6C5DD3 0%, #8374FF 100%);

            /* Original Sidebar Variables (Preserved) */
            --sidebar-width: 260px;
            --bg-color-sidebar: #1f2937; 
            
            /* Mapping variables for easier integration */
            --primary-color: var(--primary-accent);
            --primary-color-hover: var(--primary-accent-light);
            --text-color: var(--text-light);
            --text-color-muted: var(--text-muted);
            --text-color-inverted: #ffffff;
            --bg-color: var(--bg-dark);
            --bg-color-alt: var(--bg-card);
            --bg-color-header: rgba(33, 36, 45, 0.8);
            --bg-color-modal: var(--bg-card);
            --bg-color-hover: #2A2D38;
            --bg-color-active: var(--primary-accent);
            --border-color-darker: #4b5563;
            --card-shadow: var(--shadow);
            --card-hover-shadow: var(--shadow-hover);
            --border-radius-lg: var(--border-radius);
            --header-height: 70px;
            --yes-color: var(--success);
            --no-color: var(--danger);
            --rating-color: var(--warning);
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        
        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            line-height: 1.6;
            font-size: 16px;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(108, 93, 211, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(63, 140, 255, 0.05) 0%, transparent 20%);
        }

        /* --- HIDE SCROLLBARS --- */
        .sidebar, .content-wrapper, #recentActivity {
            -ms-overflow-style: none; scrollbar-width: none;
        }
        .sidebar::-webkit-scrollbar, .content-wrapper::-webkit-scrollbar, #recentActivity::-webkit-scrollbar {
            display: none;
        }


        a { text-decoration-skip-ink: none; }
        
        [lang='ar'] {
            font-family: 'Cairo', sans-serif;
            direction: rtl;
        }

        .container-fluid {
            display: flex;
            min-height: 100vh;
        }

        /* --- SIDEBAR STYLES (PRESERVED) --- */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-color-sidebar);
            padding: 1.5rem;
            border-right: 1px solid var(--border-color);
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            overflow-y: auto;
            transition: transform 0.3s ease-in-out;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }
        .sidebar.closed { transform: translateX(-100%); }
        @media (min-width: 768px) { .sidebar.closed { transform: translateX(0); } }
        .sidebar-header {
            font-size: 1.5rem; font-weight: 700; margin-bottom: 2rem; display: flex; align-items: center; color: #F9FAFB; padding-left: 0.5rem;
        }
        .sidebar-header img { height: 36px; width: auto; border-radius: 6px; margin-right: 12px; }
        .sidebar-logo-text { color: var(--text-color); }
        .sidebar-nav { flex-grow: 1; }
        .sidebar-section-title {
            padding-left: 0.75rem; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; margin-top: 1.5rem; margin-bottom: 0.5rem; color: #9ca3af; /* Muted color preserved */
        }
        .sidebar-link {
            display: flex; align-items: center; padding: 0.75rem; border-radius: 0.5rem; transition: background-color 0.2s ease, color 0.2s ease; font-weight: 500; color: #9ca3af; text-decoration: none; margin-bottom: 0.25rem;
        }
        .sidebar-link i { margin-right: 0.75rem; width: 1.5rem; font-size: 1.25rem; text-align: center; transition: color 0.2s ease; }
        .sidebar-link:hover { background-color: #374151; color: #d1d5db; }
        .sidebar-link.active { background-color: #6366f1; color: #ffffff !important; font-weight: 600; }
        .sidebar-link.active i { color: #ffffff !important; }
        .sidebar-footer { margin-top: auto; padding-top: 1rem; }
        /* --- END OF PRESERVED SIDEBAR STYLES --- */


        .content-wrapper {
            flex-grow: 1;
            padding: 1.5rem;
            transition: margin-left 0.3s ease-in-out;
            height: 100vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        @media (min-width: 768px) {
             .content-wrapper { margin-left: var(--sidebar-width); }
             .sidebar.closed + .content-wrapper { margin-left: 0; }
        }

        .content-header {
            background-color: var(--bg-color-header);
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            height: var(--header-height);
            z-index: 50;
            backdrop-filter: blur(8px);
        }
        
        .header-left-content { display: flex; align-items: center; gap: 1rem; }
        #currentSectionTitle { font-size: 1.5rem; font-weight: bold; margin: 0; }
        #breadcrumbs { font-size: 0.875rem; color: var(--text-color-muted); margin-top: 0.25rem; }
        #breadcrumbs a { color: var(--primary-color); text-decoration: none; }
        #breadcrumbs a:hover { text-decoration: underline; }

        .header-right-content { display: flex; align-items: center; gap: 1rem; }
        
        .admin-toolbar {
            display: flex; align-items: center; gap: 0.25rem; background-color: var(--bg-color-alt); padding: 0.3rem; border-radius: 0.5rem; border: 1px solid var(--border-color);
        }
        .admin-toolbar a {
            padding: 0.5rem 1rem; font-size: 0.875rem; font-weight: 500; color: var(--text-color-muted); text-decoration: none; border-radius: 0.5rem; transition: all 0.2s ease; display: flex; align-items: center; gap: 0.5rem;
        }
        .admin-toolbar a:hover { color: var(--text-color); }
        .admin-toolbar a.active { background-color: var(--bg-color); color: var(--text-color-inverted); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        .search-container input[type="search"] {
            padding: 0.625rem 1rem 0.625rem 2.5rem; border: 1px solid var(--border-color); border-radius: 9999px; min-width: 250px; background-color: var(--bg-color-alt); color: var(--text-color); transition: all 0.2s ease;
        }
         .search-container input[type="search"]:focus {
            min-width: 300px; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(108, 93, 211, 0.2);
        }
        .search-container .search-icon {
            position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: var(--text-color-muted);
        }
        
        .user-profile { display: flex; align-items: center; gap: 0.75rem; }
        #userAvatar {
            width: 36px; height: 36px; border-radius: 50%; background: var(--gradient-primary); color: var(--text-color-inverted); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.9rem;
        }
        
        main { 
            padding-top: 1.5rem;
            flex-grow: 1;
        }

        .card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--card-hover-shadow);
            border-color: var(--primary-accent-light);
        }
        .card-header-icon {
            display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 0.75rem; gap: 1rem;
        }
        .card-icon-container {
            padding: 0.75rem; border-radius: 50%; margin-right: 1rem; background: var(--gradient-primary); opacity: 0.1; flex-shrink: 0;
        }
        .card-icon-container i {
            font-size: 1.25rem; color: var(--primary-color);
        }
        
        .button, button {
            background: var(--gradient-primary);
            color: var(--text-color-inverted);
            border: none;
            padding: 0.625rem 1rem;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            transition: var(--transition);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            box-shadow: var(--shadow);
        }
        .button:hover, button:hover {
             transform: translateY(-2px);
             filter: brightness(1.1);
             box-shadow: var(--shadow-hover);
        }
        .button-secondary {
            background: var(--bg-card);
            color: var(--text-light);
            border: 1px solid var(--border-color);
        }
        .button-secondary:hover { background-color: var(--bg-header); border-color: var(--primary-accent); }
        .button-danger {
            background: var(--danger);
            color: var(--text-color-inverted);
        }
        .button-danger:hover { background: var(--danger); filter: brightness(1.1); }
        
        .modal-overlay {
            position: fixed; inset: 0; background-color: rgba(15, 16, 21, 0.8); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; padding: 1rem; z-index: 1000; opacity: 0; transition: opacity 0.3s ease-out; pointer-events: none;
        }
        .modal-overlay:not(.hidden) { opacity: 1; pointer-events: auto; }
        .modal-content {
            background-color: var(--bg-color-modal); border: 1px solid var(--border-color); padding: 1.5rem; border-radius: var(--border-radius-lg); box-shadow: var(--shadow-hover); width: 100%; max-width: 48rem; max-height: 90vh; overflow-y: auto; transform: scale(0.95); opacity: 0; transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }
        .modal-overlay:not(.hidden) .modal-content { transform: scale(1); opacity: 1; }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);
        }
        .modal-header h2 { margin: 0; font-size: 1.5rem; font-weight: 700; }
        .modal-header .close-button {
            background: none; border: none; font-size: 1.5rem; color: var(--text-color-muted); cursor: pointer; padding: 0.25rem; line-height: 1; border-radius: 50%;
        }
        .modal-header .close-button:hover { color: var(--primary-accent); }
        

        footer {
            text-align: center; padding: 1.5rem; font-size: 0.875rem; color: var(--text-color-muted); border-top: 1px solid var(--border-color); margin-top: auto;
        }
        
        .mobile-sidebar-toggle {
            display: block; position: fixed; top: calc((var(--header-height) - 40px) / 2); left: 1.5rem; z-index: 101; background: var(--bg-header); color: white; border: 1px solid var(--border-color); padding: 0.5rem 0.75rem; border-radius: 0.5rem; font-size: 1.25rem; line-height: 1;
        }
        @media (min-width: 768px) { .mobile-sidebar-toggle { display: none; } }
        
        .toast-notification {
            position: fixed; bottom: 20px; right: 20px; padding: 12px 20px; border-radius: var(--border-radius); box-shadow: var(--shadow-hover); z-index: 2000; opacity: 0; transform: translateY(20px); transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); display: flex; align-items: center; color: white;
        }
        .toast-notification.show { opacity: 1; transform: translateY(0); }
        .toast-icon { margin-right: 10px; font-size: 1.2em; }
        .toast-success { background-color: var(--success); }
        .toast-error { background-color: var(--danger); }
        .toast-info { background-color: var(--primary-accent); }

        .cards-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.5rem;
        }
        
        /* ======== DASHBOARD STYLES (UNIFIED) ======== */
        .dashboard-stats-grid {
            display: grid; gap: 1.5rem; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        }
        @media(min-width: 1280px) { .dashboard-stats-grid { grid-template-columns: repeat(5, 1fr); } }

        .dashboard-main-grid {
            display: grid; gap: 1.5rem; grid-template-columns: 1fr; margin-top: 1.5rem;
        }
        @media(min-width: 1024px) { .dashboard-main-grid { grid-template-columns: 2fr 1fr; } }
        
        .dashboard-stat-card {
            background-color: var(--bg-card); border: 1px solid var(--border-color); padding: 1.5rem; border-radius: var(--border-radius-lg); box-shadow: var(--card-shadow); display: flex; align-items: center; gap: 1rem; position: relative; transition: var(--transition);
        }
        .dashboard-stat-card:hover {
            transform: translateY(-5px); border-color: var(--primary-accent-light); box-shadow: var(--card-hover-shadow);
        }
        /* MODIFICATION: Improved dashboard icon container style */
        .dashboard-stat-card .icon-container {
            font-size: 1.5rem;
            color: var(--primary-accent-light);
            background-color: rgba(108, 93, 211, 0.15);
            height: 52px;
            width: 52px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            border: 1px solid rgba(108, 93, 211, 0.2);
        }
        .dashboard-stat-card .stat-info .stat-value { 
            font-size: 2rem; 
            font-weight: 700; 
            display: block; 
            line-height: 1.2; 
            color: var(--text-light); 
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .dashboard-stat-card .stat-info .stat-label { 
            font-size: 0.85rem; 
            color: var(--text-color-muted); 
            font-weight: 500;
        }
        
        .stat-growth {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
        }
        
        .stat-growth.positive {
            background-color: rgba(0, 182, 155, 0.2);
            color: var(--success);
        }
        
        .stat-growth.negative {
            background-color: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }
        
        .chart-container {
            position: relative; padding: 1.5rem; border-radius: var(--border-radius-lg); background-color: var(--bg-card); border: 1px solid var(--border-color); box-shadow: var(--shadow); min-height: 400px; display: flex; flex-direction: column; transition: var(--transition);
        }
        .chart-container:hover {
             transform: translateY(-5px); box-shadow: var(--shadow-hover);
        }
        /* MODIFICATION: Add min-width to prevent overflow on zoom */
        .dashboard-main-grid > .chart-container,
        .dashboard-main-grid > .card {
            min-width: 0;
        }
        .chart-container h3, #topUsersContainer h3 {
            font-size: 1.25rem; font-weight: 600; margin: 0 0 1rem 0; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color); color: var(--text-light);
        }
        .chart-placeholder {
            flex-grow: 1; /* This fixes the chart alignment */
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            /* MODIFICATION: Add min-height to prevent overflow on zoom */
            min-height: 0;
        }
        
        .hidden { display: none !important; }

        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.875rem; color: var(--text-muted); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--border-color); border-radius: 12px; background-color: var(--bg-dark); color: var(--text-light); transition: var(--transition); }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none; border-color: var(--primary-accent); box-shadow: 0 0 0 3px rgba(108, 93, 211, 0.2);
        }

        /* ======== ACTIVITY LOG STYLES (UNIFIED) ======== */
        #recentActivityContainer {
            grid-column: 1 / -1;
        }
        #recentActivityContainer h3 {
            font-size: 1.25rem; font-weight: 600; margin: 0 0 1rem 0; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);
        }
        .activity-log-item {
            display: flex; align-items: center; gap: 1rem; padding: 0.85rem 0.5rem; border-radius: 0.5rem; transition: background-color 0.2s ease;
        }
        .activity-log-item:hover { background-color: var(--bg-color-hover); }
        .activity-details .activity-user { font-weight: 600; color: var(--text-color); }
        .activity-details .activity-item-title { color: var(--primary-color); font-weight: 500; }
        
        /* Top Users List Styles */
        #topUsersContainer {
            padding: 1.5rem;
        }
        .top-users-list {
            list-style: none; padding: 0; margin: 0; flex-grow: 1; overflow-y: auto; max-height: 300px;
        }
        .top-user-item {
            display: flex; align-items: center; justify-content: space-between; padding: 0.9rem 0.5rem; border-bottom: 1px solid var(--border-color);
        }
        .top-user-item:last-child { border-bottom: none; }
        .top-user-info { display: flex; align-items: center; gap: 1rem; }
        .top-user-rank { 
            font-size: 0.9rem; 
            font-weight: bold; 
            color: var(--text-color-muted); 
            width: 24px; 
            height: 24px;
            text-align: center; 
            line-height: 24px;
            background-color: var(--bg-color-hover);
            border-radius: 50%;
        }
        .top-user-name { font-weight: 500; }
        .top-user-views {
            font-size: 1rem; font-weight: 600; color: var(--primary-color-light); background-color: rgba(108, 93, 211, 0.1); padding: 0.25rem 0.6rem; border-radius: 6px;
        }
        
        /* MODIFICATION: Added styles for the action bar in the item detail view */
        .item-actions-bar {
            display: flex;
            gap: 0.75rem; /* Adds space between buttons */
            align-items: center;
            margin-bottom: 1.5rem; /* Adds space below the bar */
            flex-wrap: wrap; /* Allows buttons to wrap on smaller screens */
        }

        /* ======== ROLE-BASED ACCESS STYLES (UNIFIED) ======== */
        .restricted-notice {
            text-align: center; margin-top: 60px; color: var(--text-light); background: var(--bg-card); padding: 40px; border-radius: var(--border-radius); border: 1px solid var(--border-color); box-shadow: var(--shadow-hover); max-width: 600px; margin-left: auto; margin-right: auto;
        }
        .restricted-icon { font-size: 56px; margin-bottom: 20px; color: var(--danger); }
        .restricted-notice h2 { font-size: 1.75rem; margin-bottom: 0.75rem; }
        .restricted-notice p { font-size: 1rem; line-height: 1.6; color: var(--text-muted); }
        
        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--text-color-muted);
        }
        
        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .empty-state h3 {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            color: var(--text-color);
        }
        
        .empty-state p {
            margin-bottom: 1.5rem;
        }
        
        /* Improved button sizes */
        .button-lg {
            padding: 0.875rem 1.5rem;
            font-size: 1rem;
        }
        
        .button-sm {
            padding: 0.5rem 0.875rem;
            font-size: 0.8rem;
        }
        
        /* Improved spacing */
        .spacing-xs { margin-bottom: 0.5rem; }
        .spacing-sm { margin-bottom: 1rem; }
        .spacing-md { margin-bottom: 1.5rem; }
        .spacing-lg { margin-bottom: 2rem; }
        .spacing-xl { margin-bottom: 3rem; }
        
        .spacing-top-xs { margin-top: 0.5rem; }
        .spacing-top-sm { margin-top: 1rem; }
        .spacing-top-md { margin-top: 1.5rem; }
        .spacing-top-lg { margin-top: 2rem; }
</style>

</head>
<body id="pageBody">
<header class="app-header">
  <div class="brand">Knowledge Base</div>
  <nav>
    <a href="app.html" id="link-dashboard" data-role-required="admin,manager">Dashboard</a>
    <a href="insights.html" id="link-insights" data-role-required="admin,manager">Insights</a>
    <a href="employees.html" id="link-employees" data-role-required="admin,manager">Employees</a>
    <a href="audit.html" id="link-audit" data-role-required="admin,manager">Audit Log</a>
    <span id="role-badge" style="margin-left:12px;padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.02);font-size:13px">guest</span>
  </nav>
</header>


<div class="modal-overlay hidden" id="addContentModalOverlay">
<div class="modal-content">
<div class="modal-header">
<h2 id="addContentModalTitle">Add New Content</h2>
<button aria-label="Close" class="close-button" id="closeAddContentModalBtn">×</button>
</div>
<div class="hidden" id="templateSelectionContainer">
<h3>Choose a Template</h3>
<div class="template-buttons-grid">
<button class="template-button" data-template="standard_article">
<i class="fas fa-newspaper"></i>
<h4>Standard Article</h4>
<p>For general information, announcements, or detailed explanations.</p>
</button>
<button class="template-button" data-template="troubleshooting_guide">
<i class="fas fa-tools"></i>
<h4>Troubleshooting Guide / Case</h4>
<p>Step-by-step solutions for common issues or case documentation.</p>
</button>
<button class="template-button" data-template="how_to_guide">
<i class="fas fa-graduation-cap"></i>
<h4>How-To Guide</h4>
<p>Instructions for completing specific tasks or processes.</p>
</button>
<button class="template-button" data-template="policy_document">
<i class="fas fa-file-contract"></i>
<h4>Policy Document</h4>
<p>Formal company policies, procedures, or compliance information.</p>
</button>
<button class="template-button" data-template="faq">
<i class="fas fa-question-circle"></i>
<h4>FAQ</h4>
<p>Frequently Asked Questions with concise answers.</p>
</button>
<button class="template-button" data-template="announcement">
<i class="fas fa-bullhorn"></i>
<h4>Announcement</h4>
<p>Important updates, news, or time-sensitive information.</p>
</button>
</div>
</div>
<div class="hidden" id="contentFormContainer">
<form id="addContentForm">
<div class="form-group">
<label for="contentTitle">Title</label>
<input id="contentTitle" name="title" placeholder="Enter a descriptive title..." required type="text">
</div>
<div class="form-group">
<label for="contentCategory">Category</label>
<select id="contentCategory" name="category">
<option value="general">General</option>
<option value="hr">Human Resources</option>
<option value="it">IT Support</option>
<option value="operations">Operations</option>
<option value="finance">Finance</option>
<option value="sales">Sales & Marketing</option>
</select>
</div>
<div class="form-group">
<label for="contentTags">Tags (comma-separated)</label>
<input id="contentTags" name="tags" placeholder="e.g., onboarding, software, guide" type="text">
</div>
<div class="form-group">
<label for="contentBody">Content</label>
<div id="editor-container" style="height: 300px;"></div>
<textarea class="hidden" id="contentBody" name="body"></textarea>
</div>
<div class="form-group">
<label for="contentStatus">Status</label>
<select id="contentStatus" name="status">
<option value="draft">Draft</option>
<option value="published">Published</option>
<option value="archived">Archived</option>
</select>
</div>
<div class="form-actions">
<button class="button button-secondary" id="backToTemplatesBtn" type="button">Back to Templates</button>
<button class="button" type="submit">Create Content</button>
</div>
</form>
</div>
</div>
</div>

<div class="protected-modal" id="protectedModal">
<div class="protected-modal-card">
<h3>Access Restricted</h3>
<p>You don't have permission to view this content. Please contact your administrator if you believe this is an error.</p>
<div class="protected-modal-actions">
<button id="closeProtectedModalBtn">Close</button>
</div>
</div>
</div>

<div class="container-fluid">
<aside class="sidebar" id="sidebar">
<div class="sidebar-header">
<img alt="InfiniBase Logo" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTE2IDI5LjMzMzNDMjMuMzYzOCAyOS4zMzMzIDI5LjMzMzMgMjMuMzYzOCAyOS4zMzMzIDE2QzI5LjMzMzMgOC42MzYyIDIzLjM2MzggMi42NjY2NyAxNiAyLjY2NjY3QzguNjM2MiAyLjY2NjY3IDIuNjY2NjcgOC42MzYyIDIuNjY2NjcgMTZDMy4wMDAwMSAyMy4zNjM4IDguOTY5MzQgMjkuMzMzMyAxNi4zMzMzIDI5LjMzMzMiIHN0cm9rZT0iIzZDNUREMyIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiLz4KPHBhdGggZD0iTTEwLjY2NjcgMTIuNjY2N0gxMy4zMzMzVjE5LjMzMzNIMTAuNjY2N1YxMi42NjY3WiIgZmlsbD0iIzZDNUREMyIvPgo8cGF0aCBkPSJNMTguNjY2NyAxMi42NjY3SDIxLjMzMzNWMTkuMzMzM0gxOC42NjY3VjEyLjY2NjdaIiBmaWxsPSIjNkM1REQzIi8+Cjwvc3ZnPgo="/>
<span class="sidebar-logo-text">InfiniBase</span>
</div>
<nav class="sidebar-nav">
<div class="sidebar-section-title">Main</div>
<a class="sidebar-link active" href="app.html">
<i class="fas fa-home"></i>
<span>Dashboard</span>
</a>
<a class="sidebar-link" href="knowledge-base.html">
<i class="fas fa-book"></i>
<span>Knowledge Base</span>
</a>
<a class="sidebar-link" href="cases.html">
<i class="fas fa-folder-open"></i>
<span>Cases</span>
</a>
<a class="sidebar-link" href="search.html">
<i class="fas fa-search"></i>
<span>Search</span>
</a>
<div class="sidebar-section-title">Management</div>
<a class="sidebar-link" href="insights.html" data-role-required="admin,manager">
<i class="fas fa-chart-line"></i>
<span>Insights</span>
</a>
<a class="sidebar-link" href="employees.html" data-role-required="admin,manager">
<i class="fas fa-users"></i>
<span>Employees</span>
</a>
<a class="sidebar-link" href="audit.html" data-role-required="admin,manager">
<i class="fas fa-clipboard-list"></i>
<span>Audit Log</span>
</a>
<div class="sidebar-section-title">Account</div>
<a class="sidebar-link" href="profile.html">
<i class="fas fa-user"></i>
<span>Profile</span>
</a>
<a class="sidebar-link" href="settings.html">
<i class="fas fa-cog"></i>
<span>Settings</span>
</a>
<a class="sidebar-link" href="#" id="logoutBtn">
<i class="fas fa-sign-out-alt"></i>
<span>Logout</span>
</a>
</nav>
<div class="sidebar-footer">
<div class="user-profile">
<div id="userAvatar">U</div>
<div>
<div id="userName">User</div>
<div id="userRole" style="font-size: 0.75rem; color: #9ca3af;">Loading...</div>
</div>
</div>
</div>
</aside>

<div class="content-wrapper">
<header class="content-header">
<div class="header-left-content">
<h1 id="currentSectionTitle">Dashboard</h1>
<div id="breadcrumbs">
<a href="app.html">Dashboard</a>
</div>
</div>
<div class="header-right-content">
<div class="admin-toolbar">
<a class="active" href="app.html">
<i class="fas fa-home"></i>
<span>Dashboard</span>
</a>
<a href="knowledge-base.html">
<i class="fas fa-book"></i>
<span>Knowledge Base</span>
</a>
<a href="cases.html">
<i class="fas fa-folder-open"></i>
<span>Cases</span>
</a>
</div>
<div class="search-container" style="position: relative;">
<i class="fas fa-search search-icon"></i>
<input placeholder="Search knowledge base..." type="search">
</div>
<div class="user-profile">
<div id="userAvatar">U</div>
<span id="userName">User</span>
</div>
</div>
</header>

<main>
<div class="dashboard-stats-grid">
<div class="dashboard-stat-card">
<div class="icon-container">
<i class="fas fa-book"></i>
</div>
<div class="stat-info">
<span class="stat-value" id="totalArticles">--</span>
<span class="stat-label">Total Articles</span>
</div>
<div class="stat-growth positive">
+5%
</div>
</div>
<div class="dashboard-stat-card">
<div class="icon-container">
<i class="fas fa-eye"></i>
</div>
<div class="stat-info">
<span class="stat-value" id="totalViews">--</span>
<span class="stat-label">Total Views</span>
</div>
<div class="stat-growth positive">
+12%
</div>
</div>
<div class="dashboard-stat-card">
<div class="icon-container">
<i class="fas fa-edit"></i>
</div>
<div class="stat-info">
<span class="stat-value" id="totalEdits">--</span>
<span class="stat-label">Total Edits</span>
</div>
<div class="stat-growth positive">
+3%
</div>
</div>
<div class="dashboard-stat-card">
<div class="icon-container">
<i class="fas fa-users"></i>
</div>
<div class="stat-info">
<span class="stat-value" id="activeUsers">--</span>
<span class="stat-label">Active Users</span>
</div>
<div class="stat-growth positive">
+8%
</div>
</div>
<div class="dashboard-stat-card">
<div class="icon-container">
<i class="fas fa-thumbs-up"></i>
</div>
<div class="stat-info">
<span class="stat-value" id="helpfulRatings">--</span>
<span class="stat-label">Helpful Ratings</span>
</div>
<div class="stat-growth positive">
+15%
</div>
</div>
</div>

<div class="dashboard-main-grid">
<div class="card">
<div class="card-header-icon">
<div class="card-icon-container">
<i class="fas fa-chart-bar"></i>
</div>
<div>
<h3>Content Performance</h3>
<p>Views and engagement over time</p>
</div>
</div>
<div class="chart-placeholder">
<canvas id="contentPerformanceChart"></canvas>
</div>
</div>

<div class="card" id="topUsersContainer">
<h3>Most Active Users</h3>
<div class="top-users-list" id="topUsersList">
<div class="empty-state">
<div class="empty-state-icon">
<i class="fas fa-users"></i>
</div>
<h3>No Active Users</h3>
<p>User activity data will appear here</p>
</div>
</div>
</div>
</div>

<div class="card" id="recentActivityContainer">
<h3>Recent Activity</h3>
<div id="recentActivity">
<div class="empty-state">
<div class="empty-state-icon">
<i class="fas fa-history"></i>
</div>
<h3>No Recent Activity</h3>
<p>Activity data will appear here</p>
</div>
</div>
</div>
</main>

<footer>
<div>InfiniBase Knowledge Management System &copy; 2025</div>
</footer>
</div>
</div>

<script>
// ========== DASHBOARD DATA FETCHING AND DISPLAY ==========
async function fetchDashboardData() {
    try {
        // استخدم فقط الجداول الموجودة
        const results = await Promise.allSettled([
            supabase.from('activity_log').select('*').limit(50),
            supabase.from('cases').select('*'),
            supabase.from('kb_feedback').select('*'),
            supabase.from('users').select('id, name, email, username, full_name').limit(10)
        ]);

        const activity = results[0].value?.data || [];
        const articles = results[1].value?.data || [];
        const feedback = results[2].value?.data || [];
        const users = results[3].value?.data || [];

        // حساب الإحصائيات الأساسية
        const totalArticles = articles.length;
        const totalViews = activity.filter(act => act.action === 'viewed').length;
        const totalEdits = activity.filter(act => act.action === 'updated').length;
        const activeUsers = [...new Set(activity.map(act => act.user_id))].length;
        const helpfulRatings = feedback.filter(fb => fb.rating >= 4).length;
        const notHelpfulRatings = feedback.filter(fb => fb.rating < 3).length;

        // 🔥 MOST ACTIVE USERS - الديناميكي الجديد
        const userStats = {};
        
        activity.forEach(act => {
            if (act.action === 'viewed') {
                const userId = act.user_id;
                if (!userStats[userId]) {
                    // البحث عن بيانات المستخدم
                    const user = users.find(u => u.id === userId);
                    userStats[userId] = {
                        user_name: user?.name || user?.full_name || user?.username || user?.email || `User ${userId}`,
                        total_articles_viewed: 0
                    };
                }
                userStats[userId].total_articles_viewed++;
            }
        });

        const topUsers = Object.values(userStats)
            .sort((a, b) => b.total_articles_viewed - a.total_articles_viewed)
            .slice(0, 5);

        return {
            activityLog: activity,
            overallInsights: {
                total_articles: totalArticles,
                total_views_all: totalViews,
                total_edits: totalEdits,
                active_users_this_week: activeUsers
            },
            feedbackKpis: {
                helpful_ratings: helpfulRatings,
                not_helpful_ratings: notHelpfulRatings
            },
            topUsers: topUsers
        };
    } catch (error) {
        console.error('Error fetching dashboard data:', error);
        return getFallbackDashboardData();
    }
}

function getFallbackDashboardData() {
    return {
        activityLog: [],
        overallInsights: {
            total_articles: 0,
            total_views_all: 0,
            total_edits: 0,
            active_users_this_week: 0
        },
        feedbackKpis: {
            helpful_ratings: 0,
            not_helpful_ratings: 0
        },
        topUsers: []
    };
}

function updateDashboardUI(data) {
    // تحديث الإحصائيات
    document.getElementById('totalArticles').textContent = data.overallInsights.total_articles;
    document.getElementById('totalViews').textContent = data.overallInsights.total_views_all;
    document.getElementById('totalEdits').textContent = data.overallInsights.total_edits;
    document.getElementById('activeUsers').textContent = data.overallInsights.active_users_this_week;
    document.getElementById('helpfulRatings').textContent = data.feedbackKpis.helpful_ratings;

    // تحديث قائمة المستخدمين النشطين
    updateTopUsersList(data.topUsers);

    // تحديث سجل النشاط
    updateRecentActivity(data.activityLog);

    // تحديث الرسوم البيانية
    updateCharts(data);
}

function updateTopUsersList(topUsers) {
    const topUsersList = document.getElementById('topUsersList');
    
    if (topUsers.length === 0) {
        topUsersList.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">
                    <i class="fas fa-users"></i>
                </div>
                <h3>No Active Users</h3>
                <p>User activity data will appear here</p>
            </div>
        `;
        return;
    }

    topUsersList.innerHTML = topUsers.map((user, index) => `
        <div class="top-user-item">
            <div class="top-user-info">
                <div class="top-user-rank">${index + 1}</div>
                <div class="top-user-name">${user.user_name}</div>
            </div>
            <div class="top-user-views">${user.total_articles_viewed} views</div>
        </div>
    `).join('');
}

function updateRecentActivity(activityLog) {
    const recentActivity = document.getElementById('recentActivity');
    
    if (activityLog.length === 0) {
        recentActivity.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">
                    <i class="fas fa-history"></i>
                </div>
                <h3>No Recent Activity</h3>
                <p>Activity data will appear here</p>
            </div>
        `;
        return;
    }

    recentActivity.innerHTML = activityLog.slice(0, 10).map(activity => `
        <div class="activity-log-item">
            <div class="activity-icon">
                <i class="fas fa-${getActivityIcon(activity.action)}"></i>
            </div>
            <div class="activity-details">
                <span class="activity-user">${getUserName(activity.user_id)}</span>
                <span>${getActivityText(activity.action)}</span>
                <span class="activity-item-title">${activity.item_title || 'Unknown Item'}</span>
                <span class="activity-time">${formatTime(activity.created_at)}</span>
            </div>
        </div>
    `).join('');
}

function getUserName(userId) {
    // في التطبيق الحقيقي، سنبحث عن اسم المستخدم في مصفوفة المستخدمين
    return `User ${userId.substring(0, 8)}`;
}

function getActivityIcon(action) {
    const icons = {
        'viewed': 'eye',
        'created': 'plus',
        'updated': 'edit',
        'deleted': 'trash'
    };
    return icons[action] || 'circle';
}

function getActivityText(action) {
    const texts = {
        'viewed': 'viewed',
        'created': 'created',
        'updated': 'updated',
        'deleted': 'deleted'
    };
    return texts[action] || 'performed an action on';
}

function formatTime(timestamp) {
    // دالة مساعدة لتنسيق الوقت
    const date = new Date(timestamp);
    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

function updateCharts(data) {
    // تحديث مخطط أداء المحتوى
    updateContentPerformanceChart(data);
}

function updateContentPerformanceChart(data) {
    const ctx = document.getElementById('contentPerformanceChart').getContext('2d');
    
    // بيانات تجريبية للرسم البياني
    const labels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
    const viewsData = [65, 59, 80, 81, 56, 55, 40];
    const editsData = [28, 48, 40, 19, 86, 27, 90];
    
    // تدمير المخطط الحالي إذا كان موجوداً
    if (window.contentPerformanceChart instanceof Chart) {
        window.contentPerformanceChart.destroy();
    }
    
    // إنشاء مخطط جديد
    window.contentPerformanceChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Views',
                    data: viewsData,
                    borderColor: '#6C5DD3',
                    backgroundColor: 'rgba(108, 93, 211, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: 'Edits',
                    data: editsData,
                    borderColor: '#3F8CFF',
                    backgroundColor: 'rgba(63, 140, 255, 0.1)',
                    tension: 0.4,
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        color: '#F5F5F5',
                        font: {
                            family: "'Poppins', sans-serif"
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: '#9CA3B3'
                    }
                },
                y: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: '#9CA3B3'
                    }
                }
            }
        }
    });
}

// تهيئة لوحة التحكم عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', async function() {
    // تحميل البيانات وعرضها
    const data = await fetchDashboardData();
    updateDashboardUI(data);
    
    // تحديث كل 30 ثانية
    setInterval(async () => {
        const newData = await fetchDashboardData();
        updateDashboardUI(newData);
    }, 30000);
});

// ========== إدارة الأدوار والوصول ==========
function checkRoleAccess() {
    const userRole = localStorage.getItem('userRole') || 'guest';
    document.getElementById('userRole').textContent = userRole;
    document.getElementById('role-badge').textContent = userRole;
    
    // تحديث رمز المستخدم
    const userAvatar = document.getElementById('userAvatar');
    const userName = document.getElementById('userName');
    const storedName = localStorage.getItem('userName') || 'User';
    
    userAvatar.textContent = storedName.charAt(0).toUpperCase();
    userName.textContent = storedName;
    
    // التحقق من الروابط المحمية
    document.querySelectorAll('[data-role-required]').forEach(link => {
        const requiredRoles = link.getAttribute('data-role-required').split(',');
        if (!requiredRoles.includes(userRole)) {
            link.classList.add('protected-link');
            link.addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById('protectedModal').classList.add('open');
            });
        }
    });
}

// ========== إدارة النمط الجانبي ==========
document.addEventListener('DOMContentLoaded', function() {
    const sidebar = document.getElementById('sidebar');
    const mobileToggle = document.querySelector('.mobile-sidebar-toggle');
    
    if (mobileToggle) {
        mobileToggle.addEventListener('click', function() {
            sidebar.classList.toggle('closed');
        });
    }
    
    // إغلاق النمط الجانبي عند النقر خارجها على الأجهزة المحمولة
    document.addEventListener('click', function(event) {
        if (window.innerWidth < 768 && 
            !sidebar.contains(event.target) && 
            event.target !== mobileToggle && 
            !sidebar.classList.contains('closed')) {
            sidebar.classList.add('closed');
        }
    });
});

// ========== إدارة النماذج ==========
document.addEventListener('DOMContentLoaded', function() {
    const protectedModal = document.getElementById('protectedModal');
    const closeProtectedModalBtn = document.getElementById('closeProtectedModalBtn');
    
    if (closeProtectedModalBtn) {
        closeProtectedModalBtn.addEventListener('click', function() {
            protectedModal.classList.remove('open');
        });
    }
    
    // إغلاق النماذج عند النقر خارجها
    protectedModal.addEventListener('click', function(e) {
        if (e.target === protectedModal) {
            protectedModal.classList.remove('open');
        }
    });
});

// ========== تسجيل الخروج ==========
document.addEventListener('DOMContentLoaded', function() {
    const logoutBtn = document.getElementById('logoutBtn');
    
    if (logoutBtn) {
        logoutBtn.addEventListener('click', function(e) {
            e.preventDefault();
            localStorage.clear();
            window.location.href = 'index.html';
        });
    }
});

// تهيئة الأدوار عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', checkRoleAccess);
</script>
</body>
</html>
