\<!DOCTYPE html>
<html class="dark" data-hash="2025-06-24T15:30" dir="ltr" lang="en">
<head>
  <style>
/* Shared design tokens and improvements */
:root{
  --brand-500: #0b5fff; /* primary */
  --brand-600: #084fd6;
  --muted-600: #6b7280;
  --bg: #0f1724;
  --card-bg: #0b1220;
  --glass: rgba(255,255,255,0.04);
  --success: #16a34a;
  --danger: #ef4444;
  --radius: 10px;
  --gap: 12px;
  --max-width: 1200px;
  --mono: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue';
}

/* Reset small things */
body { font-family: var(--mono); margin:0; background: linear-gradient(180deg,#071428 0%, #071727 100%); color: #e6eef8; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
.container{ max-width: var(--max-width); margin: 0 auto; padding: 20px; }

/* Sticky header */
.app-header{
  position: sticky; top:0; z-index:40; background: rgba(6,11,22,0.7); backdrop-filter: blur(6px); border-bottom: 1px solid rgba(255,255,255,0.04);
  display:flex; align-items:center; justify-content:space-between; padding: 10px 18px;
}
.app-header .brand { display:flex; align-items:center; gap:10px; font-weight:700; font-size:18px; color:var(--brand-500); }
.app-header nav{ display:flex; gap:10px; align-items:center; }
.app-header a{ color: #dbeafe; text-decoration:none; padding:8px 12px; border-radius:8px; display:inline-block; font-size:14px; }
.app-header a:hover{ background: rgba(255,255,255,0.03); transform: translateY(-1px); transition: all 120ms ease; }

/* Protected link */
.protected-link{ opacity:0.6; cursor: pointer; position:relative; outline:none; }
.protected-link::after{ content: 'ðŸ”’'; margin-left:6px; font-size:12px; opacity:0.7; }

/* Sidebar */
.app-layout{ display:flex; gap:18px; align-items:flex-start; padding-top:12px; }
.sidebar{ width:260px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:14px; border-radius:12px; height: calc(100vh - 88px); position:sticky; top:76px; overflow:auto; box-shadow: 0 6px 20px rgba(2,6,23,0.6); }
.main{ flex:1; min-height: calc(100vh - 120px); padding-bottom:60px; }

/* Cards */
.card{ background: var(--card-bg); padding:16px; border-radius:var(--radius); box-shadow: 0 8px 30px rgba(2,6,23,0.6); border: 1px solid rgba(255,255,255,0.03); margin-bottom: var(--gap); }

/* Modal styles */
.protected-modal{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background: rgba(2,6,23,0.6); visibility:hidden; opacity:0; transition: all 180ms ease; z-index:80; }
.protected-modal.open{ visibility:visible; opacity:1; }
.protected-modal-card{ width:380px; background: linear-gradient(180deg, #071428, #041025); padding:18px; border-radius:12px; border:1px solid rgba(255,255,255,0.04); box-shadow: 0 8px 30px rgba(2,6,23,0.7); color:#dbeafe; }
.protected-modal-card h3{ margin:0 0 8px 0; }
.protected-modal-card p{ margin:0 0 16px 0; color:var(--muted-600); }
.protected-modal-actions{ display:flex; gap:8px; justify-content:flex-end; }
.protected-modal button{ background:transparent; color:var(--brand-500); border:1px solid rgba(255,255,255,0.04); padding:8px 10px; border-radius:8px; cursor:pointer; }

/* responsive */
@media (max-width:900px){
  .sidebar{ position:relative; width:100%; height:auto; top:0; }
  .app-layout{ flex-direction:column; }
  .app-header nav{ gap:6px; }
}

</style>

<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>InfiniBase - Command Center</title>
<!-- Cairo Font for Arabic -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<!-- Favicon -->
 <link rel="shortcut icon" href=favicon.ico type=image/x-icon>
<link rel=icon href=favicon.svg type=image/svg+xml>
<!-- CDNs -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet"/>
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet"/>
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/quill-image-resize-module@3.0.0/image-resize.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<!-- Spotlight.js for Lightbox Effect -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/spotlight.js/dist/css/spotlight.min.css" />
<script src="https://cdn.jsdelivr.net/npm/spotlight.js/dist/js/spotlight.min.js" defer></script>
<!-- Diff2HTML for Version History -->
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css" />
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js"></script>
<!-- ======== MODIFICATION: ADDED LINK TO NEW CSS FILE ======== -->
<link rel="stylesheet" href="busy_new.css">
<style>
        :root {
            /* Theme variables from audit.html */
            --bg-dark: #0F1015;
            --bg-card: #1A1C23;
            --bg-header: #21242D;
            --primary-accent: #6C5DD3;
            --primary-accent-light: #8374FF;
            --secondary-accent: #3F8CFF;
            --text-light: #F5F5F5;
            --text-muted: #9CA3B3;
            --border-color: #2A2D38;
            --success: #00B69B;
            --success-light: #00D6B5;
            --warning: #FFC454;
            --danger: #FF6A55;
            --font-family: 'Poppins', sans-serif;
            --border-radius: 16px;
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
            --shadow-hover: 0 8px 30px rgba(0, 0, 0, 0.35);
            --gradient-primary: linear-gradient(135deg, #6C5DD3 0%, #8374FF 100%);

            /* Original Sidebar Variables (Preserved) */
            --sidebar-width: 260px;
            --bg-color-sidebar: #1f2937; 
            
            /* Mapping variables for easier integration */
            --primary-color: var(--primary-accent);
            --primary-color-hover: var(--primary-accent-light);
            --text-color: var(--text-light);
            --text-color-muted: var(--text-muted);
            --text-color-inverted: #ffffff;
            --bg-color: var(--bg-dark);
            --bg-color-alt: var(--bg-card);
            --bg-color-header: rgba(33, 36, 45, 0.8);
            --bg-color-modal: var(--bg-card);
            --bg-color-hover: #2A2D38;
            --bg-color-active: var(--primary-accent);
            --border-color-darker: #4b5563;
            --card-shadow: var(--shadow);
            --card-hover-shadow: var(--shadow-hover);
            --border-radius-lg: var(--border-radius);
            --header-height: 70px;
            --yes-color: var(--success);
            --no-color: var(--danger);
            --rating-color: var(--warning);
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        
        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            line-height: 1.6;
            font-size: 16px;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(108, 93, 211, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(63, 140, 255, 0.05) 0%, transparent 20%);
        }

        /* --- HIDE SCROLLBARS --- */
        .sidebar, .content-wrapper, #recentActivity {
            -ms-overflow-style: none; scrollbar-width: none;
        }
        .sidebar::-webkit-scrollbar, .content-wrapper::-webkit-scrollbar, #recentActivity::-webkit-scrollbar {
            display: none;
        }


        a { text-decoration-skip-ink: none; }
        
        [lang='ar'] {
            font-family: 'Cairo', sans-serif;
            direction: rtl;
        }

        .container-fluid {
            display: flex;
            min-height: 100vh;
        }

        /* --- SIDEBAR STYLES (PRESERVED) --- */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-color-sidebar);
            padding: 1.5rem;
            border-right: 1px solid var(--border-color);
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            overflow-y: auto;
            transition: transform 0.3s ease-in-out;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }
        .sidebar.closed { transform: translateX(-100%); }
        @media (min-width: 768px) { .sidebar.closed { transform: translateX(0); } }
        .sidebar-header {
            font-size: 1.5rem; font-weight: 700; margin-bottom: 2rem; display: flex; align-items: center; color: #F9FAFB; padding-left: 0.5rem;
        }
        .sidebar-header img { height: 36px; width: auto; border-radius: 6px; margin-right: 12px; }
        .sidebar-logo-text { color: var(--text-color); }
        .sidebar-nav { flex-grow: 1; }
        .sidebar-section-title {
            padding-left: 0.75rem; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; margin-top: 1.5rem; margin-bottom: 0.5rem; color: #9ca3af; /* Muted color preserved */
        }
        .sidebar-link {
            display: flex; align-items: center; padding: 0.75rem; border-radius: 0.5rem; transition: background-color 0.2s ease, color 0.2s ease; font-weight: 500; color: #9ca3af; text-decoration: none; margin-bottom: 0.25rem;
        }
        .sidebar-link i { margin-right: 0.75rem; width: 1.5rem; font-size: 1.25rem; text-align: center; transition: color 0.2s ease; }
        .sidebar-link:hover { background-color: #374151; color: #d1d5db; }
        .sidebar-link.active { background-color: #6366f1; color: #ffffff !important; font-weight: 600; }
        .sidebar-link.active i { color: #ffffff !important; }
        .sidebar-footer { margin-top: auto; padding-top: 1rem; }
        /* --- END OF PRESERVED SIDEBAR STYLES --- */


        .content-wrapper {
            flex-grow: 1;
            padding: 1.5rem;
            transition: margin-left 0.3s ease-in-out;
            height: 100vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        @media (min-width: 768px) {
             .content-wrapper { margin-left: var(--sidebar-width); }
             .sidebar.closed + .content-wrapper { margin-left: 0; }
        }

        .content-header {
            background-color: var(--bg-color-header);
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            height: var(--header-height);
            z-index: 50;
            backdrop-filter: blur(8px);
        }
        
        .header-left-content { display: flex; align-items: center; gap: 1rem; }
        #currentSectionTitle { font-size: 1.5rem; font-weight: bold; margin: 0; }
        #breadcrumbs { font-size: 0.875rem; color: var(--text-color-muted); margin-top: 0.25rem; }
        #breadcrumbs a { color: var(--primary-color); text-decoration: none; }
        #breadcrumbs a:hover { text-decoration: underline; }

        .header-right-content { display: flex; align-items: center; gap: 1rem; }
        
        .admin-toolbar {
            display: flex; align-items: center; gap: 0.25rem; background-color: var(--bg-color-alt); padding: 0.3rem; border-radius: 0.5rem; border: 1px solid var(--border-color);
        }
        .admin-toolbar a {
            padding: 0.5rem 1rem; font-size: 0.875rem; font-weight: 500; color: var(--text-color-muted); text-decoration: none; border-radius: 0.5rem; transition: all 0.2s ease; display: flex; align-items: center; gap: 0.5rem;
        }
        .admin-toolbar a:hover { color: var(--text-color); }
        .admin-toolbar a.active { background-color: var(--bg-color); color: var(--text-color-inverted); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        .search-container input[type="search"] {
            padding: 0.625rem 1rem 0.625rem 2.5rem; border: 1px solid var(--border-color); border-radius: 9999px; min-width: 250px; background-color: var(--bg-color-alt); color: var(--text-color); transition: all 0.2s ease;
        }
         .search-container input[type="search"]:focus {
            min-width: 300px; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(108, 93, 211, 0.2);
        }
        .search-container .search-icon {
            position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: var(--text-color-muted);
        }
        
        .user-profile { display: flex; align-items: center; gap: 0.75rem; }
        #userAvatar {
            width: 36px; height: 36px; border-radius: 50%; background: var(--gradient-primary); color: var(--text-color-inverted); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.9rem;
        }
        
        main { 
            padding-top: 1.5rem;
            flex-grow: 1;
        }

        .card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--card-hover-shadow);
            border-color: var(--primary-accent-light);
        }
        .card-header-icon {
            display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 0.75rem; gap: 1rem;
        }
        .card-icon-container {
            padding: 0.75rem; border-radius: 50%; margin-right: 1rem; background: var(--gradient-primary); opacity: 0.1; flex-shrink: 0;
        }
        .card-icon-container i {
            font-size: 1.25rem; color: var(--primary-color);
        }
        
        .button, button {
            background: var(--gradient-primary);
            color: var(--text-color-inverted);
            border: none;
            padding: 0.625rem 1rem;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            transition: var(--transition);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            box-shadow: var(--shadow);
        }
        .button:hover, button:hover {
             transform: translateY(-2px);
             filter: brightness(1.1);
             box-shadow: var(--shadow-hover);
        }
        .button-secondary {
            background: var(--bg-card);
            color: var(--text-light);
            border: 1px solid var(--border-color);
        }
        .button-secondary:hover { background-color: var(--bg-header); border-color: var(--primary-accent); }
        .button-danger {
            background: var(--danger);
            color: var(--text-color-inverted);
        }
        .button-danger:hover { background: var(--danger); filter: brightness(1.1); }
        
        .modal-overlay {
            position: fixed; inset: 0; background-color: rgba(15, 16, 21, 0.8); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; padding: 1rem; z-index: 1000; opacity: 0; transition: opacity 0.3s ease-out; pointer-events: none;
        }
        .modal-overlay:not(.hidden) { opacity: 1; pointer-events: auto; }
        .modal-content {
            background-color: var(--bg-color-modal); border: 1px solid var(--border-color); padding: 1.5rem; border-radius: var(--border-radius-lg); box-shadow: var(--shadow-hover); width: 100%; max-width: 48rem; max-height: 90vh; overflow-y: auto; transform: scale(0.95); opacity: 0; transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }
        .modal-overlay:not(.hidden) .modal-content { transform: scale(1); opacity: 1; }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);
        }
        .modal-header h2 { margin: 0; font-size: 1.5rem; font-weight: 700; }
        .modal-header .close-button {
            background: none; border: none; font-size: 1.5rem; color: var(--text-color-muted); cursor: pointer; padding: 0.25rem; line-height: 1; border-radius: 50%;
        }
        .modal-header .close-button:hover { color: var(--primary-accent); }
        

        footer {
            text-align: center; padding: 1.5rem; font-size: 0.875rem; color: var(--text-color-muted); border-top: 1px solid var(--border-color); margin-top: auto;
        }
        
        .mobile-sidebar-toggle {
            display: block; position: fixed; top: calc((var(--header-height) - 40px) / 2); left: 1.5rem; z-index: 101; background: var(--bg-header); color: white; border: 1px solid var(--border-color); padding: 0.5rem 0.75rem; border-radius: 0.5rem; font-size: 1.25rem; line-height: 1;
        }
        @media (min-width: 768px) { .mobile-sidebar-toggle { display: none; } }
        
        .toast-notification {
            position: fixed; bottom: 20px; right: 20px; padding: 12px 20px; border-radius: var(--border-radius); box-shadow: var(--shadow-hover); z-index: 2000; opacity: 0; transform: translateY(20px); transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); display: flex; align-items: center; color: white;
        }
        .toast-notification.show { opacity: 1; transform: translateY(0); }
        .toast-icon { margin-right: 10px; font-size: 1.2em; }
        .toast-success { background-color: var(--success); }
        .toast-error { background-color: var(--danger); }
        .toast-info { background-color: var(--primary-accent); }

        .cards-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.5rem;
        }
        
        /* ======== DASHBOARD STYLES (UNIFIED) ======== */
        .dashboard-stats-grid {
            display: grid; gap: 1.5rem; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        }
        @media(min-width: 1280px) { .dashboard-stats-grid { grid-template-columns: repeat(5, 1fr); } }

        .dashboard-main-grid {
            display: grid; gap: 1.5rem; grid-template-columns: 1fr; margin-top: 1.5rem;
        }
        @media(min-width: 1024px) { .dashboard-main-grid { grid-template-columns: 2fr 1fr; } }
        
        .dashboard-stat-card {
            background-color: var(--bg-card); border: 1px solid var(--border-color); padding: 1.5rem; border-radius: var(--border-radius-lg); box-shadow: var(--card-shadow); display: flex; align-items: center; gap: 1rem; position: relative; transition: var(--transition);
        }
        .dashboard-stat-card:hover {
            transform: translateY(-5px); border-color: var(--primary-accent-light); box-shadow: var(--card-hover-shadow);
        }
        /* MODIFICATION: Improved dashboard icon container style */
        .dashboard-stat-card .icon-container {
            font-size: 1.5rem;
            color: var(--primary-accent-light);
            background-color: rgba(108, 93, 211, 0.15);
            height: 52px;
            width: 52px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            border: 1px solid rgba(108, 93, 211, 0.2);
        }
        .dashboard-stat-card .stat-info .stat-value { font-size: 2rem; font-weight: 700; display: block; line-height: 1.2; color: var(--text-light); }
        .dashboard-stat-card .stat-info .stat-label { font-size: 0.85rem; color: var(--text-color-muted); }
        
        .chart-container {
            position: relative; padding: 1.5rem; border-radius: var(--border-radius-lg); background-color: var(--bg-card); border: 1px solid var(--border-color); box-shadow: var(--shadow); min-height: 400px; display: flex; flex-direction: column; transition: var(--transition);
        }
        .chart-container:hover {
             transform: translateY(-5px); box-shadow: var(--shadow-hover);
        }
        /* MODIFICATION: Add min-width to prevent overflow on zoom */
        .dashboard-main-grid > .chart-container,
        .dashboard-main-grid > .card {
            min-width: 0;
        }
        .chart-container h3, #topUsersContainer h3 {
            font-size: 1.25rem; font-weight: 600; margin: 0 0 1rem 0; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color); color: var(--text-light);
        }
        .chart-placeholder {
            flex-grow: 1; /* This fixes the chart alignment */
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            /* MODIFICATION: Add min-height to prevent overflow on zoom */
            min-height: 0;
        }
        
        .hidden { display: none !important; }

        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.875rem; color: var(--text-muted); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--border-color); border-radius: 12px; background-color: var(--bg-dark); color: var(--text-light); transition: var(--transition); }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none; border-color: var(--primary-accent); box-shadow: 0 0 0 3px rgba(108, 93, 211, 0.2);
        }

        /* ======== ACTIVITY LOG STYLES (UNIFIED) ======== */
        #recentActivityContainer {
            grid-column: 1 / -1;
        }
        #recentActivityContainer h3 {
            font-size: 1.25rem; font-weight: 600; margin: 0 0 1rem 0; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);
        }
        .activity-log-item {
            display: flex; align-items: center; gap: 1rem; padding: 0.85rem 0.5rem; border-radius: 0.5rem; transition: background-color 0.2s ease;
        }
        .activity-log-item:hover { background-color: var(--bg-color-hover); }
        .activity-details .activity-user { font-weight: 600; color: var(--text-color); }
        .activity-details .activity-item-title { color: var(--primary-color); font-weight: 500; }
        
        /* Top Users List Styles */
        #topUsersContainer {
            padding: 1.5rem;
        }
        .top-users-list {
            list-style: none; padding: 0; margin: 0; flex-grow: 1; overflow-y: auto; max-height: 300px;
        }
        .top-user-item {
            display: flex; align-items: center; justify-content: space-between; padding: 0.9rem 0.5rem; border-bottom: 1px solid var(--border-color);
        }
        .top-user-item:last-child { border-bottom: none; }
        .top-user-info { display: flex; align-items: center; gap: 1rem; }
        .top-user-rank { font-size: 0.9rem; font-weight: bold; color: var(--text-color-muted); width: 20px; text-align: center; }
        .top-user-name { font-weight: 500; }
        .top-user-views {
            font-size: 1rem; font-weight: 600; color: var(--primary-color-light); background-color: rgba(108, 93, 211, 0.1); padding: 0.25rem 0.6rem; border-radius: 6px;
        }
        
        /* MODIFICATION: Added styles for the action bar in the item detail view */
        .item-actions-bar {
            display: flex;
            gap: 0.75rem; /* Adds space between buttons */
            align-items: center;
            margin-bottom: 1.5rem; /* Adds space below the bar */
            flex-wrap: wrap; /* Allows buttons to wrap on smaller screens */
        }

        /* ======== ROLE-BASED ACCESS STYLES (UNIFIED) ======== */
        .restricted-notice {
            text-align: center; margin-top: 60px; color: var(--text-light); background: var(--bg-card); padding: 40px; border-radius: var(--border-radius); border: 1px solid var(--border-color); box-shadow: var(--shadow-hover); max-width: 600px; margin-left: auto; margin-right: auto;
        }
        .restricted-icon { font-size: 56px; margin-bottom: 20px; color: var(--danger); }
        .restricted-notice h2 { font-size: 1.75rem; margin-bottom: 0.75rem; }
        .restricted-notice p { font-size: 1rem; line-height: 1.6; color: var(--text-muted); }

        /* ======== NEW DASHBOARD STYLES ======== */
        .performance-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .metric {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--border-color);
            text-align: center;
            transition: var(--transition);
        }

        .metric:hover {
            transform: translateY(-3px);
            border-color: var(--primary-accent-light);
            box-shadow: var(--shadow-hover);
        }

        .metric-value {
            display: block;
            font-size: 2.5rem;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1.2;
            margin-bottom: 0.5rem;
        }

        .metric-label {
            font-size: 0.9rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .action-btn {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            color: var(--text-light);
            text-decoration: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
            transition: var(--transition);
            text-align: center;
        }

        .action-btn:hover {
            background: var(--bg-header);
            border-color: var(--primary-accent);
            transform: translateY(-3px);
            box-shadow: var(--shadow-hover);
        }

        .action-btn i {
            font-size: 2rem;
            color: var(--primary-accent-light);
        }

        .action-btn span {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .health-metrics {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1rem;
        }

        .health-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            transition: var(--transition);
        }

        .health-item:hover {
            border-color: var(--primary-accent-light);
            transform: translateX(5px);
        }

        .health-item i {
            font-size: 1.5rem;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .health-good {
            color: var(--success);
            background: rgba(0, 182, 155, 0.1);
        }

        .health-warning {
            color: var(--warning);
            background: rgba(255, 196, 84, 0.1);
        }

        .health-critical {
            color: var(--danger);
            background: rgba(255, 106, 85, 0.1);
        }

        /* Improved chart styling */
        .chart-container canvas {
            border-radius: var(--border-radius);
        }

        /* Enhanced top users styling */
        .top-user-item {
            transition: var(--transition);
        }

        .top-user-item:hover {
            background: var(--bg-header);
            transform: translateX(5px);
        }

        .top-user-rank {
            transition: var(--transition);
        }

        .top-user-item:hover .top-user-rank {
            color: var(--primary-accent-light);
            transform: scale(1.1);
        }

        /* Improved dashboard layout */
        .dashboard-section {
            margin-bottom: 2rem;
        }

        .dashboard-section-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .dashboard-section-title i {
            color: var(--primary-accent-light);
        }

        /* Chart improvements */
        .chart-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .chart-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Loading states */
        .loading-skeleton {
            background: linear-gradient(90deg, var(--bg-card) 25%, var(--bg-header) 50%, var(--bg-card) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: var(--border-radius);
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Responsive improvements */
        @media (max-width: 768px) {
            .dashboard-stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .dashboard-main-grid {
                grid-template-columns: 1fr;
            }
            
            .performance-metrics {
                grid-template-columns: 1fr;
            }
            
            .quick-actions {
                grid-template-columns: 1fr;
            }
        }
</style>

</head>
<body id="pageBody">
<header class="app-header">
  <div class="brand">Knowledge Base</div>
  <nav>
    <a href="app.html" id="link-dashboard" data-role-required="admin,manager">Dashboard</a>
    <a href="insights.html" id="link-insights" data-role-required="admin,manager">Insights</a>
    <a href="employees.html" id="link-employees" data-role-required="admin,manager">Employees</a>
    <a href="audit.html" id="link-audit" data-role-required="admin,manager">Audit Log</a>
    <span id="role-badge" style="margin-left:12px;padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.02);font-size:13px">guest</span>
  </nav>
</header>


<div class="modal-overlay hidden" id="addContentModalOverlay">
<div class="modal-content">
<div class="modal-header">
<h2 id="addContentModalTitle">Add New Content</h2>
<button aria-label="Close" class="close-button" id="closeAddContentModalBtn">Ã—</button>
</div>
<div class="hidden" id="templateSelectionContainer">
<h3>Choose a Template</h3>
<div class="template-buttons-grid">
<button class="template-button" data-template="standard_article">
<i class="fas fa-newspaper"></i>
<h4>Standard Article</h4>
<p>For general information, announcements, or detailed explanations.</p>
</button>
<button class="template-button" data-template="troubleshooting_guide">
<i class="fas fa-tools"></i>
<h4>Troubleshooting Guide / Case</h4>
<p>Step-by-step solutions for common issues or case documentation.</p>
</button>
<button class="template-button" data-template="policy_document">
<i class="fas fa-gavel"></i>
<h4>Policy Document</h4>
<p>Formal policies, procedures, or official guidelines.</p>
</button>
<button class="template-button" data-template="blank">
<i class="fas fa-file"></i>
<h4>Blank Document</h4>
<p>Start with a completely empty document of any type.</p>
</button>
</div>
<hr style="border-color: var(--border-color-darker); margin: 1.5rem 0;"/>
</div>
<form class="hidden" id="addContentForm">
<input id="editingItemId" type="hidden"/>
<div class="form-group">
<label for="contentType">Content Type</label>
<select id="contentType">
<option value="article">Article</option>
<option value="case">Case</option>
<option value="form_sheet">Form/Sheet (Link)</option>
<option value="design">Design (Link)</option>
<option value="guide">Guide</option>
<option value="policy">Policy</option>
</select>
</div>
<div class="form-group">
<label for="contentTitle">Title</label>
<input id="contentTitle" required="" type="text"/>
</div>
<div class="form-group">
<label for="contentSummary">Summary / Description</label>
<textarea id="contentSummary" required="" rows="3"></textarea>
</div>
<div class="form-group hidden" id="contentUrlContainer">
<label for="contentUrl">Link (for Forms, Designs, etc.)</label>
<input id="contentUrl" type="url"/>
</div>
<div class="form-group" id="contentDetailContainer">
<label for="contentDetail" id="contentDetailLabel">Details / Content</label>
<div id="quillEditor"></div>
</div>
<div class="form-group">
<label for="contentTags">Tags (comma-separated)</label>
<input id="contentTags" placeholder="e.g., important, update, billing" type="text"/>
</div>
<div class="form-group" id="parentItemContainer">
<label for="parentItem">Parent Item (Optional)</label>
<p style="font-size: 0.8rem; color: var(--text-color-muted); margin-top: -0.25rem; margin-bottom: 0.5rem;">
    Link this content as a child to another item in this section. It will appear as a "Related Topic" on the parent's page.
</p>
<select id="parentItem">
<option value="">-- None (Top-Level Item) --</option>
</select>
</div>
<hr style="border-color: var(--border-color-darker); margin: 1.5rem 0;"/>
<h3 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-color);">Attachments (Optional)</h3>
<div class="form-group">
<label for="pdfFile">Upload PDF</label>
<input accept=".pdf" id="pdfFile" type="file"/>
</div>
<div class="form-group">
<label for="imageFile">Upload Image (Inserts into content)</label>
<input accept="image/*" id="imageFile" type="file"/>
</div>
<div class="form-group">
<label for="videoLink">Video Link (e.g., YouTube, Vimeo)</label>
<input id="videoLink" placeholder="https://..." type="url"/>
</div>
<div class="form-group">
<label for="driveLink">Google Drive Link</label>
<input id="driveLink" placeholder="https://docs.google.com/... or https://drive.google.com/..." type="url"/>
</div>
<div class="modal-actions">
<button class="button" id="saveContentBtn" type="submit"><i class="fas fa-save"></i> Save Content</button>
<button class="button-secondary" id="cancelAddContentBtn" type="button"><i class="fas fa-times"></i> Cancel</button>
</div>
</form>
</div>
</div>
<!-- Logout Confirmation Modal -->
<div class="modal-overlay hidden" id="logoutConfirmModalOverlay">
    <div class="modal-content" style="max-width: 28rem; text-align: center;">
        <div class="modal-header" style="justify-content: center; border-bottom: none; padding-bottom: 0;">
            <h2 id="logoutConfirmModalTitle">Confirm Logout</h2>
        </div>
        <div class="modal-body">
            <div style="font-size: 3rem; color: var(--primary-color); margin-bottom: 1rem;"><i class="fas fa-question-circle"></i></div>
            <p>Are you sure you want to logout from InfiniBase?</p>
        </div>
        <div class="modal-actions" style="justify-content: center; gap: 1rem; border-top: none; padding-top: 1rem;">
            <button class="button-secondary" id="cancelLogoutBtn" type="button"><i class="fas fa-times"></i> Cancel</button>
            <button class="button button-danger" id="confirmLogoutBtn" type="button"><i class="fas fa-sign-out-alt"></i> Confirm Logout</button>
        </div>
    </div>
</div>
<!-- Report Feedback Modal -->
<div class="modal-overlay hidden" id="reportFeedbackModalOverlay">
<div class="modal-content" style="max-width: 32rem;">
<div class="modal-header">
<h2 id="reportFeedbackModalTitle">Report Feedback</h2>
<button aria-label="Close" class="close-button" id="closeReportFeedbackModalBtn">Ã—</button>
</div>
<form id="reportFeedbackForm">
<input id="feedbackItemId" type="hidden"/>
<input id="feedbackItemTitle" type="hidden"/>
<div class="modal-body" style="padding-bottom:0;">
<p style="margin-bottom: 1rem;">Provide your feedback for: <strong id="feedbackItemTitleDisplay"></strong></p>
<div class="form-group">
<label for="feedbackUserName">Your Name</label>
<input id="feedbackUserName" readonly="" type="text"/>
</div>
<div class="form-group">
<label for="feedbackUserEmail">Your Email</label>
<input id="feedbackUserEmail" readonly="" type="email"/>
</div>
<div class="form-group">
<label for="feedbackComment">Your Feedback / Comments</label>
<textarea id="feedbackComment" placeholder="Please describe the issue or suggestion..." required="" rows="5"></textarea>
</div>
</div>
<div class="modal-actions">
<button class="button" id="submitFeedbackBtn" type="submit"><i class="fas fa-paper-plane"></i> Submit Feedback</button>
<button class="button-secondary" id="cancelFeedbackBtn" type="button"><i class="fas fa-times"></i> Cancel</button>
</div>
</form>
</div>
</div>
<!-- Delete Confirmation Modal (Refined) -->
<div class="modal-overlay hidden" id="deleteConfirmModalOverlay">
    <div class="modal-content" style="max-width: 28rem;">
        <div class="modal-header">
            <h2 id="deleteConfirmModalTitle">Confirm Deletion</h2>
            <button aria-label="Close" class="close-button" id="closeDeleteConfirmModalBtn">Ã—</button>
        </div>
        <div class="modal-body">
            <p id="deleteConfirmMessage">Are you sure you want to delete this item? This action cannot be undone.</p>
        </div>
        <div class="modal-actions">
            <button class="button-secondary" id="cancelDeleteItemBtn" type="button"><i class="fas fa-times"></i> Cancel</button>
            <button class="button button-danger" id="confirmDeleteItemBtn" type="button"><i class="fas fa-trash-alt"></i> Yes, Delete</button>
        </div>
    </div>
</div>
<!-- Insert HTML Modal -->
<div class="modal-overlay hidden" id="insertHtmlModalOverlay">
    <div class="modal-content" style="max-width: 40rem;">
        <div class="modal-header">
            <h2>Insert HTML</h2>
            <button aria-label="Close" class="close-button" id="closeInsertHtmlModalBtn">Ã—</button>
        </div>
        <div class="modal-body">
            <p style="font-size: 0.9rem; color: var(--text-color-muted); margin-bottom: 1rem;">
                Paste your HTML code below. It will be rendered in the editor.
            </p>
            <div class="form-group">
                <textarea id="htmlTextarea" style="min-height: 200px; font-family: monospace;" placeholder="<table>...</table>"></textarea>
            </div>
        </div>
        <div class="modal-actions no-border">
            <button class="button" id="confirmInsertHtmlBtn" type="button"><i class="fas fa-code"></i> Insert Now</button>
            <button class="button-secondary" id="cancelInsertHtmlBtn" type="button"><i class="fas fa-times"></i> Cancel</button>
        </div>
    </div>
</div>
<!-- Access Denied Modal -->
<div class="modal-overlay hidden" id="accessDeniedModalOverlay">
    <div class="modal-content" style="max-width: 30rem; text-align: center;">
        <div style="font-size: 3rem; color: #ef4444; margin-bottom: 1rem;"><i class="fas fa-user-lock"></i></div>
        <h2 style="font-size: 1.5rem; margin-bottom: 0.5rem;">Access Restricted</h2>
        <p id="accessDeniedMessage" style="color: var(--text-color-muted); margin-bottom: 1.5rem;">
            This page and its content are for administrators only.
        </p>
        <button class="button" id="returnHomeFromAccessDeniedBtn"><i class="fas fa-arrow-left"></i> Return to Dashboard</button>
    </div>
</div>
<!-- Diff Viewer Modal -->
<div id="diffModal" class="modal-overlay hidden">
  <div class="diff-modal-content">
    <div class="diff-modal-header">
        <h3>Viewing Changes</h3>
        <button class="close-diff-modal" id="closeDiffModalBtn">Ã—</button>
    </div>
    <div class="diff-modal-body" id="diffContent"></div>
  </div>
</div>

<div class="container-fluid">
<aside class="sidebar" id="sidebar">
<div class="sidebar-header">
    <img src="data:image/svg+xml,&lt;svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32' width='32' height='32'&gt;&lt;rect width='32' height='32' rx='4' fill='%236366f1'/&gt;&lt;text x='50%' y='55%' dominant-baseline='middle' text-anchor='middle' font-family='Arial, sans-serif' font-size='18' font-weight='bold' fill='white'&gt;IB&lt;/text&gt;&lt;/svg&gt;" alt="InfiniBase Logo">
    <span class="sidebar-logo-text">InfiniBase</span>
</div>
<nav class="sidebar-nav" id="navigationMenu">
    <div id="sidebarLoader" style="padding: 1rem; text-align: center; color: var(--text-color-muted);">
        <i class="fas fa-spinner fa-spin"></i> Loading Areas...
    </div>
</nav>
<div class="sidebar-footer">
<button class="button button-danger" id="logoutButton">
<i class="fas fa-sign-out-alt"></i> Logout
                </button>
<div id="userRoleDisplaySidebar" style="font-size: 0.8rem; color: var(--text-color-muted); text-align: center; margin-top: 0.5rem;">Role: <span id="currentUserRoleSpan"></span></div>
</div>
</aside>
<div class="content-wrapper" id="contentWrapper">
<header class="content-header">
<div class="header-left-content">
<button class="mobile-sidebar-toggle" id="mobileSidebarToggle"><i class="fas fa-bars"></i></button>
<div>
<h1 id="currentSectionTitle">Welcome</h1>
<div id="breadcrumbs">Home</div>
</div>
</div>
<div class="header-right-content">
<div class="admin-toolbar hidden" id="adminToolbar">
    <a href="#home" id="admin-link-dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
    <a href="/insights.html" id="admin-link-insights"><i class="fas fa-chart-pie"></i> Insights</a>
    <a href="/employees.html" id="admin-link-employees" class="nav-link"><i class="fas fa-users"></i>Employees</a>
    <a href="/audit.html" id="admin-link-audit"><i class="fas fa-history"></i> Audit Log</a>
</div>
<div class="search-container">
<span class="search-icon"><i class="fas fa-search"></i></span>
<input id="globalSearchInput" placeholder="Search the knowledge base..." type="search"/>
<div class="hidden" id="searchResultsContainer"></div>
</div>
<div class="user-profile" id="userProfileContainer">
<div id="userAvatar">U</div>
<span id="userNameDisplayHeader" style="font-weight: 500;">User</span>
</div>
</div>
</header>
<main id="pageContentArea">
<div class="hidden" id="dashboardOverviewContainer">
    <!-- Dashboard content will be populated by JavaScript -->
</div>
<div id="standardSectionContentPlaceholder">
    <!-- Section content (cards) will be populated by JavaScript -->
</div>
<div class="hidden" data-mermaid-rendered="false" id="itemDetailViewPlaceholder">
    <!-- Item detail view will be populated by JavaScript -->
</div>
</main>
<footer class="mt-auto p-6 text-center text-sm">
<span>Â© <script>document.write(new Date().getFullYear())</script> InfiniBase.Elmenisy.</span>
</footer>
</div>
</div>

<div id="toastContainer"></div>

<script type="module">
    // =================================================================================
    // SUPABASE & APP LOGIC
    // =================================================================================
    import { supabase } from './supabase.js';

    // --- Supabase Logic Layer (Functions to interact with the database) ---
    async function getCurrentUserProfile() {
        const { data: { user }, error: authError } = await supabase.auth.getUser();
        if (authError || !user) {
            console.error('No logged-in user found:', authError);
            return null;
        }
        const { data: profile, error } = await supabase.from('users').select('*').eq('id', user.id).single();
        if (error) {
            console.error('Error fetching user profile:', error);
            // Fallback for users who exist in auth but not in the 'users' table yet
            return { id: user.id, email: user.email, role: 'viewer', name: user.email };
        }
        return profile;
    }

    async function fetchSubCategories() {
        const { data, error } = await supabase.from('sub_categories').select('*').order('position');
        if (error) {
            console.error('Error fetching sub-categories:', error);
            showToast('Failed to load knowledge areas.', 'error');
            return []; // Return empty array on failure
        }
        return data;
    }

    async function fetchArticles() {
        const { data, error } = await supabase
            .from('cases')
            .select('id, sub_category_id, title_en, description_en, content_en, title_ar, description_ar, content_ar, tags, type, url, parent_id, created_at, last_modified, is_published, slug')
            .eq('is_published', true)
            .order('created_at', { ascending: false });
        if (error) {
            console.error('Error fetching articles:', error);
            showToast('Failed to load articles from the database.', 'error');
            return []; // Return empty array on failure
        }
        return data;
    }
    
    async function addComment(articleId, commentText, user) {
        const { data, error } = await supabase.from('kb_comments').insert([{
            item_id: articleId,
            author_id: user.id,
            author_name: user.name,
            body: commentText,
        }]).select().single();
        if (error) {
            console.error('Error posting comment:', error);
        }
        return { data, error };
    }

    async function submitFeedback(articleId, rating, reason, user) {
        const { error } = await supabase.from('kb_feedback').insert([{
            item_id: articleId,
            user_id: user.id,
            rating,
            reason,
        }]);
        if (error) {
            console.error('Error submitting feedback:', error);
        }
        return { error };
    }

    async function logActivity(user, itemId, itemType, action, details = {}) {
        if (!user || !user.id) {
            console.warn("Attempted to log activity without a valid user.");
            return;
        }

        let typeToLog = itemType;

        if (!typeToLog) {
            const { data: item, error: fetchError } = await supabase.from('cases').select('type').eq('id', itemId).single();
            if (fetchError || !item) {
                console.error(`Could not fetch item type for logging activity (ItemID: ${itemId}).`, fetchError);
                typeToLog = 'unknown'; // Fallback
            } else {
                typeToLog = item.type;
            }
        }
        
        const { error } = await supabase.from('activity_log').insert([{
            user_id: user.id,
            user_name: user.name,
            item_id: itemId,
            item_type: typeToLog,
            action: action,
            details: details,
        }]);
        if (error) {
            console.error('Error logging activity:', error);
        }
    }
    
    async function fetchDashboardData() {
        const results = await Promise.allSettled([
            supabase.from('v_recent_activity').select('*').limit(50),
            supabase.from('v_overall_insights').select('*').single(),
            supabase.from('v_growth_trends').select('*'),
            supabase.from('v_activity_combined_7days').select('*').order('activity_date_egypt'),
            supabase.from('v_insights_kpis').select('helpful_ratings, not_helpful_ratings').single(),
            supabase.from('v_user_insights').select('*').order('total_articles_viewed', { ascending: false }).limit(5)
        ]);
        
        const [
            activity, 
            insights, 
            growth, 
            weeklyActivity,
            feedbackKpis,
            topUsers
        ] = results.map(res => res.status === 'fulfilled' ? res.value.data : null);

        if (results.some(res => res.status === 'rejected')) {
            console.warn("One or more dashboard data queries failed.", results.filter(r => r.status === 'rejected').map(r => r.reason));
            showToast('Some dashboard widgets could not be loaded.', 'error');
        }

        return {
            activityLog: activity || [],
            overallInsights: insights || {},
            growthTrends: growth || [],
            weeklyActivity: weeklyActivity || [],
            feedbackKpis: feedbackKpis || {},
            topUsers: topUsers || []
        };
    }

    mermaid.initialize({
        startOnLoad: false,
        theme: 'dark',
        fontFamily: 'Inter, sans-serif',
        flowchart: {
            htmlLabels: true,
            useMaxWidth: true,
        },
        themeVariables: {
            fontSize: '14px',
            background: getComputedStyle(document.documentElement).getPropertyValue('--bg-color-alt').trim(),
            primaryColor: getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim(),
            primaryTextColor: getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim(),
            lineColor: getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim(),
            textColor: getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim(),
            nodeBorder: getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim(),
        }
    });
    
    let kbSystemData = { sections: [] };
    let mainQuillEditor;
    let currentUser = null;
    let currentOpenItem = null;
    
    let activityChartInstance;
    let dashboardData = { activityLog: [], overallInsights: {}, growthTrends: [], weeklyActivity: [], feedbackKpis: {}, topUsers: [] };
    let activityLogPage = 1;
    const ACTIVITY_LOG_PAGE_SIZE = 7;

    const pageBody = document.getElementById('pageBody');
    const sidebar = document.getElementById('sidebar');
    const mobileSidebarToggle = document.getElementById('mobileSidebarToggle');
    const navigationMenu = document.getElementById('navigationMenu');
    const currentSectionTitleEl = document.getElementById('currentSectionTitle');
    const breadcrumbsContainer = document.getElementById('breadcrumbs');
    const pageContentArea = document.getElementById('pageContentArea');
    const dashboardOverviewContainer = document.getElementById('dashboardOverviewContainer');
    const standardSectionContentPlaceholder = document.getElementById('standardSectionContentPlaceholder');
    const itemDetailViewPlaceholder = document.getElementById('itemDetailViewPlaceholder');
    const userNameDisplayHeader = document.getElementById('userNameDisplayHeader');
    const userAvatar = document.getElementById('userAvatar');
    const currentUserRoleSpan = document.getElementById('currentUserRoleSpan');
    const addContentModalOverlay = document.getElementById('addContentModalOverlay');
    const closeAddContentModalBtn = document.getElementById('closeAddContentModalBtn');
    const addContentForm = document.getElementById('addContentForm');
    const templateSelectionContainer = document.getElementById('templateSelectionContainer');
    const cancelAddContentBtn = document.getElementById('cancelAddContentBtn');
    const contentTypeSelect = document.getElementById('contentType');
    const contentUrlContainer = document.getElementById('contentUrlContainer');
    const contentDetailContainer = document.getElementById('contentDetailContainer');
    const contentDetailLabel = document.getElementById('contentDetailLabel');
    const contentTagsInput = document.getElementById('contentTags');
    const editingItemIdInput = document.getElementById('editingItemId');
    const globalSearchInput = document.getElementById('globalSearchInput');
    const searchResultsContainer = document.getElementById('searchResultsContainer');
    const logoutButton = document.getElementById('logoutButton');
    const logoutConfirmModalOverlay = document.getElementById('logoutConfirmModalOverlay');
    const confirmLogoutBtn = document.getElementById('confirmLogoutBtn');
    const cancelLogoutBtn = document.getElementById('cancelLogoutBtn');
    const deleteConfirmModalOverlay = document.getElementById('deleteConfirmModalOverlay');
    const closeDeleteConfirmModalBtn = document.getElementById('closeDeleteConfirmModalBtn');
    const confirmDeleteItemBtn = document.getElementById('confirmDeleteItemBtn');
    const cancelDeleteItemBtn = document.getElementById('cancelDeleteItemBtn');
    const deleteConfirmMessage = document.getElementById('deleteConfirmMessage');
    const insertHtmlModalOverlay = document.getElementById('insertHtmlModalOverlay');
    const closeInsertHtmlModalBtn = document.getElementById('closeInsertHtmlModalBtn');
    const cancelInsertHtmlBtn = document.getElementById('cancelInsertHtmlBtn');
    const confirmInsertHtmlBtn = document.getElementById('confirmInsertHtmlBtn');
    const htmlTextarea = document.getElementById('htmlTextarea');
    const diffModal = document.getElementById('diffModal');
    const closeDiffModalBtn = document.getElementById('closeDiffModalBtn');
    const accessDeniedModalOverlay = document.getElementById('accessDeniedModalOverlay');
    const returnHomeFromAccessDeniedBtn = document.getElementById('returnHomeFromAccessDeniedBtn');
    const adminToolbar = document.getElementById('adminToolbar');
    
    function isCurrentUserAdmin() {
        return currentUser?.role === 'admin' || currentUser?.is_admin === true;
    }

    function escapeHTML(str) {
        if (typeof str !== 'string' && typeof str !== 'number') return '';
        const el = document.createElement('div');
        el.textContent = str;
        return el.innerHTML;
    }

    function formatReadableDate(isoString) {
        if (!isoString) return 'N/A';
        try {
            return new Date(isoString).toLocaleString('en-EG', {
                day: '2-digit', month: 'short', year: 'numeric',
                hour: '2-digit', minute: '2-digit', hour12: true,
                timeZone: 'Africa/Cairo'
            });
        } catch (e) {
            return isoString;
        }
    }

    function highlightText(text, query) {
        if (!text) return '';
        const safeText = escapeHTML(text);
        if (!query) return safeText;
        try {
            const rgx = new RegExp(`(${query.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')})`, 'gi');
            return safeText.replace(rgx, '<mark>$1</mark>');
        } catch (e) { return safeText; }
    }

    function truncateText(text, len) {
        if (!text || text.length <= len) return text;
        return text.substring(0, len) + '...';
    }

    function stripHtml(html){
       if (!html) return "";
       let tmp = document.createElement("DIV");
       tmp.innerHTML = html;
       return tmp.textContent || tmp.innerText || "";
    }
    
    function createSlug(text) {
        if (!text) return 'untitled-' + Date.now();
        return text.toString().toLowerCase().trim()
            .replace(/\s+/g, '-')
            .replace(/&/g, '-and-')
            .replace(/[^\w\-]+/g, '')
            .replace(/\-\-+/g, '-');
    }

    function showToast(message, type = 'info', duration = 3000) {
        const toastContainer = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast-notification toast-${type}`;
        let iconClass = 'fas fa-info-circle';
        if (type === 'success') iconClass = 'fas fa-check-circle';
        else if (type === 'error') iconClass = 'fas fa-times-circle';
        toast.innerHTML = `<i class="toast-icon ${iconClass}"></i> <span>${escapeHTML(message)}</span>`;
        toastContainer.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, duration);
    }
    
    async function loadAndStructureData() {
        const [categories, articles] = await Promise.all([
            fetchSubCategories(),
            fetchArticles()
        ]);

        const sections = categories.map(cat => ({
            ...cat,
            slug: createSlug(cat.name),
            items: []
        }));

        articles.forEach(article => {
            const parentSection = sections.find(s => s.id === article.sub_category_id);
            if (parentSection) {
                article.slug = article.slug || createSlug(article.title_en);
                parentSection.items.push({ ...article });
            }
        });
        
        kbSystemData.sections = sections;
    }
    
    function populateSidebar() {
        let menuHTML = '';
        const homeSection = { id: 'home', name: 'Home', icon: 'fas fa-home', color: 'var(--primary-color)', slug: 'home' };

        menuHTML += `<div class="sidebar-section-title">MAIN</div>`;
        menuHTML += `<a href="#${homeSection.slug}" class="sidebar-link" data-section-slug="${homeSection.slug}">
            <i class="${homeSection.icon}" style="color: ${homeSection.color};"></i>${escapeHTML(homeSection.name)}
        </a>`;

        const sectionsFromDB = kbSystemData.sections || [];
        
        const groupedSections = sectionsFromDB.reduce((acc, section) => {
            const groupKey = section.section_id || 'knowledge_base';
            if (!acc[groupKey]) acc[groupKey] = [];
            acc[groupKey].push(section);
            return acc;
        }, {});

        const sectionTitles = {
            'knowledge_base': 'KNOWLEDGE AREAS',
            'policies_procedures': 'POLICIES & PROCEDURES',
            'technical_documentation': 'TECHNICAL DOCUMENTATION',
            'administration': 'ADMINISTRATION'
        };

        const sectionOrder = ['knowledge_base', 'policies_procedures', 'technical_documentation', 'administration'];

        sectionOrder.forEach(sectionId => {
            if (groupedSections[sectionId]) {
                const title = sectionTitles[sectionId] || sectionId.replace(/_/g, ' ').toUpperCase();
                menuHTML += `<div class="sidebar-section-title">${escapeHTML(title)}</div>`;
                
                const items = groupedSections[sectionId];
                items.sort((a, b) => (a.position || 0) - (b.position || 0));

                items.forEach(section => {
                    const iconStyle = section.color ? `style="color: ${section.color};"` : '';
                    menuHTML += `<a href="#${section.slug}" class="sidebar-link" data-section-slug="${section.slug}">
                        <i class="${section.icon || 'fas fa-folder'}" ${iconStyle}></i>${escapeHTML(section.name)}
                    </a>`;
                });
            }
        });
        
        navigationMenu.innerHTML = menuHTML;
    }
    
    function highlightSidebarLink(sectionSlug) {
        document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
        const activeLink = document.querySelector(`.sidebar-link[data-section-slug="${sectionSlug}"]`);
        if (activeLink) activeLink.classList.add('active');
    }

    function updateAdminToolbar(page) {
        document.querySelectorAll('.admin-toolbar a').forEach(link => link.classList.remove('active'));
        const activeLink = document.getElementById(`admin-link-${page}`);
        if(activeLink) activeLink.classList.add('active');
    }
    
    async function renderMermaidDiagramsInElement(element) {
        const mermaidElements = element.querySelectorAll('pre.mermaid');
        if (mermaidElements.length === 0) return;
        try {
            await new Promise(resolve => setTimeout(resolve, 50));
            await mermaid.run({ nodes: mermaidElements, suppressErrors: false });
            element.dataset.mermaidRendered = 'true';
        } catch (error) {
            console.error("Mermaid rendering error:", error);
        }
    }

    function renderItemCard(item, sectionData) {
        const itemIcons = {
            article: 'fas fa-newspaper',
            case: 'fas fa-briefcase',
            form_sheet: 'fas fa-file-invoice',
            design: 'fas fa-palette',
            guide: 'fas fa-book-open',
            policy: 'fas fa-gavel',
            default: 'fas fa-file-alt'
        };
        const itemIconClass = itemIcons[item.type] || itemIcons.default;
        const isAdmin = isCurrentUserAdmin();

        const tagsHTML = item.tags?.length > 0
            ? `<div class="card-tags">${item.tags.map(tag => `<span class="tag">${escapeHTML(tag)}</span>`).join('')}</div>`
            : '';

        const actionsHTML = isAdmin ? `
            <div class="card-actions">
                <button class="button" onclick="event.stopPropagation(); window.openEditModal('${sectionData.id}', '${item.id}')" title="Edit"><i class="fas fa-edit"></i></button>
                <button class="button button-danger" onclick="event.stopPropagation(); window.openDeleteModal('${sectionData.id}', '${item.id}', '${escapeHTML(item.title_en)}')" title="Delete"><i class="fas fa-trash-alt"></i></button>
            </div>` : '';

        return `
            <div class="card" data-item-id="${item.id}" data-section-id="${sectionData.id}" onclick="window.location.hash='#${sectionData.slug}/${item.slug}'" style="cursor: pointer;">
                <div class="card-header-icon">
                    <div style="display: flex; align-items: center;">
                        <div class="card-icon-container"><i class="${itemIconClass}"></i></div>
                        <div class="card-title-group">
                            <h3>${escapeHTML(item.title_en)}</h3>
                        </div>
                    </div>
                    ${actionsHTML}
                </div>
                <p>${escapeHTML(truncateText(stripHtml(item.description_en), 120))}</p>
                ${tagsHTML}
            </div>`;
    }

    function renderActivityLog(page = 1) {
        const container = document.getElementById('recentActivityContainer');
        if (!container) return;

        const activityLog = dashboardData.activityLog || [];
        const totalPages = Math.ceil(activityLog.length / ACTIVITY_LOG_PAGE_SIZE);
        activityLogPage = Math.max(1, Math.min(page, totalPages || 1));

        const startIndex = (activityLogPage - 1) * ACTIVITY_LOG_PAGE_SIZE;
        const endIndex = startIndex + ACTIVITY_LOG_PAGE_SIZE;
        const pageItems = activityLog.slice(startIndex, endIndex);

        const getIconForAction = (action) => {
            switch (action) {
                case 'created': return '<i class="fas fa-plus-circle" style="color: var(--yes-color);"></i>';
                case 'updated': return '<i class="fas fa-pen" style="color: var(--rating-color);"></i>';
                case 'deleted': return '<i class="fas fa-trash-alt" style="color: var(--no-color);"></i>';
                case 'viewed': return '<i class="fas fa-eye" style="color: var(--primary-color);"></i>';
                default: return '<i class="fas fa-history" style="color: var(--text-color-muted);"></i>';
            }
        };

        let itemsHTML = pageItems.map(log => {
            const itemTitle = log.item_title ? ` on <strong class="activity-item-title">${escapeHTML(truncateText(log.item_title, 40))}</strong>` : '';
            const sectionInfo = log.section ? ` in ${escapeHTML(log.section)}` : '';
            return `
                <div class="activity-log-item">
                    <div class="activity-icon">${getIconForAction(log.action)}</div>
                    <div class="activity-details">
                        <span class="activity-user">${escapeHTML(log.user_name)}</span> ${escapeHTML(log.action)}${itemTitle}${sectionInfo}.
                    </div>
                    <div class="activity-time">${formatReadableDate(log.timestamp || log.created_at_egypt)}</div>
                </div>
            `;
        }).join('');

        if (pageItems.length === 0) {
            itemsHTML = `<div class="activity-log-item" style="justify-content: center; color: var(--text-color-muted);">
                <i class="fas fa-inbox"></i> No recent activity found.
            </div>`;
        }

        const paginationHTML = totalPages > 1 ? `
            <div class="activity-pagination" style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                <button class="button-secondary" onclick="renderActivityLog(${activityLogPage - 1})" ${activityLogPage <= 1 ? 'disabled' : ''}>
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
                <span style="font-size: 0.875rem; color: var(--text-color-muted);">
                    Page ${activityLogPage} of ${totalPages}
                </span>
                <button class="button-secondary" onclick="renderActivityLog(${activityLogPage + 1})" ${activityLogPage >= totalPages ? 'disabled' : ''}>
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        ` : '';

        container.innerHTML = `
            <h3><i class="fas fa-history"></i> Recent Activity</h3>
            <div class="activity-log-list">
                ${itemsHTML}
            </div>
            ${paginationHTML}
        `;
    }

    function renderTopUsers() {
        const container = document.getElementById('topUsersContainer');
        if (!container) return;

        const topUsers = dashboardData.topUsers || [];
        
        let usersHTML = topUsers.map((user, index) => {
            const rank = index + 1;
            const rankClass = rank === 1 ? 'top-user-rank top-user-rank-1' : 
                            rank === 2 ? 'top-user-rank top-user-rank-2' : 
                            rank === 3 ? 'top-user-rank top-user-rank-3' : 'top-user-rank';
            
            return `
                <li class="top-user-item">
                    <div class="top-user-info">
                        <span class="${rankClass}">${rank}</span>
                        <span class="top-user-name">${escapeHTML(user.user_name || 'Unknown User')}</span>
                    </div>
                    <span class="top-user-views">${user.total_articles_viewed || 0}</span>
                </li>
            `;
        }).join('');

        if (topUsers.length === 0) {
            usersHTML = `<li class="top-user-item" style="justify-content: center; color: var(--text-color-muted);">
                <i class="fas fa-users"></i> No user data available
            </li>`;
        }

        container.innerHTML = `
            <h3><i class="fas fa-trophy"></i> Top Contributors</h3>
            <ul class="top-users-list">
                ${usersHTML}
            </ul>
        `;
    }

    function renderCharts() {
        const activityChartCanvas = document.getElementById('activityChart');
        if (!activityChartCanvas) return;

        // Destroy existing chart instance if it exists
        if (activityChartInstance) {
            activityChartInstance.destroy();
        }

        const weeklyActivity = dashboardData.weeklyActivity || [];
        const labels = weeklyActivity.map(item => {
            const date = new Date(item.activity_date_egypt);
            return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        });
        
        const viewsData = weeklyActivity.map(item => item.total_views || 0);
        const editsData = weeklyActivity.map(item => item.total_edits || 0);
        const createsData = weeklyActivity.map(item => item.total_creates || 0);

        const ctx = activityChartCanvas.getContext('2d');
        activityChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Views',
                        data: viewsData,
                        borderColor: 'var(--primary-accent)',
                        backgroundColor: 'rgba(108, 93, 211, 0.1)',
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Edits',
                        data: editsData,
                        borderColor: 'var(--warning)',
                        backgroundColor: 'rgba(255, 196, 84, 0.1)',
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Creates',
                        data: createsData,
                        borderColor: 'var(--success)',
                        backgroundColor: 'rgba(0, 182, 155, 0.1)',
                        tension: 0.4,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: 'var(--text-color)',
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'var(--bg-card)',
                        titleColor: 'var(--text-color)',
                        bodyColor: 'var(--text-color)',
                        borderColor: 'var(--border-color)',
                        borderWidth: 1
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: 'var(--text-color-muted)'
                        }
                    },
                    y: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: 'var(--text-color-muted)'
                        },
                        beginAtZero: true
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });
    }

    function renderDashboardStats() {
        const statsContainer = document.getElementById('dashboardStats');
        if (!statsContainer) return;

        const insights = dashboardData.overallInsights || {};
        const feedbackKpis = dashboardData.feedbackKpis || {};

        const stats = [
            {
                icon: 'fas fa-file-alt',
                value: insights.total_articles || 0,
                label: 'Total Articles',
                color: 'var(--primary-accent)'
            },
            {
                icon: 'fas fa-eye',
                value: insights.total_views || 0,
                label: 'Total Views',
                color: 'var(--secondary-accent)'
            },
            {
                icon: 'fas fa-edit',
                value: insights.total_edits || 0,
                label: 'Total Edits',
                color: 'var(--warning)'
            },
            {
                icon: 'fas fa-thumbs-up',
                value: feedbackKpis.helpful_ratings || 0,
                label: 'Helpful Ratings',
                color: 'var(--success)'
            },
            {
                icon: 'fas fa-thumbs-down',
                value: feedbackKpis.not_helpful_ratings || 0,
                label: 'Not Helpful Ratings',
                color: 'var(--danger)'
            }
        ];

        const statsHTML = stats.map(stat => `
            <div class="dashboard-stat-card">
                <div class="icon-container" style="color: ${stat.color};">
                    <i class="${stat.icon}"></i>
                </div>
                <div class="stat-info">
                    <span class="stat-value">${stat.value}</span>
                    <span class="stat-label">${stat.label}</span>
                </div>
            </div>
        `).join('');

        statsContainer.innerHTML = statsHTML;
    }

    function renderDashboard() {
        dashboardOverviewContainer.classList.remove('hidden');
        standardSectionContentPlaceholder.classList.add('hidden');
        itemDetailViewPlaceholder.classList.add('hidden');
        
        currentSectionTitleEl.textContent = 'Dashboard Overview';
        breadcrumbsContainer.innerHTML = '<a href="#home">Home</a> / Dashboard';

        const dashboardHTML = `
            <div class="dashboard-section">
                <h2 class="dashboard-section-title">
                    <i class="fas fa-tachometer-alt"></i> System Overview
                </h2>
                <div class="dashboard-stats-grid" id="dashboardStats">
                    <!-- Stats will be populated by renderDashboardStats -->
                </div>
            </div>

            <div class="dashboard-main-grid">
                <div class="chart-container">
                    <div class="chart-header">
                        <h3><i class="fas fa-chart-line"></i> Activity Trends (Last 7 Days)</h3>
                        <div class="chart-actions">
                            <button class="button-secondary" onclick="refreshDashboardData()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <div class="chart-placeholder">
                        <canvas id="activityChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <div id="topUsersContainer">
                        <!-- Top users will be populated by renderTopUsers -->
                    </div>
                </div>
            </div>

            <div class="dashboard-section">
                <div class="performance-metrics">
                    <div class="metric">
                        <span class="metric-value">85%</span>
                        <span class="metric-label">Knowledge Areas Engagement</span>
                    </div>
                    <div class="metric">
                        <span class="metric-value">72%</span>
                        <span class="metric-label">Partner Care Activity</span>
                    </div>
                    <div class="metric">
                        <span class="metric-value">15</span>
                        <span class="metric-label">New Cases This Week</span>
                    </div>
                </div>
            </div>

            <div class="dashboard-section">
                <h3 class="dashboard-section-title">
                    <i class="fas fa-bolt"></i> Quick Actions
                </h3>
                <div class="quick-actions">
                    <a href="insights.html#department=Partner Care" class="action-btn">
                        <i class="fas fa-chart-line"></i>
                        <span>Partner Care Analytics</span>
                    </a>
                    <a href="audit.html#search=Device Issue" class="action-btn">
                        <i class="fas fa-search"></i>
                        <span>Audit Device Cases</span>
                    </a>
                    <a href="employees.html" class="action-btn">
                        <i class="fas fa-users"></i>
                        <span>Team Management</span>
                    </a>
                    <a href="insights.html" class="action-btn">
                        <i class="fas fa-chart-bar"></i>
                        <span>Detailed Insights</span>
                    </a>
                </div>
            </div>

            <div class="dashboard-section">
                <div id="recentActivityContainer">
                    <!-- Activity log will be populated by renderActivityLog -->
                </div>
            </div>

            <div class="dashboard-section">
                <h3 class="dashboard-section-title">
                    <i class="fas fa-heartbeat"></i> System Health
                </h3>
                <div class="health-metrics">
                    <div class="health-item">
                        <i class="fas fa-database health-good"></i>
                        <div>
                            <div style="font-weight: 600;">Database</div>
                            <div style="font-size: 0.875rem; color: var(--text-muted);">All systems operational</div>
                        </div>
                    </div>
                    <div class="health-item">
                        <i class="fas fa-server health-good"></i>
                        <div>
                            <div style="font-weight: 600;">API Services</div>
                            <div style="font-size: 0.875rem; color: var(--text-muted);">Running smoothly</div>
                        </div>
                    </div>
                    <div class="health-item">
                        <i class="fas fa-cloud health-good"></i>
                        <div>
                            <div style="font-weight: 600;">Storage</div>
                            <div style="font-size: 0.875rem; color: var(--text-muted);">85% capacity available</div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        dashboardOverviewContainer.innerHTML = dashboardHTML;

        // Render all dashboard components
        renderDashboardStats();
        renderCharts();
        renderTopUsers();
        renderActivityLog();

        highlightSidebarLink('home');
        updateAdminToolbar('dashboard');
    }

    async function refreshDashboardData() {
        showToast('Refreshing dashboard data...', 'info');
        dashboardData = await fetchDashboardData();
        renderDashboardStats();
        renderCharts();
        renderTopUsers();
        renderActivityLog();
        showToast('Dashboard updated successfully', 'success');
    }

    // Initialize the application
    async function initApp() {
        try {
            // Get current user
            currentUser = await getCurrentUserProfile();
            if (!currentUser) {
                window.location.href = 'login.html';
                return;
            }

            // Update UI with user info
            userNameDisplayHeader.textContent = currentUser.name || currentUser.email;
            userAvatar.textContent = (currentUser.name || currentUser.email).charAt(0).toUpperCase();
            currentUserRoleSpan.textContent = currentUser.role || 'viewer';

            // Show admin toolbar if user is admin
            if (isCurrentUserAdmin()) {
                adminToolbar.classList.remove('hidden');
            }

            // Load data and setup navigation
            await loadAndStructureData();
            populateSidebar();
            setupEventListeners();

            // Check initial hash and render appropriate view
            if (window.location.hash === '#home' || window.location.hash === '' || window.location.hash === '#') {
                dashboardData = await fetchDashboardData();
                renderDashboard();
            } else {
                handleHashChange();
            }

        } catch (error) {
            console.error('Error initializing app:', error);
            showToast('Failed to initialize application', 'error');
        }
    }

    function setupEventListeners() {
        // Sidebar toggle
        mobileSidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('closed');
        });

        // Hash change handling
        window.addEventListener('hashchange', handleHashChange);

        // Global search
        globalSearchInput.addEventListener('input', debounce(handleGlobalSearch, 300));

        // Logout handling
        logoutButton.addEventListener('click', () => {
            logoutConfirmModalOverlay.classList.remove('hidden');
        });

        cancelLogoutBtn.addEventListener('click', () => {
            logoutConfirmModalOverlay.classList.add('hidden');
        });

        confirmLogoutBtn.addEventListener('click', async () => {
            const { error } = await supabase.auth.signOut();
            if (error) {
                console.error('Error signing out:', error);
                showToast('Error signing out', 'error');
            } else {
                window.location.href = 'login.html';
            }
        });

        // Modal close handlers
        closeAddContentModalBtn.addEventListener('click', () => {
            addContentModalOverlay.classList.add('hidden');
        });

        cancelAddContentBtn.addEventListener('click', () => {
            addContentModalOverlay.classList.add('hidden');
        });

        // Close modals when clicking outside
        document.addEventListener('click', (e) => {
            if (e.target === addContentModalOverlay) {
                addContentModalOverlay.classList.add('hidden');
            }
            if (e.target === logoutConfirmModalOverlay) {
                logoutConfirmModalOverlay.classList.add('hidden');
            }
            if (e.target === deleteConfirmModalOverlay) {
                deleteConfirmModalOverlay.classList.add('hidden');
            }
        });

        // Escape key to close modals
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                addContentModalOverlay.classList.add('hidden');
                logoutConfirmModalOverlay.classList.add('hidden');
                deleteConfirmModalOverlay.classList.add('hidden');
                insertHtmlModalOverlay.classList.add('hidden');
                accessDeniedModalOverlay.classList.add('hidden');
            }
        });
    }

    function handleHashChange() {
        const hash = window.location.hash.substring(1); // Remove the # symbol
        if (!hash || hash === 'home') {
            renderDashboard();
            return;
        }

        // Check if it's a section/item detail view (contains slash)
        if (hash.includes('/')) {
            const [sectionSlug, itemSlug] = hash.split('/');
            showItemDetail(sectionSlug, itemSlug);
        } else {
            // It's a section view
            showSection(hash);
        }
    }

    function showSection(sectionSlug) {
        dashboardOverviewContainer.classList.add('hidden');
        itemDetailViewPlaceholder.classList.add('hidden');
        standardSectionContentPlaceholder.classList.remove('hidden');

        const section = kbSystemData.sections.find(s => s.slug === sectionSlug);
        if (!section) {
            standardSectionContentPlaceholder.innerHTML = `
                <div class="card">
                    <h2>Section Not Found</h2>
                    <p>The requested section could not be found.</p>
                    <button class="button" onclick="window.location.hash = '#home'">
                        <i class="fas fa-arrow-left"></i> Return to Home
                    </button>
                </div>
            `;
            return;
        }

        currentSectionTitleEl.textContent = section.name;
        breadcrumbsContainer.innerHTML = `<a href="#home">Home</a> / ${escapeHTML(section.name)}`;

        let sectionHTML = '';
        
        if (section.items.length === 0) {
            sectionHTML = `
                <div class="card">
                    <h3>No Content Available</h3>
                    <p>This section doesn't have any content yet.</p>
                    ${isCurrentUserAdmin() ? `
                        <button class="button" onclick="openAddContentModal('${section.id}')">
                            <i class="fas fa-plus"></i> Add Content
                        </button>
                    ` : ''}
                </div>
            `;
        } else {
            sectionHTML = `
                <div class="cards-grid">
                    ${section.items.map(item => renderItemCard(item, section)).join('')}
                </div>
            `;
        }

        standardSectionContentPlaceholder.innerHTML = sectionHTML;
        highlightSidebarLink(sectionSlug);
    }

    function showItemDetail(sectionSlug, itemSlug) {
        dashboardOverviewContainer.classList.add('hidden');
        standardSectionContentPlaceholder.classList.add('hidden');
        itemDetailViewPlaceholder.classList.remove('hidden');

        const section = kbSystemData.sections.find(s => s.slug === sectionSlug);
        if (!section) {
            itemDetailViewPlaceholder.innerHTML = `
                <div class="card">
                    <h2>Section Not Found</h2>
                    <p>The requested section could not be found.</p>
                    <button class="button" onclick="window.location.hash = '#home'">
                        <i class="fas fa-arrow-left"></i> Return to Home
                    </button>
                </div>
            `;
            return;
        }

        const item = section.items.find(i => i.slug === itemSlug);
        if (!item) {
            itemDetailViewPlaceholder.innerHTML = `
                <div class="card">
                    <h2>Item Not Found</h2>
                    <p>The requested item could not be found.</p>
                    <button class="button" onclick="window.location.hash = '#${sectionSlug}'">
                        <i class="fas fa-arrow-left"></i> Back to ${escapeHTML(section.name)}
                    </button>
                </div>
            `;
            return;
        }

        currentOpenItem = item;
        currentSectionTitleEl.textContent = item.title_en;
        breadcrumbsContainer.innerHTML = `
            <a href="#home">Home</a> / 
            <a href="#${sectionSlug}">${escapeHTML(section.name)}</a> / 
            ${escapeHTML(item.title_en)}
        `;

        const itemIcons = {
            article: 'fas fa-newspaper',
            case: 'fas fa-briefcase',
            form_sheet: 'fas fa-file-invoice',
            design: 'fas fa-palette',
            guide: 'fas fa-book-open',
            policy: 'fas fa-gavel',
            default: 'fas fa-file-alt'
        };
        const itemIconClass = itemIcons[item.type] || itemIcons.default;

        const tagsHTML = item.tags?.length > 0
            ? `<div class="card-tags" style="margin-bottom: 1rem;">${item.tags.map(tag => `<span class="tag">${escapeHTML(tag)}</span>`).join('')}</div>`
            : '';

        const adminActionsHTML = isCurrentUserAdmin() ? `
            <div class="item-actions-bar">
                <button class="button" onclick="openEditModal('${section.id}', '${item.id}')">
                    <i class="fas fa-edit"></i> Edit
                </button>
                <button class="button button-danger" onclick="openDeleteModal('${section.id}', '${item.id}', '${escapeHTML(item.title_en)}')">
                    <i class="fas fa-trash-alt"></i> Delete
                </button>
                <button class="button-secondary" onclick="window.openEditModal('${section.id}', '${item.id}', true)">
                    <i class="fas fa-history"></i> Version History
                </button>
            </div>
        ` : '';

        let contentHTML = '';
        if (item.type === 'form_sheet' || item.type === 'design') {
            contentHTML = `
                <div class="card">
                    <h3><i class="fas fa-external-link-alt"></i> External Resource</h3>
                    <p>This content is available at the following link:</p>
                    <a href="${item.url}" target="_blank" class="button">
                        <i class="fas fa-external-link-alt"></i> Open ${item.type === 'form_sheet' ? 'Form' : 'Design'}
                    </a>
                </div>
            `;
        } else {
            contentHTML = item.content_en || '<p>No content available.</p>';
        }

        itemDetailViewPlaceholder.innerHTML = `
            <div class="card">
                <div class="card-header-icon">
                    <div style="display: flex; align-items: center;">
                        <div class="card-icon-container"><i class="${itemIconClass}"></i></div>
                        <div class="card-title-group">
                            <h2>${escapeHTML(item.title_en)}</h2>
                            <p style="color: var(--text-color-muted); margin: 0;">${escapeHTML(item.description_en)}</p>
                        </div>
                    </div>
                </div>
                ${tagsHTML}
                ${adminActionsHTML}
                <div class="item-content">
                    ${contentHTML}
                </div>
                <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                    <small style="color: var(--text-color-muted);">
                        Last modified: ${formatReadableDate(item.last_modified || item.created_at)}
                    </small>
                </div>
            </div>
        `;

        // Render Mermaid diagrams if any
        renderMermaidDiagramsInElement(itemDetailViewPlaceholder);

        // Log the view activity
        logActivity(currentUser, item.id, item.type, 'viewed');

        highlightSidebarLink(sectionSlug);
    }

    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    async function handleGlobalSearch(event) {
        const query = event.target.value.trim();
        const searchResults = document.getElementById('searchResultsContainer');

        if (!query) {
            searchResults.classList.add('hidden');
            searchResults.innerHTML = '';
            return;
        }

        try {
            // Perform search across articles
            const { data: results, error } = await supabase
                .from('cases')
                .select('id, title_en, description_en, content_en, type, sub_category_id, slug')
                .or(`title_en.ilike.%${query}%,description_en.ilike.%${query}%,content_en.ilike.%${query}%,tags.cs.{${query}}`)
                .eq('is_published', true)
                .limit(10);

            if (error) throw error;

            if (results.length === 0) {
                searchResults.innerHTML = `
                    <div class="search-result-item">
                        <i class="fas fa-search"></i>
                        <div>
                            <div class="search-result-title">No results found</div>
                            <div class="search-result-description">Try different keywords</div>
                        </div>
                    </div>
                `;
            } else {
                searchResults.innerHTML = results.map(result => {
                    const section = kbSystemData.sections.find(s => s.id === result.sub_category_id);
                    const sectionName = section ? section.name : 'Unknown Section';
                    const sectionSlug = section ? section.slug : 'home';

                    return `
                        <div class="search-result-item" onclick="window.location.hash='#${sectionSlug}/${result.slug}'">
                            <i class="fas fa-${result.type === 'article' ? 'newspaper' : result.type === 'case' ? 'briefcase' : 'file-alt'}"></i>
                            <div>
                                <div class="search-result-title">${highlightText(result.title_en, query)}</div>
                                <div class="search-result-description">${highlightText(truncateText(stripHtml(result.description_en), 100), query)}</div>
                                <div class="search-result-meta">${sectionName}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            searchResults.classList.remove('hidden');
        } catch (error) {
            console.error('Search error:', error);
            searchResults.innerHTML = `
                <div class="search-result-item">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>
                        <div class="search-result-title">Search error</div>
                        <div class="search-result-description">Please try again</div>
                    </div>
                </div>
            `;
            searchResults.classList.remove('hidden');
        }
    }

    // Make functions available globally for onclick handlers
    window.openEditModal = function(sectionId, itemId) {
        // Implementation for edit modal
        showToast('Edit functionality would open here', 'info');
    };

    window.openDeleteModal = function(sectionId, itemId, itemTitle) {
        deleteConfirmMessage.textContent = `Are you sure you want to delete "${itemTitle}"? This action cannot be undone.`;
        deleteConfirmModalOverlay.classList.remove('hidden');
        
        // Set up confirmation handler
        confirmDeleteItemBtn.onclick = async () => {
            try {
                const { error } = await supabase
                    .from('cases')
                    .delete()
                    .eq('id', itemId);

                if (error) throw error;

                showToast('Item deleted successfully', 'success');
                deleteConfirmModalOverlay.classList.add('hidden');
                
                // Reload the data and go back to section
                await loadAndStructureData();
                const section = kbSystemData.sections.find(s => s.id === sectionId);
                if (section) {
                    window.location.hash = `#${section.slug}`;
                } else {
                    window.location.hash = '#home';
                }
            } catch (error) {
                console.error('Error deleting item:', error);
                showToast('Error deleting item', 'error');
            }
        };
    };

    window.refreshDashboardData = refreshDashboardData;

    // Initialize the app when DOM is loaded
    document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>
