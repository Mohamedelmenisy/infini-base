<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employees Directory - InfiniBase</title>
    <link href="data:image/svg+xml,&lt;svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32' width='32' height='32'&gt;&lt;rect width='32' height='32' rx='4' fill='%236366f1'/&gt;&lt;text x='50%' y='55%' dominant-baseline='middle' text-anchor='middle' font-family='Arial, sans-serif' font-size='18' font-weight='bold' fill='white'&gt;IB&lt;/text&gt;&lt;/svg&gt;" rel="icon" type="image/svg+xml"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
    <style>
        :root {
            --primary-color: #6366f1;
            --primary-color-hover: #4f46e5;
            --text-color: #d1d5db;
            --text-color-muted: #9ca3af;
            --bg-color: #111827;
            --bg-color-alt: #1f2937;
            --border-color: #374151;
            --border-radius: 0.5rem;
            --border-radius-lg: 0.75rem;
            --status-online: #22c55e;
            --status-offline: #ef4444;
        }
        html, body {
            height: 100%;
            margin: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 16px;
        }
        .hidden { display: none !important; }

        /* --- Layout --- */
        .page-wrapper {
            padding: 1.5rem 2rem;
        }
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .header-title h1 {
            font-size: 2rem; /* Bigger font for title */
            font-weight: 800;
            margin: 0 0 0.25rem 0;
            color: white;
        }
        .header-title p {
            font-size: 1rem;
            color: var(--text-color-muted);
            margin: 0;
        }
        .header-actions {
            display: flex;
            gap: 1rem;
        }

        /* --- Buttons --- */
        .button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.25rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: background-color 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .button:hover { background-color: var(--primary-color-hover); }
        .button-secondary {
            background-color: var(--bg-color-alt);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }
        .button-secondary:hover { background-color: var(--border-color); }
        
        /* --- Card & Table --- */
        .card {
            background-color: var(--bg-color-alt);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            overflow: hidden;
        }
        .table-container { overflow-x: auto; }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            text-align: left;
            font-size: 0.95rem; /* Slightly larger table font */
            vertical-align: middle;
        }
        thead th {
            background-color: var(--bg-color);
            color: var(--text-color-muted);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: #2a3546; }

        /* --- Table Content Styles --- */
        .user-info { display: flex; align-items: center; gap: 1rem; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: var(--primary-color); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; }
        .user-name { font-weight: 600; color: white; }
        .user-email { font-size: 0.85rem; color: var(--text-color-muted); }
        .role-badge { padding: 0.25rem 0.6rem; border-radius: 99px; font-size: 0.8rem; font-weight: 500; text-transform: capitalize; }
        .role-badge.admin { background-color: rgba(239, 68, 68, 0.2); color: #f87171; }
        .role-badge.editor { background-color: rgba(251, 191, 36, 0.2); color: #fcd34d; }
        .role-badge.viewer { background-color: rgba(59, 130, 246, 0.2); color: #93c5fd; }
        .status-indicator { display: flex; align-items: center; gap: 0.5rem; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; }
        .status-dot.online { background-color: var(--status-online); }
        .status-dot.offline { background-color: var(--status-offline); }
        
        /* --- Access Restricted Card --- */
        .access-restricted-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            height: 100vh;
            width: 100%;
        }
        .access-restricted-card .card {
            max-width: 450px;
            padding: 3rem;
        }
        .access-restricted-card .icon {
            font-size: 4rem;
            color: var(--primary-color);
            margin-bottom: 1.5rem;
        }
        .access-restricted-card h2 {
            font-size: 1.75rem;
            margin-bottom: 0.5rem;
            color: white;
        }
        .access-restricted-card p {
            color: var(--text-color-muted);
            margin-bottom: 2rem;
        }
    </style>
</head>
<body>

<!-- Main dashboard content, hidden by default -->
<div id="dashboard" class="hidden">
    <div class="page-wrapper">
        <header class="page-header">
            <div class="header-title">
                <h1>Employees Directory</h1>
                <p>Live roster, role management, and activity â€” managed by admins.</p>
            </div>
            <div class="header-actions">
                <a href="app.html" class="button button-secondary"><i class="fas fa-arrow-left"></i> Back to Dashboard</a>
                <button id="exportCsvBtn" class="button"><i class="fas fa-file-csv"></i> Export CSV</button>
            </div>
        </header>

        <div class="card">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Last Seen</th>
                        </tr>
                    </thead>
                    <tbody id="employeesTableBody">
                        <!-- Rows will be injected by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Admin access restricted card, visible by default -->
<div id="restricted-card" class="access-restricted-card">
    <div class="card">
        <div class="icon">ðŸ”’</div>
        <h2>Access Restricted</h2>
        <p>This page is available for administrators only.</p>
        <a href="app.html" class="button">Go Back to Dashboard</a>
    </div>
</div>


<script type="module">
    import { supabase } from './supabase.js';

    // --- Main Logic ---
    async function fetchEmployees() {
        const { data, error } = await supabase
            .from('users')
            .select('*')
            .order('name', { ascending: true });
        
        if (error) {
            console.error("Error fetching employees:", error);
            return [];
        }
        return data;
    }

    function renderEmployees(employees) {
        const tableBody = document.getElementById('employeesTableBody');
        if (!tableBody) return;

        if (employees.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="4" style="text-align: center; padding: 2rem;">No employees found.</td></tr>`;
            return;
        }

        tableBody.innerHTML = employees.map(emp => {
            const initials = (emp.name || 'U').split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
            const lastSeen = emp.last_sign_in_at ? new Date(emp.last_sign_in_at).toLocaleString() : 'Never';
            
            // Dummy online status logic
            const isOnline = Math.random() > 0.5;

            return `
                <tr>
                    <td>
                        <div class="user-info">
                            <div class="user-avatar">${initials}</div>
                            <div>
                                <div class="user-name">${emp.name || 'No Name'}</div>
                                <div class="user-email">${emp.email}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="role-badge ${emp.role}">${emp.role}</span>
                    </td>
                    <td>
                        <div class="status-indicator">
                            <span class="status-dot ${isOnline ? 'online' : 'offline'}"></span>
                            <span>${isOnline ? 'Online' : 'Offline'}</span>
                        </div>
                    </td>
                    <td>${lastSeen}</td>
                </tr>
            `;
        }).join('');
    }
    
    // --- Admin Access Check ---
    async function checkAdminAccess() {
        try {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                // Not logged in, show restricted card
                document.getElementById('dashboard').classList.add('hidden');
                document.getElementById('restricted-card').classList.remove('hidden');
                return;
            }
            // Logged in, check role from 'users' table
            const { data, error } = await supabase
                .from('users')
                .select('role')
                .eq('id', user.id)
                .single();

            if (error || !data || data.role !== 'admin') {
                // Not an admin, show restricted card
                document.getElementById('dashboard').classList.add('hidden');
                document.getElementById('restricted-card').classList.remove('hidden');
            } else {
                // Is an admin, show dashboard and load data
                document.getElementById('restricted-card').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                
                // Boot the application
                const employees = await fetchEmployees();
                renderEmployees(employees);
            }
        } catch (e) {
            console.error("Admin check failed:", e);
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('restricted-card').classList.remove('hidden');
        }
    }

    // --- Initial Load ---
    document.addEventListener('DOMContentLoaded', checkAdminAccess);

</script>

</body>
</html>
