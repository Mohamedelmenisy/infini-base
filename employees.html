<!doctype html>
<html lang=en dir=ltr>
<head>
<meta charset=UTF-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<title>InfiniBase â€” Employees Dashboard</title>
<link rel=preconnect href=https://fonts.googleapis.com>
<link rel=preconnect href=https://fonts.gstatic.com crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel=stylesheet>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css>
<script src=https://cdn.jsdelivr.net/npm/chart.js></script>
<style>:root{--bg-dark:#0F1015;--bg-card:#1A1C23;--bg-header:#21242D;--primary-accent:#6C5DD3;--primary-accent-light:#8374FF;--secondary-accent:#3F8CFF;--secondary-accent-light:#5DA1FF;--text-light:#F5F5F5;--text-muted:#9CA3B3;--border-color:#2A2D38;--success:#00B69B;--success-light:#00D6B5;--warning:#FFC454;--warning-light:#FFD27A;--danger:#FF6A55;--danger-light:#FF8A7A;--font-family:'Poppins',sans-serif;--border-radius:16px;--transition:all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);--shadow:0 4px 20px rgba(0, 0, 0, 0.25);--shadow-hover:0 8px 30px rgba(0, 0, 0, 0.35);--gradient-primary:linear-gradient(135deg, #6C5DD3 0%, #8374FF 100%)}*{margin:0;padding:0;box-sizing:border-box}html{scroll-behavior:smooth}body{font-family:var(--font-family);background-color:var(--bg-dark);color:var(--text-light);line-height:1.6;background-image:radial-gradient(circle at 10% 20%,rgba(108,93,211,.05) 0,transparent 20%),radial-gradient(circle at 90% 80%,rgba(63,140,255,.05) 0,transparent 20%)}::-webkit-scrollbar{width:8px;height:8px}::-webkit-scrollbar-track{background:var(--bg-dark)}::-webkit-scrollbar-thumb{background-color:var(--bg-header);border-radius:10px;border:2px solid var(--bg-dark)}::-webkit-scrollbar-thumb:hover{background-color:var(--primary-accent)}.insights-dashboard{padding:24px;display:grid;gap:24px;visibility:hidden}.dashboard-header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:16px;background:var(--bg-header);padding:24px;border-radius:var(--border-radius);border:1px solid var(--border-color);box-shadow:var(--shadow);position:relative;overflow:hidden}.dashboard-header::before{content:'';position:absolute;top:0;left:0;width:120px;height:120px;background:var(--gradient-primary);opacity:.1;border-radius:0 0 100% 0}.header-title h1{font-size:32px;font-weight:800;background:var(--gradient-primary);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:8px;position:relative;text-shadow:0 2px 10px rgba(0,0,0,.3)}.header-title p{color:var(--text-muted);font-size:15px;font-weight:500}.header-actions{display:flex;gap:12px;flex-wrap:wrap;align-items:center}.action-btn{background-color:var(--bg-card);color:var(--text-light);border:1px solid var(--border-color);padding:12px 20px;border-radius:12px;font-family:var(--font-family);cursor:pointer;transition:var(--transition);display:inline-flex;align-items:center;justify-content:center;gap:8px;font-weight:600;font-size:14px;box-shadow:var(--shadow);text-decoration:none}.action-btn.primary{background:var(--gradient-primary);border:none;color:#fff}.action-btn:hover{transform:translateY(-2px);box-shadow:var(--shadow-hover);border-color:var(--primary-accent)}.action-btn.primary:hover{background:var(--gradient-primary);filter:brightness(1.1)}.action-btn:disabled{opacity:.5;cursor:not-allowed;transform:none;box-shadow:none}.kpi-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:24px}.kpi-card{background-color:var(--bg-card);padding:28px 24px;border-radius:var(--border-radius);border:1px solid var(--border-color);animation:fadeInUp .5s ease-out forwards;opacity:0;transition:var(--transition);box-shadow:var(--shadow);position:relative;overflow:hidden}.kpi-card::before{content:'';position:absolute;top:0;left:0;width:100%;height:4px;background:var(--gradient-primary)}.kpi-card:hover{transform:translateY(-5px);box-shadow:var(--shadow-hover);border-color:var(--primary-accent-light)}.kpi-card .card-title{color:var(--text-muted);font-size:14px;font-weight:600;margin-bottom:16px;display:flex;align-items:center;gap:10px}.kpi-card .card-value{font-size:36px;font-weight:800;color:var(--text-light);line-height:1.2}.kpi-card .card-title i{font-size:16px;width:20px;text-align:center;color:var(--primary-accent-light)}.main-card{background-color:var(--bg-card);padding:24px;border-radius:var(--border-radius);border:1px solid var(--border-color);box-shadow:var(--shadow);transition:var(--transition)}.main-card:hover{transform:translateY(-5px);box-shadow:var(--shadow-hover)}.table-controls{display:flex;flex-wrap:wrap;align-items:center;gap:20px;padding-bottom:24px;margin-bottom:24px;border-bottom:1px solid var(--border-color)}.filter-group{display:flex;flex-direction:column;gap:8px;flex-grow:1;min-width:180px}.filter-group label{display:none}.filter-group input,.filter-group select{background-color:var(--bg-dark);border:1px solid var(--border-color);color:var(--text-light);padding:12px 16px;border-radius:12px;font-family:var(--font-family);transition:var(--transition);font-size:14px}.filter-group input:focus,.filter-group select:focus{outline:0;border-color:var(--primary-accent);box-shadow:0 0 0 3px rgba(108,93,211,.2)}.table-container{overflow-x:auto}.data-table{width:100%;border-collapse:collapse}.data-table th{background-color:var(--bg-header);color:var(--text-muted);font-weight:600;font-size:12px;text-align:left;padding:16px 20px;border-bottom:1px solid var(--border-color);text-transform:uppercase;letter-spacing:.5px}.data-table td{padding:16px 20px;border-bottom:1px solid var(--border-color);font-size:14px;color:var(--text-light)}.data-table tr{transition:background-color .2s ease-in-out}.data-table tr:last-child td{border-bottom:none}.data-table tr:hover{background-color:rgba(42,45,56,.6)}.user-info{display:flex;align-items:center;gap:12px}.user-avatar{width:36px;height:36px;border-radius:50%;background:var(--gradient-primary);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:14px}.user-name{font-weight:600;color:var(--text-light)}.user-email{font-size:12px;color:var(--text-muted)}.role-badge{padding:6px 12px;border-radius:8px;font-size:12px;font-weight:600;text-transform:uppercase}.role-badge.admin{background:rgba(108,93,211,.2);color:var(--primary-accent-light)}.role-badge.agent{background:rgba(63,140,255,.2);color:var(--secondary-accent-light)}.status-indicator{display:flex;align-items:center;gap:8px}.status-dot{width:10px;height:10px;border-radius:50%}.status-dot.online{background-color:var(--success);box-shadow:0 0 8px var(--success)}.status-dot.offline{background-color:var(--text-muted)}.charts-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:24px}.chart-card{background-color:var(--bg-card);padding:24px;border-radius:var(--border-radius);border:1px solid var(--border-color);box-shadow:var(--shadow);transition:var(--transition)}.chart-card:hover{transform:translateY(-5px);box-shadow:var(--shadow-hover)}.chart-card h3{font-size:18px;margin-bottom:20px;color:var(--text-light);font-weight:700;display:flex;align-items:center;gap:10px}.chart-card h3 i{background:var(--gradient-primary);-webkit-background-clip:text;-webkit-text-fill-color:transparent}.chart-placeholder{min-height:300px;display:flex;align-items:center;justify-content:center;color:var(--text-muted)}.pagination{display:flex;justify-content:center;align-items:center;gap:12px;margin-top:24px;padding:20px}.pagination-btn{background:var(--bg-header);border:1px solid var(--border-color);color:var(--text-light);padding:10px 16px;border-radius:10px;cursor:pointer;transition:var(--transition);font-size:14px;font-weight:600}.pagination-btn:hover:not(:disabled){background:var(--primary-accent);border-color:var(--primary-accent)}.pagination-btn:disabled{opacity:.5;cursor:not-allowed}.pagination-info{color:var(--text-muted);font-size:14px;margin:0 16px}.toast{position:fixed;top:24px;right:24px;z-index:1100;display:flex;align-items:center;gap:12px;padding:16px 20px;border-radius:var(--border-radius);color:#fff;box-shadow:var(--shadow-hover);opacity:0;transform:translateX(20px);transition:all .4s cubic-bezier(.25, .46, .45, .94)}.toast.show{opacity:1;transform:translateX(0)}.modal{position:fixed;inset:0;z-index:2000;display:none;align-items:center;justify-content:center;background:rgba(15,16,21,.8);backdrop-filter:blur(10px)}.modal.show{display:flex}.modal-content{background:var(--bg-card);color:var(--text-light);border-radius:var(--border-radius);padding:24px;width:90%;max-width:500px;max-height:80vh;overflow-y:auto;border:1px solid var(--border-color);box-shadow:var(--shadow-hover);animation:modal-fade-in .4s cubic-bezier(.165,.84,.44,1) forwards}@keyframes modal-fade-in{from{opacity:0;transform:scale(.9) translateY(10px)}to{opacity:1;transform:scale(1) translateY(0)}}.modal-header{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border-color);padding-bottom:16px;margin-bottom:20px}.modal h2{margin:0;color:#fff;font-size:20px}.modal .close-btn{background:0 0;border:none;font-size:24px;color:var(--text-muted);cursor:pointer;transition:color .2s ease}.modal .close-btn:hover{color:var(--primary-accent)}.modal-actions{margin-top:1.5rem;display:flex;justify-content:flex-end;gap:.75rem}.form-group{margin-bottom:1rem}.form-group label{display:block;margin-bottom:.5rem;font-weight:500}.form-group input,.form-group select{width:100%;padding:12px 16px;border:1px solid var(--border-color);border-radius:12px;background-color:var(--bg-dark);color:var(--text-light);font-size:14px;box-sizing:border-box}.form-group input:focus,.form-group select:focus{border-color:var(--primary-accent);box-shadow:0 0 0 3px rgba(108,93,211,.2);outline:0}.access-restricted-container{position:fixed;inset:0;z-index:3000;display:none;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:2rem;background:rgba(15,16,21,.9);backdrop-filter:blur(10px)}.access-restricted-card{max-width:450px;padding:3rem;background:var(--bg-card);border-radius:var(--border-radius);border:1px solid var(--border-color);box-shadow:var(--shadow-hover);animation:modal-fade-in .4s ease-out forwards}.access-restricted-card .icon{font-size:4rem;color:var(--primary-accent);margin-bottom:1.5rem;animation:fadeInUp .5s ease-out .2s forwards;opacity:0}.access-restricted-card h2{font-size:1.75rem;margin-bottom:.75rem;color:var(--text-light)}.access-restricted-card p{color:var(--text-muted);margin-bottom:2rem}@keyframes fadeInUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}.kpi-card:first-child{animation-delay:.1s}.kpi-card:nth-child(2){animation-delay:.2s}.kpi-card:nth-child(3){animation-delay:.3s}.kpi-card:nth-child(4){animation-delay:.4s}.kpi-card:nth-child(5){animation-delay:.5s}.back-to-dashboard-btn{background:var(--gradient-primary);color:#fff;border:none;padding:10px 16px;border-radius:10px;font-family:var(--font-family);cursor:pointer;transition:var(--transition);display:inline-flex;align-items:center;gap:8px;font-weight:600;font-size:13px;text-decoration:none;box-shadow:var(--shadow)}.back-to-dashboard-btn:hover{transform:translateY(-2px);box-shadow:var(--shadow-hover);filter:brightness(1.1)}@media (max-width:768px){.dashboard-header{flex-direction:column;align-items:flex-start}.header-actions{width:100%;justify-content:flex-start}.insights-dashboard{padding:16px}.table-controls{flex-direction:column;align-items:stretch}.charts-container{grid-template-columns:1fr}.kpi-container{grid-template-columns:repeat(auto-fit,minmax(200px,1fr))}.header-actions{flex-wrap:wrap;gap:8px}.back-to-dashboard-btn{order:-1;align-self:flex-start}}@media (max-width:480px){.kpi-container{grid-template-columns:1fr}.header-actions{flex-direction:column;align-items:stretch}.back-to-dashboard-btn{width:100%;justify-content:center}}</style>
</head>
<body>
<div id=toast-container></div>
<div id=dashboard-container class=insights-dashboard>
<header class=dashboard-header>
<div class=header-title>
<h1><i class="fas fa-users-cog"></i> Employees Dashboard</h1>
<p>Manage and track all employee activities and performance.</p>
</div>
<div class=header-actions>
<a href=/dashboard class="back-to-dashboard-btn"><i class="fas fa-arrow-left"></i> Back to Dashboard</a>
<button id=exportCsvBtn class=action-btn><i class="fas fa-file-csv"></i> Export CSV</button>
<button id=addEmployeeBtn class="action-btn primary"><i class="fas fa-plus"></i> Add Employee</button>
</div>
</header>
<div class=kpi-container>
<div class=kpi-card>
<div class=card-title><i class="fas fa-users"></i>Total Employees</div>
<div class=card-value id=total-employees>0</div>
</div>
<div class=kpi-card>
<div class=card-title><i class="fas fa-user-shield"></i>Admins</div>
<div class=card-value id=admin-count>0</div>
</div>
<div class=kpi-card>
<div class=card-title><i class="fas fa-headset"></i>Agents</div>
<div class=card-value id=agent-count>0</div>
</div>
<div class=kpi-card>
<div class=card-title><i class="fas fa-user-check"></i>Online Now</div>
<div class=card-value id=online-employees>0</div>
</div>
<div class=kpi-card>
<div class=card-title><i class="fas fa-chart-line"></i>Avg Views/Employee</div>
<div class=card-value id=avg-views>0</div>
</div>
</div>
<div class=main-card>
<div class=table-controls>
<div class=filter-group>
<label for=searchInput>Search</label>
<input id=searchInput placeholder="Search by name, email, or department...">
</div>
<div class=filter-group>
<label for=roleFilter>Role</label>
<select id=roleFilter>
<option value=all>All Roles</option>
<option value=admin>Admin</option>
<option value=agent>Agent</option>
</select>
</div>
<div class=filter-group>
<label for=statusFilter>Activity Status</label>
<select id=statusFilter>
<option value=all>All Status</option>
<option value=online>Online</option>
<option value=active_today>Active Today</option>
<option value=active_week>Active This Week</option>
<option value=inactive>Inactive</option>
</select>
</div>
</div>
<div class=table-container>
<table class=data-table>
<thead>
<tr>
<th>User</th>
<th>Role</th>
<th>Department</th>
<th>Activity Status</th>
<th>Articles Viewed</th>
<th>Total Views</th>
<th>Feedback</th>
<th>Avg Rating</th>
<th>Last Seen (Africa/Cairo)</th>
<th>Actions</th>
</tr>
</thead>
<tbody id=employeesTableBody></tbody>
</table>
</div>
<div class=pagination>
<button id=prevPageBtn class=pagination-btn><i class="fas fa-arrow-left"></i> Previous</button>
<span id=pageInfo>Page 1 of 1</span>
<button id=nextPageBtn class=pagination-btn>Next <i class="fas fa-arrow-right"></i></button>
</div>
</div>
<div class=charts-container>
<div class=chart-card>
<h3><i class="fas fa-chart-pie"></i>Department Distribution</h3>
<div class=chart-placeholder>
<canvas id=deptChart></canvas>
</div>
</div>
<div class=chart-card>
<h3><i class="fas fa-chart-bar"></i>Activity Distribution</h3>
<div class=chart-placeholder>
<canvas id=activityChart></canvas>
</div>
</div>
<div class=chart-card>
<h3><i class="fas fa-medal"></i>Top Performers</h3>
<div class=chart-placeholder>
<canvas id=performanceChart></canvas>
</div>
</div>
</div>
</div>
<div id=restricted-container class=access-restricted-container>
<div class=access-restricted-card>
<div class=icon>ðŸ”’</div>
<h2>Access Restricted</h2>
<p>You do not have the necessary permissions to view this page. This area is for administrators only.</p>
<a href=app.html class="action-btn primary">Go to Dashboard</a>
</div>
</div>
<div id=employee-modal class=modal>
<div class=modal-content>
<div class=modal-header>
<h2 id=modal-title>Add New Employee</h2>
<button class=close-btn data-close-modal>&times;</button>
</div>
<form id=employee-form>
<input type=hidden id=employee-id>
<div class=form-group><label for=employee-name>Full Name</label><input id=employee-name required></div>
<div class=form-group><label for=employee-email>Email</label><input type=email id=employee-email required></div>
<div class=form-group><label for=employee-department>Department</label><input id=employee-department placeholder="e.g., Support, Technical"></div>
<div class=form-group><label for=employee-role>Role</label><select id=employee-role required><option value=agent>Agent</option><option value=admin>Admin</option></select></div>
<div class=form-group><label for=employee-password>Password</label><input type=password id=employee-password autocomplete=new-password placeholder="Required for new user"></div>
<div class=modal-actions>
<button type=button class=action-btn data-close-modal>Cancel</button>
<button type=submit class="action-btn primary">Save Employee</button>
</div>
</form>
</div>
</div>
<div id=delete-confirm-modal class=modal>
<div class=modal-content style=max-width:400px;text-align:center>
<div style=font-size:3rem;color:var(--danger);margin-bottom:1rem><i class="fas fa-exclamation-triangle"></i></div>
<h2>Confirm Deletion</h2>
<p id=delete-confirm-message style=margin-bottom:1.5rem;font-size:1.1rem></p>
<div class=modal-actions style=justify-content:center>
<button type=button class=action-btn data-close-modal>Cancel</button>
<button type=button id=confirm-delete-btn class=action-btn style=background:var(--danger);color:#fff>Confirm Delete</button>
</div>
</div>
</div>
<script type=module>import{supabase}from"./supabase.js";const EDGE_ADD_URL="https://aefiigottnlcmjzilqnh.supabase.co/functions/v1/dynamic-endpoint",EDGE_DELETE_URL="https://aefiigottnlcmjzilqnh.supabase.co/functions/v1/bright-responder";let presenceInterval,allEmployees=[],filteredEmployees=[],charts={},currentUser=null,currentPage=1;const rowsPerPage=10,employeeModal=document.getElementById("employee-modal"),deleteConfirmModal=document.getElementById("delete-confirm-modal");function showToast(e,t="success"){const n=document.getElementById("toast-container");if(!n)return;const a=document.createElement("div");a.className="toast";const s={success:"var(--success)",error:"var(--danger)",info:"var(--primary-accent)"},o={success:"fa-check-circle",error:"fa-exclamation-circle",info:"fa-info-circle"};a.style.backgroundColor=s[t]||s.info,a.innerHTML=`<i class="fas ${o[t]||o.info}"></i> ${e}`,n.appendChild(a),setTimeout((()=>a.classList.add("show")),10),setTimeout((()=>{a.classList.remove("show"),a.addEventListener("transitionend",(()=>a.remove()),{once:!0})}),3e3)}async function fetchEmployees(){const{data:e,error:t}=await supabase.from("v_employees_dashboard").select("*").order("last_seen",{ascending:!1});return t?(console.error("Error fetching employees:",t),showToast("Failed to fetch employees.","error"),[]):e}function updateKPIs(e){const t=document.getElementById("total-employees"),n=document.getElementById("admin-count"),a=document.getElementById("agent-count"),s=document.getElementById("online-employees"),o=document.getElementById("avg-views");if(t&&n&&a&&s&&o){t.textContent=e.length;const r=e.filter((e=>"admin"===e.role)).length,c=e.filter((e=>"agent"===e.role)).length;i=e.filter((e=>"online"===e.activity_status)).length,l=(e.reduce(((e,t)=>e+(t.total_views||0)),0)/e.length).toFixed(1);n.textContent=r,a.textContent=c,s.textContent=i,o.textContent=l}}function renderEmployees(e){const t=document.getElementById("employeesTableBody");if(!t)return;t.innerHTML=0===e.length?'<tr><td colspan="10" style="text-align: center; padding: 2rem;">No employees found.</td></tr>':e.map((e=>{const t=(e.name||"U").split(" ").map((e=>e[0])).join("").substring(0,2).toUpperCase(),n=e.last_seen_cairo?new Date(e.last_seen_cairo).toLocaleString("en-US",{timeZone:"Africa/Cairo",year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"Never",a=e.activity_status||"inactive",s=getStatusColor(a),o=e.articles_viewed||0,r=e.total_views||0,c=e.feedback_given||0,i=e.avg_rating||0;return`<tr data-user-id="${e.id}">\n                            <td><div class="user-info"><div class="user-avatar">${t}</div><div><div class="user-name">${e.name||"No Name"}</div><div class="user-email">${e.email}</div></div></div></td>\n                            <td><span class="role-badge ${e.role||"agent"}">${e.role||"agent"}</span></td>\n                            <td>${e.department||"N/A"}</td>\n                            <td><div class="status-indicator"><span class="status-dot" style="background-color:${s}"></span><span>${a.replace(/_/g," ").toUpperCase()}</span></div></td>\n                            <td>${o}</td>\n                            <td>${r}</td>\n                            <td>${c}</td>\n                            <td>${i>0?i.toFixed(1):"N/A"}</td>\n                            <td>${n}</td>\n                            <td>\n                                <button class="action-btn edit" title="Edit User"><i class="fas fa-pencil-alt"></i></button>\n                                <button class="action-btn delete" title="Delete User"><i class="fas fa-trash-alt"></i></button>\n                            </td>\n                        </tr>`})).join("")}function getStatusColor(e){switch(e){case"online":return"var(--success)";case"active_today":return"var(--success-light)";case"active_week":return"var(--warning)";default:return"var(--text-muted)"}}function setupPagination(){const e=Math.max(1,Math.ceil(filteredEmployees.length/rowsPerPage));document.getElementById("pageInfo").textContent=`Page ${currentPage} of ${e}`,document.getElementById("prevPageBtn").disabled=1===currentPage,document.getElementById("nextPageBtn").disabled=currentPage>=e}const createChart=(e,t,n,a)=>{charts[e]&&charts[e].destroy();const s=document.getElementById(e);if(!s)return;const o=s.getContext("2d");charts[e]=new Chart(o,{type:t,data:n,options:a})};async function renderAllCharts(){const{data:e,error:t}=await supabase.from("v_employee_stats_for_charts").select("*").single();if(t)return console.error("Error fetching chart stats:",t);if(!e)return;const n={responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom",labels:{color:"#F5F5F5",font:{size:12},padding:15}},title:{display:!0,color:"#F5F5F5",font:{size:14,weight:"bold"},padding:{bottom:10}}}},a={responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}}};createChart("deptChart","doughnut",{labels:["Operations Development","Learning And Development"],datasets:[{data:[e.ops_development_count,e.learning_development_count],backgroundColor:["#8374FF","#5DA1FF"],borderColor:"#1A1C23",borderWidth:4}]},{...n,plugins:{...n.plugins,legend:{position:"right"}}}),createChart("activityChart","pie",{labels:["Never Visited","Low Engagement","Active"],datasets:[{data:[e.never_visited_count,e.low_engagement_count,e.total_employees-e.never_visited_count-e.low_engagement_count],backgroundColor:["#FF6A55","#FFC454","#00B69B"],borderColor:"#1A1C23",borderWidth:4}]},n));const s=await supabase.from("v_employees_dashboard").select("name, total_views").order("total_views",{ascending:!1}).limit(5);if(!s.error&&s.data){const e=s.data.map((e=>e.name)),t=s.data.map((e=>e.total_views||0));createChart("performanceChart","bar",{labels:e,datasets:[{label:"Total Views",data:t,backgroundColor:"rgba(0, 182, 155, 0.7)",borderRadius:4}]},{...a,scales:{y:{beginAtZero:!0,ticks:{color:"#F5F5F5"}},x:{ticks:{color:"#F5F5F5"},grid:{color:"#2A2D38"}}}})}}function applyFilters(e=!1){e&&(currentPage=1);const t=document.getElementById("searchInput").value.toLowerCase(),n=document.getElementById("roleFilter").value,a=document.getElementById("statusFilter").value;filteredEmployees=allEmployees.filter((e=>{const s=`${e.name||""} ${e.email||""} ${e.department||""}`.toLowerCase(),o="all"===n||e.role===n,r="all"===a||e.activity_status===a;return s.includes(t)&&o&&r}));const s=rowsPerPage*(currentPage-1),o=rowsPerPage*currentPage;renderEmployees(filteredEmployees.slice(s,o)),setupPagination()}function exportCSV(){let e=["Name","Email","Role","Department","Activity Status","Articles Viewed","Total Views","Feedback Given","Avg Rating","Last Seen"].join(",")+"\r\n";allEmployees.forEach((t=>{e+=[t.name,t.email,t.role,t.department,t.activity_status,t.articles_viewed,t.total_views,t.feedback_given,t.avg_rating>0?t.avg_rating.toFixed(1):"N/A",t.last_seen_cairo].map((e=>`"${e}"`)).join(",")+"\r\n"}));const t=document.createElement("a");t.href="data:text/csv;charset=utf-8,"+encodeURI(e),t.download="employees_export.csv",t.click(),showToast("CSV exported successfully","success")}function setupModals(){document.querySelectorAll("[data-close-modal]").forEach((e=>e.addEventListener("click",(()=>e.closest(".modal").classList.remove("show"))))),document.getElementById("addEmployeeBtn").addEventListener("click",(()=>{document.getElementById("modal-title").textContent="Add New Employee",document.getElementById("employee-form").reset(),document.getElementById("employee-id").value="",document.getElementById("employee-email").disabled=!1,document.querySelector("#employee-password").placeholder="Required for new user",employeeModal.classList.add("show")})),document.getElementById("employeesTableBody").addEventListener("click",(e=>{const t=e.target.closest("tr");if(!t)return;const n=allEmployees.find((e=>e.id===t.dataset.userId));n&&(e.target.closest(".edit")&&(document.getElementById("modal-title").textContent="Edit Employee",document.getElementById("employee-id").value=n.id,document.getElementById("employee-name").value=n.name,document.getElementById("employee-email").value=n.email,document.getElementById("employee-email").disabled=!0,document.getElementById("employee-department").value=n.department,document.getElementById("employee-role").value=n.role,document.getElementById("employee-password").value="",document.querySelector("#employee-password").placeholder="Leave blank to not change",employeeModal.classList.add("show")),e.target.closest(".delete")&&(document.getElementById("delete-confirm-message").textContent=`Delete ${n.name||n.email}?`,document.getElementById("confirm-delete-btn").dataset.userId=n.id,deleteConfirmModal.classList.add("show")))})),document.getElementById("employee-form").addEventListener("submit",handleFormSubmit),document.getElementById("confirm-delete-btn").addEventListener("click",handleDelete)}async function getAuthHeader(){const{data:{session:e}}=await supabase.auth.getSession();return e?`Bearer ${e.access_token}`:(showToast("Authentication error.","error"),null)}async function handleFormSubmit(e){e.preventDefault();const t=document.getElementById("employee-id").value,n=document.getElementById("employee-password").value,a=await getAuthHeader();if(!a)return;const s={full_name:document.getElementById("employee-name").value,email:document.getElementById("employee-email").value,department:document.getElementById("employee-department").value,role:document.getElementById("employee-role").value,password:n||void 0};try{if(t){const{error:e}=await supabase.from("users").update({name:s.full_name,role:s.role,department:s.department}).eq("id",t);if(e)throw e;showToast("User updated successfully.","success")}else{const e=await fetch(EDGE_ADD_URL,{method:"POST",headers:{"Content-Type":"application/json",Authorization:a},body:JSON.stringify(s)});if(!e.ok)throw new Error(await e.text());showToast("Employee created successfully!","success")}employeeModal.classList.remove("show"),await refreshData()}catch(e){showToast(`Error: ${e.message}`,"error")}}async function handleDelete(e){const t=e.currentTarget.dataset.userId,n=await getAuthHeader();if(n)try{const e=await fetch(EDGE_DELETE_URL,{method:"POST",headers:{"Content-Type":"application/json",Authorization:n},body:JSON.stringify({user_id:t})});if(!e.ok)throw new Error(await e.text());showToast("Employee deleted successfully!","success"),deleteConfirmModal.classList.remove("show"),await refreshData()}catch(e){showToast(`Error deleting employee: ${e.message}`,"error")}}async function updateLastSeen(){currentUser&&await supabase.from("users").update({last_seen:(new Date).toISOString()}).eq("id",currentUser.id)}async function initPresence(){const e=supabase.channel("presence:employees",{config:{presence:{key:currentUser.id}}});e.on("presence",{event:"sync"},(()=>{const t=Object.keys(e.presenceState());allEmployees=allEmployees.map((e=>({...e,activity_status:t.includes(e.id)?"online":e.activity_status}))),applyFilters(),updateKPIs(allEmployees)})).subscribe((async t=>{"SUBSCRIBED"===t&&(await e.track({user_id:currentUser.id}),await updateLastSeen(),presenceInterval&&clearInterval(presenceInterval),presenceInterval=setInterval(updateLastSeen,3e5))}))}async function refreshData(){allEmployees=await fetchEmployees(),applyFilters(!0),updateKPIs(allEmployees),renderAllCharts()}async function checkAccess(){try{const{data:{user:e}}=await supabase.auth.getUser();if(!e)throw new Error("User not logged in.");const{data:t,error:n}=await supabase.from("users").select("role").eq("id",e.id).single();if(n)throw new Error("Could not verify user role.");if(!t)throw new Error("User profile not found.");console.log("User Role Fetched:",t.role);if("admin"!==(t.role||"").trim().toLowerCase())throw new Error("Access denied. Admin role required.");currentUser=e,document.getElementById("dashboard-container").style.visibility="visible",await refreshData(),setupModals(),await initPresence(),supabase.channel("public:users").on("postgres_changes",{event:"*",schema:"public",table:"users"},refreshData).subscribe()}catch(e){console.error("Access Check Failed:",e.message),document.getElementById("restricted-container").style.display="flex"}}document.addEventListener("DOMContentLoaded",(()=>{checkAccess(),document.getElementById("searchInput").addEventListener("input",(()=>applyFilters(!0))),document.getElementById("roleFilter").addEventListener("change",(()=>applyFilters(!0))),document.getElementById("statusFilter").addEventListener("change",(()=>applyFilters(!0))),document.getElementById("exportCsvBtn").addEventListener("click",exportCSV),document.getElementById("prevPageBtn").addEventListener("click",(()=>{currentPage>1&&(currentPage--,applyFilters())})),document.getElementById("nextPageBtn").addEventListener("click",(()=>{currentPage<Math.ceil(filteredEmployees.length/rowsPerPage)&&(currentPage++,applyFilters())}))}));</script>
</body>
</html>
