<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Employees Directory â€” InfiniBase</title>
<link href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32' width='32' height='32'><rect width='32' height='32' rx='4' fill='%236366f1'/><text x='50%' y='55%' dominant-baseline='middle' text-anchor='middle' font-family='Arial, sans-serif' font-size='18' font-weight='bold' fill='white'>IB</text></svg>" rel="icon" type="image/svg+xml"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{
  --primary-color:#6366f1; --primary-color-hover:#4f46e5;
  --text-color:#d1d5db; --text-color-muted:#9ca3af;
  --bg-color:#111827; --bg-color-alt:#1f2937;
  --border-color:#374151; --border-radius:.5rem; --radius-lg:.75rem;
  --status-online:#22c55e; --status-offline:#9ca3af; --header-height:70px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial; background:#111827;color:var(--text-color);font-size:16px;}
.hidden{display:none!important}
.page-header{position:fixed;left:0;right:0;top:0;height:var(--header-height);display:flex;align-items:center;justify-content:space-between;padding:0 20px;background:rgba(31,41,55,0.85);border-bottom:1px solid var(--border-color);z-index:40;backdrop-filter:blur(6px)}
.header-left{display:flex;align-items:center;gap:12px}
.logo-ico{width:40px;height:40px;border-radius:8px;background:var(--primary-color);display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
.h-title{font-size:1.25rem;font-weight:700;color:#fff}
.header-actions{display:flex;gap:8px;align-items:center}
.button{background:var(--primary-color);color:white;border:none;padding:8px 12px;border-radius:8px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:8px;text-decoration:none}
.button.secondary{background:transparent;color:var(--text-color);border:1px solid var(--border-color)}
.container{padding:calc(var(--header-height) + 18px) 28px 28px}
.grid{display:grid;gap:16px}
.stats-grid{grid-template-columns:repeat(auto-fit,minmax(180px,1fr))}
.card{background:var(--bg-color-alt);border:1px solid var(--border-color);border-radius:var(--radius-lg);padding:16px}
.controls{display:flex;justify-content:space-between;gap:12px;align-items:center;flex-wrap:wrap}
.controls .left{display:flex;gap:8px;align-items:center}
.input,select{background:var(--bg-color);border:1px solid var(--border-color);color:var(--text-color);padding:8px 10px;border-radius:8px}
.table-wrap{overflow:auto;border-radius:8px;border:1px solid var(--border-color);background:var(--bg-color-alt)}
table{width:100%;border-collapse:collapse}
thead th{padding:12px;background:var(--bg-color);color:var(--text-color-muted);font-size:12px;text-transform:uppercase}
td,th{padding:12px;border-bottom:1px solid var(--border-color);vertical-align:middle}
tr:hover td{background:#202634}
.user-info{display:flex;align-items:center;gap:12px}
.avatar{width:44px;height:44px;border-radius:8px;background:var(--primary-color);display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
.name{font-weight:600;color:white}
.email{font-size:13px;color:var(--text-color-muted)}
.role-badge{padding:4px 8px;border-radius:999px;font-size:13px}
.role-admin{background:rgba(167,139,250,0.15);color:#c4b5fd}
.role-viewer{background:rgba(59,130,246,0.08);color:#93c5fd}
.status-dot{width:10px;height:10px;border-radius:50%}
.status-online{background:var(--status-online);box-shadow:0 0 6px var(--status-online)}
.status-offline{background:var(--status-offline)}
.actions button{background:none;border:none;color:var(--text-color-muted);cursor:pointer;padding:6px;font-size:16px}
.pager{display:flex;gap:8px;align-items:center;justify-content:flex-end;padding-top:12px}
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:60;visibility:hidden;opacity:0;transition:all .12s}
.modal.show{visibility:visible;opacity:1}
.modal-panel{background:var(--bg-color-alt);width:100%;max-width:640px;border-radius:10px;padding:18px;border:1px solid var(--border-color)}
.form-row{display:flex;gap:12px;flex-wrap:wrap}
.form-group{flex:1;min-width:180px;margin-bottom:12px}
.small{font-size:13px;color:var(--text-color-muted)}
.note{background:rgba(99,102,241,0.08);padding:8px;border-radius:6px;border:1px solid rgba(99,102,241,0.12);color:#c7d2fe;font-size:13px}
.footer-note{margin-top:12px;font-size:13px;color:var(--text-color-muted)}
</style>
</head>
<body>
<header class="page-header" role="banner">
  <div class="header-left">
    <div class="logo-ico">IB</div>
    <div>
      <div class="h-title">Employees Directory</div>
      <div class="small">Live roster, role management & activity</div>
    </div>
  </div>
  <div class="header-actions">
    <a href="app.html" class="button secondary"><i class="fas fa-arrow-left"></i> Back to Dashboard</a>
    <button id="exportBtn" class="button secondary"><i class="fas fa-file-csv"></i> Export CSV</button>
    <button id="addBtn" class="button"><i class="fas fa-plus"></i> Add Employee</button>
  </div>
</header>

<main class="container">
  <section class="grid stats-grid" style="margin-bottom:12px">
    <div class="card">
      <div class="small">Total Employees</div>
      <div style="font-size:22px;font-weight:700" id="totalCount">0</div>
    </div>
    <div class="card">
      <div class="small">Online</div>
      <div style="font-size:22px;font-weight:700" id="onlineCount">0</div>
    </div>
    <div class="card">
      <div class="small">Admins</div>
      <div style="font-size:22px;font-weight:700" id="adminCount">0</div>
    </div>
  </section>

  <section class="card" style="margin-bottom:14px">
    <div class="controls">
      <div class="left">
        <input id="search" class="input" placeholder="Search name, email or case..." style="width:300px">
        <select id="timeRange" class="input">
          <option value="all">All</option>
          <option value="today">Today</option>
          <option value="7d">Last 7 days</option>
          <option value="30d">Last 30 days</option>
        </select>
        <select id="roleFilter" class="input">
          <option value="all">All Roles</option>
          <option value="admin">Admin</option>
          <option value="viewer">Viewer</option>
        </select>
      </div>
      <div>
        <button id="loadMoreBtn" class="button secondary">Load More</button>
      </div>
    </div>
  </section>

  <section class="card table-wrap">
    <table aria-label="Employees table">
      <thead>
        <tr>
          <th>User</th>
          <th>Role</th>
          <th>Status</th>
          <th>Last Seen</th>
          <th style="width:120px">Actions</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        <!-- rows injected -->
      </tbody>
    </table>
    <div class="pager" id="pagerControls">
      <button id="prevBtn" class="button secondary">Previous</button>
      <div id="pageInfo" class="small" style="margin-left:8px">Page 1</div>
      <button id="nextBtn" class="button secondary">Next</button>
    </div>
  </section>

  <section style="margin-top:14px" class="card">
    <h3 style="margin:0 0 12px 0">Role Distribution</h3>
    <div style="height:280px"><canvas id="rolesChart"></canvas></div>
  </section>
</main>

<!-- Modals -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="modal-panel" role="dialog" aria-modal="true">
    <h2 id="modalTitle">Add Employee</h2>
    <form id="employeeForm">
      <input type="hidden" id="empId" value="">
      <div class="form-row">
        <div class="form-group"><label class="small">Full name</label><input id="empName" class="input" required></div>
        <div class="form-group"><label class="small">Email</label><input id="empEmail" type="email" class="input" required></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="small">Role</label>
          <select id="empRole" class="input">
            <option value="viewer">Viewer</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div class="form-group"><label class="small">Password (only for create)</label><input id="empPassword" type="password" class="input" autocomplete="new-password"></div>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button type="button" id="cancelBtn" class="button secondary">Cancel</button>
        <button type="submit" id="saveBtn" class="button">Save</button>
      </div>
      <div class="footer-note">Note: Creating / deleting auth users requires a secure server endpoint (see comments in code).</div>
    </form>
  </div>
</div>

<div id="confirmModal" class="modal" aria-hidden="true">
  <div class="modal-panel" role="dialog"><h3>Confirm</h3><p id="confirmText"></p>
    <div style="display:flex;justify-content:center;gap:8px;margin-top:12px">
      <button id="confirmCancel" class="button secondary">Cancel</button>
      <button id="confirmDelete" class="button button-danger">Delete</button>
    </div>
  </div>
</div>

<script type="module">
/* eslint-disable no-console */
import { supabase } from './supabase.js'; // must export a configured supabase client (anon key)
/*
  SECURITY NOTICE:
  - This client-side code MUST NOT use service-role / admin keys in the browser.
  - Actions that require admin privileges on the Auth system (create/delete/update user password)
    must be implemented server-side (Edge Function or server endpoint) which uses the service role key.
  - This file demonstrates safe client interactions with the 'users' table and placeholders for admin endpoints.
*/

// State
let employees = [];
let filtered = [];
let page = 1;
const pageSize = 25;
let rolesChart = null;
const tableBody = document.getElementById('tableBody');
const totalCount = document.getElementById('totalCount');
const onlineCount = document.getElementById('onlineCount');
const adminCount = document.getElementById('adminCount');

// Helpers to read CSS vars
const styles = getComputedStyle(document.documentElement);
const chartTextColor = styles.getPropertyValue('--text-color').trim() || '#d1d5db';
const chartBgAlt = styles.getPropertyValue('--bg-color-alt').trim() || '#1f2937';

// Fetch employees from users table (assumes profile columns: id, name, email, role, status, last_sign_in_at)
async function loadEmployees() {
  const { data, error } = await supabase.from('users').select('id,name,email,role,status,last_sign_in_at,updated_at').order('name', { ascending: true });
  if (error) { console.error('fetch error', error); return; }
  employees = data || [];
  applyFilters();
  updateStats();
  renderChart();
}

// Render table current page
function renderTable() {
  const start = (page - 1) * pageSize;
  const end = start + pageSize;
  const pageRows = filtered.slice(start, end);
  tableBody.innerHTML = '';
  if (pageRows.length === 0) {
    tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center;padding:18px">No employees found.</td></tr>`;
    return;
  }
  for (const e of pageRows) {
    const initials = (e.name||'').split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase() || 'U';
    const lastSeen = e.last_sign_in_at ? new Date(e.last_sign_in_at).toLocaleString() : 'Never';
    const isOnline = (e.status || '').toUpperCase() === 'ONLINE';
    const tr = document.createElement('tr');
    tr.dataset.id = e.id;
    tr.innerHTML = `
      <td>
        <div class="user-info">
          <div class="avatar">${initials}</div>
          <div>
            <div class="name">${escapeHtml(e.name || 'No name')}</div>
            <div class="email">${escapeHtml(e.email || '')}</div>
          </div>
        </div>
      </td>
      <td><span class="role-badge ${e.role==='admin'?'role-admin':'role-viewer'}">${escapeHtml(e.role || '')}</span></td>
      <td><div style="display:flex;align-items:center;gap:8px"><div class="status-dot ${isOnline?'status-online':'status-offline'}"></div><div>${isOnline?'Online':'Offline'}</div></div></td>
      <td>${escapeHtml(lastSeen)}</td>
      <td class="actions">
        <button class="editBtn" title="Edit"><i class="fas fa-pencil-alt"></i></button>
        <button class="deleteBtn" title="Delete"><i class="fas fa-trash-alt"></i></button>
      </td>`;
    tableBody.appendChild(tr);
  }
  updatePager();
}

// Escape to avoid injection via names/emails
function escapeHtml(str){ return String(str||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;')}

// Filtering & search
function applyFilters(){
  const q = document.getElementById('search').value.trim().toLowerCase();
  const role = document.getElementById('roleFilter').value;
  const timeRange = document.getElementById('timeRange').value;
  filtered = employees.filter(e=>{
    const matchesQ = !q || (e.name && e.name.toLowerCase().includes(q)) || (e.email && e.email.toLowerCase().includes(q));
    const matchesRole = role==='all' || (e.role===role);
    let matchesTime = true;
    if (timeRange!=='all' && e.updated_at) {
      const updated = new Date(e.updated_at);
      const now = new Date();
      if (timeRange==='today') matchesTime = updated.toDateString()===now.toDateString();
      if (timeRange==='7d') matchesTime = (now - updated) <= 7*24*3600*1000;
      if (timeRange==='30d') matchesTime = (now - updated) <= 30*24*3600*1000;
    }
    return matchesQ && matchesRole && matchesTime;
  });
  page = 1;
  renderTable();
}

// Paging
function updatePager(){
  const pageInfo = document.getElementById('pageInfo');
  const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
  pageInfo.textContent = `Page ${page} of ${totalPages}`;
  document.getElementById('prevBtn').disabled = page<=1;
  document.getElementById('nextBtn').disabled = page>=totalPages;
}

// Stats
function updateStats(){
  totalCount.textContent = employees.length;
  onlineCount.textContent = employees.filter(e=> (e.status||'').toUpperCase()==='ONLINE').length;
  adminCount.textContent = employees.filter(e=> e.role==='admin').length;
}

// Chart
function renderChart(){
  const counts = employees.reduce((acc,e)=>{ acc[e.role] = (acc[e.role]||0)+1; return acc; },{});
  const labels = Object.keys(counts);
  const data = Object.values(counts);
  const ctx = document.getElementById('rolesChart').getContext('2d');
  if (rolesChart) rolesChart.destroy();
  rolesChart = new Chart(ctx, {
    type:'pie',
    data:{labels, datasets:[{data, backgroundColor:['#c4b5fd','#93c5fd','#fcd34d'], borderColor: chartBgAlt}]},
    options:{plugins:{legend:{labels:{color:chartTextColor,font:{size:13}}}},responsive:true,maintainAspectRatio:false}
  });
}

// Show modals
const modal = document.getElementById('modal');
const confirmModal = document.getElementById('confirmModal');
function showModal(edit=false, emp=null){
  document.getElementById('empId').value = edit ? emp.id : '';
  document.getElementById('empName').value = edit ? emp.name : '';
  document.getElementById('empEmail').value = edit ? emp.email : '';
  document.getElementById('empRole').value = edit ? emp.role : 'viewer';
  document.getElementById('empPassword').value = '';
  document.getElementById('modalTitle').textContent = edit ? 'Edit Employee' : 'Add Employee';
  modal.classList.add('show'); modal.style.visibility='visible';
}
function hideModal(){ modal.classList.remove('show'); modal.style.visibility='hidden'}
function showConfirm(text, cb){
  document.getElementById('confirmText').textContent = text;
  confirmModal.classList.add('show'); confirmModal.style.visibility='visible';
  const ok = document.getElementById('confirmDelete');
  const cancel = document.getElementById('confirmCancel');
  function cleanup(){ ok.removeEventListener('click', onOk); cancel.removeEventListener('click', onCancel); confirmModal.classList.remove('show'); confirmModal.style.visibility='hidden' }
  function onOk(){ cleanup(); cb(true) }
  function onCancel(){ cleanup(); cb(false) }
  ok.addEventListener('click', onOk);
  cancel.addEventListener('click', onCancel);
}

// Add / Edit handlers â€” NOTE: creating auth user must be done server-side (see comments)
document.getElementById('addBtn').addEventListener('click', ()=> showModal(false,null));
document.getElementById('cancelBtn').addEventListener('click', hideModal);
document.getElementById('employeeForm').addEventListener('submit', async (ev)=>{
  ev.preventDefault();
  const id = document.getElementById('empId').value;
  const name = document.getElementById('empName').value.trim();
  const email = document.getElementById('empEmail').value.trim();
  const role = document.getElementById('empRole').value;
  const password = document.getElementById('empPassword').value;
  try{
    if (id){
      // Update profile record in users table (not auth)
      const { error } = await supabase.from('users').update({ name, role }).eq('id', id);
      if (error) throw error;
      // If password change for auth user needed, CALL YOUR SERVER endpoint that uses service-role key
      if (password){
        // Example POST to server: /api/admin/reset-password with body { userId: id, password } 
        // Server performs supabase.auth.admin.update... using service role key.
        console.warn('Password update requires server-side endpoint. Implement /api/admin/reset-password');
      }
    } else {
      // Create new profile row in 'users' table and then create auth user via server endpoint.
      // We avoid performing supabase.auth.admin.createUser from the browser.
      const { data, error } = await supabase.from('users').insert([{ name, email, role }]).select().single();
      if (error) throw error;
      // Call your secure server endpoint to create auth user and set password (server uses service role key).
      // Example:
      // await fetch('/api/admin/create-user', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ email, password, user_meta:{name, role}, user_id: data.id })});
      alert('Profile record created. To create auth account, call your secure server endpoint.');
    }
    hideModal();
  }catch(err){ console.error(err); alert(err.message || 'Save failed') }
});

// Table action clicks (delegate)
tableBody.addEventListener('click', (e)=>{
  const tr = e.target.closest('tr');
  if(!tr) return;
  const id = tr.dataset.id;
  if (e.target.closest('.editBtn') || e.target.closest('.fa-pencil-alt')){
    const emp = employees.find(x=>x.id==id); if(emp) showModal(true,emp);
  } else if (e.target.closest('.deleteBtn') || e.target.closest('.fa-trash-alt')){
    const emp = employees.find(x=>x.id==id);
    if(!emp) return;
    showConfirm(`Delete ${emp.name || emp.email}? This cannot be undone.`, async (ok)=>{
      if(!ok) return;
      // Deleting auth account requires server-side service key; here we delete profile row and ask server to delete auth user.
      try{
        const { error } = await supabase.from('users').delete().eq('id', id);
        if (error) throw error;
        // Call server endpoint to delete auth user by id if desired.
        alert('Profile deleted. If you need to remove the auth account, call your secure server endpoint.');
      }catch(err){ console.error(err); alert(err.message || 'Delete failed') }
    });
  }
});

// Search / filters
document.getElementById('search').addEventListener('input', ()=> applyFilters());
document.getElementById('roleFilter').addEventListener('change', ()=> applyFilters());
document.getElementById('timeRange').addEventListener('change', ()=> applyFilters());
document.getElementById('prevBtn').addEventListener('click', ()=>{ if(page>1){page--; renderTable()} });
document.getElementById('nextBtn').addEventListener('click', ()=>{ const maxp=Math.ceil(filtered.length/pageSize); if(page<maxp){page++; renderTable()} });
document.getElementById('loadMoreBtn').addEventListener('click', ()=>{ page++; renderTable() });
document.getElementById('exportBtn').addEventListener('click', ()=> exportCsv());

// CSV export
function exportCsv(){
  const headers = ['Name','Email','Role','Status','Last seen'];
  const rows = employees.map(e=>[e.name||'', e.email||'', e.role||'', e.status||'', e.last_sign_in_at||'']);
  const csv = [headers, ...rows].map(r=>r.map(v=>`"${String(v||'').replace(/"/g,'""')}"`).join(',')).join('\r\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='employees.csv'; a.click(); URL.revokeObjectURL(url);
}

// Admin access check & initial load + realtime subscription
async function init(){
  try{
    const { data:{ user } } = await supabase.auth.getUser();
    if(!user){ alert('Not signed in'); return showAccessDenied(); }
    // Lookup role in users table
    const { data, error } = await supabase.from('users').select('role').eq('id', user.id).single();
    if (error || !data || data.role!=='admin') return showAccessDenied();
    // ok admin
    await loadEmployees();
    // realtime listen to users table
    supabase.channel('public:users')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'users' }, payload=>{
        // refresh minimal: re-fetch or apply payload change to local array
        loadEmployees();
      })
      .subscribe();
  }catch(err){ console.error(err); showAccessDenied() }
}
function showAccessDenied(){ document.body.innerHTML = `<div style="height:100vh;display:flex;align-items:center;justify-content:center;background:${styles.getPropertyValue('--bg-color')}"><div style="text-align:center;color:${styles.getPropertyValue('--text-color')}"><div style="font-size:48px">ðŸ”’</div><h2>Access Restricted</h2><p style="color:${styles.getPropertyValue('--text-color-muted')}">This page is available to administrators only.</p><a href='app.html' class='button' style='margin-top:12px'>Back to Dashboard</a></div></div>`; }
document.addEventListener('DOMContentLoaded', init);

// util: re-render stats + chart when employees changes
function applyFiltersAndRender(){
  applyFilters();
  updateStats();
  renderChart();
}

// initial applyFilters wrapper used by loadEmployees
function applyFilters(){ 
  // this function name used earlier; reusing for simple flow
  const q = document.getElementById('search').value.trim().toLowerCase();
  const role = document.getElementById('roleFilter').value;
  const timeRange = document.getElementById('timeRange').value;
  filtered = employees.filter(e=>{
    const matchesQ = !q || (e.name && e.name.toLowerCase().includes(q)) || (e.email && e.email.toLowerCase().includes(q));
    const matchesRole = role==='all' || (e.role===role);
    let matchesTime = true;
    if (timeRange!=='all' && e.updated_at){
      const updated = new Date(e.updated_at), now=new Date();
      if (timeRange==='today') matchesTime = updated.toDateString()===now.toDateString();
      if (timeRange==='7d') matchesTime = (now-updated) <= 7*24*3600*1000;
      if (timeRange==='30d') matchesTime = (now-updated) <= 30*24*3600*1000;
    }
    return matchesQ && matchesRole && matchesTime;
  });
  page=1; renderTable(); updateStats(); renderChart();
}

// updateStats used above
function updateStats(){ totalCount.textContent = employees.length; onlineCount.textContent = employees.filter(e=> (e.status||'').toUpperCase()==='ONLINE').length; adminCount.textContent = employees.filter(e=> e.role==='admin').length; }

</script>
</body>
</html>
