<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Employees • InfiniBase — Admin</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{--primary:#6366f1;--bg:#0f1724;--panel:#111827;--muted:#9ca3af;--card:#0b1220;--accent:#06b6d4;}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:#e6eef8; -webkit-font-smoothing:antialiased}
    header{height:72px;position:fixed;left:0;right:0;top:0;background:rgba(6,8,15,.6);backdrop-filter:blur(6px);display:flex;align-items:center;justify-content:space-between;padding:0 20px;border-bottom:1px solid rgba(255,255,255,.03);z-index:40}
    header .left{display:flex;align-items:center;gap:12px}
    .logo{width:44px;height:44;border-radius:8px;background:linear-gradient(135deg,#6366f1,#4f46e5);display:flex;align-items:center;justify-content:center;font-weight:700;color:white}
    main{padding:96px 28px 28px;max-width:1200px;margin:0 auto}
    .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:14px;margin-bottom:18px}
    .kpi{background:var(--panel);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,.03);display:flex;align-items:center;gap:12px}
    .kpi .icon{width:44px;height:44;border-radius:10px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,.03);font-size:18px}
    .kpi .num{font-weight:700;font-size:20px}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:18px}
    .card{background:var(--panel);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,.03)}
    .controls{display:flex;gap:10px;align-items:center;margin-bottom:10px;flex-wrap:wrap}
    input[type="text"], select{background:transparent;border:1px solid rgba(255,255,255,.05);color:inherit;padding:10px;border-radius:8px}
    table{width:100%;border-collapse:collapse}
    thead th{font-size:12px;text-transform:uppercase;color:var(--muted);text-align:left;padding:10px;border-bottom:1px solid rgba(255,255,255,.02)}
    tbody td{padding:12px;border-bottom:1px solid rgba(255,255,255,.02);vertical-align:middle}
    .avatar{width:40px;height:40;border-radius:10px;background:linear-gradient(135deg,#6ee7b7,#3b82f6);display:flex;align-items:center;justify-content:center;font-weight:700;color:#032; margin-right:10px}
    .role-badge{padding:6px 10px;border-radius:999px;font-size:13px}
    .role-admin{background:rgba(167,139,250,.12);color:#c4b5fd}
    .role-agent{background:rgba(99,102,241,.06);color:#9ca3ff}
    .role-viewer{background:rgba(59,130,246,.06);color:#93c5fd}
    .actions button{background:transparent;border:1px solid rgba(255,255,255,.04);color:inherit;padding:8px;border-radius:8px;margin-left:6px;cursor:pointer}
    .actions button.danger{border-color:rgba(239,68,68,.2);color:#fda4af}
    footer.note{margin-top:12px;color:var(--muted);font-size:13px}
    /* modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,.6);display:none;align-items:center;justify-content:center;padding:18px;z-index:100}
    .modal{width:100%;max-width:680px;background:var(--panel);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,.03)}
    .modal .row{display:flex;gap:12px;margin-bottom:10px}
    .modal label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    .btn{background:var(--primary);padding:10px 14px;border-radius:10px;border:none;color:white;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.04)}
    .small{font-size:13px;color:var(--muted)}
    @media (max-width:960px){ .grid{grid-template-columns:1fr} .chart-side{order:2} }
  </style>
</head>
<body>
  <header>
    <div class="left"><div class="logo">IB</div><div><strong style="font-size:16px">InfiniBase</strong><div class="small" style="color:var(--muted)">Knowledge Base — Employees</div></div></div>
    <div style="display:flex;gap:10px;align-items:center">
      <button id="exportCsv" class="btn ghost" title="Export CSV"><i class="fas fa-file-csv"></i>&nbsp;Export</button>
      <button id="addBtn" class="btn"><i class="fas fa-plus"></i>&nbsp;Add</button>
    </div>
  </header>

  <main>
    <div class="kpis">
      <div class="kpi"><div class="icon"><i class="fas fa-users"></i></div><div><div class="num" id="k_total">0</div><div class="small">Total Employees</div></div></div>
      <div class="kpi"><div class="icon"><i class="fas fa-user-shield"></i></div><div><div class="num" id="k_admins">0</div><div class="small">Admins</div></div></div>
      <div class="kpi"><div class="icon"><i class="fas fa-user-tie"></i></div><div><div class="num" id="k_agents">0</div><div class="small">Agents</div></div></div>
      <div class="kpi"><div class="icon"><i class="fas fa-crown"></i></div><div><div class="num" id="k_owners">0</div><div class="small">Owners</div></div></div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="controls">
          <input type="text" id="search" placeholder="Search name / email / department..." />
          <select id="filterRole"><option value="">All roles</option><option>admin</option><option>agent</option><option>viewer</option></select>
          <div style="flex:1"></div>
          <div class="small" id="lastUpdated">—</div>
        </div>

        <div style="overflow:auto;max-height:560px">
          <table>
            <thead><tr><th>User</th><th>Department</th><th>Role</th><th>Last Seen</th><th style="text-align:center">Actions</th></tr></thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
        <div class="note small" id="note">Note: Creating/deleting auth-users requires server-side service_role key. Client attempts may fail; when needed use server endpoint.</div>
      </div>

      <div class="card chart-side">
        <h4 style="margin:0 0 10px 0">Role Distribution</h4>
        <div style="height:220px"><canvas id="roleChart" style="width:100%;height:220px"></canvas></div>
        <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,.03)" />
        <h4 style="margin:0 0 10px 0">Activity (Active Employees — This Month vs Last)</h4>
        <div style="height:140px"><canvas id="activityChart" style="width:100%;height:140px"></canvas></div>
        <div id="topList" style="margin-top:10px"></div>
      </div>
    </div>
  </main>

  <!-- Modal -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h3 id="modalTitle">Add Employee</h3>
      <div style="margin-top:12px">
        <div class="row"><div style="flex:1"><label>Name</label><input id="m_name" type="text" /></div><div style="width:220px"><label>Role</label><select id="m_role"><option>agent</option><option>admin</option><option>viewer</option></select></div></div>
        <div class="row"><div style="flex:1"><label>Email</label><input id="m_email" type="text" /></div><div style="width:220px"><label>Department</label><input id="m_dept" type="text" /></div></div>
        <div class="row"><div style="flex:1"><label>Password <span class="small">(optional — server required)</span></label><input id="m_pass" type="password" /></div><div style="width:220px"><label>Owner?</label><select id="m_owner"><option value="0">No</option><option value="1">Yes</option></select></div></div>
        <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:10px">
          <button id="m_cancel" class="btn ghost">Cancel</button>
          <button id="m_save" class="btn">Save</button>
        </div>
        <div class="small" id="modalMsg" style="margin-top:8px;color:#fca5a5"></div>
      </div>
    </div>
  </div>

  <!-- Delete confirm -->
  <div id="delBackdrop" class="modal-backdrop">
    <div class="modal"><h3>Confirm Delete</h3><p class="small" id="delText"></p><div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px"><button id="delCancel" class="btn ghost">Cancel</button><button id="delConfirm" class="btn danger">Delete</button></div></div>
  </div>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  // TODO: Replace with your project's values
  const SUPABASE_URL = 'https://YOUR_SUPABASE_URL';
  const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // State
  let users = []; // merged users + metadata
  let presenceState = {};
  let roleChart, activityChart;

  // Utils
  const tz = 'Africa/Cairo';
  function fmt(dt){ if(!dt) return '—'; try{ return new Date(dt).toLocaleString('en-GB',{timeZone:tz,year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit',hour12:true}) }catch(e){return dt} }

  // Fetch and merge
  async function fetchAll(){
    const [{ data:authUsers, error: uErr }, { data:meta, error: mErr }] = await Promise.all([
      supabase.from('users').select('id,name,email,role,is_admin,created_at').order('name',{ascending:true}),
      supabase.from('employees').select('id,department').order('id',{ascending:true})
    ]);
    if(uErr) console.error('users err',uErr);
    const metaMap = (meta||[]).reduce((a,r)=>{a[r.id]=r;return a},{ });
    users = (authUsers||[]).map(u=>({ ...u, department: metaMap[u.id]?.department || '' }));
    return users;
  }

  // KPIs & Charts
  async function refreshKPIs(){
    // total etc
    const tot = users.length;
    const admins = users.filter(u=>u.role==='admin' || u.is_admin).length;
    const agents = users.filter(u=>u.role==='agent').length;
    const owners = users.filter(u=>u.role==='owner' || u.is_owner).length || 1;
    document.getElementById('k_total').innerText = tot;
    document.getElementById('k_admins').innerText = admins;
    document.getElementById('k_agents').innerText = agents;
    document.getElementById('k_owners').innerText = owners;

    // role distribution chart data
    const counts = users.reduce((a,u)=>{ a[u.role]=(a[u.role]||0)+1; return a },{});
    const labels = Object.keys(counts);
    const data = Object.values(counts);
    const ctx = document.getElementById('roleChart').getContext('2d');
    if(roleChart) roleChart.destroy();
    roleChart = new Chart(ctx,{type:'doughnut',data:{labels, datasets:[{data, backgroundColor:['#c4b5fd','#93c5fd','#fcd34d','#86efac']}]} , options:{plugins:{legend:{display:true}}}});

    // activity chart (monthly). try DB view v_monthly_activity else compute
    const { data: monthly, error: monErr } = await supabase.from('v_monthly_activity').select('*').order('month', {ascending:true});
    let months=[], totals=[], edits=[];
    if(!monErr && monthly && monthly.length){
      monthly.forEach(r=>{ months.push(new Date(r.month).toLocaleString('en-GB',{timeZone:tz,month:'short',year:'numeric'})); totals.push(r.total_actions); edits.push(r.total_edits); });
    } else {
      // fallback: compute counts from activity_log
      const { data: al } = await supabase.from('activity_log').select('id, user_id, action, timestamp');
      const byMonth = {};
      (al||[]).forEach(a=>{ const m=new Date(a.timestamp).toLocaleString('en-GB',{timeZone:tz,month:'short',year:'numeric'}); byMonth[m]=byMonth[m]||{tot:0,edit:0}; byMonth[m].tot++; if(['INSERT','UPDATE','DELETE'].includes(a.action)) byMonth[m].edit++; });
      Object.keys(byMonth).slice(-6).forEach(k=>{ months.push(k); totals.push(byMonth[k].tot); edits.push(byMonth[k].edit); });
    }
    const actCtx = document.getElementById('activityChart').getContext('2d');
    if(activityChart) activityChart.destroy();
    activityChart = new Chart(actCtx,{type:'line',data:{labels:months,datasets:[{label:'Total actions',data:totals,fill:false,borderColor:'#60a5fa'},{label:'Edits',data:edits,fill:false,borderColor:'#f97316'}]},options:{scales:{y:{beginAtZero:true}}}});

    // top active employees (by view count)
    const { data: tops } = await supabase.from('activity_log').select('user_id, user_name').limit(1000);
    const cnt = {};
    (tops||[]).forEach(r=>{ if(!r.user_id) return; cnt[r.user_name||r.user_id]=(cnt[r.user_name||r.user_id]||0)+1; });
    const sorted = Object.entries(cnt).sort((a,b)=>b[1]-a[1]).slice(0,5);
    const topList = document.getElementById('topList'); topList.innerHTML = '<strong class="small">Top Active</strong><ul class="small" style="padding-left:12px;margin:6px 0">'+sorted.map(s=>`<li>${s[0]} — ${s[1]} actions</li>`).join('')+'</ul>';
  }

  // Render table
  function renderTable(filter=''){
    const tbody = document.getElementById('tableBody');
    const roleFilter = document.getElementById('filterRole').value;
    const q = (filter||'').toLowerCase();
    const rows = users.filter(u=>{
      if(roleFilter && u.role!==roleFilter) return false;
      if(!q) return true;
      return (u.name||'').toLowerCase().includes(q) || (u.email||'').toLowerCase().includes(q) || (u.department||'').toLowerCase().includes(q);
    });
    if(rows.length===0){ tbody.innerHTML = '<tr><td colspan="5" class="small">No employees found</td></tr>'; return; }
    tbody.innerHTML = rows.map(u=>{
      const initials = (u.name||'').split(' ').map(n=>n[0]).join('').slice(0,2).toUpperCase()||'U';
      const last = u.last_seen || u.last_seen_at || null;
      return `<tr data-id="${u.id}">
        <td><div style="display:flex;align-items:center"><div class="avatar">${initials}</div><div><div style="font-weight:700">${u.name||'—'}</div><div class="small">${u.email||''}</div></div></div></td>
        <td>${u.department||'—'}</td>
        <td><span class="role-badge ${u.role==='admin'?'role-admin':u.role==='agent'?'role-agent':'role-viewer'}">${u.role||'agent'}</span></td>
        <td>${fmt(last)}</td>
        <td style="text-align:center" class="actions"><button class="editBtn">Edit</button><button class="danger deleteBtn">Delete</button></td>
      </tr>`;
    }).join('');
  }

  // Open/close modal
  function openModal(data){
    document.getElementById('modalBackdrop').style.display='flex';
    document.getElementById('modalMsg').innerText='';
    document.getElementById('m_name').value = data?.name||'';
    document.getElementById('m_email').value = data?.email||'';
    document.getElementById('m_role').value = data?.role||'agent';
    document.getElementById('m_dept').value = data?.department||'';
    document.getElementById('m_pass').value = '';
    document.getElementById('m_owner').value = data?.is_owner?1:0;
    document.getElementById('modalTitle').innerText = data? 'Edit Employee' : 'Add Employee';
    document.getElementById('m_save').dataset.id = data?.id||'';
  }
  function closeModal(){ document.getElementById('modalBackdrop').style.display='none'; }

  // Delete modal
  function openDelete(id,name){ document.getElementById('delBackdrop').style.display='flex'; document.getElementById('delText').innerText=`Delete ${name}? This action cannot be undone.`; document.getElementById('delConfirm').dataset.id=id; }
  function closeDelete(){ document.getElementById('delBackdrop').style.display='none'; }

  // CSV Export
  function exportCSV(){
    const headers = ['Name','Email','Role','Department','Created At'];
    const lines = [headers.join(',')];
    users.forEach(u=> lines.push([u.name||'',u.email||'',u.role||'',u.department||'',u.created_at||''].map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')));
    const blob = new Blob([lines.join('\n')],{type:'text/csv'});
    const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='employees_export.csv'; a.click(); URL.revokeObjectURL(url);
  }

  // Save (create or update)
  async function saveEmployee(){
    const id = document.getElementById('m_save').dataset.id;
    const name = document.getElementById('m_name').value.trim();
    const email = document.getElementById('m_email').value.trim();
    const role = document.getElementById('m_role').value;
    const department = document.getElementById('m_dept').value.trim()||null;
    const pass = document.getElementById('m_pass').value;
    const isOwner = document.getElementById('m_owner').value==='1';

    try{
      if(id){
        // update users table
        const { error: uErr } = await supabase.from('users').update({ name, role }).eq('id', id);
        if(uErr) throw uErr;
        // upsert metadata into employees
        const { error: eErr } = await supabase.from('employees').upsert([{ id, department }], { onConflict: 'id' });
        if(eErr) console.warn('employees upsert', eErr);
        // update local state
        const idx = users.findIndex(x=>x.id===id);
        if(idx>=0){ users[idx].name=name; users[idx].role=role; users[idx].department=department; users[idx].is_owner=isOwner; }
        closeModal();
        renderTable(document.getElementById('search').value);
        refreshKPIs();
        return;
      } else {
        // create: try to create auth user via admin API (likely fails on client) — fallback: create entry in employees and ask admin to create auth user
        let createdId = null;
        try{
          const { data: created, error: createErr } = await supabase.auth.admin.createUser({ email, password: pass||Math.random().toString(36).slice(-8), user_metadata:{ name, role } });
          if(createErr) throw createErr;
          createdId = (created && (created.user?.id||created.id)) || created.id;
        }catch(err){
          // admin API not available on client - fallback create minimal record in employees table and users table (if allowed)
          console.warn('admin create failed (client). We'll try to insert into users table directly.');
          const { data: ins, error: insErr } = await supabase.from('users').insert([{ name, email, role, created_at: new Date().toISOString() }]).select().single();
          if(insErr) { document.getElementById('modalMsg').innerText = 'Could not auto-create auth user. Please create via Admin panel.'; console.error(insErr); return; }
          createdId = ins.id;
        }
        // upsert metadata
        await supabase.from('employees').upsert([{ id: createdId, department }], { onConflict: 'id' });
        // refresh list
        await refreshAll();
        closeModal();
      }
    }catch(err){
      console.error(err);
      document.getElementById('modalMsg').innerText = err.message || JSON.stringify(err);
    }
  }

  // Delete
  async function confirmDelete(id){
    try{
      // try to delete auth user via admin (server) — likely blocked on client
      try{
        const { error: aErr } = await supabase.auth.admin.deleteUser(id);
        if(aErr) throw aErr;
      }catch(e){
        // fallback: remove entry from users table and employees metadata (soft in client-only mode)
        await supabase.from('employees').delete().eq('id',id);
        await supabase.from('users').delete().eq('id',id);
      }
      await refreshAll();
      closeDelete();
    }catch(err){ console.error(err); alert('Delete failed: '+(err.message||err)); }
  }

  // Presence setup
  async function initPresence(currentUser){
    try{
      const channel = supabase.channel('presence:employees', { config: { presence: { key: currentUser.id } } });
      channel.on('presence', { event:'sync' }, () => {
        const state = channel.presenceState();
        presenceState = state;
        // map users online
        users = users.map(u=>({...u, is_online: !!state[u.id]}));
        renderTable(document.getElementById('search').value);
      });
      await channel.subscribe(async (status) => {
        if(status==='SUBSCRIBED'){
          await channel.track({ user_id: currentUser.id, email: currentUser.email });
          // update last_seen via rpc if exists
          await supabase.rpc('update_last_seen',{ p_user_id: currentUser.id }).catch(()=>{});
        }
      });
    }catch(err){ console.warn('presence init error',err); }
  }

  // Refresh everything
  async function refreshAll(){
    users = await fetchAll();
    renderTable(document.getElementById('search').value);
    await refreshKPIs();
  }

  // Init
  document.getElementById('addBtn').addEventListener('click', ()=>openModal(null));
  document.getElementById('m_cancel').addEventListener('click', closeModal);
  document.getElementById('m_save').addEventListener('click', saveEmployee);
  document.getElementById('m_pass').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ saveEmployee(); } });
  document.getElementById('delCancel').addEventListener('click', closeDelete);
  document.getElementById('delConfirm').addEventListener('click', ()=>confirmDelete(document.getElementById('delConfirm').dataset.id));
  document.getElementById('search').addEventListener('input', (e)=>renderTable(e.target.value));
  document.getElementById('filterRole').addEventListener('change', ()=>renderTable(document.getElementById('search').value));
  document.getElementById('exportCsv').addEventListener('click', exportCSV);

  // delegate edit/delete
  document.addEventListener('click', (e)=>{
    if(e.target.closest('.editBtn')){
      const id = e.target.closest('tr').dataset.id; const u = users.find(x=>x.id===id); openModal(u);
    }
    if(e.target.closest('.deleteBtn')){
      const id = e.target.closest('tr').dataset.id; const u = users.find(x=>x.id===id); openDelete(id,u?.name||u?.email||id);
    }
  });

  // Startup: check admin from users table not auth metadata
  (async function(){
    try{
      const { data: sessionData } = await supabase.auth.getSession();
      const user = sessionData?.data?.user || (await supabase.auth.getUser()).data?.user;
      if(!user){ document.getElementById('note').innerText = 'Please login to view this page.'; return; }

      const { data: profile, error: pErr } = await supabase.from('users').select('role,is_admin').eq('id', user.id).single();
      if(pErr || !profile){ document.getElementById('note').innerText = 'Unable to read users profile. Please ensure you have read permissions.'; console.warn(pErr); return; }
      if(!(profile.role==='admin' || profile.is_admin===true)){
        // show restricted overlay
        document.body.innerHTML = `<div style="min-height:100vh;display:flex;align-items:center;justify-content:center;color:#fff"><div style="max-width:600px;text-align:center"><h2 style="font-size:22px">Access restricted</h2><p class="small">This page is for admins only. Ask an owner to grant you access.</p></div></div>`;
        return;
      }

      // user is admin — proceed
      users = await fetchAll();
      await refreshKPIs();
      renderTable();
      // presence & realtime
      await initPresence(user);
      supabase.channel('public:users').on('postgres_changes',{event:'*',schema:'public',table:'users'}, async ()=> { users = await fetchAll(); renderTable(); await refreshKPIs(); }).subscribe();
      supabase.channel('public:employees').on('postgres_changes',{event:'*',schema:'public',table:'employees'}, async ()=> { users = await fetchAll(); renderTable(); await refreshKPIs(); }).subscribe();

      // update lastUpdated
      document.getElementById('lastUpdated').innerText = 'Updated: ' + new Date().toLocaleString('en-GB',{timeZone:tz, hour12:true});
    }catch(err){ console.error('init err',err); document.getElementById('note').innerText = 'Initialization error: '+err.message; }
  })();
</script>
</body>
</html>
