<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InfiniBase â€” Employees Dashboard</title>

    <!-- Google Fonts: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Chart.js for interactive charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- 1. Global Styles & Theme Variables (Unified) --- */
        :root {
            --bg-dark: #0F1015;
            --bg-card: #1A1C23;
            --bg-header: #21242D;
            --primary-accent: #6C5DD3;
            --primary-accent-light: #8374FF;
            --secondary-accent: #3F8CFF;
            --secondary-accent-light: #5DA1FF;
            --text-light: #F5F5F5;
            --text-muted: #9CA3B3;
            --border-color: #2A2D38;
            --success: #00B69B;
            --success-light: #00D6B5;
            --warning: #FFC454;
            --warning-light: #FFD27A;
            --danger: #FF6A55;
            --danger-light: #FF8A7A;
            --font-family: 'Poppins', sans-serif;
            --border-radius: 16px;
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
            --shadow-hover: 0 8px 30px rgba(0, 0, 0, 0.35);
            --gradient-primary: linear-gradient(135deg, #6C5DD3 0%, #8374FF 100%);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: var(--font-family);
            background-color: var(--bg-dark);
            color: var(--text-light);
            line-height: 1.6;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(108, 93, 211, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(63, 140, 255, 0.05) 0%, transparent 20%);
        }

        /* Custom Scrollbar for a modern look */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }
        ::-webkit-scrollbar-thumb {
            background-color: var(--bg-header);
            border-radius: 10px;
            border: 2px solid var(--bg-dark);
        }
        ::-webkit-scrollbar-thumb:hover {
            background-color: var(--primary-accent);
        }
        
        /* --- 2. Main Dashboard Layout --- */
        .insights-dashboard {
            padding: 24px;
            display: grid;
            gap: 24px;
            visibility: hidden; /* Hide by default */
        }
        
        /* --- Header Section --- */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
            background: var(--bg-header);
            padding: 24px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }
        .dashboard-header::before {
            content: ''; position: absolute; top: 0; left: 0;
            width: 120px; height: 120px; background: var(--gradient-primary);
            opacity: 0.1; border-radius: 0 0 100% 0;
        }
        .header-title h1 {
            font-size: 32px; font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin-bottom: 8px; position: relative;
        }
        .header-title p { color: var(--text-muted); font-size: 15px; font-weight: 500; }
        .header-actions { display: flex; gap: 12px; }
        .action-btn {
            background-color: var(--bg-card); color: var(--text-light);
            border: 1px solid var(--border-color); padding: 12px 20px;
            border-radius: 12px; font-family: var(--font-family);
            cursor: pointer; transition: var(--transition);
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            font-weight: 600; font-size: 14px; box-shadow: var(--shadow);
            text-decoration: none;
        }
        .action-btn.primary { background: var(--gradient-primary); border: none; color: white; }
        .action-btn:hover {
            transform: translateY(-2px); box-shadow: var(--shadow-hover);
            border-color: var(--primary-accent);
        }
        .action-btn.primary:hover { background: var(--gradient-primary); filter: brightness(1.1); }
        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }

        /* --- 3. KPI Cards Section --- */
        .kpi-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 24px;
        }
        .kpi-card {
            background-color: var(--bg-card); padding: 28px 24px;
            border-radius: var(--border-radius); border: 1px solid var(--border-color);
            animation: fadeInUp 0.5s ease-out forwards; opacity: 0;
            transition: var(--transition); box-shadow: var(--shadow);
            position: relative; overflow: hidden;
        }
        .kpi-card::before {
            content: ''; position: absolute; top: 0; left: 0;
            width: 100%; height: 4px; background: var(--gradient-primary);
        }
        .kpi-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-hover); border-color: var(--primary-accent-light); }
        .kpi-card .card-title {
            color: var(--text-muted); font-size: 14px; font-weight: 600;
            margin-bottom: 16px; display: flex; align-items: center; gap: 10px;
        }
        .kpi-card .card-value { font-size: 36px; font-weight: 800; color: var(--text-light); line-height: 1.2; }
        .kpi-card .card-title i {
            font-size: 16px; width: 20px; text-align: center;
            color: var(--primary-accent-light);
        }

        /* --- 4. Filters & Table Section --- */
        .main-card {
            background-color: var(--bg-card); padding: 24px;
            border-radius: var(--border-radius); border: 1px solid var(--border-color);
            box-shadow: var(--shadow); transition: var(--transition);
        }
        .main-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-hover); }
        
        .table-controls {
            display: flex; flex-wrap: wrap; align-items: center; gap: 20px;
            padding-bottom: 24px; margin-bottom: 24px; border-bottom: 1px solid var(--border-color);
        }
        .filter-group {
            display: flex; flex-direction: column; gap: 8px; flex-grow: 1; min-width: 180px;
        }
        .filter-group label { display:none; }
        .filter-group input, .filter-group select {
            background-color: var(--bg-dark); border: 1px solid var(--border-color);
            color: var(--text-light); padding: 12px 16px;
            border-radius: 12px; font-family: var(--font-family);
            transition: var(--transition); font-size: 14px;
        }
        .filter-group input:focus, .filter-group select:focus {
            outline: none; border-color: var(--primary-accent);
            box-shadow: 0 0 0 3px rgba(108, 93, 211, 0.2);
        }
        
        /* --- Table Styling --- */
        .table-container { overflow-x: auto; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th {
            background-color: var(--bg-header); color: var(--text-muted);
            font-weight: 600; font-size: 12px; text-align: left;
            padding: 16px 20px; border-bottom: 1px solid var(--border-color);
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .data-table td {
            padding: 16px 20px; border-bottom: 1px solid var(--border-color);
            font-size: 14px; color: var(--text-light);
        }
        .data-table tr:last-child td { border-bottom: none; }
        .data-table tr:hover { background-color: rgba(42, 45, 56, 0.6); }

        .user-info { display: flex; align-items: center; gap: 12px; }
        .user-avatar {
            width: 36px; height: 36px; border-radius: 50%;
            background: var(--gradient-primary);
            display: flex; align-items: center; justify-content: center;
            color: white; font-weight: 600; font-size: 14px;
        }
        .user-name { font-weight: 600; color: var(--text-light); }
        .user-email { font-size: 12px; color: var(--text-muted); }

        .role-badge { padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 600; text-transform: uppercase; }
        .role-badge.admin { background: rgba(108, 93, 211, 0.2); color: var(--primary-accent-light); }
        .role-badge.agent { background: rgba(63, 140, 255, 0.2); color: var(--secondary-accent-light); }
        
        .status-indicator { display: flex; align-items: center; gap: 8px; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; }
        .status-dot.online { background-color: var(--success); box-shadow: 0 0 8px var(--success); }
        .status-dot.offline { background-color: var(--text-muted); }

        /* --- 5. Charts Section --- */
        .charts-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px; }
        .chart-card {
            background-color: var(--bg-card); padding: 24px; border-radius: var(--border-radius);
            border: 1px solid var(--border-color); box-shadow: var(--shadow);
            transition: var(--transition);
        }
        .chart-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-hover); }
        .chart-card h3 {
            font-size: 18px; margin-bottom: 20px; color: var(--text-light);
            font-weight: 700; display: flex; align-items: center; gap: 10px;
        }
        .chart-card h3 i { background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .chart-placeholder { min-height: 300px; display: flex; align-items: center; justify-content: center; color: var(--text-muted); }

        /* --- 6. Other Components (Pagination, Modals, etc.) --- */
        .pagination { display: flex; justify-content: center; align-items: center; gap: 12px; margin-top: 24px; padding: 20px; }
        .pagination-btn { background: var(--bg-header); border: 1px solid var(--border-color); color: var(--text-light); padding: 10px 16px; border-radius: 10px; cursor: pointer; transition: var(--transition); font-size: 14px; font-weight: 600; }
        .pagination-btn:hover:not(:disabled) { background: var(--primary-accent); border-color: var(--primary-accent); }
        .pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .pagination-info { color: var(--text-muted); font-size: 14px; margin: 0 16px; }

        .toast { position: fixed; top: 24px; right: 24px; z-index: 1100; display: flex; align-items: center; gap: 12px; padding: 16px 20px; border-radius: var(--border-radius); color: #fff; box-shadow: var(--shadow-hover); opacity: 0; transform: translateX(20px); transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .toast.show { opacity: 1; transform: translateX(0); }

        .modal { position: fixed; inset: 0; z-index: 2000; display: none; align-items: center; justify-content: center; background: rgba(15, 16, 21, 0.8); backdrop-filter: blur(10px); }
        .modal.show { display: flex; }
        .modal-content { background: var(--bg-card); color: var(--text-light); border-radius: var(--border-radius); padding: 24px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; border: 1px solid var(--border-color); box-shadow: var(--shadow-hover); animation: modal-fade-in 0.3s ease-out forwards; }
        @keyframes modal-fade-in { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 16px; margin-bottom: 20px; }
        .modal h2 { margin: 0; color: #fff; font-size: 20px; }
        .modal .close-btn { background: none; border: none; font-size: 24px; color: var(--text-muted); cursor: pointer; transition: color 0.2s ease; }
        .modal .close-btn:hover { color: var(--primary-accent); }
        .modal-actions { margin-top: 1.5rem; display: flex; justify-content: flex-end; gap: 0.75rem; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .form-group input, .form-group select { width: 100%; padding: 12px 16px; border: 1px solid var(--border-color); border-radius: 12px; background-color: var(--bg-dark); color: var(--text-light); font-size: 14px; box-sizing: border-box; }
        .form-group input:focus, .form-group select:focus { border-color: var(--primary-accent); box-shadow: 0 0 0 3px rgba(108, 93, 211, 0.2); outline: none; }
        
        /* MODIFIED: Access Restricted Container to be a full-screen overlay */
        .access-restricted-container {
            position: fixed;
            inset: 0;
            z-index: 3000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 2rem;
            background: rgba(15, 16, 21, 0.9);
            backdrop-filter: blur(10px);
        }
        .access-restricted-card {
            max-width: 450px;
            padding: 3rem;
            background: var(--bg-card);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-hover);
            animation: modal-fade-in 0.4s ease-out forwards;
        }
        .access-restricted-card .icon {
            font-size: 4rem; /* Increased icon size */
            color: var(--primary-accent);
            margin-bottom: 1.5rem;
            animation: fadeInUp 0.5s ease-out 0.2s forwards;
            opacity: 0;
        }
        .access-restricted-card h2 {
            font-size: 1.75rem;
            margin-bottom: 0.75rem;
            color: var(--text-light);
        }
        .access-restricted-card p {
            color: var(--text-muted);
            margin-bottom: 2rem;
        }

        /* --- Animations & Responsive --- */
        @keyframes fadeInUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .kpi-card:nth-child(1) { animation-delay: 0.1s; }
        .kpi-card:nth-child(2) { animation-delay: 0.2s; }
        .kpi-card:nth-child(3) { animation-delay: 0.3s; }
        .kpi-card:nth-child(4) { animation-delay: 0.4s; }
        .kpi-card:nth-child(5) { animation-delay: 0.5s; }
        
        @media (max-width: 768px) {
            .dashboard-header { flex-direction: column; align-items: flex-start; }
            .header-actions { width: 100%; justify-content: flex-start; }
            .insights-dashboard { padding: 16px; }
            .table-controls { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body>

    <div id="toast-container"></div>
    
    <div id="dashboard-container" class="insights-dashboard">

        <header class="dashboard-header">
            <div class="header-title">
                <h1><i class="fas fa-users-cog"></i> Employees Dashboard</h1>
                <p>Manage and track all employee activities and roles.</p>
            </div>
             <div class="header-actions">
                <button id="exportCsvBtn" class="action-btn"><i class="fas fa-file-csv"></i> Export CSV</button>
                <button id="addEmployeeBtn" class="action-btn primary"><i class="fas fa-plus"></i> Add Employee</button>
            </div>
        </header>

        <div class="kpi-container">
            <div class="kpi-card">
                <div class="card-title"><i class="fas fa-users"></i>Total Employees</div>
                <div class="card-value" id="total-employees">0</div>
            </div>
            <div class="kpi-card">
                <div class="card-title"><i class="fas fa-user-shield"></i>Admins</div>
                <div class="card-value" id="admin-count">0</div>
            </div>
            <div class="kpi-card">
                <div class="card-title"><i class="fas fa-headset"></i>Agents</div>
                <div class="card-value" id="agent-count">0</div>
            </div>
            <div class="kpi-card">
                <div class="card-title"><i class="fas fa-user-check"></i>Online Now</div>
                <div class="card-value" id="online-employees">0</div>
            </div>
            <div class="kpi-card">
                <div class="card-title"><i class="fas fa-user-clock"></i>Inactive (7+ days)</div>
                <div class="card-value" id="inactive-employees">0</div>
            </div>
        </div>

        <div class="main-card">
            <div class="table-controls">
                <div class="filter-group">
                    <label for="searchInput">Search</label>
                    <input type="text" id="searchInput" placeholder="Search by name, email, or department...">
                </div>
                <div class="filter-group">
                    <label for="roleFilter">Role</label>
                    <select id="roleFilter">
                        <option value="all">All Roles</option>
                        <option value="admin">Admin</option>
                        <option value="agent">Agent</option>
                    </select>
                </div>
                <div class="filter-group">
                     <label for="statusFilter">Status</label>
                    <select id="statusFilter">
                        <option value="all">All Status</option>
                        <option value="online">Online</option>
                        <option value="offline">Offline</option>
                    </select>
                </div>
            </div>

            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Role</th>
                            <th>Department</th>
                            <th>Status</th>
                            <th>Last Seen (Africa/Cairo)</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="employeesTableBody"></tbody>
                </table>
            </div>

            <div class="pagination">
                <button id="prevPageBtn" class="pagination-btn"><i class="fas fa-arrow-left"></i> Previous</button>
                <span id="pageInfo">Page 1 of 1</span>
                <button id="nextPageBtn" class="pagination-btn">Next <i class="fas fa-arrow-right"></i></button>
            </div>
        </div>
        
        <div class="charts-container">
            <div class="chart-card">
                 <h3><i class="fas fa-chart-pie"></i>Role Distribution</h3>
                <div class="chart-placeholder">
                     <canvas id="rolesChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                 <h3><i class="fas fa-chart-bar"></i>Department Distribution</h3>
                <div class="chart-placeholder">
                     <canvas id="deptsChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                 <h3><i class="fas fa-medal"></i>Top 5 Active Employees</h3>
                <div class="chart-placeholder">
                     <canvas id="top5Chart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div id="restricted-container" class="access-restricted-container">
        <div class="access-restricted-card">
            <div class="icon">ðŸ”’</div>
            <h2>Access Restricted</h2>
            <p>You do not have the necessary permissions to view this page. This area is for administrators only.</p>
            <a href="app.html" class="action-btn primary">Go to Dashboard</a>
        </div>
    </div>

    <!-- Modals -->
    <div id="employee-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Add New Employee</h2>
                <button class="close-btn" data-close-modal>&times;</button>
            </div>
            <form id="employee-form">
                <input type="hidden" id="employee-id">
                <div class="form-group"><label for="employee-name">Full Name</label><input type="text" id="employee-name" required></div>
                <div class="form-group"><label for="employee-email">Email</label><input type="email" id="employee-email" required></div>
                <div class="form-group"><label for="employee-department">Department</label><input type="text" id="employee-department" placeholder="e.g., Support, Technical"></div>
                <div class="form-group"><label for="employee-role">Role</label><select id="employee-role" required><option value="agent">Agent</option><option value="admin">Admin</option></select></div>
                <div class="form-group"><label for="employee-password">Password</label><input type="password" id="employee-password" autocomplete="new-password" placeholder="Required for new user"></div>
                <div class="modal-actions">
                    <button type="button" class="action-btn" data-close-modal>Cancel</button>
                    <button type="submit" class="action-btn primary">Save Employee</button>
                </div>
            </form>
        </div>
    </div>

    <div id="delete-confirm-modal" class="modal">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <div style="font-size: 3rem; color: var(--danger); margin-bottom: 1rem;"><i class="fas fa-exclamation-triangle"></i></div>
            <h2>Confirm Deletion</h2>
            <p id="delete-confirm-message" style="margin-bottom: 1.5rem; font-size: 1.1rem;"></p>
            <div class="modal-actions" style="justify-content: center;">
                <button type="button" class="action-btn" data-close-modal>Cancel</button>
                <button type="button" id="confirm-delete-btn" class="action-btn" style="background:var(--danger); color:white;">Confirm Delete</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { supabase } from './supabase.js';

        const EDGE_ADD_URL = 'https://aefiigottnlcmjzilqnh.supabase.co/functions/v1/dynamic-endpoint';
        const EDGE_DELETE_URL = 'https://aefiigottnlcmjzilqnh.supabase.co/functions/v1/bright-responder';

        let allEmployees = [], filteredEmployees = [];
        let charts = {};
        let currentUser = null;
        let presenceInterval;
        let currentPage = 1;
        const rowsPerPage = 10;

        const employeeModal = document.getElementById('employee-modal');
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            if (!container) return; // Exit if container not found
            const toast = document.createElement('div');
            toast.className = `toast`;
            const colors = { "success": "var(--success)", "error": "var(--danger)", "info": "var(--primary-accent)" };
            const icons = { "success": "fa-check-circle", "error": "fa-exclamation-circle", "info": "fa-info-circle" };
            toast.style.backgroundColor = colors[type] || colors.info;
            toast.innerHTML = `<i class="fas ${icons[type] || icons.info}"></i> ${message}`;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove(), { once: true });
            }, 3000);
        }
        
        async function fetchEmployees() {
            const { data, error } = await supabase.from('v_users_with_last_seen').select('*').order('name', { ascending: true });
            if (error) { 
                console.error("Error fetching employees:", error);
                showToast("Failed to fetch employees.", "error");
                return [];
            }
            return data;
        }

        function updateKPIs(employees) {
            document.getElementById('total-employees').textContent = employees.length;
            document.getElementById('admin-count').textContent = employees.filter(e => e.role === 'admin').length;
            document.getElementById('agent-count').textContent = employees.filter(e => e.role === 'agent').length;
            document.getElementById('online-employees').textContent = employees.filter(e => e.status === 'ONLINE').length;
            
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            const inactiveCount = employees.filter(e => e.last_seen && new Date(e.last_seen) < sevenDaysAgo).length;
            document.getElementById('inactive-employees').textContent = inactiveCount;
        }

        function renderEmployees(employeesToRender) {
            const tableBody = document.getElementById('employeesTableBody');
            tableBody.innerHTML = employeesToRender.length === 0 
                ? `<tr><td colspan="6" style="text-align: center; padding: 2rem;">No employees found.</td></tr>`
                : employeesToRender.map(emp => {
                    const initials = (emp.name || 'U').split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                    const lastSeen = emp.last_seen_cairo ? new Date(emp.last_seen_cairo).toLocaleString('en-US', { timeZone: 'Africa/Cairo', year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'Never';
                    const isOnline = emp.status === 'ONLINE';
                    return `<tr data-user-id="${emp.id}">
                            <td><div class="user-info"><div class="user-avatar">${initials}</div><div><div class="user-name">${emp.name || 'No Name'}</div><div class="user-email">${emp.email}</div></div></div></td>
                            <td><span class="role-badge ${emp.role || 'agent'}">${emp.role || 'agent'}</span></td><td>${emp.department || 'N/A'}</td>
                            <td><div class="status-indicator"><span class="status-dot ${isOnline ? 'online' : 'offline'}"></span><span>${isOnline ? 'Online' : 'Offline'}</span></div></td>
                            <td>${lastSeen}</td>
                            <td>
                                <button class="action-btn edit" title="Edit User"><i class="fas fa-pencil-alt"></i></button>
                                <button class="action-btn delete" title="Delete User"><i class="fas fa-trash-alt"></i></button>
                            </td>
                        </tr>`;
                }).join('');
        }
        
        function setupPagination() {
            const totalPages = Math.max(1, Math.ceil(filteredEmployees.length / rowsPerPage));
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
            document.getElementById('prevPageBtn').disabled = currentPage === 1;
            document.getElementById('nextPageBtn').disabled = currentPage >= totalPages;
        }
        
        const createChart = (chartId, type, data, options) => {
            if (charts[chartId]) charts[chartId].destroy();
            const ctx = document.getElementById(chartId).getContext("2d");
            charts[chartId] = new Chart(ctx, { type, data, options });
        };

        function renderAllCharts(employees) {
            const textColor = "#F5F5F5";
            const gridColor = "#2A2D38";
            
            const baseOptions = (title) => ({
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { position: "bottom", labels: { color: textColor, font: { size: 14 }, padding: 20 }},
                    title: { display: true, text: title, color: textColor, font: { size: 16, weight: "bold" }, padding: { bottom: 15 }},
                },
            });

            const roleCounts = employees.reduce((acc, emp) => { acc[emp.role] = (acc[emp.role] || 0) + 1; return acc; }, {});
            createChart('rolesChart', 'pie', {
                labels: Object.keys(roleCounts).map(r => r.charAt(0).toUpperCase() + r.slice(1)),
                datasets: [{ data: Object.values(roleCounts), backgroundColor: ['#8374FF', '#5DA1FF'], borderColor: '#1A1C23', borderWidth: 4 }]
            }, { ...baseOptions(''), plugins: { ...baseOptions('').plugins, legend: { position: 'right' } } });

            const deptCounts = employees.reduce((acc, emp) => { acc[emp.department || 'Unassigned'] = (acc[emp.department || 'Unassigned'] || 0) + 1; return acc; }, {});
            createChart('deptsChart', 'bar', {
                labels: Object.keys(deptCounts),
                datasets: [{ label: 'Employees', data: Object.values(deptCounts), backgroundColor: "rgba(108, 93, 211, 0.7)", borderRadius: 4 }]
            }, { ...baseOptions(''), indexAxis: 'y', plugins: { legend: { display: false } }, scales: { y: { ticks: { color: textColor } }, x: { ticks: { color: textColor }, grid: { color: gridColor } } } });

            renderTop5Chart();
        }

        async function renderTop5Chart() {
            const { data, error } = await supabase.from('v_top5_employees').select('*');
            if (error || !data || data.length === 0) return;
            createChart('top5Chart', 'bar', {
                labels: data.map(u => (u.user_name || u.user_email).split(' ')[0]),
                datasets: [{ label: 'Total Views', data: data.map(u => u.total_views), backgroundColor: "rgba(0, 182, 155, 0.7)", borderRadius: 4 }]
            }, { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { color: "#F5F5F5" } }, x: { ticks: { color: "#F5F5F5" }, grid: { color: "#2A2D38" } } } });
        }

        function applyFilters(resetPage = false) {
            if(resetPage) currentPage = 1;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const roleFilter = document.getElementById('roleFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            
            filteredEmployees = allEmployees.filter(emp => {
                const searchCorpus = `${emp.name || ''} ${emp.email || ''} ${emp.department || ''}`.toLowerCase();
                const roleMatch = roleFilter === 'all' || emp.role === roleFilter;
                const statusMatch = statusFilter === 'all' || (statusFilter === 'online' && emp.status === 'ONLINE') || (statusFilter === 'offline' && emp.status !== 'ONLINE');
                return searchCorpus.includes(searchTerm) && roleMatch && statusMatch;
            });
            const paginated = filteredEmployees.slice((currentPage - 1) * rowsPerPage, currentPage * rowsPerPage);
            renderEmployees(paginated);
            setupPagination();
        }
        
        function exportCSV() {
            const headers = ['Name', 'Email', 'Role', 'Department', 'Status', 'Last Seen (UTC)'];
            let csv = headers.join(',') + '\r\n';
            allEmployees.forEach(e => csv += [e.name, e.email, e.role, e.department, e.status, e.last_seen].map(v => `"${v}"`).join(',') + '\r\n');
            const link = document.createElement('a');
            link.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);
            link.download = 'employees_export.csv';
            link.click();
            showToast('CSV exported successfully', 'success');
        }

        function setupModals() {
            document.querySelectorAll('[data-close-modal]').forEach(btn => btn.addEventListener('click', () => btn.closest('.modal').classList.remove('show')));
            document.getElementById('addEmployeeBtn').addEventListener('click', () => {
                document.getElementById('modal-title').textContent = 'Add New Employee';
                document.getElementById('employee-form').reset();
                document.getElementById('employee-id').value = '';
                document.getElementById('employee-email').disabled = false;
                document.querySelector('#employee-password').placeholder = 'Required for new user';
                employeeModal.classList.add('show');
            });
            document.getElementById('employeesTableBody').addEventListener('click', (e) => {
                const row = e.target.closest('tr');
                if (!row) return;
                const employee = allEmployees.find(emp => emp.id === row.dataset.userId);
                if (!employee) return;
                if (e.target.closest('.edit')) {
                    document.getElementById('modal-title').textContent = 'Edit Employee';
                    document.getElementById('employee-id').value = employee.id;
                    document.getElementById('employee-name').value = employee.name;
                    document.getElementById('employee-email').value = employee.email;
                    document.getElementById('employee-email').disabled = true;
                    document.getElementById('employee-department').value = employee.department;
                    document.getElementById('employee-role').value = employee.role;
                    document.getElementById('employee-password').value = '';
                    document.querySelector('#employee-password').placeholder = 'Leave blank to not change';
                    employeeModal.classList.add('show');
                }
                if (e.target.closest('.delete')) {
                    document.getElementById('delete-confirm-message').textContent = `Delete ${employee.name || employee.email}?`;
                    document.getElementById('confirm-delete-btn').dataset.userId = employee.id;
                    deleteConfirmModal.classList.add('show');
                }
            });
            document.getElementById('employee-form').addEventListener('submit', handleFormSubmit);
            document.getElementById('confirm-delete-btn').addEventListener('click', handleDelete);
        }
        
        async function getAuthHeader() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) { showToast('Authentication error.', 'error'); return null; }
            return `Bearer ${session.access_token}`;
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('employee-id').value;
            const password = document.getElementById('employee-password').value;
            const authHeader = await getAuthHeader();
            if (!authHeader) return;

            const payload = {
                full_name: document.getElementById('employee-name').value,
                email: document.getElementById('employee-email').value,
                department: document.getElementById('employee-department').value,
                role: document.getElementById('employee-role').value,
                password: password || undefined
            };
            
            try {
                if (id) {
                    const { error } = await supabase.from('users').update({ name: payload.full_name, role: payload.role, department: payload.department }).eq('id', id);
                    if (error) throw error;
                    showToast('User updated successfully.', 'success');
                } else {
                    const res = await fetch(EDGE_ADD_URL, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': authHeader }, body: JSON.stringify(payload) });
                    if (!res.ok) throw new Error(await res.text());
                    showToast('Employee created successfully!', 'success');
                }
                employeeModal.classList.remove('show');
                await refreshData();
            } catch (err) {
                showToast(`Error: ${err.message}`, 'error');
            }
        }

        async function handleDelete(e) {
            const userId = e.currentTarget.dataset.userId;
            const authHeader = await getAuthHeader();
            if (!authHeader) return;
            try {
                const res = await fetch(EDGE_DELETE_URL, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': authHeader }, body: JSON.stringify({ user_id: userId }) });
                if (!res.ok) throw new Error(await res.text());
                showToast('Employee deleted successfully!', 'success');
                deleteConfirmModal.classList.remove('show');
                await refreshData();
            } catch (err) {
                showToast(`Error deleting employee: ${err.message}`, 'error');
            }
        }

        async function updateLastSeen() {
            if (currentUser) await supabase.from('users').update({ last_seen: new Date().toISOString() }).eq('id', currentUser.id);
        }

        async function initPresence() {
            const channel = supabase.channel('presence:employees', { config: { presence: { key: currentUser.id } } });
            channel.on('presence', { event: 'sync' }, () => {
                const onlineIds = Object.keys(channel.presenceState());
                allEmployees = allEmployees.map(emp => ({...emp, status: onlineIds.includes(emp.id) ? 'ONLINE' : 'OFFLINE' }));
                applyFilters(); 
                updateKPIs(allEmployees);
            }).subscribe(async (status) => {
                if (status === 'SUBSCRIBED') {
                    await channel.track({ user_id: currentUser.id });
                    await updateLastSeen();
                    if (presenceInterval) clearInterval(presenceInterval);
                    presenceInterval = setInterval(updateLastSeen, 300000); 
                }
            });
        }
        
        async function refreshData() {
            allEmployees = await fetchEmployees();
            applyFilters(true);
            updateKPIs(allEmployees);
            renderAllCharts(allEmployees);
        }

        async function checkAccess() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    throw new Error("User not logged in.");
                }

                const { data: userData, error } = await supabase
                    .from('users')
                    .select('role')
                    .eq('id', user.id)
                    .single();
                
                if (error) {
                    throw new Error("Could not verify user role.");
                }
                if (!userData) {
                    throw new Error("User profile not found.");
                }

                console.log('User Role Fetched:', userData.role);

                const userRole = (userData.role || '').trim().toLowerCase();

                if (userRole !== 'admin') {
                    throw new Error('Access denied. Admin role required.');
                }
                
                currentUser = user; 
                document.getElementById('dashboard-container').style.visibility = 'visible';
                
                await refreshData();
                setupModals();
                await initPresence();

                supabase.channel('public:users').on('postgres_changes', { event: '*', schema: 'public', table: 'users' }, refreshData).subscribe();

            } catch (e) {
                console.error("Access Check Failed:", e.message);
                document.getElementById('restricted-container').style.display = 'flex';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            checkAccess();
            document.getElementById('searchInput').addEventListener('input', () => applyFilters(true));
            document.getElementById('roleFilter').addEventListener('change', () => applyFilters(true));
            document.getElementById('statusFilter').addEventListener('change', () => applyFilters(true));
            document.getElementById('exportCsvBtn').addEventListener('click', exportCSV);
            document.getElementById('prevPageBtn').addEventListener('click', () => { if (currentPage > 1) { currentPage--; applyFilters(); } });
            document.getElementById('nextPageBtn').addEventListener('click', () => { if (currentPage < Math.ceil(filteredEmployees.length / rowsPerPage)) { currentPage++; applyFilters(); } });
        });
    </script>
</body>
</html>
