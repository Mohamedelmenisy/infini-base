<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up - InfiniBase</title>
    <!-- Favicon (Database Icon) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%234f46e5' stroke='white' stroke-width='0.5'><path d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm0 10c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4z'/><path d='M12 6c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm0 6c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z'/></svg>">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Styles from original signup.txt (InfiniBase) adapted and merged */
        body {
            background: linear-gradient(135deg, #4f46e5, #7c3aed); /* InfiniBase: Indigo to Purple gradient */
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
            padding: 1rem;
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .signup-container { /* Used from signup1.txt structure */
            background: white;
            border-radius: 1rem; /* 16px */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            padding: 2rem; /* 32px */
            max-width: 480px; /* Slightly wider for confirm password & terms */
            width: 100%;
        }
        .logo-container { /* Renamed from .logo to match original */
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1.5rem; /* 24px */
            color: #4f46e5; /* Indigo-600 */
        }
        .logo-container .logo-icon-fa { /* New class for FA icon */
            font-size: 2.5rem; /* 40px */
            margin-right: 0.75rem; /* 12px */
        }
        .logo-container h2 {
            font-size: 1.875rem; /* 30px */
            font-weight: 700;
        }
        .header-text { /* Renamed from .signup-header to match original */
            text-align: center;
            margin-bottom: 2rem; /* 32px */
        }
        .header-text h2 {
            font-size: 1.5rem; /* 24px */
            font-weight: 600;
            color: #1f2937; /* Gray-800 */
            margin-bottom: 0.25rem;
        }
        .header-text p {
            font-size: 0.875rem; /* 14px */
            color: #4b5563; /* Gray-600 */
        }
        .form-group { /* From signup1.txt, styling adapted */
            margin-bottom: 1.25rem; /* 20px */
        }
        .form-group label {
            display: block;
            font-size: 0.875rem; /* 14px */
            font-weight: 500;
            color: #374151; /* Gray-700 */
            margin-bottom: 0.5rem; /* 8px */
        }
        .input-wrapper { /* From signup1.txt, styling adapted */
            position: relative;
            display: flex;
            align-items: center;
        }
        .input-icon-fa { /* For FontAwesome icons, adapted from original */
            position: absolute;
            left: 0.75rem; /* 12px */
            color: #9ca3af; /* Gray-400 */
            font-size: 1rem; /* 16px */
            line-height: 1; /* Ensure proper vertical alignment */
            top: 50%;
            transform: translateY(-50%);
        }
        .input-field { /* Applied to inputs from signup1.txt */
            width: 100%;
            padding: 0.75rem 0.75rem 0.75rem 2.5rem; /* 12px, 12px, 12px, 40px for icon */
            border: 1px solid #d1d5db; /* Gray-300 */
            border-radius: 0.375rem; /* 6px */
            font-size: 0.875rem;
            color: #1f2937; /* Gray-800 */
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-field:focus {
            outline: none;
            border-color: #4f46e5; /* Indigo-600 */
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        }
        .input-field.error-border {
             border-color: #ef4444; /* red-500 */
        }
        .input-field.error-border:focus {
            border-color: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
        }
        .password-toggle { /* From signup1.txt, styling for position */
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #6b7280; /* Gray-500 */
        }
        .password-toggle svg { width: 20px; height: 20px; }
        .password-toggle:hover { color: #4f46e5; }

        .field-error-message { /* Adapted from original */
            font-size: 0.75rem; /* 12px */
            color: #ef4444; /* Red-500 */
            margin-top: 0.25rem; /* 4px */
            /* display: none; is handled by JS */
        }
        .form-message { /* General message styling from original */
            padding: 0.75rem 1rem;
            margin-bottom: 1.5rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            text-align: center;
            border-width: 1px;
            border-style: solid;
            display: none; /* Hidden by default */
        }
        .success-message { /* From original */
            background-color: #dcfce7; /* Green-100 */
            border-color: #86efac; /* Green-300 */
            color: #166534; /* Green-800 */
        }
        .info-message { /* From original */
            background-color: #e0f2fe; /* Sky-100 */
            border-color: #7dd3fc; /* Sky-300 */
            color: #075985; /* Sky-800 */
        }
        .error-message.general-form-error { /* From original */
            background-color: #fee2e2; /* Red-100 */
            border-color: #fca5a5; /* Red-300 */
            color: #991b1b; /* Red-800 */
        }
        .primary-button { /* Applied to submit button, from original */
            width: 100%;
            background-color: #4f46e5; /* Indigo-600 */
            color: white;
            padding: 0.75rem 1rem;
            font-weight: 500;
            font-size: 0.875rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
        }
        .primary-button:hover {
            background-color: #4338ca; /* Indigo-700 */
        }
        .primary-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        .primary-button.loading .btn-text { display: none; }
        .primary-button.loading .loading-spinner { display: inline-block; }
        .loading-spinner { /* From original */
            display: none;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .links-footer { /* Renamed from .links to match original */
            text-align: center;
            margin-top: 1.5rem; /* 24px */
            font-size: 0.875rem;
            color: #4b5563; /* Gray-600 */
        }
        .links-footer a {
            color: #4f46e5; /* Indigo-600 */
            font-weight: 500;
            text-decoration: none;
        }
        .links-footer a:hover {
            text-decoration: underline;
        }
        .terms { /* From signup1.txt, styling for layout */
            display: flex;
            align-items: flex-start; /* Align checkbox with top of text */
            margin-bottom: 1.25rem;
            font-size: 0.875rem;
            color: #4b5563;
        }
        .terms input[type="checkbox"] {
            margin-top: 0.2rem; /* Align with text */
            margin-right: 0.5rem;
            height: 1rem;
            width: 1rem;
            border-radius: 0.25rem;
            border-color: #d1d5db;
            color: #4f46e5; /* Indigo-600 for checkmark */
            cursor: pointer;
        }
        .terms input[type="checkbox"]:focus {
            ring: 2px;
            ring-color: #4f46e5;
            ring-offset: white;
        }
        .terms label a {
            color: #4f46e5;
            text-decoration: none;
        }
        .terms label a:hover {
            text-decoration: underline;
        }
        .password-strength { /* From signup1.txt */
            font-size: 0.75rem;
            margin-top: 0.25rem;
            height: 1rem; /* Prevent layout shift */
        }
        .strength-weak { color: #ef4444; /* Red-500 */ }
        .strength-medium { color: #f59e0b; /* Amber-500 */ }
        .strength-strong { color: #10b981; /* Emerald-500 */ }

        /* Modal Styles (from signup1.txt, basic styling) */
        .modal {
            display: none; 
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 25px;
            border: 1px solid #888;
            width: 80%;
            max-width: 700px;
            border-radius: 0.5rem;
            position: relative;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .modal-close:hover, .modal-close:focus {
            color: black;
            text-decoration: none;
        }
        .modal h1 { font-size: 1.75rem; font-weight: 600; margin-bottom: 0.5rem; color: #1f2937;}
        .modal h2 { font-size: 1.25rem; font-weight: 600; margin-top: 1rem; margin-bottom: 0.25rem; color: #374151;}
        .modal p { font-size: 0.875rem; line-height: 1.6; margin-bottom: 0.75rem; color: #4b5563;}
        .modal-date { font-size: 0.75rem; color: #6b7280; margin-bottom: 1rem; }
        body.modal-open { overflow: hidden; }

        /* Utility for small text like domain restriction hint */
        .text-xs { font-size: 0.75rem; /* 12px */ }
        .text-gray-500 { color: #6b7280; /* Gray-500 */ }
        .mt-1 { margin-top: 0.25rem; /* 4px */ }
        .bg-gray-200 { background-color: #e5e7eb; /* Gray-200 */ }
        .p-0_5 { padding: 0.125rem; /* 2px for tiny padding */ }
        .rounded { border-radius: 0.25rem; /* 4px */ }

        /* Data privacy notice from signup1.txt - basic styling */
        .data-privacy-notice {
            font-size: 0.75rem;
            color: #4b5563;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 1rem;
            margin-bottom: 1rem;
            text-align: center;
        }
        .data-privacy-notice svg {
            margin-right: 0.375rem;
            color: #374151; /* Darker icon */
            width: 14px; height: 14px; /* Smaller icon */
        }

    </style>
</head>
<body>
    <div class="signup-container">
        <div class="logo-container">
            <i class="fas fa-database logo-icon-fa"></i>
            <h2>InfiniBase</h2>
        </div>
        <div class="header-text">
            <h2>Create Your Account</h2>
            <p>Join InfiniBase to access the knowledge base.</p>
        </div>

        <div id="signupGeneralMessage" class="form-message" style="display: none;"></div>

        <form id="signupForm" novalidate>
            <div class="form-group">
                <label for="name">Full Name</label>
                <div class="input-wrapper">
                    <span class="input-icon-fa"><i class="fas fa-user"></i></span>
                    <input type="text" id="name" name="name" required placeholder="E.g., Mohamed Elmenisy" class="input-field" aria-describedby="nameError">
                </div>
                <div id="nameError" class="field-error-message"></div>
            </div>
            <div class="form-group">
                <label for="email">Work Email</label>
                <div class="input-wrapper">
                     <span class="input-icon-fa"><i class="fas fa-envelope"></i></span>
                    <input type="email" id="email" name="email" required placeholder="your.name@thechefz.co" class="input-field" aria-describedby="emailError">
                </div>
                <div id="emailError" class="field-error-message"></div>
                <p class="text-xs text-gray-500 mt-1">Must be a <code class="bg-gray-200 p-0_5 rounded">@thechefz.co</code> email address.</p>
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <div class="input-wrapper">
                     <span class="input-icon-fa"><i class="fas fa-lock"></i></span>
                    <input type="password" id="password" name="password" minlength="8" required placeholder="Minimum 8 characters" class="input-field" aria-describedby="passwordError passwordStrength">
                    <span class="password-toggle" aria-label="Show password" role="button" tabindex="0">
                         <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                     </span>
                </div>
                <div class="password-strength" id="passwordStrength"></div>
                <div id="passwordError" class="field-error-message"></div>
            </div>
            <div class="form-group">
                <label for="confirmPassword">Confirm Password</label>
                <div class="input-wrapper">
                    <span class="input-icon-fa"><i class="fas fa-lock"></i></span>
                    <input type="password" id="confirmPassword" name="confirmPassword" required placeholder="Retype password" class="input-field" aria-describedby="confirmError">
                     <span class="password-toggle" aria-label="Show password" role="button" tabindex="0">
                         <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                     </span>
                </div>
                <div id="confirmError" class="field-error-message"></div>
            </div>
            <div class="terms">
                <input type="checkbox" id="terms" name="terms" required aria-describedby="termsError">
                <div>
                    <label for="terms">I agree to the <a href="#" data-modal-target="termsModal">Terms of Service</a> and <a href="#" data-modal-target="privacyModal">Privacy Policy</a></label>
                    <div id="termsError" class="field-error-message"></div>
                </div>
            </div>
             <p class="data-privacy-notice">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                Your information is kept confidential and secure.
            </p>

            <button type="submit" class="primary-button" id="submitButton">
                 <span class="btn-text">Create Account</span>
                 <span class="loading-spinner"></span>
            </button>
        </form>

        <div class="links-footer">
            Already have an account? <a href="/infini-base/login.html">Log in</a>
        </div>
    </div>

    <!-- Modals (Content from Elevo Core, should be updated for InfiniBase) -->
     <div id="termsModal" class="modal">
         <div class="modal-content">
             <span class="modal-close" data-close-modal>×</span>
             <h1>Terms of Service (for InfiniBase - Placeholder)</h1>
             <p class="modal-date">Last updated: May 15, 2025</p>
             <h2>Welcome to InfiniBase!</h2>
             <p>These terms and conditions outline the rules and regulations for the use of InfiniBase's Website.</p>
             <p>By accessing this website we assume you accept these terms and conditions. Do not continue to use InfiniBase if you do not agree to take all of the terms and conditions stated on this page.</p>
             <p>...</p>
         </div>
     </div>
     <div id="privacyModal" class="modal">
          <div class="modal-content">
              <span class="modal-close" data-close-modal>×</span>
             <h1>Privacy Policy (for InfiniBase - Placeholder)</h1>
             <p class="modal-date">Last updated: May 15, 2025</p>
             <p>At InfiniBase, one of our main priorities is the privacy of our visitors. This Privacy Policy document contains types of information that is collected and recorded by InfiniBase and how we use it.</p>
             <p>...</p>
         </div>
     </div>

    <!-- 1. Supabase CDN (as per original signup.txt) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- 2. Your Supabase client initializer (as per original signup.txt) -->
    <script src="/infini-base/js/supabase.js"></script>
    <!-- 3. Page specific logic -->
    <script>
        let supabase; // Will be assigned window.supabaseClient

        // DOM Elements (adapted from signup1.txt and original signup.txt)
        const signupForm = document.getElementById('signupForm');
        const nameInput = document.getElementById('name');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const confirmInput = document.getElementById('confirmPassword');
        const termsCheckbox = document.getElementById('terms');
        const submitButton = document.getElementById('submitButton');
        const passwordToggles = document.querySelectorAll('.password-toggle');
        
        const nameErrorEl = document.getElementById('nameError');
        const emailErrorEl = document.getElementById('emailError');
        const passwordErrorEl = document.getElementById('passwordError');
        const confirmErrorEl = document.getElementById('confirmError');
        const termsErrorEl = document.getElementById('termsError');
        const signupGeneralMessageEl = document.getElementById('signupGeneralMessage'); // Single general message div
        const passwordStrengthEl = document.getElementById('passwordStrength');

        // Utility Functions (adapted from original signup.txt and signup1.txt)
        function displayFieldError(element, message, inputElement) {
            if (element) {
                element.textContent = message;
                element.style.display = 'block';
            }
            if (inputElement) inputElement.classList.add('error-border');
        }

        function clearFieldError(element, inputElement) {
            if (element) {
                element.textContent = '';
                element.style.display = 'none';
            }
            if (inputElement) inputElement.classList.remove('error-border');
        }
        
        function displayGeneralMessage(message, type = 'error') {
            if (signupGeneralMessageEl) {
                signupGeneralMessageEl.textContent = message;
                signupGeneralMessageEl.className = 'form-message'; // Reset classes
                if (type === 'success') signupGeneralMessageEl.classList.add('success-message');
                else if (type === 'info') signupGeneralMessageEl.classList.add('info-message');
                else signupGeneralMessageEl.classList.add('error-message', 'general-form-error');
                signupGeneralMessageEl.style.display = 'block';
            }
        }

        function clearGeneralMessage() {
            if (signupGeneralMessageEl) {
                 signupGeneralMessageEl.style.display = 'none';
                 signupGeneralMessageEl.className = 'form-message'; // Reset classes
            }
        }

        function setButtonLoading(isLoading) { 
            if (!submitButton) return;
            submitButton.disabled = isLoading;
            submitButton.classList.toggle('loading', isLoading); 
        }

        function updatePasswordStrength(password) {
            if (!passwordStrengthEl) return;
            let strength = 0;
            let feedback = []; 
            if (!password) {
                passwordStrengthEl.textContent = '';
                passwordStrengthEl.className = 'password-strength';
                return;
            }

            if (password.length >= 8) strength++; else feedback.push("8+ chars.");
            if (password.match(/[a-z]/)) strength++; else feedback.push("lowercase.");
            if (password.match(/[A-Z]/)) strength++; else feedback.push("uppercase.");
            if (password.match(/\d/)) strength++; else feedback.push("number.");
            if (password.match(/[^a-zA-Z\d\s]/)) strength++; else feedback.push("special.");

            passwordStrengthEl.className = 'password-strength'; 
            let strengthText = "";
            if (strength === 0 && password.length > 0) { strengthText = 'Very Weak. '; passwordStrengthEl.classList.add('strength-weak'); }
            else if (strength <= 2 && password.length > 0) { strengthText = 'Weak. '; passwordStrengthEl.classList.add('strength-weak'); }
            else if (strength <= 4) { strengthText = 'Medium. '; passwordStrengthEl.classList.add('strength-medium'); }
            else { strengthText = 'Strong!'; passwordStrengthEl.classList.add('strength-strong'); }
            
            passwordStrengthEl.textContent = strengthText + (feedback.length > 0 && strength < 5 ? feedback.slice(0,2).join(' ') : '');
        }

        function togglePasswordVisibility(toggleButton, inputElement) {
            if (!toggleButton || !inputElement) return;
            const isPassword = inputElement.type === 'password';
            inputElement.type = isPassword ? 'text' : 'password';
            toggleButton.innerHTML = isPassword ?
                '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>' : 
                '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>'; 
            toggleButton.setAttribute('aria-label', isPassword ? 'Hide password' : 'Show password');
        }
        
        function initializePage() {
            // Initialize Supabase client from global scope (supabase.js)
            if (typeof window.supabaseClient === 'undefined' || !window.supabaseClient.auth) {
                console.error("[signup.html] Supabase client (window.supabaseClient) not available.");
                displayGeneralMessage("Service unavailable. Please try again later.", "error");
                if (signupForm) signupForm.style.display = 'none';
                return;
            }
            supabase = window.supabaseClient;
            console.log('[signup.html] Supabase client (window.supabaseClient) ready.');

            // Check if user is already logged in
            supabase.auth.getSession().then(({ data: { session } }) => {
                if (session) {
                    console.log('[signup.html] User already authenticated, redirecting to dashboard.');
                    window.location.replace('/infini-base/dashboard.html'); // Ensure correct dashboard path
                } else {
                    if (nameInput) nameInput.focus();
                }
            });

            // Event Listeners
            if (passwordInput) {
                passwordInput.addEventListener('input', (e) => {
                    updatePasswordStrength(e.target.value);
                    if (confirmInput.value) { // Re-validate confirm if password changes
                         if (e.target.value !== confirmInput.value) {
                            displayFieldError(confirmErrorEl, "Passwords do not match.", confirmInput);
                        } else {
                            clearFieldError(confirmErrorEl, confirmInput);
                        }
                    }
                });
            }
            if (confirmInput && passwordInput) { 
                confirmInput.addEventListener('input', () => {
                    if (passwordInput.value !== confirmInput.value) {
                        displayFieldError(confirmErrorEl, "Passwords do not match.", confirmInput);
                    } else {
                        clearFieldError(confirmErrorEl, confirmInput);
                    }
                });
            }

            passwordToggles.forEach(toggle => {
                const inputWrapper = toggle.closest('.input-wrapper');
                const inputElement = inputWrapper ? inputWrapper.querySelector('input[type="password"], input[type="text"]') : null;
                if (inputElement) {
                    toggle.addEventListener('click', () => togglePasswordVisibility(toggle, inputElement));
                    toggle.addEventListener('keydown', (e) => { 
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault(); 
                            togglePasswordVisibility(toggle, inputElement); 
                        }
                    });
                }
            });

            if (signupForm) { 
                signupForm.addEventListener('submit', async function(event) {
                    event.preventDefault();
                    
                    clearGeneralMessage();
                    clearFieldError(nameErrorEl, nameInput);
                    clearFieldError(emailErrorEl, emailInput);
                    clearFieldError(passwordErrorEl, passwordInput);
                    clearFieldError(confirmErrorEl, confirmInput);
                    clearFieldError(termsErrorEl, termsCheckbox);
                    
                    setButtonLoading(true);

                    const nameValue = nameInput.value.trim();
                    const emailValue = emailInput.value.trim().toLowerCase();
                    const passwordValue = passwordInput.value;
                    const confirmPasswordValue = confirmInput.value;
                    const termsAgreed = termsCheckbox.checked;
                    const expectedDomain = '@thechefz.co';

                    let isValid = true;

                    if (!nameValue) {
                        displayFieldError(nameErrorEl, "Full name is required.", nameInput);
                        isValid = false;
                    }
                    if (!emailValue) {
                        displayFieldError(emailErrorEl, "Email is required.", emailInput);
                        isValid = false;
                    } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailValue)) {
                        displayFieldError(emailErrorEl, "Please enter a valid email address.", emailInput);
                        isValid = false;
                    } else if (!emailValue.endsWith(expectedDomain)) {
                        displayFieldError(emailErrorEl, `Must be a ${expectedDomain} email address.`, emailInput);
                        isValid = false;
                    }

                    if (!passwordValue) {
                        displayFieldError(passwordErrorEl, "Password is required.", passwordInput);
                        isValid = false;
                    } else if (passwordValue.length < 8) { 
                        displayFieldError(passwordErrorEl, "Password must be at least 8 characters.", passwordInput);
                        isValid = false;
                    }
                    updatePasswordStrength(passwordValue); // Also updates visual
                     // Optionally, enforce strength:
                    // if (passwordStrengthEl && (passwordStrengthEl.classList.contains('strength-weak') || passwordStrengthEl.classList.contains('strength-very-weak'))) {
                    //    displayFieldError(passwordErrorEl, "Password is too weak.", passwordInput); isValid = false;
                    // }


                    if (!confirmPasswordValue) {
                        displayFieldError(confirmErrorEl, "Please confirm your password.", confirmInput);
                        isValid = false;
                    } else if (passwordValue !== confirmPasswordValue) {
                        displayFieldError(confirmErrorEl, "Passwords do not match.", confirmInput);
                        isValid = false;
                    }
                    if (!termsAgreed) {
                        displayFieldError(termsErrorEl, "You must agree to the terms and conditions.", termsCheckbox); // Pass checkbox for potential styling
                        isValid = false;
                    }

                    if (!isValid) {
                        setButtonLoading(false);
                        return;
                    }

                    try {
                        const { data: authData, error: authError } = await supabase.auth.signUp({
                            email: emailValue,
                            password: passwordValue
                            // NO options.data here
                        });

                        if (authError) {
                             // Check if it's a "user already exists" type error that might still have a user object for confirmation resend
                            if (!(authData && authData.user && authData.user.email === emailValue && authData.user.email_confirmed_at === null)) {
                                throw authError; // Rethrow if not the specific case above
                            }
                             console.log("AuthError but user object present for unconfirmed email, proceeding to user handling.");
                        }
                        
                        if (authData && authData.user) {
                            // Case 1: User exists, email IS confirmed, but NO session (already fully registered)
                            if (!authData.session && authData.user.email_confirmed_at !== null) {
                                displayGeneralMessage("This email is already registered and confirmed. Please log in.", "error");
                            }
                            // Case 2: User exists, email IS NOT confirmed, NO session (Email confirmation pending)
                            else if (!authData.session && authData.user.email_confirmed_at === null) {
                                displayGeneralMessage("Signup initiated! Please check your email to confirm your account. Then, proceed to log in.", "info");
                                signupForm.reset();
                                nameInput.focus();
                                // Optional: Resend confirmation if it was an old attempt, Supabase handles this usually.
                            } 
                            // Case 3: User exists AND session IS active (auto-confirmed or email verification disabled by Supabase settings)
                            else if (authData.session) {
                                const { error: profileError } = await supabase
                                    .from('users') 
                                    .insert({
                                        id: authData.user.id, 
                                        name: nameValue, 
                                        email: emailValue
                                        // is_admin and role will use DB defaults
                                    });

                                if (profileError) {
                                    console.error("Error inserting user profile:", profileError);
                                    displayGeneralMessage(`Account created, but profile setup failed. Please contact support. (${profileError.message})`, "error");
                                    // Consider what to do here - user is auth'd but no profile.
                                    // Maybe log them out or show specific instructions.
                                } else {
                                    displayGeneralMessage("Signup successful! Redirecting to login...", "success");
                                    setTimeout(() => {
                                        window.location.href = `/infini-base/login.html?email=${encodeURIComponent(emailValue)}&signedup=true`;
                                    }, 2500);
                                }
                            } else {
                                // Fallback for unexpected state
                                console.warn("Unexpected state in user/session processing:", authData);
                                displayGeneralMessage("An unexpected issue occurred. Please check your email or try again.", "info");
                            }
                        } else if (!authError) { 
                            // No user data and no authError after initial check (should be rare with Supabase v2)
                            console.warn("SignUp response did not contain user data or a specific error.");
                            displayGeneralMessage("Signup request received. Please check your email to complete the process.", "info");
                        }

                    } catch (error) {
                        console.error("Signup CATCH Block Error:", error);
                        let errorMessage = "An unexpected error occurred. Please try again.";
                        if (error && error.message) {
                            const lowerMessage = error.message.toLowerCase();
                            if (lowerMessage.includes("user already registered") || 
                                (error.status === 400 && lowerMessage.includes("user already exists")) ||
                                lowerMessage.includes("email address is already registered")) {
                                errorMessage = "This email is already registered. Please log in or check your email for a confirmation link if you haven't confirmed yet.";
                                displayGeneralMessage(errorMessage, "error");
                            } else if (lowerMessage.includes("password should be at least")) {
                                displayFieldError(passwordErrorEl, error.message, passwordInput);
                                clearGeneralMessage(); // Don't show general if field specific
                            } else if (error.status === 429 || lowerMessage.includes("rate limit exceeded")) {
                                errorMessage = "Too many signup attempts. Please try again later.";
                                displayGeneralMessage(errorMessage, "error");
                            } else {
                                displayGeneralMessage(`Signup failed: ${error.message}`, "error");
                            }
                        } else {
                            displayGeneralMessage(errorMessage, "error");
                        }
                    } finally {
                        // Only set loading false if not redirecting or explicitly showing info message that implies waiting
                        const isWaitingForUserAction = signupGeneralMessageEl.style.display === 'block' &&
                                                      (signupGeneralMessageEl.classList.contains('info-message') ||
                                                       signupGeneralMessageEl.textContent.includes("Redirecting to login..."));
                        if (!isWaitingForUserAction) {
                             setButtonLoading(false);
                        }
                    }
                });
            }
        } // end of initializePage

        // Modal Handling (from signup1.txt)
        const modalTriggers = document.querySelectorAll('[data-modal-target]');
        const closeButtons = document.querySelectorAll('[data-close-modal]');

        modalTriggers.forEach(button => {
            button.addEventListener('click', function(event) {
                event.preventDefault();
                const modalId = this.dataset.modalTarget;
                const modal = document.getElementById(modalId);
                if (modal) openModal(modal);
            });
        });

        closeButtons.forEach(button => {
            button.addEventListener('click', function() {
                const modal = this.closest('.modal');
                if (modal) closeModal(modal);
            });
        });

        window.addEventListener('click', function(event) {
            document.querySelectorAll('.modal.active').forEach(modal => { 
                if (event.target == modal) closeModal(modal);
            });
        });
        window.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                 document.querySelectorAll('.modal.active').forEach(modal => closeModal(modal));
            }
        });

        function openModal(modal) {
            if (modal == null) return;
            modal.style.display = 'block'; 
            requestAnimationFrame(() => modal.classList.add('active')); // For potential transitions
            document.body.classList.add('modal-open');
            modal.setAttribute('aria-hidden', 'false');
            const firstFocusableElement = modal.querySelector('h1, button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
            if (firstFocusableElement) firstFocusableElement.focus();
        }

        function closeModal(modal) {
            if (modal == null) return;
            modal.classList.remove('active');
            // Listen for transition end if you add one, otherwise direct hide
            modal.style.display = 'none'; 
            document.body.classList.remove('modal-open');
            modal.setAttribute('aria-hidden', 'true');
        }

        // Initialize after DOM is ready and supabase.js has potentially run
        document.addEventListener('DOMContentLoaded', () => {
            // Small delay to ensure supabase.js might have initialized window.supabaseClient
             setTimeout(initializePage, 100); 
        });
        console.log("InfiniBase signup script loaded.");
    </script>
</body>
</html>
