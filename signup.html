<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up - InfiniBase</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #3B82F6, #1E3A8A); /* Blue gradient */
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            padding: 1rem;
        }
        .signup-container {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(8px);
            border-radius: 1.25rem;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0,0,0,0.15);
            padding: 2.5rem;
            max-width: 420px;
            width: 100%;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease-out, box-shadow 0.3s ease-out;
        }
        .signup-container:hover {
            transform: translateY(-6px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.25), 0 8px 20px rgba(0,0,0,0.2);
        }
         .signup-container::before { /* Decorative gradient border effect */
            content: '';
            position: absolute;
            top: -2px; left: -2px; right: -2px; bottom: -2px;
            background: linear-gradient(45deg, rgba(59, 130, 246, 0.3), rgba(16, 185, 129, 0.3), rgba(30, 58, 138, 0.3));
            z-index: -1;
            border-radius: calc(1.25rem + 2px);
        }
        .input-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280; /* gray-500 */
        }
        .input-field {
            padding-left: 3rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            border-radius: 0.5rem;
            border: 1px solid #D1D5DB; /* gray-300 */
        }
        .input-field:focus {
            border-color: #3b82f6; /* blue-500 */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25); /* Blue focus ring */
        }
        .signup-btn {
            background: linear-gradient(90deg, #3b82f6, #2563eb); /* Blue gradient */
            transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(59, 130, 246, 0.2);
            display: flex; /* For loading spinner */
            align-items: center; /* For loading spinner */
            justify-content: center; /* For loading spinner */
        }
        .signup-btn:hover {
            background: linear-gradient(90deg, #2563eb, #1d4ed8); /* Darker Blue */
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 6px 12px rgba(59, 130, 246, 0.3);
        }
         .signup-btn:active {
            transform: translateY(0px) scale(1);
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
        }
        .signup-btn.loading .btn-text { display: none; }
        .signup-btn.loading .loading-spinner { display: inline-block; }
        .loading-spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .form-title {
             font-family: 'Inter', sans-serif;
        }
        .form-message {
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            text-align: center;
            border-width: 1px;
            border-style: solid;
        }
        .success-message {
            background-color: #d1fae5; /* green-100 */
            border-color: #6ee7b7; /* green-300 */
            color: #065f46; /* green-800 */
        }
        .error-message {
            background-color: #fee2e2; /* red-100 */
            border-color: #fca5a5; /* red-300 */
            color: #991b1b; /* red-800 */
        }
        .field-error-message { /* For specific field errors */
            background-color: transparent;
            border: none;
            color: #ef4444; /* red-500 */
            text-align: left;
            padding: 0.25rem 0 0 0;
            font-size: 0.75rem; /* 12px */
        }
    </style>
</head>
<body class="h-full font-sans">
    <div class="signup-container">
        <div class="text-center mb-8">
            <i class="fas fa-user-plus text-5xl text-blue-500 mb-3"></i>
            <h2 class="text-3xl font-bold text-gray-800 form-title">Create Your Account</h2>
            <p class="text-gray-600 mt-1">Join InfiniBase and start organizing knowledge.</p>
        </div>

        <div id="signupGeneralMessage" class="form-message" style="display: none;"></div>

        <form id="signupForm" class="space-y-4"> {/* Reduced space for tighter field error messages */}
            <div>
                <label for="fullName" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                <div class="relative">
                    <span class="input-icon"><i class="fas fa-user"></i></span>
                    <input type="text" id="fullName" name="fullName" placeholder="E.g., Jane Doe" required
                           class="input-field w-full p-3 text-gray-700 focus:outline-none">
                </div>
                <div id="fullNameError" class="field-error-message"></div>
            </div>
            <div>
                <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Work Email</label>
                <div class="relative">
                    <span class="input-icon"><i class="fas fa-envelope"></i></span>
                    <input type="email" id="email" name="email" placeholder="your.name@thechefz.co" required
                           class="input-field w-full p-3 text-gray-700 focus:outline-none">
                </div>
                <div id="emailError" class="field-error-message"></div>
                <p class="text-xs text-gray-500 mt-1">Must be a <code class="bg-gray-200 p-0.5 rounded">@thechefz.co</code> email address.</p>
            </div>
            <div>
                <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                <div class="relative">
                    <span class="input-icon"><i class="fas fa-lock"></i></span>
                    <input type="password" id="password" name="password" placeholder="Choose a strong password" required minlength="6"
                           class="input-field w-full p-3 text-gray-700 focus:outline-none">
                </div>
                <div id="passwordError" class="field-error-message"></div>
                 <p class="text-xs text-gray-500 mt-1">Minimum 6 characters.</p>
            </div>
            <button type="submit" id="submitButton" class="signup-btn w-full py-3 text-white font-semibold">
                <span class="btn-text">Sign Up <i class="fas fa-arrow-right ml-2"></i></span>
                <span class="loading-spinner"></span>
            </button>
        </form>
        <p class="text-center mt-6 text-sm text-gray-600">
            Already have an account? <a href="login.html" class="font-medium text-blue-600 hover:text-blue-500 hover:underline">Login</a>
        </p>
    </div>

    <!-- Import Supabase Client -->
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // --- Supabase Configuration ---
        const SUPABASE_URL = 'https://aefiigottnlcmjzilqnh.supabase.co'; // YOUR_SUPABASE_URL
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFlZmlpZ290dG5sY21qemlscW5oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcxNzY2MDQsImV4cCI6MjA2Mjc1MjYwNH0.FypB02v3tGMnxXV9ZmZMdMC0oQpREKOJWgHMPxUzwX4'; // YOUR_SUPABASE_ANON_KEY
        let supabase;

        try {
            supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log('Supabase client initialized for signup.');
        } catch (e) {
            console.error("Failed to initialize Supabase client:", e);
            displayGeneralMessage("Service unavailable. Please try again later.", "error");
            const form = document.getElementById('signupForm');
            if (form) form.style.display = 'none';
        }


        // --- DOM Elements ---
        const signupForm = document.getElementById('signupForm');
        const fullNameInput = document.getElementById('fullName');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const submitButton = document.getElementById('submitButton');

        const fullNameErrorEl = document.getElementById('fullNameError');
        const emailErrorEl = document.getElementById('emailError');
        const passwordErrorEl = document.getElementById('passwordError');
        const signupGeneralMessageEl = document.getElementById('signupGeneralMessage');

        // --- Helper Functions for UI ---
        function displayFieldError(element, message) {
            if (element) {
                element.textContent = message;
                element.style.display = 'block';
                const inputField = element.previousElementSibling?.querySelector('input');
                if (inputField) inputField.classList.add('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
            }
        }

        function clearFieldError(element) {
            if (element) {
                element.textContent = '';
                element.style.display = 'none';
                const inputField = element.previousElementSibling?.querySelector('input');
                if (inputField) inputField.classList.remove('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
            }
        }

        function displayGeneralMessage(message, type = 'error') {
            if (signupGeneralMessageEl) {
                signupGeneralMessageEl.textContent = message;
                signupGeneralMessageEl.classList.remove('success-message', 'error-message');
                signupGeneralMessageEl.classList.add(type === 'success' ? 'success-message' : 'error-message');
                signupGeneralMessageEl.style.display = 'block';
            }
        }

        function clearGeneralMessage() {
            if (signupGeneralMessageEl) signupGeneralMessageEl.style.display = 'none';
        }

        function setButtonLoading(isLoading) {
            if (submitButton) {
                submitButton.disabled = isLoading;
                submitButton.classList.toggle('loading', isLoading);
            }
        }

        // --- Form Submission Logic ---
        if (signupForm && supabase) {
            signupForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                clearGeneralMessage();
                clearFieldError(fullNameErrorEl);
                clearFieldError(emailErrorEl);
                clearFieldError(passwordErrorEl);
                setButtonLoading(true);

                const fullName = fullNameInput.value.trim();
                const email = emailInput.value.trim().toLowerCase();
                const password = passwordInput.value;

                // --- Client-side Validation ---
                let isValid = true;
                if (!fullName) {
                    displayFieldError(fullNameErrorEl, 'Full name is required.');
                    isValid = false;
                }
                if (!email) {
                    displayFieldError(emailErrorEl, 'Email is required.');
                    isValid = false;
                } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                    displayFieldError(emailErrorEl, 'Please enter a valid email address.');
                    isValid = false;
                } else {
                    const expectedDomain = '@thechefz.co';
                    if (!email.endsWith(expectedDomain)) {
                        displayFieldError(emailErrorEl, `Must be a ${expectedDomain} email address.`);
                        isValid = false;
                    }
                }
                if (!password) {
                    displayFieldError(passwordErrorEl, 'Password is required.');
                    isValid = false;
                } else if (password.length < 6) {
                    displayFieldError(passwordErrorEl, 'Password must be at least 6 characters.');
                    isValid = false;
                }

                if (!isValid) {
                    setButtonLoading(false);
                    return;
                }

                // --- Supabase Signup ---
                try {
                    const { data: authResponse, error: signUpError } = await supabase.auth.signUp({
                        email: email,
                        password: password,
                        options: {
                            data: {
                                full_name: fullName // This will be stored in auth.users.user_metadata
                            }
                        }
                    });

                    if (signUpError) {
                        console.error('Supabase signUp Error:', signUpError);
                        if (signUpError.message.includes("User already registered")) {
                            displayGeneralMessage("This email is already registered. Please log in.", "error");
                        } else if (signUpError.message.includes("Password should be at least 6 characters")) {
                            displayFieldError(passwordErrorEl, "Password should be at least 6 characters.");
                        }
                        else {
                            displayGeneralMessage(`Signup failed: ${signUpError.message}`, "error");
                        }
                        setButtonLoading(false);
                        return;
                    }

                    // console.log('Supabase signUp Response Data:', authResponse);

                    if (authResponse.user && authResponse.user.identities && authResponse.user.identities.length === 0) {
                        // This case can happen if "Confirm email" is OFF and the user already exists (but signUp doesn't error)
                        // Or if the user exists but email is not confirmed and signUp is called again.
                         displayGeneralMessage("This email is already registered. If you haven't confirmed your email, please check your inbox (and spam folder).", "error");
                         setButtonLoading(false);
                         return;
                    }


                    // If email confirmation is required, user object is returned but session is null.
                    // If email confirmation is OFF, user object AND session are returned.
                    if (authResponse.user) {
                        // Attempt to insert into public.users table
                        // The 'id' should match auth.users.id, 'email' auth.users.email
                        // 'role' defaults to 'viewer' by database schema.
                        const { error: profileError } = await supabase
                            .from('users') // Your custom public users table
                            .insert({
                                id: authResponse.user.id, // Link to auth.users table
                                email: authResponse.user.email,
                                full_name: fullName, // Or from authResponse.user.user_metadata.full_name
                                // 'role' will use the default 'viewer' from your table definition
                            });

                        if (profileError) {
                            console.error('Error inserting user profile into public.users:', profileError);
                            // User is created in Supabase Auth, but profile creation failed.
                            // This is a partial success. Advise user to contact support or try login.
                            // If "Confirm email" is ON, they'll get the confirmation email anyway.
                            if (authResponse.session) { // Auto-confirmed
                                displayGeneralMessage("Account created, but profile setup had an issue. Please try logging in or contact support.", "error");
                            } else { // Email confirmation pending
                                displayGeneralMessage("Account created and confirmation email sent, but profile setup had an issue. Please confirm your email, then contact support if problems persist.", "error");
                            }
                        } else {
                            if (authResponse.session) { // Email auto-confirmed (or "Confirm email" is OFF)
                                displayGeneralMessage("Signup successful! You are now logged in. Redirecting...", "success");
                                setTimeout(() => { window.location.href = 'dashboard.html'; }, 2500);
                            } else { // "Confirm email" is ON, session is null until confirmed
                                displayGeneralMessage("Signup successful! Please check your email to confirm your account.", "success");
                                signupForm.reset();
                            }
                        }
                    } else {
                        // Should not happen if signUpError was not thrown, but as a fallback.
                        displayGeneralMessage("Signup failed. Unexpected response from server.", "error");
                    }

                } catch (error) {
                    console.error("General error during signup process:", error);
                    displayGeneralMessage("An unexpected error occurred. Please try again.", "error");
                } finally {
                    // Only turn off loading if not redirecting or if a persistent message is shown
                    if (!signupGeneralMessageEl.textContent.includes("Redirecting...") &&
                        !(signupGeneralMessageEl.classList.contains('success-message') && signupGeneralMessageEl.textContent.includes("confirm your account"))
                       ) {
                        setButtonLoading(false);
                    }
                }
            });
        }

        // Check if already authenticated (using Supabase Auth)
        // This replaces the old Auth.isAuthenticated() for this page
        if (supabase) {
            supabase.auth.getSession().then(({ data: { session } }) => {
                if (session) {
                    console.log('[signup.html] User already authenticated with Supabase, redirecting to dashboard.');
                    window.location.href = 'dashboard.html';
                }
            });
        }

    </script>
</body>
</html>
