<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up - InfiniBase</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Replicating Core-Flow styles with Tailwind as much as possible, plus some custom CSS for finer details */
        body {
            background: linear-gradient(135deg, #4f46e5, #7c3aed); /* InfiniBase: Indigo to Purple gradient */
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow-y: auto; /* Allow scroll if content is too long */
            padding: 1rem;
            font-family: 'Inter', sans-serif; /* Assuming Inter is a desired font */
        }
        .signup-container {
            background: white;
            border-radius: 1rem; /* 16px */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            padding: 2rem; /* 32px */
            max-width: 450px;
            width: 100%;
        }
        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1.5rem; /* 24px */
            color: #4f46e5; /* Indigo-600 */
        }
        .logo-container i {
            font-size: 2.5rem; /* 40px */
            margin-right: 0.75rem; /* 12px */
        }
        .logo-container h2 {
            font-size: 1.875rem; /* 30px */
            font-weight: 700;
        }
        .header-text {
            text-align: center;
            margin-bottom: 2rem; /* 32px */
        }
        .header-text h2 {
            font-size: 1.5rem; /* 24px */
            font-weight: 600;
            color: #1f2937; /* Gray-800 */
            margin-bottom: 0.25rem;
        }
        .header-text p {
            font-size: 0.875rem; /* 14px */
            color: #4b5563; /* Gray-600 */
        }
        .form-group {
            margin-bottom: 1.25rem; /* 20px */
        }
        .form-group label {
            display: block;
            font-size: 0.875rem; /* 14px */
            font-weight: 500;
            color: #374151; /* Gray-700 */
            margin-bottom: 0.5rem; /* 8px */
        }
        .input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }
        .input-icon-fa {
            position: absolute;
            left: 0.75rem; /* 12px */
            color: #9ca3af; /* Gray-400 */
            font-size: 1rem; /* 16px */
        }
        .input-field {
            width: 100%;
            padding: 0.75rem 0.75rem 0.75rem 2.5rem; /* 12px, 12px, 12px, 40px for icon */
            border: 1px solid #d1d5db; /* Gray-300 */
            border-radius: 0.375rem; /* 6px */
            font-size: 0.875rem;
            color: #1f2937; /* Gray-800 */
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-field:focus {
            outline: none;
            border-color: #4f46e5; /* Indigo-600 */
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2); /* Indigo-600 with opacity */
        }
        .input-field.error-border {
             border-color: #ef4444; /* red-500 */
        }
        .input-field.error-border:focus {
            border-color: #ef4444; /* red-500 */
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2); /* red-500 with opacity */
        }
        .field-error-message {
            font-size: 0.75rem; /* 12px */
            color: #ef4444; /* Red-500 */
            margin-top: 0.25rem; /* 4px */
            display: none; /* Hidden by default */
        }
        .form-message {
            padding: 0.75rem 1rem;
            margin-bottom: 1.5rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            text-align: center;
            border-width: 1px;
            border-style: solid;
            display: none; /* Hidden by default */
        }
        .success-message {
            background-color: #dcfce7; /* Green-100 */
            border-color: #86efac; /* Green-300 */
            color: #166534; /* Green-800 */
        }
        .info-message { /* Added for needsconfirmation */
            background-color: #e0f2fe; /* Light blue, e.g., sky-100 */
            border-color: #7dd3fc; /* Sky-300 */
            color: #075985; /* Sky-800 */
        }
        .error-message.general-form-error {
            background-color: #fee2e2; /* Red-100 */
            border-color: #fca5a5; /* Red-300 */
            color: #991b1b; /* Red-800 */
        }
        .primary-button {
            width: 100%;
            background-color: #4f46e5; /* Indigo-600 */
            color: white;
            padding: 0.75rem 1rem;
            font-weight: 500;
            font-size: 0.875rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .primary-button:hover {
            background-color: #4338ca; /* Indigo-700 */
        }
        .primary-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        .primary-button.loading .btn-text { display: none; }
        .primary-button.loading .loading-spinner { display: inline-block; }
        .loading-spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .links-footer {
            text-align: center;
            margin-top: 1.5rem; /* 24px */
            font-size: 0.875rem;
            color: #4b5563; /* Gray-600 */
        }
        .links-footer a {
            color: #4f46e5; /* Indigo-600 */
            font-weight: 500;
            text-decoration: none;
        }
        .links-footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="signup-container">
        <div class="logo-container">
            <i class="fas fa-database"></i>
            <h2>InfiniBase</h2>
        </div>
        <div class="header-text">
            <h2>Create Your Account</h2>
            <p>Join InfiniBase to access the knowledge base.</p>
        </div>

        <div id="signupGeneralMessage" class="form-message" style="display: none;"></div>

        <form id="signupForm" novalidate>
            <div class="form-group">
                <label for="fullName">Full Name</label>
                <div class="input-wrapper">
                    <span class="input-icon-fa"><i class="fas fa-user"></i></span>
                    <input type="text" id="fullName" name="fullName" required placeholder="E.g., Mohamed Elmenisy" class="input-field">
                </div>
                <div id="fullNameError" class="field-error-message"></div>
            </div>
            <div class="form-group">
                <label for="email">Work Email</label>
                <div class="input-wrapper">
                     <span class="input-icon-fa"><i class="fas fa-envelope"></i></span>
                    <input type="email" id="email" name="email" required placeholder="your.name@thechefz.co" class="input-field">
                </div>
                <div id="emailError" class="field-error-message"></div>
                 <p class="text-xs text-gray-500 mt-1">Must be a <code class="bg-gray-200 p-0.5 rounded">@thechefz.co</code> email address.</p>
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <div class="input-wrapper">
                     <span class="input-icon-fa"><i class="fas fa-lock"></i></span>
                    <input type="password" id="password" name="password" minlength="6" required placeholder="Minimum 6 characters" class="input-field">
                </div>
                <div id="passwordError" class="field-error-message"></div>
            </div>

            <button type="submit" class="primary-button" id="submitButton">
                <span class="btn-text">Create Account</span>
                <span class="loading-spinner"></span>
            </button>
        </form>

        <div class="links-footer">
            Already have an account? <a href="/infini-base/login.html">Log in</a>
        </div>
    </div>

    <!-- 1. Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- 2. Your Supabase client initializer -->
    <script src="/infini-base/js/supabase.js"></script>
    <!-- 3. Page specific logic -->
    <script>
        let supabase; // Will be assigned window.supabaseClient

        const signupForm = document.getElementById('signupForm');
        const fullNameInput = document.getElementById('fullName');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const submitButton = document.getElementById('submitButton');

        const fullNameErrorEl = document.getElementById('fullNameError');
        const emailErrorEl = document.getElementById('emailError');
        const passwordErrorEl = document.getElementById('passwordError');
        const signupGeneralMessageEl = document.getElementById('signupGeneralMessage');

        function displayFieldError(element, message) {
            if (element) {
                element.textContent = message;
                element.style.display = 'block';
                const inputField = element.previousElementSibling?.querySelector('input');
                if (inputField) inputField.classList.add('error-border');
            }
        }

        function clearFieldError(element) {
            if (element) {
                element.textContent = '';
                element.style.display = 'none';
                const inputField = element.previousElementSibling?.querySelector('input');
                if (inputField) inputField.classList.remove('error-border');
            }
        }

        function displayGeneralMessage(message, type = 'error') {
            if (signupGeneralMessageEl) {
                signupGeneralMessageEl.textContent = message;
                signupGeneralMessageEl.classList.remove('success-message', 'error-message', 'general-form-error', 'info-message');
                if (type === 'success') signupGeneralMessageEl.classList.add('success-message');
                else if (type === 'info') signupGeneralMessageEl.classList.add('info-message');
                else signupGeneralMessageEl.classList.add('error-message', 'general-form-error');
                signupGeneralMessageEl.style.display = 'block';
            }
        }

        function clearGeneralMessage() {
            if (signupGeneralMessageEl) signupGeneralMessageEl.style.display = 'none';
        }

        function setButtonLoading(isLoading) {
            if (submitButton) {
                submitButton.disabled = isLoading;
                submitButton.classList.toggle('loading', isLoading);
            }
        }
        
        function initializePage() {
            if (typeof window.supabaseClient === 'undefined' || !window.supabaseClient.auth) {
                console.error("[signup.html] Supabase client (window.supabaseClient) not available.");
                displayGeneralMessage("Service unavailable. Please try again later.", "error");
                if (signupForm) signupForm.style.display = 'none'; // Hide form if Supabase fails
                return;
            }
            supabase = window.supabaseClient; // Assign to local supabase variable
            console.log('[signup.html] Supabase client (window.supabaseClient) ready.');

            // Check if user is already logged in
            supabase.auth.getSession().then(({ data: { session } }) => {
                if (session) {
                    console.log('[signup.html] User already authenticated, redirecting to dashboard.');
                    window.location.replace('/infini-base/dashboard.html');
                } else {
                    if (fullNameInput) fullNameInput.focus();
                }
            });

            if (signupForm) {
                signupForm.addEventListener('submit', async function(event) {
                    event.preventDefault();
                    clearGeneralMessage();
                    clearFieldError(fullNameErrorEl);
                    clearFieldError(emailErrorEl);
                    clearFieldError(passwordErrorEl);
                    setButtonLoading(true);

                    const fullName = fullNameInput.value.trim();
                    const email = emailInput.value.trim().toLowerCase();
                    const password = passwordInput.value;

                    let isValid = true;
                    if (!fullName) {
                        displayFieldError(fullNameErrorEl, 'Full name is required.');
                        isValid = false;
                    }
                    if (!email) {
                        displayFieldError(emailErrorEl, 'Email is required.');
                        isValid = false;
                    } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                        displayFieldError(emailErrorEl, 'Please enter a valid email address.');
                        isValid = false;
                    } else {
                        const expectedDomain = '@thechefz.co';
                        if (!email.endsWith(expectedDomain)) {
                            displayFieldError(emailErrorEl, `Must be a ${expectedDomain} email address.`);
                            isValid = false;
                        }
                    }
                    if (!password) {
                        displayFieldError(passwordErrorEl, 'Password is required.');
                        isValid = false;
                    } else if (password.length < 6) {
                        displayFieldError(passwordErrorEl, 'Password must be at least 6 characters.');
                        isValid = false;
                    }

                    if (!isValid) {
                        setButtonLoading(false);
                        return;
                    }

                    try {
                        // 1. Sign up the user with Supabase Auth
                        const { data: authResponse, error: signUpError } = await supabase.auth.signUp({
                            email: email,
                            password: password,
                            options: { 
                                data: { 
                                    // This 'data' under options is stored in auth.users.raw_user_meta_data
                                    // If your 'users' table has a trigger to copy from raw_user_meta_data.name, this is fine.
                                    // Otherwise, you'll insert/update 'name' in the 'users' table directly below.
                                    name: fullName // Store as 'name' in user_metadata if needed by triggers
                                } 
                            }
                        });

                        if (signUpError) {
                            console.error('Supabase signUp Error:', signUpError);
                            if (signUpError.message.includes("User already registered") || (signUpError.status === 400 && signUpError.message.includes("user already exists"))) {
                                displayGeneralMessage("This email is already registered. Please log in.", "error");
                            } else if (signUpError.message.includes("Password should be at least 6 characters")) {
                                displayFieldError(passwordErrorEl, "Password should be at least 6 characters.");
                            } else if (signUpError.status === 429) {
                                displayGeneralMessage("Too many signup attempts. Please try again later.", "error");
                            } else {
                                displayGeneralMessage(`Signup failed: ${signUpError.message}`, "error");
                            }
                            setButtonLoading(false);
                            return;
                        }

                        if (authResponse.user) {
                            // 2. Insert into your public 'users' table
                            const { error: profileError } = await supabase
                                .from('users') // Your custom public table
                                .insert({
                                    id: authResponse.user.id, // Link to the auth.users table
                                    email: authResponse.user.email,
                                    name: fullName, // ✅ MODIFICATION: Changed from full_name to name
                                });

                            if (profileError) {
                                console.error('Error inserting user profile into public.users:', profileError);
                                // You might want to inform the user or log this more formally
                                // For now, the auth user is created, so the flow can continue
                            }
                            
                            const emailConfirmationRequired = !authResponse.session && authResponse.user.email_confirmed_at === null;

                            if (emailConfirmationRequired) {
                                displayGeneralMessage("Signup initiated! Please check your email to confirm your account. Then, proceed to log in.", "info");
                                signupForm.reset();
                                setTimeout(() => {
                                    window.location.href = `/infini-base/login.html?email=${encodeURIComponent(email)}&needsconfirmation=true`;
                                }, 3500);
                            } else { 
                                displayGeneralMessage("Signup successful! Redirecting to login...", "success");
                                setTimeout(() => {
                                    window.location.href = `/infini-base/login.html?email=${encodeURIComponent(email)}&signedup=true`;
                                }, 2500);
                            }
                        } else {
                            console.warn("SignUp success but no user object in authResponse.user, email confirmation might be required.");
                            displayGeneralMessage("Signup request received. Please check your email to complete the process and then log in.", "info");
                            signupForm.reset();
                            setTimeout(() => {
                                window.location.href = `/infini-base/login.html?email=${encodeURIComponent(email)}&needsconfirmation=true`;
                            }, 3500);
                        }

                    } catch (error) {
                        console.error("General error during signup process:", error);
                        displayGeneralMessage("An unexpected error occurred. Please try again.", "error");
                    } finally {
                        const isRedirectingOrConfirming = signupGeneralMessageEl.textContent.includes("Redirecting to login...") ||
                                                          signupGeneralMessageEl.textContent.includes("confirm your account");
                        if (!isRedirectingOrConfirming) {
                            setButtonLoading(false);
                        }
                    }
                });
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(initializePage, 200); 
        });
    </script>
</body>
</html>
